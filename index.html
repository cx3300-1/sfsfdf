<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>EPhone</title>
    <!-- â–¼â–¼â–¼ ã€æ¡Œé¢å›¾æ ‡ã€‘çº¯HTMLå•æ–‡ä»¶æ–¹æ¡ˆï¼Œè¯·ç²˜è´´åˆ° <title> ä¹‹å â–¼â–¼â–¼ -->
    <!-- 1. (æ ¸å¿ƒ) ä¸ºè‹¹æœè®¾å¤‡è®¾ç½®ä¸»å±å¹•å›¾æ ‡ -->
    <!-- æµè§ˆå™¨ä¼šè‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„å°ºå¯¸ -->
    <link rel="apple-touch-icon" href="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg">
    <link rel="apple-touch-icon" sizes="152x152" href="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg">
    <link rel="apple-touch-icon" sizes="180x180" href="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg">
    <link rel="apple-touch-icon" sizes="167x167" href="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg">
    <link rel="manifest" href="manifest.json">
    <!-- 2. (æ ¸å¿ƒ) å‘Šè¯‰è‹¹æœè®¾å¤‡ï¼Œè¿™æ˜¯ä¸€ä¸ªWebåº”ç”¨ï¼Œå¯ä»¥å…¨å±æ˜¾ç¤º -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- 3. (æ ¸å¿ƒ) è®¾ç½®è‹¹æœè®¾å¤‡å…¨å±æ¨¡å¼ä¸‹çš„çŠ¶æ€æ æ ·å¼ -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- 4. (å¯é€‰) è®¾ç½®åº”ç”¨åœ¨ä¸»å±å¹•ä¸Šæ˜¾ç¤ºçš„æ ‡é¢˜ -->
    <meta name="apple-mobile-web-app-title" content="EPhone">
    <!-- 5. (å…¼å®¹) ä¸ºéƒ¨åˆ†å®‰å“æµè§ˆå™¨æä¾›æ”¯æŒ -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- 6. (å¤‡ç”¨) æ ‡å‡†æµè§ˆå™¨é¡µç­¾å›¾æ ‡ -->
    <link rel="icon" type="image/png" href="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg">
    <!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="x-social-app.js" defer></script>
    <style>
        @font-face { font-family: 'bulangni'; src: url('') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff; }
               /* â–¼â–¼â–¼ Safarié”®ç›˜é€‚é…ï¼šè¯·ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ ç°æœ‰çš„ html, body, å’Œ #phone-screen æ ·å¼ â–¼â–¼â–¼ */
        
        /* --- è¯·ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ‰ä½ ç°æœ‰çš„ html, body, å’Œ #phone-screen æ ·å¼ --- */
        
        /* 1. é‡ç½® html å…ƒç´  */
        html {
            -webkit-text-size-adjust: 100%;
            height: 100%; /* ç¡®ä¿htmlå…ƒç´ ä¹Ÿèƒ½æ’‘æ»¡ */
        }
        
        /* 2. è®¾ç½® body ä¸ºå…¨å±ç”»å¸ƒ */
        body {
            margin: 0;
            font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: normal;
            background-color: #f0f2f5;
            height: 100%; /* è®©bodyä¹Ÿæ’‘æ»¡çˆ¶å…ƒç´ (html) */
            overflow: hidden; /* é˜²æ­¢bodyæœ¬èº«å‡ºç°æ»šåŠ¨æ¡ */
        }
        
        /* --- Start of Replacement Code --- */
        
        #phone-screen {
            width: 100%;
            /* Use 100vh to ensure it fills the entire screen height */
            height: 100vh; 
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #ffffff; /* Your desired white background */
        }
        
        #chat-input-area {
            flex-shrink: 0;
            padding: 8px;
            /* This is the key: adds padding equal to the height of the "black bar" */
            padding-bottom: calc(8px + env(safe-area-inset-bottom)); 
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        /* --- End of Replacement Code --- */
/* --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿™æ˜¯æ§åˆ¶çŠ¶æ€æ æ˜¾éšçš„æ–°æ ·å¼ --- */

/* 1. é»˜è®¤æƒ…å†µä¸‹ï¼ŒçŠ¶æ€æ ä¾ç„¶æ˜¯éšè—çš„ */
#status-bar {
    display: none;
    /* (åŸæœ‰çš„å…¶ä»–æ ·å¼ï¼Œå¦‚é¢œè‰²ã€å­—ä½“ç­‰ï¼Œä¿æŒä¸å˜å³å¯) */
    padding: 0 20px;
    height: 40px;
    color: white;
    background-color: transparent; /* èƒŒæ™¯ç”±çˆ¶å…ƒç´ æ§åˆ¶ */
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    box-sizing: border-box;
    z-index: 100;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
    pointer-events: none; /* è®©ç‚¹å‡»å¯ä»¥ç©¿é€ */
}

/* 2. å½“ #phone-screen å…ƒç´ æ‹¥æœ‰ .status-bar-visible è¿™ä¸ª class æ—¶ï¼Œæ˜¾ç¤ºçŠ¶æ€æ  */
#phone-screen.status-bar-visible #status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
        
        .header, .qzone-header {
            position: relative;
            z-index: 15;
            flex-shrink: 0;
            padding: 15px 20px;
            /* æ ¸å¿ƒï¼šä½¿ç”¨ calc() è‡ªåŠ¨åŠ ä¸Šé¡¶éƒ¨çš„å®‰å…¨è·ç¦» */
            padding-top: calc(15px + env(safe-area-inset-top)); 
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
        }
        
        
        #status-bar { 
            display: none; 
        }
        #status-bar-time { font-weight: 600; }
        .battery-container { display: flex; align-items: center; gap: 5px; }
        .battery-icon { width: 25px; height: 12px; border: 1px solid white; border-radius: 3px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 2px; width: 2px; height: 6px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 1px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { position: relative; z-index: 15; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; }
        .header .header-actions { display: flex; align-items: center; gap: 15px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: var(--accent-color); display: flex; align-items: center; justify-content: center; }
        
        .header .action-btn {
            font-size: 16px; /* ä¸“é—¨ä¸ºâ€œä¸Šä¼ â€ã€â€œ+â€ç­‰æ–‡å­—æŒ‰é’®ç¼©å°å­—å· */
            font-weight: 600; /* å¯ä»¥åŠ ç²—ä¸€ç‚¹è®©å®ƒæ›´æ¸…æ™° */
        }
        
        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
        /* â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ä»£ç ã€‘ï¼Œå®Œæ•´æ›¿æ¢æ‰æ‚¨ç°æœ‰çš„ #home-screen, #clock-container, å’Œ #app-grid æ ·å¼ â–¼â–¼â–¼ */
        
        /* --- Start of Replacement Code --- */
        
        #home-screen {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            box-sizing: border-box;
            background-size: cover;
            background-position: center;
            padding-left: 20px;
            padding-right: 20px;
            /* We remove vertical padding here to rely on margins */
        }
        
        #clock-container {
            text-align: center;
            color: white;
            text-shadow: 0 3px 8px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            flex-shrink: 0;
            /* This is the key: pushes the clock down from the top edge */
            margin-top: calc(60px + env(safe-area-inset-top));
        }
        
        /* --- End of Replacement Code --- */
        
        /* 3. å°†Appå›¾æ ‡ç½‘æ ¼ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œç”¨ margin ä»å±å¹•åº•éƒ¨æ¨ä¸Šæ¥ */
        #app-grid {
            margin-top: auto; /* è‡ªåŠ¨è´´ç´§åº•éƒ¨ */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            padding: 20px;
            /* å…³é”®ï¼šä½¿ç”¨ margin-bottom æŠ¬é«˜å›¾æ ‡ï¼Œé€‚é…åº•éƒ¨â€œå°é»‘æ¡â€ */
            margin-bottom: calc(30px + env(safe-area-inset-bottom)); 
        }
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        #main-time {
            font-size: 88px; /* æ¨èï¼šç¨å¾®è°ƒå¤§ä¸€ç‚¹ç‚¹ï¼Œæ›´æ¥è¿‘iOSé”å±çš„æ„Ÿè§‰ */
            font-weight: 600; /* æ ¸å¿ƒä¿®æ”¹1ï¼šå°†å­—ä½“ä»â€œçº¤ç»†(200)â€æ”¹ä¸ºâ€œç²—ä½“(600)â€ï¼Œè¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ */
            letter-spacing: -2px; /* æ¨èï¼šç¨å¾®æ”¶ç´§å­—é—´è·ï¼Œè®©æ•°å­—çœ‹èµ·æ¥æ›´ç´§å‡‘ */
            /* æ ¸å¿ƒä¿®æ”¹2ï¼šæŒ‡å®šå­—ä½“ï¼Œä¼˜å…ˆä½¿ç”¨è‹¹æœç³»ç»Ÿå­—ä½“ */
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif;
        }
        #main-date { 
            font-size: 22px; /* ç¨å¾®æ”¾å¤§ä¸€ç‚¹æ›´åè°ƒ */
            font-weight: normal; /* è‹¹æœé£æ ¼çš„å¸¸è§„ä½“æ—¥æœŸ */
        }
        
        #app-grid { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
        /* ä¿®æ”¹åçš„ #world-book-list æ ·å¼ */
        #world-book-list {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--secondary-bg);
            padding-top: 80px;
            margin-top: -80px;
        }
        
        /* ä¿®æ”¹åçš„ #chat-list æ ·å¼ï¼Œå»æ‰äº† padding å’Œ margin */
        #chat-list {
            flex-grow: 1;
            background-color: var(--secondary-bg);
            padding-top: 80px; 
            padding-bottom: 90px; /* ä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
            box-sizing: border-box;
        }
        
        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }
        
        /* â–¼â–¼â–¼ ç”¨è¿™å—ä»£ç æ›¿æ¢æ‰ä½ åŸæ¥çš„ #chat-messages æ ·å¼ â–¼â–¼â–¼ */
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden; /* æ ¸å¿ƒä¿®æ­£1: å¼ºåˆ¶ç¦æ­¢æ°´å¹³æ»šåŠ¨/æ‹–åŠ¨ */
            padding: 10px 15px; /* æ ¸å¿ƒä¿®æ­£2: å°†å·¦å³å†…è¾¹è·å¢åŠ åˆ°15pxï¼Œæä¾›æ›´å¤šå‘¼å¸ç©ºé—´ */
            padding-top: 110px;
            margin-top: -80px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·è®¡ç®—æ­£ç¡® */
        }
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }
        
        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }
        
        .message-wrapper.ai .sender-name {
            margin-left: 50px; /* ç¨å¾®è°ƒæ•´ï¼Œä¸å¤´åƒå¯¹é½ */
            margin-bottom: 3px;
            position: absolute; /* è®©å®ƒè„±ç¦»æµï¼Œé¿å…å½±å“æ°”æ³¡å¯¹é½ */
            top: -16px;       /* å®šä½åˆ°æ°”æ³¡ä¸Šæ–¹ */
            left: 0;
        }
        
        /* === ã€å…¨æ–°ã€‘æ¶ˆæ¯å¸ƒå±€ä¸æ—¶é—´æˆ³æ ·å¼ === */
        
        /* 1. æ¶ˆæ¯å•å…ƒçš„æ€»å®¹å™¨ (é‡æ„) */
        .message-wrapper {
            display: flex;          /* ä½¿ç”¨Flexå¸ƒå±€ */
            gap: 8px;               /* æ°”æ³¡å’Œæ—¶é—´æˆ³ä¹‹é—´çš„é—´è· */
            align-items: flex-end;  /* æ ¸å¿ƒï¼šè®©æ°”æ³¡å’Œæ—¶é—´æˆ³åº•éƒ¨å¯¹é½ */
            position: relative;
            max-width: 90%;         /* å¯ä»¥ç¨å¾®æ”¾å®½ä¸€ç‚¹ï¼Œå› ä¸ºæ—¶é—´æˆ³ç°åœ¨åœ¨å¤–é¢äº† */
        }
        
        /* 2. AIæ¶ˆæ¯å•å…ƒé å·¦ */
        .message-wrapper.ai {
            align-self: flex-start;
            flex-direction: row; /* å¤´åƒã€æ°”æ³¡ã€æ—¶é—´æˆ³ï¼Œä»å·¦åˆ°å³æ’åˆ— */
        }
        
        /* 3. ç”¨æˆ·æ¶ˆæ¯å•å…ƒé å³ */
        .message-wrapper.user {
            align-self: flex-end;
            flex-direction: row-reverse; /* æ—¶é—´æˆ³ã€æ°”æ³¡ã€å¤´åƒï¼Œä»å³åˆ°å·¦æ’åˆ— */
        }
        
        /* 4. æ°”æ³¡å’Œå¤´åƒçš„ç›´æ¥å®¹å™¨ (ä¿æŒä¸å˜) */
        .message-bubble {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 100%;
            min-width: 0; /* <-- æ ¸å¿ƒä¿®å¤ï¼šå…è®¸æ°”æ³¡å®¹å™¨è‡ªèº«æ”¶ç¼© */
        }
        
        .timestamp {
            /* ç§»é™¤æ—§çš„ position: absolute */
            font-size: 11px;
            color: #999;
            text-shadow: 0 0 3px rgba(255,255,255,0.6);
            white-space: nowrap; /* é˜²æ­¢æ—¶é—´æ¢è¡Œ */
            margin-bottom: 5px;  /* è®©å®ƒå’Œæ°”æ³¡åº•éƒ¨æœ‰è½»å¾®çš„å¯¹é½åç§»ï¼Œæ›´ç¾è§‚ */
            flex-shrink: 0;      /* é˜²æ­¢è¢«å‹ç¼© */
        }
        
        .message-bubble.selected::after { content: 'âœ”'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }
        
        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        
        
        #chat-list-bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 15;
            display: flex;
            border-top: 1px solid var(--border-color);
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            /* æ ¸å¿ƒï¼šä¸ºåº•éƒ¨å¢åŠ å®‰å…¨è·ç¦» */
            padding-bottom: env(safe-area-inset-bottom);
        }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        /* --- è¯·ç”¨è¿™å—æ–°ä»£ç æ›¿æ¢æ—§çš„ #chat-input æ ·å¼ --- */
#chat-input {
    flex-grow: 1;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    /* æ ¸å¿ƒä¿®æ”¹ 1: è®¾ç½®ä¸€ä¸ªå›ºå®šçš„é«˜åº¦ï¼Œä¾‹å¦‚ 40px */
    height: 40px; 
    /* æ ¸å¿ƒä¿®æ”¹ 2: ç§»é™¤ max-height å±æ€§ */
    /* max-height: 100px; */ 
    resize: none;
    /* æ ¸å¿ƒä¿®æ”¹ 3: å½“å†…å®¹è¶…å‡ºé«˜åº¦æ—¶ï¼Œæ˜¾ç¤ºæ»šåŠ¨æ¡ */
    overflow-y: auto; 
    box-sizing: border-box; /* æ¨èæ·»åŠ ï¼Œç¡®ä¿å†…è¾¹è·è®¡ç®—æ­£ç¡® */
}
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: 0; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            visibility: hidden;
        }
        #notification-bar.visible {
            /* å…³é”®ï¼šåœ¨Yè½´å›åˆ°åŸä½çš„åŒæ—¶ï¼Œä¿æŒXè½´çš„å±…ä¸­å˜æ¢ */
            transform: translateX(-50%) translateY(0);
            visibility: visible;
        }
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        /* â–¼â–¼â–¼ ã€è¡¨æƒ…å«ä¹‰æ˜¾ç¤ºã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰æ‚¨ç°æœ‰çš„ .sticker-item æ ·å¼ â–¼â–¼â–¼ */

/* 1. è¡¨æƒ…é¡¹çš„æ€»å®¹å™¨ï¼Œç°åœ¨æ˜¯flexå¸ƒå±€ */
.sticker-item {
    position: relative;
    display: flex;
    flex-direction: column; /* å‚ç›´æ’åˆ—å›¾ç‰‡å’Œæ–‡å­— */
    align-items: center;    /* æ°´å¹³å±…ä¸­ */
    gap: 6px;               /* å›¾ç‰‡å’Œæ–‡å­—ä¹‹é—´çš„é—´è· */
    cursor: pointer;
}

/* 2. è¡¨æƒ…å›¾ç‰‡å®¹å™¨ (è¿™æ˜¯æ–°å¢çš„) */
.sticker-image-container {
    width: 100%;
    aspect-ratio: 1 / 1;    /* ä¿æŒæ­£æ–¹å½¢ */
    background-color: white;
    border-radius: 10px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* 3. è¡¨æƒ…å«ä¹‰æ–‡æœ¬ (è¿™æ˜¯æ–°å¢çš„) */
.sticker-name {
    font-size: 12px;           /* å­—ä½“å¤§å° */
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰² */
    width: 100%;               /* å®½åº¦æ’‘æ»¡ï¼Œä¸ºçœç•¥å·åšå‡†å¤‡ */
    text-align: center;        /* æ–‡å­—å±…ä¸­ */
    
    /* --- è¿™å°±æ˜¯å®ç°â€œè¶…å‡ºçœç•¥å·â€çš„æ ¸å¿ƒä»£ç  --- */
    white-space: nowrap;       /* å¼ºåˆ¶ä¸æ¢è¡Œ */
    overflow: hidden;          /* éšè—è¶…å‡ºçš„éƒ¨åˆ† */
    text-overflow: ellipsis;   /* å°†è¶…å‡ºçš„éƒ¨åˆ†æ˜¾ç¤ºä¸ºçœç•¥å· */
    /* --- æ ¸å¿ƒä»£ç ç»“æŸ --- */
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        /* â–¼â–¼â–¼ Safariå¼¹çª—é˜²æ”¾å¤§ä¿®æ­£ï¼šè¯·ç”¨è¿™å—æ–°æ ·å¼æ›¿æ¢æ—§çš„ .custom-modal-body input æ ·å¼ â–¼â–¼â–¼ */
        
        .custom-modal-body input {
            width: 100%;
            padding: 8px 12px; /* æ¨èï¼šç¨å¾®å¢åŠ å†…è¾¹è·ï¼Œè®©è¾“å…¥æ¡†æ›´å¥½çœ‹ */
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 16px; /* æ ¸å¿ƒä¿®æ­£ï¼šä» 14px æé«˜åˆ° 16px é˜²æ­¢è‡ªåŠ¨æ”¾å¤§ */
            box-sizing: border-box;
        }
        
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect {
            position: relative;
            -webkit-user-select: none; /* å…¼å®¹ Safari */
            user-select: none;
        }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }
        
        .checkboxes-container {
            display: none;
            position: absolute;
            /* æ ¸å¿ƒä¿®æ”¹ï¼šä¸å†ä½¿ç”¨ topï¼Œè€Œæ˜¯ç”¨ margin-top æ¥åˆ›é€ é—´è·ï¼Œæ›´ç¨³å®š */
            top: 100%; 
            margin-top: 5px; /* <-- æ–°å¢ï¼šå‘ä¸‹æ¨å¼€5åƒç´ çš„è·ç¦» */
            left: 0;
            right: 0;
            max-height: 150px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            z-index: 101;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }
        
        .checkboxes-container label {
            display: block;
            padding: 12px 15px; /* <-- ä¿®æ”¹ï¼šå¢åŠ äº†ä¸Šä¸‹å’Œå·¦å³çš„å†…è¾¹è·ï¼Œè®©æ¯ä¸€è¡Œæ›´é«˜æ›´å®½ */
            cursor: pointer;
            font-weight: normal;
            color: var(--text-primary);
            font-size: 15px; /* <-- æ–°å¢ï¼šå°†å­—ä½“å¤§å°ä»é»˜è®¤å€¼æ”¾å¤§åˆ°15px */
        }
        
        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
        .voice-duration {
            /* --- æ ¸å¿ƒä¿®æ­£ --- */
            font-size: var(--chat-font-size, 13px);
            /* --- ä¿®æ­£ç»“æŸ --- */
            font-weight: 500;
            color: var(--text-secondary);
        }
        .message-bubble.user .voice-duration { color: #3e6224; }
        
        /* â–¼â–¼â–¼ ç”¨è¿™å—ä»£ç æ›¿æ¢æ‰ä½ åŸæ¥çš„ .message-bubble .content æ ·å¼ â–¼â–¼â–¼ */
        /* é€šç”¨å†…å®¹åŒºæ ·å¼ï¼Œä¸ºæ—¶é—´æˆ³å’Œå­—ä½“å¤§å°åšå‡†å¤‡ */
        .message-bubble .content {
            position: relative;
            font-size: var(--chat-font-size, 16px);
            padding: 8px 12px;
            line-height: 1.5;
            word-break: break-word; /* æ ¸å¿ƒä¿®æ­£: å¼ºåˆ¶é•¿å•è¯æˆ–URLæ¢è¡Œï¼Œé˜²æ­¢æ’‘ç ´æ°”æ³¡ */
        
        }
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        
        /* === æ°”æ³¡ä¸»é¢˜æ ·å¼ === */
        .message-bubble.user .content { background-color: rgba(255, 255, 255, 0.75); color: #585858; border-radius: 8px 2px 8px 8px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: #585858; border-radius: 2px 8px 8px 8px; }
              
        .message-bubble::after {
            content: "";
            position: absolute;
            width: 20px;  
            height: 20px; 
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 1; 
            z-index: 1;
        }
              
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #fffde4; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        
        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: 'ğŸ¾'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
       .playlist-body {
    flex-grow: 1;
    overflow-y: auto;
    /* æ ¸å¿ƒä¿®å¤ï¼šå°† padding-bottom æ˜¾è‘—å¢å¤§ï¼Œç¡®ä¿æœ€åä¸€æ¡æ­Œæ›²ä¸ä¼šè¢«é®æŒ¡ */
    /* åŒæ—¶ä½¿ç”¨ box-sizing ç¡®ä¿å†…è¾¹è·è®¡ç®—æ­£ç¡® */
    padding: 10px 0 80px 0;
    box-sizing: border-box;
}
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }
        
        /* Persona Library Styles */
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }
        
        /* è¿™æ˜¯ä½ è¦æ·»åŠ çš„æ–°æ ·å¼ */
        #font-preview {
            transition: font-family 0.3s ease;}
        
        /* === èŠå¤©åˆ—è¡¨ç•Œé¢æ–°å¢æ ·å¼ (è¿™æ˜¯æ–°æ·»åŠ çš„) === */
        #chat-list-screen {
        }
        
        .chat-list-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1; 
        }
        .chat-list-view.active {
            opacity: 1;
            visibility: visible;
            z-index: 2; 
        }
        
        #messages-view {
            overflow-y: auto; 
        }
        
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .nav-item.active {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        /* === åŠ¨æ€ç•Œé¢ (QZone) æ ·å¼ (è¿™æ˜¯æ–°æ·»åŠ çš„) === */
        #qzone-screen {
            background-color: #f0f2f5;
        }
        
        .qzone-header {
            /* position: absolute;  <-- æŠŠè¿™ä¸ªæ”¹æˆ relative */
            position: relative;
            z-index: 10; /* z-index ä¿æŒï¼Œæˆ–è€…å¯ä»¥æ›´é«˜ */
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
            padding: 15px 20px;
            padding-top: 45px;
            background-color: rgba(247, 247, 247, 0.7); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }
        
        .qzone-header .back-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--accent-color);
        }
        
        .qzone-header span:nth-child(2) { /* "å¥½å‹åŠ¨æ€"æ–‡å­— */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .qzone-content {
            flex-grow: 1;
            overflow-y: auto;
            /* padding-top: 80px;  <-- åˆ é™¤è¿™ä¸ªï¼Œå› ä¸ºheaderä¸å†æ˜¯absoluteäº† */
        }
        
        .qzone-profile-header {
            position: relative;
            margin-bottom: 20px;
        }
        
        .qzone-banner-container {
            width: 100%;
            height: 180px; /* èƒŒæ™¯æ¿é«˜åº¦ */
            position: relative;
        }
        
        #qzone-banner-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .qzone-user-info {
            position: absolute;
            bottom: -30px; /* è®©å¤´åƒå’Œæ˜µç§°åŒºåŸŸå‘ä¸‹åç§»ï¼Œä¸€åŠåœ¨èƒŒæ™¯æ¿å†…ï¼Œä¸€åŠåœ¨å¤– */
            left: 20px;
            display: flex;
            align-items: flex-end; /* è®©æ˜µç§°å’Œå¤´åƒåº•éƒ¨å¯¹é½ */
            gap: 10px;
        }
        
        .qzone-avatar-container {
            position: relative;
        }
        
        #qzone-avatar-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            object-fit: cover;
        }
        
        #qzone-nickname {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            padding-bottom: 5px; /* å¾®è°ƒä½ç½® */
        }
        
        /* ç¼–è¾‘æŒ‰é’®çš„é€šç”¨æ ·å¼ */
        .qzone-edit-btn {
            position: absolute;
            background-color: rgba(0,0,0,0.4);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        #change-qzone-banner-btn {
            bottom: 10px;
            right: 10px;
        }
        
        #change-qzone-avatar-btn {
            bottom: 5px;
            right: 5px;
        }
        
        #change-qzone-nickname-btn {
            font-size: 14px;
            padding: 2px 6px;
            margin-left: 5px; /* ä¸æ˜µç§°çš„é—´è· */
            color: var(--text-primary);
            background-color: rgba(255,255,255,0.7);
            border-radius: 5px;
            position: relative; /* è„±ç¦»flexå¸ƒå±€çš„å¯¹é½ */
            bottom: 5px; /* å¾®è°ƒå‚ç›´ä½ç½® */
        }
        
        /* === è®©ç¼–è¾‘åŠŸèƒ½æ›´â€œéšå½¢â€ === */
        #qzone-banner-container,
        #qzone-avatar-container,
        #qzone-nickname {
            cursor: pointer; /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¸ºå¯ç‚¹å‡»æ‰‹åŠ¿ */
            transition: opacity 0.2s;
        }
        #qzone-banner-container:hover,
        #qzone-avatar-container:hover,
        #qzone-nickname:hover {
            opacity: 0.85; /* æ‚¬åœæ—¶ç¨å¾®å˜æš—ï¼Œç»™ç”¨æˆ·åé¦ˆ */
        }
        /* éšè—æ‰æ—§çš„ã€ç‹¬ç«‹çš„ç¼–è¾‘æŒ‰é’® */
        .qzone-edit-btn {
            display: none;
        }
        
        /* === æ§åˆ¶ Header å’Œ Bottom Nav çš„æ˜¾éš === */
        /* é»˜è®¤éšè—åŠ¨æ€ç•Œé¢çš„ Header */
        #qzone-screen .qzone-header {
            display: none;
        }
        /* å½“åŠ¨æ€è§†å›¾æ¿€æ´»æ—¶ï¼Œæ˜¾ç¤ºå®ƒçš„Header */
        #qzone-screen.active .qzone-header {
            display: flex;
        }
        
        /* å½“è¿›å…¥åŠ¨æ€è§†å›¾æ—¶ï¼Œéšè—ä¸»Headerå’Œåº•éƒ¨å¯¼èˆªæ  */
        #chat-list-screen.in-qzone-view > .header,
        #chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
            display: none;
        }
        
        .chat-list-item:first-child,
        .chat-group-container:first-child {
            margin-top: 10px; 
        }
        
        /* â–²â–²â–² æ–°æ ·å¼æ›¿æ¢ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ æŠŠæ‰€æœ‰è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === åŠ¨æ€åŠŸèƒ½æ æ ·å¼ === */
        .qzone-actions-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            margin: 40px 15px 15px 15px; /* ä¸Šè¾¹è·æ›´å¤§ï¼Œä¸ºæµ®åŠ¨çš„å¤´åƒç•™å‡ºç©ºé—´ */
            background-color: var(--secondary-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .action-item {
            flex: 1;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 0;
            position: relative;
        }
        
        /* ç”¨ä¼ªå…ƒç´ åˆ›å»ºåˆ†éš”çº¿ */
        .action-item:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 20px;
            background-color: var(--border-color);
        }
        
        /* === åŠ¨æ€å¸–å­åˆ—è¡¨æ ·å¼ === */
        #qzone-posts-list {
            padding: 0 15px 20px 15px; /* å·¦å³å’Œåº•éƒ¨ç•™å‡ºè¾¹è· */
            display: flex;
            flex-direction: column;
            gap: 20px; /* å¸–å­ä¹‹é—´çš„é—´è· */
        }
        
        .qzone-post-item {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        
        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .post-header .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .post-info {
            display: flex;
            flex-direction: column;
        }
        
        .post-info .post-nickname {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }
        
        .post-info .post-timestamp {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .post-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap; /* è®©æ¢è¡Œç¬¦ç”Ÿæ•ˆ */
            word-break: break-word; /* é˜²æ­¢é•¿å•è¯æº¢å‡º */
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ æ–°æ ·å¼ç²˜è´´åˆ°æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡†æ ·å¼ === */
        #post-public-text {
            min-height: 80px; /* ç¡®ä¿æ–‡æœ¬åŸŸæœ‰è¶³å¤Ÿçš„é«˜åº¦ */
            resize: vertical;
        }
        
        .post-image-preview-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9; /* ä¿æŒ16:9çš„é¢„è§ˆæ¯”ä¾‹ */
            background-color: #f0f2f5;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            display: none; /* é»˜è®¤éšè— */
            justify-content: center;
            align-items: center;
        }
        .post-image-preview-container.visible {
            display: flex; /* ä¸Šä¼ åæ˜¾ç¤º */
        }
        
        #post-image-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }
        
        #post-remove-image-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ff3b30;
            color: white;
            border: 2px solid white;
            font-size: 16px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }
        
        .post-image-upload-options {
            display: flex;
            gap: 10px;
        }
        
        .post-image-upload-options button {
            flex: 1;
            margin-top: 0;
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ æ–°æ ·å¼ â–¼â–¼â–¼ */
        
        /* === å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡† - æ¨¡å¼åˆ‡æ¢æ ·å¼ === */
        .post-mode-switcher {
            display: flex;
            margin-bottom: 20px;
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 4px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background-color: transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        
        .mode-btn.active {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .post-mode-content {
            display: none; /* é»˜è®¤éƒ½éšè— */
        }
        
        .post-mode-content.active {
            display: block; /* æ¿€æ´»çš„æ‰æ˜¾ç¤º */
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */
        
        /* === ç›¸å†Œé¡µé¢èƒŒæ™¯è‰² === */
        #album-screen {
            background-color: #f0f2f5; /* ä½¿ç”¨ä¸€ä¸ªæŸ”å’Œçš„æµ…ç°è‰²ï¼Œæ¯”çº¯ç™½æ›´æŠ¤çœ¼ */
        }
        
        /* === ç›¸å†Œé¡µé¢ç½‘æ ¼å¸ƒå±€ === */
        #album-grid-page {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* æ¯è¡Œæ˜¾ç¤º2ä¸ªç›¸å†Œ */
            gap: 15px;
        }
        
        /* === ç›¸å†Œé¡¹ç›®æ ·å¼ (ç¾åŒ–) === */
        .album-item {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 8px; /* ç»™æ•´ä¸ªé¡¹ç›®ä¹ŸåŠ ä¸ªåœ†è§’ */
        }
        
        .album-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .album-cover {
            aspect-ratio: 1 / 1; /* ä¿æŒå°é¢ä¸ºæ­£æ–¹å½¢ */
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: #f0f2f5; /* å°é¢åŠ è½½å‰çš„å ä½é¢œè‰² */
        }
        
        .album-info {
            text-align: center;
        }
        
        .album-name {
            font-weight: 500;
            margin: 0 0 4px 0;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* é˜²æ­¢é•¿åå­—æ¢è¡Œ */
        }
        
        .album-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* â–²â–²â–² æ–°çš„ CSS ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ç›¸å†Œç…§ç‰‡è¯¦æƒ…é¡µ === */
        #album-photos-screen {
            background-color: #f0f2f5;
        }
        
        #photos-grid-page {
            padding: 15px;
            display: grid;
            /* æ¯è¡Œæ˜¾ç¤º3å¼ ç…§ç‰‡ï¼Œå¹¶ä¿æŒé—´è· */
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .photo-item {
            position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
            aspect-ratio: 1 / 1; /* ä¿æŒç…§ç‰‡ä¸ºæ­£æ–¹å½¢ */
            border-radius: 6px;
            overflow: hidden; /* é˜²æ­¢å›¾ç‰‡æº¢å‡ºåœ†è§’ */
            background-color: #e9ecef; /* å›¾ç‰‡åŠ è½½å‰çš„å ä½ç¬¦é¢œè‰² */
        }
        
        .photo-item .photo-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover; /* ä¿è¯å›¾ç‰‡å¡«æ»¡å®¹å™¨ä¸”ä¸å˜å½¢ */
            cursor: pointer;
        }
        
        /* åˆ é™¤æŒ‰é’®çš„æ ·å¼ */
        .photo-item .photo-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 22px;
            height: 22px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            opacity: 0; /* é»˜è®¤éšè— */
            transition: opacity 0.2s ease;
        }
        
        /* é¼ æ ‡æ‚¬åœåœ¨ç…§ç‰‡ä¸Šæ—¶æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
        .photo-item:hover .photo-delete-btn {
            opacity: 1;
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* === å›¾ç‰‡æŸ¥çœ‹å™¨æ¨¡æ€æ¡†æ ·å¼ === */
        #photo-viewer-modal {
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1002;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }
        
        .photo-viewer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        
        #photo-viewer-image {
            max-width: 90vw;  /* å›¾ç‰‡æœ€å¤§å®½åº¦ä¸ºè§†å£çš„90% */
            max-height: 85vh; /* å›¾ç‰‡æœ€å¤§é«˜åº¦ä¸ºè§†å£çš„85% */
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            /* ä¸ºå›¾ç‰‡çš„åˆ‡æ¢æ·»åŠ ä¸€ç‚¹å¹³æ»‘çš„æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
            transition: opacity 0.2s ease-in-out;
        }
        
        /* å…³é—­æŒ‰é’® */
        #photo-viewer-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 40px;
            font-weight: 200;
            cursor: pointer;
            line-height: 1;
            text-shadow: 0 0 5px black;
        }
        
        /* å·¦å³å¯¼èˆªç®­å¤´ */
        #photo-viewer-modal .nav-arrow {
            position: absolute; /* ç°åœ¨æˆ‘ä»¬ç”¨ç»å¯¹å®šä½æ¥æ§åˆ¶ç®­å¤´ */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 50px; /* åœ¨æ‰‹æœºå±å¹•ä¸Šï¼Œå¯ä»¥ç¨å¾®å°ä¸€ç‚¹ */
            font-weight: 100;
            cursor: pointer;
            padding: 10px; /* è°ƒæ•´å†…è¾¹è· */
        -webkit-user-select: none; /* å…¼å®¹ Safari */
            user-select: none;
            transition: color 0.2s;
            z-index: 1003; /* ç¡®ä¿ç®­å¤´åœ¨æœ€ä¸Šå±‚ */
        }
        
        #photo-viewer-prev-btn {
            left: 5px; /* å®šä½å·¦ç®­å¤´ */
        }
        
        #photo-viewer-next-btn {
            right: 5px; /* å®šä½å³ç®­å¤´ */
        }
        
        #photo-viewer-modal .nav-arrow:hover {
            color: white;
        }
        
        /* å½“ç®­å¤´è¢«ç¦ç”¨æ—¶ï¼ˆæ¯”å¦‚ç¬¬ä¸€å¼ æˆ–æœ€åä¸€å¼ ï¼‰ */
        #photo-viewer-modal .nav-arrow:disabled {
            color: rgba(255, 255, 255, 0.2);
            cursor: default;
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* â–¼â–¼â–¼ è¯·ç”¨è¿™å—æ–°CSSæ›¿æ¢æ‰ä¸Šä¸€ç‰ˆçš„äº¤äº’åŒºCSS â–¼â–¼â–¼ */
        
        /* === å¸–å­å†…å®¹åŒº - ç›¸å¯¹å®šä½å®¹å™¨ === */
        /* === å¸–å­å†…å®¹åŒº === */
        .post-main-content {
            /* å®ƒç°åœ¨åªæ˜¯ä¸€ä¸ªæ™®é€šçš„å†…å®¹å®¹å™¨ï¼Œä¸å†éœ€è¦ç‰¹æ®Šæ ·å¼äº† */
        }
        
        /* === å¸–å­äº’åŠ¨å›¾æ ‡åŒº (æ–°æ ·å¼) === */
        .post-feedback-icons {
            display: flex;
            justify-content: flex-end; /* è®©å›¾æ ‡é å³å¯¹é½ */
            align-items: center;
            gap: 12px;
            padding: 8px 0; /* æ ¸å¿ƒä¿®æ”¹ï¼šç»™å›¾æ ‡åŒºåŸŸä¸Šä¸‹å„8pxçš„ç•™ç™½ */
        }
        
        .action-icon {
            cursor: pointer;
            color: var(--text-secondary); /* é»˜è®¤ç°è‰² */
            transition: all 0.2s ease-in-out;
        }
        
        .action-icon svg {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* å›¾æ ‡æ¿€æ´»(ç‚¹èµ/æ”¶è—å)çš„æ ·å¼ */
        .action-icon.active {
            color: #ff5252; /* æ¿€æ´»åå˜çº¢è‰² */
            transform: scale(1.1); /* è½»å¾®æ”¾å¤§ */
        }
        
        .action-icon.active.favorite {
            color: #ffc107; /* æ”¶è—ç”¨é»„è‰² */
        }
        
        .action-icon.active svg {
            fill: currentColor; /* æ¿€æ´»åå¡«å……é¢œè‰² */
        }
        
        /* ç‚¹å‡»æ—¶çš„åŠ¨ç”»æ•ˆæœ */
        .animate-like {
            animation: like-bounce 0.4s ease-in-out;
        }
        
        @keyframes like-bounce {
            0%   { transform: scale(1); }
            25%  { transform: scale(0.8); }
            50%  { transform: scale(1.2); }
            75%  { transform: scale(1.05); }
            100% { transform: scale(1.1); }
        }
        
        
        /* === å¸–å­åº•éƒ¨è¯„è®ºåŒºæ ·å¼ (ç°åœ¨æ˜¯ç‹¬ç«‹éƒ¨åˆ†) === */
        .post-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0; /* ç”¨ä¸€æ¡æµ…è‰²çº¿åˆ†éš” */
            display: flex;
            align-items: center;
            gap: 8px; /* è°ƒæ•´æ•´ä½“é—´è· */
        }
        
        /* è¯„è®ºåŒºå®¹å™¨ */
        .comment-section {
            flex-grow: 1; /* å æ®å¤§éƒ¨åˆ†ç©ºé—´ */
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .comment-section .comment-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        /* â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°æ ·å¼ â–¼â–¼â–¼ */
        .comment-section {
            position: relative; /* æ ¸å¿ƒä¿®æ­£ï¼šä¸ºå¼¹çª—å»ºç«‹å®šä½çš„é”šç‚¹ */
        }
        /* â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ Safarié˜²æ”¾å¤§ä¿®æ­£ï¼šè¯·ç”¨ä¸‹é¢è¿™ä¸¤å—æ–°æ ·å¼ï¼Œæ›¿æ¢æ—§çš„ .comment-input å’Œ .comment-send-btn æ ·å¼ â–¼â–¼â–¼ */
        
        .comment-section .comment-input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            background-color: #f0f2f5;
            border-radius: 14px;
            font-size: 16px; /* æ ¸å¿ƒä¿®æ­£ï¼šä» 13px æé«˜åˆ° 16px é˜²æ­¢è‡ªåŠ¨æ”¾å¤§ */
            outline: none;
        }
        
        /* (æ¨è) åŒæ—¶è°ƒæ•´å‘é€æŒ‰é’®ï¼Œä¿æŒè§†è§‰ç»Ÿä¸€ */
        .comment-send-btn {
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
            padding: 8px 15px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            border-radius: 14px;
            font-size: 16px; /* ä» 13px è°ƒæ•´ä¸º 16px */
            font-weight: 500;
            cursor: pointer;
        }
        
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === æœªè¯»æ¶ˆæ¯å°çº¢ç‚¹é€šç”¨æ ·å¼ === */
        .unread-indicator {
            position: absolute;
            top: -8px;      
            right: -15px;    
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background-color: #ff3b30;
            color: white;
            font-size: 11px;
            font-weight: bold;
            line-height: 18px;
            text-align: center;
            border-radius: 9px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            display: none;
            z-index: 1;
        }
        
        /* èŠå¤©ç•Œé¢è¿”å›æŒ‰é’®ä¸Šçš„å°çº¢ç‚¹ (åªæ˜¾ç¤ºç‚¹ï¼Œä¸æ˜¾ç¤ºæ•°å­—) */
        .back-btn-indicator {
            top: 0;
            right: -8px; /* æ”¾åˆ°è¿”å›ç®­å¤´å³ä¸Šè§’ */
            width: 10px;
            height: 10px;
            min-width: 10px;
            padding: 0;
            border-radius: 50%;
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === è¯„è®ºåˆ—è¡¨å®¹å™¨ === */
        .post-comments-container {
            padding: 10px 0; /* ä¸Šä¸‹ç•™ç™½ */
            display: flex;
            flex-direction: column;
            gap: 8px; /* è¯„è®ºä¹‹é—´çš„é—´è· */
            font-size: 13px; /* ç»Ÿä¸€è¯„è®ºåŒºå­—ä½“å¤§å° */
        }
        
        /* æ¯ä¸€æ¡è¯„è®º */
        .comment-item {
            line-height: 1.5;
        }
        
        /* è¯„è®ºè€…çš„åå­—ï¼ŒåŠ ç²—å¹¶ä½¿ç”¨ä¸»é¢˜è‰² */
        .comment-item .commenter-name {
            font-weight: 600;
            color: var(--accent-color);
            cursor: pointer;
            margin-right: 5px; /* å’Œè¯„è®ºå†…å®¹ä¹‹é—´ç•™ç‚¹ç©ºéš™ */
        }
        
        /* è¯„è®ºå†…å®¹ */
        .comment-item .comment-text {
            color: var(--text-primary);
            word-break: break-word;
        }
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === å¸–å­ç‚¹èµåŒºåŸŸæ ·å¼ === */
        .post-likes-section {
            display: flex;
            align-items: center;
            gap: 6px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
            padding: 8px 10px; /* å†…è¾¹è· */
            font-size: 13px;
            color: var(--accent-color); /* ä½¿ç”¨ä¸»é¢˜è“è‰² */
            background-color: #f0f5fa; /* ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
            border-top: 1px solid #e9eef3;
            border-bottom: 1px solid #e9eef3;
            margin-top: 5px; /* å’Œä¸Šæ–¹çš„å›¾æ ‡ä¿æŒä¸€ç‚¹è·ç¦» */
        }
        
        .post-likes-section .like-icon {
            width: 16px;
            height: 16px;
            fill: currentColor; /* è®©SVGå›¾æ ‡ç»§æ‰¿çˆ¶å…ƒç´ çš„é¢œè‰² */
            flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === @æåŠ å¼¹å‡ºèœå•æ ·å¼ === */
        .at-mention-popup {
            position: absolute; /* ç›¸å¯¹äºçˆ¶å…ƒç´ å®šä½ */
            bottom: 100%; /* æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†çš„ä¸Šæ–¹ */
            left: 40px; /* å’Œè¾“å…¥æ¡†å·¦ä¾§å¯¹é½ (è€ƒè™‘äº†å¤´åƒå®½åº¦) */
            width: calc(100% - 40px); /* å®½åº¦å’Œè¾“å…¥æ¡†å·®ä¸å¤š */
            max-height: 120px;
            overflow-y: auto;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 10;
            display: none; /* é»˜è®¤éšè— */
        }
        
        .at-mention-item {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            color: var(--text-primary);
            border-bottom: 1px solid #f0f0f0;
        }
        
        .at-mention-item:last-child {
            border-bottom: none;
        }
        
        .at-mention-item:hover {
            background-color: #f5f5f5;
        }
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™æ®µã€æ–°æ ·å¼ã€‘æ›¿æ¢æ‰ä½ ç°æœ‰çš„ #favorites-list æ ·å¼ â–¼â–¼â–¼ */
        
        /* è®©æ”¶è—è§†å›¾æˆä¸ºä¸€ä¸ªflexå®¹å™¨, ä»ä¸Šåˆ°ä¸‹æ’åˆ— */
        #favorites-view {
            display: flex;
            flex-direction: column;
        }
        
        /* ç¡®ä¿æ”¶è—é¡µçš„headeré«˜åº¦å›ºå®šï¼Œä¸è¢«å‹ç¼© */
        #favorites-view > .header {
            flex-shrink: 0;
        }
        
        /* === æ”¶è—åˆ—è¡¨æ ·å¼ (ä¿®æ­£å) === */
        #favorites-list {
            flex-grow: 1; 
            overflow-y: auto; 
            overflow-x: hidden; /* <-- æ–°å¢è¿™è¡Œï¼Œç¦æ­¢æ°´å¹³æ»šåŠ¨ */
            padding: 15px; 
            display: flex;
            flex-direction: column;
            gap: 15px; 
        }
        
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        
        .favorite-item-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
        }
        
        /* å¡ç‰‡å¤´éƒ¨ï¼ŒåŒ…å«å¤´åƒã€åå­—å’Œæ¥æº */
        .fav-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .fav-card-header .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .fav-card-header .info {
            flex-grow: 1;
        }
        
        .fav-card-header .name {
            font-weight: 600;
            font-size: 15px;
        }
        
        .fav-card-header .source {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* å¡ç‰‡å†…å®¹ */
        .fav-card-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .fav-card-content .chat-image {
            margin-top: 8px; /* å›¾ç‰‡å’Œæ–‡å­—çš„é—´è· */
        }
        
        /* åˆ é™¤æŒ‰é’® */
        .fav-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: #f0f2f5;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-secondary);
            line-height: 28px;
            text-align: center;
        }
        
        .fav-delete-btn:hover {
            background-color: #e9ecef;
            color: #ff3b30;
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === æœç´¢æ æ ·å¼ === */
        .search-bar-container {
            padding: 10px 15px;
            background-color: #f9f9f9; /* å’Œåˆ—è¡¨èƒŒæ™¯è‰²ä¿æŒä¸€è‡´ */
            position: relative; /* ä¸ºäº†å®šä½æ¸…é™¤æŒ‰é’® */
            flex-shrink: 0;
        }
        
        #favorites-search-input {
            width: 100%;
            padding: 10px 30px 10px 15px; /* å³ä¾§ç•™å‡ºæ¸…é™¤æŒ‰é’®çš„ä½ç½® */
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 18px; /* åœ†è§’çŸ©å½¢ï¼Œæ›´ç°ä»£åŒ– */
            background-color: var(--secondary-bg);
            box-sizing: border-box;
            outline: none;
        }
        #favorites-search-input:focus {
            border-color: var(--accent-color);
        }
        
        .search-clear-btn {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            background: #ccc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* === èŠå¤©ç•Œé¢å¤šé€‰æ“ä½œæ ä¼˜åŒ– === */
        #chat-interface-screen .header .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        #chat-interface-screen .selection-controls .action-btn {
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            padding: 5px;
        }
        
        /* === æ”¶è—é¡µé¢å¤šé€‰æ¨¡å¼æ ·å¼ === */
        #favorites-view.selection-mode .favorite-item-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        /* é€‰æ‹©æ¡†çš„æ ·å¼ */
        .favorite-item-card::before {
            content: '';
            position: absolute;
            left: -25px; /* æŠŠå®ƒæ”¾åœ¨å¡ç‰‡å·¦è¾¹å¤–é¢ */
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            background-color: white;
            transition: all 0.2s ease;
            opacity: 0; /* é»˜è®¤éšè— */
        }
        
        /* è¿›å…¥é€‰æ‹©æ¨¡å¼æ—¶ï¼Œå¡ç‰‡å‘å³ç§»åŠ¨ï¼Œéœ²å‡ºé€‰æ‹©æ¡† */
        #favorites-view.selection-mode .favorite-item-card {
            transform: translateX(35px);
        }
        #favorites-view.selection-mode .favorite-item-card::before {
            opacity: 1;
        }
        
        /* é€‰ä¸­åçš„æ ·å¼ */
        #favorites-view.selection-mode .favorite-item-card.selected::before {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            content: 'âœ”';
            color: white;
            font-size: 14px;
            text-align: center;
            line-height: 20px;
        }
        
        /* åº•éƒ¨æ“ä½œæ  (ç»ˆæä¿®æ­£ç‰ˆ) */
        #favorites-action-bar {
            position: absolute; /* â˜… æ”¹ä¸º absoluteï¼Œç›¸å¯¹äº #phone-screen å®šä½ */
            bottom: 0;
            left: 0;
            right: 0;           /* â˜… æ–°å¢ right: 0ï¼Œå’Œ left: 0 ä¸€èµ·æ’‘æ»¡å®½åº¦ */
            width: auto;        /* â˜… æ”¹ä¸º autoï¼Œè®© left/right å†³å®šå®½åº¦ */
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* é€‚é…iPhoneåº•éƒ¨å®‰å…¨åŒº */
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            box-sizing: border-box;
            z-index: 5;
            display: none;
            /* max-width å·²ç»ä¸éœ€è¦äº†ï¼Œå› ä¸ºçˆ¶å…ƒç´ å·²ç»é™åˆ¶äº†å®½åº¦ */
        }
        
        #favorites-action-bar .action-bar-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
        
        /* === ã€ä¿®æ­£ã€‘èŠå¤©ç•Œé¢å¤´éƒ¨æ§ä»¶åˆ‡æ¢é€»è¾‘ === */
        
        /* é»˜è®¤çŠ¶æ€ï¼šéšè—å¤šé€‰æ§ä»¶ */
        #chat-interface-screen .header .selection-controls {
            display: none;
        }
        
        /* é»˜è®¤çŠ¶æ€ï¼šæ˜¾ç¤ºé»˜è®¤æ§ä»¶ï¼Œå¹¶è®©å®ƒæ’‘æ»¡æ•´ä¸ªå¤´éƒ¨ */
        #chat-interface-screen .header .default-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        /* å½“è¿›å…¥å¤šé€‰æ¨¡å¼æ—¶ï¼šéšè—é»˜è®¤æ§ä»¶ */
        #chat-interface-screen.selection-mode .header .default-controls {
            display: none;
        }
        
        /* å½“è¿›å…¥å¤šé€‰æ¨¡å¼æ—¶ï¼šæ˜¾ç¤ºå¤šé€‰æ§ä»¶ï¼Œå¹¶è®©å®ƒæ’‘æ»¡æ•´ä¸ªå¤´éƒ¨ */
        #chat-interface-screen.selection-mode .header .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ä¿®æ­£ï¼šæ”¾å¤§æ‰€æœ‰ä¸»è¦çš„â€œ+â€å·æŒ‰é’® === */
        #add-chat-btn,
        #add-world-book-btn,
        #create-album-btn-page {
            font-size: 28px;   /* æ˜¾è‘—å¢å¤§å­—ä½“å¤§å°ï¼Œä½¿å…¶è§†è§‰ä¸Šä¸æ—è¾¹çš„å›¾æ ‡åŒ¹é… */
            font-weight: 300;  /* ä½¿ç”¨æ›´ç»†çš„å­—é‡ï¼Œè®©åŠ å·çœ‹èµ·æ¥æ›´æ¸…çˆ½ï¼Œä¸æ˜¾ç²—ç¬¨ */
            position: relative;/* å…è®¸è¿›è¡Œä½ç½®å¾®è°ƒ */
            top: -1px;         /* å­—ä½“æ”¾å¤§åï¼Œé€šå¸¸éœ€è¦ç¨å¾®å‘ä¸Šç§»åŠ¨ä¸€ç‚¹ï¼Œä½¿å…¶è§†è§‰ä¸Šæ›´å±…ä¸­ */
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* é¢„è§ˆåŒºå®¹å™¨æ ·å¼ */
        #settings-preview-area {
            width: 100%;
            height: 180px; /* ç»™ä¸€ä¸ªå›ºå®šçš„é«˜åº¦ */
            background-color: #f0f2f5;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
            display: flex;
            flex-direction: column;
            gap: 10px; /* é¢„è§ˆæ°”æ³¡ä¹‹é—´çš„é—´è· */
            border: 1px solid var(--border-color);
            position: relative; /* ä¸ºäº†å®šä½èƒŒæ™¯ */
        }
        
        /* é¢„è§ˆåŒºçš„èƒŒæ™¯ï¼Œå¯ä»¥å’ŒçœŸå®èŠå¤©ç•Œé¢åŒæ­¥ */
        #settings-preview-area::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 1;
            opacity: 0.8;
        }
        
        /* è®©é¢„è§ˆæ°”æ³¡åœ¨èƒŒæ™¯ä¹‹ä¸Š */
        #settings-preview-area .message-wrapper {
            position: relative;
            z-index: 2;
        }
        
        /* é¢„è§ˆåŒºå†…ä½¿ç”¨çš„å¤´åƒè¦å°ä¸€ç‚¹ */
        #settings-preview-area .message-bubble .avatar {
            width: 30px;
            height: 30px;
        }
        
        #settings-preview-area .message-bubble .timestamp {
            display: none; /* é¢„è§ˆåŒºä¸éœ€è¦æ˜¾ç¤ºæ—¶é—´æˆ³ */
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        .existing-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .existing-group-item .group-name {
            font-weight: 500;
        }
        
        .existing-group-item .delete-group-btn {
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        .chat-group-container {
            border-bottom: 1px solid var(--border-color);
        }
        .chat-group-container:first-child {
            border-top: 1px solid var(--border-color);
        }
        
        .chat-group-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            background-color: #f7f7f7;
        }
        
        .chat-group-header .arrow {
            font-size: 14px;
            margin-right: 8px;
            transition: transform 0.2s ease;
        }
        
        .chat-group-header.collapsed .arrow {
            transform: rotate(-90deg);
        }
        
        .chat-group-header .group-name {
            font-weight: 600;
            font-size: 15px;
        }
        
        .chat-group-content {
            max-height: 1000px; /* ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å€¼ */
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        
        .chat-group-content.collapsed {
            max-height: 0;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* æ ¼å¼åŠ©æ‰‹æŒ‰é’®çš„å®¹å™¨ */
        .format-helpers {
            display: flex;
            gap: 10px;
            margin-bottom: 15px; /* ä¸ä¸‹æ–¹çš„æ–‡æœ¬æ¡†æ‹‰å¼€è·ç¦» */
            flex-wrap: wrap; /* å¦‚æœæŒ‰é’®å¤ªå¤šå¯ä»¥æ¢è¡Œ */
        }
        
        /* å•ä¸ªæ ¼å¼åŠ©æ‰‹æŒ‰é’®çš„æ ·å¼ */
        .format-btn {
            background-color: #e9ecef;
            color: var(--text-primary);
            border: none;
            padding: 6px 12px;
            border-radius: 16px; /* èƒ¶å›Šå½¢çŠ¶ï¼Œæ›´å‹å¥½ */
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .format-btn:hover {
            background-color: #dcdfe3;
        }
        
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* â€œâ€¦â€æŒ‰é’®çš„æ ·å¼ */
        .post-actions-btn {
            margin-left: auto; /* å…³é”®ï¼šè®©å®ƒè‡ªåŠ¨é åˆ°æœ€å³è¾¹ */
            padding: 5px 10px;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            line-height: 1;
        }
        .post-actions-btn:hover {
            background-color: #f0f0f0;
        }
        
        /* åŠ¨æ€ç¼–è¾‘æ¨¡æ€æ¡†çš„æ ·å¼ (å®ƒå°†å¤ç”¨ç°æœ‰çš„æ“ä½œèœå•æ ·å¼) */
        #post-actions-modal .custom-modal-footer button {
            width: 100%;
            border: none;
            border-bottom: 1px solid #dbdbdb;
            padding: 14px;
            font-size: 18px;
        }
        #post-actions-modal .custom-modal-footer button:last-child {
            border-bottom: none;
        }
        #post-actions-modal #cancel-post-action-btn {
            margin-top: 8px;
            border-radius: 8px;
            background-color: #f0f0f0;
        }
        
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* ç»Ÿä¸€é‡ç½®è½¬è´¦å¡ç‰‡å†…æ‰€æœ‰æ–‡å­—çš„ç‰¹æ•ˆå’Œé¢œè‰² */
        #chat-messages .transfer-card .transfer-title,
        #chat-messages .transfer-card .transfer-amount,
        #chat-messages .transfer-card .transfer-note {
            text-shadow: none !important; /* å¼ºåˆ¶ç§»é™¤ä»»ä½•å‘å…‰æˆ–é˜´å½±æ•ˆæœ */
            color: white !important;      /* å¼ºåˆ¶é”å®šæ–‡å­—é¢œè‰²ä¸ºç™½è‰² */
        }
        
        /* åˆ†åˆ«é”å®šå„è‡ªçš„å­—ä½“å¤§å°å’Œå­—é‡ï¼Œé˜²æ­¢è¢«ç¯¡æ”¹ */
        #chat-messages .transfer-card .transfer-title {
            font-size: 16px !important;
            font-weight: 600 !important;
        }
        
        #chat-messages .transfer-card .transfer-amount {
            font-size: 28px !important;
            font-weight: bold !important;
        }
        
        #chat-messages .transfer-card .transfer-note {
            font-size: 13px !important;
            opacity: 0.9 !important;
        }
        
        /* â–¼â–¼â–¼ è¿™æ˜¯æ–°å¢çš„æ ·å¼ï¼Œç”¨äºä¿®æ­£æ‰€æœ‰å¤´éƒ¨æ ‡é¢˜çš„å±…ä¸­é—®é¢˜ â–¼â–¼â–¼ */
        .header > span:nth-child(2),
        #chat-header-title {
            position: absolute;
            left: 50%;
            transform: translateX(calc(-50% - 2px)); /* åœ¨-50%çš„åŸºç¡€ä¸Šï¼Œå†å‘å·¦æ¨2åƒç´  */
            
            /* (å¯é€‰ä½†æ¨è) é˜²æ­¢é•¿æ ‡é¢˜ä¸ä¸¤è¾¹æŒ‰é’®é‡å  */
            max-width: 60%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯è§†åŒ–æ¶ˆæ¯ç¼–è¾‘å™¨æ ·å¼ â–¼â–¼â–¼ */
        #message-editor-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message-editor-block {
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }
        
        .message-editor-block textarea {
            width: 100%;
            min-height: 60px;
            resize: vertical;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .message-editor-block .format-helpers {
            margin-top: 8px;
            margin-bottom: 0; /* è¦†ç›–é»˜è®¤çš„ margin-bottom */
        }
        
        .message-editor-block .delete-block-btn {
            float: right;
            margin-top: -5px;
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è”ç³»äººé€‰æ‹©å™¨æ ·å¼ â–¼â–¼â–¼ */
        .contact-picker-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .contact-picker-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 15px;
            transition: all 0.2s ease;
        }
        .contact-picker-item.selected .checkbox {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            content: 'âœ”';
            color: white;
            font-size: 14px;
            text-align: center;
            line-height: 20px;
        }
        .contact-picker-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        .contact-picker-item .name {
            font-weight: 500;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
        #member-management-list {
            padding: 0; /* ç§»é™¤é»˜è®¤paddingï¼Œè®©åˆ—è¡¨é¡¹æ’‘æ»¡ */
        }
        
        .member-management-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .member-management-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .member-management-item .name {
            flex-grow: 1;
            font-weight: 500;
        }
        
        .member-management-item .remove-member-btn {
            background-color: #ff3b30;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 20px;
            line-height: 28px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        #member-management-actions {
            flex-shrink: 0;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: #f7f7f7;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        #member-management-actions button {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        #member-management-actions #create-new-member-btn {
            background-color: #4cd964; /* æ–°å»ºç”¨ç»¿è‰²ï¼Œä»¥ç¤ºåŒºåˆ† */
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–ä»£ä»˜å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */
        
        
        .waimai-card {
            width: 240px;
            border-radius: 12px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .waimai-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .waimai-header .icon {
            width: 20px;
            height: 20px;
        }
        
        .waimai-header .title-group {
            display: flex;
            align-items: baseline;
            font-size: 14px;
            color: #8a8a8a;
        }
        .waimai-header .title-group .brand {
            font-weight: 600;
            color: #555;
            margin-right: 5px;
        }
        .waimai-header .title-group .separator {
            margin: 0 5px;
        }
        
        .waimai-catchphrase {
            font-size: 13px;
            color: #1f1f1f;
            padding: 12px;
        }
        
        .waimai-main {
            background-color: #FFD66B; /* æ©™é»„è‰²èƒŒæ™¯ */
            padding: 12px;
            text-align: center;
        }
        
        .waimai-main .request-title {
            font-size: 12px;
            color: #856404;
            margin-bottom: 8px;
        }
        
        .waimai-main .payment-box {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px 10px;
        }
        
        .waimai-main .payment-label {
            font-size: 13px;
            color: #8a8a8a;
        }
        
        .waimai-main .amount {
            font-size: 32px;
            font-weight: 700;
            color: #1f1f1f;
            margin: 4px 0 12px 0;
        }
        
        .waimai-main .countdown-label {
            font-size: 13px;
            color: #8a8a8a;
        }
        .waimai-main .countdown-timer {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin-left: 5px;
        }
        .waimai-main .countdown-timer span {
            background-color: #333;
            color: white;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .waimai-details-btn {
            width: 100%;
            padding: 10px 0;
            margin-top: 15px;
            border: none;
            border-radius: 6px;
            background-color: #FFC33A;
            color: #49380a;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–å“åº”çŠ¶æ€æ ·å¼ â–¼â–¼â–¼ */
        
        /* === åŒæ„æ”¯ä»˜åçš„æ ·å¼ === */
        .message-bubble.status-paid .waimai-card {
            border: 2px solid #28a745; /* ç»¿è‰²è¾¹æ¡† */
        }
        .message-bubble.status-paid .waimai-main .request-title::before {
            content: 'âœ…  ';
        }
        .message-bubble.status-paid .waimai-main .request-title {
            color: #155724;
            font-weight: 600;
            /* é‡å†™ request-title çš„å†…å®¹ */
            content: "æˆ‘å·²ä¸ºæ‚¨ä¹°å•ï¼Œè¯·å°½æƒ…äº«ç”¨å§ï½" !important;
            display: block;
            margin-bottom: 15px;
        }
        
        .message-bubble.status-paid .payment-box {
            display: none; /* éšè—æ”¯ä»˜è¯¦æƒ… */
        }
        .message-bubble.status-paid .waimai-details-btn {
            background-color: #28a745;
            color: white;
        }
        
        /* === æ‹’ç»æ”¯ä»˜åçš„æ ·å¼ === */
        .message-bubble.status-rejected .waimai-card {
            border: 2px solid #dc3545; /* çº¢è‰²è¾¹æ¡† */
            opacity: 0.8;
        }
        .message-bubble.status-rejected .waimai-main {
            background-color: #e9ecef;
        }
        .message-bubble.status-rejected .waimai-main .request-title::before {
            content: 'âŒ ';
        }
        .message-bubble.status-rejected .waimai-main .request-title {
            color: #721c24;
            font-weight: 600;
            /* é‡å†™ request-title çš„å†…å®¹ */
            content: "æˆ‘æ‹’ç»äº†æ‚¨çš„ä»£ä»˜è¯·æ±‚" !important;
            display: block;
            margin-bottom: 15px;
        }
        .message-bubble.status-rejected .payment-box {
            display: none; /* éšè—æ”¯ä»˜è¯¦æƒ… */
        }
         .message-bubble.status-rejected .waimai-details-btn {
            background-color: #6c757d;
            color: white;
        }
        
        /* å¼ºåˆ¶é‡å†™ request-title å†…å®¹çš„æŠ€å·§ */
        .message-bubble[class*="status-"] .request-title {
            font-size: 0; /* éšè—åŸå§‹æ–‡æœ¬ */
        }
        .message-bubble[class*="status-"] .request-title::after {
            font-size: 14px; /* è®©ä¼ªå…ƒç´ æ˜¾ç¤ºæ–°æ–‡æœ¬ */
        }
        .message-bubble.status-paid .request-title::after {
            content: "æˆ‘å·²ä¸ºæ‚¨ä¹°å•ï¼Œè¯·å°½æƒ…äº«ç”¨å§ï½";
        }
        .message-bubble.status-rejected .request-title::after {
            content: "æˆ‘æ‹’ç»äº†æ‚¨çš„ä»£ä»˜è¯·æ±‚";
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚çš„ç”¨æˆ·æ“ä½œæŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */
        .waimai-user-actions {
            display: flex;
            gap: 10px;
            padding: 0 12px 12px 12px; /* åœ¨å¡ç‰‡åº•éƒ¨ç•™å‡ºç©ºé—´ */
            background-color: #fff;
        }
        
        .waimai-user-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1.5px solid;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .waimai-pay-btn {
            background-color: #28a745;
            border-color: #1f7a33;
            color: white;
        }
        .waimai-pay-btn:hover {
            background-color: #218838;
        }
        
        .waimai-decline-btn {
            background-color: #f8f9fa;
            border-color: #ced4da;
            color: #495057;
        }
        .waimai-decline-btn:hover {
            background-color: #e2e6ea;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* === ã€æ–°å¢ã€‘ç»Ÿä¸€è®¾ç½®é¡µé¢çš„èƒŒæ™¯è‰² (å·²ä¿®æ­£) === */
        #api-settings-screen,
        #font-settings-screen,
        #wallpaper-screen,
        #memories-view,
        #contact-picker-screen,
        #member-management-screen,
        #world-book-editor-screen {  
            background-color: var(--secondary-bg);
        }
        
        /* ç¡®ä¿è¿™äº›é¡µé¢çš„å†…å®¹åŒºèƒ½æ­£ç¡®æ»šåŠ¨ */
        #api-settings-screen .form-container,
        #font-settings-screen .form-container,
        #wallpaper-screen .form-container {
            padding-top: 100px;
            margin-top: -80px;
            background-color: var(--secondary-bg);
        }
        
        /* å£çº¸è®¾ç½®é¡µé¢çš„é¢„è§ˆåŒºæ¯”è¾ƒç‰¹æ®Šï¼Œéœ€è¦é¢å¤–è°ƒæ•´ */
        #wallpaper-screen .form-container {
            align-items: center; /* ä¿æŒå†…å®¹å±…ä¸­ */
        }
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¥ç”µè¯·æ±‚ä¸è§†é¢‘é€šè¯ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
        
        /* --- æ¥ç”µè¯·æ±‚æ¨¡æ€æ¡† --- */
        #incoming-call-modal .incoming-call-content {
            background-color: rgba(40, 40, 40, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 280px;
            padding: 30px 20px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .caller-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 3px solid rgba(255,255,255,0.5);
        }
        
        .caller-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .caller-text {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 30px;
        }
        
        .incoming-call-actions {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .action-button-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #e0e0e0;
        }
        
        .call-action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background-size: 50%;
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .call-action-btn:active {
            transform: scale(0.9);
        }
        
        .call-action-btn.decline {
            background-color: #ff3b30;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
        }
        
        .call-action-btn.accept {
            background-color: #4cd964;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
        }
        
        /* --- è§†é¢‘é€šè¯ç•Œé¢ --- */
        /* â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸€æ•´å—ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ‰€æœ‰æ—§çš„ video-call ç›¸å…³CSS â–¼â–¼â–¼ */
        
        /* 1. é€šè¯å±å¹•æ€»å®¹å™¨ (ä¿æŒä¸å˜) */
        #video-call-screen {
            background-color: #1c1c1e;
            color: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* 2. é¡¶éƒ¨æ å’Œåº•éƒ¨æ§åˆ¶æ  (ä¿æŒä¸å˜) */
        .video-call-top-bar {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 15px 20px;
            padding-top: 50px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
            z-index: 10;
            text-align: center;
            box-sizing: border-box;
            pointer-events: none;
        }
        #call-timer {
            font-size: 16px;
            font-weight: 500;
            letter-spacing: 1px;
        }
        .video-call-controls {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 20px;
            padding-bottom: 40px;
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
            z-index: 10;
            box-sizing: border-box;
        }
        
        /* 3. å‚ä¸è€…å¤´åƒæ˜¾ç¤ºåŒº (ä¿æŒä¸å˜) */
        .video-call-avatar-area {
            flex-grow: 1; 
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            padding-top: 80px; /* ç¡®ä¿é¡¶éƒ¨æœ‰è¶³å¤Ÿç©ºé—´ */
            box-sizing: border-box;
            overflow-y: auto; /* â˜… æ–°å¢ï¼šå¦‚æœå¤´åƒå¤ªå¤šï¼Œå…è®¸æ­¤åŒºåŸŸæ»šåŠ¨ */
        }
        
        /* 4. å¤´åƒç½‘æ ¼å®¹å™¨ (ä¿æŒä¸å˜) */
        #participant-avatars-grid {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            align-items: center;
            gap: 15px; /* â˜… ç¨å¾®å‡å°å¤´åƒé—´è· */
            max-width: 100%;
        }
        
        /* 5. å•ä¸ªå‚ä¸è€…çš„å¤´åƒå®¹å™¨ (å¤´åƒç¼©å°) */
        .participant-avatar-wrapper {
            position: relative;
            text-align: center;
            flex-shrink: 0;
        }
        .participant-avatar {
            width: 70px;   /* â˜… ä» 80px ç¼©å°åˆ° 70px */
            height: 70px;  /* â˜… ä» 80px ç¼©å°åˆ° 70px */
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .participant-name {
            margin-top: 8px;
            font-size: 12px;
            color: #ccc;
        }
        
        /* 6. å‘è¨€è€…å¤´åƒé«˜äº®æ•ˆæœ (ä¿æŒä¸å˜) */
        .participant-avatar.speaking {
            border-color: #4cd964;
            box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
            transform: scale(1.05);
        }
        
        /* 7. ã€æœ€ç»ˆç‰ˆã€‘å¯¹è¯æ¡†åŒºåŸŸ */
        #video-call-main {
            flex-shrink: 0; 
            height: 30%;   /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šé«˜åº¦ä»35%å‡å°åˆ°30% */
            margin: 15px 15px 130px 15px; /* â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåº•éƒ¨è¾¹è·ä»120pxå¢åŠ åˆ°130pxï¼Œåˆ›é€ æ˜æ˜¾ç©ºéš™ */
            overflow-y: auto;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-sizing: border-box;
        }
        
        /* 8. æ§åˆ¶æŒ‰é’®æ ·å¼ (ä¿æŒä¸å˜) */
        .control-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.2s, background-color 0.2s;
        }
        .control-btn:active {
            transform: scale(0.9);
        }
        .control-btn.speak-btn {
            background-color: rgba(255,255,255,0.2);
            background-size: 55%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>');
        }
        .control-btn.hangup-btn {
            background-color: #ff3b30;
            background-size: 50%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
        }
        .control-btn.join-btn {
            background-color: #007bff;
            background-size: 50%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>');
        }
        
        /* â–²â–²â–² æ–°CSSæ›¿æ¢ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯å¯¹è¯æ°”æ³¡æ ·å¼ â–¼â–¼â–¼ */
        .call-message-bubble {
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.6;
            word-break: break-word;
            white-space: pre-wrap;
        }
        
        .call-message-bubble.ai-speech {
            background-color: rgba(255, 255, 255, 0.15);
            align-self: flex-start; /* AIå‘è¨€é å·¦ */
        }
        
        .call-message-bubble.user-speech {
            background-color: #4cd964; /* ç”¨æˆ·å‘è¨€ç”¨ç»¿è‰²ï¼Œç±»ä¼¼å¾®ä¿¡ */
            align-self: flex-end;   /* ç”¨æˆ·å‘è¨€é å³ */
            text-align: left; /* ç¡®ä¿ç”¨æˆ·æ°”æ³¡å†…çš„æ–‡å­—æ˜¯å·¦å¯¹é½çš„ */
        }
        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘æ­£åœ¨å‘¼å«ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
        #outgoing-call-screen {
            background-color: #1c1c1e;
            color: white;
            justify-content: center; /* å‚ç›´å±…ä¸­ */
            align-items: center;   /* æ°´å¹³å±…ä¸­ */
        }
        
        .outgoing-call-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .outgoing-call-actions {
            margin-top: 50px; /* å’Œä¸Šæ–¹æ–‡å­—æ‹‰å¼€è·ç¦» */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #e0e0e0;
        }
        /* â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² */
        
        /* 1. åŠ¨æ€å¸–å­çš„å¤–å±‚å®¹å™¨ï¼Œæˆ‘ä»¬éœ€è¦å®ƒæ¥å®šä½å’Œè£å‰ª */
        .qzone-post-container {
            position: relative; /* è®©å†…éƒ¨çš„åˆ é™¤æŒ‰é’®å¯ä»¥ç›¸å¯¹äºå®ƒå®šä½ */
            overflow: hidden;   /* éšè—æ‰è¶…å‡ºéƒ¨åˆ†çš„åˆ é™¤æŒ‰é’® */
            border-radius: 12px;/* å’Œå†…éƒ¨å¡ç‰‡ä¿æŒä¸€è‡´çš„åœ†è§’ */
        }
        
        /* 2. å¯æ»‘åŠ¨çš„å†…å®¹å¡ç‰‡ï¼Œå¢åŠ ä¸€ä¸ªå¹³æ»‘çš„è¿‡æ¸¡æ•ˆæœ */
        .qzone-post-item {
            transition: transform 0.3s ease;
            background-color: var(--secondary-bg); /* ç¡®ä¿å®ƒæœ‰èƒŒæ™¯è‰²ï¼Œèƒ½ç›–ä½ä¸‹é¢çš„åˆ é™¤æŒ‰é’® */
            position: relative; /* ç¡®ä¿å®ƒåœ¨æœ€ä¸Šå±‚ */
            z-index: 2;
        }
        
        /* 3. ã€æ ¸å¿ƒã€‘è¿™å°±æ˜¯é‚£ä¸ªâ€œåˆ é™¤â€æŒ‰é’®çš„æ ·å¼ï¼*/
        .qzone-post-delete-action {
            position: absolute; /* ç»å¯¹å®šä½ï¼Œè„±ç¦»æ–‡æ¡£æµ */
            top: 0;
            right: 0;
            bottom: 0;
            width: 90px; /* åˆ é™¤æŒ‰é’®çš„å®½åº¦ */
            background-color: #ff3b30; /* æ‚¨æƒ³è¦çš„çº¢è‰²èƒŒæ™¯ */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            cursor: pointer;
            z-index: 1; /* ç¡®ä¿å®ƒåœ¨å¡ç‰‡ä¸‹é¢ */
        }
        
        /* 4. å½“å¡ç‰‡å·¦æ»‘æ—¶ï¼ŒæŠŠå®ƒå‘å·¦ç§»åŠ¨ï¼Œéœ²å‡ºåˆ é™¤æŒ‰é’® */
        .qzone-post-item.swiped {
            transform: translateX(-90px); /* ç§»åŠ¨çš„è·ç¦»å’Œåˆ é™¤æŒ‰é’®çš„å®½åº¦ä¸€è‡´ */
        }
        
        /* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„â€œæ‹ä¸€æ‹â€æ ·å¼ï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* 1. â€œæ‹ä¸€æ‹â€çš„å±å¹•éœ‡åŠ¨åŠ¨ç”» */
        @keyframes pat-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }
        
        .pat-animation {
            animation: pat-shake 0.4s ease-in-out;
        }
        
        /* 2. â€œæ‹ä¸€æ‹â€ç³»ç»Ÿæç¤ºæ¶ˆæ¯çš„æ ·å¼ */
        .system-message {
            align-self: center; /* å±…ä¸­æ˜¾ç¤º */
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* è®©â€œæ‹ä¸€æ‹â€ç±»å‹çš„ wrapper å±…ä¸­ */
        .message-wrapper.system-pat {
            justify-content: center;
            align-self: center;
            margin: 5px 0;
            max-width: 80%;
        }
        /* â€œæ‹ä¸€-æ‹â€æ¶ˆæ¯æ°”æ³¡çš„æ ·å¼ */
        .message-bubble.system-bubble {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 10px;
        }
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ä¿®æ­£ï¼šè®©é¡¶éƒ¨æ“ä½œæ å¯ä»¥æ¨ªå‘æ»šåŠ¨ === */
        #chat-input-actions-top {
            display: flex;
            gap: 8px;
            padding: 0 5px;
        
            /* --- æ ¸å¿ƒä»£ç å¼€å§‹ --- */
            overflow-x: auto;      
            flex-wrap: nowrap;     
            -webkit-overflow-scrolling: touch; 
        
            scrollbar-width: none; 
            -ms-overflow-style: none;  
        }
        
        #chat-input-actions-top::-webkit-scrollbar {
            display: none; 
        }
        
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* === ã€å…¨æ–°ã€‘èŠå¤©ç•Œé¢å¤´éƒ¨çŠ¶æ€æ æ ·å¼ === */
        
        /* 1. æ ‡é¢˜å’ŒçŠ¶æ€çš„æ€»å®¹å™¨ï¼Œä½¿ç”¨flexå¸ƒå±€è®©å®ƒä»¬å‚ç›´æ’åˆ— */
        #chat-header-title-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center; /* æ°´å¹³å±…ä¸­ */
            gap: 2px; /* æ ‡é¢˜å’ŒçŠ¶æ€ä¹‹é—´çš„å¾®å°é—´è· */
            
            /* ä¸ºäº†è®©å®ƒèƒ½åœ¨flexå¸ƒå±€ä¸­æ­£ç¡®å±…ä¸­ */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            max-width: 60%;
        }
        
        /* 2. ä¸»æ ‡é¢˜çš„æ ·å¼å¾®è°ƒ */
        #chat-header-title {
            font-size: 16px; /* å¯ä»¥ç¨å¾®ç¼©å°ä¸€ç‚¹ï¼Œç»™çŠ¶æ€æ ç•™å‡ºç©ºé—´ */
            font-weight: 600;
            position: static; /* è¦†ç›–æ‰æ—§çš„absoluteå®šä½ */
            transform: none;  /* è¦†ç›–æ‰æ—§çš„transform */
            /* ä¿è¯é•¿æ ‡é¢˜ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤ºçœç•¥å· */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        /* 3. çŠ¶æ€æ å®¹å™¨ */
        #chat-header-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        
        /* 4. çŠ¶æ€å°åœ†ç‚¹ */
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background-color: #4cd964; /* é»˜è®¤ç»¿è‰²ï¼Œä»£è¡¨åœ¨çº¿ */
            transition: background-color 0.3s ease;
        }
        
        /* å½“AIçŠ¶æ€ä¸ºâ€œå¿™ç¢Œâ€æˆ–â€œç¦»å¼€â€æ—¶ï¼Œè®©åœ†ç‚¹å˜ç°è‰² */
        #chat-header-status.busy .status-dot {
            background-color: #cccccc;
        }
        
        /* 5. çŠ¶æ€æ–‡æœ¬ */
        .status-text {
            font-weight: 500;
        }
        
        /* === ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘å›å¿†å¡ç‰‡æ ·å¼ === */
        
        /* 1. å¡ç‰‡æ€»å®¹å™¨ï¼šè¿™é‡Œè´Ÿè´£å®šä¹‰æ•´ä½“çš„èƒŒæ™¯è‰²å’Œè¾¹æ¡† */
        .memory-card {
            background-color: #fffaf0; /* ç»Ÿä¸€çš„ã€æ¸©æš–çš„ç±³é»„è‰²èƒŒæ™¯ */
            border-radius: 12px;
            padding: 15px; /* åœ¨å¡ç‰‡å››å‘¨ç•™å‡ºå†…è¾¹è· */
            box-shadow: 0 2px 6px rgba(0,0,0,0.07);
            border-left: 5px solid #ffb74d; 
            display: flex; /* è®©å®ƒæˆä¸ºflexå®¹å™¨ï¼Œæ–¹ä¾¿å†…éƒ¨å…ƒç´ æ’åˆ— */
            flex-direction: column; /* è®©å¤´éƒ¨å’Œå†…å®¹å‚ç›´å †å  */
            gap: 8px; /* åœ¨å¤´éƒ¨å’Œå†…å®¹ä¹‹é—´åˆ›é€ ä¸€ä¸ªè‡ªç„¶çš„é—´è· */
        }
        
        /* 2. å¤´éƒ¨å®¹å™¨ï¼šç°åœ¨åªè´Ÿè´£å¸ƒå±€å’Œåˆ†å‰²çº¿ */
        .memory-card .header {
            border-bottom: 1px solid rgba(217, 129, 0, 0.15); /* åˆ†å‰²çº¿é¢œè‰²å¯ä»¥ç¨å¾®åŠ æ·±ä¸€ç‚¹ */
            padding-bottom: 8px; 
        }
        
        /* 3. æ—¥æœŸæ ·å¼ (ä¿æŒä¸å˜) */
        .memory-card .header .date {
            font-size: 11px;
            color: #a1887f;
            margin-bottom: 4px; 
        }
        
        /* 4. ä½œè€…æ ·å¼ (ä¿æŒä¸å˜) */
        .memory-card .header .author {
            font-weight: 600;
            color: #d98100;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 5. å†…å®¹åŒºæ ·å¼ (ä¿æŒä¸å˜) */
        .memory-card .content {
            font-size: 14px;
            line-height: 1.7;
            color: #5d4037;
            white-space: pre-wrap;
        }
        
        /* === ã€å…¨æ–°ã€‘çº¦å®š/å€’è®¡æ—¶å¡ç‰‡æ ·å¼ === */
        .countdown-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
            text-align: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        .countdown-card::before {
            content: 'âœ¨';
            position: absolute;
            top: -10px;
            left: -10px;
            font-size: 50px;
            opacity: 0.1;
            transform: rotate(-15deg);
        }
        .countdown-card .title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .countdown-card .timer {
            font-size: 28px;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }
        .countdown-card .target-date {
            font-size: 12px;
            opacity: 0.8;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 10px;
        }
        
        /* === ã€å…¨æ–°ã€‘èŠå¤©é”å®šé®ç½©å±‚æ ·å¼ === */
        #chat-lock-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 150; /* æ¯”è¾“å…¥æ¡†é«˜ï¼Œæ¯”è´´çº¸é¢æ¿ä½ */
            display: none; /* é»˜è®¤éšè— */
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        #chat-lock-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #chat-lock-content .lock-text {
            color: var(--text-secondary);
            font-size: 14px;
        }
        #chat-lock-content .lock-action-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--accent-color);
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
        }
        #chat-lock-content .lock-action-btn.secondary {
            background-color: transparent;
            color: var(--accent-color);
        }
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */
        
        
        .red-packet-card {
            width: 220px;
            border-radius: 8px;
            background: linear-gradient(160deg, #F96259, #E44D44);
            color: #ffd700; /* é‡‘è‰²æ–‡å­— */
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .red-packet-card.opened {
            background: linear-gradient(160deg, #d3c4a0, #c4b693);
            cursor: default;
        }
        
        .red-packet-card::before {
            content: 'ğŸ§§';
            position: absolute;
            top: -5px;
            left: -5px;
            font-size: 30px;
            opacity: 0.2;
            transform: rotate(-10deg);
        }
        
        .rp-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .rp-icon {
            width: 20px;
            height: 20px;
        }
        
        .rp-greeting {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .rp-type {
            font-size: 11px;
            color: white;
            opacity: 0.8;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .rp-claimed-info {
            font-size: 13px;
            color: white;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…è¯¦æƒ…åˆ—è¡¨æ ·å¼ â–¼â–¼â–¼ */
        .rp-details-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .rp-details-item:last-child {
            border-bottom: none;
        }
        .rp-details-item .name {
            flex-grow: 1;
            font-weight: 500;
            color: #333;
        }
        .rp-details-item .amount {
            font-weight: 500;
            color: #555;
        }
        .rp-details-item .lucky-king-tag {
            font-size: 10px;
            background-color: #ffd700;
            color: #a67c00;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: bold;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
        
        /* æŠ•ç¥¨å¡ç‰‡åœ¨æ¶ˆæ¯æ°”æ³¡ä¸­çš„æ ·å¼ */
        
        /* æŠ•ç¥¨å¡ç‰‡ä¸»ä½“ */
        .poll-card {
            width: 250px;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .poll-card.closed {
            background-color: #e9ecef; /* ç»“æŸåå˜ç° */
        }
        
        /* æŠ•ç¥¨é—®é¢˜ */
        .poll-question {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 12px;
            line-height: 1.4;
            word-break: break-word;
        }
        
        /* æŠ•ç¥¨é€‰é¡¹åˆ—è¡¨ */
        .poll-options-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* å•ä¸ªæŠ•ç¥¨é€‰é¡¹ */
        .poll-option-item {
            background-color: white;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: background-color 0.2s;
        }
        
        .poll-card:not(.closed) .poll-option-item:hover {
            background-color: #f0f8ff;
        }
        
        /* ç”¨æˆ·å·²æŠ•ç¥¨çš„é€‰é¡¹æ ·å¼ */
        .poll-option-item.voted {
            border-color: var(--accent-color);
            background-color: #e7f3ff;
            font-weight: 500;
        }
        
        /* æŠ•ç¥¨è¿›åº¦æ¡ */
        .poll-option-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: rgba(0, 123, 255, 0.1);
            z-index: 1;
            transition: width 0.3s ease-in-out;
        }
        
        /* é€‰é¡¹å†…å®¹ï¼ˆæ–‡å­—å’Œç¥¨æ•°ï¼‰ï¼Œç¡®ä¿åœ¨è¿›åº¦æ¡ä¹‹ä¸Š */
        .poll-option-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .poll-option-text {
            font-size: 14px;
        }
        
        .poll-option-votes {
            font-size: 13px;
            color: #8a8a8a;
            font-weight: 500;
        }
        
        /* æŠ•ç¥¨å¡ç‰‡åº•éƒ¨ */
        .poll-footer {
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #e9e9e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .poll-total-votes {
            font-weight: 500;
        }
        
        .poll-action-btn {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 4px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }
        .poll-card.closed .poll-action-btn {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
        }
        
        /* åˆ›å»ºæŠ•ç¥¨æ¨¡æ€æ¡†çš„é€‰é¡¹è¾“å…¥ */
        .poll-option-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .poll-option-input-wrapper input {
            flex-grow: 1;
        }
        .poll-option-input-wrapper .remove-option-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #ff3b30;
            border: none;
            cursor: pointer;
            font-size: 18px;
            line-height: 28px;
            text-align: center;
            flex-shrink: 0;
        }
        
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* === ã€å…¨æ–°ã€‘èŠå¤©å¤´éƒ¨â€œæ­£åœ¨è¾“å…¥â€çŠ¶æ€æ ·å¼ === */
        #chat-header-title.typing-status {
            color: var(--text-secondary);
            animation: typing-pulse 1.5s infinite;
            font-style: italic;
        }
        
        @keyframes typing-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        #chat-header-title {
            transition: opacity 0.2s ease-in-out;
        }
        
        @keyframes message-pop-in {
          from {
            opacity: 0;
            transform: translateY(15px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        .message-wrapper.animate-in {
          animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
          }
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Appå›¾æ ‡è®¾ç½®æ ·å¼ â–¼â–¼â–¼ */
#icon-settings-grid,
#cphone-icon-settings-grid { /* <--- æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œä¸ºä¸¤ä¸ªå®¹å™¨åŒæ—¶åº”ç”¨æ ·å¼ */
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 20px;
    width: 100%;
    padding: 0 10px;
    box-sizing: border-box;
}
        
        .icon-setting-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .icon-preview {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .change-icon-btn {
            padding: 4px 10px;
            font-size: 12px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è§‚è®¾ç½®é¡µé¢å¸ƒå±€ä¿®æ­£ â–¼â–¼â–¼ */
        
        /* 1. ä¿®æ­£æ»šåŠ¨é—®é¢˜ */
        #wallpaper-screen .form-container {
            /* æ ¸å¿ƒä¿®æ­£1: è§£å†³flexå¸ƒå±€ä¸‹çš„æ»šåŠ¨å†²çªï¼Œè®©æ»šåŠ¨æ¡èƒ½æ­£å¸¸å‡ºç° */
            min-height: 0; 
        }
        
        /* 2. ä¿®æ­£å£çº¸é¢„è§ˆè¢«å‹æ‰çš„é—®é¢˜ */
        #wallpaper-preview {
            /* æ ¸å¿ƒä¿®æ­£2: é˜²æ­¢é¢„è§ˆæ¡†è¢«è¿‡å¤šçš„å†…å®¹æŒ¤å‹å˜å½¢ï¼Œè®©å®ƒä¿æŒè‡ªå·±çš„é«˜åº¦ */
            flex-shrink: 0; 
        }
        /* â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«é“¾æ¥åŠŸèƒ½æ ·å¼ (æ— å›¾ç‰ˆ) â–¼â–¼â–¼ */
        
        /* 1. æµè§ˆå™¨ç•Œé¢èƒŒæ™¯è‰²å’Œå†…å®¹åŒºæ ·å¼ (ä¿æŒä¸å˜) */
        #browser-screen {
            background-color: #f8f9fa;
        }
        #browser-content {
            padding: 20px;
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        #browser-content .article-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        #browser-content .article-meta {
            font-size: 13px;
            color: #8a8a8a;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        #browser-content .article-body {
            white-space: pre-wrap;
            word-break: break-word;
        }
        #browser-content .article-body p {
            margin-bottom: 1em;
        }
        
        /* 2. èŠå¤©æ°”æ³¡ä¸­çš„é“¾æ¥å¡ç‰‡æ ·å¼ (æ— å›¾ç‰ˆ) */
        
        
        .link-share-card {
            width: 210px; 
            background-color: #fff;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .link-share-card:hover {
            background-color: #f9f9f9;
        }
        
        .link-share-card .title {
            font-weight: 600;
            font-size: 15px;
            line-height: 1.4;
            color: #1f1f1f;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .link-share-card .description {
            font-size: 13px;
            color: #8a8a8a;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .link-share-card .footer {
            display: flex; /* è®©å›¾æ ‡å’Œæ–‡å­—æ°´å¹³å¯¹é½ */
            align-items: center;
            gap: 6px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px; /* å’Œä¸Šé¢çš„æè¿°æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
        }
        .link-share-card .footer-icon{
            width: 14px;
            height: 14px;
            flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
        }
        
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* å•æ¡è¯„è®ºçš„å®¹å™¨ï¼Œç°åœ¨éœ€è¦ç›¸å¯¹å®šä½ */
        .comment-item {
            position: relative;
            padding-right: 25px; /* åœ¨å³ä¾§ç•™å‡ºåˆ é™¤æŒ‰é’®çš„ç©ºé—´ */
        }
        
        /* è¯„è®ºåˆ é™¤æŒ‰é’®çš„æ ·å¼ */
        .comment-delete-btn {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            line-height: 22px;
            text-align: center;
            border-radius: 50%;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0; /* é»˜è®¤éšè— */
        }
        
        /* é¼ æ ‡æ‚¬åœåœ¨è¯„è®ºä¸Šæ—¶ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
        .comment-item:hover .comment-delete-btn {
            opacity: 1;
        }
        
        .comment-delete-btn:hover {
            background-color: #f0f0f0;
            color: #ff3b30;
        }
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ã€å…¨æ–°ã€‘å¤œé—´æ¨¡å¼æ ·å¼ === */
        
        /* æ ¸å¿ƒï¼šå½“ #phone-screen æ‹¥æœ‰ .dark-mode ç±»æ—¶ï¼Œæ¿€æ´»ä»¥ä¸‹æ‰€æœ‰æ ·å¼ */
        
        /* 1. å…¨å±€èƒŒæ™¯å’Œæ–‡æœ¬é¢œè‰² */
        #phone-screen.dark-mode {
            --secondary-bg: #1c1c1e; /* ä¸»è¦å¡ç‰‡èƒŒæ™¯è‰² */
            --border-color: #38383a;  /* è¾¹æ¡†é¢œè‰² */
            --text-primary: #ffffff;   /* ä¸»è¦æ–‡å­—é¢œè‰² */
            --text-secondary: #8d8d92; /* æ¬¡è¦æ–‡å­—/å›¾æ ‡é¢œè‰² */
        }
        
        /* 2. å„ä¸ªé¡µé¢çš„ä¸»èƒŒæ™¯è‰² */
        #phone-screen.dark-mode #chat-list-screen,
        #phone-screen.dark-mode #qzone-screen .qzone-content,
        #phone-screen.dark-mode #memories-view {
            background-color: #000000;
        }
        
        /* 3. èŠå¤©åˆ—è¡¨ */
        #phone-screen.dark-mode #chat-list {
            background-color: #000000;
        }
        #phone-screen.dark-mode .chat-list-item {
            border-bottom-color: rgba(255, 255, 255, 0.15);
        }
        #phone-screen.dark-mode .chat-group-header {
            background-color: #1c1c1e; /* ä»ç™½è‰²æ”¹ä¸ºæ·±ç°è‰² */
            border-bottom: 1px solid #38383a; /* ç»™å®ƒä¸€ä¸ªç»†å¾®çš„ä¸‹è¾¹æ¡† */
        }
        #phone-screen.dark-mode .chat-list-item .name,
        #phone-screen.dark-mode .chat-group-header .group-name {
            color: #ffffff;
        }
        #phone-screen.dark-mode .chat-list-item:hover {
            background-color: #1c1c1e;
        }
        
        /* 4. é¡¶éƒ¨/åº•éƒ¨å¯¼èˆªæ  */
        #phone-screen.dark-mode .header,
        #phone-screen.dark-mode .qzone-header {
            background-color: rgba(25, 25, 25, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom-color: rgba(255, 255, 255, 0.15);
            color: #ffffff;
        }
        #phone-screen.dark-mode .header .back-btn,
        #phone-screen.dark-mode .header .action-btn,
        #phone-screen.dark-mode .header .save-btn {
            color: #ffffff;
        }
        #phone-screen.dark-mode #chat-list-bottom-nav {
            background-color: rgba(25, 25, 25, 0.9);
            border-top-color: rgba(255, 255, 255, 0.15);
        }
        #phone-screen.dark-mode .nav-item.active {
            color: #ffffff;
        }
        
        /* 5. èŠå¤©ç•Œé¢ */
        #phone-screen.dark-mode #chat-input-area {
            background-color: rgba(5, 5, 5, 0.8);
            border-top: none;
        }
        #phone-screen.dark-mode #chat-input {
            background-color: #3e3e42;
            color: #ffffff;
        }
        #phone-screen.dark-mode #chat-input::placeholder {
            color: #8d8d92;
        }
        #phone-screen.dark-mode .chat-action-icon-btn {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
        }
        #phone-screen.dark-mode #send-btn {
            background-color: var(--accent-color);
        }
        
        /* 6. åŠ¨æ€ (QZone) ç•Œé¢ */
        #phone-screen.dark-mode .qzone-actions-bar,
        #phone-screen.dark-mode .qzone-post-item {
            background-color: #1c1c1e;
            border: 1px solid #333;
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
        }
        #phone-screen.dark-mode .action-item:not(:last-child)::after {
            background-color: #333;
        }
        #phone-screen.dark-mode .post-footer,
        #phone-screen.dark-mode .post-likes-section {
            border-top-color: #333;
        }
        #phone-screen.dark-mode .post-likes-section {
            background-color: rgba(0, 123, 255, 0.1);
        }
        #phone-screen.dark-mode .comment-input {
            background-color: #333;
            color: #ffffff;
        }
        #phone-screen.dark-mode .comment-input::placeholder {
            color: #8d8d92;
        }
        #phone-screen.dark-mode .post-actions-btn:hover {
            background-color: #333;
        }
        #phone-screen.dark-mode .at-mention-popup {
            background-color: #1c1c1e;
            border-color: #333;
        }
        #phone-screen.dark-mode .at-mention-item {
            border-bottom-color: #333;
        }
        #phone-screen.dark-mode .at-mention-item:hover {
            background-color: #333;
        }
        
        /* 7. å›å¿†å½•ç•Œé¢ */
        #phone-screen.dark-mode .memory-card {
            background-color: #1c1c1e;
            border-left-color: #e6a753;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.08);
        }
        #phone-screen.dark-mode .memory-card .header {
            background-color: #2c2c2e;
            border-bottom-color: #38383a;
            margin: -15px -15px 8px -15px;
            padding: 12px 15px;
            border-radius: 12px 12px 0 0;
        }
        #phone-screen.dark-mode .memory-card .header .date,
        #phone-screen.dark-mode .memory-card .header .author,
        #phone-screen.dark-mode .memory-card .content {
            color: #e0e0e0;
        }
        
        /* 8. å…¶ä»–è®¾ç½®å’Œåˆ—è¡¨é¡µ */
        #phone-screen.dark-mode #api-settings-screen,
        #phone-screen.dark-mode #font-settings-screen,
        #phone-screen.dark-mode #wallpaper-screen,
        #phone-screen.dark-mode #contact-picker-screen,
        #phone-screen.dark-mode #member-management-screen,
        #phone-screen.dark-mode #world-book-editor-screen,
        #phone-screen.dark-mode #world-book-list,
        #phone-screen.dark-mode .list-item:hover,
        #phone-screen.dark-mode .list-container,
        #phone-screen.dark-mode .form-container {
            background-color: #000000;
        }
        #phone-screen.dark-mode .form-group input, 
        #phone-screen.dark-mode .form-group select, 
        #phone-screen.dark-mode .form-group textarea {
            background-color: #1c1c1e;
            color: #ffffff;
            border-color: #38383a;
        }
        #phone-screen.dark-mode .form-button-secondary {
            background-color: #333;
            border-color: #555;
            color: #fff;
        }
        #phone-screen.dark-mode #font-preview {
            background-color: #1c1c1e;
            border-color: #38383a;
        }
        #phone-screen.dark-mode #font-preview p {
            color: #ffffff;
        }
        
        /* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—ã€å…¨æ–°çš„ä¿®æ­£CSSã€‘ï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ã€å…¨æ–°ã€‘å¤œé—´æ¨¡å¼è§†è§‰ä¿®æ­£ === */
        
        /* 1. ä¿®æ­£åŠ¨æ€å¡ç‰‡å†…çš„æ–‡å­—é¢œè‰² */
        #phone-screen.dark-mode .qzone-post-item .post-nickname,
        #phone-screen.dark-mode .qzone-post-item .post-content {
            color: #f0f0f0; /* ä»æ·±ç°è‰²æ”¹ä¸ºæ˜äº®çš„æµ…ç°è‰² */
        }
        
        /* 2. ä¿®æ­£æ”¶è—å¡ç‰‡å†…çš„æ–‡å­—é¢œè‰² */
        #phone-screen.dark-mode .favorite-item-card .fav-card-header .name,
        #phone-screen.dark-mode .favorite-item-card .fav-card-content {
            color: #f0f0f0; /* åŒæ ·æ”¹ä¸ºæµ…ç°è‰² */
        }
        #phone-screen.dark-mode .favorite-item-card .fav-card-header .source {
            color: #8d8d92; /* æ¥æºæ–‡å­—ç”¨æ¬¡è¦ç°è‰² */
        }
        
        /* 3. ä¿®æ­£æ”¶è—é¡µçš„æœç´¢æ èƒŒæ™¯å’Œè¾“å…¥æ¡†æ ·å¼ */
        #phone-screen.dark-mode .search-bar-container {
            background-color: #000000; /* å®¹å™¨èƒŒæ™¯å˜ä¸ºçº¯é»‘ */
        }
        #phone-screen.dark-mode #favorites-search-input {
            background-color: #1c1c1e; /* è¾“å…¥æ¡†èƒŒæ™¯å˜ä¸ºæ·±ç° */
            border-color: #38383a;     /* è¾¹æ¡†é¢œè‰²å˜æš— */
            color: #ffffff;            /* è¾“å…¥æ–‡å­—å˜ä¸ºç™½è‰² */
        }
        #phone-screen.dark-mode #favorites-search-input::placeholder {
            color: #8d8d92; /* å ä½ç¬¦æ–‡å­—é¢œè‰²å˜æš— */
        }
        
        /* â–²â–²â–² ä¿®æ­£CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === ã€å…¨æ–°ã€‘iOSé£æ ¼çš„Toggle Switchå¼€å…³æ ·å¼ === */
        
        /* 1. å¼€å…³çš„å®¹å™¨ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }
        
        /* 2. éšè—æ‰åŸå§‹çš„ checkbox è¾“å…¥æ¡† */
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        /* 3. å¼€å…³çš„èƒŒæ™¯ï¼ˆé‚£ä¸ªæ¤­åœ†ï¼‰ */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e9e9eb; /* å…³é—­æ—¶çš„èƒŒæ™¯è‰² */
            transition: .4s;
            border-radius: 34px;
        }
        
        /* 4. å¼€å…³ä¸Šçš„åœ†ç‚¹ */
        .slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* 5. ã€æ ¸å¿ƒã€‘å½“ checkbox è¢«é€‰ä¸­æ—¶ï¼ˆå³å¼€å¯çŠ¶æ€ï¼‰ */
        input:checked + .slider {
            background-color: #34c759; /* å¼€å¯æ—¶çš„èƒŒæ™¯è‰²ï¼ˆiOSç»¿è‰²ï¼‰*/
        }
        
        input:checked + .slider:before {
            transform: translateX(20px); /* è®©åœ†ç‚¹æ»‘åŠ¨åˆ°å³è¾¹ */
        }
        
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨å›å¤åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨å›å¤åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
        
        /* 1. è¾“å…¥æ¡†ä¸Šæ–¹çš„â€œå›å¤é¢„è§ˆæ â€ */
        #reply-preview-bar {
            display: none; /* é»˜è®¤éšè— */
            padding: 8px 12px;
            margin: 0 8px 8px 8px; /* å’Œè¾“å…¥æ¡†å‘¨å›´çš„è¾¹è·ä¿æŒä¸€è‡´ */
            background-color: rgba(0, 0, 0, 0.05);
            border-left: 3px solid var(--accent-color);
            border-radius: 6px;
            position: relative;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        #phone-screen.dark-mode #reply-preview-bar {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .reply-preview-content .sender {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .reply-preview-content .text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block; /* ç¡®ä¿çœç•¥å·ç”Ÿæ•ˆ */
            max-width: 95%;
        }
        
        #cancel-reply-btn {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 14px;
        }
        
        /* 2. æ¶ˆæ¯æ°”æ³¡å†…éƒ¨çš„â€œå¼•ç”¨æ¶ˆæ¯å—â€ */
        .quoted-message {
            padding: 6px 10px;
            margin-bottom: 6px;
            background-color: rgba(0, 0, 0, 0.04);
            border-left: 2px solid var(--accent-color);
            border-radius: 4px;
            font-size: 0.9em; /* å­—ä½“æ¯”æ­£æ–‡å°ä¸€ç‚¹ */
            opacity: 0.8;
        }
        
        #phone-screen.dark-mode .quoted-message {
            background-color: rgba(255, 255, 255, 0.08);
            border-left-color: #a0cff1;
        }
        
        .quoted-message .quoted-sender {
            font-weight: 600;
            color: var(--accent-color);
        }
        #phone-screen.dark-mode .quoted-message .quoted-sender {
            color: #a0cff1;
        }
        
        .quoted-message .quoted-content {
            color: var(--text-secondary);
            white-space: normal;     /* æ ¸å¿ƒä¿®æ­£1: å…è®¸æ–‡æœ¬æ­£å¸¸æ¢è¡Œ */
            word-break: break-word;  /* æ ¸å¿ƒä¿®æ­£2: å¼ºåˆ¶é•¿å•è¯æˆ–è¿ç»­å­—ç¬¦æ–­å¼€ï¼Œé˜²æ­¢æº¢å‡º */
            display: block;
        }
        
        /* === å­—ä½“é¢„è§ˆæ¡†æ ·å¼ (ä¿®æ­£å) === */
        
        /* é»˜è®¤ï¼ˆæ—¥é—´æ¨¡å¼ï¼‰çš„æ ·å¼ */
        #font-preview {
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f9f9f9; /* æ—¥é—´æ¨¡å¼çš„æµ…ç°è‰²èƒŒæ™¯ */
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        /* é¢„è§ˆæ¡†é‡Œçš„æ–‡å­—é¢œè‰²ï¼Œé»˜è®¤æ˜¯é»‘è‰² */
        #font-preview p {
            color: var(--text-primary);
        }
        
        /* å¤œé—´æ¨¡å¼ä¸‹çš„ä¿®æ­£æ ·å¼ */
        #phone-screen.dark-mode #font-preview {
            background-color: #1c1c1e; /* æ·±ç°è‰²èƒŒæ™¯ */
            border-color: #38383a;     /* æš—è‰²è¾¹æ¡† */
        }
        
        /* å¤œé—´æ¨¡å¼ä¸‹ï¼Œé¢„è§ˆæ¡†é‡Œçš„æ–‡å­—å˜ä¸ºç™½è‰² */
        #phone-screen.dark-mode #font-preview p {
            color: #ffffff;
        }
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²¾è‡´ç‰ˆè½¬è´¦æ“ä½œå¼¹çª—æ ·å¼ â–¼â–¼â–¼ */
        .transfer-actions-content {
            background-color: #fff0f5; /* ç²‰å«©çš„èƒŒæ™¯è‰² */
            border-radius: 20px;
            width: 290px;
            padding: 20px;
            box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); /* ç²‰è‰²é˜´å½± */
            text-align: center;
            position: relative;
            border: 1px solid #ffcce0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .transfer-actions-header {
            font-size: 20px;
            font-weight: bold;
            color: #a35c7b; /* æ·±ç²‰è‰²æ ‡é¢˜ */
            margin-bottom: 15px;
        }
        
        .transfer-actions-body p {
            font-size: 15px;
            color: #555;
            margin: 0 0 25px 0;
            line-height: 1.5;
        }
        
        .transfer-actions-footer {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        
        .transfer-actions-footer .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: white;
        }
        
        .transfer-actions-footer .action-btn:active {
            transform: scale(0.95);
        }
        
        .transfer-actions-footer .action-btn.accept {
            background: linear-gradient(135deg, #ff85b3, #ff69b4);
            box-shadow: 0 4px 10px rgba(255, 105, 180, 0.4);
        }
        
        .transfer-actions-footer .action-btn.decline {
            background: linear-gradient(135deg, #c2c2c2, #a0a0a0);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .transfer-actions-content .cancel-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background-color: rgba(0, 0, 0, 0.1);
            color: #a35c7b;
            font-size: 20px;
            line-height: 28px;
            cursor: pointer;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
        
        /* === æœªè¯»æ¶ˆæ¯çº¢ç‚¹æ ·å¼ === */
        .unread-count-wrapper {
            flex-shrink: 0;
            width: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px; /* è®©çº¢ç‚¹å’Œåå­—å·®ä¸å¤šé«˜ */
        }
        
        .unread-count {
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background-color: #ff3b30; /* iOS é£æ ¼çš„çº¢è‰² */
            color: white;
            font-size: 13px;
            font-weight: 500;
            line-height: 20px;
            text-align: center;
            border-radius: 10px; /* åœ†è§’çŸ©å½¢ */
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            display: none; /* é»˜è®¤éšè— */
            justify-content: center;
            align-items: center;
        }
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•é¡µé¢ä¸å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */
        
        /* ç¡®ä¿é¡µé¢èƒŒæ™¯è‰²ç»Ÿä¸€ */
        #call-history-screen {
            background-color: #f0f2f5;
        }
        
        /* é€šè¯è®°å½•å¡ç‰‡æ ·å¼ */
        .call-record-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 5px solid var(--accent-color);
        }
        .call-record-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        /* å¡ç‰‡å¤´éƒ¨ï¼šåŒ…å«æ—¥æœŸå’Œæ—¶é•¿ */
        .call-record-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .call-record-card .card-header .duration {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* å¡ç‰‡ä¸»ä½“ï¼šå‚ä¸è€…å¤´åƒ */
        .call-record-card .card-body {
            display: flex;
            align-items: center;
        }
        .call-record-card .participants-avatars {
            display: flex;
            align-items: center;
        }
        .call-record-card .participant-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        /* è®©å¤´åƒæœ‰ä¸€ä¸ªæ¼‚äº®çš„å †å æ•ˆæœ */
        .call-record-card .participant-avatar:not(:first-child) {
            margin-left: -12px;
        }
        .call-record-card .participants-names {
            margin-left: 12px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }
        
        /* --- é€šè¯è¯¦æƒ…å¼¹çª—æ ·å¼ --- */
        #transcript-modal-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 15px;
        }
        .transcript-entry {
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 85%;
            line-height: 1.5;
            word-break: break-word;
        }
        .transcript-entry.user {
            background-color: #dcf8c6; /* ç±»ä¼¼å¾®ä¿¡çš„ç»¿è‰² */
            align-self: flex-end;
        }
        .transcript-entry.assistant {
            background-color: #ffffff;
            align-self: flex-start;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        #chat-list-title {
            cursor: pointer;
        }
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•å¡ç‰‡ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */
        
        .call-record-card .card-body {
            /* å°† body æ”¹ä¸º flex å¸ƒå±€ï¼Œè®©æ ‡é¢˜å’Œå‚ä¸è€…ä¿¡æ¯å‚ç›´æ’åˆ— */
            display: flex;
            flex-direction: column;
            gap: 8px; /* æ ‡é¢˜å’Œå‚ä¸è€…ä¿¡æ¯ä¹‹é—´çš„é—´è· */
        }
        
        .call-record-card .custom-title {
            font-size: 16px;
            font-weight: 600; /* åŠ ç²—ï¼Œè®©å®ƒåƒä¸ªæ ‡é¢˜ */
            color: var(--text-primary);
            padding-bottom: 8px; /* æ ‡é¢˜ä¸‹çš„ç•™ç™½ */
            border-bottom: 1px solid var(--border-color); /* åœ¨æ ‡é¢˜ä¸‹åŠ ä¸€æ¡åˆ†å‰²çº¿ */
            margin-bottom: 4px; /* å’Œä¸‹é¢çš„å‚ä¸è€…ä¿¡æ¯æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
        }
        
        .call-record-card .participants-info {
            /* è¿™ä¸ªæ–°å®¹å™¨è®©å¤´åƒå’Œâ€œä¸xxâ€èƒ½æ°´å¹³å¯¹é½ */
            display: flex;
            align-items: center;
        }
        
        /* å‚ä¸è€…åå­—çš„æ ·å¼å¾®è°ƒï¼Œè®©å®ƒä¸é‚£ä¹ˆçªå‡º */
        .call-record-card .participants-names {
            margin-left: 12px;
            font-weight: 500; /* ä¸å†åŠ ç²— */
            font-size: 14px; /* ç¨å¾®å°ä¸€ç‚¹ */
            color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰² */
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯­éŸ³è½¬æ–‡å­—åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
        
        /* 1. è¯­éŸ³æ–‡å­—å†…å®¹çš„æ ·å¼ */
        .voice-transcript {
            font-size: 14px;         /* æ–‡å­—å¤§å° */
            line-height: 1.6;        /* è¡Œé«˜ï¼Œè®©å¤šè¡Œæ–‡æœ¬æ›´æ˜“è¯» */
            color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰²ï¼Œä¸è¯­éŸ³æ¡åŒºåˆ† */
            padding: 8px 12px;       /* å†…è¾¹è· */
            margin-top: 6px;         /* å’Œä¸Šæ–¹çš„è¯­éŸ³æ¡æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
            background-color: rgba(0, 0, 0, 0.04); /* ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯ï¼Œæ›´æœ‰å±‚æ¬¡æ„Ÿ */
            border-radius: 6px;      /* åœ†è§’ */
            word-break: break-word;  /* ç¡®ä¿é•¿æ–‡æœ¬èƒ½æ­£å¸¸æ¢è¡Œ */
            display: none;           /* é»˜è®¤éšè— */
        }
        
        #phone-screen.dark-mode .voice-transcript {
            background-color: rgba(255, 255, 255, 0.1); /* å¤œé—´æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
        }
        
        /* 2. æ—‹è½¬åŠ è½½åŠ¨ç”»çš„æ ·å¼ */
        .loading-spinner {
            display: none; /* é»˜è®¤éšè— */
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-top-color: var(--accent-color); /* æ—‹è½¬éƒ¨åˆ†çš„é¢œè‰² */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 8px; /* å’Œæ³¢å½¢å›¾ã€æ—¶é•¿ä¿æŒä¸€ç‚¹é—´è· */
        }
        
        /* 3. å®šä¹‰æ—‹è½¬åŠ¨ç”» */
        @keyframes spin {
            to {
        transform: rotate(360deg);
            }
        }
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«è®°å½•æŸ¥çœ‹å™¨æ ·å¼ä¿®æ­£ â–¼â–¼â–¼ */
        #shared-history-viewer-content {
            display: flex;
            flex-direction: column; /* è®©æ°”æ³¡å‚ç›´æ’åˆ— */
            gap: 20px; /* åœ¨æ¯ä¸ªæ°”æ³¡ä¹‹é—´å¢åŠ 20åƒç´ çš„é—´è· */
            padding: 15px; /* åœ¨å®¹å™¨å››å‘¨ä¹Ÿå¢åŠ ä¸€äº›å†…è¾¹è·ï¼Œé¿å…æ°”æ³¡è´´è¾¹ */
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’­æ”¾å™¨å’Œæ­Œè¯æ ·å¼ â–¼â–¼â–¼ */
        #music-player-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 60px;
            background-color: rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-50px);
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        #music-player-overlay.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .music-player-window { 
            width: 70%; 
            min-height: 420px;
            background-color: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border-radius: 25px; 
            box-shadow: 0 8px 32px 0 rgba(25, 25, 25, 0.37); 
            border: 1px solid rgba(255, 255, 255, 0.18); 
            padding: 25px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: #1f1f1f; 
            position: relative;
            justify-content: space-between;
            padding-bottom: 15px;
        }
        
        .music-player-top-actions {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            width: calc(100% - 30px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-left-cluster {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #music-return-btn, #music-exit-btn {
            background: none;
            border: none;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            color: #555;
            padding: 5px;
            line-height: 1;
        }
        #music-exit-btn {
            font-size: 24px;
            font-weight: 400;
        }
        
        .music-progress-bar-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        .time-display {
            font-size: 11px;
            color: #888;
            width: 35px;
            text-align: center;
            flex-shrink: 0;
            font-family: 'SF Mono', 'Menlo', monospace;
        }
        .progress-bar {
            flex-grow: 1;
            height: 5px;
            background-color: #e5e5e5;
            border-radius: 2.5px;
            cursor: pointer;
        }
        .progress-bar-fill {
            width: 0%;
            height: 100%;
            background-color: #333;
            border-radius: 2.5px;
        }
        
        #music-lyrics-container {
            width: 100%;
            height: 192px;
            overflow: hidden;
            position: relative;
            -webkit-mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
            mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
        }
        
        #music-lyrics-list {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .lyric-line {
            padding: 4px 0;
            font-size: 14px;
            color: #666;
            text-align: center;
            line-height: 1.5;
            transition: all 0.5s ease;
            opacity: 0.7;
            transform: scale(0.95);
        }
        
        .lyric-line.active {
            font-size: 16px;
            color: #000;
            opacity: 1;
            transform: scale(1);
        }
        
        .music-player-controls-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .music-controls {
            margin-top: 0;
        }
        
        #music-return-btn, #music-exit-btn, #music-playlist-btn {
            position: relative;
        }
        
        #music-return-btn { top: -2px; }
        #music-playlist-btn { top: -3px; }
        
        .playlist-item-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .playlist-action-btn {
            font-size: 18px;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
        }
        .playlist-action-btn:hover { color: #000; }
        .delete-track-btn { font-size: 24px; color: #ff3b30; }
        .delete-track-btn:hover { color: #c00; }
        .lyrics-btn { font-weight: 500; }
        
        /* --- ã€æ ¸å¿ƒä¿®æ­£ã€‘ç¡®ä¿å¤´åƒå°ºå¯¸ --- */
        .message-bubble .avatar {
            width: 34px;
            height: 34px;
            border-radius: 20%;
            object-fit: cover;
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
        }
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’¤å›æ¶ˆæ¯æ ·å¼ â–¼â–¼â–¼ */
        
        /* 1. æ’¤å›æ¶ˆæ¯çš„å ä½ç¬¦æ ·å¼ */
        .recalled-message-placeholder {
            align-self: center; /* å±…ä¸­æ˜¾ç¤º */
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            cursor: pointer; /* è®©å®ƒçœ‹èµ·æ¥å¯ä»¥ç‚¹å‡» */
        }
        
        /* 2. å¤œé—´æ¨¡å¼ä¸‹çš„é€‚é… */
        #phone-screen.dark-mode .recalled-message-placeholder {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        /* 3. AIæ’¤å›æ¶ˆæ¯æ—¶çš„åŠ¨ç”»æ•ˆæœ */
        @keyframes recall-animation {
          from {
            opacity: 1;
            transform: scale(1);
          }
          to {
            opacity: 0;
            transform: scale(0.8);
          }
        }
        
        .message-wrapper.recalled-animation {
          animation: recall-animation 0.3s ease-out forwards;
        }
        
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’¤å›æ¶ˆæ¯æ ·å¼ä¿®æ­£ â–¼â–¼â–¼ */
        
        /* å¼ºåˆ¶æ’¤å›æ¶ˆæ¯çš„å ä½ç¬¦ä¸æ¢è¡Œï¼Œå¹¶ä¿æŒå†…å®¹å±…ä¸­ */
        .recalled-message-placeholder {
            white-space: nowrap; /* æ ¸å¿ƒï¼šç¦æ­¢æ–‡æœ¬æ¢è¡Œ */
            display: inline-block; /* è®©èƒŒæ™¯æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */
            padding: 4px 12px;
        }
        
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦åˆ†ç±»åˆ—è¡¨æ ·å¼ â–¼â–¼â–¼ */
        .world-book-group-container {
            border-bottom: 1px solid var(--border-color);
        }
        .world-book-group-container:first-child {
            border-top: 1px solid var(--border-color);
        }
        .world-book-group-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            background-color: #f7f7f7;
        }
        .world-book-group-header .arrow {
            font-size: 14px;
            margin-right: 8px;
            transition: transform 0.2s ease;
        }
        .world-book-group-header.collapsed .arrow {
            transform: rotate(-90deg);
        }
        .world-book-group-header .group-name {
            font-weight: 600;
            font-size: 15px;
        }
        .world-book-group-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .world-book-group-content.collapsed {
            max-height: 0;
        }
        #phone-screen.dark-mode .world-book-group-header {
            background-color: #1c1c1e;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©ç½®é¡¶æ ·å¼ â–¼â–¼â–¼ */
        .chat-list-item.pinned {
            background-color: #f0f2f5; /* ç»™ä¸€ä¸ªæ·¡æ·¡çš„ã€ä¸åŒçš„èƒŒæ™¯è‰² */
        }
        
        #phone-screen.dark-mode .chat-list-item.pinned {
            background-color: #2c2c2e; /* å¤œé—´æ¨¡å¼ä¸‹çš„ç½®é¡¶èƒŒæ™¯è‰² */
        }
        /* â–¼â–¼â–¼ ä¿®å¤è¾“å…¥æ¡†é®æŒ¡æŒ‰é’®çš„å¸ƒå±€é—®é¢˜ â–¼â–¼â–¼ */
        #chat-input-area {
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* é˜²æ­¢æ•´ä¸ªè¾“å…¥åŒºè¢«æ„å¤–å‹ç¼© */
            background-color: var(--secondary-bg); /* ç¡®ä¿èƒŒæ™¯è‰²ç»Ÿä¸€ï¼Œé¿å…é€æ˜é‡å  */
        }
        
        #chat-input-actions-top {
            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¡Œè¢«å‹ç¼© */
            padding-bottom: 8px; /* å¢åŠ ä¸€ç‚¹å’Œè¾“å…¥æ¡†çš„é—´è·ï¼Œæ”¹å–„è§‚æ„Ÿ */
        }
        
        #chat-input-main-row {
            flex-shrink: 0; /* é˜²æ­¢è¾“å…¥æ¡†è¡Œè¢«å‹ç¼© */
        }
        /* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤èŠ@åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
        
        /* â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤ã€‘è¯·ç”¨è¿™æ®µä»£ç æ›¿æ¢æ‚¨ç°æœ‰çš„ #chat-input-area æ ·å¼ â–¼â–¼â–¼ */
        #chat-input-area {
            position: relative; /* ä¿æŒç›¸å¯¹å®šä½ï¼Œä½œä¸ºå¼¹çª—çš„â€œé”šç‚¹â€ */
            z-index: 20;      /* ã€å…³é”®ä¿®å¤ã€‘æå‡æ•´ä¸ªè¾“å…¥åŒºçš„å±‚çº§ */
            flex-shrink: 0;
            padding: 8px;
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        
        /* 2. å®šä¹‰èŠå¤©@å¼¹çª—çš„å…·ä½“ä½ç½®å’Œæ ·å¼ */
        #chat-at-mention-popup {
            bottom: 100%; /* æ˜¾ç¤ºåœ¨æ•´ä¸ªè¾“å…¥åŒºçš„ä¸Šæ–¹ */
            left: 8px;    /* ä¸è¾“å…¥åŒºå·¦è¾¹å†…è¾¹è·å¯¹é½ */
            right: 8px;   /* ä¸è¾“å…¥åŒºå³è¾¹å†…è¾¹è·å¯¹é½ */
            width: auto;  /* å®½åº¦è‡ªåŠ¨æ’‘æ»¡ */
            margin-bottom: 5px; /* å’Œè¾“å…¥åŒºæ‹‰å¼€ä¸€ç‚¹è·ç¦» */
            /* å…¶ä»–æ ·å¼å°†å¤ç”¨ .at-mention-popup çš„ç°æœ‰æ ·å¼ */
        }
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤å…¬å‘Šæ¿å¼¹çª—æ ·å¼ â–¼â–¼â–¼ */
        #announcement-board-modal .modal-content {
            height: 70%;
            background-color: #f0f2f5;
        }
        #announcement-board-content {
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px; /* å…¬å‘Šä¹‹é—´çš„é—´è· */
        }
        #announcement-board-content .message-wrapper {
            max-width: 100%; /* è®©å…¬å‘Šæ¶ˆæ¯å¯ä»¥æ’‘æ»¡å®½åº¦ */
            align-self: center;
        }
        #announcement-board-content .timestamp {
            display: none; /* å…¬å‘Šæ¿å†…ä¸æ˜¾ç¤ºæ—¶é—´æˆ³ */
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å…¬å‘Šæ¿å¡ç‰‡ç®¡ç†æ ·å¼ â–¼â–¼â–¼ */
        .announcement-item-wrapper {
            position: relative; /* ä¸ºäº†å®šä½æ“ä½œæŒ‰é’® */
            padding: 10px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .announcement-item-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            border-radius: 50%;
        }
        .announcement-item-actions:hover {
            background-color: #f0f0f0;
        }
        .pinned-indicator {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 28px;
            height: 28px;
            background-color: #ffc107;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è½¬å‘åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
        
        /* 1. è½¬å‘åçš„åŠ¨æ€ï¼Œå†…åµŒçš„åŸå§‹å†…å®¹å®¹å™¨ */
        .reposted-content-wrapper {
            background-color: #f7f7f8;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        
        /* åœ¨å¤œé—´æ¨¡å¼ä¸‹ï¼Œä¸ºå†…åµŒå®¹å™¨æä¾›ä¸€ä¸ªæ·±è‰²èƒŒæ™¯ */
        #phone-screen.dark-mode .reposted-content-wrapper {
            background-color: #2c2c2e;
            border-color: #38383a;
        }
        
        /* 2. ç§»é™¤å†…åµŒåŸå§‹å†…å®¹çš„åº•éƒ¨äº’åŠ¨åŒºï¼Œé¿å…æ··æ·† */
        .reposted-content-wrapper .post-footer,
        .reposted-content-wrapper .post-feedback-icons,
        .reposted-content-wrapper .post-likes-section {
            display: none;
        }
        
        /* 3. è®©å†…åµŒå†…å®¹çš„å¤´éƒ¨ä¿¡æ¯ç¨å¾®ç´§å‡‘ä¸€äº› */
        .reposted-content-wrapper .post-header {
            margin-bottom: 8px;
        }
        .reposted-content-wrapper .post-avatar {
            width: 32px;
            height: 32px;
        }
        .reposted-content-wrapper .post-nickname {
            font-size: 14px;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

             
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å…±äº«ä½ç½®å¡ç‰‡æ ·å¼ (å¾®ä¿¡é£æ ¼ V2 - æ”¯æŒå›¾ç‰‡èƒŒæ™¯) â–¼â–¼â–¼ */
        
        /* 1. å¡ç‰‡æ€»å®¹å™¨ (ä¿æŒä¸å˜) */
        .location-share-card {
            width: 230px;
            border-radius: 10px;
            overflow: hidden; 
            background-color: #fff;
            border: 1px solid #f0f0f0;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            cursor: pointer; /* è®©å¡ç‰‡çœ‹èµ·æ¥å¯ä»¥ç‚¹å‡» */
        }
        
        /* 2. ä¸ŠåŠéƒ¨åˆ†ï¼šç™½è‰²æ–‡å­—åŒº (ä¿æŒä¸å˜) */
        .card-text-area {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .card-text-primary {
            font-size: 16px;
            font-weight: 600;
            color: #222;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-text-secondary {
            font-size: 12px;
            color: #a0a0a0;
        }
        
        /* 3. ä¸‹åŠéƒ¨åˆ†ï¼šã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ°å›¾/å›¾ç‰‡åŒº */
        .card-map-area {
            height: 100px; /* å¢åŠ é«˜åº¦ä»¥æ›´å¥½åœ°å±•ç¤ºå›¾ç‰‡ */
            display: flex;
            justify-content: center;
            align-items: center;
            
            /* å›¾ç‰‡èƒŒæ™¯çš„å…³é”®æ ·å¼ */
            background-size: cover;
            background-position: center;
            
            /* é»˜è®¤çš„çº¯è‰²èƒŒæ™¯ (å½“æ²¡æœ‰æä¾›å›¾ç‰‡æ—¶ç”Ÿæ•ˆ) */
            background-color: #FFF0F5; /* AIçš„å¡ç‰‡ç”¨æŸ”å’Œç²‰è‰² */
        }
        
        /* 4. ç”¨æˆ·å‘é€çš„å¡ç‰‡ï¼Œåœ°å›¾åŒºé»˜è®¤ç”¨æŸ”å’Œç»¿è‰² */
        .message-bubble.user .location-share-card .card-map-area {
            background-color: #F0FFF8;
        }
        
        /* 5. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¾åŒ–å›¾é’‰å›¾æ ‡ï¼Œå¢åŠ é˜´å½±ä½¿å…¶æ›´çªå‡º */
        .card-pin-icon {
            font-size: 40px;
            color: #FF6B6B; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†é¢œè‰²ä» white æ”¹ä¸ºæ‚¨å–œæ¬¢çš„ä»»æ„é¢œè‰² */
        
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); 
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AI è§’è‰²è¡ŒåŠ¨å‘¼å¸ç¯æ•ˆæœ â–¼â–¼â–¼ */
        @keyframes breathing-light {
            0% {
        box-shadow: 0 0 6px rgba(0, 123, 255, 0.4);
            }
            50% {
        box-shadow: 0 0 18px 4px rgba(0, 123, 255, 0.8);
            }
            100% {
        box-shadow: 0 0 6px rgba(0, 123, 255, 0.4);
            }
        }
        
        .chat-list-item .avatar.is-acting {
            /* æ ¸å¿ƒï¼šåº”ç”¨å‘¼å¸ç¯åŠ¨ç”» */
            animation: breathing-light 2s ease-in-out infinite;
            /* (å¯é€‰) åŒæ—¶æ·»åŠ ä¸€ä¸ªå¸¸äº®çš„è¾¹æ¡†ï¼Œè®©æ•ˆæœæ›´æ˜æ˜¾ */
            border: 1.5px solid rgba(0, 123, 255, 0.7);
        }
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åŠ¨æ€è¯„è®ºåŒºè¡¨æƒ…åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
        
        /* === ã€å…¨æ–°ã€‘è¯„è®ºåŒºè¡¨æƒ…æŒ‰é’®æ ·å¼ (ä¸action-iconé£æ ¼ç»Ÿä¸€) === */
        .comment-sticker-btn {
            /* 1. é‡ç½®æŒ‰é’®é»˜è®¤æ ·å¼ */
            background: none;
            border: none;
            padding: 5px; /* å¢åŠ ä¸€ç‚¹å¯ç‚¹å‡»åŒºåŸŸ */
            cursor: pointer;
            
            /* 2. ä¸å…¶ä»–å›¾æ ‡é¢œè‰²å’Œè¿‡æ¸¡æ•ˆæœå¯¹é½ */
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
        
            /* 3. ä½¿ç”¨Flexå¸ƒå±€è®©å†…éƒ¨çš„SVGå®Œç¾å±…ä¸­ */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .comment-sticker-btn:hover {
            color: var(--text-primary); /* é¼ æ ‡æ‚¬åœæ—¶å˜è‰²ï¼Œæä¾›åé¦ˆ */
        }
        
        /* 4. å®šä¹‰SVGå›¾æ ‡çš„æ ·å¼ï¼Œä¸ç‚¹èµ/è½¬å‘å›¾æ ‡å®Œå…¨ä¸€è‡´ */
        .comment-sticker-btn svg {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* 2. è¯„è®ºåŒºè¡¨æƒ…é¢æ¿å®¹å™¨ */
        #qzone-sticker-panel {
            position: absolute; /* ä½¿ç”¨ç»å¯¹å®šä½ï¼Œç”±JSæ§åˆ¶ä½ç½® */
            width: 280px;
            height: 200px;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 1010; /* ç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column;
            overflow: hidden;
        }
        
        /* 3. é¢æ¿å†…çš„è¡¨æƒ…ç½‘æ ¼ (ä¸å˜) */
        #qzone-sticker-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
        }
        
        #qzone-sticker-grid .sticker-item {
            position: relative;
            aspect-ratio: 1 / 1;
            background-color: white;
            border-radius: 8px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        
        /* 4. è¯„è®ºåŒºé‡Œçš„è¡¨æƒ…å›¾ç‰‡æ ·å¼ (å°ºå¯¸ä¿®æ­£å) */
        .comment-text .comment-sticker {
            max-width: 100px;  /* å‡å°æœ€å¤§å®½åº¦ */
            max-height: 100px; /* å‡å°æœ€å¤§é«˜åº¦ */
            display: block;
            background-color: transparent;
        }
        
        /* 5. ã€æ–°å¢ã€‘ä¼˜åŒ–ï¼šå½“è¯„è®ºå†…å®¹æ˜¯è¡¨æƒ…æ—¶ï¼Œè°ƒæ•´é—´è· */
        .comment-item .comment-text:has(.comment-sticker) {
            /* å¦‚æœ .comment-text å†…éƒ¨åªæœ‰è¡¨æƒ…ï¼Œå°±ç§»é™¤æ–‡å­—è¡Œé«˜å¸¦æ¥çš„é¢å¤–è¾¹è· */
            line-height: 1;
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        /* === å¤´åƒæ¡†é€‰æ‹©æ¨¡æ€æ¡†æ ·å¼ === */
        .change-frame-btn {
            padding: 6px 10px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
        }
        
        #avatar-frame-modal .modal-content {
            height: 70%;
        }
        
        #avatar-frame-modal .modal-body {
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .frame-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .frame-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
        }
        
        .frame-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        
        .frame-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .frame-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }
        
        .frame-item {
            aspect-ratio: 1 / 1;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            background-color: #f0f0f0;
            background-size: cover;
            background-position: center;
            padding: 5px;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .frame-item.selected {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }
        
        .frame-item .preview-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .frame-item .preview-frame {
            position: absolute;
            top: -7px;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        
        /* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤æ–¹æ¡ˆã€‘è¯·ç”¨è¿™ä¸€æ•´å—ä»£ç æ›¿æ¢æ‰€æœ‰æ—§çš„å¤´åƒç›¸å…³æ ·å¼ â–¼â–¼â–¼ */
        
        /* 1. å¤´åƒæœ€å¤–å±‚å®¹å™¨ï¼Œè´Ÿè´£å ä½å’ŒåŠ¨æ€å˜å®½ */
        .avatar-group {
            width: 34px;
            flex-shrink: 0; /* ç¡®ä¿åœ¨flexå¸ƒå±€ä¸­ä¸è¢«å‹ç¼© */
            position: relative;
            transition: width 0.2s ease;
        }
        /* å½“ä½©æˆ´å¤´åƒæ¡†æ—¶ï¼Œå¤–å±‚å®¹å™¨å˜å®½ï¼Œä¸ºæ›´å¤§çš„å¤´åƒæ¡†åˆ›é€ ç©ºé—´ */
        .avatar-group.has-frame {
            width: 42px; 
        }
        
        /* 2. åŸºç¡€çš„ã€æ— æ¡†çš„å¤´åƒæ ·å¼ */
        .message-bubble .avatar {
            width: 34px;
            height: 34px;
            border-radius: 20%; /* é»˜è®¤çš„æ–¹åœ†å½¢å¤´åƒ */
            object-fit: cover;
        }
        
        /* 3. å¸¦æ¡†å¤´åƒçš„â€œå†…éƒ¨å®¹å™¨â€ */
        .avatar-with-frame {
            position: relative; /* å…³é”®ï¼šä¸ºå†…éƒ¨çš„å¤´åƒå’Œæ¡†æä¾›å®šä½é”šç‚¹ */
            width: 38px;
            height: 38px;
            margin: 0 auto;
            transition: all 0.2s ease;
        }
        /* ã€æ ¸å¿ƒã€‘å½“æœ‰æ¡†æ—¶ï¼Œè¿™ä¸ªå†…éƒ¨å®¹å™¨ä¹Ÿå˜å¤§ï¼Œè®©é‡Œé¢çš„å›¾ç‰‡å¯ä»¥æ›´å¤§ */
        .avatar-group.has-frame .avatar-with-frame {
            width: 43px;
            height: 43px;
        }
        
        /* 4. å¸¦æ¡†å¤´åƒä¸­çš„â€œå¤´åƒå›¾ç‰‡æœ¬èº«â€ */
        .avatar-with-frame .avatar-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; /* å®½åº¦æ’‘æ»¡å…¶çˆ¶å®¹å™¨ (.avatar-with-frame) */
            height: 100%;/* é«˜åº¦ä¹Ÿæ’‘æ»¡ */
            border-radius: 50%; /* ä½©æˆ´å¤´åƒæ¡†æ—¶ï¼Œå›¾ç‰‡æœ¬èº«å˜ä¸ºåœ†å½¢ä»¥æ›´å¥½åœ°é€‚é… */
            object-fit: cover;
            z-index: 1; /* ç¡®ä¿åœ¨å¤´åƒæ¡†ä¸‹æ–¹ */
        }
        
        /* 5. â€œå¤´åƒæ¡†å›¾ç‰‡æœ¬èº«â€ */
        .avatar-with-frame .avatar-frame {
            position: absolute;
            width: 120%;  
            height: 120%; 
        
            /* --- è¿™å°±æ˜¯ç¡®ä¿å®Œç¾åŒ…è£¹å’Œå±…ä¸­çš„å…³é”®ä»£ç  --- */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* --- å…³é”®ä»£ç ç»“æŸ --- */
            z-index: 2; /* ç¡®ä¿åœ¨å¤´åƒå›¾ç‰‡ä¸Šæ–¹ */
            pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶å¯ä»¥ç©¿é€å¤´åƒæ¡†ï¼Œç‚¹åˆ°ä¸‹é¢çš„å¤´åƒ */
        }
        
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤æ–¹æ¡ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ‰€æœ‰æ—§çš„å¤´åƒå’Œæ°”æ³¡ç›¸å…³æ ·å¼ â–¼â–¼â–¼ */
        
        /* 1. å¼ºåˆ¶å¤–å±‚æ°”æ³¡å®¹å™¨(.message-bubble)æˆä¸ºä¸€ä¸ªçœŸæ­£çš„â€œå¼¹æ€§â€é¡¹ç›®ã€‚*/
        /* è¿™è®©å®ƒå¯ä»¥æ­£ç¡®åœ°ä¸ºæ—è¾¹çš„â€œæ—¶é—´æˆ³â€æ”¶ç¼©ã€‚*/
        .message-bubble {
            flex: 1;          /* å…³é”®ä¿®å¤â‘ : è®©å®ƒå¡«å……æ‰€æœ‰å¯ç”¨ç©ºé—´ (flex-grow: 1, flex-shrink: 1) */
            min-width: 0;     /* å…³é”®ä¿®å¤â‘¡: å…è®¸å®ƒæ”¶ç¼©è‡³æ¯”å…¶å†…å®¹æ›´å°ï¼Œè¿™æ˜¯è§£å†³æ­¤ç±»é—®é¢˜çš„æ ¸å¿ƒæŠ€å·§ */
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 100%;
        }
        
        .message-bubble.user { 
            flex-direction: row-reverse; 
        }
        
        /* 2. å¼ºåˆ¶å†…å±‚å†…å®¹åŒº(.content)ä¹Ÿæˆä¸ºä¸€ä¸ªâ€œå¼¹æ€§â€é¡¹ç›®ã€‚*/
        /* è¿™è®©å®ƒå¯ä»¥æ­£ç¡®åœ°ä¸ºæ—è¾¹çš„â€œå¤´åƒâ€æ”¶ç¼©ã€‚*/
        .message-bubble .content {
            flex: 1;          /* å…³é”®ä¿®å¤â‘¢: è®©å†…å®¹åŒºå¡«å……æ°”æ³¡å†…çš„æ‰€æœ‰å¯ç”¨ç©ºé—´ */
            min-width: 0;     /* å…³é”®ä¿®å¤â‘£: åŒæ ·å…è®¸å®ƒæ”¶ç¼©ï¼Œé˜²æ­¢é•¿æ–‡æœ¬æ’‘ç ´å¸ƒå±€ */
            word-break: break-all !important; /* å…³é”®ä¿®å¤â‘¤: ä½¿ç”¨æœ€å¼ºåŠ›çš„æ¢è¡Œæ¨¡å¼ï¼Œç¡®ä¿é•¿ä¸²å­—ç¬¦èƒ½è¢«æˆªæ–­ */
            position: relative;
            font-size: var(--chat-font-size, 16px);
            padding: 8px 12px;
            line-height: 1.5;
        }
        
        /* 3. å†æ¬¡ç¡®ä¿å¤´åƒå®¹å™¨ç»å¯¹ä¸æ”¶ç¼© (ä½œä¸ºæœ€ç»ˆä¿é™©) */
        .message-bubble .avatar-group {
            flex-shrink: 0 !important;
        }
        
        /* â–²â–²â–² ä¿®å¤æ–¹æ¡ˆç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€ç»ˆæå¼ºåˆ¶ä¿®æ­£ã€‘è¯·å°†è¿™æ®µä»£ç ç²˜è´´åˆ° <style> çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */
        
        /* ä½¿ç”¨IDé€‰æ‹©å™¨å’Œ!importantï¼Œå¼ºåˆ¶æå‡è¿™æ¡è§„åˆ™çš„ä¼˜å…ˆçº§åˆ°æœ€é«˜ï¼Œ
           ä»¥è¦†ç›–ä»»ä½•å¯èƒ½å­˜åœ¨çš„æœªçŸ¥å†²çªæ ·å¼ã€‚*/
        
        #chat-interface-screen .message-bubble .avatar-group.has-frame .avatar-with-frame {
            width: 43px !important;
            height: 43px !important;
        }
        
        #chat-interface-screen .message-bubble .avatar-with-frame .avatar-img {
            width: 100% !important;
            height: 100% !important;
        }
        /* â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¡ç‰‡/ç‰¹æ®Šå†…å®¹å±…ä¸­ä¿®æ­£ â–¼â–¼â–¼ */
        .message-bubble.is-link-share .content,
        .message-bubble.is-transfer .content,
        .message-bubble.is-waimai-request .content,
        .message-bubble.is-red-packet .content,
        .message-bubble.is-poll .content,
        .message-bubble.is-location-share .content,
        .message-bubble.is-sticker .content,
        .message-bubble.is-ai-image .content {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘éšè—èŠå¤©åˆ—è¡¨ä¸­çš„å¤´åƒæ¡† (æœ€ç»ˆä¿®æ­£ç‰ˆ) â–¼â–¼â–¼ */
        
        /* 1. åœ¨èŠå¤©åˆ—è¡¨å±å¹•ä¸­ï¼Œç›´æ¥éšè—å¤´åƒæ¡†å›¾ç‰‡ */
        #chat-list-screen .avatar-frame {
            display: none;
        }
        
        /* 2. å¼ºåˆ¶æ‰€æœ‰å¤´åƒçš„æœ€å¤–å±‚å®¹å™¨ï¼Œåœ¨åˆ—è¡¨é¡µéƒ½ä¿æŒ 45px çš„æ­£ç¡®å°ºå¯¸ */
        #chat-list-screen .avatar-group {
            width: 45px;
            height: 45px;
        }
        
        /* 3. å¦‚æœä¸€ä¸ªå¤´åƒæ˜¯å¸¦æ¡†ç»“æ„ï¼Œä¹Ÿå¼ºåˆ¶å…¶å†…éƒ¨å®¹å™¨å’Œå›¾ç‰‡é€‚åº” 45px çš„å°ºå¯¸ */
        #chat-list-screen .avatar-group.has-frame .avatar-with-frame,
        #chat-list-screen .avatar-group.has-frame .avatar-img {
            width: 45px;
            height: 45px;
        }
        
        /* 4. ç¡®ä¿æ‰€æœ‰å¤´åƒåœ¨åˆ—è¡¨é¡µéƒ½æ˜¯åœ†å½¢çš„ï¼Œä¿æŒç»Ÿä¸€ */
        #chat-list-screen .avatar-img,
        #chat-list-screen .avatar {
            border-radius: 50%;
        }
        
        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¢åŠ èŠå¤©åˆ—è¡¨å¤´åƒä¸æ–‡å­—çš„é—´è· â–¼â–¼â–¼ */
        
        /* 1. å¼ºåˆ¶ä¸ºèŠå¤©åˆ—è¡¨ä¸­çš„å¤´åƒå®¹å™¨è®¾ç½®å³è¾¹è· */
        /*    è¿™å°†è¦†ç›–ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ—§æ ·å¼ï¼Œå¹¶ç¡®ä¿é—´è·ç”Ÿæ•ˆ */
        #chat-list .chat-list-item .avatar-group {
            margin-right: 15px !important; /* æ ¸å¿ƒï¼šå¢åŠ å³è¾¹è·ï¼Œå°†æ–‡å­—æ¨å¼€ */
        }
        
        /* 2. (å¯é€‰ä½†æ¨è) ç¡®ä¿æ—§çš„å¤´åƒæ ·å¼ä¸å†å¹²æ‰°å¸ƒå±€ */
        #chat-list .chat-list-item .avatar {
            margin-right: 0; /* ç§»é™¤æ—§çš„è¾¹è·ï¼Œé˜²æ­¢é‡å¤è®¡ç®— */
        }
        
        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åŠ¨æ€è¯„è®ºåŒºå›å¤åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
        
        /* è®©è¯„è®ºé¡¹åœ¨é¼ æ ‡æ‚¬åœæ—¶é«˜äº®ï¼Œå¹¶æ˜¾ç¤ºæ‰‹å‹å…‰æ ‡ */
        .comment-item {
            cursor: pointer;
            transition: background-color 0.2s;
            /* ä½¿ç”¨Flexå¸ƒå±€ï¼Œè®©è¯„è®ºå†…å®¹å’Œåˆ é™¤æŒ‰é’®èƒ½æ­£ç¡®å¯¹é½ */
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px; /* å†…å®¹å’Œåˆ é™¤æŒ‰é’®çš„é—´è· */
            padding: 4px 6px; /* å¢åŠ ä¸€ç‚¹å†…è¾¹è·ï¼Œæ–¹ä¾¿ç‚¹å‡» */
            margin: 0 -6px; /* æŠµæ¶ˆå†…è¾¹è·ï¼Œä¿æŒè§†è§‰å¯¹é½ */
            border-radius: 4px;
        }
        
        .comment-item:hover {
            background-color: #f0f2f5;
        }
        
        /* å¤œé—´æ¨¡å¼ä¸‹çš„æ‚¬åœæ•ˆæœ */
        #phone-screen.dark-mode .comment-item:hover {
            background-color: #2c2c2e;
        }
        
        /* è¯„è®ºå†…å®¹æ–‡æœ¬çš„å®¹å™¨ */
        .comment-item .comment-text {
            flex-grow: 1; /* å æ®ä¸»è¦ç©ºé—´ */
            word-break: break-word; /* ç¡®ä¿é•¿å†…å®¹èƒ½æ¢è¡Œ */
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨äºå…¼å®¹æ—§æ ¼å¼è¯„è®ºçš„æ ·å¼ â–¼â–¼â–¼ */
        .legacy-comment-item {
            line-height: 1.5;
            padding: 4px 6px; /* å’Œæ–°æ ·å¼ä¿æŒä¸€è‡´çš„å†…è¾¹è· */
            color: var(--text-secondary); /* ç”¨æ¬¡è¦é¢œè‰²æ˜¾ç¤ºï¼Œä»¥ç¤ºåŒºåˆ« */
        }
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¡ç‰‡/ç‰¹æ®Šå†…å®¹å±…ä¸­ä¿®æ­£ â–¼â–¼â–¼ */
        .message-bubble.is-link-share .content,
        .message-bubble.is-transfer .content,
        .message-bubble.is-waimai-request .content,
        .message-bubble.is-red-packet .content,
        .message-bubble.is-poll .content,
        .message-bubble.is-location-share .content,
        .message-bubble.is-sticker .content,
        .message-bubble.is-ai-image .content {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€ç»ˆæå¼ºåˆ¶ä¿®æ­£ã€‘è¯·å°†è¿™æ®µä»£ç ç²˜è´´åˆ° <style> çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */
        
        /* ä½¿ç”¨IDé€‰æ‹©å™¨å’Œ!importantï¼Œå¼ºåˆ¶æå‡è¿™æ¡è§„åˆ™çš„ä¼˜å…ˆçº§åˆ°æœ€é«˜ï¼Œ
           ä»¥è¦†ç›–ä»»ä½•å¯èƒ½å­˜åœ¨çš„æœªçŸ¥å†²çªæ ·å¼ã€‚*/
        
        #chat-interface-screen .message-bubble .avatar-group.has-frame .avatar-with-frame {
            width: 43px !important;
            height: 43px !important;
        }
        
        #chat-interface-screen .message-bubble .avatar-with-frame .avatar-img {
            width: 100% !important;
            height: 100% !important;
        }
        /* â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€Safari/iOS æœ€ç»ˆå¡ç‰‡å¸ƒå±€ä¿®å¤ã€‘è¯·ç”¨è¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç  â–¼â–¼â–¼ */
        
        /* 
          ç¬¬ä¸€æ­¥ï¼šã€æ ¸å¿ƒä¿®å¤ã€‘
          è¿™ä¸ªé€‰æ‹©å™¨ä¼šä¸€æ¬¡æ€§é€‰ä¸­æ‰€æœ‰åŒ…å«ç‰¹æ®Šå¡ç‰‡çš„æ¶ˆæ¯æ°”æ³¡å®¹å™¨(.message-bubble)ã€‚
          æˆ‘ä»¬å‘Šè¯‰å®ƒä¸è¦å†å¼ºåˆ¶æ‹‰ä¼¸ï¼Œè€Œæ˜¯æ ¹æ®å†…éƒ¨å¡ç‰‡çš„å¤§å°è‡ªé€‚åº”å®½åº¦ã€‚
        */
        .message-bubble.is-sticker,
        .message-bubble.is-voice-message,
        .message-bubble.is-transfer,
        .message-bubble.is-ai-image,
        .message-bubble.is-waimai-request,
        .message-bubble.is-red-packet,
        .message-bubble.is-poll,
        .message-bubble.is-link-share,
        .message-bubble.is-location-share {
            flex: initial; /* è¦†ç›–æ‰é€šç”¨çš„ flex: 1ï¼Œè¿™æ˜¯è§£å†³é—®é¢˜çš„å…³é”®ï¼Œè®©æ°”æ³¡æœ¬èº«ä¸å†æ‹‰ä¼¸ */
            min-width: auto; /* åŒæ ·é‡ç½® min-widthï¼Œå…è®¸å…¶è‡ªç”±æ”¶ç¼© */
        }
        
        /* 
          ç¬¬äºŒæ­¥ï¼šä¿æŒå¯¹å¡ç‰‡å†…éƒ¨ .content åŒºåŸŸçš„æ ·å¼é‡ç½®ã€‚
          æˆ‘ä»¬ç§»é™¤å®ƒçš„èƒŒæ™¯å’Œå†…è¾¹è·ï¼Œè®©å¡ç‰‡è‡ªå·±è´Ÿè´£å¤–è§‚ã€‚
        */
        .message-bubble.is-sticker .content,
        .message-bubble.is-voice-message .content,
        .message-bubble.is-transfer .content,
        .message-bubble.is-ai-image .content,
        .message-bubble.is-waimai-request .content,
        .message-bubble.is-red-packet .content,
        .message-bubble.is-poll .content,
        .message-bubble.is-link-share .content,
        .message-bubble.is-location-share .content {
            /* ä¿æŒè¿™ä¸ªå¥½ä¹ æƒ¯ï¼Œç¡®ä¿å†…å®¹åŒºä¹Ÿä¸æ‹‰ä¼¸ */
            flex: initial; 
            
            /* ç§»é™¤æ‰€æœ‰å¯èƒ½å¹²æ‰°å¡ç‰‡æ˜¾ç¤ºçš„æ ·å¼ */
            padding: 0;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }
        
        /* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€ç»ˆæç‰ˆã€‘ç¾¤å…¬å‘Šå¯¹é½ä¿®å¤ (å¼ºåˆ¶æ‰€æœ‰å†…å®¹é å·¦) â–¼â–¼â–¼ */
        
        /* 
          ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶æ‰€æœ‰æ¶ˆæ¯å—ï¼ˆæ— è®ºæ˜¯AIè¿˜æ˜¯ç”¨æˆ·ï¼‰éƒ½åœ¨å…¬å‘Šæ¿å†…é å·¦å¯¹é½ã€‚
          è¿™ç¡®ä¿äº†AIå’Œç”¨æˆ·çš„æ¶ˆæ¯å—åœ¨å‚ç›´æ–¹å‘ä¸Šæ˜¯å¯¹é½çš„ã€‚
        */
        #announcement-board-content .message-wrapper {
            align-self: flex-start !important;
        }
        
        /* 
          ç¬¬äºŒæ­¥ï¼šè¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼
          æˆ‘ä»¬ä¸“é—¨é’ˆå¯¹ç”¨æˆ·çš„æ¶ˆæ¯æ°”æ³¡ï¼Œå¼ºåˆ¶å°†å…¶å†…éƒ¨çš„å…ƒç´ é¡ºåºï¼ˆå¤´åƒå’Œå†…å®¹ï¼‰
          ä»â€œåå‘â€æ¢å¤ä¸ºâ€œæ­£å‘â€ï¼Œä½¿å…¶ä¸AIçš„æ¶ˆæ¯æ°”æ³¡å¸ƒå±€å®Œå…¨ä¸€è‡´ã€‚
        */
        #announcement-board-content .message-bubble.user {
            flex-direction: row !important;
        }
        
        /* 
          ç¬¬ä¸‰æ­¥ (å¯é€‰ä½†æ¨è): 
          åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¼ºåˆ¶å°†ç”¨æˆ·æ¶ˆæ¯å—å¤–éƒ¨çš„æ—¶é—´æˆ³å’Œæ°”æ³¡é¡ºåºæ¢å¤æ­£å¸¸ï¼Œ
          ä»¥é˜²æœªæ¥å¯èƒ½å‡ºç°çš„å¸ƒå±€é—®é¢˜ã€‚
        */
        #announcement-board-content .message-wrapper.user {
            flex-direction: row !important;
        }
        
        /* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€ç»ˆæä¿®å¤ã€‘è¯·ç”¨è¿™ä¸€æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰ä½ ä¸Šä¸€æ¬¡ç²˜è´´çš„ä»£ç  â–¼â–¼â–¼ */
        
        /* === èŠå¤©ç•Œé¢å¤´éƒ¨æµ®åŠ¨ä¸å±‚çº§ç»ˆæä¿®å¤ === */
        
        /* 
          è¿™æ¬¡çš„ä¿®å¤æœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼š
          1. ä¾ç„¶ä½¿ç”¨ absolute å®šä½è®©å¤´éƒ¨æµ®åŠ¨èµ·æ¥ã€‚
          2. é¢å¤–ç»™å®ƒä¸€ä¸ªéå¸¸é«˜çš„ z-index å¹¶ç”¨ !important æ ‡è®°ï¼Œ
             èµ‹äºˆå®ƒâ€œè‡³é«˜æ— ä¸Šâ€çš„æƒåŠ›ï¼Œå¼ºåˆ¶å®ƒå‹åˆ¶é¡µé¢ä¸Šä»»ä½•å…¶ä»–å…ƒç´ ã€‚
        */
        
        /* 1. å¼ºåˆ¶èŠå¤©ç•Œé¢çš„å¤´éƒ¨å˜ä¸ºç»å¯¹å®šä½ï¼Œå¹¶èµ‹äºˆä¸€ä¸ªæé«˜çš„å±‚çº§ */
        #chat-interface-screen > .header {
            position: absolute !important; /* æ ¸å¿ƒä¿®æ­£1: è„±ç¦»æ–‡æ¡£æµï¼Œæµ®åŠ¨èµ·æ¥ */
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100 !important; /* æ ¸å¿ƒä¿®æ­£2: èµ‹äºˆä¸€ä¸ªéå¸¸é«˜çš„ z-indexï¼Œå‹åˆ¶ä¸€åˆ‡ */
        }
        
        /* 2. ä¿®æ­£èŠå¤©å†…å®¹åŒºçš„å¸ƒå±€ï¼Œç§»é™¤ä¸å†éœ€è¦çš„è´Ÿå¤–è¾¹è·ï¼Œè®©ä¸ºå¤´éƒ¨é¢„ç•™çš„ padding ç”Ÿæ•ˆ */
        #chat-interface-screen #chat-messages {
            margin-top: 0 !important; /* æ ¸å¿ƒä¿®æ­£3: ç§»é™¤ç”¨äºâ€œä¸Šæ‹‰â€çš„è´Ÿå¤–è¾¹è· */
        }
        
        /* â–²â–²â–² ä¿®å¤ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€æœ€ç»ˆè§£å†³æ–¹æ¡ˆã€‘è¯·ç”¨è¿™ä¸€æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ä¿®å¤ä»£ç  â–¼â–¼â–¼ */
        
        /* === èŠå¤©ç•Œé¢å¸ƒå±€ä¸å±‚çº§ç»ˆæä¿®å¤ === */
        
        /* 
          ç¬¬ä¸€éƒ¨åˆ†ï¼šä¿®å¤éŸ³ä¹æ’­æ”¾å™¨è¢«é®æŒ¡çš„é—®é¢˜
          æˆ‘ä»¬ç»™æ’­æ”¾å™¨ä¸€ä¸ªæ¯”å¤´éƒ¨æ›´é«˜çš„ z-indexï¼Œè®©å®ƒèƒ½æ­£ç¡®åœ°è¦†ç›–æ‰€æœ‰å†…å®¹ã€‚
        */
        #music-player-overlay {
            z-index: 200 !important;
        }
        
        /* 
          ç¬¬äºŒéƒ¨åˆ†ï¼šå½»åº•é‡æ„èŠå¤©é¡µé¢çš„å¸ƒå±€ï¼Œè§£å†³å®½åº¦å’Œé®æŒ¡é—®é¢˜
          æˆ‘ä»¬å°†é‡‡ç”¨æœ€ç¨³å®šã€æœ€ç°ä»£çš„å¸ƒå±€æ–¹å¼ï¼š
          - å¤´éƒ¨å’Œè¾“å…¥æ¡†éƒ½ä½¿ç”¨ç»å¯¹å®šä½ï¼Œåˆ†åˆ«â€œé’‰â€åœ¨å±å¹•çš„é¡¶éƒ¨å’Œåº•éƒ¨ã€‚
          - èŠå¤©å†…å®¹åŒºåˆ™å æ®æ•´ä¸ªå±å¹•çš„é«˜åº¦ï¼Œå¹¶é€šè¿‡å†…è¾¹è·ï¼ˆpaddingï¼‰ä¸ºå¤´éƒ¨å’Œè¾“å…¥æ¡†ç•™å‡ºç©ºé—´ã€‚
          è¿™æ ·å¯ä»¥å®Œç¾å®ç°å†…å®¹åœ¨é€æ˜é¡¶/åº•éƒ¨ä¹‹ä¸‹æ»šåŠ¨çš„ç¾è§‚æ•ˆæœï¼Œä¸”ä¸ä¼šå†å‡ºç°å®½åº¦è®¡ç®—é”™è¯¯ã€‚
        */
        
        /* â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ‰€æœ‰æ—§çš„èŠå¤©ç•Œé¢å¸ƒå±€CSS â–¼â–¼â–¼ */
        
        /* 1. ç¡®ä¿èŠå¤©ç•Œé¢å®¹å™¨æ˜¯å¯é çš„å®šä½é”šç‚¹ */
        #chat-interface-screen {
            position: relative !important;
            height: 100%;
            width: 100%;
            overflow: hidden; /* é˜²æ­¢ä»»ä½•æ„å¤–æº¢å‡º */
        }
        
        /* 2. å¼ºåˆ¶ã€å¤´éƒ¨ã€‘ç»å¯¹å®šä½ï¼Œå¹¶â€œé’‰â€åœ¨å±å¹•é¡¶éƒ¨ */
        #chat-interface-screen > .header {
            position: absolute !important;
            top: 0;
            left: 0;
            right: 0; /* ä½¿ç”¨ left/right æ’‘æ»¡å®½åº¦ï¼Œæ¯” width:100% æ›´å¯é  */
            width: auto !important; 
            z-index: 100 !important; /* èµ‹äºˆä¸€ä¸ªéå¸¸é«˜çš„å±‚çº§ï¼Œç¡®ä¿å®ƒåœ¨æœ€ä¸Šå±‚ */
        }
        
        /* 3. å¼ºåˆ¶ã€è¾“å…¥æ¡†ã€‘ä¹Ÿç»å¯¹å®šä½ï¼Œå¹¶â€œé’‰â€åœ¨å±å¹•åº•éƒ¨ */
        #chat-interface-screen #chat-input-area {
            position: absolute !important;
            bottom: 0;
            left: 0;
            right: 0;
            width: auto !important;
            z-index: 100 !important;
            /* æ ¸å¿ƒï¼šä¸ºè¾“å…¥æ¡†æœ¬èº«æ·»åŠ é€‚é…â€œå°é»‘æ¡â€çš„åº•éƒ¨å†…è¾¹è· */
            padding-bottom: calc(8px + env(safe-area-inset-bottom)); 
        }
        
        /* 4. ã€æ ¸å¿ƒã€‘é‡æ–°å®šä¹‰ã€èŠå¤©å†…å®¹åŒºã€‘çš„å¸ƒå±€ */
        #chat-interface-screen #chat-messages {
            /* è®©å®ƒå¡«æ»¡æ•´ä¸ªå±å¹• */
            height: 100% !important; 
            width: 100% !important;
            
            /* å…è®¸å…¶å†…å®¹å‚ç›´æ»šåŠ¨ */
            overflow-y: auto !important; 
            
            /* ç¡®ä¿ padding çš„è®¡ç®—æ–¹å¼æ­£ç¡® */
            box-sizing: border-box !important; 
            
            /* ç§»é™¤æ‰€æœ‰å¯èƒ½å¹²æ‰°å¸ƒå±€çš„ margin */
            margin-top: 0 !important; 
        
            /* å…³é”®ï¼šä½¿ç”¨å†…è¾¹è·ä¸ºé¡¶éƒ¨çš„â€œå¤´éƒ¨â€å’Œåº•éƒ¨çš„â€œè¾“å…¥æ¡†â€ç•™å‡ºç©ºé—´ */
            /* è¿™æ ·å†…å®¹å°±ä¼šåœ¨åŠé€æ˜çš„é¡¶/åº•éƒ¨ä¹‹ä¸‹æ»šåŠ¨ï¼Œæ•ˆæœç¾è§‚ä¸”ç²¾å‡† */
            padding-top: 150px !important;  /* ä¸ºå¤´éƒ¨é¢„ç•™çº¦110pxç©ºé—´ */
            padding-bottom: 150px !important; /* ä¸ºè¾“å…¥æ¡†é¢„ç•™çº¦120pxç©ºé—´ */
        }
        
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        
        /* â–²â–²â–² ä¿®å¤ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œåŠ¨æ€å·²åˆ é™¤â€æç¤ºæ ·å¼ â–¼â–¼â–¼ */
        .post-deleted-placeholder {
            align-self: center;
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            cursor: pointer; /* å…³é”®ï¼šè®©å®ƒçœ‹èµ·æ¥å¯ä»¥ç‚¹å‡» */
        }
        
        #phone-screen.dark-mode .post-deleted-placeholder {
            background-color: rgba(255, 255, 255, 0.15);
        }
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºæ¶‚é»‘ï¼ˆå‰§é€ï¼‰åŠŸèƒ½æ·»åŠ çš„æ ·å¼ â–¼â–¼â–¼ */
        .spoiler {
            background-color: #333; /* æ¶‚é»‘çš„èƒŒæ™¯è‰² */
            color: #333;           /* æ¶‚é»‘çš„æ–‡å­—é¢œè‰²ï¼Œä½¿å…¶ä¸èƒŒæ™¯èä¸ºä¸€ä½“ */
            padding: 0 4px;         /* è½»å¾®çš„å·¦å³å†…è¾¹è·ï¼Œä½¿å…¶æ›´ç¾è§‚ */
            border-radius: 4px;     /* åœ†è§’ */
            cursor: pointer;        /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¸ºå¯ç‚¹å‡»çš„æ‰‹å‹ */
            transition: all 0.2s ease-in-out; /* è®©æ˜¾ç¤º/éšè—æ•ˆæœæ›´å¹³æ»‘ */
        }
        
        /* é¼ æ ‡æ‚¬åœæˆ–ç‚¹å‡»æ—¶ï¼Œæ¢å¤èƒŒæ™¯å’Œæ–‡å­—é¢œè‰²ä»¥æ˜¾ç¤ºå†…å®¹ */
        .spoiler:hover, .spoiler:active {
            background-color: #e0e0e0; /* æ˜¾ç¤ºæ—¶ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
            color: inherit;           /* æ¢å¤ä¸ºæ­£å¸¸çš„æ–‡å­—é¢œè‰² */
        }
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é•¿æœŸè®°å¿†ç®¡ç†æŒ‰é’®ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */
        .memory-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px; /* å¢åŠ ä¸€ç‚¹å¯ç‚¹å‡»åŒºåŸŸï¼Œæ–¹ä¾¿ç”¨æˆ·æ“ä½œ */
            border-radius: 50%; /* åœ†å½¢èƒŒæ™¯ */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .memory-action-btn svg {
            width: 18px;  /* è®©å›¾æ ‡æ¯”é¡¶éƒ¨çš„ç¨å°ä¸€ç‚¹ï¼Œæ›´æ˜¾ç²¾è‡´ */
            height: 18px;
            stroke: var(--text-secondary); /* é»˜è®¤ä½¿ç”¨æ¬¡è¦æ–‡å­—çš„ç°è‰² */
            transition: stroke 0.2s;
        }
        
        .memory-action-btn:hover {
            background-color: #e9ecef; /* é¼ æ ‡æ‚¬åœæ—¶ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
        }
        
        /* å¤œé—´æ¨¡å¼ä¸‹çš„æ‚¬åœæ•ˆæœ */
        #phone-screen.dark-mode .memory-action-btn:hover {
            background-color: #38383a;
        }
        
        /* ç¼–è¾‘æŒ‰é’®æ‚¬åœæ—¶ï¼Œå›¾æ ‡å˜ä¸ºè“è‰² */
        .memory-action-btn.edit-memory-btn:hover svg {
            stroke: var(--accent-color);
        }
        
        /* åˆ é™¤æŒ‰é’®æ‚¬åœæ—¶ï¼Œå›¾æ ‡å˜ä¸ºå±é™©çš„çº¢è‰² */
        .memory-action-btn.delete-memory-btn:hover svg {
            stroke: #ff3b30;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…æ‰¹é‡åˆ é™¤åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
        
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œä¸ºè¡¨æƒ…é¡¹æ·»åŠ ä¸€ä¸ªé€‰ä¸­æ¡† */
        #sticker-grid.management-mode .sticker-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-radius: 10px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œè¢«é€‰ä¸­çš„è¡¨æƒ…é¡¹ï¼Œæ˜¾ç¤ºè“è‰²è¾¹æ¡† */
        #sticker-grid.management-mode .sticker-item.selected::after {
            border-color: var(--accent-color);
        }
        
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œæ€»æ˜¯æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
        #sticker-grid.management-mode .sticker-item .delete-btn {
            display: block;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid white;
        }
        
        /* åº•éƒ¨æ‰¹é‡åˆ é™¤æ“ä½œæ  */
        #sticker-action-bar {
            display: none; /* é»˜è®¤éšè— */
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
        }
        
        #sticker-action-bar button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯¼æ¼”å‰ªè¾‘å®¤æ ·å¼ â–¼â–¼â–¼ */
        #ai-response-editor-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .ai-response-editor-block {
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }
        
        .ai-response-editor-block textarea {
            width: 100%;
            min-height: 80px; /* é»˜è®¤ç»™ä¸€ä¸ªæ›´å¤§çš„é«˜åº¦ */
            resize: vertical;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            font-size: 14px; /* ä½¿ç”¨å°ä¸€ç‚¹çš„å­—ä½“ï¼Œæ–¹ä¾¿æŸ¥çœ‹JSON */
            font-family: monospace; /* ä½¿ç”¨ç­‰å®½å­—ä½“ï¼Œè®©JSONå¯¹é½æ›´ç¾è§‚ */
            box-sizing: border-box;
        }
        
        .ai-response-editor-block .format-helpers {
            margin-top: 8px;
            margin-bottom: 0; /* è¦†ç›–é»˜è®¤çš„ margin-bottom */
        }
        
        .ai-response-editor-block .delete-block-btn {
            float: right;
            margin-top: -5px;
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
        }
        
        #phone-screen.dark-mode .ai-response-editor-block {
            background-color: #2c2c2e;
            border-color: #38383a;
        }
        #phone-screen.dark-mode .ai-response-editor-block textarea {
            background-color: #1c1c1e;
            color: #f0f0f0;
            border-color: #4a4a4e;
        }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¿ä¸‹æ¨¡å¼æ¶ˆæ¯æ ·å¼ â–¼â–¼â–¼ */
.offline-dialogue {
    /* å¯¹è¯éƒ¨åˆ†å¯ä»¥ä¿æŒé»˜è®¤æ ·å¼ï¼Œæˆ–è€…ç¨ä½œå¼ºè°ƒ */
    font-weight: 500;
}
.offline-description {
    display: block; /* ç¡®ä¿æå†™å¦èµ·ä¸€è¡Œæˆ–å¤šè¡Œ */
    color: var(--text-secondary);
    font-style: italic; /* å¿ƒç†æ´»åŠ¨å’ŒåŠ¨ä½œæå†™ä½¿ç”¨æ–œä½“ï¼Œä»¥ä½œåŒºåˆ† */
    margin-top: 4px; /* å’Œå¯¹è¯æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
    white-space: pre-wrap; /* å…è®¸æå†™ä¸­çš„æ¢è¡Œç¬¦ç”Ÿæ•ˆ */
    line-height: 1.6;
}

#phone-screen.dark-mode .offline-description {
    color: #a0a0a0; /* å¤œé—´æ¨¡å¼ä¸‹ä½¿ç”¨æ›´æŸ”å’Œçš„ç°è‰² */
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨è·³è½¬é«˜äº®æ•ˆæœ â–¼â–¼â–¼ */
        
        /* 1. ä¸ºæ¶ˆæ¯æ°”æ³¡çš„å†…å®¹åŒºæ·»åŠ ä¸€ä¸ªå¹³æ»‘çš„èƒŒæ™¯è‰²è¿‡æ¸¡æ•ˆæœ */
        .message-bubble .content {
            transition: background-color 0.5s ease-out;
        }
        
        /* 2. å®šä¹‰é«˜äº®æ—¶çš„èƒŒæ™¯è‰² */
        /*    æˆ‘ä»¬ä½¿ç”¨ !important æ¥ç¡®ä¿å®ƒèƒ½è¦†ç›–æ‰æ‰€æœ‰ä¸»é¢˜çš„é»˜è®¤é¢œè‰² */
        .message-bubble.highlighted .content {
            background-color: rgba(0, 123, 255, 0.2) !important;
        }
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å¸ƒå±€ç»ˆæä¿®å¤ã€‘è¯·ç”¨è¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œæ›¿æ¢æ‰æ‚¨æ—§çš„æ‰€æœ‰äº”å­æ£‹ç›¸å…³æ ·å¼ â–¼â–¼â–¼ */
        
        /* â–¼â–¼â–¼ ã€è¾¹æ¡†ç»ˆæä¿®å¤V2ã€‘è¯·ç”¨è¿™ä¸€æ•´å—å…¨æ–°çš„CSSï¼Œæ›¿æ¢æ‰æ‚¨æ—§çš„æ‰€æœ‰äº”å­æ£‹ç›¸å…³æ ·å¼ â–¼â–¼â–¼ */
        
        /* 1. æ£‹ç›˜çš„å¤–éƒ¨å®¹å™¨ (è´Ÿè´£å®šä½å’ŒåŠ¨ç”»çª—å£) */
        #gomoku-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 350px;
            z-index: 50;
            pointer-events: none; /* è®©ç‚¹å‡»å¯ä»¥ç©¿é€ */
            overflow: hidden;     /* ã€æ ¸å¿ƒã€‘éšè—æ‰æ»‘å‡ºå±å¹•å¤–çš„å†…å®¹ */
            display: none;        /* é»˜è®¤ä¸æ˜¾ç¤ºï¼Œç”±JSæ§åˆ¶ */
        }
        
        /* â–¼â–¼â–¼ ã€é®ç½©ç»ˆæä¿®å¤ã€‘è¯·ç”¨è¿™æ•´å—å…¨æ–°çš„CSSï¼Œæ›¿æ¢æ‰æ‚¨æ—§çš„ #gomoku-content-wrapper æ ·å¼ â–¼â–¼â–¼ */
        
        /* 2. æ£‹ç›˜çš„å†…éƒ¨åŒ…è£…å™¨ (è´Ÿè´£å¤–è§‚å’Œå†…å®¹å¸ƒå±€) */
        #gomoku-content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* ã€æ ¸å¿ƒã€‘ç§»é™¤æ‰€æœ‰èƒŒæ™¯å’Œæ•ˆæœï¼Œä½¿å…¶å®Œå…¨é€æ˜ */
            background-color: transparent !important;
            backdrop-filter: none !important;
            box-shadow: none !important;
            /* --- å…¶ä»–å¸ƒå±€æ ·å¼ä¿æŒä¸å˜ --- */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            box-sizing: border-box;
            transition: transform 0.3s ease-out;
            transform: translateY(-100%);
            pointer-events: auto;
        }
        
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        
        #phone-screen.dark-mode #gomoku-content-wrapper {
            background-color: rgba(28, 28, 30, 0.9);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        /* å½“æ£‹ç›˜å¯è§æ—¶ï¼Œå°†å†…éƒ¨åŒ…è£…å™¨æ»‘å…¥è§†å›¾ */
        #gomoku-overlay.visible #gomoku-content-wrapper {
            transform: translateY(0);
        }
        
        /* 3. èŠå¤©æ¶ˆæ¯åŒº (ä¿æŒä¸å˜) */
        #chat-messages {
            transition: padding-top 0.3s ease-out;
        }
        
        /* 4. æ£‹ç›˜ç”»å¸ƒå’Œæ§åˆ¶æŒ‰é’® (ä¿æŒä¸å˜) */
        #gomoku-board {
            background-color: #e4b591;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            cursor: pointer;
        }
        
        #gomoku-controls {
            width: 100%;
            text-align: center;
            flex-shrink: 0;
        }
        
        #close-gomoku-btn {
            padding: 6px 15px;
            border-radius: 15px;
            border: 1px solid var(--text-secondary);
            background-color: rgba(255,255,255,0.5);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
        }
        #phone-screen.dark-mode #close-gomoku-btn {
            background-color: rgba(0,0,0,0.2);
            border-color: var(--text-secondary);
        }
        
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€æ£‹ç›˜äº¤äº’ç»ˆæä¿®å¤ã€‘è¯·å°†è¿™æ•´å—CSSç²˜è´´åˆ° <style> çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */
        
        /* 
          ç¬¬ä¸€æ­¥ï¼šã€æ ¸å¿ƒã€‘è®©æ£‹ç›˜çš„å·¨å¤§é€æ˜å®¹å™¨â€œç©¿é€â€æ‰€æœ‰é¼ æ ‡/è§¦æ‘¸ç‚¹å‡»ã€‚
          è¿™æ ·æ‚¨å°±å¯ä»¥ç‚¹å‡»åˆ°å®ƒä¸‹æ–¹çš„èŠå¤©æ¶ˆæ¯äº†ã€‚
        */
        #gomoku-overlay {
            pointer-events: none;
        }
        
        /* 
          ç¬¬äºŒæ­¥ï¼šç°åœ¨ï¼Œæˆ‘ä»¬å¿…é¡»â€œæ¢å¤â€æ£‹ç›˜å’ŒæŒ‰é’®æœ¬èº«çš„å¯ç‚¹å‡»æ€§ã€‚
          æˆ‘ä»¬å°†å®ƒä»¬è®¾ç½®ä¸º autoï¼Œè¿™æ ·å®ƒä»¬å°±åˆèƒ½å“åº”æ‚¨çš„æ“ä½œäº†ã€‚
        */
        #gomoku-board,
        #gomoku-controls {
            pointer-events: auto;
        }
        
        /* --- è¯·ç”¨è¿™æ•´å—ã€æœ€ç»ˆå¸ƒå±€ä¿®å¤ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢ä» #product-grid åˆ° .product-footer çš„æ‰€æœ‰ç›¸å…³æ ·å¼ --- */
        
        #product-grid {
            flex-grow: 1; 
            overflow-y: auto; 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
            padding-bottom: 80px;
            /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘: ç§»é™¤ align-items: startï¼Œæ¢å¤Gridé»˜è®¤çš„æ‹‰ä¼¸å¯¹é½ï¼Œç¡®ä¿å¡ç‰‡ç­‰é«˜ */
        }
        
        .product-item {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            display: flex;         /* ã€æ ¸å¿ƒä¿®æ”¹2ã€‘: å¿…é¡»æ˜¯Flexå®¹å™¨ï¼Œæ‰èƒ½æ§åˆ¶å†…éƒ¨å…ƒç´  */
            flex-direction: column;
        
            cursor: pointer;
            position: relative;
        }
        
        .product-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
        }
        
        /* --- è¯·ç”¨è¿™æ•´å—ã€æœ€ç»ˆç´§å‡‘å¸ƒå±€ç‰ˆã€‘ä»£ç ï¼Œæ›¿æ¢æ—§çš„ .product-info, .product-name, å’Œ .product-footer æ ·å¼ --- */
        
        .product-info {
            padding: 12px 10px;
            flex-grow: 1;      /* ä¿æŒï¼šè®©ä¿¡æ¯åŒºå¡«æ»¡ï¼Œç¡®ä¿æ‰€æœ‰å¡ç‰‡ç­‰é«˜ */
            display: flex;
            flex-direction: column;
        }
        
        .product-name {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
            min-height: 36px;
            /* ç§»é™¤æ‰€æœ‰flex-growå±æ€§ï¼Œè®©å®ƒåªå æ®è‡ªå·±éœ€è¦çš„é«˜åº¦ */
        }
        
        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;      /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šä¸å†ä½¿ç”¨ autoï¼Œè€Œæ˜¯è®¾ç½®ä¸€ä¸ªå›ºå®šçš„ã€è¾ƒå°çš„é¡¶éƒ¨é—´è· */
        }
        
        /* --- æ›¿æ¢ç»“æŸ --- */
        
        
        
        
        
        /* --- æ›¿æ¢ç»“æŸ --- */
        
        .product-price {
            font-size: 16px;
            font-weight: 700;
            color: #ff5722;
        }
        .product-price::before { content: 'Â¥'; font-size: 12px; }
        
        .add-to-cart-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            background: linear-gradient(90deg, #ff9800, #ff5722);
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }
        
        /* --- ç®¡ç†æ¨¡å¼æ ·å¼ (ä¿æŒä¸å˜) --- */
        .product-management-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 5;
        }
        #shopping-screen.management-mode .product-management-overlay {
            display: flex;
        }
        .product-management-overlay button {
            padding: 8px 20px;
            border: 1px solid white;
            background-color: rgba(255,255,255,0.2);
            color: white;
            border-radius: 15px;
            cursor: pointer;
        }
        .product-management-overlay .delete-product-btn {
            border-color: #ff8a80;
            color: #ff8a80;
        }
        #shopping-screen.management-mode .product-footer {
            display: none;
        }
        
        
        /* --- è´­ç‰©è½¦é¡µ (å¾®è°ƒ) --- */
        #cart-title {
            position: static;
            transform: none;
        }
        #cart-items-list { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .cart-item {
            display: flex; align-items: flex-start; gap: 12px; background-color: white;
            padding: 12px; border-radius: 12px;
        }
        .cart-item-checkbox { margin-top: 28px; }
        .cart-item-image { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
        .cart-item-info { flex-grow: 1; display: flex; flex-direction: column; }
        .cart-item-name { font-weight: 500; font-size: 14px; line-height: 1.4; }
        .cart-item-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px;}
        .cart-item-price { color: #ff5722; font-weight: bold; font-size: 16px; }
        .quantity-control { display: flex; align-items: center; gap: 4px; }
        .quantity-btn {
            width: 26px; height: 26px; border: none; background-color: #f7f8fa;
            border-radius: 4px; font-weight: 500; cursor: pointer; color: #666;
        }
        .quantity-display { font-weight: 500; min-width: 30px; text-align: center; }
        
        #cart-footer {
            position: absolute; bottom: 0; left: 0; width: 100%; display: flex;
            justify-content: space-between; align-items: center; padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: white; border-top: 1px solid var(--border-color); box-sizing: border-box;
        }
        #cart-footer .select-all-label { display: flex; align-items: center; gap: 5px; }
        #cart-footer .cart-summary { text-align: right; }
        #cart-footer .cart-subtext { font-size: 11px; color: #999; }
        #checkout-btn {
            padding: 10px 25px; border: none; border-radius: 20px;
            background: linear-gradient(90deg, #ff9800, #ff5722);
            color: white; font-size: 15px; font-weight: 500; cursor: pointer;
        }
        
        /* --- ç¤¼ç‰©å¡ç‰‡ & å°ç¥¨ (æ ·å¼ä¸å˜) --- */
        .gift-card {
            width: 220px; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°† max-width æ”¹ä¸ºå›ºå®šçš„ width */
            box-sizing: border-box; 
            border-radius: 12px; 
            background-color: #fff; 
            border: 1px solid #eee; 
            padding: 12px;
            cursor: pointer; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        .gift-header { display: flex; align-items: center; gap: 8px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .gift-header-icon { width: 20px; height: 20px; color: #ff9800; }
        .gift-header-text { font-size: 15px; font-weight: 600; color: var(--text-primary); }
        .gift-items-preview { padding: 12px 0; display: flex; flex-direction: column; gap: 8px; }
        .gift-preview-item { display: flex; align-items: center; gap: 8px; }
        .gift-preview-img { width: 32px; height: 32px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        .gift-preview-name { flex-grow: 1; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gift-preview-quantity { font-size: 12px; color: var(--text-secondary); }
        .gift-footer { font-size: 12px; color: var(--text-secondary); text-align: right; }
        #gift-receipt-body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 15px; background-color: #f7f8fa; }
        .receipt-header { text-align: center; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
        .receipt-header h3 { margin: 0 0 5px 0; font-size: 20px; }
        .receipt-header p { margin: 0; font-size: 12px; color: #888; }
        .receipt-items-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .receipt-items-table th, .receipt-items-table td { padding: 10px 5px; font-size: 13px; }
        .receipt-items-table thead th { border-bottom: 1px solid #333; text-align: left; }
        .receipt-items-table .item-name { width: 50%; }
        .receipt-items-table .item-qty { text-align: center; }
        .receipt-items-table .item-price, .receipt-items-table .item-subtotal { text-align: right; }
        .receipt-total { padding-top: 15px; border-top: 1px solid #333; text-align: right; font-size: 16px; font-weight: bold; }
        .receipt-footer { text-align: center; margin-top: 25px; font-size: 12px; color: #888; }
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ (å¯é€‰ï¼Œä½†æ¨è) ä¸ºå•†å“ç®¡ç†æ¨¡å¼æ·»åŠ æ–°æ ·å¼ â–¼â–¼â–¼ */
        .product-item {
            position: relative; /* ä¸ºäº†å®šä½é®ç½©å±‚ */
        }
        .product-management-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 5;
        }
        #shopping-screen.management-mode .product-management-overlay {
            display: flex; /* åœ¨ç®¡ç†æ¨¡å¼ä¸‹æ˜¾ç¤º */
        }
        .product-management-overlay button {
            padding: 8px 20px;
            border: 1px solid white;
            background-color: rgba(255,255,255,0.2);
            color: white;
            border-radius: 15px;
            cursor: pointer;
        }
        .product-management-overlay .delete-product-btn {
            border-color: #ff8a80;
            color: #ff8a80;
        }
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œéšè—â€œåŠ å…¥è´­ç‰©è½¦â€æŒ‰é’® */
        #shopping-screen.management-mode .add-to-cart-btn {
            display: none;
        }
        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€æ£€æŸ¥å¹¶æ·»åŠ ã€‘å¡ç‰‡/ç‰¹æ®Šå†…å®¹æ°”æ³¡å¸ƒå±€è§„åˆ™ â–¼â–¼â–¼ */
        .message-bubble.is-card-like {
            flex: initial; /* è¦†ç›–é€šç”¨çš„ flex: 1ï¼Œè®©æ°”æ³¡æœ¬èº«ä¸å†æ‹‰ä¼¸ */
            min-width: auto; /* å…è®¸å…¶è‡ªç”±æ”¶ç¼© */
        }
        .message-bubble.is-card-like .content {
            flex: initial; 
            padding: 0;
            background: transparent;
        }
        /* â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¿®å¤è´­ç‰©è½¦å›¾æ ‡å¯¹é½é—®é¢˜ â–¼â–¼â–¼ */
        #go-to-cart-btn {
            display: flex;
            align-items: center; /* æ ¸å¿ƒï¼šå‚ç›´å±…ä¸­å¯¹é½ */
            gap: 4px; /* åœ¨å›¾æ ‡å’Œæ•°å­—ä¹‹é—´å¢åŠ ä¸€ç‚¹é—´è· */
        }
        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºç¤¼ç‰©æ¥æ”¶äººåˆ—è¡¨æ·»åŠ æ ·å¼ â–¼â–¼â–¼ */
        #gift-recipient-list .contact-picker-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        #gift-recipient-list .contact-picker-item:last-child {
            border-bottom: none;
        }
        #gift-recipient-list .contact-picker-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 15px;
            transition: all 0.2s ease;
        }
        #gift-recipient-list .contact-picker-item.selected .checkbox {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        #gift-recipient-list .contact-picker-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        #gift-recipient-list .contact-picker-item .name {
            font-weight: 500;
        }
        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ­Œè¯æ æ›¿æ¢å¿ƒç‡æ˜¾ç¤ºå™¨æ ·å¼ (æœ€ç»ˆç‰ˆ) â–¼â–¼â–¼ */
        
        /* 1. å½»åº•éšè—æ—§çš„å¿ƒç‡æ˜¾ç¤ºå™¨ï¼Œä¸å†éœ€è¦å®ƒäº† */
        #ai-heart-rate-display {
            display: none !important;
        }
        
        /* 2. ä¸ºæ­Œè¯æ åº”ç”¨æ–°çš„æ ·å¼ï¼Œä½¿å…¶å¤–è§‚å’Œå®šä½ä¸åŸå¿ƒç‡æ˜¾ç¤ºå™¨å®Œå…¨ä¸€è‡´ */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ­Œè¯æ ä½ç½®æ§åˆ¶æ ·å¼ â–¼â–¼â–¼ */
        #global-lyrics-bar {
            /* æ ¸å¿ƒå®šä½ï¼šç»å¯¹å®šä½ */
            position: absolute;
            z-index: 20;
        
            /* å¤–è§‚æ ·å¼ (ä¿æŒä¸å˜) */
            display: flex;
            align-items: center;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            background-color: rgba(0, 0, 0, 0.05);
            padding: 4px 12px;
            border-radius: 12px;
            
            /* åŠ¨ç”»æ•ˆæœ (ä¿æŒä¸å˜) */
            opacity: 0;
            visibility: hidden;
            /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºä½ç½®å±æ€§æ·»åŠ å¹³æ»‘è¿‡æ¸¡ */
            transition: opacity 0.4s ease, visibility 0.4s ease, top 0.3s ease, bottom 0.3s ease, left 0.3s ease, right 0.3s ease, transform 0.3s ease;
        
            /* é™„åŠ æ ·å¼ (ä¿æŒä¸å˜) */
            pointer-events: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 65%;
        }
        
        #phone-screen.dark-mode #global-lyrics-bar {
            color: #a0a0a0;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* 3. å½“JSæ·»åŠ .visibleç±»æ—¶ï¼Œæ˜¾ç¤ºæ­Œè¯æ  */
        #global-lyrics-bar.visible {
            opacity: 1;
            visibility: visible;
        }
        
        /* 4. é€‚é…å¤œé—´æ¨¡å¼ */
        #phone-screen.dark-mode #global-lyrics-bar {
            color: #a0a0a0;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦é¡µé¢ç¾åŒ–æ ·å¼ (V2 - é¡µç­¾åˆ‡æ¢ç‰ˆ) â–¼â–¼â–¼ */
        
        /* 1. ç¡®ä¿ä¸–ç•Œä¹¦é¡µé¢èƒŒæ™¯è‰²ç»Ÿä¸€ */
        #world-book-screen {
            background-color: #f0f2f5;
            display: flex; /* æ”¹ä¸ºflexå¸ƒå±€ï¼Œè®©å¤´éƒ¨ã€é¡µç­¾ã€å†…å®¹åŒºå‚ç›´æ’åˆ— */
            flex-direction: column;
        }
        
        #phone-screen.dark-mode #world-book-screen {
            background-color: #000000;
        }
        
        /* 2. é¡µç­¾æ æ ·å¼ */
        #world-book-tabs {
            display: flex;
            overflow-x: auto; /* å¦‚æœåˆ†ç±»å¤ªå¤šï¼Œå¯ä»¥æ¨ªå‘æ»šåŠ¨ */
            padding: 10px 15px 0 15px;
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
        
            /* éšè—æ»šåŠ¨æ¡ */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #world-book-tabs::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        
        
        /* 3. å•ä¸ªé¡µç­¾æŒ‰é’®æ ·å¼ */
        .world-book-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px; /* è®©åº•è¾¹æ¡†ä¸å®¹å™¨è¾¹æ¡†é‡åˆ */
            transition: all 0.2s ease-in-out;
            white-space: nowrap; /* é˜²æ­¢åˆ†ç±»åæ¢è¡Œ */
        }
        
        /* 4. æ¿€æ´»çš„é¡µç­¾æ ·å¼ */
        .world-book-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
        }
        #phone-screen.dark-mode .world-book-tab.active {
            color: #ffffff;
        }
        
        
        /* 5. å†…å®¹åŒºæ€»å®¹å™¨ï¼Œè´Ÿè´£æ»šåŠ¨ */
        #world-book-content-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        /* 6. å•ä¸ªåˆ†ç±»çš„å†…å®¹é¢æ¿ï¼Œä½¿ç”¨Gridå¸ƒå±€ç¾åŒ– */
        .world-book-category-pane {
            display: none; /* é»˜è®¤éšè— */
            grid-template-columns: repeat(2, 1fr); /* æ¯è¡Œæ˜¾ç¤º2æœ¬ä¹¦ */
            gap: 15px;
            padding: 15px;
        }
        
        /* 7. æ¿€æ´»çš„å†…å®¹é¢æ¿ */
        .world-book-category-pane.active {
            display: grid;
        }
        

/* 8. ç¾åŒ–åçš„ä¸–ç•Œä¹¦å¡ç‰‡æ ·å¼ (æœ€ç»ˆä¿®å¤ç‰ˆ) */
.world-book-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 8px;
    
    /* æ ¸å¿ƒä¿®å¤ 1: å…è®¸å¡ç‰‡åœ¨ç½‘æ ¼å¸ƒå±€ä¸­æ­£ç¡®åœ°æ”¶ç¼©ï¼Œè¿™æ˜¯è§£å†³é—®é¢˜çš„å…³é”® */
    min-width: 0;

    /* æ ¸å¿ƒä¿®å¤ 2: å¼ºåˆ¶å¯¹æ‰€æœ‰å†…å®¹ï¼ˆåŒ…æ‹¬ä¸­è‹±æ–‡ï¼‰è¿›è¡Œæ¢è¡Œï¼Œä½œä¸ºåŒé‡ä¿é™© */
    word-break: break-all;
}
        
        .world-book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        }
        #phone-screen.dark-mode .world-book-card {
            box-shadow: 0 2px 8px rgba(255,255,255,0.05);
        }
        
        .world-book-card .card-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* é˜²æ­¢é•¿æ ‡é¢˜æº¢å‡º */
        }
        
        .world-book-card .card-content-preview {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            /* å¤šè¡Œçœç•¥æ•ˆæœ */
            display: -webkit-box;
            -webkit-line-clamp: 3; /* æœ€å¤šæ˜¾ç¤º3è¡Œ */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¸²æŸ“å™¨é¡µé¢ç¾åŒ–æ ·å¼ (V2 - é¡µç­¾åˆ‡æ¢ç‰ˆ) â–¼â–¼â–¼ */
        
        /* 1. ç¡®ä¿æ¸²æŸ“å™¨é¡µé¢èƒŒæ™¯è‰²ç»Ÿä¸€ */
        #rendering-rules-screen {
            background-color: #f0f2f5;
            display: flex; /* æ”¹ä¸ºflexå¸ƒå±€ï¼Œè®©å…ƒç´ å‚ç›´æ’åˆ— */
            flex-direction: column;
        }
        
        #phone-screen.dark-mode #rendering-rules-screen {
            background-color: #000000;
        }
        
        /* 2. é¡µç­¾æ æ ·å¼ (ä»¿ä¸–ç•Œä¹¦) */
        #rules-tabs {
            display: flex;
            overflow-x: auto;
            padding: 10px 15px 0 15px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #rules-tabs::-webkit-scrollbar {
            display: none;
        }
        
        /* 3. å•ä¸ªé¡µç­¾æŒ‰é’®æ ·å¼ */
        .rules-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        
        /* 4. æ¿€æ´»çš„é¡µç­¾æ ·å¼ */
        .rules-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
        }
        #phone-screen.dark-mode .rules-tab.active {
            color: #ffffff;
        }
        
        /* 5. å†…å®¹åŒºæ€»å®¹å™¨ */
        #rules-content-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        /* 6. å•ä¸ªåˆ†ç±»çš„å†…å®¹é¢æ¿ (Gridå¸ƒå±€) */
        .rules-category-pane {
            display: none; /* é»˜è®¤éšè— */
            grid-template-columns: repeat(2, 1fr); /* æ¯è¡Œæ˜¾ç¤º2ä¸ª */
            gap: 15px;
            padding: 15px;
        }
        
        .rules-category-pane.active {
            display: grid;
        }
        
        /* 7. ç¾åŒ–åçš„è§„åˆ™å¡ç‰‡æ ·å¼ */
        .rule-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 8px; /* æ ‡é¢˜å’Œå†…å®¹çš„é—´è· */
            border-left: 5px solid #6c757d; /* é»˜è®¤ç»™ä¸€ä¸ªç°è‰²è¾¹æ¡† */
        }
        .rule-card.enabled {
            border-left-color: #28a745; /* å¯ç”¨çš„è§„åˆ™ç”¨ç»¿è‰²è¾¹æ¡† */
        }
        
        .rule-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        }
        #phone-screen.dark-mode .rule-card {
            box-shadow: 0 2px 8px rgba(255,255,255,0.05);
        }
        
        .rule-card .card-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .rule-card .card-content-preview {
            font-size: 12px;
            font-family: monospace; /* ä½¿ç”¨ç­‰å®½å­—ä½“ï¼Œæ˜¾ç¤ºæ­£åˆ™æ›´æ¸…æ™° */
            color: var(--text-secondary);
            background-color: #f0f2f5;
            padding: 5px 8px;
            border-radius: 4px;
            word-break: break-all;
        }
        #phone-screen.dark-mode .rule-card .card-content-preview {
            background-color: #2c2c2e;
        }
        
        /* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

        /* â–¼â–¼â–¼ ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘é‡æ–°ç”Ÿæˆå›å¤æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */
        .control-btn.regenerate-btn {
            /* æ ¸å¿ƒä¿®æ”¹ï¼šå°†èƒŒæ™¯è‰²æ”¹ä¸ºä¸å…¶ä»–åŠŸèƒ½æŒ‰é’®ä¸€è‡´çš„åŠé€æ˜ç°è‰² */
            background-color: rgba(255, 255, 255, 0.2);
            background-size: 55%; /* å›¾æ ‡å¤§å°ä¿æŒä¸å˜ */
            /* SVGå›¾æ ‡ä¿æŒä¸å˜ï¼Œä¾ç„¶æ˜¯æˆ‘ä»¬çš„åˆ·æ–°å›¾æ ‡ */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"/><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/></svg>');
        }
        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¨è¿›å‰§æƒ…æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */
        .control-btn.propel-btn {
            background-color: rgba(255, 255, 255, 0.2);
            background-size: 55%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>');
        }
        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯è§£å†³HTMLä»£ç è¢«æ°”æ³¡æ ·å¼â€œå‹ç¼©â€çš„æ ¸å¿ƒCSS â–¼â–¼â–¼ */

/* å½“ä¸€ä¸ªæ¶ˆæ¯æ°”æ³¡è¢«æ ‡è®°ä¸º is-raw-html æ—¶ */
.message-bubble.is-raw-html .content {
    padding: 0 !important; /* å¼ºåˆ¶ç§»é™¤æ‰€æœ‰å†…è¾¹è· */
    background: transparent !important; /* å¼ºåˆ¶èƒŒæ™¯é€æ˜ */
    border: none !important; /* å¼ºåˆ¶ç§»é™¤è¾¹æ¡† */
    box-shadow: none !important; /* å¼ºåˆ¶ç§»é™¤é˜´å½± */
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é˜²æ­¢é•¿æŒ‰æ—¶è§¦å‘è“è‰²æ–‡æœ¬é€‰ä¸­ â–¼â–¼â–¼ */

#phone-screen {
    /* æ ¸å¿ƒå±æ€§ï¼Œé€‚ç”¨äºå¤§å¤šæ•°ç°ä»£æµè§ˆå™¨ */
    user-select: none;

    /* å…¼å®¹æ—§ç‰ˆ Safari, iOS Safari, Chrome */
    -webkit-user-select: none;

    /* å…¼å®¹æ—§ç‰ˆ Firefox */
    -moz-user-select: none;

    /* å…¼å®¹ Internet Explorer/Edge */
    -ms-user-select: none;

    /* é˜²æ­¢åœ¨ iOS ä¸Šé•¿æŒ‰é“¾æ¥ã€å›¾ç‰‡æ—¶å¼¹å‡ºèœå• */
    -webkit-touch-callout: none;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æ­¥éª¤ 2ï¼šç”¨è¿™æ•´å—æ–°ä»£ç ï¼Œæ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ä¸»å±å¹•å’Œä¸ªäººèµ„æ–™ç›¸å…³CSS â–¼â–¼â–¼ */

/* --- 1. éšè—æ‰€æœ‰æ—§çš„ä¸»å±å¹•å…ƒç´  --- */
#home-screen #clock-container,
#home-screen #app-grid,
#home-screen #home-widgets-container {
    display: none !important;
}

/* --- 2. ã€æœ€ç»ˆä¿®å¤ã€‘é‡æ–°å®šä¹‰ä¸»å±å¹•å¸ƒå±€ --- */

#home-screen {
    background: linear-gradient(135deg, #6DD5FA, #2980B9);
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šæ·»åŠ ä¸‹é¢è¿™ä¸¤è¡Œ â–¼â–¼â–¼ */
    background-size: cover;
    background-position: center;
    /* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top));
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: space-between; 
    align-items: center;
    height: 100%;
}

/* --- æ›¿æ¢è¿™ä¸€æ•´å—ä»£ç  --- */
/* â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—æ–°ä»£ç æ›¿æ¢æ—§çš„ #main-content-area æ ·å¼ â–¼â–¼â–¼ */

#main-content-area {
    width: 100%;
    display: flex;
    flex-direction: column;
    /* æ ¸å¿ƒä¿®æ”¹1ï¼šå°†å¡ç‰‡å’Œä¸‹æ–¹å›¾æ ‡çš„é—´è·ä»60pxç¼©å°åˆ°30px */
    gap: 30px; 
    align-items: center;
    /* æ ¸å¿ƒä¿®æ”¹2ï¼šå°†é¡¶éƒ¨çš„å¤–è¾¹è·ä»40pxç¼©å°åˆ°20pxï¼Œç»™å±å¹•é¡¶éƒ¨ç•™å‡ºä¸€ç‚¹å‘¼å¸ç©ºé—´å³å¯ */
    margin-top: 20px; 
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€æœ€ç»ˆè§£å†³æ–¹æ¡ˆã€‘è¯·ç”¨è¿™ä¸€æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰€æœ‰æ—§çš„ä¸ªäººèµ„æ–™å¡ç‰‡ç›¸å…³CSS â–¼â–¼â–¼ */

/* 1. å¡ç‰‡å¤–å±‚å®¹å™¨ï¼šè¿™æ˜¯æ‰€æœ‰å†…éƒ¨å…ƒç´ å®šä½çš„â€œé”šç‚¹â€ */
#profile-widget {
    position: relative; /* å…³é”®ï¼šè®©å†…éƒ¨çš„å¤´åƒå’Œä¼ªå…ƒç´ å¯ä»¥ç›¸å¯¹äºå®ƒè¿›è¡Œç»å¯¹å®šä½ */
    width: 100%;
    max-width: 380px;
    flex-shrink: 0;
}

/* 2. èƒŒæ™¯å¤´å›¾ï¼šåªç»™é¡¶éƒ¨è®¾ç½®åœ†è§’ */
#profile-banner-img {
    display: block; 
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 24px 24px 0 0; /* åªç»™é¡¶éƒ¨è®¾ç½®åœ†è§’ */
    position: relative;
    z-index: 1; /* è®©å¤´å›¾åœ¨ä¸‹æ–¹ */
}

/* 3. å¤´åƒå®¹å™¨ï¼šç²¾ç¡®å®šä½ï¼Œä½¿å…¶ä¸­å¿ƒçº¿ä¸å¤´å›¾åº•éƒ¨å¯¹é½ */
#profile-widget .profile-avatar-container {
    position: absolute;
    top: 80px; 
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: white; 
    padding: 4px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 3; /* å¤´åƒå±‚çº§æœ€é«˜ï¼Œå‹ä½ä¸€åˆ‡ */
}

#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* 4. ç™½è‰²ä¿¡æ¯å¡ç‰‡ï¼šä½¿ç”¨è´Ÿå¤–è¾¹è·å®ç°æ— ç¼æ‹¼æ¥ */
#profile-widget .profile-info {
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 24px;
    
    /* --- â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜… --- */
    
    /* 1. ä½¿ç”¨è´Ÿå¤–è¾¹è·ï¼Œå°†å¡ç‰‡å‘ä¸Šç§»åŠ¨24pxï¼ˆç­‰äºå…¶åœ†è§’åŠå¾„ï¼‰ */
    margin-top: -24px; 
    
    /* 2. ä¸ºå¤´åƒçš„ä¸‹åŠéƒ¨åˆ†å’Œä¸Šæ–¹çš„è´Ÿè¾¹è·ï¼Œå…±åŒç•™å‡ºç²¾ç¡®çš„ç©ºé—´ */
    /* 40px (å¤´åƒåŠå¾„) + 10px (é¢å¤–é—´è·) + 24px (æŠµæ¶ˆè´Ÿè¾¹è·) = 74px */
    padding-top: 44px; 
    
    /* --- â˜…â˜…â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…â˜…â˜… --- */
    
    min-height: 120px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding-left: 15px;
    padding-right: 15px;
    padding-bottom: 15px;
    text-align: center;
    color: #1c1c1e;
    position: relative;
    z-index: 2; /* è®©ä¿¡æ¯å¡åœ¨å¤´å›¾ä¹‹ä¸Šï¼Œä½†åœ¨å¤´åƒä¹‹ä¸‹ */
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* 5. å¼ºåˆ¶ç¦ç”¨ä»»ä½•å¯èƒ½æ®‹ç•™çš„æ—§ä¼ªå…ƒç´ æ ·å¼ */
#profile-widget::before {
    display: none !important;
}

/* (è¿™ä¸ªæ˜¯å¤´åƒå›¾ç‰‡æœ¬èº«çš„æ ·å¼ï¼Œä¿æŒä¸å˜) */
#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* 5. å¼ºåˆ¶ç¦ç”¨ä»»ä½•å¯èƒ½æ®‹ç•™çš„æ—§ä¼ªå…ƒç´ æ ·å¼ */
#profile-widget::before {
    display: none !important;
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* (è¿™ä¸ªæ˜¯å¤´åƒå›¾ç‰‡æœ¬èº«çš„æ ·å¼ï¼Œä¿æŒä¸å˜) */
#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */



/* (ä»¥ä¸‹ä¸ºä¸ªäººèµ„æ–™å†…éƒ¨æ–‡å­—æ ·å¼ï¼Œä¿æŒä¸å˜) */
#profile-username { font-size: 18px; font-weight: 600; margin: 0 0 2px 0; }
#profile-sub-username { font-size: 13px; color: #8a8a8a; margin: 0 0 10px 0; }
#profile-bio { font-size: 14px; margin: 0 0 12px 0; color: #333; }
#profile-location {
    font-size: 12px; color: #8a8a8a; margin: 0 auto; display: inline-flex;
    align-items: center; gap: 4px; background-color: rgba(0,0,0,0.05);
    padding: 3px 9px; border-radius: 10px;
}

/* --- (ä»è¿™é‡Œå¼€å§‹ï¼Œåé¢çš„æ‰€æœ‰æ ·å¼éƒ½ä¿æŒä¸å˜å³å¯) --- */
#desktop-layout {
    display: grid;
    grid-template-columns: 1fr 1.1fr;
    gap: 20px;
    width: 100%;
    align-items: start;
}
#desktop-widget-column {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.widget-header {
    font-size: 14px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.8);
    margin: 0 0 5px 5px;
}
.desktop-widget {
    background-color: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 18px;
    padding: 12px 15px;
    /* æ ¸å¿ƒä¿®æ”¹ï¼šå°†é¢œè‰²ä» white æ”¹ä¸ºæ¥è¿‘é»‘è‰²çš„æ·±ç°è‰² */
    color: #1f1f1f; 
    font-weight: 500;
    font-size: 13px;
    display: flex;
    align-items: center;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ç§»é™¤ç¬¬ä¸€ä¸ªå°ç»„ä»¶èƒŒæ™¯æ¡†çš„æ ·å¼ â–¼â–¼â–¼ */

.desktop-widget.text-only {
    background-color: transparent; /* å°†èƒŒæ™¯è‰²è®¾ä¸ºé€æ˜ */
    border: none;                  /* ç§»é™¤è¾¹æ¡† */
    padding: 0;                    /* ç§»é™¤å†…è¾¹è·ï¼Œé¿å…å¤šä½™çš„ç©ºç™½ */
    box-shadow: none;              /* ç¡®ä¿æ²¡æœ‰é˜´å½± */
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
.desktop-widget.icon-left { justify-content: flex-start; gap: 10px; }
/* This is the NEW code */
.desktop-widget.icon-right {
    justify-content: flex-end; /* Pushes both items to the right */
    gap: 10px;                 /* Adds a nice space between the text and the avatar */
}
.desktop-widget img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
.desktop-widget p, .desktop-widget span { margin: 0; }
#desktop-app-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    align-content: start;
}
#desktop-dock {
    background-color: rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 15px 25px;
    display: flex;
    justify-content: center;
    gap: 30px;
    width: fit-content;
    flex-shrink: 0;
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ â–¼â–¼â–¼ */
    /* æˆ‘ä»¬ä¸ºDockæ å¢åŠ ä¸€ä¸ªåº•éƒ¨å¤–è¾¹è·ï¼Œ
       è¿™ä¸ªè¾¹è·ç”±20pxçš„åŸºç¡€é—´è·å’Œåº•éƒ¨çš„å®‰å…¨è·ç¦»ç»„æˆï¼Œ
       èƒ½å°†å®ƒä»å±å¹•åº•éƒ¨å®Œç¾åœ°æŠ¬èµ·ã€‚ */
    margin-bottom: calc(20px + env(safe-area-inset-bottom));
}
.desktop-app-icon {
    display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; text-align: center;
}
.icon-bg-desktop {
    width: 55px; height: 55px; border-radius: 14px; background-color: #f0f2f5; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s ease; overflow: hidden;
}
.icon-bg-desktop img {
    width: 100%; height: 100%; object-fit: cover; border-radius: 0;
}
.desktop-app-icon .label {
    color: #333; font-size: 13px; font-weight: 500;
}
.desktop-app-icon:active .icon-bg-desktop {
    transform: scale(0.9);
}
.editable-text:hover, .editable-image:hover {
    outline: 2px dashed rgba(255, 255, 255, 0.8);
    cursor: pointer;
    opacity: 0.9;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºå°ç»„ä»¶ç¼–è¾‘åŠŸèƒ½æ·»åŠ çš„æ ·å¼ â–¼â–¼â–¼ */

/* ä¸ºå¯ç¼–è¾‘çš„å…ƒç´ æ·»åŠ å¯ç‚¹å‡»çš„å…‰æ ‡å’Œè¿‡æ¸¡æ•ˆæœ */
.editable-text, .editable-image {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

/* é¼ æ ‡æ‚¬åœæ—¶ï¼Œæ˜¾ç¤ºä¸€ä¸ªåŠé€æ˜çš„è™šçº¿å¤–æ¡†ï¼Œå¹¶è½»å¾®å˜æš—ï¼Œæä¾›è§†è§‰åé¦ˆ */
.editable-text:hover, .editable-image:hover {
    outline: 2px dashed rgba(255, 255, 255, 0.8);
    opacity: 0.9;
    border-radius: 4px; /* è®©å¤–æ¡†ä¹Ÿæœ‰ä¸€ç‚¹åœ†è§’ */
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€æ–¹æ¡ˆAï¼šä»…èƒŒæ™¯æ¸å˜ï¼Œæ–‡å­—ä¿æŒå®ä½“ã€‘(å¯èƒ½å¯¼è‡´åº•éƒ¨æ–‡å­—å¯è¯»æ€§ä¸‹é™) â–¼â–¼â–¼ */

#profile-widget .profile-info {
    /* 1. å°†å¡ç‰‡æœ¬èº«çš„èƒŒæ™¯è®¾ä¸ºé€æ˜ */
    background: transparent !important;
    /* 2. å»ºç«‹å®šä½ä¸Šä¸‹æ–‡ï¼Œè®©ä¼ªå…ƒç´ å¯ä»¥ç›¸å¯¹äºå®ƒå®šä½ */
    position: relative;
    z-index: 1; /* ç¡®ä¿æ–‡å­—å†…å®¹åœ¨èƒŒæ™¯ä¹‹ä¸Š */
}

#profile-widget .profile-info::before {
    /* 3. åˆ›å»ºä¸€ä¸ªä¼ªå…ƒç´ ä½œä¸ºæ–°çš„èƒŒæ™¯å±‚ */
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    
    /* 4. å°†åŸæœ¬çš„ç™½è‰²èƒŒæ™¯å’Œåœ†è§’åº”ç”¨åˆ°è¿™ä¸ªèƒŒæ™¯å±‚ä¸Š */
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 24px;
    
    /* 5. ã€æ ¸å¿ƒã€‘åªå¯¹è¿™ä¸ªèƒŒæ™¯å±‚åº”ç”¨æ¸å˜æ¶ˆå¤±æ•ˆæœ */
    mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
    
    /* 6. å°†èƒŒæ™¯å±‚æ”¾åˆ°æ–‡å­—å†…å®¹çš„åé¢ */
    z-index: -1;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è®¾ç½®é¡µé¢æ ·å¼ â–¼â–¼â–¼ */
#chat-settings-screen {
    /* ç¡®ä¿é¡µé¢æ˜¯ Flex å®¹å™¨ï¼Œè®©å†…å®¹åŒºå¯ä»¥æ­£ç¡®åœ°æ‹‰ä¼¸ */
    display: flex;
    flex-direction: column;
    background-color: #f0f2f5; /* ä¸å…¶ä»–è®¾ç½®é¡µä¿æŒä¸€è‡´çš„èƒŒæ™¯è‰² */
}

#phone-screen.dark-mode #chat-settings-screen {
     background-color: #000000; /* å¤œé—´æ¨¡å¼èƒŒæ™¯ */
}

#chat-settings-screen .form-container {
    flex-grow: 1;      /* æ ¸å¿ƒï¼šè®©å†…å®¹åŒºå æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
    overflow-y: auto;  /* æ ¸å¿ƒï¼šç¡®ä¿å†…å®¹è¿‡é•¿æ—¶å¯ä»¥æ»šåŠ¨ */
    padding-top: 100px;  /* ä¸ºæµ®åŠ¨çš„ Header ç•™å‡ºè¶³å¤Ÿçš„é¡¶éƒ¨ç©ºé—´ */
    margin-top: -80px;   /* å°†å†…å®¹åŒºå‘ä¸Šæ‹‰ï¼Œä½¿å…¶å¯ä»¥æ»šåŠ¨åˆ° Header ä¸‹æ–¹ */
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢ç»“æœå¼¹çª—æ ·å¼ â–¼â–¼â–¼ */

.search-result-item {
    display: flex;
    flex-direction: column;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}

.search-result-item:hover {
    background-color: rgba(0, 0, 0, 0.1);
}

#phone-screen.dark-mode .search-result-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.search-result-item .title {
    font-weight: 500;
    font-size: 15px;
    color: var(--text-primary);
}

.search-result-item .artist {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.search-result-item .source {
    font-size: 10px;
    color: var(--accent-color);
    background-color: rgba(0, 123, 255, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    margin-left: 8px;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘éŸ³ä¹æ’­æ”¾å™¨ä¸“è¾‘å°é¢æ ·å¼ â–¼â–¼â–¼ */
#music-player-cover {
    width: 180px;
    height: 180px;
    border-radius: 15px;
    object-fit: cover;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    margin-bottom: 25px; /* åœ¨å°é¢å’Œæ ‡é¢˜ä¹‹é—´å¢åŠ é—´è· */
    transition: opacity 0.5s ease-in-out; /* è®©å›¾ç‰‡åˆ‡æ¢æ—¶æœ‰æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä»¿ç½‘æ˜“äº‘å”±ç‰‡/æ­Œè¯åˆ‡æ¢æ ·å¼ â–¼â–¼â–¼ */

/* 1. åˆ‡æ¢çš„æ€»å®¹å™¨ï¼Œè´Ÿè´£å®šä½å’Œå¤§å° */
#music-visual-container {
    position: relative;
    width: 220px;
    height: 220px;
    margin-bottom: 25px;
    cursor: pointer;
}

/* 2. å”±ç‰‡å’Œæ­Œè¯è§†å›¾çš„é€šç”¨æ ·å¼ï¼Œè®©å®ƒä»¬é‡å åœ¨ä¸€èµ· */
#vinyl-view, #inline-lyrics-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    /* æ ¸å¿ƒï¼šä¸ºåˆ‡æ¢æ•ˆæœæ·»åŠ å¹³æ»‘çš„è¿‡æ¸¡åŠ¨ç”» */
    transition: opacity 0.5s ease, transform 0.5s ease;
}

/* 3. é»‘èƒ¶å”±ç‰‡è§†å›¾çš„ä¸“å±æ ·å¼ */
#vinyl-view {
    background-color: #222;
    border-radius: 50%;
    padding: 18px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3), 
                inset 0 0 0 2px rgba(255, 255, 255, 0.05);
    background-image: repeating-radial-gradient(circle, #333, #333 1px, #222 1px, #222 2px);
    box-sizing: border-box;
}
#vinyl-view #music-player-cover {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    margin: 0; /* ç§»é™¤æ—§çš„å¤–è¾¹è· */
}

/* 4. å†…è”æ­Œè¯è§†å›¾çš„ä¸“å±æ ·å¼ */
#inline-lyrics-view {
    /* é»˜è®¤çŠ¶æ€ï¼šå®Œå…¨é€æ˜ï¼Œè½»å¾®æ”¾å¤§ï¼Œä¸”ä¸å¯ç‚¹å‡» */
    opacity: 0;
    transform: scale(1.1);
    pointer-events: none;
    padding: 10px;
    box-sizing: border-box;
}

/* 5. ã€æ ¸å¿ƒã€‘åˆ‡æ¢é€»è¾‘ */
/* å½“å®¹å™¨æ‹¥æœ‰ .lyrics-active ç±»æ—¶... */
#music-visual-container.lyrics-active #vinyl-view {
    /* ...å”±ç‰‡è§†å›¾æ¶ˆå¤± */
    opacity: 0;
    transform: scale(0.9);
}
#music-visual-container.lyrics-active #inline-lyrics-view {
    /* ...æ­Œè¯è§†å›¾å‡ºç° */
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
}

/* 6. æ­Œè¯å®¹å™¨çš„æ ·å¼ (ä¸ä¹‹å‰ç±»ä¼¼ï¼Œä½†æœ‰å¾®è°ƒ) */
#inline-lyrics-view #music-lyrics-container {
    width: 100%;
    height: 100%;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é¡¶éƒ¨æ­Œæ›²ä¿¡æ¯åŒºåŸŸæ ·å¼ â–¼â–¼â–¼ */

/* 1. æ–°çš„é¡¶éƒ¨ä¿¡æ¯å®¹å™¨ */
#music-info-top {
    text-align: center; /* è®©æ‰€æœ‰æ–‡å­—å±…ä¸­ */
    flex-shrink: 0;
    margin-bottom: 20px; /* åœ¨ä¿¡æ¯å’Œå”±ç‰‡ä¹‹é—´å¢åŠ ä¸€äº›é—´è· */
}

/* 2. ç§»é™¤æ—§çš„ã€å¤šä½™çš„è¾¹è·ï¼Œé¿å…åŒé‡é—´è· */
#music-player-song-title,
#music-player-artist,
#music-time-counter {
    margin-bottom: 5px; /* ç»Ÿä¸€è®¾ç½®ä¸€ä¸ªè¾ƒå°çš„è¡Œé—´è· */
}

/* 3. è°ƒæ•´å”±ç‰‡å®¹å™¨çš„å¤–è¾¹è· */
#music-visual-container {
    margin-bottom: 15px; /* é€‚å½“å‡å°å”±ç‰‡å’Œè¿›åº¦æ¡çš„è·ç¦» */
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é»‘èƒ¶å”±ç‰‡æ—‹è½¬åŠ¨ç”» â–¼â–¼â–¼ */

/* 1. å®šä¹‰ä¸€ä¸ªåä¸º "spin-vinyl" çš„æ—‹è½¬åŠ¨ç”» */
@keyframes spin-vinyl {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* 2. åˆ›å»ºä¸€ä¸ª .spinning ç±»ï¼Œåº”ç”¨è¿™ä¸ªåŠ¨ç”» */
/*    æˆ‘ä»¬å¸Œæœ›å®ƒæ— é™ã€åŒ€é€Ÿåœ°æ—‹è½¬ */
#vinyl-view.spinning {
  animation: spin-vinyl 12s linear infinite;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å•è¡Œæ­Œè¯æ˜¾ç¤ºæ ·å¼ â–¼â–¼â–¼ */

#single-lyric-display {
    /* 1. å°ºå¯¸ä¸å®šä½ */
    height: 40px;          /* ç»™ä¸€ä¸ªå›ºå®šçš„é«˜åº¦ï¼Œé˜²æ­¢æ–‡å­—æ¢è¡Œæ—¶å¸ƒå±€è·³åŠ¨ */
    line-height: 40px;     /* å‚ç›´å±…ä¸­ */
    width: 100%;           /* å®½åº¦æ’‘æ»¡ */
    margin-top: 15px;      /* å’Œä¸Šæ–¹çš„å”±ç‰‡æ‹‰å¼€ä¸€äº›è·ç¦» */
    
    /* 2. æ–‡å­—å¤–è§‚ */
    text-align: center;    /* æ–‡å­—å±…ä¸­ */
    font-size: 14px;       /* å­—ä½“å¤§å° */
    color: #333;           /* å­—ä½“é¢œè‰² */
    font-weight: 500;      /* å­—ä½“ç¨å¾®åŠ ç²—ä¸€ç‚¹ */

    /* 3. æ•ˆæœä¸åŠ¨ç”» */
    transition: opacity 0.3s ease; /* è®©æ–‡å­—åˆ‡æ¢æ—¶æœ‰æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
    white-space: nowrap;           /* å¼ºåˆ¶ä¸æ¢è¡Œ */
    overflow: hidden;              /* è¶…å‡ºéƒ¨åˆ†éšè— */
    text-overflow: ellipsis;       /* è¶…å‡ºéƒ¨åˆ†æ˜¾ç¤ºçœç•¥å· */
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ‡æ¢åˆ°å…¨å±æ­Œè¯æ—¶ï¼Œéšè—å•è¡Œæ­Œè¯é¢„è§ˆ â–¼â–¼â–¼ */

#music-visual-container.lyrics-active + #single-lyric-display {
    /* æ ¸å¿ƒï¼šä½¿ç”¨ display: none; å°†å…¶å½»åº•éšè—ï¼Œä¸å ç©ºé—´ */
    display: none;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* 1. å¼¹çª—èƒŒæ™¯ */
#character-profile-modal {
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

/* 2. å¡ç‰‡ä¸»ä½“å†…å®¹åŒº */
.character-profile-content {
    width: 320px;
    height: 75vh;
    max-height: 580px;
    background-color: #f0f2f5;
    border-radius: 20px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    display: flex;
    flex-direction: column;
    position: relative;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
     overflow: visible; /* <--- CHANGE TO THIS */
    /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å¢åŠ é¡¶éƒ¨çš„å†…è¾¹è·ï¼Œè®©å¤´éƒ¨ä¿¡æ¯æ›´èˆ’å±• */
    padding-top: 40px; 
}

/* 3. å³ä¸Šè§’â€œæŸ¥çœ‹å†å²â€å›¾æ ‡æŒ‰é’® (ä¿æŒä¸å˜) */
#profile-history-icon-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 36px;
    height: 36px;
    background: none;
    border: none;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    padding: 0;
    z-index: 10;
}
#profile-history-icon-btn:hover { background-color: rgba(0,0,0,0.05); }
#profile-history-icon-btn svg { width: 20px; height: 20px; stroke: #b0b0b0; stroke-width: 2; }

/* 4. ä¸»èµ„æ–™é¡µä¸å†å²è®°å½•é¡µçš„å®¹å™¨ */
#profile-main-content, #profile-thoughts-history-view {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
}

/* 5. ä¸»èµ„æ–™é¡µç‹¬æœ‰çš„æ ·å¼ */
#profile-main-content {
    padding: 0 25px 25px 25px; /* ç§»é™¤äº†é¡¶éƒ¨paddingï¼Œå› ä¸ºå®ƒå·²åœ¨çˆ¶å…ƒç´ ä¸­å®šä¹‰ */
    /* ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ˜¾è‘—å¢åŠ å¡ç‰‡ä¹‹é—´çš„å‚ç›´é—´è·ï¼Œè§£å†³â€œæŒ¤â€çš„é—®é¢˜ */
    gap: 20px; 
    flex-grow: 1;
    overflow-y: auto;
}

/* 6. å¤´éƒ¨ä¿¡æ¯åŒº */
.profile-header {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-shrink: 0;
    /* ã€æ ¸å¿ƒä¿®æ”¹3ã€‘ä¸ºå¤´éƒ¨ä¸‹æ–¹å¢åŠ æ˜ç¡®çš„è¾¹è· */
    margin-bottom: 10px; 
}
#profile-avatar { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; }
.profile-info { display: flex; flex-direction: column; }
#profile-name { font-size: 20px; font-weight: 600; color: #1f1f1f; }
#profile-id { font-size: 14px; color: #8a8a8a; }
        
/* â–¼â–¼â–¼ ã€å…¨æ–°V2ç‰ˆã€‘å¿ƒå£°ä¸æ•£è®°å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */

/* 1. å¡ç‰‡é€šç”¨å®¹å™¨æ ·å¼ */
.profile-section {
    background-color: #ffffff; /* å¹²å‡€çš„ç™½è‰²èƒŒæ™¯ */
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06); /* æŸ”å’Œçš„å¡ç‰‡é˜´å½± */
    display: flex;
    flex-direction: column;
    gap: 12px; /* å¤´éƒ¨å’Œå†…å®¹åŒºçš„é—´è· */
    flex-shrink: 0;
}

/* 2. å¡ç‰‡å¤´éƒ¨å®¹å™¨ */
.profile-section-header {
    display: flex;
    align-items: center;
    gap: 10px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    padding-bottom: 12px;
    border-bottom: 1px solid #f0f0f0; /* ä¸€æ¡ç²¾è‡´çš„åˆ†å‰²çº¿ */
}

/* 3. å¡ç‰‡å¤´éƒ¨å›¾æ ‡æ ·å¼ */
.profile-section-icon {
    font-size: 20px;
    opacity: 0.5;
}

/* 4. å¡ç‰‡å¤´éƒ¨æ ‡é¢˜æ–‡å­— ("å¿ƒå£°", "æ•£è®°") */
.profile-section label {
    font-size: 15px;
    font-weight: 600;
    color: #555; /* æ¯”ä¹‹å‰æ›´æ·±çš„é¢œè‰²ï¼Œæ›´æœ‰è´¨æ„Ÿ */
    margin: 0; /* ç§»é™¤æ—§çš„è¾¹è· */
}

/* 5. å¡ç‰‡å†…å®¹åŒºæ–‡å­— (ä¿æŒä¸å˜) */
.profile-section p {
    font-size: 15px;
    color: #333;
    line-height: 1.7;
    margin: 0;
    white-space: pre-wrap;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */
        
/* 10. å†å²è®°å½•é¡µé¢ç‰¹å®šæ ·å¼ (ä¿æŒä¸å˜) */
#profile-thoughts-history-view { display: none; padding: 0 25px 25px 25px; }
#profile-thoughts-history-view .profile-header { justify-content: space-between; padding-bottom: 15px; }
#profile-thoughts-history-view .profile-header span { font-size: 18px; font-weight: 600; }
#history-back-btn { width: 36px; height: 36px; background: none; border: none; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; padding: 0; }
#history-back-btn:hover { background-color: rgba(0,0,0,0.05); }
#history-back-btn svg { width: 22px; height: 22px; stroke: #a0a0a0; stroke-width: 2.5; }

/* 11. å†å²è®°å½•åˆ—è¡¨ (ä¿æŒä¸å˜) */
#thoughts-history-list {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 5px;
    margin-right: -10px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.thought-card { background-color: #ffffff; border-radius: 16px; padding: 15px 20px; border: 1px solid #eee; }
.thought-header { font-size: 12px; color: #b0b0b0; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
.thought-content .label { display: flex; align-items: center; gap: 6px; font-weight: 600; color: #a0a0a0; font-size: 13px; margin-bottom: 6px; }
.thought-content .label svg { width: 16px; height: 16px; }
.thought-content .text { font-size: 14px; color: #555; line-height: 1.7; white-space: pre-wrap; padding-left: 22px; }
.thought-content .jottings { margin-top: 15px; }

/* 12. éšè—æ»šåŠ¨æ¡ (ä¿æŒä¸å˜) */
#profile-main-content::-webkit-scrollbar,
#thoughts-history-list::-webkit-scrollbar { display: none; }
#profile-main-content, #thoughts-history-list { -ms-overflow-style: none; scrollbar-width: none; }
/* â–¼â–¼â–¼ ã€æœ€ç»ˆç‰ˆã€‘å¿ƒå£°é¡µé¢ä¸å†å²è®°å½•ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */

/* 1. å°†è§’è‰²è¯¦æƒ…é¡µï¼ˆå¿ƒå£°é¡µé¢ï¼‰çš„èƒŒæ™¯ä¿®æ”¹ä¸ºçº¯ç™½è‰² */
.character-profile-content {
    background-color: #ffffff !important;
}

/* 2. ä»…éšè—â€œæ•£è®°â€æ ‡ç­¾ (åœ¨ä¸»é¡µå’Œå†å²è®°å½•ä¸­éƒ½ç”Ÿæ•ˆ) */
#character-profile-modal .jottings .label {
    display: none;
}

/* 3. ã€å¯¹é½ä¿®æ­£ã€‘ç§»é™¤å¿ƒå£°å’Œæ•£è®°å†…å®¹çš„å·¦è¾¹è·ï¼Œè®©å®ƒä»¬ä¸æ ‡é¢˜å¯¹é½ */
#character-profile-modal .thought-content .text {
    padding-left: 0;
}

/* â–²â–²â–² æ ·å¼ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æ­¥éª¤ 2ï¼šå°†è¿™æ®µå…¨æ–°çš„CSSä»£ç ï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* ä¸ºåŠ¨æ€é¡µé¢çš„â€œä¸‰ç‚¹â€æŒ‰é’®è®¾ç½®ä¸“å±æ ·å¼ */
#qzone-more-actions-btn {
    font-size: 24px;      /* å¢å¤§å­—ä½“ï¼Œè®©â€œâ€¦â€æ›´æ¸…æ™° */
    font-weight: bold;    /* åŠ ç²— */
    padding: 0 10px;      /* å¢åŠ æ°´å¹³å¯ç‚¹å‡»åŒºåŸŸ */
    border-radius: 50%;   /* æ·»åŠ ä¸€ä¸ªåœ†å½¢èƒŒæ™¯ï¼ˆæ‚¬åœæ—¶å¯è§ï¼‰ */
    line-height: 1;       /* ç¡®ä¿å‚ç›´å±…ä¸­ */
    position: relative;
    top: -2px;            /* ä½ç½®å¾®è°ƒ */
    transition: background-color 0.2s;
}
#qzone-more-actions-btn:hover {
    background-color: rgba(0,0,0,0.05); /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¸€ä¸ªæ·¡æ·¡çš„ç°è‰²åœ†å½¢èƒŒæ™¯ */
}

/* å¤œé—´æ¨¡å¼ä¸‹çš„æ‚¬åœæ•ˆæœ */
#phone-screen.dark-mode #qzone-more-actions-btn:hover {
    background-color: rgba(255,255,255,0.1);
}

/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æ­¥éª¤ 2ï¼šå°†è¿™æ®µã€å…¨æ–°çš„CSSä»£ç ã€‘ï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* æ¸…ç©ºåŠ¨æ€é€‰æ‹©åˆ—è¡¨çš„æ ·å¼ */
#clear-posts-list {
    overflow-y: auto; /* å†…å®¹è¿‡é•¿æ—¶å¯ä»¥æ»šåŠ¨ */
    flex-grow: 1;
}

/* æ¯ä¸€ä¸ªå¯å‹¾é€‰çš„é¡¹ç›® */
.clear-posts-item {
    display: flex;
    align-items: center;
    padding: 12px 18px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s;
}
.clear-posts-item:hover {
    background-color: #f5f5f5;
}

/* æ¨¡æ‹Ÿçš„å‹¾é€‰æ¡† */
.clear-posts-item .checkbox {
    width: 22px;
    height: 22px;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 15px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}
/* é€‰ä¸­åçš„æ ·å¼ */
.clear-posts-item.selected .checkbox {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}
/* ä¸ºå‹¾é€‰æ¡†æ·»åŠ ä¸€ä¸ªâ€œâœ”â€å· */
.clear-posts-item.selected .checkbox::after {
    content: 'âœ”';
    font-size: 14px;
    font-weight: bold;
}

/* é¡¹ç›®åç§° */
.clear-posts-item .name {
    font-weight: 500;
}

/* ä¸ºå±é™©é€‰é¡¹ï¼ˆå¦‚â€œæ¸…ç©ºæ‰€æœ‰â€ï¼‰æ·»åŠ çº¢è‰²è­¦å‘Šæ ·å¼ */
.clear-posts-item.danger-option .name {
    color: #ff3b30;
    font-weight: 600;
}

/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ æ­¥éª¤ 2ï¼šå°†è¿™æ®µã€å…¨æ–°çš„CSSä»£ç ã€‘ï¼Œç²˜è´´åˆ° <style> æ ‡ç­¾çš„æœ€æœ«å°¾ â–¼â–¼â–¼ */

/* 1. è®©å¿ƒå£°å¡ç‰‡æˆä¸ºåˆ é™¤æŒ‰é’®çš„å®šä½é”šç‚¹ */
.thought-card {
    position: relative; /* å…³é”®ï¼ */
}

/* 2. åˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.thought-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: none;
    background-color: rgba(0,0,0,0.05);
    color: var(--text-secondary);
    font-size: 20px;
    line-height: 26px;
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: all 0.2s ease-in-out;
}

/* 3. é¼ æ ‡æ‚¬åœåœ¨å¡ç‰‡ä¸Šæ—¶ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.thought-card:hover .thought-delete-btn {
    opacity: 1;
}

/* 4. é¼ æ ‡æ‚¬åœåœ¨åˆ é™¤æŒ‰é’®ä¸Šæ—¶ï¼Œå˜ä¸ºçº¢è‰²è­¦å‘Š */
.thought-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢ç»“æœå¼¹çª—ç¾åŒ– (å¤šé€‰æ”¯æŒç‰ˆ) â–¼â–¼â–¼ */



/* 2. è®©åˆ—è¡¨é¡¹æ”¯æŒFlexå¸ƒå±€ï¼Œä¸ºå¤é€‰æ¡†ç•™å‡ºç©ºé—´ */
.search-result-item {
    display: flex;       /* æ”¹ä¸ºFlexå¸ƒå±€ */
    align-items: center; /* å‚ç›´å±…ä¸­ */
    padding: 12px 18px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}
.search-result-item:hover {
    background-color: rgba(0, 0, 0, 0.05);
}
#phone-screen.dark-mode .search-result-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

/* 3. è®©æ­Œæ›²ä¿¡æ¯éƒ¨åˆ†å æ®å‰©ä½™ç©ºé—´ */
.search-result-item .search-result-info {
    flex-grow: 1;
    pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°çˆ¶å…ƒç´  */
}

/* 4. å¤é€‰æ¡†æ ·å¼ */
.search-result-item .music-search-checkbox {
    width: 20px;
    height: 20px;
    margin-right: 15px;
    flex-shrink: 0;
}

/* 5. è°ƒæ•´å¼¹çª—å¤´éƒ¨ï¼Œä¸ºâ€œå…¨é€‰â€ç•™å‡ºç©ºé—´ */
#music-search-results-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* 6. è°ƒæ•´å¼¹çª—é¡µè„šï¼Œå®¹çº³ä¸¤ä¸ªæŒ‰é’® */
#music-search-results-modal .modal-footer {
    display: flex;
    justify-content: space-around;
}
#music-search-results-modal .modal-footer button {
    width: 45%; /* è®©æ¯ä¸ªæŒ‰é’®å æ®è¿‘ä¸€åŠå®½åº¦ */
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾åŒ–å¤–è§‚è®¾ç½®é¡µé¢çš„æ¬¡è¦æŒ‰é’® â–¼â–¼â–¼ */
.bg-upload-container {
    /* ç¡®ä¿å®¹å™¨å†…çš„æŒ‰é’®èƒ½æ­£ç¡®å¯¹é½ */
    width: 100%;
    justify-content: center;
    gap: 15px; /* å¢åŠ æŒ‰é’®ä¹‹é—´çš„é—´è· */
}

.bg-upload-container .form-button-secondary {
    flex-grow: 1; /* è®©æŒ‰é’®è‡ªåŠ¨å¡«å……ç©ºé—´ */
    flex-basis: 0; /* ç¡®ä¿flex-growç”Ÿæ•ˆ */
    max-width: 180px; /* ç»™ä¸€ä¸ªæœ€å¤§å®½åº¦ï¼Œé¿å…åœ¨å®½å±ä¸Šæ‹‰ä¼¸è¿‡åº¦ */
    margin-top: 0;
    padding: 12px; /* é€‚ä¸­çš„å†…è¾¹è·ï¼Œè®©æŒ‰é’®æ›´é¥±æ»¡ */
    font-size: 15px;
    font-weight: 600; /* ä¸ä¸»æŒ‰é’®ä¸€è‡´çš„å­—é‡ */
    border-radius: 8px; /* ä¸ä¸»æŒ‰é’®ä¸€è‡´çš„åœ†è§’ */
    border: none; /* ç§»é™¤è¾¹æ¡†ï¼Œæ›´åƒiOSé£æ ¼ */
    background-color: #e9e9eb; /* iOSé£æ ¼çš„æµ…ç°è‰² */
    color: #1c1c1e; /* æ·±è‰²æ–‡å­— */
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
}

.bg-upload-container .form-button-secondary:active {
    transform: scale(0.98); /* æ·»åŠ ç‚¹å‡»åé¦ˆ */
}

/* ä¸ºâ€œç§»é™¤â€æŒ‰é’®è®¾ç½®ç‰¹æ®Šçš„è­¦å‘Šè‰² */
#remove-global-bg-btn {
    background-color: #ffebee;
    color: #c62828;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒå£°/æ•£è®°å¡ç‰‡ç¥¨æ ¹æ ·å¼ â–¼â–¼â–¼ */

/* 1. ä¸ºå¡ç‰‡ä¸»ä½“è®¾ç½®ç›¸å¯¹å®šä½å’Œæº¢å‡ºéšè—ï¼Œè¿™æ˜¯å®ç°æ•ˆæœçš„åŸºç¡€ */
#character-profile-modal .character-profile-content {
    position: relative; /* è®©ä¼ªå…ƒç´ å¯ä»¥ç›¸å¯¹äºå®ƒå®šä½ */
    overflow: visible;  /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å…è®¸ä¼ªå…ƒç´ â€œæº¢å‡ºâ€åˆ°å¤–é¢ä¸€ç‚¹ï¼Œå½¢æˆæ‰“å­”æ•ˆæœ */
    padding-bottom: 35px; /* å¢åŠ åº•éƒ¨å†…è¾¹è·ï¼Œé˜²æ­¢å†…å®¹ä¸åº•éƒ¨æ‰“å­”é‡å  */
}

/* 2. åˆ›å»ºé¡¶éƒ¨çš„æ‰“å­”æ•ˆæœ */
#character-profile-modal .character-profile-content::before {
    content: '';
    position: absolute;
    top: -10px; /* å‘ä¸Šç§»åŠ¨ï¼Œéœ²å‡ºä¸€åŠ */
    left: 0;
    right: 0;
    height: 20px; /* æ‰“å­”æ¡çš„é«˜åº¦ */
    /* æ ¸å¿ƒï¼šä½¿ç”¨å¾„å‘æ¸å˜åˆ›å»ºé‡å¤çš„åŠåœ†å½¢â€œå­”â€ */
    background-image: radial-gradient(circle at 50% 0, transparent 8px, #f0f2f5 8px);
    background-size: 25px 20px; /* æ§åˆ¶æ¯ä¸ªå­”çš„å¤§å°å’Œé—´è· */
    background-repeat: repeat-x;
}

/* 3. åˆ›å»ºåº•éƒ¨çš„æ‰“å­”æ•ˆæœ */
#character-profile-modal .character-profile-content::after {
    content: '';
    position: absolute;
    bottom: -10px; /* å‘ä¸‹ç§»åŠ¨ï¼Œéœ²å‡ºä¸€åŠ */
    left: 0;
    right: 0;
    height: 20px; /* æ‰“å­”æ¡çš„é«˜åº¦ */
    /* æ ¸å¿ƒï¼šä¸é¡¶éƒ¨ç±»ä¼¼ï¼Œä½†åœ†å¿ƒä½ç½®ç›¸å */
    background-image: radial-gradient(circle at 50% 100%, transparent 8px, #f0f2f5 8px);
    background-size: 25px 20px; /* æ§åˆ¶æ¯ä¸ªå­”çš„å¤§å°å’Œé—´è· */
    background-repeat: repeat-x;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¥¨æ ¹æ ·å¼ç¾åŒ– (ç›´è§’ + çº¯ç™½èƒŒæ™¯) â–¼â–¼â–¼ */

/* 1. è¦†ç›–ä¸»å®¹å™¨æ ·å¼ï¼Œæ”¹ä¸ºç›´è§’å’Œç™½è‰²èƒŒæ™¯ */
#character-profile-modal .character-profile-content {
    border-radius: 0;         /* æ ¸å¿ƒä¿®æ”¹1: ç§»é™¤åœ†è§’ï¼Œå˜ä¸ºç›´è§’ */
    background-color: #ffffff; /* æ ¸å¿ƒä¿®æ”¹2: å°†èƒŒæ™¯è‰²æ”¹ä¸ºçº¯ç™½è‰² */
}

/* 2. è¦†ç›–é¡¶éƒ¨æ‰“å­”æ¡çš„é¢œè‰²ï¼Œä¸æ–°çš„ç™½è‰²èƒŒæ™¯ç»Ÿä¸€ */
#character-profile-modal .character-profile-content::before {
    /* æ ¸å¿ƒä¿®æ”¹3: å°†æ‰“å­”æ¡çš„é¢œè‰²ä»ç°è‰²æ”¹ä¸ºçº¯ç™½è‰² */
    background-image: radial-gradient(circle at 50% 0, transparent 8px, #ffffff 8px);
}

/* 3. è¦†ç›–åº•éƒ¨æ‰“å­”æ¡çš„é¢œè‰²ï¼Œä¸æ–°çš„ç™½è‰²èƒŒæ™¯ç»Ÿä¸€ */
#character-profile-modal .character-profile-content::after {
    /* æ ¸å¿ƒä¿®æ”¹4: å°†æ‰“å­”æ¡çš„é¢œè‰²ä¹Ÿæ”¹ä¸ºçº¯ç™½è‰² */
    background-image: radial-gradient(circle at 50% 100%, transparent 8px, #ffffff 8px);
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºå¿ƒå£°/æ•£è®°å¡ç‰‡æ·»åŠ ç¥¨æ ¹åˆ†å‰²çº¿ â–¼â–¼â–¼ */

/* 1. ä¸ºå¤´éƒ¨åŒºåŸŸï¼ˆæ—¶é—´æˆ³ï¼‰æ·»åŠ ç›¸å¯¹å®šä½å’Œç©ºé—´ï¼Œä½œä¸ºåˆ†å‰²çº¿çš„â€œé”šç‚¹â€ */
#character-profile-modal .thought-header {
    position: relative;
    width: 100%;
    /* å¢åŠ åº•éƒ¨å†…è¾¹è·ï¼Œä¸ºåˆ†å‰²çº¿åˆ›é€ ç©ºé—´ */
    padding-bottom: 15px; 
    /* å¢åŠ åº•éƒ¨å¤–è¾¹è·ï¼Œå°†ä¸‹æ–¹çš„â€œå¿ƒå£°â€å†…å®¹æ¨å¼€ */
    margin-bottom: 25px; 
    /* è¿™å°±æ˜¯ä¸­é—´çš„ç°è‰²è™šçº¿ */
    border-bottom: 2px dashed #e0e0e0; 
}

/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ã€‘ç¥¨æ ¹åˆ†å‰²çº¿æ‰“å­”é€æ˜æ•ˆæœ â–¼â–¼â–¼ */


/* 2. é‡æ–°åˆ›å»ºå·¦ä¾§çš„â€œæ‰“å­”â€ï¼Œä½¿å…¶é¢œè‰²ä¸é¡µé¢èƒŒæ™¯ä¸€è‡´ */
#character-profile-modal .thought-header::before {
    content: '';
    position: absolute;
    bottom: -11px;
    left: -35px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    /* æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨é¡µé¢çš„èƒŒæ™¯è‰² (#f0f2f5) æ¥â€œä¼ªè£…â€é€æ˜æ•ˆæœ */
    background-color:  rgba(0, 0, 0, 0.3);
}

/* 3. é‡æ–°åˆ›å»ºå³ä¾§çš„â€œæ‰“å­”â€ */
#character-profile-modal .thought-header::after {
    content: '';
    position: absolute;
    bottom: -11px;
    right: -35px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    /* æ ¸å¿ƒä¿®å¤ï¼šé¢œè‰²ä¸é¡µé¢èƒŒæ™¯ä¿æŒä¸€è‡´ */
    background-color:  rgba(0, 0, 0, 0.3);
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€ç»ˆç‰ˆã€‘è§’è‰²èµ„æ–™å¡å›ºå®šèƒŒæ™¯å›¾æ ·å¼ (ç›´è§’) â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ ã€æœ€ç»ˆå›¾ç‰‡æ˜¾ç¤ºä¿®å¤ã€‘è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ .thought-header æ ·å¼ â–¼â–¼â–¼ */
#character-profile-modal .thought-header {
    height: 140px;         /* ä¿æŒå›ºå®šçš„ã€é˜²å‹ç¼©çš„é«˜åº¦ */
    flex-shrink: 0;
    padding: 10px;         /* åœ¨å›¾ç‰‡å››å‘¨ç•™å‡ºâ€œç”»æ¡†â€è¾¹è· */
    padding-bottom: 25px;  /* åŠ å¤§åº•éƒ¨è¾¹è·ï¼Œå°†å›¾ç‰‡ä¸è™šçº¿åˆ†å¼€ */
    box-sizing: border-box;
    border-bottom: 2px dashed #e0e0e0; /* æ¢å¤è™šçº¿åˆ†å‰²çº¿ */
    margin-bottom: 25px;
    position: relative;     /* ä¿æŒï¼Œä¸ºäº†è®©æ‰“å­”èƒ½æ­£ç¡®å®šä½ */

    /* --- æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œé‡æ–°æ·»åŠ èƒŒæ™¯å›¾ç‰‡ --- */
    background-image: url('https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758340625111_qdqqd_zqr2cl.jpeg'); /* <-- è¯·åœ¨è¿™é‡Œæ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„å›¾ç‰‡URL */
    background-size: cover;
    background-position: center top;
    border-radius: 0;      /* ç¡®ä¿å›¾ç‰‡å®¹å™¨æ˜¯ç›´è§’çš„ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* 2. ç§»é™¤ä¹‹å‰ä¸ºJSåŠ¨æ€å›¾ç‰‡å‡†å¤‡çš„æ ·å¼ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰ */
#profile-photo-slot {
    display: none; /* éšè—æ‰JSå¯èƒ½åˆ›å»ºçš„<img>æ ‡ç­¾ */
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ã€‘éš”ç¦»èµ„æ–™å¡æ ·å¼ï¼Œé˜²æ­¢æ³„éœ²åˆ°å†å²è®°å½• â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ã€‘éš”ç¦»èµ„æ–™å¡æ ·å¼ï¼Œé˜²æ­¢æ³„éœ²åˆ°å†å²è®°å½• â–¼â–¼â–¼ */

/* 1. ã€æ ¸å¿ƒã€‘ä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨ï¼Œç¡®ä¿ç…§ç‰‡åŒºåŸŸåªå‡ºç°åœ¨ä¸»èµ„æ–™é¡µä¸Š */
#character-profile-modal #profile-main-content .thought-header {
   // height: 120px;
    //padding-bottom: 15px; /* æ­¥éª¤1ï¼šä¿ç•™è¶³å¤Ÿçš„ç©ºé—´ï¼Œå°†è™šçº¿å‘ä¸‹æ¨ */
    box-sizing: border-box;
    background-image: url('https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758340625111_qdqqd_zqr2cl.jpeg');
    background-size: cover;
    background-position: center top;
    border-bottom: 2px dashed #e0e0e0;
    margin-bottom: 15px;
    
    /* â–¼â–¼â–¼ æ­¥éª¤2ï¼šè¿™å°±æ˜¯è§£å†³é—®é¢˜çš„å…³é”®ï¼â–¼â–¼â–¼ */
    /* å¼ºåˆ¶èƒŒæ™¯å›¾åªåœ¨å†…å®¹åŒºç»˜åˆ¶ï¼Œä¸è¦è¿›å…¥æˆ‘ä»¬ç”¨paddingæ’‘å¼€çš„ç©ºç™½åŒºåŸŸ */
    background-clip: content-box; 
    -webkit-background-clip: content-box; /* å…¼å®¹æ—§ç‰ˆæµè§ˆå™¨ */
    /* â–²â–²â–² å…³é”®ä»£ç ç»“æŸ â–²â–²â–² */
}

/* 2. ã€æ ¸å¿ƒã€‘ç¡®ä¿æ‰“å­”æ•ˆæœä¹Ÿåªå‡ºç°åœ¨ä¸»èµ„æ–™é¡µä¸Š */
#character-profile-modal #profile-main-content .thought-header::before,
#character-profile-modal #profile-main-content .thought-header::after {
    content: '';
    position: absolute;
    bottom: -11px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.3);
}
#character-profile-modal #profile-main-content .thought-header::before {
    left: -35px;
}
#character-profile-modal #profile-main-content .thought-header::after {
    right: -35px;
}

/* 3. ã€é‡è¦ã€‘å°†å†å²è®°å½•é¡µé‡Œçš„å°å¡ç‰‡å¤´éƒ¨æ ·å¼ï¼Œå¼ºåˆ¶æ¢å¤ä¸ºåŸå§‹çš„ç®€æ´æ ·å¼ */
#character-profile-modal #thoughts-history-list .thought-card .thought-header {
    height: auto;
    padding: 0;
    padding-bottom: 8px; /* æ¢å¤åº•éƒ¨çš„å°é—´è· */
    margin-bottom: 12px;
    background-image: none; /* ç§»é™¤èƒŒæ™¯å›¾ */
    border: none; /* ç§»é™¤æ‰€æœ‰è¾¹æ¡† */
    border-bottom: 1px solid #f0f0f0; /* åªä¿ç•™åº•éƒ¨çš„ç»†åˆ†å‰²çº¿ */
}

/* 4. ã€é‡è¦ã€‘åœ¨å†å²è®°å½•çš„å°å¡ç‰‡ä¸Šï¼Œå¼ºåˆ¶éšè—æ‰æ‰“å­”çš„ä¼ªå…ƒç´  */
#character-profile-modal #thoughts-history-list .thought-card .thought-header::before,
#character-profile-modal #thoughts-history-list .thought-card .thought-header::after {
    display: none !important; /* å¼ºåˆ¶ä¸æ˜¾ç¤º */
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¿ƒå£°/æ•£è®°ç¾åŒ–ä¸å­—ä½“ä¿®å¤ â–¼â–¼â–¼ */

/* 
  ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶æ˜¾ç¤ºâ€œå¿ƒå£°â€å’Œâ€œæ•£è®°â€çš„æ ‡ç­¾ã€‚
  æˆ‘ä»¬ä½¿ç”¨ !important æ¥ç¡®ä¿è¿™æ¡è§„åˆ™çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œ
  å¯ä»¥è¦†ç›–æ‰ä»»ä½•ä¹‹å‰å¯èƒ½å­˜åœ¨çš„ display: none; éšè—è§„åˆ™ã€‚
*/
#character-profile-modal #profile-main-content .label {
    display: flex !important;
}

/* 
  ç¬¬äºŒæ­¥ï¼šä¸ºâ€œå¿ƒå£°â€å’Œâ€œæ•£è®°â€çš„æ­£æ–‡å†…å®¹æ›´æ¢å­—ä½“ã€‚
  è¿™é‡Œä»¥å¸¸è§çš„å®‹ä½“(SimSun)ä¸ºä¾‹ï¼Œæ‚¨å¯ä»¥æ›¿æ¢æˆä»»ä½•æ‚¨å–œæ¬¢çš„å­—ä½“åç§°ã€‚
*/
#character-profile-modal #profile-main-content .text {
    font-family: "SimSun", "Songti SC", serif; /* ç¤ºä¾‹ï¼šæ›´æ¢ä¸ºå®‹ä½“ */
    font-size: 16px; /* (å¯é€‰) ç¨å¾®æ”¾å¤§å­—ä½“ï¼Œè®©å®‹ä½“æ›´æ¸…æ™° */
}

/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ã€‘å¼ºåˆ¶å°†å¿ƒå£°/æ•£è®°å†…å®¹å˜ä¸ºçº¯é»‘è‰² â–¼â–¼â–¼ */

/* 1. å°†â€œå¿ƒå£°â€å’Œâ€œæ•£è®°â€çš„æ ‡é¢˜æ–‡å­—å’Œå›¾æ ‡å˜ä¸ºé»‘è‰² */
#character-profile-modal .thought-content .label {
    color: #000000 !important;
}

/* 2. å°†â€œå¿ƒå£°â€å’Œâ€œæ•£è®°â€çš„æ­£æ–‡æ®µè½æ–‡å­—å˜ä¸ºé»‘è‰² */
#character-profile-modal .thought-content .text {
    color: #000000 !important;
}

/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¿®å¤å¿ƒå£°/èµ„æ–™å¡é¡µé¢å·¦å³æ»‘åŠ¨é—®é¢˜ â–¼â–¼â–¼ */
#character-profile-modal #profile-main-content {
    overflow-x: hidden;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…åŒ…åˆ†ç±»åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

        /* 1. åˆ†ç±»é¡µç­¾å®¹å™¨æ ·å¼ */
        #sticker-category-tabs {
            display: flex;
            overflow-x: auto;
            padding: 0 15px; /* å·¦å³ç•™ç™½ */
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            /* éšè—æ»šåŠ¨æ¡ */
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #sticker-category-tabs::-webkit-scrollbar {
            display: none;
        }

        /* 2. å•ä¸ªé¡µç­¾æŒ‰é’®æ ·å¼ */
        .sticker-category-tab {
            padding: 10px 16px; /* å¢åŠ ä¸Šä¸‹å†…è¾¹è·ï¼Œè®©é¡µç­¾æ›´é«˜ä¸€äº› */
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px; /* è®©åº•è¾¹æ¡†ä¸å®¹å™¨è¾¹æ¡†é‡åˆ */
            transition: all 0.2s ease-in-out;
            white-space: nowrap; /* é˜²æ­¢åˆ†ç±»åæ¢è¡Œ */
        }

        /* 3. æ¿€æ´»çš„é¡µç­¾æ ·å¼ */
        .sticker-category-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
        }

        #phone-screen.dark-mode .sticker-category-tab.active {
            color: #ffffff;
        }
        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…æ‰¹é‡åˆ é™¤ä¸å…¨é€‰åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
        
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œä¸ºè¡¨æƒ…é¡¹æ·»åŠ ä¸€ä¸ªé€‰ä¸­æ¡† */
        #sticker-grid.management-mode .sticker-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-radius: 10px;
            box-sizing: border-box;
            transition: border-color 0.2s;
            pointer-events: none; /* ç¡®ä¿ä¸å½±å“ç‚¹å‡» */
        }
        
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œè¢«é€‰ä¸­çš„è¡¨æƒ…é¡¹ï¼Œæ˜¾ç¤ºè“è‰²è¾¹æ¡† */
        #sticker-grid.management-mode .sticker-item.selected::after {
            border-color: var(--accent-color);
        }
        
        /* ç®¡ç†æ¨¡å¼ä¸‹ï¼Œæ€»æ˜¯æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
        #sticker-grid.management-mode .sticker-item .delete-btn {
            display: block;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid white;
        }
        
        /* ã€å…¨æ–°ã€‘åº•éƒ¨æ‰¹é‡åˆ é™¤æ“ä½œæ  */
        #sticker-action-bar {
            display: none; /* é»˜è®¤éšè— */
            flex-shrink: 0;
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            justify-content: space-between; /* è®©â€œå…¨é€‰â€å’Œâ€œåˆ é™¤â€ä¸¤ç«¯å¯¹é½ */
            align-items: center;
        }
        
        #sticker-action-bar .select-all-label {
            font-size: 16px;
            color: var(--text-primary);
            cursor: pointer;
        }

        #sticker-action-bar button {
            padding: 10px 25px;
            border-radius: 20px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–° V2.0ã€‘CphoneåŠŸèƒ½çš„æ‰€æœ‰CSSæ ·å¼ â–¼â–¼â–¼ */

/* --- 1. è§’è‰²é€‰æ‹©ç•Œé¢ (ä¿æŒä¸å˜) --- */
#character-selection-screen { background-color: #f0f2f5; }
#phone-screen.dark-mode #character-selection-screen { background-color: #000; }
/* --- è¯·ç”¨è¿™ä¸€æ•´å—ã€å…¨æ–°ã€‘çš„CSSï¼Œæ›¿æ¢æ—§çš„ #character-grid å’Œ .character-select-item ç›¸å…³çš„æ‰€æœ‰æ ·å¼ --- */

/* 1. å°†ç½‘æ ¼å®¹å™¨å˜ä¸ºåˆ—è¡¨å®¹å™¨ */
#character-grid {
    /* ç§»é™¤äº† display: grid å’Œç›¸å…³å±æ€§ */
    padding: 0; /* ç§»é™¤å†…è¾¹è·ï¼Œç”±åˆ—è¡¨é¡¹è‡ªå·±æ§åˆ¶ */
    overflow-y: auto; /* ç¡®ä¿å†…å®¹è¶…å‡ºæ—¶å¯ä»¥æ»šåŠ¨ */
    flex-grow: 1;
}

/* 2. ä¿®æ”¹æ¯ä¸ªåˆ—è¡¨é¡¹çš„å¸ƒå±€ï¼Œä»å‚ç›´å˜ä¸ºæ°´å¹³ */
.character-select-item {
    display: flex;
    flex-direction: row;     /* æ ¸å¿ƒä¿®æ”¹ï¼šä» column å˜ä¸º row */
    align-items: center;     /* ä¿æŒå‚ç›´å±…ä¸­ */
    cursor: pointer;
    padding: 12px 20px;      /* å¢åŠ å†…è¾¹è·ï¼Œå½¢æˆåˆ—è¡¨é¡¹å¤–è§‚ */
    border-bottom: 1px solid var(--border-color); /* æ·»åŠ åˆ†å‰²çº¿ */
    gap: 15px;               /* åœ¨å¤´åƒå’Œåå­—ä¹‹é—´å¢åŠ é—´è· */
    transition: background-color 0.2s; /* æ·»åŠ æ‚¬åœæ•ˆæœ */
    /* ç§»é™¤äº† text-align: center */
}
.character-select-item:hover {
    background-color: #f5f5f5; /* é¼ æ ‡æ‚¬åœæ—¶é«˜äº® */
}


/* 3. è°ƒæ•´å¤´åƒå¤§å°å’Œæ ·å¼ */
.character-select-item .avatar {
    width: 45px;             /* æ ¸å¿ƒä¿®æ”¹ï¼šç¼©å°å¤´åƒå°ºå¯¸ */
    height: 45px;
    border-radius: 50%;      /* æ”¹ä¸ºåœ†å½¢ï¼Œæ›´é€‚åˆåˆ—è¡¨è§†å›¾ */
    object-fit: cover;
    margin-bottom: 0;        /* ç§»é™¤åº•éƒ¨å¤–è¾¹è· */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
    flex-shrink: 0;          /* é˜²æ­¢å¤´åƒè¢«å‹ç¼© */
}

/* 4. è°ƒæ•´åå­—æ ·å¼ */
.character-select-item .name {
    font-weight: 500;
    font-size: 16px;         /* ç¨å¾®å¢å¤§å­—ä½“ï¼Œæé«˜å¯è¯»æ€§ */
    color: var(--text-primary);
}
/* --- æ›¿æ¢ç»“æŸ --- */

/* --- 2. Cphoneä¸»å®¹å™¨ä¸å±å¹•åˆ‡æ¢ (ä¿æŒä¸å˜) --- */
#character-phone-screen { background-size: cover; background-position: center; }
.char-screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
.char-screen.active { opacity: 1; visibility: visible; z-index: 2; }

/* --- 3. Cphoneä¸»å±å¹• (ä¿æŒä¸å˜) --- */
#char-home-screen { justify-content: flex-start; align-items: center; box-sizing: border-box; padding: 0 20px; }
#char-clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-top: calc(60px + env(safe-area-inset-top)); flex-shrink: 0; margin-bottom: 100px; }
#char-main-time { font-size: 88px; font-weight: 600; letter-spacing: -2px; font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; }
#char-main-date { font-size: 22px; font-weight: normal; }
#char-app-grid { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }

/* --- 4. Cphoneå†…çš„Appé€šç”¨èƒŒæ™¯è‰² (å·²æ‰©å±•) --- */
#char-qq-screen, #char-memo-screen, #char-diary-screen, #char-usage-screen, 
#char-album-screen, #char-browser-screen, #char-taobao-screen {
     background-color: var(--secondary-bg);
}

/* --- 5. å¤‡å¿˜å½•ã€æ—¥è®°ã€ä½¿ç”¨è®°å½•åˆ—è¡¨æ ·å¼ (ä¿æŒä¸å˜) --- */
.memo-item, .diary-item, .usage-item { padding: 15px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
.memo-item .content, .diary-item .content { font-size: 16px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.diary-item .date, .usage-item .timestamp { font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }
.usage-item .action { font-size: 15px; color: var(--text-primary); }

/* --- 6. ã€å…¨æ–°ã€‘è§’è‰²ç›¸å†Œæ ·å¼ --- */
#char-album-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* æ¯è¡Œ3å¼ å›¾ */
    gap: 5px;
    padding: 5px;
}
.char-photo-item {
    aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
    background-size: cover;
    background-position: center;
    background-color: #e9ecef;
}

/* --- 7. ã€å…¨æ–°ã€‘è§’è‰²æµè§ˆå™¨å†å²æ ·å¼ --- */
.char-browser-item {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border-color);
}
.char-browser-item .title {
    font-weight: 500;
    font-size: 15px;
    color: var(--text-primary);
    margin-bottom: 4px;
}
.char-browser-item .url {
    font-size: 12px;
    color: var(--accent-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* --- 8. ã€å…¨æ–°ã€‘è§’è‰²æ·˜å®é¡µé¢æ ·å¼ (å¤ç”¨ä¸»è´­ç‰©é¡µæ ·å¼) --- */
#char-product-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    padding: 10px;
}
.char-product-item {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    display: flex;
    flex-direction: column;
}
.char-product-item .product-image {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 8px 8px 0 0;
}
.char-product-item .product-info {
    padding: 12px 10px;
    flex-grow: 1;
}
.char-product-item .product-name {
    font-size: 13px;
    color: #333;
    line-height: 1.4;
    min-height: 36px;
}
.char-product-item .product-price {
    font-size: 16px;
    font-weight: 700;
    color: #ff5722;
    margin-top: 8px;
}
.char-product-item .product-price::before { content: 'Â¥'; font-size: 12px; }

/* â–²â–²â–² å…¨æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°V2.0ã€‘CphoneQQæ¨¡æ‹ŸåŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
#char-qq-screen .list-container {
    padding: 0; /* ç§»é™¤å®¹å™¨çš„å†…è¾¹è· */
}
/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneQQæ¨¡æ‹ŸèŠå¤©è®°å½•å¼¹çª—æ ·å¼ â–¼â–¼â–¼ */

/* 1. è®©å¼¹çª—å†…å®¹åŒºæ‹¥æœ‰å’Œä¸»èŠå¤©ç•Œé¢ä¸€æ ·çš„å¸ƒå±€ */
#transcript-modal-body {
    display: flex;
    flex-direction: column;
    gap: 20px; /* æ¶ˆæ¯æ°”æ³¡ä¹‹é—´çš„é—´è· */
    padding: 15px; /* å†…è¾¹è· */
    background-color: #f0f2f5;
}

/* 2. å¤œé—´æ¨¡å¼é€‚é… */
#phone-screen.dark-mode #transcript-modal-body {
    background-color: #000000;
}

/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | æœ€ç»ˆå¸ƒå±€ä¿®å¤ã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰æ‚¨ä¸Šä¸€æ¬¡ç²˜è´´çš„ #char-chat-list ç›¸å…³çš„CSS â–¼â–¼â–¼ */

/* 1. ä¸ºä¸¤ä¸ªåˆ—è¡¨çš„åˆ—è¡¨é¡¹ï¼ˆä¸»QQåˆ—è¡¨å’Œè§’è‰²QQåˆ—è¡¨ï¼‰è®¾ç½®ç»Ÿä¸€çš„ Flexbox å¸ƒå±€ */
#chat-list .chat-list-item,
#char-chat-list .chat-list-item {
    display: flex;
    align-items: center;
    gap: 15px; /* ã€æ ¸å¿ƒä¿®å¤1ã€‘ä½¿ç”¨ gap å±æ€§åœ¨å¤´åƒå’Œæ–‡å­—ä¹‹é—´åˆ›å»ºé—´è·ï¼Œè¿™æ¯” margin æ›´ç°ä»£ã€æ›´å¯é  */
}

/* 2. ç¡®ä¿å¤´åƒå®¹å™¨ï¼ˆæ— è®ºåœ¨å“ªä¸€ä¸ªåˆ—è¡¨ä¸­ï¼‰éƒ½ç»å¯¹ä¸ä¼šè¢«å‹ç¼© */
#chat-list .chat-list-item .avatar-group,
#char-chat-list .chat-list-item .avatar-group {
    flex-shrink: 0;
    /* ç§»é™¤äº†æ—§çš„ margin-rightï¼Œå› ä¸ºç°åœ¨ç”±çˆ¶å…ƒç´ çš„ gap å±æ€§ç»Ÿä¸€æ§åˆ¶é—´è· */
}

/* 3. ç¡®ä¿æ–‡å­—ä¿¡æ¯åŒºåŸŸï¼ˆæ— è®ºåœ¨å“ªä¸€ä¸ªåˆ—è¡¨ä¸­ï¼‰éƒ½èƒ½å¤Ÿæ­£ç¡®åœ°ä¼¸ç¼© */
#chat-list .chat-list-item .info,
#char-chat-list .chat-list-item .info {
    flex-grow: 1;
    min-width: 0; /* å…³é”®ï¼å…è®¸å®¹å™¨æ”¶ç¼©ï¼Œä»è€Œé˜²æ­¢å†…éƒ¨çš„é•¿æ–‡å­—æ’‘ç ´å¸ƒå±€å¯¼è‡´é‡å  */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneQQæ¨¡æ‹Ÿå¯¹è¯é¡µé¢ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */

/* 1. è®©å¼¹çª—å†…å®¹åŒºæ‹¥æœ‰å’Œä¸»èŠå¤©ç•Œé¢ä¸€æ ·çš„å¸ƒå±€ */
#char-qq-conversation-screen .list-container {
    display: flex;
    flex-direction: column;
    gap: 20px; /* <-- æ ¸å¿ƒï¼šæ·»åŠ 20pxçš„é—´è· */
    padding: 15px; /* <-- æ–°å¢ï¼šåœ¨å››å‘¨å¢åŠ å†…è¾¹è·ï¼Œé¿å…æ°”æ³¡è´´è¾¹ */
    background-color: #f0f2f5;
}

/* 2. å¤œé—´æ¨¡å¼é€‚é… */
#phone-screen.dark-mode #char-qq-conversation-screen .list-container {
    background-color: #000000;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneAppé€šç”¨èƒŒæ™¯è‰² (å·²ä¿®å¤) â–¼â–¼â–¼ */
#char-qq-screen, 
#char-memo-screen, 
#char-diary-screen, 
#char-usage-screen, 
#char-album-screen, 
#char-browser-screen, 
#char-taobao-screen,
/* --- ã€æ ¸å¿ƒä¿®å¤ã€‘å°†æ–°çš„æ–‡ç« é¡µé¢ä¹ŸåŠ å…¥è¿™ä¸ªè§„åˆ™ï¼Œç¡®ä¿å®ƒæœ‰æ­£ç¡®çš„èƒŒæ™¯è‰² --- */
#char-browser-article-screen {
     background-color: var(--secondary-bg);
}
/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneAppé€šç”¨èƒŒæ™¯è‰² (å·²ä¿®å¤é’±åŒ…é¡µé¢) â–¼â–¼â–¼ */
#char-qq-screen, 
#char-memo-screen, 
#char-diary-screen, 
#char-usage-screen, 
#char-album-screen, 
#char-browser-screen, 
#char-taobao-screen,
#char-browser-article-screen,
/* --- ã€æ ¸å¿ƒä¿®å¤ã€‘å°†æ–°çš„é’±åŒ…é¡µé¢ä¹ŸåŠ å…¥è¿™ä¸ªè§„åˆ™ï¼Œç¡®ä¿å®ƒæœ‰æ­£ç¡®çš„èƒŒæ™¯è‰² --- */
#char-wallet-screen {
     background-color: var(--secondary-bg);
}
/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Cphoneå¤‡å¿˜å½•è¯¦æƒ…é¡µæ ·å¼ â–¼â–¼â–¼ */

#char-memo-detail-content {
    width: 100%;
    height: 100%;
    border: none;
    background-color: transparent;
    font-size: 16px;
    line-height: 1.7; /* å¢åŠ è¡Œé«˜ï¼Œæ›´æ˜“è¯» */
    padding: 15px 20px; /* å¢åŠ å·¦å³å†…è¾¹è· */
    box-sizing: border-box;
    resize: none; /* ç¦æ­¢ç”¨æˆ·æ‹–åŠ¨è°ƒæ•´å¤§å° */
    outline: none; /* ç§»é™¤é€‰ä¸­æ—¶çš„è“è‰²è¾¹æ¡† */
    font-family: inherit; /* ç»§æ‰¿é¡µé¢å­—ä½“ */
    color: var(--text-primary); /* ç¡®ä¿æ–‡å­—é¢œè‰²èƒ½é€‚é…å¤œé—´æ¨¡å¼ */
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Cphoneå¤‡å¿˜å½•è¯¦æƒ…é¡µç¾åŒ– (ä»¿iOS Notes App) â–¼â–¼â–¼ */

/* 1. è®©è¯¦æƒ…é¡µæ‹¥æœ‰è‡ªå·±çš„ã€èƒ½é€‚é…å¤œé—´æ¨¡å¼çš„èƒŒæ™¯è‰² */
#char-memo-detail-screen {
    background-color: var(--secondary-bg);
}

/* 2. ç¾åŒ–å¤´éƒ¨ï¼Œæ·»åŠ åˆ†å‰²çº¿ï¼Œå¹¶è°ƒæ•´å†…è¾¹è· */
#char-memo-detail-screen .header {
    background-color: var(--secondary-bg); /* ä¸é¡µé¢èƒŒæ™¯è‰²ç»Ÿä¸€ */
    border-bottom: 1px solid var(--border-color); /* æ·»åŠ ç²¾è‡´çš„åˆ†å‰²çº¿ */
    
    padding-bottom: 10px;
}

/* 3. ã€æ ¸å¿ƒã€‘å¼ºåˆ¶æ ‡é¢˜å±…ä¸­æ˜¾ç¤º */
#char-memo-detail-title {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    font-weight: 600; /* æ ‡é¢˜åŠ ç²— */
}

/* 4. ç§»é™¤å†…å®¹å®¹å™¨çš„é»˜è®¤å†…è¾¹è·ï¼Œè®©æ–‡æœ¬åŒºèƒ½æ’‘æ»¡ */
#char-memo-detail-screen .form-container {
    padding: 0;
}

/* 5. ç¾åŒ–æ–‡æœ¬åŒºåŸŸï¼Œä½¿å…¶çœ‹èµ·æ¥åƒä¸€ä¸ªçœŸæ­£çš„ç¬”è®°é¡µé¢ */
#char-memo-detail-content {
    background-color: var(--secondary-bg); /* èƒŒæ™¯è‰²ä¸å¤´éƒ¨ç»Ÿä¸€ï¼Œå½¢æˆæ•´ä½“æ„Ÿ */
    padding: 15px 20px; /* å¢åŠ é¡¶éƒ¨å’Œå·¦å³çš„å†…è¾¹è·ï¼Œè®©æ–‡å­—æœ‰å‘¼å¸ç©ºé—´ */
    font-size: 17px; /* ä»¿iOSå¤‡å¿˜å½•çš„å­—ä½“å¤§å° */
    line-height: 1.7; /* æ›´å®½æ¾çš„è¡Œé«˜ï¼Œæå‡é˜…è¯»ä½“éªŒ */
    color: var(--text-primary);
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Cphoneæ—¥è®°è¯¦æƒ…é¡µâ€œä¿¡çº¸â€æ ·å¼ â–¼â–¼â–¼ */

/* 1. è¯¦æƒ…é¡µä¸»å±å¹•ï¼Œä½¿ç”¨æŸ”å’Œçš„ç±³ç™½è‰²èƒŒæ™¯ */
#char-diary-detail-screen {
    background-color: #FDFBF5; /* æŸ”å’Œçš„ä¿¡çº¸åº•è‰² */
}

/* å¤œé—´æ¨¡å¼ä¸‹çš„é€‚é… */
#phone-screen.dark-mode #char-diary-detail-screen {
    background-color: #2c2c2e; /* æ·±è‰²èƒŒæ™¯ */
}

/* 2. ç§»é™¤å†…å®¹åŒºçš„é»˜è®¤å†…è¾¹è·ï¼Œè®©æˆ‘ä»¬çš„â€œä¿¡çº¸â€èƒ½æ’‘æ»¡ */
#char-diary-detail-content-wrapper {
    padding: 0;
    overflow-y: auto; /* ç¡®ä¿é•¿æ—¥è®°å¯ä»¥æ»šåŠ¨ */
}

/* 3. â€œä¿¡çº¸â€æœ¬èº«çš„æ ¸å¿ƒæ ·å¼ */
#char-diary-detail-content {
    padding: 25px 20px; /* åœ¨ä¿¡çº¸å››å‘¨ç•™å‡ºèˆ’é€‚çš„è¾¹è· */
    font-family: Georgia, 'Times New Roman', Times, serif; /* ä½¿ç”¨æ›´å…¸é›…çš„è¡¬çº¿å­—ä½“ */
    font-size: 16px;
    line-height: 1.8; /* æ›´å¤§çš„è¡Œé«˜ï¼Œæå‡é˜…è¯»æ„Ÿ */
    color: #383838; /* ä½¿ç”¨æ·±ç°è‰²æ–‡å­—ï¼Œæ¯”çº¯é»‘æ›´æŸ”å’Œ */
}

/* å¤œé—´æ¨¡å¼ä¸‹çš„æ–‡å­—é¢œè‰² */
#phone-screen.dark-mode #char-diary-detail-content {
    color: #e0e0e0;
}

/* 4. ä¸ºæ—¥è®°çš„ç¬¬ä¸€è¡Œï¼ˆé€šå¸¸æ˜¯æ ‡é¢˜ï¼‰è®¾ç½®ç‰¹æ®Šæ ·å¼ */
#char-diary-detail-content > p:first-of-type {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    text-align: center;
}

/* 5. ç¡®ä¿Markdownè½¬æ¢åçš„æ ‡ç­¾æ ·å¼æ­£ç¡® */
#char-diary-detail-content strong {
    font-weight: 600; /* åŠ ç²— */
}
#char-diary-detail-content .spoiler {
    /* è¿™é‡Œçš„æ ·å¼ä¸ä¸»èŠå¤©ç•Œé¢ä¿æŒä¸€è‡´ */
    background-color: #333;
    color: #333;
    padding: 0 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
#char-diary-detail-content .spoiler:hover {
    background-color: #e0e0e0;
    color: inherit;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ—¥è®°è¯¦æƒ…é¡µè‡ªå®šä¹‰Markdownæ ·å¼ â–¼â–¼â–¼ */

/* 0. å¼•å…¥å¤–éƒ¨æ‰‹å†™å­—ä½“ (Google Fonts) */
@import url('https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap');

/* 1. é»„è‰²èƒŒæ™¯é«˜äº® */
#char-diary-detail-content .diary-highlight {
    background-color: #FFFACD; /* æŸ æª¬ç»¸è‰²ï¼Œä¸€ç§æŸ”å’Œçš„é»„è‰² */
    padding: 1px 4px;
    border-radius: 3px;
    margin: 0 2px;
}

/* 2. ç²‰è‰²è™šçº¿ä¸‹åˆ’çº¿ */
#char-diary-detail-content .diary-underline {
    border-bottom: 2px dotted #FFB6C1; /* æµ…ç²‰è‰² */
    text-decoration: none; /* ç§»é™¤é»˜è®¤çš„å®çº¿ä¸‹åˆ’çº¿ */
    padding-bottom: 1px;
}

/* 3. ç²‰çº¢è‰²åŠ ç²—æ–‡å­— */
#char-diary-detail-content .diary-emphasis {
    color: #DB7093; /* ç°ç´«è‰² */
    font-weight: bold;
}

/* 4. æ‰‹å†™ä½“é»‘è‰²æ–‡å­— */
#char-diary-detail-content .diary-handwritten {
    font-family: 'Zhi Mang Xing', cursive; /* åº”ç”¨æ‰‹å†™å­—ä½“ */
    font-size: 1.1em; /* æ‰‹å†™ä½“ç¨å¾®å¤§ä¸€ç‚¹æ›´å¥½çœ‹ */
    color: #1a1a1a; /* æ¯”çº¯é»‘æ›´æŸ”å’Œçš„æ·±ç°è‰² */
}

/* 5. ç¨å¾®å€¾æ–œçš„æ‰‹å†™ä½“æ–‡å­— */
#char-diary-detail-content .diary-messy {
    font-family: 'Zhi Mang Xing', cursive;
    font-size: 1.1em;
    color: #1a1a1a;
    transform: rotate(-2deg); /* è½»å¾®æ—‹è½¬ */
    display: inline-block; /* æ—‹è½¬éœ€è¦ display å±æ€§é…åˆ */
    margin: 0 2px;
}

/* 6. è¢«æ¶‚é»‘çš„å†…å®¹ */
#char-diary-detail-content .diary-censored {
    background-color: #222;
    color: #222; /* è®©æ–‡å­—é¢œè‰²å’ŒèƒŒæ™¯è‰²ä¸€æ ·ï¼Œå®ç°æ¶‚é»‘æ•ˆæœ */
    user-select: none; /* é˜²æ­¢ç”¨æˆ·é€šè¿‡é€‰ä¸­æ¥æŸ¥çœ‹å†…å®¹ */
    padding: 0 3px;
    border-radius: 2px;
}

/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
.diary-censored:hover, .diary-censored:active {
  background-color: #E0E0E0; /* é¼ æ ‡æ‚¬åœæ—¶å˜æˆæµ…ç°è‰²èƒŒæ™¯ */
  color: inherit; /* æ¢å¤ä¸ºæ­£å¸¸çš„æ–‡å­—é¢œè‰² */
  cursor: pointer; /* é¼ æ ‡å˜ä¸ºå¯ç‚¹å‡»çš„æ‰‹å‹ */
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²é«˜å¾·åœ°å›¾åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. ä¸»å±å¹•èƒŒæ™¯è‰² */
#char-amap-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #char-amap-screen {
    background-color: #000000;
}

/* 2. è¶³è¿¹åˆ—è¡¨å®¹å™¨ */
#char-amap-list {
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 18px; /* å¢åŠ è¶³è¿¹ä¹‹é—´çš„é—´è· */
}

/* 3. å•ä¸ªè¶³è¿¹å¡ç‰‡ */
.char-amap-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    display: flex;
    flex-direction: column; /* è®©å†…å®¹å‚ç›´æ’åˆ— */
}

/* 4. å¡ç‰‡å¤´éƒ¨ (å›¾æ ‡ + åœ°ç‚¹ä¿¡æ¯) */
.amap-item-header {
    display: flex;
    align-items: flex-start; /* å›¾æ ‡å’Œæ–‡å­—é¡¶éƒ¨å¯¹é½ */
    gap: 12px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 12px;
    margin-bottom: 12px;
}

/* 5. åœ°ç‚¹å›¾æ ‡ */
.amap-item-icon {
    font-size: 24px;
    color: var(--accent-color);
    margin-top: 2px;
}

/* 6. åœ°ç‚¹ä¿¡æ¯ (æ ‡é¢˜ + åœ°å€) */
.amap-item-info {
    flex-grow: 1;
}
.amap-item-title {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 4px;
}
.amap-item-address {
    font-size: 13px;
    color: var(--text-secondary);
}

/* 7. å¡ç‰‡ä¸»ä½“ (è¯„è®º + å›¾ç‰‡) */
.amap-item-body {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.amap-item-comment {
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap; /* æ”¯æŒæ¢è¡Œ */
}

/* 8. è¶³è¿¹é™„å¸¦çš„å›¾ç‰‡ */
.amap-item-photo {
    width: 100%;
    height: 150px;
    border-radius: 8px;
    background-size: cover;
    background-position: center;
    cursor: pointer;
}

/* 9. å¡ç‰‡åº•éƒ¨ (æ—¶é—´æˆ³) */
.amap-item-footer {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 10px;
    text-align: right;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²Appä½¿ç”¨è®°å½•åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. åˆ—è¡¨å®¹å™¨ */
#char-usage-list {
    padding: 10px 0; /* ä¸Šä¸‹ç•™ç™½ï¼Œå·¦å³ç”±åˆ—è¡¨é¡¹æ§åˆ¶ */
}

/* 2. å•ä¸ªAppè®°å½•é¡¹ */
.char-usage-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px 20px;
    transition: background-color 0.2s;
}
.char-usage-item:hover {
    background-color: rgba(0,0,0,0.03);
}

/* 3. Appå›¾æ ‡ */
.usage-item-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px; /* iOSé£æ ¼çš„åœ†è§’çŸ©å½¢ */
    object-fit: cover;
    flex-shrink: 0;
    background-color: #e9ecef;
}

/* 4. ä¸­é—´ä¿¡æ¯åŒº (Appå + åˆ†ç±») */
.usage-item-info {
    flex-grow: 1; /* å æ®æ‰€æœ‰å‰©ä½™ç©ºé—´ */
}
.usage-item-name {
    font-weight: 500;
    font-size: 16px;
}
.usage-item-category {
    font-size: 12px;
    color: var(--text-secondary);
}

/* 5. å³ä¾§æ—¶é•¿æ˜¾ç¤º */
.usage-item-time {
    font-size: 15px;
    color: var(--text-secondary);
    font-weight: 500;
    flex-shrink: 0;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§’è‰²ç½‘æ˜“äº‘éŸ³ä¹åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. ä¸»å±å¹•èƒŒæ™¯è‰² */
#char-music-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #char-music-screen {
    background-color: #000000;
}

/* 2. æ­Œæ›²åˆ—è¡¨å®¹å™¨ */
#char-music-list {
    padding: 0;
}

/* 3. å•ä¸ªæ­Œæ›²åˆ—è¡¨é¡¹ (ä»¿ç½‘æ˜“äº‘é£æ ¼) */
.char-music-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.char-music-item:hover {
    background-color: rgba(0,0,0,0.03);
}

/* 4. æ­Œæ›²å°é¢ */
.music-item-cover {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}

/* 5. æ­Œæ›²ä¿¡æ¯ (æ­Œå + æ­Œæ‰‹) */
.music-item-info {
    flex-grow: 1;
    overflow: hidden; /* é˜²æ­¢é•¿æ–‡æœ¬æº¢å‡º */
}
.music-item-name {
    font-weight: 500;
    font-size: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.music-item-artist {
    font-size: 12px;
    color: var(--text-secondary);
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¿™æ˜¯ä½ è¦ã€æ·»åŠ ã€‘åˆ° <style> æ ‡ç­¾æœ«å°¾çš„ã€å…¨æ–°æ’­æ”¾å™¨CSSä»£ç ã€‘ â–¼â–¼â–¼ */

/* 1. æ’­æ”¾å™¨ä¸»çª—å£æ ·å¼ */
#char-music-player-modal .modal-content {
    width: 400px !important; /* å›ºå®šå®½åº¦ */
    height: auto !important; /* é«˜åº¦è‡ªé€‚åº” */
    max-height: 90vh;
    background-color: #f7f8fa !important; /* æµ…ç°è‰²èƒŒæ™¯ */
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important;
    color: #333 !important;
    display: flex;
    flex-direction: column;
}

/* 2. å¤´éƒ¨æ ‡é¢˜æ  */
#char-music-player-modal .char-player-header {
    flex-shrink: 0;
    padding: 12px 15px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
}
#char-music-player-modal .char-player-close-btn {
    background: none;
    border: none;
    font-size: 20px;
    color: #aaa;
    cursor: pointer;
}
#char-music-player-modal .char-player-close-btn:hover {
    color: #333;
}


/* 3. ä¸»å†…å®¹åŒºï¼ˆå°é¢ã€è¿›åº¦æ¡ã€æŒ‰é’®ï¼‰ */
#char-music-player-modal .char-player-body {
    padding: 30px 35px 20px 35px;
    text-align: center;
}
#char-music-player-modal #char-music-cover {
    width: 220px;
    height: 220px;
    border-radius: 10px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    margin-bottom: 20px;
    object-fit: cover;
}

/* 4. è¿›åº¦æ¡æ ·å¼ */
#char-music-player-modal .char-player-progress-bar-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}
#char-music-player-modal .char-player-progress-bar {
    flex-grow: 1;
    height: 4px;
    background-color: #e0e0e0;
    border-radius: 2px;
    cursor: pointer;
}
#char-music-player-modal #char-music-progress-fill {
    width: 0%;
    height: 100%;
    background-color: #555;
    border-radius: 2px;
}

/* 5. æ§åˆ¶æŒ‰é’®æ ·å¼ */
#char-music-player-modal .char-player-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
}
#char-music-player-modal .char-player-controls .control-btn {
    background: none;
    border: none;
    color: #555;
    cursor: pointer;
    transition: color 0.2s;
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
}
#char-music-player-modal .char-player-controls .control-btn:hover {
    color: #000;
}
#char-music-player-modal .char-player-controls .control-btn.play {
    width: 50px;
    height: 50px;
    background-color: #f0f1f3;
    border-radius: 50%;
    color: #333;
}
#char-music-player-modal .char-player-controls .control-btn.mode {
    font-size: 14px;
    font-weight: 500;
    width: 50px;
}

/* 6. æ­Œè¯åŒºåŸŸæ ·å¼ */
#char-music-player-modal #char-music-lyrics {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0 35px 25px 35px;
    font-size: 14px;
    line-height: 2;
    color: #888;
    text-align: center;
}
#char-music-player-modal #char-music-lyrics p.active {
    color: #000;
    font-weight: 600;
}

/* éšè—æ»šåŠ¨æ¡ */
#char-music-player-modal #char-music-lyrics::-webkit-scrollbar {
    display: none;
}
#char-music-player-modal #char-music-lyrics {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¿™æ˜¯ä½ è¦ã€æ·»åŠ ã€‘åˆ° <style> æ ‡ç­¾æœ«å°¾çš„ã€å…¨æ–°æ’­æ”¾å™¨CSS V3.0ã€‘ â–¼â–¼â–¼ */

/* 1. å®šä¹‰å”±ç‰‡æ—‹è½¬åŠ¨ç”» */
@keyframes spin-vinyl {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* 2. æ’­æ”¾å™¨ä¸»çª—å£æ ·å¼ */
#char-music-player-modal .modal-content {
    width: 340px !important; /* å®½åº¦é€‚ä¸­ */
    height: auto !important;
    background-color: #f0f1f3 !important; /* è½»æŸ”çš„ç°è‰²èƒŒæ™¯ */
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important;
    color: #333 !important;
    display: flex;
    flex-direction: column;
    padding: 20px; /* ç»Ÿä¸€å†…è¾¹è· */
    position: relative;
}

/* 3. ç§»é™¤æ—§çš„å¤´éƒ¨ï¼Œå› ä¸ºå…³é—­æŒ‰é’®å·²ç‹¬ç«‹ */
#char-music-player-modal .modal-header {
    display: none !important;
}

/* 4. å³ä¸Šè§’å…³é—­æŒ‰é’® */
#char-music-player-modal .char-player-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    font-weight: 300;
    color: #aaa;
    cursor: pointer;
    line-height: 1;
    z-index: 10;
}

/* 5. ä¸»å†…å®¹åŒº */
#char-music-player-modal .char-player-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-grow: 1;
}

/* 6. æ­Œæ›²ä¿¡æ¯ */
#char-music-player-modal .char-player-song-info {
    text-align: center;
    margin-bottom: 25px;
}
#char-music-player-modal #char-music-player-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0 0 5px 0;
}
#char-music-player-modal #char-music-artist {
    font-size: 14px;
    color: #888;
    margin: 0;
}

/* 7. é»‘èƒ¶å”±ç‰‡æ•ˆæœ */
#char-music-player-modal #char-vinyl-container {
    width: 210px;
    height: 210px;
    border-radius: 50%;
    background-color: #222;
    padding: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2), 
                inset 0 0 0 2px rgba(255, 255, 255, 0.05);
    background-image: repeating-radial-gradient(circle, #333, #333 1px, #222 1px, #222 2px);
    box-sizing: border-box;
    margin-bottom: 25px;
}
#char-music-player-modal #char-vinyl-container.spinning {
    animation: spin-vinyl 12s linear infinite;
}
#char-music-player-modal #char-music-cover {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* 8. æ­Œè¯å ä½ç¬¦ (éŸ³ç¬¦) */
#char-music-player-modal #char-lyric-placeholder {
    color: #aaa;
    font-size: 18px;
    letter-spacing: 5px;
    margin-bottom: 25px;
}

/* 9. åº•éƒ¨æ§åˆ¶æ  */
#char-music-player-modal .char-player-footer {
    width: 100%;
    margin-top: auto; /* å°†å…¶æ¨åˆ°åº•éƒ¨ */
}

/* 10. è¿›åº¦æ¡å’Œæ§åˆ¶æŒ‰é’® (ä¸ä¸Šä¸€ç‰ˆç±»ä¼¼ï¼Œä½†classå·²æ›´æ–°) */
#char-music-player-modal .char-player-progress-bar-container {
    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
#char-music-player-modal .char-player-progress-bar {
    flex-grow: 1; height: 4px; background-color: #e0e0e0; border-radius: 2px; cursor: pointer;
}
#char-music-player-modal #char-music-progress-fill {
    width: 0%; height: 100%; background-color: #555; border-radius: 2px;
}
#char-music-player-modal .char-player-controls {
    display: flex; align-items: center; justify-content: center; gap: 20px;
}
#char-music-player-modal .char-player-controls .control-btn {
    background: none; border: none; color: #555; cursor: pointer; transition: color 0.2s; padding: 5px;
    display: flex; align-items: center; justify-content: center;
}
#char-music-player-modal .char-player-controls .control-btn:hover { color: #000; }
#char-music-player-modal .char-player-controls .control-btn.play {
    width: 50px; height: 50px; background-color: #e0e1e3; border-radius: 50%; color: #333;
}
#char-music-player-modal .char-player-controls .control-btn.mode {
    font-size: 14px; font-weight: 500; width: 50px;
}
#char-music-player-modal #char-music-lyrics {
    display: none; /* åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å½»åº•éšè—æ­Œè¯åŒºåŸŸ */
}

/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¿™æ˜¯ä½ è¦ã€æ·»åŠ ã€‘åˆ° <style> æ ‡ç­¾æœ«å°¾çš„ã€å…¨æ–°æ’­æ”¾å™¨CSS V3.0ã€‘ â–¼â–¼â–¼ */

/* 1. å®šä¹‰å”±ç‰‡æ—‹è½¬åŠ¨ç”» */
@keyframes spin-vinyl {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* 2. æ’­æ”¾å™¨ä¸»çª—å£æ ·å¼ */
#char-music-player-modal .modal-content {
    width: 340px !important; /* å®½åº¦é€‚ä¸­ */
    height: auto !important;
    background-color: #f0f1f3 !important; /* è½»æŸ”çš„ç°è‰²èƒŒæ™¯ */
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important;
    color: #333 !important;
    display: flex;
    flex-direction: column;
    padding: 20px; /* ç»Ÿä¸€å†…è¾¹è· */
    position: relative;
}

/* 3. ç§»é™¤æ—§çš„å¤´éƒ¨ï¼Œå› ä¸ºå…³é—­æŒ‰é’®å·²ç‹¬ç«‹ */
#char-music-player-modal .modal-header {
    display: none !important;
}

/* 4. å³ä¸Šè§’å…³é—­æŒ‰é’® */
#char-music-player-modal .char-player-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    font-weight: 300;
    color: #aaa;
    cursor: pointer;
    line-height: 1;
    z-index: 10;
}

/* 5. ä¸»å†…å®¹åŒº */
#char-music-player-modal .char-player-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-grow: 1;
}

/* 6. æ­Œæ›²ä¿¡æ¯ */
#char-music-player-modal .char-player-song-info {
    text-align: center;
    margin-bottom: 25px;
}
#char-music-player-modal #char-music-player-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0 0 5px 0;
}
#char-music-player-modal #char-music-artist {
    font-size: 14px;
    color: #888;
    margin: 0;
}

/* 7. é»‘èƒ¶å”±ç‰‡æ•ˆæœ */
#char-music-player-modal #char-vinyl-container {
    width: 210px;
    height: 210px;
    border-radius: 50%;
    background-color: #222;
    padding: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2), 
                inset 0 0 0 2px rgba(255, 255, 255, 0.05);
    background-image: repeating-radial-gradient(circle, #333, #333 1px, #222 1px, #222 2px);
    box-sizing: border-box;
    margin-bottom: 25px;
}
#char-music-player-modal #char-vinyl-container.spinning {
    animation: spin-vinyl 12s linear infinite;
}
#char-music-player-modal #char-music-cover {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* 8. ã€æ ¸å¿ƒæ–°å¢ã€‘æ­Œè¯åŒºåŸŸæ ·å¼ */
#char-music-player-modal #char-music-lyrics {
    width: 100%;
    height: 50px; /* è®¾å®šä¸€ä¸ªå›ºå®šé«˜åº¦ï¼Œç”¨äºæ˜¾ç¤ºçº¦ä¸¤è¡Œæ­Œè¯ */
    overflow: hidden; /* éšè—è¶…å‡ºéƒ¨åˆ†çš„æ­Œè¯ */
    position: relative;
    margin-bottom: 25px;
    font-size: 14px;
    line-height: 25px; /* è®¾ç½®è¡Œé«˜ */
    color: #888;
    text-align: center;
    transition: all 0.3s ease;
}

#char-music-player-modal #char-music-lyrics p {
    margin: 0;
    transition: all 0.3s ease;
}

#char-music-player-modal #char-music-lyrics p.active {
    color: #000;
    font-weight: 600;
    font-size: 16px; /* å½“å‰è¡Œæ­Œè¯æ”¾å¤§ä¸€ç‚¹ */
}


/* 9. åº•éƒ¨æ§åˆ¶æ  */
#char-music-player-modal .char-player-footer {
    width: 100%;
    margin-top: auto; /* å°†å…¶æ¨åˆ°åº•éƒ¨ */
}

/* 10. è¿›åº¦æ¡å’Œæ§åˆ¶æŒ‰é’® */
#char-music-player-modal .char-player-progress-bar-container {
    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
#char-music-player-modal .char-player-progress-bar {
    flex-grow: 1; height: 4px; background-color: #e0e0e0; border-radius: 2px; cursor: pointer;
}
#char-music-player-modal #char-music-progress-fill {
    width: 0%; height: 100%; background-color: #555; border-radius: 2px;
}
#char-music-player-modal .char-player-controls {
    display: flex; align-items: center; justify-content: center; gap: 20px;
}
#char-music-player-modal .char-player-controls .control-btn {
    background: none; border: none; color: #555; cursor: pointer; transition: color 0.2s; padding: 5px;
    display: flex; align-items: center; justify-content: center;
}
#char-music-player-modal .char-player-controls .control-btn:hover { color: #000; }
#char-music-player-modal .char-player-controls .control-btn.play {
    width: 50px; height: 50px; background-color: #e0e1e3; border-radius: 50%; color: #333;
}
#char-music-player-modal .char-player-controls .control-btn.mode {
    font-size: 14px; font-weight: 500; width: 50px;
}

/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
#chat-list .chat-list-item {
    /* æ ¸å¿ƒ1ï¼šå¼ºåˆ¶ä½¿ç”¨ gap å±æ€§æ¥æ§åˆ¶é—´è·ï¼Œå¹¶è¦†ç›–æ—§æœ‰å†²çª */
    gap: 15px !important;
    /* ç¡®ä¿æ²¡æœ‰å…¶ä»–å¯¹é½æ–¹å¼å¹²æ‰° */
    justify-content: flex-start !important;
}

#chat-list .chat-list-item .avatar-group {
    /* æ ¸å¿ƒ2ï¼šå¼ºåˆ¶ç§»é™¤ä¹‹å‰ç”¨äºé—´è·çš„ marginï¼Œç°åœ¨å®Œå…¨ç”± gap æ§åˆ¶ */
    margin-right: 0 !important;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | ä»¿è±†ç“£UIã€‘è±†ç“£å°ç»„åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. è±†ç“£ä¸»é¢˜è‰²ä¸é¡µé¢èƒŒæ™¯ */
#douban-screen {
    background-color: #F6F6F1; /* è±†ç“£ç»å…¸çš„ç±³è‰²èƒŒæ™¯ */
}
#phone-screen.dark-mode #douban-screen {
    background-color: #1a1a1a;
}
#douban-posts-list {
    padding: 0; /* åˆ—è¡¨æœ¬èº«ä¸éœ€è¦å†…è¾¹è· */
    display: flex;
    flex-direction: column;
}

/* 2. å¸–å­å¡ç‰‡ç¾åŒ– (V2.0) */
.douban-post-item {
    background-color: var(--secondary-bg);
    padding: 12px 15px;
    border: none;
    box-shadow: none;
    border-bottom: 1px solid var(--border-color); /* ç”¨åˆ†å‰²çº¿ä»£æ›¿è¾¹æ¡† */
    cursor: pointer;
    transition: background-color 0.2s;
}
.douban-post-item:hover {
    background-color: #f9f9f9;
}
#phone-screen.dark-mode .douban-post-item:hover {
    background-color: #2c2c2e;
}

/* 3. å¸–å­å¤´éƒ¨ (å¤´åƒã€æ˜µç§°ã€å°ç»„å) */
.douban-post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}
.douban-post-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
}
.douban-author-info {
    flex-grow: 1;
}
.douban-author-name {
    font-weight: 500;
    color: var(--text-primary);
    font-size: 14px;
}
.douban-group-name {
    font-size: 12px;
    color: #007722; /* è±†ç“£æ ‡å¿—æ€§çš„ç»¿è‰² */
    font-weight: 500;
}

/* 4. å¸–å­æ ‡é¢˜å’Œå†…å®¹é¢„è§ˆ */
.douban-post-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
}
.douban-post-content {
    font-size: 14px;
    color: #555;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
#phone-screen.dark-mode .douban-post-content {
    color: #dcdcdc;
}

/* 5. å¸–å­åº•éƒ¨ (ç»Ÿè®¡æ•°æ®) */
.douban-post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-secondary);
}
.douban-post-actions {
    display: flex;
    gap: 20px;
}
.douban-post-actions span {
    display: flex;
    align-items: center;
    gap: 6px; /* å¢åŠ å›¾æ ‡å’Œæ•°å­—ä¹‹é—´çš„é—´è· */
    color: var(--text-secondary); /* ç¡®ä¿é¢œè‰²ç»Ÿä¸€ */
}
/* ã€æ ¸å¿ƒæ–°å¢ã€‘ä¸ºSVGå›¾æ ‡è®¾ç½®ç»Ÿä¸€æ ·å¼ */
.douban-post-actions svg {
    width: 18px;
    height: 18px;
    fill: currentColor; /* è®©å›¾æ ‡é¢œè‰²è·Ÿéšçˆ¶å…ƒç´ çš„æ–‡å­—é¢œè‰² */
    position: relative;
    top: -1px; /* ä½ç½®å¾®è°ƒï¼Œä½¿å…¶ä¸æ•°å­—æ›´å¯¹é½ */
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾½æ¯›ç¬”å›¾æ ‡æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */
.douban-feather-btn {
    /* 1. åŸºç¡€æ ·å¼ (å¤ç”¨ä¸»èŠå¤©ç•Œé¢çš„åœ†å½¢æŒ‰é’®) */
    font-size: 24px;
    padding: 0;
    width: 38px;
    height: 38px;
    line-height: 38px;
    text-align: center;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    margin-right: 8px; /* å’Œå‘é€æŒ‰é’®æ‹‰å¼€è·ç¦» */

    /* 2. å¤–è§‚ (ä»¿iOSé£æ ¼çš„æµ…ç°è‰²) */
    background-color: #f0f2f5;
    color: #555;
    transition: background-color 0.2s;
}
.douban-feather-btn:hover {
    background-color: #e2e6ea;
}
.douban-feather-btn svg {
    width: 20px;
    height: 20px;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* 6. ã€V2.2 | æœ€ç»ˆå¸ƒå±€ä¿®å¤ç‰ˆã€‘å¸–å­è¯¦æƒ…é¡µ */

#douban-post-detail-screen {
    background-color: #F6F6F1; /* å¤–éƒ¨ç±³è‰²èƒŒæ™¯ */
}
#phone-screen.dark-mode #douban-post-detail-screen {
    background-color: #1a1a1a;
}

/* ã€æ ¸å¿ƒä¿®å¤1ã€‘é‡ç½®å¤–éƒ¨å®¹å™¨çš„å†…è¾¹è·ï¼Œè®©ç™½è‰²èƒŒæ™¯èƒ½æ’‘æ»¡å…¨å± */
#douban-detail-content-wrapper {
    background-color: var(--secondary-bg);
    padding: 0; /* ç§»é™¤å¯¼è‡´ä¸¤ä¾§ç©ºç™½çš„å†…è¾¹è· */
    padding-bottom: 80px; /* åªä¿ç•™åº•éƒ¨çš„ç©ºé—´ç»™è¾“å…¥æ¡† */
}

/* ã€æ ¸å¿ƒä¿®å¤2ã€‘å°†è¾¹è·åº”ç”¨åˆ°å†…éƒ¨çš„æ­£æ–‡åŒºåŸŸ */
#douban-post-detail-body {
    padding: 20px 18px 25px 18px; /* åœ¨å†…å®¹å››å‘¨ç•™å‡ºå‘¼å¸ç©ºé—´ */
    border-bottom: 1px solid #f0f0f0;
}
#phone-screen.dark-mode #douban-post-detail-body {
    border-bottom-color: #38383a;
}

/* ç¾åŒ–å¸–å­æ ‡é¢˜ */
.douban-post-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
    line-height: 1.5;
}

/* ä¼˜åŒ–æ­£æ–‡é˜…è¯»ä½“éªŒ */
.douban-detail-content {
    white-space: pre-wrap;
    line-height: 1.8;
    font-size: 15px;
    color: #333;
}
#phone-screen.dark-mode .douban-detail-content {
    color: #dcdcdc;
}

/* ã€æ ¸å¿ƒä¿®å¤3ã€‘å°†è¾¹è·ä¹Ÿåº”ç”¨åˆ°è¯„è®ºåŒºï¼Œå¹¶ç§»é™¤ä¸æ­£æ–‡çš„é—´è· */
.douban-comments-section {
    margin-top: 0;
    padding: 15px 18px;
}

/* ä¸ºâ€œå›åº”â€å¢åŠ æ ‡é¢˜æ ·å¼ */
.douban-comments-section h4 {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    margin: 0 0 15px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}
#phone-screen.dark-mode .douban-comments-section h4 {
    border-bottom-color: #38383a;
}

/* ç¾åŒ–å•æ¡è¯„è®º */
.douban-comment-item {
    display: flex;
    gap: 12px;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}
.douban-comment-item:last-child {
    border-bottom: none;
}
#phone-screen.dark-mode .douban-comment-item {
    border-bottom-color: #38383a;
}

.douban-comment-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    flex-shrink: 0;
}
.douban-comment-body {
    flex-grow: 1;
}
.douban-comment-author {
    font-weight: 500;
    font-size: 14px;
    color: var(--text-primary);
}
.douban-comment-text {
    font-size: 14px;
    color: #555;
    margin-top: 6px;
    line-height: 1.7;
    word-break: break-word;
}
#phone-screen.dark-mode .douban-comment-text {
    color: #b0b0b0;
}

/* 7. ã€V2.2 | æœ€ç»ˆå¸ƒå±€ä¿®å¤ç‰ˆã€‘è¯¦æƒ…é¡µåº•éƒ¨è¯„è®ºè¾“å…¥æ  */
#douban-comment-footer {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    
    /* ã€æ ¸å¿ƒä¿®å¤1ã€‘å¢åŠ ä¸Šä¸‹å·¦å³çš„å†…è¾¹è·ï¼Œè§£å†³è´´è¾¹é—®é¢˜ */
    padding: 10px 18px; 
    
    /* ã€æ ¸å¿ƒä¿®å¤2ã€‘ä¿ç•™å¯¹iPhoneåº•éƒ¨å®‰å…¨åŒºåŸŸçš„é€‚é… */
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    
    /* ã€æ ¸å¿ƒä¿®å¤3ã€‘ç¡®ä¿ padding ä¸ä¼šæ’‘ç ´å¸ƒå±€ */
    box-sizing: border-box; 
    
    /* (å…¶ä»–æ ·å¼ä¿æŒä¸å˜) */
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color); /* åœ¨é¡¶éƒ¨ä¹ŸåŠ ä¸€æ¡åˆ†å‰²çº¿ï¼Œæ›´ç²¾è‡´ */
}
#douban-send-comment-btn {
    background-color: #007722; /* è±†ç“£ç»¿ */
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ | V3.0ã€‘è±†ç“£å¤´éƒ¨æŒ‰é’®æ˜¾ç¤ºç»ˆæè§£å†³æ–¹æ¡ˆ â–¼â–¼â–¼ */

/* 1. ç¡®ä¿å³ä¾§çš„æŒ‰é’®å®¹å™¨æœ¬èº«ä¸ä¼šè¢«æ„å¤–å‹ç¼© */
#douban-screen .header .header-actions {
    flex-shrink: 0;
    display: flex;       /* ç¡®ä¿å®ƒæ˜¯ä¸€ä¸ªflexå®¹å™¨ */
    align-items: center; /* å‚ç›´å±…ä¸­å†…éƒ¨çš„å›¾æ ‡ */
}

/* 2. ã€æ ¸å¿ƒä¿®å¤ã€‘ä¸ºæ‰€æœ‰å¤´éƒ¨æ“ä½œæŒ‰é’®å†…çš„SVGå›¾æ ‡è®¾ç½®ä¸€ä¸ªå›ºå®šçš„ã€ç»Ÿä¸€çš„å°ºå¯¸ */
.header .action-btn svg {
    width: 24px;   /* ç¡®ä¿å°ºå¯¸ç»Ÿä¸€ */
    height: 24px;
    display: block; /* ç§»é™¤SVGå¯èƒ½å¸¦æœ‰çš„é¢å¤–åº•éƒ¨ç©ºé—´ */
}

/* 3. ä¸ºæ‰€æœ‰æ“ä½œæŒ‰é’®è®¾ç½®ä¸€ä¸ªæœ€å°å®½åº¦ï¼Œä¿è¯å®ƒä»¬ä¸ä¼šè¢«æŒ¤å‹å¾—è¿‡å° */
.header .action-btn {
    min-width: 30px; /* ç»™äºˆæ¯ä¸ªæŒ‰é’®è¶³å¤Ÿçš„ç‚¹å‡»åŒºåŸŸ */
    display: flex;
    align-items: center;
    justify-content: center;
}
/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ç”¨äºå¯¹é½å¤´éƒ¨å·¦ä¾§æŒ‰é’®çš„æ ·å¼ â–¼â–¼â–¼ */
.header .header-left-actions {
    display: flex;
    align-items: center;
    gap: 15px; /* (å¯é€‰) åœ¨è¿”å›ã€å¯¼å…¥ã€å¯¼å‡ºæŒ‰é’®ä¹‹é—´å¢åŠ ä¸€äº›é—´è· */
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œè§’è‰²ç›¸å†Œç”Ÿå›¾å…³é—­â€åŠŸèƒ½æ·»åŠ çš„æ ·å¼ â–¼â–¼â–¼ */

        /* 1. è®©ç›¸å†Œæ ¼å­æˆä¸º Flex å®¹å™¨ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½æ–¹ä¾¿åœ°å±…ä¸­å†…éƒ¨çš„æ–‡å­— */
        .char-photo-item {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px; /* åœ¨æ–‡å­—å‘¨å›´ç•™å‡ºä¸€ç‚¹å†…è¾¹è·ï¼Œé¿å…è´´è¾¹ */
            box-sizing: border-box;
        }
        
        /* 2. ç…§ç‰‡æè¿°æ–‡å­—æœ¬èº«çš„æ ·å¼ */
        .char-photo-description {
            font-size: 13px;
            color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰²ï¼Œçœ‹èµ·æ¥æ›´æŸ”å’Œ */
            text-align: center;
            line-height: 1.5;
        
            /* æ ¸å¿ƒï¼šè¿™æ˜¯ä¸€ä¸ªå®ç°â€œå¤šè¡Œçœç•¥å·â€çš„æŠ€å·§ï¼Œé˜²æ­¢è¿‡é•¿çš„æè¿°æ’‘ç ´å¸ƒå±€ */
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 5; /* æœ€å¤šæ˜¾ç¤º5è¡Œ */
            overflow: hidden;
            word-break: break-all; /* ç¡®ä¿é•¿å•è¯æˆ–URLä¹Ÿèƒ½è¢«æˆªæ–­ */
        }
        
        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
        /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºæ·˜å®/æµè§ˆå™¨ç”Ÿå›¾å…³é—­åŠŸèƒ½æ·»åŠ çš„æ ·å¼ â–¼â–¼â–¼ */

        /* 1. ä¸ºæ·˜å®å•†å“å¡ç‰‡ä¸Šçš„æ–‡å­—æè¿°åˆ›å»ºä¸€ä¸ªå®¹å™¨ */
        .char-product-description-overlay {
            width: 100%;
            aspect-ratio: 1 / 1; /* ä¸å›¾ç‰‡ä¿æŒç›¸åŒçš„æ­£æ–¹å½¢æ¯”ä¾‹ï¼Œç¡®ä¿ç½‘æ ¼å¸ƒå±€ä¸ä¹± */
            background-color: #f7f8fa; /* æŸ”å’Œçš„èƒŒæ™¯è‰² */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px; /* å†…è¾¹è· */
            box-sizing: border-box;
            border-bottom: 1px solid #eee; /* åœ¨æè¿°å’Œå•†å“ä¿¡æ¯ä¹‹é—´åŠ ä¸€æ¡åˆ†å‰²çº¿ */
            border-radius: 8px 8px 0 0; /* åŒ¹é…å›¾ç‰‡çš„é¡¶éƒ¨åœ†è§’ */
        }

        /* 2. æè¿°æ–‡å­—æœ¬èº«çš„æ ·å¼ (å¤ç”¨ç›¸å†Œçš„æ ·å¼ï¼Œå¹¶è®©æµè§ˆå™¨ä¹Ÿä½¿ç”¨) */
        .char-product-description-overlay .char-photo-description,
        .char-browser-image-description { 
            font-size: 14px; /* å­—ä½“å¯ä»¥ç¨å¾®å¤§ä¸€ç‚¹ */
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 6; /* æœ€å¤šæ˜¾ç¤º6è¡Œ */
            overflow: hidden;
            word-break: break-all;
        }

        /* 3. ä¸ºæµè§ˆå™¨ä¸­çš„å›¾ç‰‡æè¿°åˆ›å»ºä¸€ä¸ªå®¹å™¨ */
        .char-browser-image-description {
            padding: 40px 20px; /* ä¸Šä¸‹ç•™å‡ºæ›´å¤šç©ºé—´ */
        }

        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºè§’è‰²æ·˜å®è®¢å•çŠ¶æ€æ·»åŠ çš„æ ·å¼ â–¼â–¼â–¼ */
.char-product-status {
    font-size: 12px;
    color: #8a8a8a; /* ä½¿ç”¨æŸ”å’Œçš„ç°è‰² */
    background-color: #f0f2f5; /* ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯ */
    padding: 3px 8px;
    border-radius: 10px;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² *
/* 1. æœç´¢å±å¹•çš„èƒŒæ™¯è‰² */
#search-history-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #search-history-screen {
    background-color: #000000;
}

/* 2. æœç´¢ç»“æœåˆ—è¡¨ï¼Œç¡®ä¿å¯ä»¥æ»šåŠ¨ */
#search-results-list {
    flex-grow: 1;
    overflow-y: auto;
}

/* 3. æ—¥æœŸåˆ†éš”ç¬¦çš„æ ·å¼ */
.date-separator {
    text-align: center;
    color: var(--text-secondary);
    font-size: 12px;
    padding: 10px 0;
    font-weight: 500;
}

/* 4. å¤œé—´æ¨¡å¼ä¸‹çš„è¾“å…¥æ¡†é€‚é… */
#phone-screen.dark-mode #search-bar input {
    background-color: #1c1c1e;
    color: #ffffff;
    border-color: #38383a;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸»å±å¹•åˆ†é¡µåŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

        /* 1. è®©ä¸»å±å¹•æˆä¸ºFlexå®¹å™¨ï¼Œä½†æ–¹å‘æ”¹ä¸ºæ°´å¹³ï¼Œä¸ºç¿»é¡µåšå‡†å¤‡ */
        #home-screen {
            flex-direction: column;
            padding: 0; /* ç§»é™¤æ—§çš„å†…è¾¹è·ï¼Œç”±å†…éƒ¨é¡µé¢è‡ªå·±æ§åˆ¶ */
        }

        /* 2. é¡µé¢å®¹å™¨ï¼Œè´Ÿè´£æ¨ªå‘æ’åˆ—æ‰€æœ‰é¡µé¢ */
        #home-screen-pages-container {
            flex-grow: 1; /* å æ®é™¤äº†Dockæ å¤–çš„æ‰€æœ‰ç©ºé—´ */
            width: 100%;
            overflow: hidden; /* éšè—æ¨ªå‘æ»šåŠ¨æ¡ */
            position: relative;
        }

        #home-screen-pages {
            display: flex;
            width: 200%; /* å‡è®¾æœ‰ä¸¤é¡µï¼Œå®½åº¦è®¾ä¸º200% */
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* å¹³æ»‘çš„ç¿»é¡µåŠ¨ç”» */
        }

        /* 3. å•ä¸ªé¡µé¢çš„æ ·å¼ */
        .home-screen-page {
            width: 50%; /* æ¯é¡µå æ®ä¸€åŠå®½åº¦ */
            height: 100%;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-bottom: 0; /* åº•éƒ¨ç”±åˆ†é¡µæŒ‡ç¤ºå™¨æ§åˆ¶ */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 4. åˆ†é¡µæŒ‡ç¤ºå™¨ (å°åœ†ç‚¹) */
        #home-screen-pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 10px 0;
             /* é€‚é…iPhoneåº•éƒ¨å®‰å…¨åŒº */
            padding-bottom: calc(10px + env(safe-area-inset-bottom) / 2);
            flex-shrink: 0;
        }

        .pagination-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
        }

        .pagination-dot.active {
            background-color: white;
            transform: scale(1.1);
        }
        
        /* 5. ç¬¬äºŒé¡µçš„Appç½‘æ ¼å®¹å™¨ */
        #page-2-app-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr; /* æ¯è¡Œ4ä¸ªå›¾æ ‡ */
            gap: 20px;
            width: 100%;
            padding-top: 40px; /* ä¸é¡¶éƒ¨ç•™å‡ºä¸€äº›è·ç¦» */
        }
        /* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©å·¥å…·æ æŒ‰é’®æ’åºåŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
.draggable-button-item {
    padding: 8px 12px;
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    cursor: grab;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s, box-shadow 0.2s;
    user-select: none;
}
.draggable-button-item:active {
    cursor: grabbing;
}
.draggable-button-item svg {
    width: 18px;
    height: 18px;
    stroke-width: 2;
}
/* å½“ä¸€ä¸ªå…ƒç´ æ­£åœ¨è¢«æ‹–åŠ¨æ—¶åº”ç”¨çš„æ ·å¼ */
.draggable-button-item.dragging {
    opacity: 0.5;
    background-color: #e0e0e0;
}
/* å½“æ‹–åŠ¨çš„å…ƒç´ æ‚¬åœåœ¨å¦ä¸€ä¸ªå…ƒç´ ä¸Šæ–¹æ—¶ï¼Œä¸ºé‚£ä¸ªå…ƒç´ åº”ç”¨çš„æ ·å¼ */
.draggable-button-item.drag-over {
    background-color: #d0eaff;
    box-shadow: 0 0 0 2px var(--accent-color);
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–° | ç§»åŠ¨ç«¯å…¼å®¹ã€‘ä¸ºæ‹–åŠ¨è¿‡ç¨‹æ·»åŠ çš„æ ·å¼ â–¼â–¼â–¼ */

/* å½“ä¸€ä¸ªå…ƒç´ æ­£åœ¨è¢«æ‹–åŠ¨æ—¶åº”ç”¨çš„æ ·å¼ */
.draggable-button-item.dragging {
    opacity: 0.5;
    background-color: #e0e0e0;
    /* æ ¸å¿ƒï¼šè®©è¢«æ‹–åŠ¨çš„å…ƒç´ â€œæµ®â€èµ·æ¥ï¼Œä¸ä¼šå½±å“å…¶ä»–å…ƒç´ çš„å¸ƒå±€ */
    position: relative; 
    z-index: 10;
}

/* é˜²æ­¢åœ¨æ‰‹æœºä¸Šæ‹–åŠ¨æ—¶ï¼Œæ„å¤–é€‰ä¸­é¡µé¢ä¸Šçš„æ–‡å­— */
#button-order-editor {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºå¼¹çª—å†…å¯æ»šåŠ¨é•¿æ–‡æœ¬æ·»åŠ çš„æ ·å¼ â–¼â–¼â–¼ */
.scrollable-content-preview {
    /* æ ¸å¿ƒ1ï¼šè®¾ç½®ä¸€ä¸ªæœ€å¤§é«˜åº¦ã€‚å†…å®¹è¶…å‡ºè¿™ä¸ªé«˜åº¦å°±ä¼šè§¦å‘æ»šåŠ¨ã€‚
       35vh è¡¨ç¤ºè§†çª—é«˜åº¦çš„35%ï¼Œè¿™æ˜¯ä¸€ä¸ªçµæ´»çš„é«˜åº¦ï¼Œèƒ½é€‚åº”ä¸åŒå±å¹•ã€‚*/
    max-height: 35vh;
    
    /* æ ¸å¿ƒ2ï¼šå½“å†…å®¹å‚ç›´æ–¹å‘æº¢å‡ºæ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºæ»šåŠ¨æ¡ã€‚ */
    overflow-y: auto;
    
    /* (å¯é€‰) ç¾åŒ–æ ·å¼ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´åƒä¸€ä¸ªä»£ç /å¼•ç”¨å— */
    background-color: #f0f2f5;
    padding: 10px 15px;
    border-radius: 8px;
    text-align: left;
    white-space: pre-wrap; /* ä¿æŒæ–‡æœ¬ä¸­çš„æ¢è¡Œ */
    border: 1px solid var(--border-color);
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é«˜çº§æ•°æ®æ¸…ç†å‘å¯¼æ ·å¼ â–¼â–¼â–¼ */
.wizard-step {
    display: none; /* é»˜è®¤éšè—æ‰€æœ‰æ­¥éª¤ */
    flex-direction: column;
    width: 100%;
    height: 100%;
}

.wizard-step.active {
    display: flex; /* åªæ˜¾ç¤ºæ¿€æ´»çš„æ­¥éª¤ */
}

/* å¤ç”¨ç°æœ‰çš„åˆ—è¡¨é¡¹æ ·å¼ï¼Œä¸ºå…¶æ·»åŠ ä¸€ç‚¹å†…è¾¹è· */
#data-clear-char-list .clear-posts-item,
#data-clear-type-list .clear-posts-item {
    padding: 12px 18px;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºæ¸…ç†å‘å¯¼æ·»åŠ â€œå…¨é€‰â€æ ·å¼ â–¼â–¼â–¼ */
#data-clear-wizard-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#data-clear-wizard-modal .modal-header label {
    font-size: 14px;
    font-weight: normal;
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ•™ç¨‹é¡µé¢æ ·å¼ â–¼â–¼â–¼ */
#tutorial-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #tutorial-screen {
    background-color: #000000;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é¢„è®¾ç¼–è¾‘å™¨å†…å®¹æŠ˜å åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */
.entry-content-container {
    display: none; /* é»˜è®¤éšè—å†…å®¹åŒºåŸŸ */
    margin-top: 8px; /* å’Œä¸Šæ–¹çš„æ ‡ç­¾æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
}
.toggle-content-btn {
    background: none;
    border: 1px solid #ccc;
    color: var(--text-secondary);
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 5px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ›´æ–°é€šçŸ¥å¼¹çª—çš„æ ·å¼ â–¼â–¼â–¼ */
#update-notice-modal {
    position: fixed; /* å›ºå®šå®šä½ï¼Œè¦†ç›–åœ¨æ‰€æœ‰å†…å®¹ä¹‹ä¸Š */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    display: none; /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
    z-index: 2000; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
    opacity: 0;
    transition: opacity 0.3s ease;
}
#update-notice-modal.visible {
    display: flex;
    opacity: 1;
}
.update-notice-content {
    background-color: #fff;
    width: 300px;
    border-radius: 14px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
#update-notice-modal.visible .update-notice-content {
    transform: scale(1);
}
.update-notice-body {
    padding: 20px;
    font-size: 15px;
    line-height: 1.6;
    color: #333;
    
    /* --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œ â–¼â–¼â–¼ --- */

    /* 1. è®¾ç½®ä¸€ä¸ªæœ€å¤§é«˜åº¦ã€‚æˆ‘ä»¬ä½¿ç”¨ vh (è§†çª—é«˜åº¦) å•ä½ï¼Œ
       è®©å¼¹çª—æœ€å¤§ä¸è¶…è¿‡å±å¹•é«˜åº¦çš„60%ï¼Œä»¥é€‚åº”ä¸åŒå°ºå¯¸çš„æ‰‹æœºã€‚ */
    max-height: 60vh; 
    
    /* 2. å½“å†…å®¹è¶…å‡ºè¿™ä¸ªæœ€å¤§é«˜åº¦æ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ã€‚ */
    overflow-y: auto; 

    /* --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² --- */
}
.update-notice-footer {
    border-top: 1px solid #dbdbdb;
    display: flex;
}
.update-notice-footer button {
    flex: 1;
    background: none;
    border: none;
    padding: 14px;
    font-size: 17px;
    cursor: pointer;
    color: var(--accent-color);
}
.update-notice-footer button:first-child {
    border-right: 1px solid #dbdbdb;
    font-weight: 600;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–° | ä¿æŒæ¨ªå‘å¸ƒå±€ã€‘è¿™æ˜¯ä¿®å¤é•¿æŒ‰èœå•æˆªæ–­é—®é¢˜çš„æœ€ç»ˆç‰ˆæ ·å¼ â–¼â–¼â–¼ */

/* 1. æ ¸å¿ƒä¿®æ”¹ï¼šè®©æŒ‰é’®å®¹å™¨æ”¯æŒæ¢è¡Œ */
#message-actions-modal .custom-modal-footer {
    flex-wrap: wrap; /* å…è®¸é¡¹ç›®æ¢è¡Œ */
    padding: 10px;   /* åœ¨å®¹å™¨å‘¨å›´å¢åŠ ä¸€äº›å†…è¾¹è·ï¼Œè®©å¸ƒå±€æ›´èˆ’å±• */
    gap: 10px;       /* åœ¨æŒ‰é’®ä¹‹é—´å¢åŠ é—´è· */
    justify-content: flex-start; /* è®©æŒ‰é’®ä»å·¦ä¾§å¼€å§‹æ’åˆ— */
}

/* 2. ä¸ºæ¯ä¸€ä¸ªæ“ä½œæŒ‰é’®ï¼ˆé™¤äº†å–æ¶ˆæŒ‰é’®ï¼‰è®¾ç½®å°ºå¯¸å’Œæ ·å¼ */
#message-actions-modal .custom-modal-footer button:not(#cancel-message-action-btn) {
    /* æ ¸å¿ƒä¿®æ”¹ï¼šä¸å†å¹³åˆ†å®½åº¦ï¼Œè€Œæ˜¯å…è®¸å®ƒä»¬æ ¹æ®å†…å®¹ç”Ÿé•¿ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªåŸºç¡€å®½åº¦ */
    flex-grow: 1;
    flex-basis: 75px; /* æ¯ä¸ªæŒ‰é’®çš„åŸºç¡€å®½åº¦ï¼Œç¡®ä¿è‡³å°‘èƒ½å®¹çº³4ä¸ªå­— */
    
    /* (å¯é€‰ä½†æ¨è) ç»Ÿä¸€æŒ‰é’®å¤–è§‚ï¼Œä½¿å…¶æ›´åƒä¸€ä¸ªç½‘æ ¼ */
    border: none;
    background-color: #f0f2f5;
    border-radius: 8px;
    padding: 12px 5px; /* è°ƒæ•´å†…è¾¹è·ï¼Œè®©æ–‡å­—å±…ä¸­ */
    font-size: 16px;
    font-weight: 500;
}

/* 3. è®©â€œå–æ¶ˆâ€æŒ‰é’®å•ç‹¬å æ®ä¸€æ•´è¡Œï¼Œå¹¶æ¢å¤å…¶ç‹¬ç«‹æ ·å¼ */
#message-actions-modal #cancel-message-action-btn {
    width: 100%; /* å¼ºåˆ¶å®½åº¦ä¸º100% */
    flex-basis: 100%; /* åœ¨flexå¸ƒå±€ä¸­ä¹Ÿç¡®ä¿å®ƒå æ»¡ä¸€è¡Œ */
    margin-top: 8px;
    border-radius: 8px;
    background-color: #f0f2f5;
    font-weight: 600;
}
/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* ä¿®å¤iOSè¾“å…¥æ¡†è‡ªåŠ¨æ”¾å¤§é—®é¢˜ (å¼ºåˆ¶ç‰ˆ) */
input, textarea, select {
    font-size: 16px !important;
}
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºæ—¥è®°æ”¶è—åŠŸèƒ½æ·»åŠ çš„æ ·å¼ â–¼â–¼â–¼ */

/* æ”¶è—æŒ‰é’®æ¿€æ´»æ—¶çš„æ ·å¼ï¼ˆå¡«å……é»„è‰²ï¼‰ */
#favorite-diary-btn.active svg {
    fill: #ffc107; /* æ‚¨å¯ä»¥æ¢æˆä»»ä½•æ‚¨å–œæ¬¢çš„é¢œè‰² */
    color: #ffc107;
}

/* æ”¶è—å¡ç‰‡ä¸­æ—¥è®°æ ‡é¢˜çš„æ ·å¼ */
.favorite-item-card .diary-title {
    font-weight: 600;
    display: block;
    margin-bottom: 8px;
    font-size: 15px;
}

/* æ”¶è—å¡ç‰‡ä¸­æ—¥è®°å†…å®¹é¢„è§ˆçš„æ ·å¼ */
.favorite-item-card .diary-content-preview {
    font-size: 13px;
    opacity: 0.8;
    line-height: 1.6;
    
    /* å¤šè¡Œçœç•¥å·æ•ˆæœ */
    display: -webkit-box;
    -webkit-line-clamp: 3; /* æœ€å¤šæ˜¾ç¤º3è¡Œ */
    -webkit-box-orient: vertical;
    overflow: hidden;
}
/* â–¼â–¼â–¼ æŠŠè¿™æ®µCSSä»£ç ã€å®Œå…¨åˆ é™¤ã€‘â–¼â–¼â–¼ */
.favorite-item-card .diary-content-preview {
    font-size: 13px;
    opacity: 0.8;
    line-height: 1.6;
    
    /* å¤šè¡Œçœç•¥å·æ•ˆæœ */
    display: -webkit-box;
    -webkit-line-clamp: 3; /* æœ€å¤šæ˜¾ç¤º3è¡Œ */
    -webkit-box-orient: vertical;
    overflow: hidden;
}
/* â–²â–²â–² åˆ é™¤åˆ°è¿™é‡Œç»“æŸ â–²â–²â–² */
#npc-list-view {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #npc-list-view {
    background-color: #000;
}
 Â  Â  Â  /* æ‚¬æµ®X Logoæ ·å¼ */
Â  Â  Â  Â  #floating-x-logo {
Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  Â  Â  width: 50px;
Â  Â  Â  Â  Â  height: 50px;
Â  Â  Â  Â  Â  background: linear-gradient(135deg, #1d9bf0 0%, #0ea5ff 100%);
Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  box-shadow: 0 4px 20px rgba(29, 155, 240, 0.3);
Â  Â  Â  Â  Â  z-index: 999;
Â  Â  Â  Â  Â  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
Â  Â  Â  Â  }

Â  Â  Â  Â  .floating-x-hidden {
Â  Â  Â  Â  Â  transform: translateY(-50%) translateX(100px);
Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  .floating-x-visible {
Â  Â  Â  Â  Â  transform: translateY(-50%) translateX(0);
Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  }

Â  Â  Â  Â  #floating-x-logo:hover {
Â  Â  Â  Â  Â  transform: translateY(-50%) scale(1.1);
Â  Â  Â  Â  Â  box-shadow: 0 6px 25px rgba(29, 155, 240, 0.4);
Â  Â  Â  Â  }

Â  Â  Â  Â  #floating-x-logo:active {
Â  Â  Â  Â  Â  transform: translateY(-50%) scale(0.95);
Â  Â  Â  Â  }
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œå›´è§‚ç¾¤èŠâ€æ“ä½œæŒ‰é’®æ·»åŠ çš„æ ·å¼ â–¼â–¼â–¼ */

/* 1. è®©â€œå›´è§‚ä¸­â€æ–‡å­—å’ŒæŒ‰é’®å®¹å™¨å‚ç›´æ’åˆ— */
#chat-lock-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px; /* åœ¨æ–‡å­—å’ŒæŒ‰é’®ä¹‹é—´å¢åŠ é—´è· */
}

/* 2. æŒ‰é’®çš„å®¹å™¨ï¼Œä½¿ç”¨Flexå¸ƒå±€è®©å®ƒä»¬æ°´å¹³æ’åˆ— */
.spectator-actions-container {
    display: flex;
    gap: 12px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
    align-items: center;
}

/* 3. ä¸ºæ¬¡è¦æŒ‰é’®ï¼ˆé‡Roll/å‰ªè¾‘ï¼‰åˆ›å»ºä¸€ä¸ªæ–°æ ·å¼ */
#chat-lock-content .lock-action-btn.secondary {
    background-color: transparent; /* é€æ˜èƒŒæ™¯ */
    color: var(--accent-color);   /* ä½¿ç”¨ä¸»é¢˜è‰²æ–‡å­— */
    border: 1px solid var(--accent-color); /* åŒæ ·é¢œè‰²çš„è¾¹æ¡† */
    padding: 8px 18px; /* è°ƒæ•´å†…è¾¹è·ï¼Œè®©å®ƒæ¯”ä¸»æŒ‰é’®å°ä¸€ç‚¹ */
    font-size: 14px;
}
/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œå›´è§‚ç¾¤èŠâ€SVGå›¾æ ‡æŒ‰é’®æ·»åŠ çš„æ ·å¼ â–¼â–¼â–¼ */

.spectator-actions-container .lock-action-btn.secondary svg {
    width: 20px;  /* è®¾ç½®å›¾æ ‡å®½åº¦ */
    height: 20px; /* è®¾ç½®å›¾æ ‡é«˜åº¦ */
    stroke: currentColor; /* å…³é”®ï¼šè®©å›¾æ ‡é¢œè‰²è‡ªåŠ¨ç»§æ‰¿æŒ‰é’®çš„æ–‡å­—é¢œè‰² */
}

/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */
    </style>
</head>
<body>
    <div id="phone-screen">
        <div id="status-bar">
            <span id="status-bar-time">12:00</span>
            <div id="status-bar-battery" class="battery-container">
                <span class="battery-text">--%</span>
                <div class="battery-icon">
                    <div class="battery-level"></div>
                </div>
            </div>
        </div>
        <div id="notification-bar"><img id="notification-avatar" src="">
            <div id="notification-content">
                <div class="name"></div>
                <div class="message"></div>
            </div>
        </div>
<!-- â–¼â–¼â–¼ æ­¥éª¤ 1ï¼šç”¨è¿™æ•´å—æ–°ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ‚¨ç°æœ‰çš„ <div id="home-screen" ...> ... </div> â–¼â–¼â–¼ -->

<div id="home-screen" class="screen active">

    <!-- 1. é¡µé¢æ»‘åŠ¨å®¹å™¨ -->
    <div id="home-screen-pages-container">
        <div id="home-screen-pages">
            <!-- é¡µé¢ 1: ä¿æŒæ‚¨åŸæœ‰çš„å¸ƒå±€ -->
            <div class="home-screen-page">
                <div id="main-content-area">
                    <div id="profile-widget">
                        <img id="profile-banner-img" src="https://i.imgur.com/1n3a43H.jpeg" class="editable-image">
                        <div class="profile-avatar-container">
                            <img id="profile-avatar-img" src="https://i.postimg.cc/y8xWzCqj/anime-boy.jpg" class="editable-image">
                        </div>
                        <div class="profile-info">
                            <p id="profile-username" class="editable-text">@ insonneve ğŸª¦</p>
                            <p id="profile-sub-username" class="editable-text">@ insonneve</p>
                            <p id="profile-bio" class="editable-text">ä½ å¥½åƒè¿‡å¾—å¾ˆå¥½ è¿«ä¸åŠå¾…çš„æŠ¹å»æˆ‘å­˜åœ¨çš„ç—•è¿¹</p>
                            <p id="profile-location" class="editable-text">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5-2.5-1.12 2.5-2.5 2.5z"></path></svg>
                                <span>åŒ—æµ·é“</span>
                            </p>
                        </div>
                    </div>
                    <div id="desktop-layout">
                        <div id="desktop-widget-column">
                            <div class="desktop-widget text-only">
                                <p id="widget-text-1" class="editable-text">Be fearless in pursuit of happiness</p>
                            </div>
                            <div class="desktop-widget icon-left">
                                <img id="widget-avatar-1" src="https://i.imgur.com/1n3a43H.jpeg" class="editable-image">
                                <span id="widget-text-2" class="editable-text">Dare to be different</span>
                            </div>
                            <div class="desktop-widget icon-right">
                                <span id="widget-text-3" class="editable-text">* Keep your spirit free</span>
                                <img id="widget-avatar-2" src="https://i.imgur.com/5A0tE9a.jpeg" class="editable-image">
                            </div>
                        </div>
                        <div id="desktop-app-container">
                            <div class="desktop-app-icon" onclick="showScreen('chat-list-screen')">
                                <div class="icon-bg-desktop"><img id="icon-img-qq" src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg" alt="QQ"></div>
                                <span class="label">QQ</span>
                            </div>
                            <div class="desktop-app-icon" onclick="showScreen('world-book-screen')">
                                <div class="icon-bg-desktop"><img id="icon-img-world-book" src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg" alt="ä¸–ç•Œä¹¦"></div>
                                <span class="label">ä¸–ç•Œä¹¦</span>
                            </div>
                            <div class="desktop-app-icon" onclick="showScreen('wallpaper-screen')">
                                <div class="icon-bg-desktop"><img id="icon-img-wallpaper" src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg" alt="å¤–è§‚è®¾ç½®"></div>
                                <span class="label">å¤–è§‚è®¾ç½®</span>
                            </div>
                            <div class="desktop-app-icon" onclick="openRenderingRulesScreen()">
                                <div class="icon-bg-desktop"><img id="icon-img-renderer" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg" alt="æ¸²æŸ“å™¨"></div>
                                <span class="label">æ¸²æŸ“å™¨</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- é¡µé¢ 2: æ”¾ç½®æ–°Appå›¾æ ‡çš„åœ°æ–¹ -->
            <div class="home-screen-page">
                <div id="page-2-app-container">
                    <div class="desktop-app-icon" onclick="openPresetScreen()">
                        <div class="icon-bg-desktop"><img id="icon-img-preset" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg" alt="é¢„è®¾"></div>
                        <span class="label">é¢„è®¾</span>
                    </div>
<div class="desktop-app-icon" onclick="showScreen('tutorial-screen')">
    <div class="icon-bg-desktop"><img id="icon-img-tutorial" src="https://i.postimg.cc/d10GjC4g/IMG-7302.jpg" alt="æ•™ç¨‹"></div>
    <span class="label">æ•™ç¨‹</span>
</div>
Â  Â  Â <!-- æ‚¬æµ®X Logo - åªåœ¨ä¸»é¡µé¢æ˜¾ç¤º -->
Â  Â  Â  <div id="floating-x-logo" class="floating-x-hidden">
Â  Â  Â  Â  <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
Â  Â  Â  Â  Â  <path
Â  Â  Â  Â  Â  Â  d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
Â  Â  Â  Â  </svg>
Â  Â  Â  </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. åˆ†é¡µæŒ‡ç¤ºå™¨ -->
    <div id="home-screen-pagination">
        <div class="pagination-dot active"></div>
        <div class="pagination-dot"></div>
    </div>

    <!-- 3. åº•éƒ¨ Dock (å·²ä¸ºæ‚¨è¡¥å…¨æ‰€æœ‰æ–‡å­—) -->
    <div id="desktop-dock">
        <div class="desktop-app-icon" onclick="showScreen('api-settings-screen')">
            <div class="icon-bg-desktop"><img id="icon-img-api-settings" src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg" alt="APIè®¾ç½®"></div>
            <span class="label">APIè®¾ç½®</span>
        </div>
        <div class="desktop-app-icon" onclick="showScreen('font-settings-screen')">
            <div class="icon-bg-desktop"><img id="icon-img-font" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="å­—ä½“"></div>
            <span class="label">å­—ä½“</span>
        </div>
        <div class="desktop-app-icon" onclick="openCharacterSelector()">
            <div class="icon-bg-desktop"><img id="icon-img-char-phone" src="https://i.postimg.cc/pXj9h20L/IMG-7275.jpg" alt="Cphone"></div>
            <span class="label">Cphone</span>
        </div>
        <div class="desktop-app-icon" onclick="showScreen('douban-screen')">
            <div class="icon-bg-desktop"><img id="icon-img-douban" src="https://i.postimg.cc/Pq2xJN1g/IMG-7301.jpg" alt="è±†ç“£"></div>
            <span class="label">è±†ç“£</span>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneåŠŸèƒ½çš„æ‰€æœ‰HTMLå±å¹• â–¼â–¼â–¼ -->

<!-- 1. è§’è‰²é€‰æ‹©å±å¹• -->
<div id="character-selection-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>é€‰æ‹©ä¸€éƒ¨æ‰‹æœº</span>
        <span style="width: 30px;"></span>
    </div>
    <div id="character-grid" class="list-container">
        <!-- è§’è‰²åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€V3.0 å…¨æ–°ç‰ˆæœ¬ã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ #character-phone-screen â–¼â–¼â–¼ -->
<div id="character-phone-screen" class="screen">
    
    <!-- 1. Cphone - ä¸»å±å¹• (è¿™æ˜¯å®ƒåº”è¯¥åœ¨çš„ä½ç½®ï¼Œä½œä¸ºç‹¬ç«‹çš„é¡µé¢) -->
    <div id="char-home-screen" class="char-screen active">
        <div id="char-clock-container">
            <div id="char-main-time">12:00</div>
            <div id="char-main-date">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
        </div>
        <div id="char-app-grid">
            <div class="app-row">
                <div class="app-icon" onclick="openCharApp('qq')"><div class="icon-bg"><img id="cphone-icon-img-qq" src=""></div><span class="label">QQ</span></div>
                <div class="app-icon" onclick="openCharApp('album')"><div class="icon-bg"><img id="cphone-icon-img-album" src=""></div><span class="label">ç›¸å†Œ</span></div>
                <div class="app-icon" onclick="openCharApp('browser')"><div class="icon-bg"><img id="cphone-icon-img-browser" src=""></div><span class="label">æµè§ˆå™¨</span></div>
                <div class="app-icon" onclick="openCharApp('taobao')"><div class="icon-bg"><img id="cphone-icon-img-taobao" src=""></div><span class="label">æ·˜å®</span></div>
            </div>
            <div class="app-row">
                <div class="app-icon" onclick="openCharApp('memo')"><div class="icon-bg"><img id="cphone-icon-img-memo" src=""></div><span class="label">å¤‡å¿˜å½•</span></div>
                <div class="app-icon" onclick="openCharApp('diary')"><div class="icon-bg"><img id="cphone-icon-img-diary" src=""></div><span class="label">æ—¥è®°</span></div>
                <div class="app-icon" onclick="openCharApp('amap')"><div class="icon-bg"><img id="cphone-icon-img-amap" src=""></div><span class="label">é«˜å¾·åœ°å›¾</span></div>
                <div class="app-icon" onclick="openCharApp('usage')"><div class="icon-bg"><img id="cphone-icon-img-usage" src=""></div><span class="label">Appè®°å½•</span></div>
            </div>
            <div class="app-row">
                <div class="app-icon" onclick="openCharApp('music')"><div class="icon-bg"><img id="cphone-icon-img-music" src=""></div><span class="label">ç½‘æ˜“äº‘</span></div>
                <div class="app-icon" onclick="switchToMyPhone()"><div class="icon-bg"><img id="cphone-icon-img-ephone" src=""></div><span class="label">Ephone</span></div>
            </div>
        </div>
    </div>
<div id="char-amap-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>è¶³è¿¹</span>
        <div class="header-actions">
            <span class="action-btn" id="regenerate-char-amap-btn" title="é‡æ–°ç”Ÿæˆè¶³è¿¹">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
        </div>
    </div>
    <div id="char-amap-list" class="list-container">
        <!-- è¶³è¿¹åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
    <!-- 2. Cphone - QQ App åˆ—è¡¨é¡µ -->
    <div id="char-qq-screen" class="char-screen">
        <div class="header">
            <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
            <span>QQ</span>
            <div class="header-actions">
                <span class="action-btn" id="regenerate-char-qq-btn" title="é‡æ–°ç”Ÿæˆ">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                    </svg>
                </span>
            </div>
        </div>
        <div id="char-chat-list" class="list-container"></div>
    </div>
    
    <!-- 3. Cphone - æ¨¡æ‹Ÿå¯¹è¯é¡µé¢ -->
    <div id="char-qq-conversation-screen" class="char-screen">
        <div class="header">
            <span class="back-btn" id="back-to-char-qq-list-btn">â€¹</span>
            <span id="char-conversation-partner-name"></span>
            <span style="width: 30px;"></span>
        </div>
        <div id="char-conversation-messages" class="list-container">
        </div>
        <div id="char-conversation-input-area" style="padding: 8px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; background-color: #f7f7f7;">
            <input type="text" id="char-simulated-input" placeholder="è¿™æ˜¯æ¨¡æ‹Ÿå¯¹è¯ï¼Œæ— æ³•å‘é€æ¶ˆæ¯" disabled style="flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid #ddd; background: #eee;">
            <button id="char-simulated-send-btn" style="padding: 0 20px; border: none; background-color: var(--accent-color); color: white; border-radius: 6px; font-weight: 500;">å‘é€</button>
        </div>
    </div>
    
    <!-- 4. Cphone - ç›¸å†Œ App é¡µé¢ (è¿™æ˜¯å®ƒåº”è¯¥åœ¨çš„ä½ç½®ï¼Œä¸ä¸»å±å¹•å¹³çº§) -->
    <div id="char-album-screen" class="char-screen">
        <div class="header">
            <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
            <span>TAçš„ç›¸å†Œ</span>
            <div class="header-actions">
                <span class="action-btn" id="regenerate-char-album-btn" title="é‡æ–°ç”Ÿæˆç›¸å†Œå†…å®¹">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                    </svg>
                </span>
            </div>
        </div>
        <div class="list-container">
            <div id="char-album-grid"></div>
        </div>
    </div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | æ”¯æŒæ–‡ç« /å›¾ç‰‡ã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„ #char-browser-screen â–¼â–¼â–¼ -->
<div id="char-browser-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>TAçš„æµè§ˆå™¨å†å²</span>
        <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘é‡æ–°ç”ŸæˆæŒ‰é’® -->
        <div class="header-actions">
            <span class="action-btn" id="regenerate-char-browser-btn" title="é‡æ–°ç”Ÿæˆæµè§ˆè®°å½•">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
        </div>
    </div>
    <div id="char-browser-history" class="list-container">
        <!-- æµè§ˆè®°å½•å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>

<!-- ã€ã€ã€æ ¸å¿ƒæ–°å¢ï¼šå…¨æ–°çš„æ–‡ç« æŸ¥çœ‹é¡µé¢ã€‘ã€‘ã€‘ -->
<div id="char-browser-article-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharScreen('char-browser-screen')">â€¹</span>
        <span id="char-article-title" style="max-width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">æ–‡ç« </span>
        <span style="width: 30px;"></span>
    </div>
    <div id="char-article-content" class="list-container" style="padding: 20px; font-size: 16px; line-height: 1.8; color: #333; overflow-y: auto;">
        <!-- æ–‡ç« æˆ–å›¾ç‰‡å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | æ”¯æŒé’±åŒ…ã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ #char-taobao-screen â–¼â–¼â–¼ -->
<div id="char-taobao-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>TAçš„æ·˜å®è®¢å•</span>
        <div class="header-actions">
            
            <!-- ã€æ ¸å¿ƒæ–°å¢2ã€‘é‡æ–°ç”ŸæˆæŒ‰é’® -->
            <span class="action-btn" id="regenerate-char-taobao-btn" title="é‡æ–°ç”Ÿæˆè´­ä¹°è®°å½•">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
        </div>
    </div>
    <!-- è´­ä¹°è®°å½•åˆ—è¡¨ (å¤ç”¨æ—§çš„gridï¼Œä½†å†…å®¹ä¼šæ˜¯åŠ¨æ€çš„) -->
    <div id="char-product-grid" class="list-container"></div>
</div>


<div id="char-memo-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>å¤‡å¿˜å½•</span>
        <div class="header-actions">
            <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘é‡æ–°ç”ŸæˆæŒ‰é’® -->
            <span class="action-btn" id="regenerate-char-memo-btn" title="é‡æ–°ç”Ÿæˆå¤‡å¿˜å½•">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
            <span class="action-btn" id="add-char-memo-btn">+</span>
        </div>
    </div>
    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç¡®ä¿åˆ—è¡¨æœ‰å†…è¾¹è·ï¼Œæ›´ç¾è§‚ -->
    <div id="char-memo-list" class="list-container" style="padding: 10px;"></div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨ #char-memo-screen çš„ div ä¹‹åï¼Œç²˜è´´è¿™ä¸ªå…¨æ–°çš„å¤‡å¿˜å½•è¯¦æƒ…å±å¹• â–¼â–¼â–¼ -->
<div id="char-memo-detail-screen" class="char-screen">
    <div class="header">
        <!-- è¿™ä¸ªè¿”å›æŒ‰é’®ä¼šå¸¦æˆ‘ä»¬å›åˆ°å¤‡å¿˜å½•åˆ—è¡¨ -->
        <span class="back-btn" id="char-memo-detail-back-btn">â€¹</span>
        <!-- è¿™é‡Œä¼šåŠ¨æ€æ˜¾ç¤ºå¤‡å¿˜å½•çš„æ ‡é¢˜ -->
        <span id="char-memo-detail-title"></span>
        <!-- å³ä¸Šè§’çš„å ä½ç¬¦ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­ -->
        <span style="width: 80px;"></span>
    </div>
    <!-- è¿™ä¸ªå®¹å™¨å°†ç”¨æ¥æ˜¾ç¤ºå¤‡å¿˜å½•çš„å®Œæ•´å†…å®¹ -->
    <div class="form-container" style="padding: 0;">
        <textarea id="char-memo-detail-content" readonly></textarea>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—æ–°ä»£ç æ›¿æ¢æ—§çš„ #char-diary-screen â–¼â–¼â–¼ -->
<div id="char-diary-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>æ—¥è®°</span>
        <div class="header-actions">
            <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘é‡æ–°ç”ŸæˆæŒ‰é’® -->
            <span class="action-btn" id="regenerate-char-diary-btn" title="é‡æ–°ç”Ÿæˆæ—¥è®°æœ¬">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿™ä¸ªâ€œ+â€å·ç°åœ¨ä¼šè§¦å‘AIå†™ä¸€ç¯‡æ–°æ—¥è®° -->
            <span class="action-btn" id="add-char-diary-btn">+</span>
        </div>
    </div>
    <div id="char-diary-list" class="list-container"></div>
</div>

<!-- ã€ã€ã€æ ¸å¿ƒæ–°å¢ï¼šå…¨æ–°çš„æ—¥è®°è¯¦æƒ…å±å¹•ã€‘ã€‘ã€‘ -->
<div id="char-diary-detail-screen" class="char-screen">
<div class="header">
    <span class="back-btn" id="char-diary-detail-back-btn">â€¹ </span>
    <span id="char-diary-detail-title"></span>
    <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨è¿™é‡Œæ·»åŠ æ”¶è—æŒ‰é’® -->
    <div class="header-actions">
        <span class="action-btn" id="favorite-diary-btn" title="æ”¶è—">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
        </span>
    </div>
</div>
    <div id="char-diary-detail-content-wrapper" class="list-container">
        <div id="char-diary-detail-content">
            <!-- æ—¥è®°å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªV2.0ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ id="char-usage-screen" çš„ div â–¼â–¼â–¼ -->
<div id="char-usage-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>Appä½¿ç”¨è®°å½•</span>
        <div class="header-actions">
            <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘é‡æ–°ç”ŸæˆæŒ‰é’® -->
            <span class="action-btn" id="regenerate-char-usage-btn" title="é‡æ–°ç”Ÿæˆè®°å½•">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
        </div>
    </div>
    <div id="char-usage-list" class="list-container">
        <!-- Appä½¿ç”¨è®°å½•å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

    <!-- æ¨¡æ‹ŸèŠå¤©è®°å½•çš„å¼¹çª— (ä¿æŒä¸å˜) -->
    <div id="char-qq-transcript-modal" class="modal">
        <div class="modal-content" style="height: 80%;">
            <div class="modal-header">
                <span id="transcript-modal-char-name"></span>
            </div>
            <div class="modal-body" id="transcript-modal-body" style="background-color: #f0f2f5; padding: 15px; display: flex; flex-direction: column; gap: 15px;">
            </div>
            <div class="modal-footer">
                <button class="save" id="close-transcript-modal-btn" style="width:100%;">å…³é—­</button>
            </div>
        </div>
    </div>
<!-- â–¼â–¼â–¼ æ­¥éª¤ 1-2ï¼šå°†è¿™æ•´å—å…¨æ–°çš„â€œç½‘æ˜“äº‘éŸ³ä¹â€å±å¹•å’Œæ’­æ”¾å™¨ï¼Œå®Œæ•´ç²˜è´´åˆ° id="character-phone-screen" çš„ div å†…éƒ¨æœ«å°¾ â–¼â–¼â–¼ -->

<!-- 1. ç½‘æ˜“äº‘éŸ³ä¹Appä¸»å±å¹• -->
<div id="char-music-screen" class="char-screen">
    <div class="header">
        <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
        <span>TAçš„æ­Œå•</span>
        <div class="header-actions">
            <span class="action-btn" id="regenerate-char-music-btn" title="é‡æ–°ç”Ÿæˆæ­Œå•">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
        </div>
    </div>
    <div id="char-music-list" class="list-container">
        <!-- æ­Œæ›²åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>

<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ã€å…¨æ–° V3.0 | ä»¿é»‘èƒ¶å”±ç‰‡æœºUIã€‘çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ char-music-player-modal â–¼â–¼â–¼ -->
<div id="char-music-player-modal" class="modal">
    <div class="modal-content">
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="char-player-body">
            <!-- æ­Œæ›²ä¿¡æ¯ -->
            <div class="char-player-song-info">
                <p id="char-music-player-title">æ­Œæ›²åç§°</p>
                <p id="char-music-artist">æ­Œæ‰‹</p>
            </div>

            <!-- ä¸“è¾‘å°é¢ (é»‘èƒ¶å”±ç‰‡æ•ˆæœ) -->
            <div id="char-vinyl-container">
                <img id="char-music-cover" src="">
            </div>
            
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†éŸ³ç¬¦å ä½ç¬¦æ›¿æ¢ä¸ºçœŸæ­£çš„æ­Œè¯å®¹å™¨ -->
            <div id="char-music-lyrics">
                <!-- æ­Œè¯å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>

            <!-- åº•éƒ¨æ§åˆ¶æ  -->
            <div class="char-player-footer">
                <div class="char-player-progress-bar-container">
                    <span id="char-music-current-time" class="time-display">0:00</span>
                    <div id="char-music-progress-bar" class="char-player-progress-bar">
                        <div id="char-music-progress-fill"></div>
                    </div>
                    <span id="char-music-total-time" class="time-display">0:00</span>
                </div>

                <div class="char-player-controls">
                    <button id="char-music-prev-btn" class="control-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path></svg>
                    </button>
                    <button id="char-music-play-pause-btn" class="control-btn play">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                    </button>
                    <button id="char-music-next-btn" class="control-btn">
                         <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M16 6h2v12h-2zm-3.5 6l-8.5 6V6z"></path></svg>
                    </button>
                     <button id="char-music-mode-btn" class="control-btn mode">é¡ºåº</button>
                </div>
            </div>
        </div>
        <!-- å…³é—­æŒ‰é’®è¢«ç§»åˆ°å³ä¸Šè§’ -->
        <button id="close-char-music-player-btn" class="char-player-close-btn">Ã—</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

        <!-- â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ world-book-screen â–¼â–¼â–¼ -->
        <div id="world-book-screen" class="screen">
            <div class="header">
    <!-- å°†æ‰€æœ‰éœ€è¦é å·¦çš„æŒ‰é’®ï¼Œç”¨ä¸€ä¸ªæ–°çš„ div åŒ…è£¹èµ·æ¥ -->
    <div class="header-left-actions">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span class="action-btn" id="import-world-book-btn" title="å¯¼å…¥ä¸–ç•Œä¹¦">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        </span>
        <span class="action-btn" id="export-world-book-btn" title="å¯¼å‡ºä¸–ç•Œä¹¦">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        </span>
    </div>
                <span>ä¸–ç•Œä¹¦</span>
                <div class="header-actions">
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å°†æ–‡å­—æŒ‰é’®æ›¿æ¢ä¸ºSVGå›¾æ ‡ -->
                    <span class="action-btn" id="manage-world-book-categories-btn" title="ç®¡ç†åˆ†ç±»">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </span>
                    <span class="action-btn" id="add-world-book-btn">+</span>
                </div>
            </div>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å…¨æ–°çš„é¡µç­¾å’Œå†…å®¹åŒºç»“æ„ -->
            <div id="world-book-tabs"></div>
            <div id="world-book-content-container"></div>
        </div>
        <!-- â–¼â–¼â–¼ ã€è¯·å°†è¿™ä¸ªç¼ºå¤±çš„ä»£ç å—ã€‘ç²˜è´´åˆ° id="world-book-screen" çš„ div ä¹‹å â–¼â–¼â–¼ -->
        <div id="world-book-editor-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('world-book-screen')">â€¹</span>
                <span id="world-book-editor-title">ç¼–è¾‘ä¸–ç•Œä¹¦</span>
                <span class="save-btn" id="save-world-book-btn">ä¿å­˜</span>
            </div>
            <div class="form-container">
                <div class="form-group">
                    <label for="world-book-name-input">ä¹¦å</label>
                    <input type="text" id="world-book-name-input" placeholder="è¯·è¾“å…¥ä¸–ç•Œä¹¦çš„åç§°...">
                </div>
                <div class="form-group">
                    <label for="world-book-category-select">åˆ†ç±»</label>
                    <select id="world-book-category-select"></select>
                </div>
                <!-- ç¼–è¾‘å™¨åŒºåŸŸ -->
                <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;">
                    <label>å†…å®¹æ¡ç›®</label>
                    <!-- è¿™ä¸ªå®¹å™¨å°†ç”¨æ¥åŠ¨æ€è£…è½½æ‰€æœ‰å¯ç¼–è¾‘çš„æ¡ç›®å— -->
                    <div id="world-book-entries-container" style="display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding: 5px; flex-grow: 1;">
                        <!-- JS ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆå†…å®¹ -->
                    </div>
                </div>
                <!-- æ·»åŠ æ–°æ¡ç›®çš„æŒ‰é’® -->
                <button id="add-world-book-entry-btn" class="form-button form-button-secondary"> [+] æ·»åŠ æ–°æ¡ç›® </button>
            </div>
        </div>
        <!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯â€œé¢„è®¾â€Appçš„æ‰€æœ‰HTMLå±å¹•ï¼Œè¯·ç²˜è´´åˆ° world-book-editor-screen ä¹‹å â–¼â–¼â–¼ -->
<div id="preset-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>é¢„è®¾</span>
        <div class="header-actions">
 <span class="action-btn" id="import-preset-btn" title="å¯¼å…¥é¢„è®¾æ–‡ä»¶">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </span>
            <span class="action-btn" id="manage-preset-categories-btn" title="ç®¡ç†åˆ†ç±»">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
            </span>
            <span class="action-btn" id="add-preset-btn">+</span>
        </div>
    </div>
    <div id="preset-tabs"></div>
    <div id="preset-content-container"></div>
</div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ•™ç¨‹é¡µé¢ï¼Œè¯·ç²˜è´´åˆ°å…¶ä»– .screen çš„divæ—è¾¹ â–¼â–¼â–¼ -->
<div id="tutorial-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>æ•™ç¨‹</span>
        <span style="width: 30px;"></span> <!-- å ä½ç¬¦ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­ -->
    </div>
    <div class="list-container" style="padding: 0; overflow: hidden;">
        <!-- è¿™é‡Œä¼šåµŒå…¥ä½ çš„æ•™ç¨‹HTMLæ–‡ä»¶ -->
        <iframe id="tutorial-iframe" src="tutorial.html" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<div id="preset-editor-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('preset-screen')">â€¹</span>
        <span id="preset-editor-title">ç¼–è¾‘é¢„è®¾</span>
        <span class="save-btn" id="save-preset-btn">ä¿å­˜</span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label for="preset-name-input">é¢„è®¾åç§°</label>
            <input type="text" id="preset-name-input" placeholder="è¯·è¾“å…¥é¢„è®¾çš„åç§°...">
        </div>
        <div class="form-group">
            <label for="preset-category-select">åˆ†ç±»</label>
            <select id="preset-category-select"></select>
        </div>
        <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;">
            <label>å†…å®¹æ¡ç›®</label>
            <div id="preset-entries-container" style="display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding: 5px; flex-grow: 1;">
            </div>
        </div>
        <button type="button" id="add-preset-entry-btn" class="form-button form-button-secondary"> [+] æ·»åŠ æ–°æ¡ç›® </button>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ åŸæ¥çš„ id="api-settings-screen" çš„ div â–¼â–¼â–¼ -->
        <div id="api-settings-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
                <span>API è®¾ç½®</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <!-- ã€ã€ã€å…¨æ–°ï¼šAPIé¢„è®¾ç®¡ç†ã€‘ã€‘ã€‘ -->
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">API é¢„è®¾ç®¡ç†</h3>
                <div class="form-group">
                    <label for="api-preset-select">é€‰æ‹©æˆ–åˆ‡æ¢é¢„è®¾</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="api-preset-select" style="flex-grow: 1;"></select>
                        <button id="save-api-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ä¿å­˜</button>
                        <button id="delete-api-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">åˆ é™¤</button>
                    </div>
                </div>
                <hr style="margin: 30px 0; opacity: 0.3;">
                <!-- ä¸»APIè®¾ç½® -->
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">ä¸»APIè®¾ç½® (ç”¨äºèŠå¤©)</h3>
                <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;"> æç¤º: è‹¥è¦ä½¿ç”¨â€œå‘é€å›¾ç‰‡â€åŠŸèƒ½, è¯·åŠ¡å¿…é€‰æ‹©æ”¯æŒVision(è§†è§‰)çš„æ¨¡å‹, å¦‚<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>æˆ–<code
                        style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>ã€‚ </p>
                <div class="form-group">
                    <label for="proxy-url">åä»£åœ°å€ (ä¸éœ€è¦æ·»åŠ /v1å™¢~)</label>
                    <input type="text" id="proxy-url" placeholder="ä¾‹å¦‚: https://api.openai.com">
                </div>
                <div class="form-group">
                    <label for="api-key">å¯†é’¥ (API Key)</label>
                    <input type="password" id="api-key" placeholder="sk-...">
                </div>
                <div class="form-group">
                    <label for="model-select">æ¨¡å‹</label>
                    <select id="model-select"></select>
                </div>
                <button class="form-button" id="fetch-models-btn">æ‹‰å–ä¸»æ¨¡å‹</button>
                <!-- å‰¯APIè®¾ç½® -->
                <hr style="margin: 30px 0; opacity: 0.3;">
                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">å‰¯APIè®¾ç½® (ç”¨äºæ€»ç»“é•¿æœŸè®°å¿†)</h3>
                <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;"> æ‚¨å¯ä»¥åœ¨æ­¤é…ç½®ä¸€ä¸ªç‹¬ç«‹çš„ã€å¯èƒ½æˆæœ¬æ›´ä½çš„APIï¼Œä¸“é—¨ç”¨äºåå°çš„é•¿æœŸè®°å¿†æ€»ç»“ä»»åŠ¡ï¼Œä»¥èŠ‚çœä¸»APIçš„è´¹ç”¨ã€‚å¦‚æœç•™ç©ºï¼Œå°†é»˜è®¤ä½¿ç”¨ä¸»APIè¿›è¡Œæ€»ç»“ã€‚ </p>
                <div class="form-group">
                    <label for="secondary-proxy-url">å‰¯åä»£åœ°å€</label>
                    <input type="text" id="secondary-proxy-url" placeholder="ä¾‹å¦‚: https://api.groq.com/openai">
                </div>
                <div class="form-group">
                    <label for="secondary-api-key">å‰¯å¯†é’¥</label>
                    <input type="password" id="secondary-api-key" placeholder="gsk_...">
                </div>
                <div class="form-group">
                    <label for="secondary-model-select">å‰¯æ¨¡å‹</label>
                    <select id="secondary-model-select"></select>
                </div>
                <button class="form-button form-button-secondary" id="fetch-secondary-models-btn">æ‹‰å–å‰¯æ¨¡å‹</button>
                <!-- åå°æ´»åŠ¨è®¾ç½® -->
                <hr style="margin: 30px 0; opacity: 0.3;">
                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">åå°æ´»åŠ¨è®¾ç½®</h3>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="background-activity-switch" style="margin-bottom: 0;"> å¯ç”¨åå°è§’è‰²æ´»åŠ¨ <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;"> è­¦å‘Šï¼šæ­¤åŠŸèƒ½ä¼šæ˜¾è‘—å¢åŠ APIè°ƒç”¨å’Œè´¹ç”¨ï¼ </p>
                    </label>
                    <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <label for="background-interval-input" style="margin-bottom: 0;"> åå°æ´»åŠ¨æ£€æµ‹é—´éš” (ç§’) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> å»ºè®®å€¼ 60-300ã€‚å€¼è¶Šå¤§ï¼Œè´¹ç”¨è¶Šä½ï¼Œä½†è§’è‰²ååº”è¶Šæ…¢ã€‚ </p>
                    </label>
                    <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <label for="block-cooldown-input" style="margin-bottom: 0;"> AIè¢«æ‹‰é»‘åå†·é™æœŸ (å°æ—¶) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> è¢«æ‹‰é»‘è¶…è¿‡è¿™ä¸ªæ—¶é—´åï¼ŒAIæ‰æœ‰å‡ ç‡é‡æ–°ç”³è¯·å¥½å‹ã€‚ </p>
                    </label>
                    <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;">
                </div>
                <hr style="margin: 30px 0; opacity: 0.3;">
                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">ç”Ÿå›¾åŠŸèƒ½è®¾ç½®</h3>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="enable-ai-drawing-switch" style="margin-bottom: 0;">
                        å¯ç”¨AIç”Ÿå›¾åŠŸèƒ½
                        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                            å…³é—­åï¼Œæ‰€æœ‰éœ€è¦AIç”Ÿæˆçš„å›¾ç‰‡ï¼ˆåŠ¨æ€ã€å¤´åƒç­‰ï¼‰éƒ½å°†æ˜¾ç¤ºä¸ºå ä½å›¾ï¼Œä»¥èŠ‚çœæµé‡å’ŒAPIè´¹ç”¨ã€‚
                        </p>
                    </label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="enable-ai-drawing-switch">
                        <span class="slider"></span>
                    </label>
                </div>
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°æŒ‰é’®ä»£ç  â–¼â–¼â–¼ -->
<hr style="margin: 30px 0; opacity: 0.3;">
<h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">å­˜å‚¨ç©ºé—´ä¼˜åŒ–</h3>
<button class="form-button form-button-secondary" id="compress-images-btn" style="background-color: #e8f5e9; color: #2e7d32; border-color: #c8e6c9;">
    ä¸€é”®å‹ç¼©æœ¬åœ°å›¾ç‰‡
</button>
<p style="font-size: 12px; color: #8a8a8a; margin-top: 8px; line-height: 1.5;">
    æ­¤åŠŸèƒ½ä¼šå°†æ‚¨æ‰€æœ‰æœ¬åœ°ä¸Šä¼ çš„å›¾ç‰‡ï¼ˆå¦‚å¤´åƒã€è¡¨æƒ…åŒ…ã€èŠå¤©å›¾ç‰‡ã€å¤´åƒæ¡†ã€ç»„ä»¶å›¾ç­‰ï¼‰å‹ç¼©ä¸ºJPEGæ ¼å¼ï¼Œä»¥å¤§å¹…å‡å°æ•°æ®ä½“ç§¯ã€‚
    <br><strong style="color: #ff3b30;">è­¦å‘Šï¼šè¿™æ˜¯ä¸€ä¸ªæœ‰æŸå‹ç¼©ä¸”ä¸å¯é€†çš„æ“ä½œï¼Œä¼šè½»å¾®é™ä½å›¾ç‰‡è´¨é‡ã€‚å»ºè®®æ“ä½œå‰å…ˆå¤‡ä»½æ•°æ®ã€‚</strong>
</p>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
                <!-- ä¿å­˜ä¸å¯¼å…¥å¯¼å‡º -->
                <hr style="margin: 30px 0; opacity: 0.3;">
                <button class="form-button" id="save-api-settings-btn" style="margin-top: 20px;">ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
                <button class="form-button" id="export-data-btn">å¯¼å‡ºæ•°æ®</button>
                <button class="form-button" id="import-btn">å¯¼å…¥å¤‡ä»½æ–‡ä»¶</button>
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°æŒ‰é’®ä»£ç  â–¼â–¼â–¼ -->
<button class="form-button form-button-secondary" id="cleanup-data-btn" style="background-color: #ffebee; color: #c62828; border-color: #ef9a9a; margin-top: 10px;">æ¸…ç†å†—ä½™æ•°æ®</button>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
<button class="form-button form-button-secondary" id="clear-specific-data-btn" style="background-color: #ffcdd2; color: #b71c1c; border-color: #ef9a9a; margin-top: 10px;">é«˜çº§æ•°æ®æ¸…ç†</button>
                <input id="import-data-input" type="file" accept="application/json" hidden>

            </div>
        </div>
        <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- ã€ã€ã€å…¨æ–° V2.0 | æ”¯æŒå…¨é€‰ã€‘ï¼šé«˜çº§æ•°æ®æ¸…ç†å‘å¯¼æ¨¡æ€æ¡†ã€‘ã€‘ã€‘ -->
<div id="data-clear-wizard-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <!-- æ­¥éª¤ 1: é€‰æ‹©è§’è‰² -->
        <div id="data-clear-step-1" class="wizard-step">
            <div class="modal-header">
                <span>ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©è¦æ¸…ç†çš„è§’è‰²</span>
                <!-- æ ¸å¿ƒæ–°å¢ï¼šå…¨é€‰å¤é€‰æ¡† -->
                <label>
                    <input type="checkbox" id="select-all-chars-for-clear"> å…¨é€‰
                </label>
            </div>
            <div class="modal-body" id="data-clear-char-list" style="padding: 0;">
                <!-- è§’è‰²åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-clear-wizard-btn-step1">å–æ¶ˆ</button>
                <button class="save" id="go-to-clear-step2-btn">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>
        <!-- æ­¥éª¤ 2: é€‰æ‹©æ•°æ®ç±»å‹ -->
        <div id="data-clear-step-2" class="wizard-step" style="display: none;">
            <div class="modal-header">
                <span>ç¬¬äºŒæ­¥ï¼šé€‰æ‹©è¦æ¸…ç†çš„æ•°æ®ç±»å‹</span>
                <!-- æ ¸å¿ƒæ–°å¢ï¼šå…¨é€‰å¤é€‰æ¡† -->
                <label>
                    <input type="checkbox" id="select-all-types-for-clear"> å…¨é€‰
                </label>
            </div>
            <div class="modal-body" id="data-clear-type-list" style="padding: 0;">
                <!-- æ•°æ®ç±»å‹åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="modal-footer">
                <button class="form-button-secondary" id="back-to-clear-step1-btn" style="width: 30%; margin:0;">ä¸Šä¸€æ­¥</button>
                <button class="cancel" id="cancel-clear-wizard-btn-step2" style="width: 30%; margin:0;">å–æ¶ˆ</button>
                <button class="save btn-danger" id="confirm-final-clear-btn" style="width: 30%; margin:0;">ç¡®è®¤æ¸…ç†</button>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ åŸæ¥çš„ chat-list-screen â–¼â–¼â–¼ -->
        <div id="chat-list-screen" class="screen">
            <!-- ä¸»å¤´éƒ¨ (åªåœ¨æ¶ˆæ¯åˆ—è¡¨æ˜¾ç¤º) -->
            <div class="header" id="main-chat-list-header">
                <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
                <span id="chat-list-title">æ¶ˆæ¯</span>
                <div class="header-actions">
                    <span class="action-btn" id="add-group-chat-btn" title="åˆ›å»ºç¾¤èŠ"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg></span>
                    <span class="action-btn" id="add-chat-btn">+</span>
                </div>
            </div>
            <!-- æ¶ˆæ¯åˆ—è¡¨è§†å›¾ -->
            <div id="messages-view" class="chat-list-view active">
                <div id="chat-list">
                    <!-- JSä¼šåœ¨è¿™é‡Œç”ŸæˆèŠå¤©åˆ—è¡¨ -->
                </div>
            </div>
            <!-- åŠ¨æ€ç•Œé¢è§†å›¾ -->
            <div id="qzone-screen" class="chat-list-view">
                <div class="qzone-header">
                    <span class="back-btn" id="qzone-back-btn">â€¹</span> <!-- è¿™ä¸ªæŒ‰é’®ç°åœ¨åªè´Ÿè´£ä»åŠ¨æ€è¿”å› -->
                    <span>å¥½å‹åŠ¨æ€</span>
    <div class="header-actions">
        <span class="action-btn" id="qzone-more-actions-btn" title="æ›´å¤šæ“ä½œ">â€¦</span>
    </div>
                </div>
                <div class="qzone-content">
                    <div class="qzone-profile-header">
                        <div id="qzone-banner-container" class="qzone-banner-container">
                            <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="èƒŒæ™¯">
                            <input type="file" id="qzone-banner-input" accept="image/*" hidden>
                        </div>
                        <div class="qzone-user-info">
                            <div id="qzone-avatar-container" class="qzone-avatar-container">
                                <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="å¤´åƒ">
                                <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                            </div>
                            <span id="qzone-nickname">{{user}}</span>
                        </div>
                    </div>
                    <div class="qzone-actions-bar">
                        <div class="action-item" id="create-shuoshuo-btn"><span>è¯´è¯´</span></div>
                        <div class="action-item" id="create-post-btn"><span>åŠ¨æ€</span></div>
                        <div class="action-item" id="open-album-btn"><span>ç›¸å†Œ</span></div>
                    </div>
                    <div id="qzone-posts-list"></div>
                </div>
            </div>
            <!-- æ”¶è—ç•Œé¢è§†å›¾ -->
            <div id="favorites-view" class="chat-list-view">
                <div class="header">
                    <span class="back-btn" id="favorites-back-btn">â€¹</span>
                    <span>æˆ‘çš„æ”¶è—</span>
                    <!-- æ–°å¢çš„ç¼–è¾‘æŒ‰é’® -->
                    <span class="action-btn" id="favorites-edit-btn">ç¼–è¾‘</span>
                </div>
                <!-- ã€æ–°å¢ã€‘æœç´¢æ å®¹å™¨ -->
                <div class="search-bar-container">
                    <input type="search" id="favorites-search-input" placeholder="æœç´¢æ”¶è—çš„æ ‡é¢˜ã€å†…å®¹æˆ–ä½œè€…...">
                    <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">Ã—</button>
                </div>
                <div id="favorites-list" class="list-container">
                    <!-- æ”¶è—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
                <!-- æ–°å¢ï¼šæ”¶è—é¡µåº•éƒ¨æ“ä½œæ  -->
                <div id="favorites-action-bar" style="display: none;">
                    <button id="favorites-delete-selected-btn" class="action-bar-btn">åˆ é™¤ (0)</button>
                </div>
            </div>
            <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å›å¿†å½•ç•Œé¢è§†å›¾ â–¼â–¼â–¼ -->
            <div id="memories-view" class="chat-list-view">
                <div class="header">
                    <span class="back-btn" id="memories-back-btn">â€¹</span>
                    <span>æˆ‘ä»¬çš„å›å¿†</span>
                    <span class="action-btn" id="add-countdown-btn">+</span>
                </div>
                <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                    <!-- å›å¿†å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
            </div>
            <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
            <div id="npc-list-view" class="chat-list-view">
                <div class="header">
                    <span class="back-btn" id="npc-list-back-btn">â€¹</span>
                    <span>NPC åˆ—è¡¨</span>
                    <div class="header-actions">
                        <span class="action-btn" id="add-npc-btn">+</span>
                    </div>
                </div>
                <div id="npc-list" class="list-container" style="padding: 0;">
                    <!-- NPCåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
            </div>
            <!-- åº•éƒ¨å¯¼èˆªæ  -->
            <div id="chat-list-bottom-nav">
                <div class="nav-item active" data-view="messages-view">
                    <span>æ¶ˆæ¯</span>
                </div>
                <div class="nav-item" data-view="qzone-screen">
                    <span>åŠ¨æ€</span>
                </div>
                <!-- â–¼â–¼â–¼ åœ¨â€œåŠ¨æ€â€å’Œâ€œæ”¶è—â€ä¹‹é—´ï¼ŒåŠ å…¥è¿™ä¸ªæ–°é¡µç­¾ â–¼â–¼â–¼ -->
                <div class="nav-item" data-view="memories-view">
                    <span>å›å¿†</span>
                </div>
                <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
                <div class="nav-item" data-view="favorites-view">
                    <span>æ”¶è—</span>
                </div>
                <div class="nav-item" data-view="npc-list-view">
                    <span>NPC</span>
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ›¿æ¢åŒºåŸŸç»“æŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ° id="chat-list-screen" çš„ div ä¹‹å â–¼â–¼â–¼ -->
        <div id="album-screen" class="screen">
            <!-- 1. é¡µé¢å¤´éƒ¨ï¼ŒåŒ…å«è¿”å›æŒ‰é’®å’Œæ ‡é¢˜ -->
            <div class="header">
                <span class="back-btn" id="album-back-btn">â€¹</span>
                <span>æˆ‘çš„ç›¸å†Œ</span>
                <span class="action-btn" id="create-album-btn-page">+</span>
            </div>
            <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
            <div class="list-container">
                <div id="album-grid-page">
                    <!-- ç›¸å†Œåˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ° id="album-screen" çš„ div ä¹‹å â–¼â–¼â–¼ -->
        <div id="album-photos-screen" class="screen">
            <!-- 1. é¡µé¢å¤´éƒ¨ -->
            <div class="header">
                <span class="back-btn" id="album-photos-back-btn">â€¹</span>
                <span id="album-photos-title">ç›¸å†Œåç§°</span>
                <span class="action-btn" id="album-upload-photo-btn">ä¸Šä¼ </span>
            </div>
            <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
            <div class="list-container">
                <div id="photos-grid-page">
                    <!-- ç…§ç‰‡åˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
                <!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
                <div id="photo-viewer-modal" class="modal">
                    <!-- 1. å…³é—­æŒ‰é’® -->
                    <button id="photo-viewer-close-btn">Ã—</button>
                    <!-- 2. ä¸Šä¸€å¼ ç…§ç‰‡æŒ‰é’® -->
                    <button id="photo-viewer-prev-btn" class="nav-arrow">â€¹</button>
                    <!-- 3. å›¾ç‰‡å®¹å™¨ -->
                    <div class="photo-viewer-content">
                        <img id="photo-viewer-image" src="" alt="å…¨å±ç…§ç‰‡é¢„è§ˆ">
                    </div>
                    <!-- 4. ä¸‹ä¸€å¼ ç…§ç‰‡æŒ‰é’® -->
                    <button id="photo-viewer-next-btn" class="nav-arrow">â€º</button>
                </div>
                <!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->
            </div>
        </div>
        <!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->
<div id="npc-editor-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="npc-editor-title">æ·»åŠ  NPC</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>NPC å¤´åƒ</label>
                <div class="avatar-upload">
                    <img id="npc-avatar-preview" src="https://i.postimg.cc/VkQfgzGJ/1.jpg">
                    <button onclick="document.getElementById('npc-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button>
                    <input type="file" id="npc-avatar-input" accept="image/*" hidden>
                </div>
            </div>
            <div class="form-group">
                <label for="npc-name-input">NPC æ˜µç§°</label>
                <input type="text" id="npc-name-input" placeholder="è¾“å…¥NPCçš„å¸¸ç”¨å">
            </div>
            <div class="form-group">
                <label for="npc-persona-input">NPC äººè®¾</label>
                <textarea id="npc-persona-input" rows="4" placeholder="è¯¦ç»†æè¿°è¿™ä¸ªNPCçš„æ€§æ ¼ã€èƒŒæ™¯ã€è¯´è¯æ–¹å¼ç­‰..."></textarea>
            </div>
<!-- â–¼â–¼â–¼ åœ¨NPCäººè®¾è¾“å…¥æ¡†ä¹‹åï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼ -->
                <hr style="opacity: 0.2;">
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="npc-background-activity-switch" style="margin-bottom: 0;">
                        å¯ç”¨ç‹¬ç«‹åå°æ´»åŠ¨
                        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                            å…è®¸è¯¥NPCåœ¨åå°ç‹¬ç«‹å‘è¡¨åŠ¨æ€è¯„è®ºã€‚éœ€åŒæ—¶å¼€å¯APIè®¾ç½®ä¸­çš„æ€»å¼€å…³ã€‚
                        </p>
                    </label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="npc-background-activity-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group">
                    <label for="npc-action-cooldown-input">
                        ç‹¬ç«‹è¡ŒåŠ¨å†·å´ (åˆ†é’Ÿ)
                        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                            è¯¥NPCåœ¨åå°ä¸»åŠ¨è¡ŒåŠ¨çš„æœ€å°é—´éš”ã€‚
                        </p>
                    </label>
                    <input type="number" id="npc-action-cooldown-input" min="1" value="15" style="width: 80px; text-align: center;">
                </div>
<!-- â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
            <div class="form-group">
                <label>å…³è”çš„è§’è‰² (NPCä¼šå»è¯„è®ºè¿™äº›è§’è‰²çš„åŠ¨æ€)</label>
                <div id="npc-association-list" style="max-height: 150px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                    <!-- å…³è”è§’è‰²å¤šé€‰æ¡†å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-npc-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-npc-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–¼â–¼â–¼ æ­¥éª¤ 1ï¼šå°†è¿™ä¸ªã€å…¨æ–°çš„æ¨¡æ€æ¡†ã€‘ç²˜è´´åˆ° body å†…å…¶ä»–æ¨¡æ€æ¡†çš„æ—è¾¹ â–¼â–¼â–¼ -->
<div id="clear-posts-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>é€‰æ‹©æ¸…ç©ºèŒƒå›´</span>
        </div>
        <div class="modal-body" id="clear-posts-list" style="padding: 0;">
            <!-- æ¸…ç©ºé€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-clear-posts-btn">å–æ¶ˆ</button>
            <!-- æ·»åŠ äº† btn-danger ç±»ï¼Œè®©æŒ‰é’®æ˜¾ç¤ºä¸ºçº¢è‰²ä»¥ç¤ºè­¦å‘Š -->
            <button class="save btn-danger" id="confirm-clear-posts-btn">ç¡®è®¤æ¸…ç©º</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ç²˜è´´åˆ° #album-photos-screen çš„ div ä¹‹å â–¼â–¼â–¼ -->
        <input type="file" id="album-photo-input" accept="image/*" multiple hidden>
        <div id="chat-interface-screen" class="screen">
            <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸ªäº”å­æ£‹å®¹å™¨ç²˜è´´åˆ°èŠå¤©ç•Œé¢(chat-interface-screen)çš„ã€æœ€é¡¶éƒ¨ã€‘ â–¼â–¼â–¼ -->
            <div id="gomoku-overlay">
                <div id="gomoku-content-wrapper">
                    <canvas id="gomoku-board"></canvas>
                    <div id="gomoku-controls">
                        <button id="close-gomoku-btn">æ”¶èµ·æ£‹ç›˜</button>
                    </div>
                </div>
            </div>
            <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
            <div class="header">
                <div class="default-controls">
                    <span class="back-btn" id="back-to-list-btn">â€¹</span>
                    <div id="global-lyrics-bar"></div>

                    <div id="chat-header-title-wrapper">
                        <span id="chat-header-title">èŠå¤©å¯¹è±¡</span>
                        <div id="chat-header-status">
                            <span class="status-dot"></span>
                            <span class="status-text">åœ¨çº¿</span>
                        </div>
                    </div>
                    <div class="header-actions">
                        <!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢ä½ ç°æœ‰çš„ id="open-memory-screen-btn" çš„ span æ ‡ç­¾ â–¼â–¼â–¼ -->
                        <span class="action-btn" id="open-memory-screen-btn" title="é•¿æœŸè®°å¿†">
                            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨SVGå›¾æ ‡æ›¿æ¢åŸæ¥çš„å›¾ç‰‡ -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M12 6L9 9L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M21 5V19C21 20.1046 20.1046 21 19 21H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                        <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
                        <span class="action-btn" id="listen-together-btn" title="ä¸€èµ·å¬"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="ä¸€èµ·å¬"></span>
                        <span class="action-btn" id="chat-settings-btn" title="èŠå¤©è®¾ç½®"><img src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png" alt="è®¾ç½®"></span>
                    </div>
                </div>
                <!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢ä½ åŸæ¥çš„ .selection-controls div â–¼â–¼â–¼ -->
                <div class="selection-controls">
                    <span id="selection-cancel-btn">å–æ¶ˆ</span>
                    <span id="selection-count"></span>
                    <div class="header-actions">
                        <span id="selection-screenshot-btn" class="action-btn">é•¿æˆªå›¾</span>
                        <span id="selection-favorite-btn" class="action-btn">æ”¶è—</span>
                        <span id="selection-share-btn" class="action-btn">åˆ†äº«</span>
                        <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ—§æŒ‰é’®é‡å‘½åï¼ŒåŠŸèƒ½ä¸å˜ -->
                        <span id="selection-soft-delete-btn" class="action-btn">åˆ é™¤(é€šçŸ¥AI)</span>
                        <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ–°å¢ä¸€ä¸ªçº¢è‰²çš„ã€æ›´å¼ºåŠ›çš„åˆ é™¤æŒ‰é’® -->
                        <span id="selection-erase-btn" class="action-btn" style="color: #ff3b30;">å½»åº•åˆ é™¤</span>
                    </div>
                </div>
                <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
            </div>
            <div id="chat-messages">
                <div id="typing-indicator">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div>
            </div>
            <div id="chat-input-area">
                <div id="chat-at-mention-popup" class="at-mention-popup"></div>
                <div id="reply-preview-bar">
                    <div class="reply-preview-content">
                        <div class="sender">å›å¤ xxx:</div>
                        <div class="text">è¢«å¼•ç”¨çš„æ¶ˆæ¯å†…å®¹...</div>
                    </div>
                    <span id="cancel-reply-btn">Ã—</span>
                </div>
                <div id="chat-input-actions-top">
                    <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="è¡¨æƒ…é¢æ¿">+</button>
                    <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="å‘é€ç…§ç‰‡"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg></button>
                    <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="ä¸Šä¼ å›¾ç‰‡">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            <path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            <path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    </button>
                    <button id="transfer-btn" class="chat-action-icon-btn action-button" title="è½¬è´¦">ï¿¥</button>
                    <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="å‘é€è¯­éŸ³"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <path d="M12 19v4"></path>
                            <path d="M8 23h8"></path>
                        </svg></button>
                    <button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title="å‘èµ·å¤–å–è¯·æ±‚"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <path d="M16 10a4 4 0 0 1-8 0"></path>
                        </svg></button>
                    <button id="video-call-btn" class="chat-action-icon-btn action-button" title="è§†é¢‘é€šè¯"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="23 7 16 12 23 17 23 7"></polygon>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                        </svg></button>
                    <button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="ç¾¤è§†é¢‘é€šè¯"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg></button>
                    <button id="send-poll-btn" class="chat-action-icon-btn action-button" title="å‘èµ·æŠ•ç¥¨"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 6h10"></path>
                            <path d="M6 6h.01"></path>
                            <path d="M8 12h10"></path>
                            <path d="M6 12h.01"></path>
                            <path d="M8 18h10"></path>
                            <path d="M6 18h.01"></path>
                        </svg></button>
                    <button id="share-link-btn" class="chat-action-icon-btn action-button" title="åˆ†äº«é“¾æ¥"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path>
                        </svg></button>
                    <button id="share-location-btn" class="chat-action-icon-btn action-button" title="å…±äº«ä½ç½®"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg></button>
                    <!-- â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°æŒ‰é’®ï¼Œç²˜è´´åˆ° id="chat-input-actions-top" å®¹å™¨çš„æœ«å°¾ â–¼â–¼â–¼ -->
                    <button id="gomoku-btn" class="chat-action-icon-btn action-button" title="äº”å­æ£‹">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <circle cx="12" cy="12" r="4"></circle>
                            <circle cx="12" cy="12" r="7"></circle>
                        </svg>
                    </button>
                    <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
                    <!-- â–¼â–¼â–¼ åœ¨â€œè¡¨æƒ…é¢æ¿â€æŒ‰é’®åï¼Œç²˜è´´è¿™ä¸ªæ–°æŒ‰é’® â–¼â–¼â–¼ -->
                    <button id="open-shopping-btn" class="chat-action-icon-btn action-button" title="è´­ç‰©">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                    </button>
                    <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
                    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å•èŠä¸“ç”¨çš„â€œæ‹ä¸€-æ‹â€æŒ‰é’® (Qå¼¹å›¾æ ‡ç‰ˆ) â–¼â–¼â–¼ -->
                    <button id="pat-btn" class="chat-action-icon-btn action-button" title="æ‹ä¸€-æ‹" style="display: none;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 5.02c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M14.5 11.02c0 .83-.67 1.5-1.5 1.5v0c-.83 0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5v0c.83 0 1.5.67 1.5 1.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M5.5 14.52l-1.92-1.92c-.34-.34-.34-.89 0-1.23l3.58-3.58c.34-.34.89-.34 1.23 0l1.92 1.92c.34.34.34.89 0 1.23l-3.58 3.58c-.34.34-.89.34-1.23 0Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
                    <!-- â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°æŒ‰é’®ï¼Œç²˜è´´åˆ° id="chat-input-actions-top" å®¹å™¨çš„æœ«å°¾ â–¼â–¼â–¼ -->
                    <button id="edit-last-response-btn" class="chat-action-icon-btn action-button" title="å¯¼æ¼”æ¨¡å¼ï¼šç¼–è¾‘AIä¸Šä¸€è½®çš„å®Œæ•´å“åº”">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                    </button>
                    <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
                        <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°æŒ‰é’® â–¼â–¼â–¼ -->
                        <button id="regenerate-btn" class="chat-action-icon-btn action-button" title="é‡æ–°ç”Ÿæˆå›å¤" style="display: flex;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                            </svg>
                        </button>
                        <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°æŒ‰é’® â–¼â–¼â–¼ -->
                        <button id="propel-btn" class="chat-action-icon-btn action-button" title="æ¨è¿›å‰§æƒ…" style="display: flex;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="13 19 22 12 13 5 13 19"></polygon>
                                <polygon points="2 19 11 12 2 5 2 19"></polygon>
                            </svg>
                        </button>
                        <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
                    <button id="show-announcement-board-btn" class="chat-action-icon-btn action-button" title="ç¾¤å…¬å‘Šæ¿" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21.782 6.132a1 1 0 0 0-1.053-.08l-4.729 2.489a1 1 0 0 0-.5.88v4.158a1 1 0 0 0 .5.88l4.729 2.489a1 1 0 0 0 1.053-.08a1 1 0 0 0 .499-.921V7.052a1 1 0 0 0-.499-.92zm-6 3.207L11 7.05v9.9l4.782-2.281V9.339zM10 6H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h6V6z" />
                        </svg>
                    </button>
                </div>
                <div id="chat-input-main-row">
                    <textarea id="chat-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                    <div id="input-actions-wrapper">
                        <button id="wait-reply-btn" title="ç­‰å¾…å›å¤"><img src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png" alt="ç­‰å¾…å›å¤"></button>
                        <button id="send-btn" class="action-button">å‘é€</button>
                    </div>
                </div>
            </div>
            <div id="chat-lock-overlay">
                <div id="chat-lock-content"></div>
            </div>
        <!-- â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ª V2.0 ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ id="sticker-panel" çš„ div â–¼â–¼â–¼ -->
        <div id="sticker-panel">
            <div id="sticker-panel-header">
                <span class="panel-btn" id="close-sticker-panel-btn">å–æ¶ˆ</span>
                <span class="title">æˆ‘çš„è¡¨æƒ…</span>
                <div style="display: flex; gap: 10px;">
                    <span class="panel-btn" id="manage-sticker-categories-btn">åˆ†ç±»</span>
                    <span class="panel-btn" id="manage-stickers-btn">ç®¡ç†</span>
                    <span class="panel-btn" id="add-sticker-batch-btn">æ‰¹é‡</span>
                    <span class="panel-btn" id="add-sticker-url-btn">URL</span>
                    <span class="panel-btn" id="upload-sticker-btn">ä¸Šä¼ </span>
                </div>
            </div>
            <div id="sticker-category-tabs"></div>
            <div id="sticker-grid"></div>

            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†æ—§çš„å•ä¸ªåˆ é™¤æŒ‰é’®ï¼Œå‡çº§ä¸ºä¸€ä¸ªåŒ…å«â€œå…¨é€‰â€å’Œâ€œåˆ é™¤â€çš„æ“ä½œæ  -->
            <div id="sticker-action-bar">
                <label class="select-all-label" style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="select-all-stickers-checkbox"> å…¨é€‰
                </label>
                <button id="delete-selected-stickers-btn">åˆ é™¤ (0)</button>
            </div>
        </div>
        <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
            <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
            <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
<div id="music-player-overlay">
    <!-- â–¼â–¼â–¼ ã€è¯·ç”¨è¿™æ•´å—ä»£ç ã€‘æ›¿æ¢æ—§çš„ .music-player-window â–¼â–¼â–¼ -->
    <div class="music-player-window">
        <div class="music-player-top-actions">
            <div class="top-left-cluster">
                <button id="music-return-btn">â€¹</button>
                <button id="music-exit-btn">Ã—</button>
            </div>
            <span id="music-playlist-btn">â˜°</span>
        </div>

        <!-- æ ¸å¿ƒä¿®æ”¹ï¼šå°†æ­Œæ›²ä¿¡æ¯ç§»åŠ¨åˆ°å”±ç‰‡ä¸Šæ–¹ï¼Œå¹¶ç”¨ä¸€ä¸ªå®¹å™¨åŒ…è£¹ -->
        <div id="music-info-top">
            <div id="music-time-counter">å·²ç»ä¸€èµ·å¬äº†0.0å°æ—¶</div>
            <div id="music-player-song-title">è¯·æ·»åŠ æ­Œæ›²</div>
            <div id="music-player-artist">...</div>
        </div>

        <!-- å”±ç‰‡/æ­Œè¯åˆ‡æ¢å®¹å™¨ä¿æŒä¸å˜ -->
        <div id="music-visual-container">
            <div id="vinyl-view">
                <img id="music-player-cover" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg" alt="Album Art">
            </div>
            <div id="inline-lyrics-view">
                <div id="music-lyrics-container">
                    <div id="music-lyrics-list">
                        <!-- JS ä¼šåœ¨è¿™é‡Œå¡«å……æ­Œè¯ -->
                    </div>
                </div>
            </div>
        </div>
    <div id="single-lyric-display">â™ª â™ª â™ª</div>
        <!-- åº•éƒ¨æ§åˆ¶åŒºåŸŸä¿æŒä¸å˜ -->
        <div class="music-player-controls-wrapper">
            <div class="music-progress-bar-container">
                <div id="music-current-time" class="time-display">0:00</div>
                <div class="progress-bar">
                    <div id="music-progress-fill" class="progress-bar-fill"></div>
                </div>
                <div id="music-total-time" class="time-display">0:00</div>
            </div>
            <div class="music-controls">
                <button id="music-prev-btn">â—€</button>
                <button id="music-play-pause-btn" class="play-pause-btn">â–¶</button>
                <button id="music-next-btn">â–¶</button>
                <button id="music-mode-btn">é¡ºåº</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
</div>
            <div id="music-playlist-panel">
                <div class="playlist-header">
                    <span class="panel-btn" id="close-playlist-btn">è¿”å›</span>
                    <span>æ’­æ”¾åˆ—è¡¨</span>
                    <div>
                     <span class="panel-btn" id="cleanup-songs-btn">æ¸…ç†</span>
                        <span class="panel-btn" id="add-song-local-btn">æœ¬åœ°</span>
                        <span class="panel-btn" id="add-song-url-btn">URL</span>
        <span class="panel-btn" id="add-song-search-btn">æœç´¢</span>
                    </div>
                </div>
                <div class="playlist-body" id="playlist-body"></div>
            </div>
            <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
            <input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">
        </div>
        <!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ã€å·²ä¿®å¤ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ ç°æœ‰çš„ id="wallpaper-screen" çš„é‚£æ•´ä¸ª <div> â–¼â–¼â–¼ -->
        <div id="wallpaper-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
                <span>å¤–è§‚è®¾ç½®</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <!-- EPhone å£çº¸è®¾ç½® -->
                <label style="font-weight: 500; color: var(--text-secondary);">EPhone ä¸»å±å¹•å£çº¸</label>
                <div id="wallpaper-preview">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div>
                <button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">ä¸Šä¼ å£çº¸</button>
                <input type="file" id="wallpaper-upload-input" accept="image/*">
                
                <!-- ã€ã€ã€å…¨æ–°ï¼šCPhone å£çº¸è®¾ç½®ã€‘ã€‘ã€‘ -->
                <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
                <label style="font-weight: 500; color: var(--text-secondary);">CPhone Cphoneå£çº¸</label>
                <div id="cphone-wallpaper-preview">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div>
                <button class="form-button" onclick="document.getElementById('cphone-wallpaper-upload-input').click();">ä¸Šä¼ CPhoneå£çº¸</button>
                <input type="file" id="cphone-wallpaper-upload-input" accept="image/*" hidden>

                <!-- å…¨å±€èŠå¤©èƒŒæ™¯è®¾ç½® -->
                <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
                <label style="font-weight: 500; color: var(--text-secondary);">å…¨å±€èŠå¤©èƒŒæ™¯ (æ‰€æœ‰èŠå¤©é»˜è®¤)</label>
                <div id="global-bg-preview" class="wallpaper-preview" style="height: 160px; width: 90px;">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div>
                <div class="bg-upload-container">
                    <button class="form-button-secondary" onclick="document.getElementById('global-bg-input').click()">ä¸Šä¼ å…¨å±€èƒŒæ™¯</button>
                    <button id="remove-global-bg-btn" class="form-button-secondary">ç§»é™¤å…¨å±€èƒŒæ™¯</button>
                </div>
                <input type="file" id="global-bg-input" accept="image/*" style="display: none;">
                
                <!-- å…¶ä»–è®¾ç½® -->
                <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="theme-toggle-switch" style="margin-bottom: 0;">å¤œé—´æ¨¡å¼</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="theme-toggle-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="status-bar-toggle-switch" style="margin-bottom: 0;">æ˜¾ç¤ºé¡¶éƒ¨çŠ¶æ€æ </label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="status-bar-toggle-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <!-- æç¤ºéŸ³è®¾ç½® -->
                <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
                <div style="width:100%; text-align: left; margin-bottom: 15px;">
                    <label style="font-weight: 500; color: var(--text-secondary);">æ¶ˆæ¯æç¤ºéŸ³</label>
                </div>
                <div class="form-group" style="width:100%;">
                    <label for="notification-sound-url-input">æç¤ºéŸ³æ–‡ä»¶ URL (.mp3, .wav, .ogg)</label>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
                        <input type="text" id="notification-sound-url-input" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤æç¤ºéŸ³" style="flex-grow: 1;">
                        <button id="test-sound-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">â–¶</button>
                        <button id="reset-sound-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">é‡ç½®</button>
                    </div>
                </div>

                <!-- EPhone å›¾æ ‡è®¾ç½® -->
                <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
                <div style="width:100%; text-align: left; margin-bottom: 15px;">
                    <label style="font-weight: 500; color: var(--text-secondary);">EPhone App å›¾æ ‡è®¾ç½®</label>
                </div>
                <div id="icon-settings-grid"></div>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨è¿™é‡Œç²˜è´´èŠå¤©å·¥å…·æ æ’åºåŠŸèƒ½ â–¼â–¼â–¼ -->
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
<div class="form-group" style="width:100%;">
    
    <!-- è¿™é‡Œæ˜¯ä¿®æ”¹åçš„æ ·å­ -->
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <label>èŠå¤©å·¥å…·æ æŒ‰é’®æ’åº</label>
        <button id="reset-button-order-btn" title="æ¢å¤é»˜è®¤é¡ºåº" class="form-button-secondary" style="margin: 0; padding: 4px 12px; font-size: 13px;">é‡ç½®é¡ºåº</button>
    </div>
    
    <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
        æŒ‰ä½ä¸‹æ–¹çš„æŒ‰é’®å¹¶æ‹–åŠ¨å³å¯æ’åºï¼Œè®¾ç½®ä¼šè‡ªåŠ¨ä¿å­˜ã€‚
    </p>
    <div id="button-order-editor" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background-color: #f0f2f5; border-radius: 8px; border: 1px solid var(--border-color);">
        <!-- æŒ‰é’®æ’åºé¡¹å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
                <!-- ã€ã€ã€å…¨æ–°ï¼šCPhone å›¾æ ‡è®¾ç½®ã€‘ã€‘ã€‘ -->
                <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
                <div style="width:100%; text-align: left; margin-bottom: 15px;">
                    <label style="font-weight: 500; color: var(--text-secondary);">CPhone App å›¾æ ‡è®¾ç½®</label>
                </div>
                <div id="cphone-icon-settings-grid"></div>

                <!-- CSS é¢„è®¾ -->
                <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
                <h3 style="margin-top:0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; width:100%; text-align: left;">CSS é¢„è®¾ç®¡ç†</h3>
                <div class="form-group" style="width:100%;">
                    <label for="css-preset-select">é€‰æ‹©æˆ–åˆ‡æ¢é¢„è®¾</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="css-preset-select" style="flex-grow: 1;"></select>
                        <button id="save-css-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ä¿å­˜</button>
                        <button id="delete-css-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">åˆ é™¤</button>
                    </div>
                </div>
                <div class="form-group" style="width:100%;">
                    <label for="global-css-input"> å…¨å±€ç¾åŒ–æ ·å¼ (CSS) <button id="reset-global-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">é‡ç½®</button>
                    </label>
                    <textarea id="global-css-input" rows="6" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 16px; resize: vertical;" placeholder="/* åœ¨æ­¤è¾“å…¥è‡ªå®šä¹‰CSS */"></textarea>
                </div>
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->

<button class="form-button form-button-secondary" id="import-appearance-btn" style="margin-top: 10px;">å¯¼å…¥å¤–è§‚ (JSON)</button>
<input type="file" id="import-appearance-input" accept="application/json" hidden>

<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->                
                <!-- ä¿å­˜æŒ‰é’® -->
                <button class="form-button" id="save-wallpaper-btn" style="margin-top: 30px;">ä¿å­˜æ‰€æœ‰å¤–è§‚è®¾ç½®</button>
            </div>
        </div>

        <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«é“¾æ¥åŠŸèƒ½ HTML â–¼â–¼â–¼ -->
        <div id="browser-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="browser-back-btn">â€¹</span>
                <span id="browser-title"></span>
                <span style="width: 30px;"></span>
            </div>
            <div id="browser-content" class="list-container">
                <!-- æ–‡ç« å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
        <div id="font-settings-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
                <span>å­—ä½“è®¾ç½®</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
                <!-- ã€ã€ã€å…¨æ–°ï¼šå­—ä½“é¢„è®¾ç®¡ç†ã€‘ã€‘ã€‘ -->
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">å­—ä½“é¢„è®¾ç®¡ç†</h3>
                <div class="form-group">
                    <label for="font-preset-select">é€‰æ‹©æˆ–åˆ‡æ¢é¢„è®¾</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="font-preset-select" style="flex-grow: 1;"></select>
                        <button id="save-font-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ä¿å­˜</button>
                        <button id="delete-font-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">åˆ é™¤</button>
                    </div>
                </div>
                <hr style="margin: 30px 0; opacity: 0.3;">
                <!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
                <div class="form-group">
                    <label for="font-url-input">å­—ä½“æ–‡ä»¶URL (.ttf, .otf, .woffç­‰)</label>
                    <input type="text" id="font-url-input" placeholder="https://..../font.ttf">
                </div>
                <div class="form-group">
                    <label>å®æ—¶é¢„è§ˆ</label>
                    <div id="font-preview">
                        <p style="font-size: 20px; margin: 0 0 10px 0;">ä½ å¥½ä¸–ç•Œ Hello World</p>
                        <p style="margin: 0;">è¿™æ˜¯å­—ä½“é¢„è§ˆæ•ˆæœï¼Œ12345ã€‚</p>
                    </div>
                </div>
                <button class="form-button" id="save-font-btn">ä¿å­˜å¹¶åº”ç”¨</button>
                <button class="form-button form-button-secondary" id="reset-font-btn">æ¢å¤é»˜è®¤å­—ä½“</button>
            </div>
        </div>
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€‰æ‹©è”ç³»äººä»¥åˆ›å»ºç¾¤èŠçš„å±å¹• â–¼â–¼â–¼ -->
        <div id="contact-picker-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="cancel-contact-picker-btn">å–æ¶ˆ</span>
                <span>é€‰æ‹©è”ç³»äºº</span>
                <span class="save-btn" id="confirm-contact-picker-btn">å®Œæˆ(0)</span>
            </div>
            <div class="list-container" id="contact-picker-list">
                <!-- è”ç³»äººåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†å±å¹• â–¼â–¼â–¼ -->
        <div id="member-management-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="back-from-member-management">â€¹</span>
                <span>ç¾¤æˆå‘˜ç®¡ç†</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="list-container" id="member-management-list">
                <!-- ç°æœ‰æˆå‘˜åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div id="member-management-actions">
                <button id="add-existing-contact-btn">ä»å¥½å‹åˆ—è¡¨æ·»åŠ </button>
                <button id="create-new-member-btn">åˆ›å»ºç¾¤å†…æ–°æˆå‘˜</button>
            </div>
        </div>
        <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸ªå¼¹çª—HTMLç²˜è´´åˆ°å…¶ä»–æ‰€æœ‰ modal çš„æ—è¾¹ â–¼â–¼â–¼ -->
    <div id="sticker-category-manager-modal" class="modal">
        <div class="modal-content" style="height: 60%;">
            <div class="modal-header">
                <span>ç®¡ç†è¡¨æƒ…åˆ†ç±»</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ–°å»ºåˆ†ç±»</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-sticker-category-name-input" placeholder="è¾“å…¥åˆ†ç±»å..." style="flex-grow: 1;">
                        <button id="add-new-sticker-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                    </div>
                </div>
                <hr style="opacity: 0.2;">
                <div id="existing-sticker-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- åˆ†ç±»åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-sticker-category-manager-btn" style="width: 100%;">å®Œæˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¥ç”µè¯·æ±‚æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
        <div id="incoming-call-modal" class="modal">
            <div class="incoming-call-content">
                <img id="caller-avatar" class="caller-avatar" src="">
                <div id="caller-name" class="caller-name"></div>
                <div class="caller-text">é‚€è¯·ä½ è§†é¢‘é€šè¯</div>
                <div class="incoming-call-actions">
                    <div class="action-button-wrapper">
                        <button id="decline-call-btn" class="call-action-btn decline"></button>
                        <span>æ‹’ç»</span>
                    </div>
                    <div class="action-button-wrapper">
                        <button id="accept-call-btn" class="call-action-btn accept"></button>
                        <span>æ¥å¬</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€å…¨æ–°ç¾¤èŠå…¼å®¹ç»“æ„ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ #video-call-screen â–¼â–¼â–¼ -->
        <div id="video-call-screen" class="screen">
            <!-- 1. é¡¶éƒ¨æ  (ä¿æŒä¸å˜) -->
            <div class="video-call-top-bar">
                <span id="call-timer">00:00</span>
            </div>
            <!-- 2. ã€å‡çº§ã€‘å‚ä¸è€…å¤´åƒç½‘æ ¼åŒºåŸŸ -->
            <div class="video-call-avatar-area">
                <div id="participant-avatars-grid">
                    <!-- JSä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆå¤´åƒ -->
                </div>
            </div>
            <!-- 3. å¯¹è¯æ¡†åŒºåŸŸ (ä¿æŒä¸å˜) -->
            <div id="video-call-main" class="video-call-main">
                <!-- å¯¹è¯å†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <!-- 4. ã€å‡çº§ã€‘åº•éƒ¨æ§åˆ¶æ ï¼Œç°åœ¨åŒ…å«ä¸€ä¸ªâ€œåŠ å…¥â€æŒ‰é’® -->
            <div class="video-call-controls">
                <button id="user-speak-btn" class="control-btn speak-btn"></button>

                <button id="hang-up-btn" class="control-btn hangup-btn"></button>
                <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°æŒ‰é’® â–¼â–¼â–¼ -->
                <button id="regenerate-call-btn" class="control-btn regenerate-btn"></button>
                <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
                <!-- è¿™ä¸ªæŒ‰é’®é»˜è®¤éšè—ï¼Œåªåœ¨ç”¨æˆ·â€œæ—è§‚â€æ—¶æ˜¾ç¤º -->
                <button id="join-call-btn" class="control-btn join-btn" style="display: none;"></button>
            </div>
        </div>
        <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘æ­£åœ¨å‘¼å«ç•Œé¢ â–¼â–¼â–¼ -->
        <div id="outgoing-call-screen" class="screen">
            <div class="outgoing-call-content">
                <img id="outgoing-call-avatar" class="caller-avatar" src="">
                <div id="outgoing-call-name" class="caller-name"></div>
                <div class="caller-text">æ­£åœ¨å‘¼å«...</div>
                <div class="outgoing-call-actions">
                    <button id="cancel-call-btn" class="call-action-btn decline"></button>
                    <span>å–æ¶ˆ</span>
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•é¡µé¢ â–¼â–¼â–¼ -->
        <div id="call-history-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="call-history-back-btn">â€¹</span>
                <span id="call-history-title">é€šè¯è®°å½•</span>
                <span style="width: 30px;"></span> <!-- å ä½ç¬¦ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­ -->
            </div>
            <div id="call-history-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                <!-- é€šè¯è®°å½•å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- =================================================================== -->
<!-- â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ‰€æœ‰æ—§çš„è±†ç“£HTML â–¼â–¼â–¼ -->
<!-- =================================================================== -->

<!-- 1. è±†ç“£å°ç»„å¸–å­åˆ—è¡¨å±å¹• -->
<div id="douban-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>è±†ç“£å°ç»„</span>
        <div class="header-actions">
            <span class="action-btn" id="douban-cast-select-btn" title="é€‰æ‹©å‚ä¸è§’è‰²">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </span>
            <span class="action-btn" id="regenerate-douban-btn" title="é‡æ–°ç”Ÿæˆå†…å®¹">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </span>
        </div>
    </div>
    <div id="douban-posts-list" class="list-container">
        <!-- AIç”Ÿæˆçš„å¸–å­å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>
</div>

<!-- 2. è±†ç“£å¸–å­è¯¦æƒ…é¡µå±å¹• -->
<div id="douban-post-detail-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="douban-detail-back-btn">â€¹</span>
        <span id="douban-post-detail-title">å¸–å­è¯¦æƒ…</span>
        <span style="width: 30px;"></span>
    </div>
    <div id="douban-detail-content-wrapper" class="list-container">
        <div id="douban-post-detail-body">
            <div class="douban-post-header">
                <img id="douban-detail-avatar" class="douban-post-avatar">
                <div class="douban-author-info">
                    <div id="douban-detail-author" class="douban-author-name"></div>
                    <div id="douban-detail-group" class="douban-group-name"></div>
                </div>
            </div>
            <h2 id="douban-detail-post-title" class="douban-post-title"></h2>
            <div id="douban-detail-content" class="douban-detail-content"></div>
        </div>
        <div class="douban-comments-section">
            <h4>å›åº”</h4>
            <div id="douban-detail-comments-list"></div>
        </div>
    </div>
    <div id="douban-comment-footer" class="post-footer">
        <div class="comment-section">
            <img id="douban-my-comment-avatar" src="" class="comment-avatar">
            <input type="text" id="douban-comment-input" class="comment-input" placeholder="å†™å›åº”...">
        </div>
        <button id="douban-wait-reply-btn" class="douban-feather-btn" title="è®©AIç»§ç»­è®¨è®º">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                <line x1="16" y1="8" x2="2" y2="22"></line>
                <line x1="17.5" y1="15" x2="9" y2="15"></line>
            </svg>
        </button>
        <button id="douban-send-comment-btn" class="comment-send-btn">å‘é€</button>
    </div>
</div>

<!-- =================================================================== -->
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- =================================================================== -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è´­ç‰©åŠŸèƒ½ç›¸å…³é¡µé¢ä¸å¼¹çª— (V4.0 - ä»¿æ·˜å®ç»ˆæç‰ˆ) â–¼â–¼â–¼ -->
        <div id="shopping-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="shopping-back-btn">â€¹</span>
                <span>è´­ç‰©ä¸­å¿ƒ</span>
                <div class="header-actions">
                    <!-- â€œç®¡ç†â€æŒ‰é’®å·²æ›¿æ¢ä¸ºSVGå›¾æ ‡ -->
                    <span class="action-btn" id="manage-products-btn" title="ç®¡ç†å•†å“">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                        </svg>
                    </span>
                    <!-- æ–°å¢çš„â€œæ·»åŠ å•†å“â€SVGå›¾æ ‡æŒ‰é’® -->
                    <span class="action-btn" id="add-new-product-btn" title="æ·»åŠ æ–°å•†å“">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                    </span>
                    <!-- è´­ç‰©è½¦æŒ‰é’®ä¿æŒä¸å˜ -->
                    <!-- â–¼â–¼â–¼ ã€å…¨æ–°SVGå›¾æ ‡ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„è´­ç‰©è½¦å›¾æ ‡ â–¼â–¼â–¼ -->
                    <span class="action-btn" id="go-to-cart-btn" title="æŸ¥çœ‹è´­ç‰©è½¦">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                        <span id="cart-count">0</span>
                    </span>
                    <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
                </div>
            </div>
            <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
            <div id="product-grid" class="list-container">
                <!-- å•†å“å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘å•†å“è¯¦æƒ…é¡µ -->
        <div id="product-detail-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="product-detail-back-btn">â€¹</span>
                <span>å•†å“è¯¦æƒ…</span>
                <span style="width: 30px;"></span>
            </div>
            <div id="product-detail-content" class="list-container">
                <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div id="product-detail-footer">
                <button class="footer-btn add-to-cart-detail-btn">åŠ å…¥è´­ç‰©è½¦</button>
                <button class="footer-btn buy-now-btn">ç«‹å³è´­ä¹°</button>
            </div>
        </div>
        <div id="cart-screen" class="screen">
            <!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µæ–°ä»£ç æ›¿æ¢è´­ç‰©è½¦é¡µé¢çš„Header â–¼â–¼â–¼ -->
            <div class="header">
                <span class="back-btn" id="cart-back-btn">â€¹</span>
                <span id="cart-title">è´­ç‰©è½¦(0)</span>
                <span class="action-btn" id="clear-cart-btn">æ¸…ç©º</span> <!-- å°†â€œç®¡ç†â€æ›¿æ¢ä¸ºâ€œæ¸…ç©ºâ€åŠŸèƒ½ -->
            </div>
            <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
            <div id="cart-items-list" class="list-container">
                <!-- è´­ç‰©è½¦å•†å“å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div id="cart-footer">
                <label class="select-all-label"><input type="checkbox" id="select-all-cart-items"> å…¨é€‰</label>
                <div class="cart-summary">
                    <div id="cart-total">åˆè®¡: Â¥0.00</div>
                    <span class="cart-subtext">ä¸å«è¿è´¹</span>
                </div>
                <button id="checkout-btn">ç»“ç®—(0)</button>
            </div>
        </div>
        <div id="product-editor-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span id="product-editor-title">æ·»åŠ å•†å“</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>å•†å“å›¾ç‰‡</label>
                        <div class="avatar-upload">
                            <img id="product-image-preview" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756206115802_qdqqd_0c99bh.jpeg">
                            <button onclick="document.getElementById('product-image-input').click()">ä¸Šä¼ å›¾ç‰‡</button>
                            <input type="file" id="product-image-input" accept="image/*" hidden>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="product-name-input">å•†å“åç§°</label>
                        <input type="text" id="product-name-input">
                    </div>
                    <div class="form-group">
                        <label for="product-price-input">ä»·æ ¼ (å…ƒ)</label>
                        <input type="number" id="product-price-input" min="0" step="0.01">
                    </div>
                    <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘å•†å“æè¿°è¾“å…¥æ¡† -->
                    <div class="form-group">
                        <label for="product-description-input">å•†å“æè¿°</label>
                        <textarea id="product-description-input" rows="4" placeholder="è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™ä¸ªå•†å“..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="cancel" id="cancel-product-editor-btn">å–æ¶ˆ</button>
                    <button class="save" id="save-product-btn">ä¿å­˜</button>
                </div>
            </div>
        </div>
        <div id="gift-receipt-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span>è´­ç‰©å°ç¥¨</span>
                </div>
                <div class="modal-body" id="gift-receipt-body">
                    <!-- å°ç¥¨å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="modal-footer">
                    <button class="save" id="close-receipt-btn" style="width:100%;">å…³é—­</button>
                </div>
            </div>
        </div>
        <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
    </div>

    </div>

    <input type="file" id="import-card-input" accept=".json,.png" style="display: none;">
   <input type="file" id="import-world-book-input" accept=".json" style="display: none;">
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è®¾ç½®é¡µé¢ç»“æ„ â–¼â–¼â–¼ -->
<div id="chat-settings-screen" class="screen">
    <!-- 1. é¡µé¢çš„å¤´éƒ¨ï¼ŒåŒ…å«è¿”å›å’Œä¿å­˜æŒ‰é’® -->
    <div class="header">
        <span class="back-btn" onclick="showScreen('chat-interface-screen')">â€¹</span>
        <span>èŠå¤©è®¾ç½®</span>
        <span class="save-btn" id="save-chat-settings-btn">ä¿å­˜</span>
    </div>

    <!-- 2. é¡µé¢çš„å†…å®¹å®¹å™¨ï¼Œç°åœ¨å¯ä»¥æ»šåŠ¨äº† -->
    <div class="form-container">
        <!-- 
          è¿™é‡Œçš„å†…å®¹å°±æ˜¯ä½ åŸæ¥ modal-body é‡Œçš„æ‰€æœ‰ form-groupã€‚
          æˆ‘ä»¬å·²ç»å°†å®ƒä»¬åŸå°ä¸åŠ¨åœ°ç§»åŠ¨åˆ°è¿™é‡Œäº†ã€‚
        -->
        <div class="form-group" id="chat-name-group"><label for="chat-name-input">å¤‡æ³¨å / ç¾¤å</label><input type="text" id="chat-name-input"></div>
        <div class="form-group" id="my-nickname-group">
            <label for="my-nickname-input">æˆ‘çš„æ˜µç§°</label>
            <input type="text" id="my-nickname-input">
        </div>
        <div class="form-group" id="assign-group-section" style="display: none;">
            <label for="assign-group-select">å¥½å‹åˆ†ç»„</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <select id="assign-group-select" style="flex-grow: 1;"></select>
                <button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ç®¡ç†åˆ†ç»„</button>
            </div>
        </div>
        <div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">æˆ‘çš„ç¾¤æ˜µç§°</label><input type="text" id="my-group-nickname-input"></div>
        <button class="form-button form-button-secondary" id="search-history-btn" style="margin-top: 10px;">æœç´¢èŠå¤©è®°å½•</button>
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
<div class="form-group" id="single-char-background-activity-group">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <label for="char-background-activity-switch" style="margin-bottom: 0;">
            å¯ç”¨ç‹¬ç«‹åå°æ´»åŠ¨
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                å…è®¸è¯¥è§’è‰²åœ¨åå°ç‹¬ç«‹å‘æ¶ˆæ¯æˆ–åŠ¨æ€ã€‚éœ€åŒæ—¶å¼€å¯APIè®¾ç½®ä¸­çš„æ€»å¼€å…³ã€‚
            </p>
        </label>
        <label class="toggle-switch">
            <input type="checkbox" id="char-background-activity-switch">
            <span class="slider"></span>
        </label>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
        <div class="form-group" id="ai-cooldown-group">
            <label for="ai-action-cooldown-input"> ç‹¬ç«‹è¡ŒåŠ¨å†·å´ (åˆ†é’Ÿ) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> AIåœ¨åå°ä¸»åŠ¨å‘æ¶ˆæ¯æˆ–åŠ¨æ€çš„æœ€å°é—´éš”ã€‚ </p>
            </label>
            <input type="number" id="ai-action-cooldown-input" min="1" value="10" style="width: 80px; text-align: center;">
        </div>
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ—¶é—´æ„ŸçŸ¥å¼€å…³ â–¼â–¼â–¼ -->
        <div class="form-group" id="time-perception-group">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label for="time-perception-toggle" style="margin-bottom: 0;">
                    å¯ç”¨æ—¶é—´æ„ŸçŸ¥
                    <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                        å…³é—­åï¼ŒAIå°†ä¸ä¼šæ¥æ”¶åˆ°å½“å‰æ—¶é—´ä¿¡æ¯ï¼Œå¯¹è¯ä¸­ä¸å†ä½“ç°æ—¶é—´å˜åŒ–ã€‚
                    </p>
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="time-perception-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<div class="form-group" id="group-background-activity-group">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <label for="group-background-activity-switch" style="margin-bottom: 0;">
            å¯ç”¨ç¾¤å†…åå°æ´»åŠ¨
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                å…è®¸AIæˆå‘˜åœ¨è¯¥ç¾¤èŠä¸­ç‹¬ç«‹è¡ŒåŠ¨ã€‚éœ€åŒæ—¶å¼€å¯APIè®¾ç½®ä¸­çš„æ€»å¼€å…³ã€‚
            </p>
        </label>
        <label class="toggle-switch">
            <input type="checkbox" id="group-background-activity-switch">
            <span class="slider"></span>
        </label>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
        <div class="form-group" id="group-cooldown-group">
            <label for="group-action-cooldown-input"> ç¾¤èŠè¡ŒåŠ¨å†·å´ (åˆ†é’Ÿ) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> AIåœ¨åå°ä¸»åŠ¨åœ¨ç¾¤å†…è¡ŒåŠ¨çš„æœ€å°é—´éš”ã€‚ </p>
            </label>
            <input type="number" id="group-action-cooldown-input" min="1" value="10" style="width: 80px; text-align: center;">
        </div>
        <div class="form-group" id="group-avatar-group">
            <label>ç¾¤å¤´åƒ</label>
            <div class="avatar-upload">
                <img id="group-avatar-preview">
                <button onclick="document.getElementById('group-avatar-input').click()">ä¸Šä¼ ç¾¤å¤´åƒ</button>
                <button id="manage-group-avatar-library-btn">ç®¡ç†å¤´åƒåº“</button>
                <input type="file" id="group-avatar-input" accept="image/*">
            </div>
        </div>
        <div class="form-group" id="world-book-link-group">
            <label>å…³è”ä¸–ç•Œä¹¦ (å¯å¤šé€‰)</label>
            <div class="custom-multiselect">
                <div class="select-box">
                    <span class="selected-options-text">-- ç‚¹å‡»é€‰æ‹© --</span>
                    <span class="arrow-down">â–¼</span>
                </div>
                <div id="world-book-checkboxes-container" class="checkboxes-container">
                </div>
            </div>
        </div>
        <div class="form-group" id="lyrics-position-group" style="display: none;">
            <hr style="opacity: 0.3; margin: 20px 0;">
            <label>æ­Œè¯æ ä½ç½®</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                <div>
                    <label for="lyrics-vertical-pos" style="font-size: 0.9em; color: var(--text-secondary);">å‚ç›´ä½ç½®</label>
                    <select id="lyrics-vertical-pos" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <option value="top">é¡¶éƒ¨</option>
                        <option value="bottom">åº•éƒ¨</option>
                    </select>
                </div>
                <div>
                    <label for="lyrics-horizontal-pos" style="font-size: 0.9em; color: var(--text-secondary);">æ°´å¹³å¯¹é½</label>
                    <select id="lyrics-horizontal-pos" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <option value="left">å±…å·¦</option>
                        <option value="center">å±…ä¸­</option>
                        <option value="right">å±…å³</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <label for="lyrics-offset-input" style="font-size: 0.9em; color: var(--text-secondary);">å‚ç›´åç§» (px)</label>
                <input type="number" id="lyrics-offset-input" value="10" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; box-sizing: border-box;">
            </div>
        </div>
        <div class="form-group" id="offline-mode-group">
            <hr style="opacity: 0.3; margin: 20px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label for="offline-mode-toggle" style="margin-bottom: 0;"> å¯ç”¨çº¿ä¸‹æ¨¡å¼ <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> å¼€å¯å, AIçš„å›å¤å°†å˜ä¸ºåŒ…å«ã€Œå¯¹è¯ã€å’Œ<i style="color: #666;">åŠ¨ä½œ/ç¯å¢ƒæå†™</i>çš„å‰§æƒ…æ¨¡å¼ã€‚ </p>
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="offline-mode-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="offline-mode-options" style="display: none; margin-top: 15px;">
                <label for="offline-min-length-input">å›å¤å­—æ•°èŒƒå›´</label>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                    <input type="number" id="offline-min-length-input" value="100" style="width: 80px; text-align: center;">
                    <span>åˆ°</span>
                    <input type="number" id="offline-max-length-input" value="300" style="width: 80px; text-align: center;">
                    <span>å­—</span>
                </div>
    <div class="form-group" style="margin-top: 15px; margin-bottom: 0;">
        <label for="offline-preset-select">æ–‡é£é¢„è®¾ (å°†å½±å“AIçš„æå†™é£æ ¼)</label>
        <select id="offline-preset-select" style="width: 100%; margin-top: 5px;"></select>
    </div>
            </div>
        </div>
        <div class="form-group" id="linked-memory-group">
            <label for="link-memory-toggle">æŒ‚è½½å…¶ä»–èŠå¤©è®°å¿†</label>
            <input type="checkbox" id="link-memory-toggle" style="width: auto; height: 20px; vertical-align: middle; margin-left: 10px;">
            <div id="linked-memory-selection" style="display: none; margin-top: 10px;">
                <label>é€‰æ‹©è¦æŒ‚è½½è®°å¿†çš„èŠå¤© (å¯å¤šé€‰):</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">-- ç‚¹å‡»é€‰æ‹© --</span>
                        <span class="arrow-down">â–¼</span>
                    </div>
                    <div id="linked-chats-checkboxes-container" class="checkboxes-container" style="max-height: 120px;">
                    </div>
                </div>
                <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px; line-height: 1.5;"> â€¢ æŒ‚è½½çš„è®°å¿†ä¼šä»¥â€œå‚è€ƒè®°å¿†â€çš„å½¢å¼æä¾›ç»™AIï¼Œä¸ä¼šç›´æ¥æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢ã€‚<br> â€¢ å»ºè®®æ¯ä¸ªèŠå¤©æŒ‚è½½3-10è½®è®°å¿†ï¼Œé¿å…å½±å“å“åº”é€Ÿåº¦ã€‚ </p>
            </div>
        </div>
        <div class="form-group" id="ai-original-name-group">
            <label for="ai-original-name-input">å¯¹æ–¹æœ¬å (AIè¯†åˆ«ç”¨)</label>
            <input type="text" id="ai-original-name-input">
        </div>
        <div class="form-group" id="ai-persona-group"><label for="ai-persona">å¯¹æ–¹äººè®¾ (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div>
        <div class="form-group" id="ai-avatar-group"><label>å¯¹æ–¹å¤´åƒ</label>
            <div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">ä¸Šä¼ å¯¹æ–¹å¤´åƒ</button><button id="manage-ai-avatar-library-btn">ç®¡ç†å¤´åƒåº“</button><button class="change-frame-btn" data-type="ai">æ›´æ¢å¤´åƒæ¡†</button>
                <input type="file" id="ai-avatar-input" accept="image/*">
            </div>
        </div>
        <div class="form-group" id="my-persona-group"><label for="my-persona">æˆ‘çš„äººè®¾ (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div>
        <div class="form-group" id="switch-greeting-group" style="display: none;">
            <label>åˆ‡æ¢å¼€åœº (ä¼šæ¸…ç©ºå½“å‰å¯¹è¯)</label>
            <button id="switch-greeting-btn" class="form-button form-button-secondary" style="margin-top: 5px;">é€‰æ‹©å…¶ä»–å¼€åœºæ•…äº‹...</button>
        </div>
        <div class="form-group" id="my-avatar-group">
            <label>æˆ‘çš„å¤´åƒ</label>
            <div class="avatar-upload">
                <img id="my-avatar-preview">
                <button onclick="document.getElementById('my-avatar-input').click()">ä¸Šä¼ æˆ‘çš„å¤´åƒ</button>
                <button id="manage-my-avatar-library-btn">ç®¡ç†å¤´åƒåº“</button>
                <button class="change-frame-btn" data-type="my">æ›´æ¢å¤´åƒæ¡†</button>
                <button id="open-persona-library-btn">é¢„è®¾</button>
                <input type="file" id="my-avatar-input" accept="image/*">
            </div>
        </div>
        <div class="form-group" id="group-members-group"><label>ç¾¤æˆå‘˜äººè®¾</label>
            <div id="group-members-settings"></div>
            <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;">ç®¡ç†ç¾¤æˆå‘˜</button>
        </div>
        <div class="form-group">
            <label for="max-memory">çŸ­æœŸè®°å¿†ï¼ˆä¸Šä¸‹æ–‡ï¼‰æ¡æ•°</label>
            <input type="number" id="max-memory" value="10">
        </div>
        <div class="form-group">
            <label for="linked-memory-count">æŒ‚è½½è®°å¿†æ¡æ•°</label>
            <input type="number" id="linked-memory-count" value="10">
            <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px; line-height: 1.5;"> â€¢ æ¯æ¬¡è°ƒç”¨æ—¶ï¼Œä»æ¯ä¸ªâ€œæŒ‚è½½çš„èŠå¤©â€ä¸­æå–æœ€åå‡ æ¡è®°å½•ä½œä¸ºå‚è€ƒè®°å¿†ã€‚ <br> â€¢ å»ºè®®å€¼ 5-20ã€‚å€¼è¶Šå¤§è®°å¿†è¶Šå…¨ï¼Œä½†APIè´¹ç”¨è¶Šé«˜ã€å“åº”è¶Šæ…¢ã€‚ </p>
        </div>
        <hr style="opacity: 0.3; margin: 20px 0;">
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
            <label for="auto-memory-toggle" style="margin-bottom: 0;"> å¯ç”¨è‡ªåŠ¨æ€»ç»“é•¿æœŸè®°å¿† <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> å¼€å¯åï¼ŒAIä¼šåœ¨å¯¹è¯è¾¾åˆ°ä¸€å®šé•¿åº¦æ—¶ï¼Œè‡ªåŠ¨å°†å†…å®¹æç‚¼ä¸ºé•¿æœŸè®°å¿†ã€‚ </p>
            </label>
            <label class="toggle-switch">
                <input type="checkbox" id="auto-memory-toggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="form-group">
            <label for="auto-memory-interval">è‡ªåŠ¨æ€»ç»“é—´éš”ï¼ˆæ¶ˆæ¯æ¡æ•°ï¼‰</label>
            <input type="number" id="auto-memory-interval" min="10" value="20" style="width: 80px; text-align: center;">
            <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px;"> å»ºè®®å€¼ 15-30ã€‚å€¼è¶Šå°ï¼Œæ€»ç»“è¶Šé¢‘ç¹ï¼Œä½†APIè´¹ç”¨ä¹Ÿè¶Šé«˜ã€‚ </p>
        </div>
        <hr style="opacity: 0.3; margin: 20px 0;">
        <div class="form-group">
            <label>èŠå¤©æ°”æ³¡ä¸»é¢˜ <button id="reset-theme-btn" type="button">é‡ç½®</button></label>
            <div class="theme-selector">
                <label><input type="radio" name="theme-select" value="default" id="theme-default"> é»˜è®¤</label>
                <label><input type="radio" name="theme-select" value="pink_blue"> ç²‰è“</label>
                <label><input type="radio" name="theme-select" value="blue_white"> è“ç™½</label>
                <label><input type="radio" name="theme-select" value="purple_yellow"> ç´«é»„</label>
                <label><input type="radio" name="theme-select" value="black_white"> é»‘ç™½</label>
                <label><input type="radio" name="theme-select" value="yellow_white"> é»„ç™½</label>
                <label><input type="radio" name="theme-select" value="red_black"> çº¢é»‘</label>
                <label><input type="radio" name="theme-select" value="blue_yellow"> è“é»„</label>
                <label><input type="radio" name="theme-select" value="pink_yellow"> ç²‰é»„</label>
                <label><input type="radio" name="theme-select" value="pink_purple"> ç²‰ç´«</label>
                <label><input type="radio" name="theme-select" value="gray_white"> ç°ç™½</label>
                <label><input type="radio" name="theme-select" value="blue_green"> è“ç»¿</label>
                <label><input type="radio" name="theme-select" value="pink_white"> ç²‰ç™½</label>
                <label><input type="radio" name="theme-select" value="pink_black"> ç²‰é»‘</label>
                <label><input type="radio" name="theme-select" value="pink_green"> ç²‰ç»¿</label>
                <label><input type="radio" name="theme-select" value="green_black"> ç»¿é»‘</label>
            </div>
        </div>
        <div class="form-group">
            <label for="font-size-slider">èŠå¤©å­—ä½“å¤§å° <span id="font-size-value">13px</span></label>
            <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
        </div>
        <!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
        <!-- ã€ã€ã€å…¨æ–°ï¼šæ°”æ³¡ä¸»é¢˜é¢„è®¾ç®¡ç†ã€‘ã€‘ã€‘ -->
        <hr style="opacity: 0.3; margin: 20px 0;">
        <div class="form-group">
            <label for="theme-preset-select">ä¸»é¢˜é¢„è®¾ç®¡ç†</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <select id="theme-preset-select" style="flex-grow: 1;"></select>
                <button id="save-theme-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ä¿å­˜</button>
                <button id="delete-theme-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">åˆ é™¤</button>
            </div>
        </div>
        <!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
        <div class="form-group">
            <label for="custom-css-input"> è‡ªå®šä¹‰æ°”æ³¡æ ·å¼ (CSS) <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">é‡ç½®</button>
            </label>
            <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 16px; resize: vertical;" placeholder="/* ç¤ºä¾‹ï¼šä¸ºâ€œæˆ‘â€çš„æ°”æ³¡æ·»åŠ æ¸å˜èƒŒæ™¯å’Œé˜´å½± */ .message-bubble.user .content { background: linear-gradient(135deg, #a1c4fd, #c2e9fb); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 15px 4px 15px 15px; }"></textarea>
        </div>
        <div class="form-group">
            <label>å®æ—¶é¢„è§ˆ</label>
            <div id="settings-preview-area"></div>
        </div>
        <div class="form-group">
            <label>èŠå¤©èƒŒæ™¯</label>
            <div class="bg-upload-container">
                <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">ä¸Šä¼ èƒŒæ™¯å›¾</button>
                <button type="button" id="remove-bg-btn">ç§»é™¤èƒŒæ™¯</button>
            </div>
            <img id="bg-preview" class="bg-preview-img">
            <input type="file" id="bg-input" accept="image/*" style="display: none;">
        </div>
        <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
        <button class="form-button form-button-secondary" id="block-chat-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">æ‹‰é»‘å¯¹æ–¹</button>
<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼ -->
<hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
<button class="form-button form-button-secondary" id="export-single-chat-btn" style="background-color: #e8f5e9; color: #2e7d32; border-color: #c8e6c9;">å¯¼å‡ºè¯¥èŠå¤©</button>
<button class="form-button form-button-secondary" id="import-single-chat-btn" style="background-color: #fff3e0; color: #ef6c00; border-color: #ffe0b2;">å¯¼å…¥è¯¥èŠå¤©</button>
<input type="file" id="import-single-chat-input" accept="application/json" hidden>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
        <button class="form-button form-button-secondary" id="clear-chat-btn">æ¸…ç©ºèŠå¤©è®°å½•</button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯èŠå¤©è®°å½•æœç´¢åŠŸèƒ½çš„HTMLä»£ç  â–¼â–¼â–¼ -->
<div id="search-history-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="search-history-back-btn">â€¹</span>
        <span>æœç´¢èŠå¤©è®°å½•</span>
        <span style="width: 30px;"></span>
    </div>
    <!-- æœç´¢æ¡ä»¶è¾“å…¥åŒº -->
    <div id="search-bar" style="padding: 10px 15px; border-bottom: 1px solid var(--border-color); background-color: var(--secondary-bg); flex-shrink: 0;">
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="search" id="keyword-search-input" placeholder="è¾“å…¥å…³é”®è¯..." style="flex-grow: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px;">
            <input type="date" id="date-search-input" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px;">
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="execute-search-btn" class="form-button" style="margin-top: 0; flex-grow: 1;">æœç´¢</button>
            <button id="clear-search-btn" class="form-button form-button-secondary" style="margin-top: 0; flex-grow: 1;">é‡ç½®</button>
        </div>
    </div>
    <!-- æœç´¢ç»“æœæ˜¾ç¤ºåŒº -->
 
    <div id="chat-search-results-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
        <!-- èŠå¤©è®°å½•çš„æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
    <div id="persona-library-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>æˆ‘çš„äººè®¾åº“</span><button id="add-persona-preset-btn" class="action-button">æ·»åŠ </button></div>
            <div class="modal-body">
                <div id="persona-library-grid"></div>
            </div>
            <div class="modal-footer"><button class="cancel" id="close-persona-library-btn">å…³é—­</button></div>
        </div>
    </div>
    <div id="persona-editor-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span id="persona-editor-title">æ·»åŠ äººè®¾é¢„è®¾</span></div>
            <div class="modal-body">
                <div class="form-group"><label>é¢„è®¾å¤´åƒ</label>
                    <div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button><input type="file" id="preset-avatar-input" accept="image/*"></div>
                </div>
                <div class="form-group"><label for="preset-persona-input">é¢„è®¾äººè®¾</label><textarea id="preset-persona-input" rows="4" placeholder="åœ¨æ­¤è¾“å…¥è¿™ä¸ªäººè®¾çš„è¯¦ç»†è®¾å®š..."></textarea></div>
            </div>
            <div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">å–æ¶ˆ</button><button class="save" id="save-persona-preset-btn">ä¿å­˜</button></div>
        </div>
    </div>
    <div id="member-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>ç¼–è¾‘ç¾¤æˆå‘˜</span></div>
            <div class="modal-body">
                <div class="form-group"><label for="member-name-input">åå­—</label><input type="text" id="member-name-input"></div>
                <div class="form-group"><label for="member-persona-input">äººè®¾</label><textarea id="member-persona-input" rows="4"></textarea></div>
                <div class="form-group"><label>å¤´åƒ</label>
                    <div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button><button class="change-frame-btn" data-type="member">æ›´æ¢å¤´åƒæ¡†</button><input type="file" id="member-avatar-input" accept="image/*"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">å–æ¶ˆ</button><button class="save" id="save-member-settings-btn">ä¿å­˜</button></div>
        </div>
    </div>
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">å–æ¶ˆ</button>
                <button id="custom-modal-confirm" class="confirm-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>
    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ç¼–è¾‘é¢„è®¾</button>
                <button id="preset-action-delete" class="btn-danger">åˆ é™¤é¢„è®¾</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">ç»™Taä¸€ä¸ªæƒŠå–œï¼</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">è½¬è´¦é‡‘é¢</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="999999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">å¤‡æ³¨ (å¯é€‰)</label>
                <input type="text" id="transfer-note" placeholder="ç•™ä¸‹ä½ çš„å°å¿ƒæ€~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">å–æ¶ˆ</button>
                <button id="transfer-confirm-btn">ç¡®è®¤è½¬è´¦</button>
            </div>
        </div>
    </div>
    <div id="battery-alert-modal">
        <div class="battery-alert-content">
            <img id="battery-alert-image" src="">
            <p id="battery-alert-text"></p>
        </div>
    </div>
    <audio id="audio-player" style="display:none;"></audio>
    <!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µã€å®Œæ•´ã€‘çš„æ¨¡æ€æ¡†ä»£ç ï¼Œæ›¿æ¢æ‰ä½ ç°æœ‰çš„ id="create-post-modal" çš„æ•´ä¸ª div â–¼â–¼â–¼ -->
    <div id="create-post-modal" class="modal">
        <div class="modal-content" style="height: auto; max-height: 90%;">
            <div class="modal-header">
                <span>å‘å¸ƒåŠ¨æ€</span>
            </div>
            <div class="modal-body">
                <!-- å…¬å¼€æ–‡å­—è¾“å…¥åŒº -->
                <div class="form-group">
                    <textarea id="post-public-text" rows="3" placeholder="åˆ†äº«æ–°é²œäº‹...ï¼ˆéå¿…å¡«çš„å…¬å¼€æ–‡å­—ï¼‰"></textarea>
                </div>
                <!-- === æ¨¡å¼åˆ‡æ¢å¼€å…³ (æ–°å¢) === -->
                <div class="post-mode-switcher">
                    <button id="switch-to-image-mode" class="mode-btn active">ä¸Šä¼ å›¾ç‰‡</button>
                    <button id="switch-to-text-image-mode" class="mode-btn">ä½¿ç”¨æ–‡å­—å›¾</button>
                </div>
                <!-- â–¼â–¼â–¼ ã€ä¿®æ­£åã€‘çš„å¯è§èŒƒå›´è®¾ç½® â–¼â–¼â–¼ -->
                <div class="form-group">
                    <label>å¯è§èŒƒå›´</label>
                    <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;">
                        <label><input type="radio" name="visibility" value="public" checked> å…¬å¼€</label>
                        <label><input type="radio" name="visibility" value="include"> æŒ‡å®šåˆ†ç»„å¯è§</label>
                    </div>
                    <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                        <!-- åˆ†ç»„å¤šé€‰æ¡†å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <!-- â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² -->
                <!-- === å›¾ç‰‡æ¨¡å¼åŒºåŸŸ === -->
                <div id="image-mode-content" class="post-mode-content active">
                    <div class="form-group">
                        <div id="post-image-preview-container" class="post-image-preview-container">
                            <img id="post-image-preview" src="" alt="å›¾ç‰‡é¢„è§ˆ">
                            <button id="post-remove-image-btn">Ã—</button>
                        </div>
                        <div class="post-image-upload-options">
                            <button id="post-upload-local-btn" class="form-button-secondary">æœ¬åœ°ä¸Šä¼ </button>
                            <button id="post-use-url-btn" class="form-button-secondary">ç½‘ç»œURL</button>
                            <input type="file" id="post-local-image-input" accept="image/*" hidden>
                        </div>
                    </div>
                    <div id="post-image-desc-group" class="form-group" style="display: none;">
                        <label>å›¾ç‰‡æè¿° (å¿…å¡«ï¼Œç»™AIçœ‹)</label>
                        <input type="text" id="post-image-description" placeholder="ç®€å•æè¿°å›¾ç‰‡å†…å®¹ï¼Œå¸®åŠ©AIç†è§£">
                    </div>
                </div>
                <!-- === æ–‡å­—å›¾æ¨¡å¼åŒºåŸŸ (æ–°å¢) === -->
                <div id="text-image-mode-content" class="post-mode-content">
                    <div class="form-group">
                        <label>æ–‡å­—å›¾ (ç»™AIç†è§£ç”¨çš„æè¿°ï¼Œç‚¹å‡»å›¾ç‰‡åå¯è§)</label>
                        <textarea id="post-hidden-text" rows="4" placeholder="åœ¨è¿™é‡Œå†™ä¸‹å›¾ç‰‡æè¿°..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-post-btn">å–æ¶ˆ</button>
                <button class="save" id="confirm-create-post-btn">å‘å¸ƒ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°çš„æ¨¡æ€æ¡†HTMLç²˜è´´åˆ°æ‰€æœ‰å…¶ä»–æ¨¡æ€æ¡†ä¹‹å â–¼â–¼â–¼ -->
    <div id="group-management-modal" class="modal">
        <div class="modal-content" style="height: 60%;">
            <div class="modal-header">
                <span>ç®¡ç†å¥½å‹åˆ†ç»„</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ–°å»ºåˆ†ç»„</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-group-name-input" placeholder="è¾“å…¥åˆ†ç»„å..." style="flex-grow: 1;">
                        <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                    </div>
                </div>
                <hr style="opacity: 0.2;">
                <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- åˆ†ç»„åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-group-manager-btn" style="width: 100%;">å®Œæˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°HTMLç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
    <div id="message-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <!-- æ–°çš„æ“ä½œæŒ‰é’® -->
                <button id="edit-message-btn">ç¼–è¾‘æ¶ˆæ¯</button>
                <button id="copy-message-btn">å¤åˆ¶æ–‡æœ¬</button>
            <button id="copy-timestamp-btn">å¤åˆ¶æ—¶é—´æˆ³</button>
                <button id="recall-message-btn">æ’¤å›</button>
                <button id="publish-to-announcement-btn" style="display: none;">å‘å¸ƒåˆ°å…¬å‘Šæ¿</button>
                <button id="quote-message-btn">å¼•ç”¨</button>
                <button id="select-message-btn">è¿›å…¥å¤šé€‰</button>
                <!-- å–æ¶ˆæŒ‰é’® -->
                <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°HTMLç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
    <div id="post-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="edit-post-btn">ç¼–è¾‘åŠ¨æ€</button>
                <button id="copy-post-btn">å¤åˆ¶å†…å®¹</button>
                <button id="cancel-post-action-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯è§†åŒ–æ¶ˆæ¯ç¼–è¾‘å™¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="message-editor-modal" class="modal">
        <div class="modal-content" style="height: 75%;">
            <div class="modal-header">
                <span>ç¼–è¾‘ä¸æ‹†åˆ†æ¶ˆæ¯</span>
            </div>
            <div class="modal-body" id="message-editor-body">
                <!-- ç¼–è¾‘å™¨å®¹å™¨ï¼ŒJSä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆæ–‡æœ¬æ¡† -->
                <div id="message-editor-container"></div>
                <!-- æ·»åŠ æ–°æ¶ˆæ¯çš„æŒ‰é’® -->
                <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;"> [+] æ·»åŠ ä¸‹ä¸€æ¡æ¶ˆæ¯ </button>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-advanced-editor-btn">å–æ¶ˆ</button>
                <button class="save" id="save-advanced-editor-btn">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œå¯¼æ¼”å‰ªè¾‘å®¤â€æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="ai-response-editor-modal" class="modal">
        <div class="modal-content" style="height: 80%;">
            <div class="modal-header">
                <span>å¯¼æ¼”å‰ªè¾‘å®¤ (AIä¸Šä¸€è½®å“åº”)</span>
            </div>
            <div class="modal-body" id="ai-response-editor-body">
                <!-- å¯¼æ¼”å‰ªè¾‘å™¨å®¹å™¨ï¼ŒJSä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆæ–‡æœ¬æ¡† -->
                <div id="ai-response-editor-container" style="display: flex; flex-direction: column; gap: 15px;"></div>
                <!-- æ·»åŠ æ–°æ¶ˆæ¯çš„æŒ‰é’® -->
                <button id="add-ai-response-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;"> [+] æ·»åŠ ä¸€ä¸ªæ–°åŠ¨ä½œ </button>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-ai-response-editor-btn">å–æ¶ˆ</button>
                <button class="save" id="save-ai-response-editor-btn">åº”ç”¨ä¿®æ”¹</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <div id="repost-modal" class="modal">
        <div id="custom-modal" style="width: 280px;">
            <div class="custom-modal-header">è½¬å‘åŠ¨æ€</div>
            <div class="custom-modal-body">
                <textarea id="repost-comment-input" placeholder="è¯·è¾“å…¥è½¬å‘è¯„è®º (å¯é€‰)" style="width: 100%; min-height: 60px; resize: vertical; border: 1px solid #ccc; border-radius: 6px; padding: 8px; font-size: 16px; box-sizing: border-box;"></textarea>
            </div>
            <div class="custom-modal-footer">
                <button id="repost-cancel-btn">å–æ¶ˆ</button>
                <button id="repost-confirm-btn" class="confirm-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯æ¶ˆæ¯æ“ä½œèœå• â–¼â–¼â–¼ -->
    <div id="call-message-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="edit-call-message-btn">ç¼–è¾‘</button>
                <button id="delete-call-message-btn" class="btn-danger">åˆ é™¤</button>
                <button id="cancel-call-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="waimai-request-modal" class="modal">
        <div class="modal-content" style="width: 290px;">
            <div class="modal-header">
                <span>å‘èµ·å¤–å–ä»£ä»˜</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="waimai-product-info">å•†å“ä¿¡æ¯</label>
                    <input type="text" id="waimai-product-info" placeholder="ä¾‹å¦‚ï¼šä¸€æ¯æ¨æç”˜éœ²">
                </div>
                <div class="form-group">
                    <label for="waimai-amount">ä»£ä»˜é‡‘é¢ (å…ƒ)</label>
                    <input type="number" id="waimai-amount" placeholder="ä¾‹å¦‚ï¼š21" min="0" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="waimai-cancel-btn">å–æ¶ˆ</button>
                <button class="save" id="waimai-confirm-btn">å‘èµ·è¯·æ±‚</button>
            </div>
        </div>
    </div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ–°å»ºçº¦å®š/å€’è®¡æ—¶æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="create-countdown-modal" class="modal">
        <div class="modal-content" style="height: auto;">
            <div class="modal-header">
                <span>æ–°å»ºçº¦å®š</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="countdown-title-input">çº¦å®šæ ‡é¢˜</label>
                    <input type="text" id="countdown-title-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç”Ÿæ—¥">
                </div>
                <div class="form-group">
                    <label for="countdown-date-input">çº¦å®šæ—¥æœŸä¸æ—¶é—´</label>
                    <input type="datetime-local" id="countdown-date-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-countdown-btn">å–æ¶ˆ</button>
                <button class="save" id="confirm-create-countdown-btn">ä¿å­˜çº¦å®š</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‘çº¢åŒ…æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="red-packet-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>å‘çº¢åŒ…</span>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- 1. é¡µç­¾åˆ‡æ¢ -->
                <div class="frame-tabs">
                    <div id="rp-tab-group" class="frame-tab active">æ‹¼æ‰‹æ°”çº¢åŒ…</div>
                    <div id="rp-tab-direct" class="frame-tab">ä¸“å±çº¢åŒ…</div>
                </div>
                <!-- 2. æ‹¼æ‰‹æ°”çº¢åŒ…å†…å®¹åŒº -->
                <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
                    <div class="form-group">
                        <label>æ€»é‡‘é¢ (å…ƒ)</label>
                        <input type="number" id="rp-group-amount" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>çº¢åŒ…ä¸ªæ•°</label>
                        <input type="number" id="rp-group-count" placeholder="å¡«å†™çº¢åŒ…ä¸ªæ•°">
                    </div>
                    <div class="form-group">
                        <label>ç¥ç¦è¯­</label>
                        <input type="text" id="rp-group-greeting" placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼">
                    </div>
                    <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">Â¥ 0.00</p>
                    <button id="send-group-packet-btn" class="form-button">å¡é’±è¿›çº¢åŒ…</button>
                </div>
                <!-- 3. ä¸“å±çº¢åŒ…å†…å®¹åŒº -->
                <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
                    <div class="form-group">
                        <label>å‘é€ç»™</label>
                        <select id="rp-direct-receiver"></select>
                    </div>
                    <div class="form-group">
                        <label>é‡‘é¢ (å…ƒ)</label>
                        <input type="number" id="rp-direct-amount" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>ç¥ç¦è¯­</label>
                        <input type="text" id="rp-direct-greeting" placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼">
                    </div>
                    <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">Â¥ 0.00</p>
                    <button id="send-direct-packet-btn" class="form-button">å¡é’±è¿›çº¢åŒ…</button>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…è¯¦æƒ…æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="red-packet-details-modal" class="modal">
        <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
            <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
                <div style="text-align: center; width: 100%;">
                    <div id="rp-details-sender" style="font-size: 16px;"></div>
                    <div style="font-size: 13px; opacity: 0.8;">çš„çº¢åŒ…</div>
                </div>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
                <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;">
                    <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span>
                    <span style="font-size: 18px; color: #E44D44;">å…ƒ</span>
                </div>
                <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
                <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                    <!-- é¢†å–è¯¦æƒ…å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-rp-details-btn" style="width: 100%;">å…³é—­</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ›å»ºæŠ•ç¥¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="create-poll-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>å‘èµ·æŠ•ç¥¨</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="poll-question-input">æŠ•ç¥¨é—®é¢˜</label>
                    <textarea id="poll-question-input" rows="2" placeholder="ä¾‹å¦‚ï¼šä»Šæ™šæˆ‘ä»¬çœ‹ä»€ä¹ˆç”µå½±ï¼Ÿ"></textarea>
                </div>
                <div class="form-group">
                    <label>æŠ•ç¥¨é€‰é¡¹ (è‡³å°‘2é¡¹)</label>
                    <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- æŠ•ç¥¨é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                    </div>
                    <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ æ·»åŠ é€‰é¡¹</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-poll-btn">å–æ¶ˆ</button>
                <button class="save" id="confirm-create-poll-btn">å‘èµ·æŠ•ç¥¨</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="ai-avatar-library-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span id="ai-avatar-library-title">å¯¹æ–¹çš„å¤´åƒåº“</span>
                <div class="header-actions">
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†ä¸€ä¸ªæŒ‰é’®æ‹†åˆ†ä¸ºä¸¤ä¸ª -->
                    <button id="add-ai-avatar-batch-btn" class="action-button">æ‰¹é‡</button>
                    <button id="add-ai-avatar-url-btn" class="action-button">URL</button>
                    <button id="add-ai-avatar-upload-btn" class="action-button">ä¸Šä¼ </button>
                </div>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                    <!-- å¤´åƒåº“å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;">å…³é—­</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæˆ‘çš„â€å¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="my-avatar-library-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span id="my-avatar-library-title">æˆ‘çš„å¤´åƒåº“</span>
                <div class="header-actions">
                    <button id="add-my-avatar-batch-btn" class="action-button">æ‰¹é‡</button>
                    <button id="add-my-avatar-url-btn" class="action-button">URL</button>
                    <button id="add-my-avatar-upload-btn" class="action-button">ä¸Šä¼ </button>
                </div>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <div id="my-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                    <!-- â€œæˆ‘çš„â€å¤´åƒåº“å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-my-avatar-library-btn" style="width: 100%;">å…³é—­</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <div id="group-avatar-library-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢ä½ ç°æœ‰çš„ #group-avatar-library-modal .modal-header â–¼â–¼â–¼ -->
            <div class="modal-header">
                <span id="group-avatar-library-title">ç¾¤å¤´åƒåº“</span>
                <div class="header-actions">
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†ä¸€ä¸ªæŒ‰é’®æ‹†åˆ†ä¸ºä¸¤ä¸ª -->
                    <button id="add-group-avatar-batch-btn" class="action-button">æ‰¹é‡</button>
                    <button id="add-group-avatar-url-btn" class="action-button">URL</button>
                    <button id="add-group-avatar-upload-btn" class="action-button">ä¸Šä¼ </button>
                </div>
            </div>
            <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
            <div class="modal-body" style="padding: 15px;">
                <div id="group-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-group-avatar-library-btn" style="width: 100%;">å…³é—­</button>
            </div>
        </div>
    </div>
    <div id="chat-list-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="chat-list-action-pin"></button> <button id="chat-list-action-delete" class="btn-danger">åˆ é™¤èŠå¤©</button>
                <button id="chat-list-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·åˆ†äº«é“¾æ¥æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="share-link-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>åˆ†äº«é“¾æ¥</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="link-title-input">æ ‡é¢˜</label>
                    <input type="text" id="link-title-input" placeholder="è¾“å…¥æ–‡ç« æˆ–é“¾æ¥çš„æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label for="link-description-input">æ‘˜è¦ (å¯é€‰)</label>
                    <textarea id="link-description-input" rows="2" placeholder="ç®€å•æè¿°ä¸€ä¸‹é“¾æ¥å†…å®¹"></textarea>
                </div>
                <div class="form-group">
                    <label for="link-source-input">æ¥æºåç§° (å¯é€‰)</label>
                    <input type="text" id="link-source-input" placeholder="ä¾‹å¦‚ï¼šçŸ¥ä¹æ—¥æŠ¥ã€Bç«™">
                </div>
                <div class="form-group">
                    <label for="link-content-input">å®Œæ•´å†…å®¹ (å¯é€‰ï¼Œç”¨äºæµè§ˆå™¨å†…æ˜¾ç¤º)</label>
                    <textarea id="link-content-input" rows="4" placeholder="ç²˜è´´æˆ–è¾“å…¥å®Œæ•´çš„æ–‡ç« å†…å®¹"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-share-link-btn">å–æ¶ˆ</button>
                <button class="save" id="confirm-share-link-btn">åˆ†äº«</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²¾è‡´ç‰ˆè½¬è´¦æ“ä½œå¼¹çª— â–¼â–¼â–¼ -->
    <div id="transfer-actions-modal" class="modal">
        <div class="transfer-actions-content">
            <div class="transfer-actions-header">è¯·é€‰æ‹©æ“ä½œ</div>
            <div class="transfer-actions-body">
                <p>ä½ æ”¶åˆ°äº†æ¥è‡ª <strong id="transfer-sender-name"></strong> çš„ä¸€ç¬”è½¬è´¦ã€‚</p>
            </div>
            <div class="transfer-actions-footer">
                <button id="transfer-action-decline" class="action-btn decline">æ®‹å¿æ‹’ç»</button>
                <button id="transfer-action-accept" class="action-btn accept">å¼€å¿ƒæ”¶ä¸‹</button>
            </div>
            <button id="transfer-action-cancel" class="cancel-btn">Ã—</button>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•è¯¦æƒ…æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="call-transcript-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span id="transcript-modal-title">é€šè¯è¯¦æƒ…</span>
            </div>
            <div class="modal-body" id="call-transcript-modal-body" style="background-color: #f0f2f5;">
                <!-- é€šè¯æ–‡å­—è®°å½•å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="delete-transcript-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">åˆ é™¤è®°å½•</button>
                <!-- ã€ã€ã€æ ¸å¿ƒæ–°å¢ã€‘ã€‘ã€‘ -->
                <button class="save" id="manual-summarize-btn" style="background-color: #ffc107; border-color: #ffc107;">æ‰‹åŠ¨æ€»ç»“</button>
                <button class="save" id="close-call-transcript-btn" style="width: 100%;">å…³é—­</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«ç›®æ ‡é€‰æ‹©å™¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="share-target-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span>åˆ†äº«åˆ°...</span>
            </div>
            <div class="modal-body" id="share-target-list" style="padding: 0;">
                <!-- èŠå¤©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-share-target-btn">å–æ¶ˆ</button>
                <button class="save" id="confirm-share-target-btn">ç¡®è®¤åˆ†äº«</button>
            </div>
        </div>
    </div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«è®°å½•æŸ¥çœ‹å™¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="shared-history-viewer-modal" class="modal">
        <div class="modal-content" style="height: 80%;">
            <div class="modal-header">
                <span id="shared-history-viewer-title">èŠå¤©è®°å½•</span>
            </div>
            <div class="modal-body" id="shared-history-viewer-content" style="background-color: #f0f2f5;">
                <!-- åˆ†äº«çš„èŠå¤©è®°å½•æ°”æ³¡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <div class="modal-footer">
                <button class="save" id="close-shared-history-viewer-btn" style="width:100%;">å…³é—­</button>
            </div>
        </div>
    </div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
    <div id="world-book-category-manager-modal" class="modal">
        <div class="modal-content" style="height: 60%;">
            <div class="modal-header">
                <span>ç®¡ç†ä¸–ç•Œä¹¦åˆ†ç±»</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ–°å»ºåˆ†ç±»</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-category-name-input" placeholder="è¾“å…¥åˆ†ç±»å..." style="flex-grow: 1;">
                        <button id="add-new-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                    </div>
                </div>
                <hr style="opacity: 0.2;">
                <div id="existing-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- åˆ†ç±»åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-category-manager-btn" style="width: 100%;">å®Œæˆ</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <div id="announcement-board-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>ç¾¤å…¬å‘Šæ¿</span>
            </div>
            <div id="announcement-board-content">
            </div>
            <div class="modal-footer">
                <button class="save" id="close-announcement-board-btn" style="width: 100%;">å…³é—­</button>
            </div>
        </div>
    </div>
    <div id="announcement-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="announcement-action-pin">ç½®é¡¶å…¬å‘Š</button>
                <button id="announcement-action-delete" class="btn-danger">åˆ é™¤å…¬å‘Š</button>
                <button id="announcement-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é•¿æœŸè®°å¿†ç®¡ç†å…¨å±é¡µé¢ â–¼â–¼â–¼ -->
    <div id="long-term-memory-screen" class="screen">
        <div class="header">
            <span class="back-btn" id="memory-screen-back-btn">â€¹</span>
            <span>é•¿æœŸè®°å¿†</span>
            <div class="header-actions">
                <span class="action-btn" id="refine-memory-btn-header">ç²¾ç‚¼</span>
                <span class="action-btn" id="summarize-recent-btn-header">æ€»ç»“</span>
                <span class="action-btn" id="add-manual-memory-btn-header">+</span>
            </div>
        </div>
        <div class="list-container" id="memory-list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px; background-color: #f0f2f5;">
            <!-- é•¿æœŸè®°å¿†åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <input type="file" id="ai-avatar-upload-input" accept="image/*" hidden>
    <input type="file" id="group-avatar-upload-input" accept="image/*" hidden>
    <script>
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
if (!Array.prototype.findLastIndex) {
  Object.defineProperty(Array.prototype, 'findLastIndex', {
    value: function(predicate) {
      if (this == null) {
        throw new TypeError('Cannot read property \'findLastIndex\' of null or undefined');
      }
      if (typeof predicate !== 'function') {
        throw new TypeError('predicate must be a function');
      }
      let o = Object(this);
      let len = o.length >>> 0;
      let thisArg = arguments[1];
      let k = len - 1;
      while (k >= 0) {
        let kValue = o[k];
        if (predicate.call(thisArg, kValue, k, o)) {
          return k;
        }
        k--;
      }
      return -1;
    },
    configurable: true,
    writable: true
  });
}
Â  Â  Â  Â  // åŒå‡»æ£€æµ‹å˜é‡
Â  Â  Â  Â  let homeScreenTapCount = 0;
Â  Â  Â  Â  let homeScreenTapTimer = null;
 Â  Â  Â  document.addEventListener('DOMContentLoaded', function () {
Â  Â  Â  Â  Â  const homeScreen = document.getElementById('home-screen');
Â  Â  Â  Â  Â  const floatingXLogo = document.getElementById('floating-x-logo');

Â  Â  Â  Â  Â  if (homeScreen && floatingXLogo) {
Â  Â  Â  Â  Â  Â  // åŒå‡»äº‹ä»¶ç›‘å¬
Â  Â  Â  Â  Â  Â  homeScreen.addEventListener('click', function (e) {
Â  Â  Â  Â  Â  Â  Â  // é¿å…ä¸å…¶ä»–å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶å†²çª
Â  Â  Â  Â  Â  Â  Â  if (e.target.closest('.desktop-app-icon') || e.target.closest('#floating-x-logo')) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  homeScreenTapCount++;

Â  Â  Â  Â  Â  Â  Â  if (homeScreenTapCount === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  homeScreenTapTimer = setTimeout(function () {
Â  Â  Â  Â  Â  Â  Â  Â  Â  homeScreenTapCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  Â  Â  Â  } else if (homeScreenTapCount === 2) {
Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(homeScreenTapTimer);
Â  Â  Â  Â  Â  Â  Â  Â  homeScreenTapCount = 0;

Â  Â  Â  Â  Â  Â  Â  Â  // æ˜¾ç¤ºæ‚¬æµ®X Logo
Â  Â  Â  Â  Â  Â  Â  Â  floatingXLogo.classList.remove('floating-x-hidden');
Â  Â  Â  Â  Â  Â  Â  Â  floatingXLogo.classList.add('floating-x-visible');

Â  Â  Â  Â  Â  Â  Â  Â  // 3ç§’åè‡ªåŠ¨éšè—
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(function () {
Â  Â  Â  Â  Â  Â  Â  Â  Â  floatingXLogo.classList.remove('floating-x-visible');
Â  Â  Â  Â  Â  Â  Â  Â  Â  floatingXLogo.classList.add('floating-x-hidden');
Â  Â  Â  Â  Â  Â  Â  Â  }, 3000);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // X Logoç‚¹å‡»äº‹ä»¶
Â  Â  Â  Â  Â  Â  floatingXLogo.addEventListener('click', function (e) {
Â  Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  Â  showScreen('x-social-screen');
Â  Â  Â  Â  Â  Â  Â  // ç‚¹å‡»åéšè—logo
Â  Â  Â  Â  Â  Â  Â  floatingXLogo.classList.remove('floating-x-visible');
Â  Â  Â  Â  Â  Â  Â  floatingXLogo.classList.add('floating-x-hidden');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

        // ... å…¶ä»–å…¨å±€å˜é‡
        let activeMessageTimestamp = null;
        let activeTransferTimestamp = null; // <-- ç¡®ä¿è¿™è¡Œåœ¨è¿™é‡Œï¼Œå¹¶ä¸”åªæœ‰ä¸€è¡Œ
        // â–¼â–¼â–¼ åœ¨ä¸‹æ–¹ç²˜è´´æ–°å˜é‡ â–¼â–¼â–¼
        let lastRawAiResponse = ''; // ç”¨äºå­˜å‚¨AIä¸Šä¸€è½®çš„åŸå§‹å“åº”å­—ç¬¦ä¸²
        let lastResponseTimestamps = []; // ç”¨äºå­˜å‚¨ä¸Šä¸€è½®å“åº”ç”Ÿæˆçš„æ¶ˆæ¯çš„æ—¶é—´æˆ³
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        let currentQzoneReplyContext = null;
        let editingNpcId = null; // <-- æ–°å¢è¿™ä¸€è¡Œ
        // ...
                const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models'
            // geminiå¦‚æœæ˜¯å¤šä¸ªå¯†é’¥, é‚£ä¹ˆéšæœºè·å–ä¸€ä¸ª
            function getRandomValue(str) {
                // æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«é€—å·
                if (str.includes(',')) {
                    // ç”¨é€—å·åˆ†éš”å­—ç¬¦ä¸²å¹¶ç§»é™¤å¤šä½™ç©ºæ ¼
                    const arr = str.split(',').map(item => item.trim());
                    // ç”Ÿæˆéšæœºç´¢å¼• (0 åˆ° arr.length-1)
                    const randomIndex = Math.floor(Math.random() * arr.length);
                    // è¿”å›éšæœºå…ƒç´ 
                    return arr[randomIndex];
                }
                // æ²¡æœ‰é€—å·åˆ™ç›´æ¥è¿”å›åŸå­—ç¬¦ä¸²
                return str;
            }
            function isImage(content) {
                if(content.image_url && content.image_url.url){
                    let currentImageData = content.image_url.url
                    // æå–Base64æ•°æ®ï¼ˆå»æ‰å‰ç¼€ï¼‰
                    const base64Data = currentImageData.split(',')[1];
                    // æ ¹æ®å›¾ç‰‡ç±»å‹è·å–MIMEç±»å‹
                    const mimeType = currentImageData.match(/^data:(.*);base64/)[1];
                    return [
                        {text: 'ç”¨æˆ·å‘ä½ å‘é€äº†ä¸€å¼ å›¾ç‰‡'},
                        {
                            inline_data: {
                                mime_type: mimeType,
                                data: base64Data
                            }
                        }
                    ]
                }
                return []
            }
        
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆè¯Šæ–­å¢å¼ºç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‚¨ç°æœ‰çš„ getGeminiResponseText â–¼â–¼â–¼
        /**
         * ã€V3.0 | è¯Šæ–­å¢å¼ºç‰ˆã€‘ä»Geminiæˆ–å…¼å®¹OpenAIçš„APIå“åº”ä¸­å®‰å…¨åœ°æå–æ–‡æœ¬å†…å®¹
         * @param {object} data - ä» response.json() è§£æåçš„æ•°æ®å¯¹è±¡
         * @returns {string} - æå–åˆ°çš„æ–‡æœ¬å†…å®¹
         * @throws {Error} - å¦‚æœå“åº”æ ¼å¼ä¸æ­£ç¡®æˆ–è¢«å±è”½ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ªå¸¦æœ‰è¯¦ç»†åŸå› çš„é”™è¯¯
         */
        function getGeminiResponseText(data) {
            // 1. æ£€æŸ¥æ˜¯å¦æ˜¯å…¼å®¹OpenAIçš„å“åº”æ ¼å¼
            if (data.choices && Array.isArray(data.choices) && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
                return data.choices[0].message.content;
            }
        
            // 2. æ£€æŸ¥æ˜¯å¦æ˜¯æˆåŠŸçš„ã€æ ‡å‡†çš„åŸç”ŸGeminiå“åº”æ ¼å¼
            if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts) {
                return data.candidates[0].content.parts[0].text;
            }
        
            // --- ã€ã€ã€æ ¸å¿ƒå‡çº§ï¼šå…¨é¢çš„é”™è¯¯è¯Šæ–­ã€‘ã€‘ã€‘ ---
            console.error("Gemini APIè¿”å›äº†éé¢„æœŸçš„æ ¼å¼:", data);
            let errorReason = "AIè¿”å›äº†ç©ºå†…å®¹æˆ–æœªçŸ¥æ ¼å¼ã€‚";
        
            // 3a. è¯Šæ–­æ˜¯å¦æ˜¯å› ä¸ºå†…å®¹å®‰å…¨ç­–ç•¥è¢«å±è”½ (Geminiå®˜æ–¹APIæœ€å¸¸è§çš„é—®é¢˜)
            // è¿™ç§æƒ…å†µdata.candidatesæ˜¯å­˜åœ¨çš„ï¼Œä½†é‡Œé¢æ²¡æœ‰content
            if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0 && data.candidates[0].finishReason === 'SAFETY') {
                const safetyRatings = data.candidates[0].safetyRatings;
                const blockedCategories = safetyRatings
                    .filter(r => r.probability !== 'NEGLIGIBLE' && r.probability !== 'LOW')
                    .map(r => `${r.category} (æ¦‚ç‡: ${r.probability})`)
                    .join(', ');
                errorReason = `å†…å®¹å› å®‰å…¨ç­–ç•¥è¢«å±è”½ã€‚è§¦å‘ç±»åˆ«: ${blockedCategories || 'æœªçŸ¥'}`;
            }
            // 3b. è¯Šæ–­å¦ä¸€ç§å†…å®¹å®‰å…¨å±è”½æ ¼å¼ (promptFeedback)
            else if (data.promptFeedback?.blockReason) {
                const reason = data.promptFeedback.blockReason;
                const details = data.promptFeedback.safetyRatings?.map(r => `${r.category}: ${r.probability}`).join(', ');
                errorReason = `å†…å®¹å› å®‰å…¨ç­–ç•¥è¢«å±è”½ (åŸå› : ${reason})ã€‚è¯¦æƒ…: ${details || 'æ— '}`;
            } 
            // 3c. è¯Šæ–­æ˜¯å¦æ˜¯å…¶ä»–ç±»å‹çš„APIé”™è¯¯
            else if (data.error) {
                errorReason = `APIé”™è¯¯: ${data.error.message}`;
            }
            
            // 4. æŠ›å‡ºä¸€ä¸ªå¸¦æœ‰è¯¦ç»†ä¿¡æ¯çš„é”™è¯¯
            throw new Error(errorReason);
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
// â–¼â–¼â–¼ ã€æœ€ç»ˆè¯†å›¾ä¿®å¤æ–¹æ¡ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„ã€å…¼å®¹æ€§æ›´å¼ºçš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ toGeminiRequestData â–¼â–¼â–¼
function toGeminiRequestData(model, apiKey, systemInstruction, messagesForDecision) {
    const roleType = {
        user: 'user',
        assistant: 'model',
        system: 'user'
    };

    // --- 1. å°† systemInstruction æ¨¡æ‹Ÿæˆç¬¬ä¸€æ¬¡ç”¨æˆ·å¯¹è¯ï¼Œæå¤§æé«˜å…¼å®¹æ€§ ---
    const contents = [
        {
            role: 'user',
            parts: [{ text: systemInstruction }]
        },
        {
            role: 'model',
            parts: [{ text: 'å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ã€‚æˆ‘ä¼šä¸¥æ ¼éµå®ˆä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œè®¾å®šã€‚' }]
        },
        // --- 2. ã€æ ¸å¿ƒä¿®å¤ã€‘æ™ºèƒ½åœ°å¤„ç†æ¯ä¸€æ¡æ¶ˆæ¯ï¼Œæ„å»ºæ­£ç¡®çš„ parts æ•°ç»„ ---
        ...messagesForDecision.map((item) => {
            const parts = [];
            // a. å¦‚æœ content æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¯´æ˜å¯èƒ½æ˜¯å¤æ‚æ¶ˆæ¯ï¼ˆæ–‡æœ¬+å›¾ç‰‡ï¼‰
            if (Array.isArray(item.content)) {
                item.content.forEach(part => {
                    if (part.type === 'text') {
                        parts.push({ text: part.text });
                    } else if (part.type === 'image_url' && part.image_url && part.image_url.url) {
                        // b. æ­£ç¡®åœ°ä» Base64 URL ä¸­æå–å›¾ç‰‡æ•°æ®å’Œç±»å‹
                        const currentImageData = part.image_url.url;
                        const base64Data = currentImageData.split(',')[1];
                        const mimeTypeMatch = currentImageData.match(/^data:(.*);base64/);
                        if (mimeTypeMatch && base64Data) {
                            parts.push({
                                inline_data: {
                                    mime_type: mimeTypeMatch[1],
                                    data: base64Data
                                }
                            });
                        }
                    }
                });
            } else {
                // c. å¦‚æœ content æ˜¯æ™®é€šå­—ç¬¦ä¸²ï¼Œç›´æ¥ä½œä¸ºæ–‡æœ¬å¤„ç†
                parts.push({ text: String(item.content) });
            }
            return { role: roleType[item.role], parts: parts };
        })
    ];

    // --- 3. è¿”å›æœ€ç»ˆæ„å»ºå¥½çš„ã€å®Œå…¨ç¬¦åˆ Gemini API è§„èŒƒçš„è¯·æ±‚æ•°æ® ---
    return {
        url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${getRandomValue(apiKey)}`,
        data: {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: contents,
                generationConfig: {
                    temperature: 0.8,
                },
            })
        }
    };
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            document.addEventListener('DOMContentLoaded', () => {
        
                // ===================================================================
                // 1. æ‰€æœ‰å˜é‡å’Œå¸¸é‡å®šä¹‰
                // ===================================================================
                const db = new Dexie('GeminiChatDB');
        const avatarFrames = [ { id: 'none', url: '', name: 'æ— ' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/fLDnz5Pn/IMG-5574.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/HxH3cNHz/IMG-6871.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/jCVK0fGL/IMG-6890.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/85Zsyjwn/IMG-6895.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/cJtpZCB3/IMG-6894.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/63sDQKMm/IMG-6893.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/cHQPgzj4/IMG-6888.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/dVLXm3Xf/IMG-6885.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/kGsZwbq0/IMG-6886.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/63NmX03s/IMG-4366.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/zvz2LGK0/IMG-4367.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/prsGKMBx/IMG-4370.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/gk0BmrY0/IMG-4371.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/fRt2SFSn/IMG-4368.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/kGgwJhPH/IMG-4374.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/PrcKH436/IMG-4376.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/fRV86FMq/IMG-4381.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/HsyqMVyk/IMG-4385.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/qBbKK7dS/IMG-4386.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/05wnd389/IMG-4388.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/RZNLhbbr/IMG-4389.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/fLTc42dg/IMG-4391.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/FzbGNdRT/IMG-4392.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/XY63sTS3/IMG-4393.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Cx9vCVWH/IMG-4395.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/kMfPQBwQ/IMG-4396.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/CLrZQMMD/IMG-4398.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/L4zwDhTC/IMG-4399.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/yN3s8szM/IMG-4400.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/59Cn1tkB/IMG-4401.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/g0s1V0PX/IMG-4402.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/Jn1DFPgY/IMG-4403.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/q7cQnDy1/IMG-4404.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/RFK3q2t0/IMG-4407.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/gcV0VR2t/IMG-4408.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/W1CjLb4J/IMG-4409.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Ss7pM6fW/IMG-4410.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nrFfYX3N/IMG-4412.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/cHWp0KG6/IMG-4413.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/4yNjHrdg/IMG-4414.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/hPX5F8Qp/IMG-4415.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/vHCSG1WM/IMG-4416.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/x1Hp80Rm/IMG-4417.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/FHRcCGfH/IMG-4418.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/13hhJ77p/IMG-4419.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/J4WCQd2j/IMG-4420.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/Dydkpd9H/IMG-4421.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/mrkvDxPW/IMG-4422.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/76Tj3g1B/IMG-4425.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/3N5Vndn3/IMG-4426.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/05DLr0yj/IMG-4427.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/GhR6DT4Q/IMG-4428.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/fRTF24jS/IMG-4430.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/R0WYmcYM/IMG-4431.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/nrJSqNhz/IMG-4432.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/tC9mJ0cv/IMG-4438.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/XNkQTHvf/IMG-5561.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/Mpv5fzm5/IMG-4439.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/T1tjhsyB/IMG-4720.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/c4JMPd2W/IMG-4724.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/g2XykNGB/IMG-4727.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/y8MmJcd6/IMG-4728.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/Lsjzj5Yt/IMG-4729.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/bNdk33SN/IMG-4893.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/4x9tTy1D/IMG-5563.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/DZshzKv6/IMG-5576.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Fsvr71JL/IMG-5573.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/Fz3HwLk9/IMG-5569.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/wjH180kn/IMG-5566.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/MG6qtLYK/IMG-5565.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/CKgDNYVb/IMG-5577.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/C5XnfpNB/IMG-5579.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/4y7mGFgJ/IMG-5716.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/FzM1Hgr0/IMG-5717.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/rF4KYbjj/IMG-5720.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/6pLTBvDG/IMG-5721.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/VNK6Ccsf/IMG-5722.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/wx72fhr2/IMG-5968.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/QdrqdvdY/IMG-5969.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/0yd0MZ6k/IMG-5971.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/1zmcp66p/IMG-5973.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/wBw5Fvcn/IMG-5974.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/R0pfKYvB/IMG-5976.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/9fQZ425b/IMG-5975.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/v8V9xXjJ/IMG-6137.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/WbmkXzsS/IMG-6138.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/Dw2bDhZh/IMG-6140.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/ZqQBCyLY/IMG-6144.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/qRCtnMms/IMG-6145.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/1Rwn3XVP/IMG-6146.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Kv51tW5H/IMG-6147.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nhcC21Rc/IMG-6148.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/fTWzQRx8/IMG-6149.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/LXyyqDbY/IMG-6294.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/7Zgm1wRy/IMG-6295.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/5tbpnDcQ/IMG-6296.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/YSRRV8kn/IMG-6297.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/k45sd8gn/IMG-6375.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/50k390X8/IMG-6376.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/90RBDh9K/IMG-6377.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/cCpBYbMH/IMG-6552.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/Pf9g2fSL/IMG-6554.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/gkhf597g/IMG-6555.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/g2PfbSFm/IMG-6556.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/pLY3WfR8/IMG-6557.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/65Cmcr7S/IMG-6559.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Y94XWYKd/IMG-6560.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/ydwLXx7s/IMG-6562.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/G3y73Fj2/IMG-6563.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/TYvkKKkc/IMG-6565.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/GmcqjZn8/IMG-6566.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/k5Gs0K47/IMG-6567.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/XJy8JWdh/IMG-6568.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/fycfcvHf/IMG-6569.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/J7ZxC11H/IMG-6570.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/hPnrSHjy/IMG-4434.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/YqxxjbLp/IMG-6572.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/wjfcQMkZ/IMG-6573.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Vv8jkCYr/IMG-6574.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/MZ77rdDy/IMG-6850.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/T3NvqJCZ/IMG-6851.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/28TsrxRV/IMG-6852.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/VkV2bLNw/IMG-6853.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/gJ95NSRB/IMG-6854.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/d1qsQsbQ/IMG-6855.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/gJNYx9pV/IMG-6856.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/fyPDvxJk/IMG-6860.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/QMDsSNxg/IMG-6861.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/vBqsQW7X/IMG-6858.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/Y0vwjhb7/IMG-6857.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/90sH9Cn7/IMG-6868.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/Y2PHZzCC/IMG-6866.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/7Z8yYP7v/IMG-6889.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nryNzTXK/IMG-6915.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Qx5dqyJ3/IMG-6917.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/Wbr0JSDD/IMG-5316.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/tgR6wjBP/IMG-5570.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/d0WCKxff/IMG-6932.gif', name: '14' }, { id: 'frame_11', url: 'https://i.postimg.cc/Ss3znzk7/IMG-6934.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/nrm9BcL8/IMG-6941.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/ZYvd1jxf/IMG-6937.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/sDFhySn3/IMG-6936.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/43PhvxRq/IMG-6922.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/3Rb46fRZ/IMG-6923.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/PJppkbvn/IMG-6918.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/XqRZNZ9G/IMG-6916.gif', name: '14' }, { id: 'frame_14', url: 'https://i.postimg.cc/RVt6sRzc/IMG-6939.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/mgGc0HbK/IMG-6926.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/P5zLh5JJ/IMG-6942.gif', name: '14' }, { id: 'frame_14', url: 'https://i.postimg.cc/xCqqKGRN/IMG-6929.gif', name: '14' },
              { id: 'frame_12', url: 'https://i.postimg.cc/7LSRp4hx/e7fa949b9pc84cff0dabe57defceb54c.gif', name: '12' },
            { id: 'frame_13', url: 'https://i.postimg.cc/DZgMwc1H/817178fdbpf2ff7740dc98e26ab78759.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/3NffgJSZ/e09c07034ld7e62266c0a5de6a36ae62.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/vHDNGfT2/35ac7f372v588bf48d4f659077196b85.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/KvVsjjgG/3c3aa5219s18b90187ef1f54b3db7ba8.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/k5P1NHcL/55f3e31d8qbc8a02d152b07b99d31567.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/FFCTCzpy/641bad3b3udc599fdb63ca75fde427e5.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/8k7YSLjK/1689aa46aqc4b9ffc0f970e668f56537.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/J0CZSwyW/IMG-6938.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/Df1qLzDf/IMG-6927.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/CLNkrQSW/IMG-6925.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/y8p9s3Jj/IMG-6919.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/Lsr1Zd3Z/IMG-6928.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/Ssgbv41n/IMG-6876.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/SNByPrf9/IMG-7005.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/Z5nrCyS5/IMG-7006.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/mDfMXXFP/IMG-7007.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/DZrGtrqB/IMG-7008.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/ZnJNZWHZ/IMG-7009.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/RhGH0vpt/IMG-7010.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/tRzPkzRg/IMG-7012.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/wTTNGs3Q/IMG-7013.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/3JSG5Jv5/IMG-7014.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/rwDr8X1d/IMG-7015.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/DzDy2vS7/IMG-7017.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/QMVdG9x6/IMG-7016.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/mZ9hgH3J/IMG-7019.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/t4ksHGdg/IMG-7020.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/hP9JpdfT/IMG-7023.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/wTKyXVT9/IMG-7024.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/ZqjKXPSv/IMG-7025.gif', name: '14' },
        
          { id: 'frame_14', url: 'https://i.postimg.cc/gj3Tmqz5/mmexport1751030241029.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/4yCXW52F/mmexport1751030908335.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/VkXngG72/mmexport1751031208329.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/LscBkxZb/mmexport1751017556565.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/1XqzGKwJ/mmexport1751018282681.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/8kHCQwbQ/mmexport1751020645824.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/HWynLK7f/mmexport1751021724230.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/JnwFp3Kx/mmexport1751031208329.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/HLZNWkQw/mmexport1751031767634.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/vH2X6N1y/mmexport1751032231179.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/NFS4ZyvM/mmexport1751032686953.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/3RpmWc8c/mmexport1751033102811.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/L5RLr3tg/mmexport1751035976943.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/4NCPsp5d/mmexport1751034427637.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/CMv02LHm/mmexport1751034842120.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/rFnSzWGx/mmexport1751035618517.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/7YRbzN51/mmexport1751036276038.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/cJpbtPWq/mmexport1751036607799.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/HxLV5v92/mmexport1751036977582.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/D01rYy86/mmexport1751037965259.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/J4fwkTLW/mmexport1751038167142.gif', name: '14' },
          
          
        { id: 'frame_14', url: 'https://i.postimg.cc/xjpN4swz/IMG-7240.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/ZnzbGdxX/IMG-7239.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/DyYDmKtw/IMG-7238.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/W40f9qtd/IMG-7098.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/8PsK20jQ/IMG-7236.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/cHsTXDVz/IMG-7235.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/sXwm8Yzg/IMG-7234.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/xTk5xN49/IMG-7233.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/k5yv6QBv/IMG-7232.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/yx2m4nbs/IMG-7231.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/vZt0fFKn/IMB-r-HMBXY.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/pddJj9zN/IMG-7094.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/rmB17Qbc/IMB-f-VDf-Fc.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/VkKjzYTK/IMB-f4kk-CT.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/B6KD52vz/IMG-7096.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/9XPwWmwy/IMB-Kf7um-P.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/mrFhKBGz/IMB-e-QWBpa.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/bw4wxW2z/IMB-16r-COL.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/3x0Kx1fz/IMB-K1u-Jp-P.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/CLz0cJ0d/IMG-7116.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/fyyGgW61/IMG-7115.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/gkk7s0vD/IMG-6984.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/0NpZPgYj/IMG-6985.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/tTWKKmTN/IMG-7073.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/jS8tc9wW/IMG-7083.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/rmRVKJpD/IMG-7087.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/zvWGPjms/IMG-7090.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/YSkqDg8V/IMG-7092.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/FzqHTBng/IMG-7093.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/tTpZ6wLs/IMG-7095.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/8P5vt8sW/IMG-7097.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/wMxmCZVC/IMG-7099.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/2jxd0FGp/IMG-7100.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/B6T59xGK/IMG-7101.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/kXfcgFRN/IMG-7106.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/htZppbS4/IMG-7107.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/hPgyjtyn/IMG-7108.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/HLKvs0Kv/IMG-7109.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/wjwbnYkp/IMG-7111.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/bJDMQVkj/IMG-7112.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/SNWBTP5S/IMG-7113.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/jCVMQsKH/IMG-7114.gif', name: '14' },
          
          ];
                // --- å·²ä¿®æ­£ ---
               // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨ state å¯¹è±¡ä¸­åˆå§‹åŒ– cache å±æ€§
let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [], qzoneSettings: {}, activeAlbumId: null, cache: { songs: new Map(), lyrics: new Map() } };
                // --- ä¿®æ­£ç»“æŸ ---
        
        let thoughtsHistoryRenderCount = 0;
        const THOUGHTS_RENDER_WINDOW = 15; // æ¯æ¬¡åŠ è½½15æ¡å†å²è®°å½•
        // â–¼â–¼â–¼ åœ¨JSé¡¶éƒ¨ï¼Œå˜é‡å®šä¹‰åŒºï¼Œæ·»åŠ è¿™ä¸ªæ–°å˜é‡ â–¼â–¼â–¼
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºåŠ¨æ€åˆ†é¡µåŠ è½½æ·»åŠ çš„å˜é‡ â–¼â–¼â–¼
        let qzonePostsRenderCount = 0;
        const QZONE_RENDER_WINDOW = 10; // æ¯æ¬¡åŠ è½½10æ¡åŠ¨æ€
        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        let qzonePostsCache = []; // ç”¨äºç¼“å­˜å·²åŠ è½½çš„åŠ¨æ€å¸–å­æ•°æ®
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        let musicState = { 
            isActive: false, 
            activeChatId: null, 
            isPlaying: false, 
            playlist: [], 
            currentIndex: -1, 
            playMode: 'order', 
            totalElapsedTime: 0, 
            timerId: null,
            // ã€æ–°å¢ã€‘æ­Œè¯ç›¸å…³çŠ¶æ€
            parsedLyrics: [],      // å½“å‰æ­Œæ›²è§£æåçš„æ­Œè¯æ•°ç»„
            currentLyricIndex: -1  // å½“å‰é«˜äº®çš„æ­Œè¯è¡Œç´¢å¼•
        };
        let qzoneStickerPanelState = {
            isOpen: false,
            activePostId: null,
            panelEl: null,
            gridEl: null
        };
                const audioPlayer = document.getElementById('audio-player');
                let newWallpaperBase64 = null;
                let isSelectionMode = false;
        let activeStickerCategoryId = 'all'; // ç”¨äºè·Ÿè¸ªå½“å‰é€‰ä¸­çš„è¡¨æƒ…åˆ†ç±»
                let selectedMessages = new Set();
                let editingMemberId = null;
                let editingWorldBookId = null;
               let editingRuleId = null; // ç”¨äºå­˜å‚¨æ­£åœ¨ç¼–è¾‘çš„è§„åˆ™ID
                let editingPersonaPresetId = null;
                let currentReplyContext = null;
        let waimaiTimers = {}; // ç”¨äºå­˜å‚¨å¤–å–å€’è®¡æ—¶
        
        let activeMessageTimestamp = null;
let activeCharacterId = null; // ç”¨äºè·Ÿè¸ªå½“å‰æ­£åœ¨æŸ¥çœ‹çš„CphoneID
let editingMemoId = null;
let editingDiaryId = null;
let activeDiaryForViewing = null; // ç”¨äºæš‚å­˜å½“å‰æ­£åœ¨æŸ¥çœ‹çš„æ—¥è®°å¯¹è±¡
        // â–¼â–¼â–¼ åœ¨ä¸‹æ–¹ç²˜è´´æ–°å˜é‡ â–¼â–¼â–¼
        let shoppingCart = []; // æ•°æ®ç»“æ„å°†å˜ä¸º [{ productId: 123, quantity: 1 }, ...]
        let editingProductId = null; // ç”¨äºå­˜å‚¨æ­£åœ¨ç¼–è¾‘çš„å•†å“ID
        let activeProductId = null; // ç”¨äºå­˜å‚¨å½“å‰æŸ¥çœ‹çš„å•†å“ID
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºåŠ¨æ€è¯„è®ºåŒºå›å¤åŠŸèƒ½æ·»åŠ çš„çŠ¶æ€å˜é‡ â–¼â–¼â–¼
        let currentQzoneReplyContext = null; // ç”¨äºå­˜å‚¨å›å¤ä¸Šä¸‹æ–‡ { postId, replyToName, replyToDisplayName }
        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        let activePostId = null; // <-- æ–°å¢ï¼šç”¨äºå­˜å‚¨å½“å‰æ“ä½œçš„åŠ¨æ€ID
        let activeDoubanPostId = null;
                let photoViewerState = {
                    isOpen: false,
                    photos: [], // å­˜å‚¨å½“å‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡URL
                    currentIndex: -1, // å½“å‰æ­£åœ¨æŸ¥çœ‹çš„ç…§ç‰‡ç´¢å¼•
                };
        
                let unreadPostsCount = 0;
        
                let isFavoritesSelectionMode = false;
                let selectedFavorites = new Set()
        
        let simulationIntervalId = null;
        
                const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
                const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
                const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
                const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
                let notificationTimeout;
// åœ¨ä½ çš„JSé¡¶éƒ¨å˜é‡å®šä¹‰åŒºï¼Œæ·»åŠ è¿™ä¸ªæ–°å¸¸é‡
const DEFAULT_NOTIFICATION_SOUND = 'https://www.myinstants.com/media/sounds/notification-sound-2.mp3'; // é»˜è®¤çš„å¾®ä¿¡æç¤ºéŸ³
        // â–¼â–¼â–¼ åœ¨JSé¡¶éƒ¨ï¼Œå˜é‡å®šä¹‰åŒºï¼Œæ·»åŠ è¿™ä¸ªæ–°å˜é‡ â–¼â–¼â–¼
        let gomokuState = {}; // ç”¨äºå­˜å‚¨æ¯ä¸ªèŠå¤©çš„äº”å­æ£‹çŠ¶æ€
        let originalChatMessagesPaddingTop = null; // ç”¨äºå­˜å‚¨æ¶ˆæ¯åŒºçš„åŸå§‹é¡¶éƒ¨å†…è¾¹è·
        
        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ª V2 ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ DEFAULT_APP_ICONS å¸¸é‡ â–¼â–¼â–¼
        const DEFAULT_APP_ICONS = {
            'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
            'world-book': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
            'wallpaper': 'https://i.postimg.cc/T1j03pQr/IMG-6440.jpg',
            'renderer': 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg',
            'api-settings': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
            'font': 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg',
            // ã€æ ¸å¿ƒæ–°å¢ã€‘å°†Cphone(Cphone)å’Œè±†ç“£ä¹ŸåŠ å…¥ç®¡ç†åˆ—è¡¨
            'char-phone': 'https://i.postimg.cc/pXj9h20L/IMG-7275.jpg',
            'douban': 'https://i.postimg.cc/Pq2xJN1g/IMG-7301.jpg',
    // ã€ã€ã€æ ¸å¿ƒæ–°å¢ï¼šåœ¨è¿™é‡Œä¸ºâ€œé¢„è®¾â€Appæ³¨å†Œä¸€ä¸ªå”¯ä¸€çš„IDå’Œé»˜è®¤å›¾æ ‡ã€‘ã€‘ã€‘
    'preset': 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg',
            // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„ä¸€è¡Œ â–¼â–¼â–¼
            'tutorial': 'https://i.postimg.cc/d10GjC4g/IMG-7302.jpg'
        };
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºCPhoneå›¾æ ‡è®¾ç½®æ–°å¢çš„å¸¸é‡ â–¼â–¼â–¼
        const DEFAULT_CPHONE_ICONS = {
            'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
            'album': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
            'browser': 'https://i.postimg.cc/KzC2gTq6/IMG-7276.jpg',
            'taobao': 'https://i.postimg.cc/L6R7x16R/IMG-7278.jpg',
            'memo': 'https://i.postimg.cc/J0b6Nym4/IMG-7279.jpg',
            'diary': 'https://i.postimg.cc/DZ541sbt/IMG-7280.jpg',
            'amap': 'https://i.postimg.cc/Jz2Tz0dw/IMG-7281.jpg',
            'usage': 'https://i.postimg.cc/WbF8kzz9/IMG-7282.jpg',
            'music': 'https://is1-ssl.mzstatic.com/image/thumb/Purple112/v4/64/9d/21/649d21e8-a151-6136-3914-256e54f15d9a/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/1200x630wa.png',
            'ephone': 'https://i.postimg.cc/pXj9h20L/IMG-7275.jpg'
        };
        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        let repostTargetId = null; // ç”¨äºå­˜å‚¨å½“å‰è¦è½¬å‘çš„åŠ¨æ€ID
                const STICKER_REGEX = /(^https:\/\/i\.postimg\.cc\/.+|^https:\/\/files\.catbox\.moe\/.+|^https?:\/\/sharkpan\.xyz\/.+|^data:image|\.(png|jpg|jpeg|gif|webp)\?.*$|\.(png|jpg|jpeg|gif|webp)$)/i;
                const MESSAGE_RENDER_WINDOW = 50;
                let currentRenderedCount = 0;
                let lastKnownBatteryLevel = 1;
                let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
                let batteryAlertTimeout;
                const dynamicFontStyle = document.createElement('style');
                dynamicFontStyle.id = 'dynamic-font-style';
                document.head.appendChild(dynamicFontStyle);
        
                const modalOverlay = document.getElementById('custom-modal-overlay');
                const modalTitle = document.getElementById('custom-modal-title');
                const modalBody = document.getElementById('custom-modal-body');
                const modalConfirmBtn = document.getElementById('custom-modal-confirm');
                const modalCancelBtn = document.getElementById('custom-modal-cancel');
                let modalResolve;
        
                function showCustomModal() { 
                    modalOverlay.classList.add('visible'); 
                }
        
                function hideCustomModal() { 
                    modalOverlay.classList.remove('visible'); 
                    modalConfirmBtn.classList.remove('btn-danger'); 
                    if (modalResolve) modalResolve(null); 
                }
        /**
         * ã€å…¨æ–°ã€‘æ ¹æ®ä¿å­˜çš„è®¾ç½®ï¼Œåº”ç”¨æ­Œè¯æ çš„CSSæ ·å¼
         * @param {object} chat - å½“å‰çš„èŠå¤©å¯¹è±¡
         */
        function applyLyricsBarPosition(chat) {
            const lyricsBar = document.getElementById('global-lyrics-bar');
            // å¦‚æœèŠå¤©æ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼
            const settings = chat.settings.lyricsPosition || { vertical: 'top', horizontal: 'center', offset: 10 };
            
            // é‡ç½®æ‰€æœ‰å¯èƒ½å½±å“ä½ç½®çš„å±æ€§
            lyricsBar.style.top = 'auto';
            lyricsBar.style.bottom = 'auto';
            lyricsBar.style.left = 'auto';
            lyricsBar.style.right = 'auto';
            lyricsBar.style.transform = 'none';
        
            // 1. è®¾ç½®å‚ç›´ä½ç½®å’Œåç§»é‡
            if (settings.vertical === 'top') {
                lyricsBar.style.top = `${settings.offset}px`;
            } else { // 'bottom'
                lyricsBar.style.bottom = `${settings.offset}px`;
            }
            
            // 2. è®¾ç½®æ°´å¹³å¯¹é½
            switch (settings.horizontal) {
                case 'left':
                    lyricsBar.style.left = '15px'; // ç•™å‡ºä¸€äº›è¾¹è·
                    break;
                case 'right':
                    lyricsBar.style.right = '15px'; // ç•™å‡ºä¸€äº›è¾¹è·
                    break;
                case 'center':
                default:
                    lyricsBar.style.left = '50%';
                    lyricsBar.style.transform = 'translateX(-50%)';
                    break;
            }
        }
        // â–¼â–¼â–¼ æŠŠè¿™ä¸ªã€å…¨æ–°çš„å‡½æ•°ã€‘ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æœ¬åœ°ä¸Šä¼ ç¾¤å¤´åƒå¹¶ç”±å‰¯APIè¯†åˆ«çš„æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ä»æœ¬åœ°ä¸Šä¼ ç¾¤å¤´åƒçš„æµç¨‹
         * @param {Event} event - æ–‡ä»¶è¾“å…¥æ¡†çš„ change äº‹ä»¶å¯¹è±¡
         */
        async function handleLocalGroupAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
        
            // 1. è¯»å–æ–‡ä»¶ä¸º Base64
            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        
            // 2. å¼¹å‡ºæç¤ºï¼Œå¼€å§‹è¯†å›¾
            await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚AIä¸ºæ–°ç¾¤å¤´åƒå‘½å...");
        
            try {
                // 3. è°ƒç”¨é€šç”¨çš„APIè¯†å›¾å‡½æ•°è·å–æè¿°
                const description = await getAvatarDescriptionFromApi(base64Url);
                
                if (!description) {
                    throw new Error("AIæœªèƒ½æˆåŠŸæè¿°å›¾ç‰‡ã€‚");
                }
        
                // 4. å°†æè¿°ä½œä¸ºåå­—ï¼Œå’Œå›¾ç‰‡URLä¸€èµ·å­˜å…¥ç¾¤å¤´åƒåº“
                const chat = state.chats[state.activeChatId];
                if (!chat.settings.groupAvatarLibrary) {
                    chat.settings.groupAvatarLibrary = [];
                }
                chat.settings.groupAvatarLibrary.push({ name: description, url: base64Url });
                
                // 5. ä¿å­˜å¹¶åˆ·æ–°
                await db.chats.put(chat);
                renderGroupAvatarLibrary();
                await showCustomAlert("ä¸Šä¼ æˆåŠŸï¼", `AIå·²å°†æ–°ç¾¤å¤´åƒå‘½åä¸ºï¼šâ€œ${description}â€`);
        
            } catch (error) {
                console.error("æœ¬åœ°ç¾¤å¤´åƒä¸Šä¼ åŠè¯†åˆ«å¤±è´¥:", error);
                await showCustomAlert("æ“ä½œå¤±è´¥", `æ— æ³•ä¸ºå¤´åƒå‘½åï¼Œè¯·æ£€æŸ¥ï¼ˆä¸»/å‰¯ï¼‰APIé…ç½®æ˜¯å¦æ­£ç¡®å¹¶æ”¯æŒVisionã€‚\né”™è¯¯: ${error.message}`);
            } finally {
                // æ— è®ºæˆåŠŸä¸å¦ï¼Œéƒ½æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
                event.target.value = null;
            }
        }
        // â–²â–²â–² å…¨æ–°åŠŸèƒ½å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æœ¬åœ°ä¸Šä¼ å¤´åƒå¹¶ç”±å‰¯APIè¯†åˆ«çš„æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ä»æœ¬åœ°ä¸Šä¼ å¤´åƒçš„æµç¨‹
         * @param {Event} event - æ–‡ä»¶è¾“å…¥æ¡†çš„ change äº‹ä»¶å¯¹è±¡
         */
        async function handleLocalAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
        
            // 1. è¯»å–æ–‡ä»¶ä¸º Base64ï¼Œè¿™æ˜¯å‘é€ç»™APIå’Œå­˜å‚¨çš„å¿…è¦æ ¼å¼
            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        
            // 2. å¼¹å‡ºæç¤ºï¼Œå¼€å§‹è¯†å›¾
            await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚AIä¸ºæ–°å¤´åƒå‘½å...");
        
            try {
                // 3. è°ƒç”¨APIè·å–å›¾ç‰‡æè¿°ï¼ˆè¿™ä¸ªæè¿°å°†ä½œä¸ºå¤´åƒçš„åå­—ï¼‰
                const description = await getAvatarDescriptionFromApi(base64Url);
                
                if (!description) {
                    throw new Error("AIæœªèƒ½æˆåŠŸæè¿°å›¾ç‰‡ã€‚");
                }
        
                // 4. å°†æè¿°ä½œä¸ºåå­—ï¼Œå’Œå›¾ç‰‡URLä¸€èµ·å­˜å…¥å¤´åƒåº“
                const chat = state.chats[state.activeChatId];
                if (!chat.settings.aiAvatarLibrary) {
                    chat.settings.aiAvatarLibrary = [];
                }
                chat.settings.aiAvatarLibrary.push({ name: description, url: base64Url });
                
                // 5. ä¿å­˜å¹¶åˆ·æ–°
                await db.chats.put(chat);
                renderAiAvatarLibrary();
                await showCustomAlert("ä¸Šä¼ æˆåŠŸï¼", `AIå·²å°†æ–°å¤´åƒå‘½åä¸ºï¼šâ€œ${description}â€`);
        
            } catch (error) {
                console.error("æœ¬åœ°å¤´åƒä¸Šä¼ åŠè¯†åˆ«å¤±è´¥:", error);
                await showCustomAlert("æ“ä½œå¤±è´¥", `æ— æ³•ä¸ºå¤´åƒå‘½åï¼Œè¯·æ£€æŸ¥ï¼ˆä¸»/å‰¯ï¼‰APIé…ç½®æ˜¯å¦æ­£ç¡®å¹¶æ”¯æŒVisionã€‚\né”™è¯¯: ${error.message}`);
            } finally {
                // æ— è®ºæˆåŠŸä¸å¦ï¼Œéƒ½æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
                event.target.value = null;
            }
        }
        
        /**
         * ã€å…¨æ–°ã€‘è°ƒç”¨ï¼ˆå‰¯ï¼‰APIæ¥è·å–å›¾ç‰‡çš„æè¿°
         * @param {string} base64Url - å›¾ç‰‡çš„ Base64 Data URL
         * @returns {Promise<string>} - è¿”å›AIç”Ÿæˆçš„å›¾ç‰‡æè¿°
         */
        async function getAvatarDescriptionFromApi(base64Url) {
            // æ™ºèƒ½é€‰æ‹©APIï¼šä¼˜å…ˆä½¿ç”¨å‰¯APIï¼Œå¦‚æœæœªé…ç½®åˆ™è‡ªåŠ¨å›é€€åˆ°ä¸»API
            const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
            const { proxyUrl, apiKey, model } = useSecondaryApi 
                ? { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel }
                : state.apiConfig;
        
            if (!proxyUrl || !apiKey || !model) {
                throw new Error("ä¸»APIå’Œå‰¯APIå‡æœªé…ç½®æˆ–é…ç½®ä¸å®Œæ•´ã€‚");
            }
        
            const prompt = "è¯·ä¸ºè¿™å¼ å›¾ç‰‡èµ·ä¸€ä¸ªç®€æ´çš„ã€é€‚åˆä½œä¸ºå¤´åƒåº“æ ‡ç­¾çš„åå­—ã€‚ä¾‹å¦‚ï¼šâ€œå¾®ç¬‘è‡ªæ‹â€ã€â€œé˜³å…‰ä¸‹çš„çŒ«å’ªâ€ã€â€œè“å‘åŠ¨æ¼«å°‘å¥³â€ã€‚è¯·ç›´æ¥å›ç­”åå­—ï¼Œä¸è¦åŠ ä»»ä½•å¤šä½™çš„è§£é‡Šã€‚";
            
            let isGemini = proxyUrl.includes('generativelanguage');
            let response;
        
            if (isGemini) {
                const mimeType = base64Url.match(/^data:(.*);base64/)[1];
                const base64Data = base64Url.split(',')[1];
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: mimeType, data: base64Data } }
                        ]
                    }]
                };
                response = await fetch(`${proxyUrl}/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
        
            } else { // OpenAI å…¼å®¹ Vision API
                const payload = {
                    model: model,
                    messages: [{
                        role: 'user',
                        content: [
                            { type: 'text', text: prompt },
                            { type: 'image_url', image_url: { url: base64Url } }
                        ]
                    }],
                    max_tokens: 50 // é™åˆ¶è¾“å‡ºé•¿åº¦
                };
                response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify(payload)
                });
            }
        
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API é”™è¯¯: ${errorData.error.message}`);
            }
        
            const data = await response.json();
            let description = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
            
            // æ¸…ç†AIå¯èƒ½è¿”å›çš„å¤šä½™å­—ç¬¦
            return description.trim().replace(/["'â€œâ€â€˜â€™]/g, '');
        }
        // â–²â–²â–² å…¨æ–°åŠŸèƒ½å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        /**
         * ã€å…¨æ–°ã€‘å½“å•èŠè§’è‰²çš„åç§°è¢«ä¿®æ”¹åï¼Œè‡ªåŠ¨åŒæ­¥å…¶åœ¨æ‰€æœ‰ç¾¤èŠä¸­çš„ä¿¡æ¯
         * @param {object} characterChat - è¢«ä¿®æ”¹äº†åç§°çš„ã€å•èŠã€‘chatå¯¹è±¡
         */
        async function syncCharacterNameInGroups(characterChat) {
            // 1. å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ä¼ å…¥çš„æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å•èŠå¯¹è±¡
            if (!characterChat || characterChat.isGroup) {
                console.warn("syncCharacterNameInGroups: ä¼ å…¥çš„ä¸æ˜¯æœ‰æ•ˆçš„å•èŠå¯¹è±¡ï¼Œå·²è·³è¿‡åŒæ­¥ã€‚");
                return;
            }
        
            const characterId = characterChat.id;
            const newRemarkName = characterChat.name;        // è¿™æ˜¯è§’è‰²æ–°çš„ã€å¤‡æ³¨åã€‘
            const newOriginalName = characterChat.originalName;  // è¿™æ˜¯è§’è‰²æ–°çš„ã€æœ¬åã€‘
        
            console.log(`æ­£åœ¨ä¸ºè§’è‰² ${characterId} åŒæ­¥æ‰€æœ‰ç¾¤èŠå†…çš„åç§°ä¿¡æ¯...`);
        
            // 2. éå†å†…å­˜ä¸­æ‰€æœ‰çš„èŠå¤©è®°å½•ï¼Œæ‰¾å‡ºæ‰€æœ‰ç¾¤èŠ
            for (const chatId in state.chats) {
                const groupChat = state.chats[chatId];
                
                // 3. ç­›é€‰å‡ºç¾¤èŠï¼Œå¹¶ç¡®ä¿å®ƒæœ‰æˆå‘˜åˆ—è¡¨
                if (groupChat.isGroup && groupChat.members) {
                    // 4. åœ¨ç¾¤èŠä¸­æŸ¥æ‰¾å¯¹åº”çš„æˆå‘˜
                    const memberToUpdate = groupChat.members.find(m => m.id === characterId);
        
                    // å¦‚æœåœ¨è¿™ä¸ªç¾¤é‡Œæ‰¾åˆ°äº†è¯¥æˆå‘˜
                    if (memberToUpdate) {
                        let needsDbUpdate = false; // æ ‡è®°æ˜¯å¦éœ€è¦æ›´æ–°æ•°æ®åº“ï¼Œä»¥ä¼˜åŒ–æ€§èƒ½
                        
                        // 5. å¯¹æ¯”å¹¶æ›´æ–°ç¾¤å†…æ˜µç§° (groupNickname)ï¼Œå®ƒåº”è¯¥ä¸å•èŠçš„å¤‡æ³¨å(name)ä¿æŒä¸€è‡´
                        if (memberToUpdate.groupNickname !== newRemarkName) {
                            memberToUpdate.groupNickname = newRemarkName;
                            needsDbUpdate = true;
                        }
        
                        // 6. å¯¹æ¯”å¹¶æ›´æ–°ç¾¤å†…çš„æœ¬å (originalName)
                        if (memberToUpdate.originalName !== newOriginalName) {
                            memberToUpdate.originalName = newOriginalName;
                            needsDbUpdate = true;
                        }
        
                        // 7. å¦‚æœæœ‰ä»»ä½•æ›´æ–°ï¼Œå°±æŠŠè¿™ä¸ªã€æ•´ä¸ªç¾¤èŠå¯¹è±¡ã€‘ä¹Ÿä¿å­˜å›æ•°æ®åº“
                        if (needsDbUpdate) {
                            await db.chats.put(groupChat);
                            console.log(`æˆåŠŸå°†ç¾¤èŠ "${groupChat.name}" ä¸­çš„æˆå‘˜ä¿¡æ¯æ›´æ–°`);
                        }
                    }
                }
            }
        }
        
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ç²˜è´´åˆ° syncCharacterNameInGroups çš„ä¸‹æ–¹ â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°ã€‘å½“å•èŠè§’è‰²çš„å¤´åƒè¢«ä¿®æ”¹åï¼Œè‡ªåŠ¨åŒæ­¥å…¶åœ¨æ‰€æœ‰ç¾¤èŠä¸­çš„å¤´åƒä¿¡æ¯
         * @param {object} characterChat - è¢«ä¿®æ”¹äº†å¤´åƒçš„ã€å•èŠã€‘chatå¯¹è±¡
         */
        async function syncCharacterAvatarInGroups(characterChat) {
            // 1. å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿æ˜¯æœ‰æ•ˆçš„å•èŠå¯¹è±¡
            if (!characterChat || characterChat.isGroup) {
                console.warn("syncCharacterAvatarInGroups: ä¼ å…¥çš„ä¸æ˜¯æœ‰æ•ˆçš„å•èŠå¯¹è±¡ï¼Œå·²è·³è¿‡åŒæ­¥ã€‚");
                return;
            }
        
            const characterId = characterChat.id;
            const newAvatar = characterChat.settings.aiAvatar; // è·å–æœ€æ–°çš„å¤´åƒURL
        
            console.log(`æ­£åœ¨ä¸ºè§’è‰² ${characterId} åŒæ­¥æ‰€æœ‰ç¾¤èŠå†…çš„å¤´åƒ...`);
        
            // 2. éå†æ‰€æœ‰èŠå¤©ï¼Œæ‰¾å‡ºæ‰€æœ‰ç¾¤èŠ
            for (const groupChat of Object.values(state.chats)) {
                if (groupChat.isGroup && groupChat.members) {
                    // 3. åœ¨ç¾¤èŠä¸­æŸ¥æ‰¾å¯¹åº”çš„æˆå‘˜
                    const memberToUpdate = groupChat.members.find(m => m.id === characterId);
                    
                    // 4. å¦‚æœæ‰¾åˆ°äº†è¯¥æˆå‘˜ï¼Œå¹¶ä¸”å¤´åƒä¿¡æ¯ä¸ä¸€è‡´ï¼Œå°±æ›´æ–°å®ƒ
                    if (memberToUpdate && memberToUpdate.avatar !== newAvatar) {
                        memberToUpdate.avatar = newAvatar; // å°†æ–°å¤´åƒåŒæ­¥åˆ°ç¾¤æˆå‘˜æ•°æ®ä¸­
                        
                        // 5. ã€è‡³å…³é‡è¦ã€‘å°†ä¿®æ”¹åçš„ã€æ•´ä¸ªç¾¤èŠå¯¹è±¡ã€‘å­˜å›æ•°æ®åº“
                        await db.chats.put(groupChat);
                        console.log(`æˆåŠŸå°†è§’è‰² ${characterId} çš„æ–°å¤´åƒåŒæ­¥åˆ°ç¾¤èŠ "${groupChat.name}"`);
                    }
                }
            }
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„ã€æ›´æ™ºèƒ½çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ getDisplayNameInGroup å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€å…¨æ–° | å·²ä¿®å¤ç”¨æˆ·è¯†åˆ«é—®é¢˜ã€‘æ ¹æ®è§’è‰²æœ¬åï¼Œåœ¨æŒ‡å®šç¾¤èŠä¸­è·å–å…¶æ­£ç¡®çš„æ˜¾ç¤ºåç§°ï¼ˆç¾¤æ˜µç§°ï¼‰
         * @param {object} groupChat - å½“å‰çš„ç¾¤èŠå¯¹è±¡
         * @param {string} originalName - è§’è‰²çš„æœ¬å (e.g., "å°å¯çˆ±", "æ–¹äº¦æ¥·")
         * @returns {string} - è¯¥è§’è‰²åœ¨æ­¤ç¾¤èŠä¸­çš„ç¾¤æ˜µç§°ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™è¿”å›å…¶æœ¬å
         */
        function getDisplayNameInGroup(groupChat, originalName) {
            // å®‰å…¨æ£€æŸ¥ï¼Œå¦‚æœä¿¡æ¯ä¸å…¨åˆ™ç›´æ¥è¿”å›
            if (!groupChat || !groupChat.isGroup || !originalName) {
                return originalName;
            }
        
            // --- ã€ã€ã€æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œï¼ã€‘ã€‘ã€‘ ---
        
            // æ­¥éª¤1ï¼šä¼˜å…ˆæ£€æŸ¥è¿™ä¸ªâ€œæœ¬åâ€æ˜¯ä¸æ˜¯ã€ç”¨æˆ·è‡ªå·±ã€‘çš„å…¨å±€æœ¬å
            // ç”¨æˆ·çš„å…¨å±€æœ¬åå­˜å‚¨åœ¨ qzoneSettings.nickname ä¸­
            const userOriginalName = state.qzoneSettings.nickname || '{{user}}';
            if (originalName === userOriginalName) {
                // å¦‚æœæ˜¯ç”¨æˆ·ï¼Œå°±è¿”å›ç”¨æˆ·åœ¨ã€è¿™ä¸ªç¾¤èŠä¸­ã€‘çš„ä¸“å±æ˜µç§°
                return groupChat.settings.myNickname || 'æˆ‘';
            }
        
            // æ­¥éª¤2ï¼šå¦‚æœä¸æ˜¯ç”¨æˆ·ï¼Œå†åˆ°ç¾¤æˆå‘˜åˆ—è¡¨é‡Œå»æŸ¥æ‰¾å¯¹åº”çš„AIè§’è‰²
            const member = groupChat.members.find(m => m.originalName === originalName);
            
            // æ­¥éª¤3ï¼šå¦‚æœæ‰¾åˆ°äº†AIæˆå‘˜ï¼Œå°±è¿”å›TAçš„ç¾¤æ˜µç§°ï¼›å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œå°±è¿”å›åŸå§‹åå­—ä½œä¸ºä¿åº•
            return member ? member.groupNickname : originalName;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸ªå‡½æ•°ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘åˆ‡æ¢æ¸²æŸ“è§„åˆ™çš„åˆ†ç±»é¡µç­¾
         * @param {string} categoryId - è¦åˆ‡æ¢åˆ°çš„åˆ†ç±»ID ('global' æˆ– èŠå¤©ID)
         */
        function switchRuleCategory(categoryId) {
            // åˆ‡æ¢é¡µç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.rules-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
            });
            // åˆ‡æ¢å†…å®¹é¢æ¿çš„æ˜¾ç¤ºçŠ¶æ€
            document.querySelectorAll('.rules-category-pane').forEach(pane => {
                pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
            });
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸ªå‡½æ•°ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°ã€‘æ ¹æ®è§’è‰²çš„æœ¬åï¼Œåœ¨æ•´ä¸ªåº”ç”¨ä¸­æŸ¥æ‰¾å…¶æ­£ç¡®çš„æ˜¾ç¤ºåç§°
         * @param {string} originalName - è§’è‰²çš„æœ¬å (e.g., "ææ˜Ÿè¾°")
         * @returns {string} - è¯¥è§’è‰²çš„å¤‡æ³¨å/ç¾¤æ˜µç§°/ç”¨æˆ·æ˜µç§°ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™è¿”å›å…¶æœ¬å
         */
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å…¨æ–°ã€æ›´æ™ºèƒ½ã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ getDisplayNameByOriginalName å‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘æ ¹æ®è§’è‰²çš„æœ¬åæˆ–æ›¾ç”¨åï¼Œåœ¨æ•´ä¸ªåº”ç”¨ä¸­æŸ¥æ‰¾å…¶æ­£ç¡®çš„ã€å½“å‰æ˜¾ç¤ºåç§°ã€‘
         * @param {string} nameIdentifier - è§’è‰²çš„æœ¬å æˆ– å‚¨å­˜åœ¨æ—§æ•°æ®ä¸­çš„æ›¾ç”¨å
         * @returns {string} - è¯¥è§’è‰²çš„ã€å½“å‰ã€‘å¤‡æ³¨å/ç¾¤æ˜µç§°/ç”¨æˆ·æ˜µç§°ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™è¿”å›ä¼ å…¥çš„æ ‡è¯†ç¬¦
         */
        function getDisplayNameByOriginalName(nameIdentifier) {
            // 1. å¦‚æœä¼ å…¥çš„æ˜¯ç©ºå€¼ï¼Œç›´æ¥è¿”å›
            if (!nameIdentifier) return '';
        
            // 2. æ£€æŸ¥æ˜¯ä¸æ˜¯ç”¨æˆ·è‡ªå·±
            if (state.qzoneSettings && nameIdentifier === state.qzoneSettings.nickname) {
                return state.qzoneSettings.nickname;
            }
            
            // 3. ã€ä¸»è¦æŸ¥æ‰¾æ–¹å¼ã€‘: é€šè¿‡â€œæœ¬åâ€ (originalName) æŸ¥æ‰¾ã€‚
            // è¿™æ˜¯æœ€æ ‡å‡†ã€æœ€å¯é çš„æ–¹å¼ï¼Œé€‚ç”¨äºæ‰€æœ‰æ–°åˆ›å»ºçš„æ•°æ®ã€‚
            let characterChat = Object.values(state.chats).find(chat => !chat.isGroup && chat.originalName === nameIdentifier);
            if (characterChat) {
                return characterChat.name; // å¦‚æœæ‰¾åˆ°ï¼Œè¿”å›è¯¥è§’è‰²ã€å½“å‰ã€‘çš„å¤‡æ³¨å
            }
        
            // 4. ã€å…¼å®¹æ—§æ•°æ®ã€‘: å¦‚æœé€šè¿‡â€œæœ¬åâ€æ²¡æ‰¾åˆ°ï¼Œå°±å°è¯•æŠŠä¼ å…¥çš„åå­—å½“ä½œä¸€ä¸ªã€æ—§çš„å¤‡æ³¨åã€‘å»å†å²è®°å½•é‡ŒæŸ¥æ‰¾ã€‚
            characterChat = Object.values(state.chats).find(chat => 
                !chat.isGroup && 
                (chat.nameHistory && chat.nameHistory.includes(nameIdentifier))
            );
            if (characterChat) {
                return characterChat.name; // å¦‚æœåœ¨å†å²è®°å½•é‡Œæ‰¾åˆ°äº†ï¼ŒåŒæ ·è¿”å›è¯¥è§’è‰²ã€å½“å‰ã€‘çš„å¤‡æ³¨å
            }
        
            // 5. ã€æœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆã€‘: å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ‰¾ä¸åˆ°ï¼Œè¯´æ˜è¿™å¯èƒ½æ˜¯ä¸€ä¸ªéå¸¸æ—§çš„æ•°æ®ï¼Œæˆ–è€…è§’è‰²å·²è¢«åˆ é™¤ã€‚
            // æ­¤æ—¶ï¼Œç›´æ¥è¿”å›å‚¨å­˜åœ¨è¯„è®ºé‡Œçš„é‚£ä¸ªåå­—ï¼Œè‡³å°‘èƒ½ä¿è¯æœ‰å†…å®¹æ˜¾ç¤ºã€‚
            return nameIdentifier;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å…¨æ–°çš„ã€æ›´æ™ºèƒ½çš„ã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ processMentions å‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘å¤„ç†AIç”Ÿæˆçš„æ–‡æœ¬ï¼Œå°†ç‰¹æ®Šçš„@å ä½ç¬¦æ›¿æ¢ä¸ºæ­£ç¡®çš„æ˜¾ç¤ºåç§°
         * @param {string} text - AIç”Ÿæˆçš„ã€å¯èƒ½åŒ…å« @[[æœ¬å]] å ä½ç¬¦çš„åŸå§‹æ–‡æœ¬
         * @param {object|null} chat - å½“å‰çš„èŠå¤©å¯¹è±¡ (å¦‚æœæ˜¯ç¾¤èŠï¼Œåˆ™ç”¨äºæŸ¥æ‰¾ç¾¤æ˜µç§°)
         * @returns {string} - å¤„ç†å®Œæˆåï¼Œå¯¹ç”¨æˆ·å‹å¥½çš„æ˜¾ç¤ºæ–‡æœ¬
         */
        function processMentions(text, chat = null) {
            // å¦‚æœæ–‡æœ¬æ— æ•ˆæˆ–ä¸åŒ…å«@æ ‡è®°ï¼Œç›´æ¥è¿”å›ä»¥æé«˜æ€§èƒ½
            if (!text || typeof text !== 'string' || !text.includes('@[[')) {
                return text; 
            }
            
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„å…¨å±€åŒ¹é…ï¼Œä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰@æåŠ
            return text.replace(/@\[\[([^\]]+)\]\]/g, (match, originalName) => {
                const trimmedOriginalName = originalName.trim();
                let displayName;
                
                // ã€æ ¸å¿ƒé€»è¾‘ã€‘å¦‚æœæä¾›äº†èŠå¤©å¯¹è±¡ï¼Œå¹¶ä¸”æ˜¯ç¾¤èŠ
                if (chat && chat.isGroup) {
                    // å°±è°ƒç”¨æˆ‘ä»¬ç°æœ‰çš„ã€å¼ºå¤§çš„ getDisplayNameInGroup å‡½æ•°
                    // è¿™ä¸ªå‡½æ•°ä¼šè‡ªåŠ¨ä¼˜å…ˆæŸ¥æ‰¾ç¾¤æ˜µç§°ï¼Œæ‰¾ä¸åˆ°å†ç”¨æœ¬å
                    displayName = getDisplayNameInGroup(chat, trimmedOriginalName);
                } else {
                    // å¦‚æœæ˜¯ç§èŠæˆ–æ²¡æœ‰æä¾›èŠå¤©å¯¹è±¡ï¼Œå°±ä½¿ç”¨å…¨å±€æŸ¥æ‰¾å‡½æ•°
                    displayName = getDisplayNameByOriginalName(trimmedOriginalName);
                }
                
                // è¿”å›è½¬æ¢åçš„ã€å¸¦@çš„æ­£ç¡®æ˜µç§°
                return `@${displayName}`;
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ä¿®æ­£åã€‘çš„å®Œæ•´å‡½æ•°ï¼Œæ›¿æ¢æ‰æ‚¨ç°æœ‰çš„ showCustomConfirm å‡½æ•° â–¼â–¼â–¼
        
        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
        
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œé‡æ–°è·å–æœ€æ–°çš„æŒ‰é’®å…ƒç´ 
                const confirmBtn = document.getElementById('custom-modal-confirm');
                const cancelBtn = document.getElementById('custom-modal-cancel');
        
                cancelBtn.style.display = 'block';
        
                confirmBtn.textContent = options.confirmText || 'ç¡®å®š';
                cancelBtn.textContent = options.cancelText || 'å–æ¶ˆ';
        
                if (options.confirmButtonClass) {
                    confirmBtn.classList.add(options.confirmButtonClass);
                } else {
                    // ç¡®ä¿ä¹‹å‰çš„å±é™©æ“ä½œæ ·å¼è¢«ç§»é™¤
                    confirmBtn.classList.remove('btn-danger');
                }
        
                // ä¸ºæœ€æ–°çš„æŒ‰é’®ç»‘å®šæœ¬æ¬¡çš„ç‚¹å‡»äº‹ä»¶
                confirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                cancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
                function showCustomAlert(title, message) {
                    return new Promise(resolve => {
                        modalResolve = resolve;
                        modalTitle.textContent = title;
                        modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                        modalCancelBtn.style.display = 'none';
                        modalConfirmBtn.textContent = 'å¥½çš„';
                        modalConfirmBtn.onclick = () => {
                            modalCancelBtn.style.display = 'block'; 
                            modalConfirmBtn.textContent = 'ç¡®å®š';
                            resolve(true); 
                            hideCustomModal();
                        };
                        showCustomModal();
                    });
                }
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ä¿®æ­£åã€‘çš„å®Œæ•´å‡½æ•°ï¼Œæ›¿æ¢æ‰æ‚¨ç°æœ‰çš„ showCustomPrompt å‡½æ•° â–¼â–¼â–¼
        
        function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                const inputId = 'custom-prompt-input';
                
                const inputHtml = type === 'textarea' 
                    ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
                    : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;
                
                modalBody.innerHTML = extraHtml + inputHtml;
                const input = document.getElementById(inputId);
        
                modalBody.querySelectorAll('.format-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const templateStr = btn.dataset.template;
                        if (templateStr) {
                            try {
                                const templateObj = JSON.parse(templateStr);
                                input.value = JSON.stringify(templateObj, null, 2);
                                input.focus();
                            } catch(e) { console.error("è§£ææ ¼å¼æ¨¡æ¿å¤±è´¥:", e); }
                        }
                    });
                });
                
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œé‡æ–°è·å–æœ€æ–°çš„æŒ‰é’®å…ƒç´ 
                const confirmBtn = document.getElementById('custom-modal-confirm');
                const cancelBtn = document.getElementById('custom-modal-cancel');
                
                // ä¸ºæœ€æ–°çš„æŒ‰é’®ç»‘å®šæœ¬æ¬¡çš„ç‚¹å‡»äº‹ä»¶
                confirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
                cancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
        
                showCustomModal();
                setTimeout(() => input.focus(), 100);
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€å…¨æ–°ã€‘çš„å‡½æ•°ä»£ç ç²˜è´´åˆ° showCustomPrompt å‡½æ•°çš„åé¢ â–¼â–¼â–¼
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„ã€æ›´å¥å£®çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ showChoiceModal â–¼â–¼â–¼
        /**
         * ã€å·²ä¿®å¤ã€‘æ˜¾ç¤ºä¸€ä¸ªåŒ…å«å¤šä¸ªé€‰é¡¹çš„æ“ä½œèœå•æ¨¡æ€æ¡†
         * @param {string} title - æ¨¡æ€æ¡†çš„æ ‡é¢˜
         * @param {Array<object>} options - æŒ‰é’®é€‰é¡¹æ•°ç»„, e.g., [{ text: 'æŒ‰é’®æ–‡å­—', value: 'è¿”å›å€¼' }]
         * @returns {Promise<string|null>} - è¿”å›ç”¨æˆ·ç‚¹å‡»æŒ‰é’®çš„valueï¼Œå¦‚æœå–æ¶ˆåˆ™è¿”å›null
         */
        function showChoiceModal(title, options) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal-overlay');
                const modalTitle = document.getElementById('custom-modal-title');
                const modalBody = document.getElementById('custom-modal-body');
                const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');
        
                // 1. è®¾ç½®æ ‡é¢˜å’Œæ¸…ç©ºå†…å®¹åŒº
                modalTitle.textContent = title;
                modalBody.innerHTML = ''; 
                
                // 2. åŠ¨æ€åˆ›å»ºé€‰é¡¹æŒ‰é’®
                modalFooter.innerHTML = ''; 
                modalFooter.style.flexDirection = 'column';
        
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option.text;
                    button.onclick = () => {
                        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸å†è°ƒç”¨ hideCustomModalï¼Œè€Œæ˜¯ç›´æ¥æ§åˆ¶
                        modal.classList.remove('visible');
                        resolve(option.value);
                    };
                    modalFooter.appendChild(button);
                });
        
                // 3. æ·»åŠ ä¸€ä¸ªæ ‡å‡†çš„å–æ¶ˆæŒ‰é’®
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'å–æ¶ˆ';
                cancelButton.style.marginTop = '8px';
                cancelButton.style.borderRadius = '8px';
                cancelButton.style.backgroundColor = '#f0f0f0';
                cancelButton.onclick = () => {
                    modal.classList.remove('visible');
                    resolve(null); // ç”¨æˆ·å–æ¶ˆï¼Œè¿”å› null
                };
                modalFooter.appendChild(cancelButton);
        
                // 4. æ˜¾ç¤ºæ¨¡æ€æ¡†
                modal.classList.add('visible');
        
            }).finally(() => {
                // 5. ã€ã€ã€è¿™å°±æ˜¯æœ€å…³é”®çš„ä¿®å¤ï¼ã€‘ã€‘ã€‘
                // æ— è®ºç”¨æˆ·æ˜¯é€‰æ‹©äº†é€‰é¡¹è¿˜æ˜¯å–æ¶ˆï¼Œæœ€åéƒ½ã€å¿…é¡»ã€‘å°†æ¨¡æ€æ¡†çš„é¡µè„šæ¢å¤ä¸ºåŸå§‹çš„ã€åŠŸèƒ½å®Œæ•´çš„çŠ¶æ€ã€‚
                const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');
        
                modalFooter.style.flexDirection = 'row'; // æ¢å¤æ°´å¹³å¸ƒå±€
                // é‡æ–°åˆ›å»ºåŸå§‹çš„â€œå–æ¶ˆâ€å’Œâ€œç¡®å®šâ€æŒ‰é’®
                modalFooter.innerHTML = `
                    <button id="custom-modal-cancel">å–æ¶ˆ</button>
                    <button id="custom-modal-confirm" class="confirm-btn">ç¡®å®š</button>
                `;
        
                // ã€é‡è¦ã€‘ä¸ºæ–°åˆ›å»ºçš„æŒ‰é’®é‡æ–°ç»‘å®šå®ƒä»¬æœ€åŸºæœ¬çš„é»˜è®¤äº‹ä»¶ï¼
                document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
                // æ³¨æ„ï¼šæˆ‘ä»¬ä¸éœ€è¦ä¸ºâ€œç¡®å®šâ€æŒ‰é’®ç»‘å®šé»˜è®¤äº‹ä»¶ï¼Œå› ä¸º showCustomConfirm å’Œ showCustomPrompt 
                // æ¯æ¬¡è°ƒç”¨æ—¶éƒ½ä¼šä¸ºå®ƒåŠ¨æ€ç»‘å®šæ–°çš„ onclick äº‹ä»¶ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„è¡Œä¸ºã€‚
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªã€å…¨æ–°ã€‘çš„å‡½æ•°ç²˜è´´åˆ° showChoiceModal å‡½æ•°çš„åé¢ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘è·å–æ­Œè¯å†…å®¹ï¼ˆæ”¯æŒæ–‡ä»¶å’Œç²˜è´´ï¼Œå¹¶ä¿®å¤ç²˜è´´æ ¼å¼ï¼‰
         * @returns {Promise<string|null>} è¿”å›æ­Œè¯æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œå¦‚æœç”¨æˆ·å–æ¶ˆåˆ™è¿”å›null
         */
        async function getLrcContent() {
            // 1. å¼¹å‡ºé€‰æ‹©æ¡†
            const choice = await showChoiceModal('é€‰æ‹©æ­Œè¯å¯¼å…¥æ–¹å¼', [
                { text: 'ğŸ“ ä»æœ¬åœ°æ–‡ä»¶ (.lrc)', value: 'file' },
                { text: 'ğŸ“‹ ç›´æ¥ç²˜è´´æ­Œè¯æ–‡æœ¬', value: 'paste' }
            ]);
        
            // 2. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©æ‰§è¡Œä¸åŒæ“ä½œ
            if (choice === 'file') {
                // ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ï¼šè¿™éƒ¨åˆ†é€»è¾‘ä¸å˜ï¼Œå®ƒå·¥ä½œæ­£å¸¸
                return new Promise(resolve => {
                    const lrcInput = document.getElementById('lrc-upload-input');
                    const lrcChangeHandler = (e) => {
                        const lrcFile = e.target.files[0];
                        if (lrcFile) {
                            const reader = new FileReader();
                            reader.onload = (readEvent) => resolve(readEvent.target.result);
                            reader.onerror = () => resolve(""); // å‡ºé”™æ—¶è¿”å›ç©ºå­—ç¬¦ä¸²
                            reader.readAsText(lrcFile);
                        } else {
                            resolve(null); // ç”¨æˆ·å…³é—­äº†æ–‡ä»¶é€‰æ‹©æ¡†
                        }
                        lrcInput.removeEventListener('change', lrcChangeHandler);
                        lrcInput.value = ''; // é‡ç½®inputï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒåæ–‡ä»¶
                    };
                    lrcInput.addEventListener('change', lrcChangeHandler, { once: true });
                    lrcInput.click();
                });
            } else if (choice === 'paste') {
                // ç”¨æˆ·é€‰æ‹©ç²˜è´´ï¼šå¼¹å‡ºæ–‡æœ¬è¾“å…¥æ¡†
                const pastedText = await showCustomPrompt(
                    'ç²˜è´´æ­Œè¯',
                    'è¯·åœ¨æ­¤å¤„ç²˜è´´å®Œæ•´çš„LRCæ ¼å¼æ­Œè¯...',
                    '',
                    'textarea' // ä½¿ç”¨å¤šè¡Œæ–‡æœ¬æ¡†
                );
                
                // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œ â˜…â˜…â˜… ---
                if (pastedText) {
                    // åœ¨è§£æä¹‹å‰ï¼Œè‡ªåŠ¨ä¸ºæ¯ä¸ªæ—¶é—´æˆ³å‰æ·»åŠ æ¢è¡Œç¬¦
                    // è¿™ä¼šä¿®å¤å•è¡Œç²˜è´´çš„é—®é¢˜
                    const formattedText = pastedText.replace(/\[/g, '\n[').trim();
                    return formattedText;
                }
                return pastedText; // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œè¿™é‡Œä¼šè¿”å› null
                // --- â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜… ---
        
            } else {
                // ç”¨æˆ·ç‚¹å‡»äº†â€œå–æ¶ˆâ€
                return null;
            }
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
                // ===================================================================
                // 2. æ•°æ®åº“ç»“æ„å®šä¹‰
                // ===================================================================
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ª V30 ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ db.version(...) ä»£ç å— â–¼â–¼â–¼
        db.version(36).stores({ 
            doubanPosts: '++id, timestamp',
            chats: '&id, isGroup, groupId, isPinned, memos, diary, appUsageLog',
            apiConfig: '&id', 
            globalSettings: '&id', 
            userStickers: '&id, url, name, categoryId',
            worldBooks: '&id, name, categoryId',
            worldBookCategories: '++id, name',
            musicLibrary: '&id', 
            personaPresets: '&id',
            qzoneSettings: '&id',
            qzonePosts: '++id, timestamp, authorId',
            qzoneAlbums: '++id, name, createdAt',
            qzonePhotos: '++id, albumId',
            favorites: '++id, type, timestamp, originalTimestamp',
            qzoneGroups: '++id, name',
            memories: '++id, chatId, timestamp, type, targetDate',
            callRecords: '++id, chatId, timestamp, customName',
            shoppingProducts: '++id, name, description',
            apiPresets: '++id, name',
            renderingRules: '++id, name, chatId',
            appearancePresets: '++id, name, type',
            stickerCategories: '++id, name',
            customAvatarFrames: '++id, name',
            presets: '&id, name, categoryId', // æ–°å¢ï¼šé¢„è®¾ä¸»è¡¨
            presetCategories: '++id, name',
            npcs: '++id, name',
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºNPCè¡¨æ·»åŠ åå°æ´»åŠ¨ã€å†·å´æ—¶é—´å’Œæœ€åè¡ŒåŠ¨æ—¶é—´æˆ³å­—æ®µ
            npcs: '++id, name, enableBackgroundActivity, actionCooldownMinutes, lastActionTimestamp'  
        }).upgrade(tx => {
            // è¿™ä¸ªå‡çº§å‡½æ•°ä¼šè‡ªåŠ¨å¤„ç†æ•°æ®è¿ç§»
            return tx.table('worldBooks').toCollection().modify(book => {
                // ç¡®ä¿ content å­—æ®µæ˜¯æ•°ç»„
                if (typeof book.content === 'string' && book.content.trim() !== '') {
                    book.content = [{
                        keys: [],
                        comment: 'ä»æ—§ç‰ˆæœ¬è¿ç§»çš„æ¡ç›®',
                        content: book.content
                    }];
                } else if (!Array.isArray(book.content)) {
                    book.content = [];
                }

                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºæ‰€æœ‰æ¡ç›®æ·»åŠ  enabled å±æ€§ï¼Œé»˜è®¤ä¸º true
                book.content.forEach(entry => {
                    if (typeof entry.enabled === 'undefined') {
                        entry.enabled = true;
                    }
                });
            });
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
window.db = db;        
                // ===================================================================
                // 3. æ‰€æœ‰åŠŸèƒ½å‡½æ•°å®šä¹‰
                // ===================================================================
        
                function showScreen(screenId) {
                    if (screenId === 'chat-list-screen') {
                        window.renderChatListProxy(); 
                        switchToChatListView('messages-view');
                    }
                    if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
                    if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
                    if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
                 Â  Â if (screenId === 'x-social-screen') window.renderXSocialScreenProxy();
                     if (screenId === 'douban-screen') renderDoubanScreen();
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    const screenToShow = document.getElementById(screenId);
                    if (screenToShow) screenToShow.classList.add('active');
                    if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
                    if (screenId === 'font-settings-screen') {
            loadFontPresetsDropdown(); // <-- æ–°å¢è¿™ä¸€è¡Œ
                        document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
                        applyCustomFont(state.globalSettings.fontUrl || '', true);
                    }
                }
                window.updateListenTogetherIconProxy = () => {};
        
                function switchToChatListView(viewId) {
                    const chatListScreen = document.getElementById('chat-list-screen');
                    const views = {
                        'messages-view': document.getElementById('messages-view'),
                        'qzone-screen': document.getElementById('qzone-screen'),
                        'favorites-view': document.getElementById('favorites-view'),
                'memories-view': document.getElementById('memories-view'),
               'npc-list-view': document.getElementById('npc-list-view')
            };
                    const mainHeader = document.getElementById('main-chat-list-header');
                    const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // è·å–ä¸»å¯¼èˆªæ 
        
                    if (isFavoritesSelectionMode) {
                        document.getElementById('favorites-edit-btn').click(); 
                    }
        
                    // éšè—æ‰€æœ‰è§†å›¾
                    Object.values(views).forEach(v => v.classList.remove('active'));
                    // æ˜¾ç¤ºç›®æ ‡è§†å›¾
                    if (views[viewId]) {
                        views[viewId].classList.add('active');
                    }
        
                    // æ›´æ–°åº•éƒ¨å¯¼èˆªæ é«˜äº®
                    document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.view === viewId);
                    });
                    
                    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰UIå…ƒç´ çš„æ˜¾éš â–¼â–¼â–¼
                    if (viewId === 'messages-view') {
                        mainHeader.style.display = 'flex';
                        mainBottomNav.style.display = 'flex';
                    } else {
                        mainHeader.style.display = 'none';
                        mainBottomNav.style.display = 'none';
                    }
                    // â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–²
        
            if (viewId !== 'memories-view') {
                activeCountdownTimers.forEach(timerId => clearInterval(timerId));
                activeCountdownTimers = [];
            }
        
                    // æ ¹æ®è§†å›¾IDæ‰§è¡Œç‰¹å®šçš„æ¸²æŸ“/æ›´æ–°é€»è¾‘
                    switch (viewId) {
                        case 'qzone-screen':
                            views['qzone-screen'].style.backgroundColor = '#f0f2f5';
                            updateUnreadIndicator(0);
                            renderQzoneScreen();
                            renderQzonePosts();
                            break;
                        case 'favorites-view':
                            views['favorites-view'].style.backgroundColor = '#f9f9f9';
                            renderFavoritesScreen();
                            break;
                        case 'messages-view':
                            // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è¿”å›æ¶ˆæ¯åˆ—è¡¨æ—¶è¦æ‰§è¡Œçš„é€»è¾‘
                            break;
        case 'npc-list-view':
            renderNpcListScreen(); // åˆ‡æ¢åˆ°NPCè§†å›¾æ—¶ï¼Œæ¸²æŸ“åˆ—è¡¨
            break;
                    }
                }
Â  Â  // Xç¤¾äº¤é¡µé¢æ¸²æŸ“å‡½æ•°
Â  Â  Â  function renderXSocialScreen() {
Â  Â  Â  Â  // æš‚æ—¶ä¸ºç©ºï¼Œåç»­æ·»åŠ Xç¤¾äº¤é¡µé¢çš„æ¸²æŸ“é€»è¾‘
Â  Â  Â  Â  console.log("æ¸²æŸ“Xç¤¾äº¤é¡µé¢");
Â  Â  Â  }
Â  Â  Â  window.renderXSocialScreenProxy = renderXSocialScreen;
                
                function renderQzoneScreen() {
                    if (state && state.qzoneSettings) {
                        const settings = state.qzoneSettings;
                        document.getElementById('qzone-nickname').textContent = settings.nickname;
                        document.getElementById('qzone-avatar-img').src = settings.avatar;
                        document.getElementById('qzone-banner-img').src = settings.banner;
                    }
                }
                window.renderQzoneScreenProxy = renderQzoneScreen;
        
                async function saveQzoneSettings() {
                    if (db && state.qzoneSettings) {
                        await db.qzoneSettings.put(state.qzoneSettings);
                    }
                }
        
                function formatPostTimestamp(timestamp) {
                    if (!timestamp) return '';
                    const now = new Date();
                    const date = new Date(timestamp);
                    const diffSeconds = Math.floor((now - date) / 1000);
                    const diffMinutes = Math.floor(diffSeconds / 60);
                    const diffHours = Math.floor(diffMinutes / 60);
                    if (diffMinutes < 1) return 'åˆšåˆš';
                    if (diffMinutes < 60) return `${diffMinutes}åˆ†é’Ÿå‰`;
                    if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    if (now.getFullYear() === year) {
                        return `${month}-${day} ${hours}:${minutes}`;
                    } else {
                        return `${year}-${month}-${day} ${hours}:${minutes}`;
                    }
                }
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸‰ä¸ªå‡½æ•°ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–° | æ€§èƒ½æ ¸å¿ƒ | å·²é›†æˆMarkdownã€‘æ ¹æ®å¸–å­æ•°æ®ï¼Œåˆ›å»ºæˆ–æ›´æ–°å•ä¸ªå¸–å­çš„HTMLå…ƒç´ 
         * @param {object} post - å•ä¸ªå¸–å­çš„æ•°æ®å¯¹è±¡
         * @returns {HTMLElement} - åˆ›å»ºæˆ–æ›´æ–°åçš„å¸–å­å®¹å™¨DOMå…ƒç´ 
         */
        function createOrUpdatePostElement(post) {
            const existingPostContainer = document.querySelector(`.qzone-post-container[data-post-id="${post.id}"]`);
            const isUpdating = !!existingPostContainer;
            
            const postContainer = isUpdating ? existingPostContainer : document.createElement('div');
            if (!isUpdating) {
                postContainer.className = 'qzone-post-container';
                postContainer.dataset.postId = post.id;
            }
        
            const postEl = isUpdating ? postContainer.querySelector('.qzone-post-item') : document.createElement('div');
            if (!isUpdating) {
                postEl.className = 'qzone-post-item';
            }
        
            let authorAvatar = '', authorNickname = '', commentAvatar = state.qzoneSettings.avatar; 
        
            if (post.authorId === 'user') {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
            } else if (state.chats[post.authorId]) {
                const authorChat = state.chats[post.authorId];
                authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
                authorNickname = authorChat.name;
            } else {
                authorNickname = getDisplayNameByOriginalName(post.authorOriginalName);
                authorAvatar = defaultAvatar;
            }
        
function renderOriginalPostContent(targetPost) {
            let innerContentHtml = '';
            const publicTextHtml = targetPost.publicText ? `<div class="post-content">${parseMarkdown(targetPost.publicText).replace(/\n/g, '<br>')}</div>` : '';

            if (targetPost.type === 'shuoshuo') {
                innerContentHtml = `<div class="post-content" style="margin-bottom: 10px;">${parseMarkdown(targetPost.content).replace(/\n/g, '<br>')}</div>`;
            } else if (targetPost.type === 'image_post' && targetPost.imageUrl) {
                // ã€æ ¸å¿ƒä¿®å¤ã€‘ç›´æ¥ä½¿ç”¨ targetPost.imageUrl æ¥æ˜¾ç¤ºç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡
                innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${targetPost.imageUrl}" class="chat-image"></div>` : `<img src="${targetPost.imageUrl}" class="chat-image">`;
            } else if (targetPost.type === 'text_image') {
                const postImageUrl = state.globalSettings.enableAiDrawing && targetPost.image_prompt ? `https://image.pollinations.ai/prompt/${targetPost.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
                innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}"></div>` : `<img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}">`;
            }
            return innerContentHtml;
        }
        
            let mainContentHtml;
        
            if (post.type === 'repost') {
                // â–¼â–¼â–¼ å·²æ·»åŠ  Markdown è§£æ â–¼â–¼â–¼
                const repostCommentHtml = post.repostComment ? `<div class="post-content">${parseMarkdown(post.repostComment).replace(/\n/g, '<br>')}</div>` : '';
                let originalAuthorAvatar = defaultAvatar;
                let originalAuthorNickname = 'åŸä½œè€…';
                if (post.originalPost.authorId === 'user') {
                    originalAuthorAvatar = state.qzoneSettings.avatar;
                    originalAuthorNickname = state.qzoneSettings.nickname;
                } else {
                    const originalAuthorChat = state.chats[post.originalPost.authorId];
                    if (originalAuthorChat) {
                        originalAuthorAvatar = originalAuthorChat.settings.aiAvatar || defaultAvatar;
                    }
                    originalAuthorNickname = getDisplayNameByOriginalName(post.originalPost.authorOriginalName);
                }
                mainContentHtml = `
                    ${repostCommentHtml}
                    <div class="reposted-content-wrapper">
                        <div class="post-header">
                            <img src="${originalAuthorAvatar}" class="post-avatar">
                            <div class="post-info">
                                <span class="post-nickname">@${originalAuthorNickname}</span>
                                <span class="post-timestamp">${formatPostTimestamp(post.originalPost.timestamp)}</span>
                            </div>
                        </div>
                        <div class="post-main-content">${renderOriginalPostContent(post.originalPost)}</div>
                    </div>
                `;
            } else {
                mainContentHtml = `<div class="post-main-content">${renderOriginalPostContent(post)}</div>`;
            }
        
            let likesHtml = '';
            if (post.likes && post.likes.length > 0) {
                const displayLikes = post.likes.map(name => getDisplayNameByOriginalName(name)).join('ã€');
                likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${displayLikes} è§‰å¾—å¾ˆèµ</span></div>`;
            }
        
            let commentsHtml = '';
            if (post.comments && post.comments.length > 0) {
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach((comment, index) => {
                    if (typeof comment === 'object' && comment !== null && comment.commenterName) {
                        const commenterOriginalName = comment.commenterName;
                        const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);
                        
                        let innerCommentContent;
                        if (STICKER_REGEX.test(comment.text)) {
                            innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
                        } else {
                            // â–¼â–¼â–¼ å·²æ·»åŠ  Markdown è§£æ â–¼â–¼â–¼
                            innerCommentContent = parseMarkdown(comment.text);
                        }
        
                        let commentLineHtml = '';
                        if (comment.replyTo) {
                            const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
                            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> å›å¤ <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
                        } else {
                            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
                        }
                        
                        commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                            <div class="comment-text">${commentLineHtml}</div>
                                            <span class="comment-delete-btn" data-comment-index="${index}">Ã—</span>
                                         </div>`;
        
                    } else {
                        // â–¼â–¼â–¼ å·²ä¸ºæ—§æ ¼å¼è¯„è®ºæ·»åŠ  Markdown è§£æ â–¼â–¼â–¼
                        commentsHtml += `<div class="legacy-comment-item">
                                            <span class="comment-text">${parseMarkdown(String(comment))}</span>
                                         </div>`;
                    }
                });
                commentsHtml += '</div>';
            }
        
            const userOriginalName = state.qzoneSettings.nickname;
            const isLikedByUser = post.likes && post.likes.includes(userOriginalName);
            const isFavoritedByUser = state.favoritedPostIds && state.favoritedPostIds.has(post.id);
        
            let repostIconHtml = '';
            if (post.type !== 'repost') {
                repostIconHtml = `
                    <span class="action-icon repost">
                        <svg viewBox="0 0 24 24"><path d="M17 2.1l4 4-4 4 M3 11.5v-3a4 4 0 0 1 4-4h13 M7 21.9l-4-4 4-4 M21 12.5v3a4 4 0 0 1-4 4H4"></path></svg>
                    </span>`;
            }
            
            postEl.innerHTML = `
                <div class="post-header">
                    <img src="${authorAvatar}" class="post-avatar" data-author-id="${post.authorId}">
                    <div class="post-info">
                        <span class="post-nickname">${authorNickname}</span>
                        <span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
                    </div>
                    <div class="post-actions-btn">â€¦</div>
                </div>
                ${mainContentHtml}
                <div class="post-feedback-icons">
                    ${repostIconHtml}
                    <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                    <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                </div>
                ${likesHtml}
                ${commentsHtml}
                <div class="post-footer">
                    <div class="comment-section">
                        <img src="${commentAvatar}" class="comment-avatar">
                        <input type="text" class="comment-input" placeholder="å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹">
                        <button class="comment-sticker-btn">
        <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 14 Q 12 16 16 14"></path>
            <line x1="9" y1="9" x2="9.01" y2="9"></line>
            <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
        </button>
                        <div class="at-mention-popup"></div>
                    </div>
                    <button class="comment-send-btn">å‘é€</button>
                </div>
            `;
        
            if (!isUpdating) {
                const deleteAction = document.createElement('div');
                deleteAction.className = 'qzone-post-delete-action';
                deleteAction.innerHTML = '<span>åˆ é™¤</span>';
                postContainer.appendChild(postEl);
                postContainer.appendChild(deleteAction);
            }
            
            return postContainer;
        }
        
        /**
         * ã€å…¨æ–° | å¢é‡æ›´æ–°å‡½æ•°ã€‘åªæ›´æ–°å•ä¸ªå¸–å­ï¼Œè€Œä¸æ˜¯é‡ç»˜æ•´ä¸ªåˆ—è¡¨
         * @param {number} postId - éœ€è¦æ›´æ–°çš„å¸–å­çš„ID
         */
        async function updateSinglePostInDOM(postId) {
            const postData = await db.qzonePosts.get(postId);
            if (!postData) {
                // å¦‚æœå¸–å­è¢«åˆ äº†ï¼Œå°±ä»DOMä¸­ç§»é™¤
                const postContainer = document.querySelector(`.qzone-post-container[data-post-id="${postId}"]`);
                if (postContainer) postContainer.remove();
                return;
            }
        
            // æ›´æ–°ç¼“å­˜
            const cacheIndex = qzonePostsCache.findIndex(p => p.id === postId);
            if (cacheIndex > -1) qzonePostsCache[cacheIndex] = postData;
            
            // æ›´æ–°æ”¶è—çŠ¶æ€
            const favorites = await db.favorites.where('type').equals('qzone_post').toArray();
            state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
        
            // è°ƒç”¨æ ¸å¿ƒå‡½æ•°æ¥æ›´æ–°DOM
            createOrUpdatePostElement(postData);
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸ªå‡½æ•°ç²˜è´´åˆ° formatPostTimestamp å‡½æ•°çš„åé¢ â–¼â–¼â–¼
        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);
            const minutes = Math.floor(seconds / 60);
            if (minutes < 2) return 'åˆšåˆš';
            if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}å°æ—¶å‰`;
            const days = Math.floor(hours / 24);
            return `${days}å¤©å‰`;
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸¤ä¸ªå‡½æ•°ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–° | æ€§èƒ½æ ¸å¿ƒã€‘æ ¹æ®å¸–å­æ•°æ®ï¼Œåˆ›å»ºæˆ–æ›´æ–°å•ä¸ªå¸–å­çš„HTMLå…ƒç´ 
         * @param {object} post - å•ä¸ªå¸–å­çš„æ•°æ®å¯¹è±¡
         * @returns {HTMLElement} - åˆ›å»ºæˆ–æ›´æ–°åçš„å¸–å­å®¹å™¨DOMå…ƒç´ 
         */
        function createOrUpdatePostElement(post) {
            const existingPostContainer = document.querySelector(`.qzone-post-container[data-post-id="${post.id}"]`);
            const isUpdating = !!existingPostContainer;
            
            // å¦‚æœæ˜¯æ›´æ–°ï¼Œå°±ç›´æ¥ç”¨æ—§çš„å®¹å™¨ï¼›å¦‚æœæ˜¯æ–°å»ºï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„
            const postContainer = isUpdating ? existingPostContainer : document.createElement('div');
            if (!isUpdating) {
                postContainer.className = 'qzone-post-container';
                postContainer.dataset.postId = post.id;
            }
        
            // --- åç»­çš„HTMLæ„å»ºé€»è¾‘ä¸æ‚¨æ—§çš„ renderQzonePosts å‡½æ•°å®Œå…¨ç›¸åŒ ---
            // (æˆ‘ä»¬åªæ˜¯æŠŠå®ƒä»ä¸€ä¸ªå¤§å¾ªç¯é‡ŒæŠ½ç¦»å‡ºæ¥ï¼Œå˜æˆä¸€ä¸ªç‹¬ç«‹çš„ã€å¯å¤ç”¨çš„å‡½æ•°)
            const postEl = isUpdating ? postContainer.querySelector('.qzone-post-item') : document.createElement('div');
            if (!isUpdating) {
                postEl.className = 'qzone-post-item';
            }
        
            let authorAvatar = '', authorNickname = '', commentAvatar = state.qzoneSettings.avatar; 
        
            if (post.authorId === 'user') {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
            } else if (state.chats[post.authorId]) {
                const authorChat = state.chats[post.authorId];
                authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
                authorNickname = authorChat.name;
            } else {
                authorNickname = getDisplayNameByOriginalName(post.authorOriginalName);
                authorAvatar = defaultAvatar;
            }
        
function renderOriginalPostContent(targetPost) {
            let innerContentHtml = '';
            const publicTextHtml = targetPost.publicText ? `<div class="post-content">${parseMarkdown(targetPost.publicText).replace(/\n/g, '<br>')}</div>` : '';

            if (targetPost.type === 'shuoshuo') {
                innerContentHtml = `<div class="post-content" style="margin-bottom: 10px;">${parseMarkdown(targetPost.content).replace(/\n/g, '<br>')}</div>`;
            } else if (targetPost.type === 'image_post' && targetPost.imageUrl) {
                // ã€æ ¸å¿ƒä¿®å¤ â‘ ã€‘ç›´æ¥ä½¿ç”¨ targetPost.imageUrl æ˜¾ç¤ºæ‚¨ä¸Šä¼ çš„å›¾ç‰‡
                innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${targetPost.imageUrl}" class="chat-image"></div>` : `<img src="${targetPost.imageUrl}" class="chat-image">`;
            } else if (targetPost.type === 'text_image') {
                // ï¼ˆè¿™éƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜ï¼Œç”¨äºAIç”Ÿæˆçš„æ–‡å­—å›¾ï¼‰
                const postImageUrl = state.globalSettings.enableAiDrawing && targetPost.image_prompt ? `https://image.pollinations.ai/prompt/${targetPost.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
                innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}"></div>` : `<img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}">`;
            }
            return innerContentHtml;
        }
        
            let mainContentHtml;
        
            if (post.type === 'repost') {
                const repostCommentHtml = post.repostComment ? `<div class="post-content">${post.repostComment.replace(/\n/g, '<br>')}</div>` : '';
                let originalAuthorAvatar = defaultAvatar;
                let originalAuthorNickname = 'åŸä½œè€…';
                if (post.originalPost.authorId === 'user') {
                    originalAuthorAvatar = state.qzoneSettings.avatar;
                    originalAuthorNickname = state.qzoneSettings.nickname;
                } else {
                    const originalAuthorChat = state.chats[post.originalPost.authorId];
                    if (originalAuthorChat) {
                        originalAuthorAvatar = originalAuthorChat.settings.aiAvatar || defaultAvatar;
                    }
                    originalAuthorNickname = getDisplayNameByOriginalName(post.originalPost.authorOriginalName);
                }
                mainContentHtml = `
                    ${repostCommentHtml}
                    <div class="reposted-content-wrapper">
                        <div class="post-header">
                            <img src="${originalAuthorAvatar}" class="post-avatar">
                            <div class="post-info">
                                <span class="post-nickname">@${originalAuthorNickname}</span>
                                <span class="post-timestamp">${formatPostTimestamp(post.originalPost.timestamp)}</span>
                            </div>
                        </div>
                        <div class="post-main-content">${renderOriginalPostContent(post.originalPost)}</div>
                    </div>
                `;
            } else {
                mainContentHtml = `<div class="post-main-content">${renderOriginalPostContent(post)}</div>`;
            }
        
            let likesHtml = '';
            if (post.likes && post.likes.length > 0) {
                const displayLikes = post.likes.map(name => getDisplayNameByOriginalName(name)).join('ã€');
                likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${displayLikes} è§‰å¾—å¾ˆèµ</span></div>`;
            }
        
        // â–¼â–¼â–¼ åœ¨ createOrUpdatePostElement å‡½æ•°ä¸­ï¼Œæ‰¾åˆ° let commentsHtml = ''; å¹¶ç”¨ä¸‹é¢è¿™æ•´å—æ›¿æ¢ â–¼â–¼â–¼
            let commentsHtml = '';
            if (post.comments && post.comments.length > 0) {
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach((comment, index) => {
                    // ã€æ ¸å¿ƒä¿®å¤1ã€‘æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„ã€åŒ…å« commenterName çš„å¯¹è±¡æ ¼å¼
                    if (typeof comment === 'object' && comment !== null && comment.commenterName) {
                        const commenterOriginalName = comment.commenterName;
                        // ã€æ ¸å¿ƒä¿®å¤2ã€‘ä½¿ç”¨æˆ‘ä»¬å…¨æ–°çš„å‡½æ•°æ¥å®æ—¶æŸ¥æ‰¾æœ€æ–°çš„æ˜¾ç¤ºåç§°ï¼
                        const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);
                        
                        let innerCommentContent;
                        if (STICKER_REGEX.test(comment.text)) {
                            innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
                        } else {
                            innerCommentContent = parseMarkdown(comment.text);
                        }
        
                        let commentLineHtml = '';
                        // ã€æ ¸å¿ƒä¿®å¤3ã€‘å›å¤çš„ç›®æ ‡ä¹Ÿä½¿ç”¨æ–°å‡½æ•°æ¥æŸ¥æ‰¾åå­—
                        if (comment.replyTo) {
                            const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
                            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> å›å¤ <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
                        } else {
                            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
                        }
                        
                        commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                            <div class="comment-text">${commentLineHtml}</div>
                                            <span class="comment-delete-btn" data-comment-index="${index}">Ã—</span>
                                         </div>`;
        
                    } else {
                        // ã€å…¼å®¹æ—§æ•°æ®ã€‘å¦‚æœè¿˜æ˜¯æ—§çš„å­—ç¬¦ä¸²æ ¼å¼ï¼Œå°±åŸæ ·æ˜¾ç¤º
                        commentsHtml += `<div class="legacy-comment-item">
                                            <span class="comment-text">${String(comment)}</span>
                                         </div>`;
                    }
                });
                commentsHtml += '</div>';
            }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
            const userOriginalName = state.qzoneSettings.nickname;
            const isLikedByUser = post.likes && post.likes.includes(userOriginalName);
            const isFavoritedByUser = state.favoritedPostIds && state.favoritedPostIds.has(post.id); // ä» state è¯»å–
        
            let repostIconHtml = '';
            if (post.type !== 'repost') {
                repostIconHtml = `
                    <span class="action-icon repost">
                        <svg viewBox="0 0 24 24"><path d="M17 2.1l4 4-4 4 M3 11.5v-3a4 4 0 0 1 4-4h13 M7 21.9l-4-4 4-4 M21 12.5v3a4 4 0 0 1-4 4H4"></path></svg>
                    </span>`;
            }
            
            postEl.innerHTML = `
                <div class="post-header">
                    <img src="${authorAvatar}" class="post-avatar" data-author-id="${post.authorId}">
                    <div class="post-info">
                        <span class="post-nickname">${authorNickname}</span>
                        <span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
                    </div>
                    <div class="post-actions-btn">â€¦</div>
                </div>
                ${mainContentHtml}
                <div class="post-feedback-icons">
                    ${repostIconHtml}
                    <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                    <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                </div>
                ${likesHtml}
                ${commentsHtml}
                <div class="post-footer">
                    <div class="comment-section">
                        <img src="${commentAvatar}" class="comment-avatar">
                        <input type="text" class="comment-input" placeholder="å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹">
                        <button class="comment-sticker-btn">
        <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 14 Q 12 16 16 14"></path>
            <line x1="9" y1="9" x2="9.01" y2="9"></line>
            <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
        </button>
                        <div class="at-mention-popup"></div>
                    </div>
                    <button class="comment-send-btn">å‘é€</button>
                </div>
            `;
        
            if (!isUpdating) {
                const deleteAction = document.createElement('div');
                deleteAction.className = 'qzone-post-delete-action';
                deleteAction.innerHTML = '<span>åˆ é™¤</span>';
                postContainer.appendChild(postEl);
                postContainer.appendChild(deleteAction);
            }
            
            return postContainer;
        }
        
        /**
         * ã€å…¨æ–° | å¢é‡æ›´æ–°å‡½æ•°ã€‘åªæ›´æ–°å•ä¸ªå¸–å­ï¼Œè€Œä¸æ˜¯é‡ç»˜æ•´ä¸ªåˆ—è¡¨
         * @param {number} postId - éœ€è¦æ›´æ–°çš„å¸–å­çš„ID
         */
        async function updateSinglePostInDOM(postId) {
            const postData = await db.qzonePosts.get(postId);
            if (!postData) {
                // å¦‚æœå¸–å­è¢«åˆ äº†ï¼Œå°±ä»DOMä¸­ç§»é™¤
                const postContainer = document.querySelector(`.qzone-post-container[data-post-id="${postId}"]`);
                if (postContainer) {
                    postContainer.remove();
                }
                return;
            }
        
            // æ›´æ–°ç¼“å­˜
            const cacheIndex = qzonePostsCache.findIndex(p => p.id === postId);
            if (cacheIndex > -1) {
                qzonePostsCache[cacheIndex] = postData;
            }
            
            // æ›´æ–°æ”¶è—çŠ¶æ€
            const favorites = await db.favorites.where('type').equals('qzone_post').toArray();
            state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
        
            // è°ƒç”¨æ ¸å¿ƒå‡½æ•°æ¥æ›´æ–°DOM
            createOrUpdatePostElement(postData);
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–° | é«˜æ€§èƒ½ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå‡½æ•°å®Œæ•´æ›¿æ¢æ—§çš„ renderQzonePosts â–¼â–¼â–¼
        /**
         * ã€å…¨æ–° | åˆ†é¡µåŠ è½½ç‰ˆã€‘æ¸²æŸ“åŠ¨æ€åˆ—è¡¨
         */
        async function renderQzonePosts() {
            const postsListEl = document.getElementById('qzone-posts-list');
            if (!postsListEl) return;
        
            // 1. ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰æ•°æ®åˆ°ç¼“å­˜ä¸­ï¼Œä½†ä¸ç«‹å³æ¸²æŸ“
            const [postsFromDb, favorites] = await Promise.all([
                db.qzonePosts.orderBy('timestamp').reverse().filter(post => !post.isDeleted).toArray(),
                db.favorites.where('type').equals('qzone_post').toArray()
            ]);
            qzonePostsCache = postsFromDb;
            state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
        
            // 2. æ¸…ç©ºåˆ—è¡¨
            postsListEl.innerHTML = '';
        
            if (qzonePostsCache.length === 0) {
                postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡è¯´è¯´å§ï¼</p>';
                return;
            }
        
            // 3. åªæ¸²æŸ“ç¬¬ä¸€é¡µçš„åŠ¨æ€
            const initialPosts = qzonePostsCache.slice(0, QZONE_RENDER_WINDOW);
            const fragment = document.createDocumentFragment();
            initialPosts.forEach(post => {
                const postElement = createOrUpdatePostElement(post);
                fragment.appendChild(postElement);
            });
            postsListEl.appendChild(fragment);
            
            // 4. æ›´æ–°å·²æ¸²æŸ“çš„æ•°é‡
            qzonePostsRenderCount = initialPosts.length;
        
            // 5. å¦‚æœè¿˜æœ‰æ›´å¤šåŠ¨æ€ï¼Œå°±æ·»åŠ â€œåŠ è½½æ›´å¤šâ€æŒ‰é’®
            if (qzonePostsCache.length > qzonePostsRenderCount) {
                appendLoadMorePostsButton(postsListEl);
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        /**
         * ã€å…¨æ–°ã€‘åˆ›å»ºä¸€ä¸ªâ€œåŠ è½½æ›´å¤šâ€æŒ‰é’®å¹¶æ·»åŠ åˆ°åˆ—è¡¨æœ«å°¾
         * @param {HTMLElement} container - è¦æ·»åŠ æŒ‰é’®çš„å®¹å™¨
         */
        function appendLoadMorePostsButton(container) {
            const button = document.createElement('button');
            button.id = 'load-more-qzone-btn'; // ä½¿ç”¨æ–°IDï¼Œé¿å…ä¸èŠå¤©è®°å½•çš„æŒ‰é’®å†²çª
            button.textContent = 'åŠ è½½æ›´å¤šåŠ¨æ€';
            button.className = 'load-more-btn'; // å¤ç”¨èŠå¤©é¡µé¢çš„æŒ‰é’®æ ·å¼
            container.appendChild(button);
        }
        
        /**
         * ã€å…¨æ–°ã€‘åŠ è½½æ›´å¤šåŠ¨æ€è®°å½•
         */
        function loadMoreQzonePosts() {
            const postsListEl = document.getElementById('qzone-posts-list');
            if (!postsListEl) return;
        
            // ç§»é™¤æ—§çš„â€œåŠ è½½æ›´å¤šâ€æŒ‰é’®
            const loadMoreBtn = document.getElementById('load-more-qzone-btn');
            if (loadMoreBtn) loadMoreBtn.remove();
            
            // è®¡ç®—ä¸‹ä¸€é¡µè¦åŠ è½½çš„æ•°æ®
            const nextSliceStart = qzonePostsRenderCount;
            const nextSliceEnd = qzonePostsRenderCount + QZONE_RENDER_WINDOW;
            const postsToAppend = qzonePostsCache.slice(nextSliceStart, nextSliceEnd);
            
            // æ¸²æŸ“å¹¶è¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾
            const fragment = document.createDocumentFragment();
            postsToAppend.forEach(post => {
                const postElement = createOrUpdatePostElement(post);
                fragment.appendChild(postElement);
            });
            postsListEl.appendChild(fragment);
        
            // æ›´æ–°å·²æ¸²æŸ“çš„æ•°é‡
            qzonePostsRenderCount += postsToAppend.length;
        
            // å¦‚æœè¿˜æœ‰æ›´å¤šï¼Œå†æ¬¡æ·»åŠ æŒ‰é’®
            if (qzonePostsCache.length > qzonePostsRenderCount) {
                appendLoadMorePostsButton(postsListEl);
            }
        }
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åŠ¨æ€è¯„è®ºåŒºè¡¨æƒ…é¢æ¿ç®¡ç†å‡½æ•° â–¼â–¼â–¼
        
        function openQzoneStickerPanel(postId, buttonElement) {
            const panel = qzoneStickerPanelState.panelEl;
            const grid = qzoneStickerPanelState.gridEl;
        
            // 1. å¡«å……è¡¨æƒ… (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
            grid.innerHTML = '';
            if (state.userStickers.length === 0) {
                grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1; padding-top: 20px;">è¯·å…ˆåœ¨èŠå¤©ç•Œé¢çš„<br>è¡¨æƒ…é¢æ¿ä¸­æ·»åŠ è¡¨æƒ…åŒ…</p>';
            } else {
                state.userStickers.forEach(sticker => {
                    const item = document.createElement('div');
                    item.className = 'sticker-item';
                    item.style.backgroundImage = `url(${sticker.url})`;
                    item.title = sticker.name;
                    grid.appendChild(item);
                });
            }
        
            // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ­£ï¼šæ™ºèƒ½å®šä½é€»è¾‘ â–¼â–¼â–¼ ---
        
            // 2. è·å–å¿…è¦çš„å°ºå¯¸å’Œä½ç½®ä¿¡æ¯
            const btnRect = buttonElement.getBoundingClientRect();
            const phoneScreenRect = document.getElementById('phone-screen').getBoundingClientRect();
            
            panel.style.display = 'flex'; // å…ˆæ˜¾ç¤ºå‡ºæ¥æ‰èƒ½è·å–å°ºå¯¸
            const panelRect = panel.getBoundingClientRect();
            const panelHeight = panelRect.height;
            const panelWidth = panelRect.width;
        
            // 3. è®¡ç®—å‚ç›´ä½ç½® (ä¿æŒä¸å˜ï¼Œæ€»æ˜¯å‡ºç°åœ¨æŒ‰é’®ä¸Šæ–¹)
            panel.style.top = `${btnRect.top - panelHeight - 5 - phoneScreenRect.top}px`;
        
            // 4. è®¡ç®—å¹¶åˆ¤æ–­æ°´å¹³ä½ç½®
            const desiredLeftPosition = btnRect.left - phoneScreenRect.left;
        
            // å¦‚æœé¢æ¿çš„å·¦ä¾§ä½ç½® + è‡ªèº«å®½åº¦ > æ‰‹æœºå±å¹•å®½åº¦ï¼Œè¯´æ˜ä¼šè¶…å‡º
            if (desiredLeftPosition + panelWidth > phoneScreenRect.width) {
                // å¦‚æœä¼šè¶…å‡ºï¼Œåˆ™æ”¹ä¸ºè´´ç€å±å¹•å³ä¾§è¾¹ç¼˜æ˜¾ç¤º (ç•™5pxè¾¹è·)
                panel.style.left = 'auto';
                panel.style.right = '5px';
            } else {
                // å¦‚æœä¸ä¼šè¶…å‡ºï¼Œåˆ™æ­£å¸¸å¯¹é½æŒ‰é’®å·¦ä¾§
                panel.style.left = `${desiredLeftPosition}px`;
                panel.style.right = 'auto';
            }
            
            // --- â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² ---
        
            // 5. æ›´æ–°çŠ¶æ€ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
            qzoneStickerPanelState.isOpen = true;
            qzoneStickerPanelState.activePostId = postId;
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ° openQzoneStickerPanel å‡½æ•°çš„åé¢ â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘å…³é—­åŠ¨æ€è¯„è®ºåŒºçš„è¡¨æƒ…é¢æ¿
         */
        function closeQzoneStickerPanel() {
            // æ£€æŸ¥çŠ¶æ€ï¼Œç¡®ä¿é¢æ¿æ˜¯æ‰“å¼€çš„
            if (qzoneStickerPanelState.isOpen) {
                // éšè—é¢æ¿DOMå…ƒç´ 
                qzoneStickerPanelState.panelEl.style.display = 'none';
                
                // é‡ç½®çŠ¶æ€å˜é‡
                qzoneStickerPanelState.isOpen = false;
                qzoneStickerPanelState.activePostId = null;
            }
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€æ–°ä»£ç å—ã€‘æ›¿æ¢æ—§çš„ sendQzoneStickerComment å‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°å‡çº§ç‰ˆã€‘å‘é€åŠ¨æ€è¡¨æƒ…è¯„è®ºï¼Œå¹¶å‘ŠçŸ¥AIå…¶å«ä¹‰
         * @param {number} postId - å¸–å­ID
         * @param {object} sticker - å®Œæ•´çš„è¡¨æƒ…å¯¹è±¡ { url, name }
         */
        async function sendQzoneStickerComment(postId, sticker) {
            if (!sticker || !sticker.url) return;
        
            const post = await db.qzonePosts.get(postId);
            if (!post) {
                console.error("sendQzoneStickerComment: æ‰¾ä¸åˆ°å¸–å­:", postId);
                return;
            }
        
            if (!post.comments) {
                post.comments = [];
            }
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œä¸ºæ‚¨å‘é€çš„è¡¨æƒ…ä¹Ÿæ·»åŠ  meaning å­—æ®µ â–¼â–¼â–¼
            const newComment = {
                commenterName: state.qzoneSettings.nickname,
                text: sticker.url,
                meaning: sticker.name, // ä¿å­˜è¡¨æƒ…çš„å«ä¹‰
                timestamp: Date.now()
            };
            // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
            post.comments.push(newComment);
        
            await db.qzonePosts.update(postId, { comments: post.comments });
        
            closeQzoneStickerPanel();
            await renderQzonePosts();
            
            const postSummary = (post.publicText || post.content || `[å›¾ç‰‡åŠ¨æ€]`).substring(0, 30);
            
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šé€šçŸ¥AIæ—¶ï¼Œæ˜ç¡®å‘ŠçŸ¥è¡¨æƒ…çš„å«ä¹‰ â–¼â–¼â–¼
            for (const chatId in state.chats) {
                const chat = state.chats[chatId];
                if (!chat.isGroup) {
                    const intelligentPrompt = `[ç³»ç»Ÿæç¤ºï¼š'${state.qzoneSettings.nickname}' åœ¨ä½ çš„åŠ¨æ€(ID: ${postId}, å†…å®¹æ‘˜è¦: â€œ${postSummary}â€)ä¸‹å‘é€äº†ä¸€ä¸ªè¡¨æƒ…è¯„è®ºï¼Œæ„æ€æ˜¯ï¼šâ€œ${sticker.name}â€ã€‚è¯·ä½ å¯¹æ­¤ä½œå‡ºå›åº”ã€‚]`;
                    
                    const historyMessage = { 
                        role: 'system', 
                        content: intelligentPrompt, 
                        timestamp: Date.now(), 
                        isHidden: true 
                    };
                    chat.history.push(historyMessage);
                    await db.chats.put(chat);
                }
            }
            // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
        }
        
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™ä¸‰ä¸ªå‡½æ•°æ˜¯è½¬å‘åŠŸèƒ½çš„æ ¸å¿ƒï¼Œè¯·å°†å®ƒä»¬ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        
        /**
         * æ‰“å¼€è½¬å‘è¯„è®ºçš„æ¨¡æ€æ¡†
         * @param {number} postId - è¦è½¬å‘çš„åŠ¨æ€çš„ID
         */
        function openRepostModal(postId) {
            repostTargetId = postId;
            document.getElementById('repost-comment-input').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('repost-modal').classList.add('visible');
        }
        
        /**
         * éšè—è½¬å‘æ¨¡æ€æ¡†
         */
        function hideRepostModal() {
            document.getElementById('repost-modal').classList.remove('visible');
            repostTargetId = null;
        }
        
        /**
         * å¤„ç†ç¡®è®¤è½¬å‘çš„é€»è¾‘
         */
        async function handleConfirmRepost() {
            if (!repostTargetId) return;
        
            const comment = document.getElementById('repost-comment-input').value.trim();
            const originalPost = await db.qzonePosts.get(repostTargetId);
        
            if (!originalPost) {
                alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¦è½¬å‘çš„åŸå§‹åŠ¨æ€ã€‚");
                hideRepostModal();
                return;
            }
        
            const newPost = {
                type: 'repost', // æ ‡è®°ä¸ºè½¬å‘ç±»å‹
                timestamp: Date.now(),
                authorId: 'user', // è½¬å‘è€…æ°¸è¿œæ˜¯å½“å‰ç”¨æˆ·
                repostComment: comment,
                originalPost: originalPost, // å°†åŸå§‹åŠ¨æ€å®Œæ•´åœ°åµŒå…¥æ–°åŠ¨æ€ä¸­
                visibleGroupIds: null // è½¬å‘çš„åŠ¨æ€é»˜è®¤å¯¹æ‰€æœ‰äººå¯è§
            };
        
            await db.qzonePosts.add(newPost);
            hideRepostModal();
            await renderQzonePosts();
            alert('è½¬å‘æˆåŠŸï¼');
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²             
        // â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ä¸ªã€æ›´æ–°åçš„ã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ ä»£ç ä¸­æ—§çš„ displayFilteredFavorites å‡½æ•° â–¼â–¼â–¼
        
        function displayFilteredFavorites(items) {
            const listEl = document.getElementById('favorites-list');
            listEl.innerHTML = '';
        
            if (items.length === 0) {
                const searchTerm = document.getElementById('favorites-search-input').value;
                const message = searchTerm ? 'æœªæ‰¾åˆ°ç›¸å…³æ”¶è—' : 'ä½ çš„æ”¶è—å¤¹æ˜¯ç©ºçš„ï¼Œ<br>å¿«å»åŠ¨æ€æˆ–èŠå¤©ä¸­æ”¶è—å–œæ¬¢çš„å†…å®¹å§ï¼';
                listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
                return;
            }
        
            for (const item of items) {
                const card = document.createElement('div');
                card.className = 'favorite-item-card';
                card.dataset.favid = item.id;
        
                let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';
        
                if (item.type === 'qzone_post') {
                    const post = item.content;
                    sourceText = 'æ¥è‡ªåŠ¨æ€';
                    let authorAvatar = defaultAvatar, authorNickname = 'æœªçŸ¥ç”¨æˆ·';
        
                    if (post.authorId === 'user') {
                        authorAvatar = state.qzoneSettings.avatar;
                        authorNickname = state.qzoneSettings.nickname;
                    } else if (state.chats[post.authorId]) {
                        authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                        authorNickname = state.chats[post.authorId].name;
                    }
        
                    headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
                    
                    const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
                    if (post.type === 'shuoshuo') {
                        contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
                    } else if (post.type === 'image_post' && post.imageUrl) {
    const postImageUrl = state.globalSettings.enableAiDrawing && post.image_prompt ? `https://image.pollinations.ai/prompt/${post.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image"></div>` : `<img src="${postImageUrl}" class="chat-image">`;
} else if (post.type === 'text_image') {
    const postImageUrl = state.globalSettings.enableAiDrawing && post.image_prompt ? `https://image.pollinations.ai/prompt/${post.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
                    }
        
                    // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„ä»£ç å¼€å§‹ â–¼â–¼â–¼
                    
                    // 1. æ„é€ ç‚¹èµåŒºåŸŸçš„HTML
                    let likesHtml = '';
                    // æ£€æŸ¥ post å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨ likes æ•°ç»„å¹¶ä¸”ä¸ä¸ºç©º
                    if (post.likes && post.likes.length > 0) {
                        // å¦‚æœå­˜åœ¨ï¼Œå°±åˆ›å»ºç‚¹èµåŒºåŸŸçš„ div
                        likesHtml = `
                            <div class="post-likes-section">
                                <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                <span>${post.likes.join('ã€')} è§‰å¾—å¾ˆèµ</span>
                            </div>`;
                    }
        
                    // 2. æ„é€ è¯„è®ºåŒºåŸŸçš„HTML
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤æ–¹æ¡ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„ã€å‘ä¸‹å…¼å®¹çš„ä»£ç å—æ›¿æ¢æ—§çš„ if(post.comments...) é€»è¾‘ â–¼â–¼â–¼
        let commentsHtml = '';
        if (post.comments && post.comments.length > 0) {
            commentsHtml = '<div class="post-comments-container">';
            post.comments.forEach((comment, index) => {
                // --- æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œåˆ¤æ–­è¯„è®ºçš„æ•°æ®æ ¼å¼ ---
                if (typeof comment === 'object' && comment !== null && comment.commenterName) {
                    // --- è¿™æ˜¯æ–°æ ¼å¼çš„ã€åŠŸèƒ½å®Œæ•´çš„è¯„è®º ---
                    const commenterOriginalName = comment.commenterName;
                    const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);
                    
                    let innerCommentContent;
                    if (STICKER_REGEX.test(comment.text)) {
                        innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
                    } else {
                        innerCommentContent = comment.text;
                    }
        
                    let commentLineHtml = '';
                    if (comment.replyTo) {
                        const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
                        commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> å›å¤ <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
                    } else {
                        commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
                    }
                    
                    commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                        <div class="comment-text">${commentLineHtml}</div>
                                        <span class="comment-delete-btn" data-comment-index="${index}">Ã—</span>
                                     </div>`;
        
                } else {
                    // --- è¿™æ˜¯æ—§æ ¼å¼çš„ã€åªåšæ˜¾ç¤ºçš„è¯„è®º ---
                    // æˆ‘ä»¬æŠŠå®ƒæ¸²æŸ“æˆä¸€ä¸ªæ²¡æœ‰äº¤äº’ã€æ²¡æœ‰dataå±æ€§çš„ç®€å•divï¼Œä»è€Œé¿å…æŠ¥é”™
                    commentsHtml += `<div class="legacy-comment-item">
                                        <span class="comment-text">${String(comment)}</span>
                                     </div>`;
                }
            });
            commentsHtml += '</div>';
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
                    // 3. å°†ç‚¹èµå’Œè¯„è®ºçš„HTMLç»„åˆåˆ° footerHtml ä¸­
                    footerHtml = `${likesHtml}${commentsHtml}`;
                    
                    // â–²â–²â–² æ–°å¢/ä¿®æ”¹çš„ä»£ç ç»“æŸ â–²â–²â–²
        
        } else if (item.type === 'chat_message') {
            const msg = item.content;
            const chat = state.chats[item.chatId];
            if (!chat) continue; 
        
            sourceText = `æ¥è‡ªä¸ ${chat.name} çš„èŠå¤©`;
            const isUser = msg.role === 'user';
            let senderName, senderAvatar;
        
            if (isUser) {
                // ç”¨æˆ·æ¶ˆæ¯çš„é€»è¾‘ä¿æŒä¸å˜
                senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
                senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
            } else { // AI/æˆå‘˜æ¶ˆæ¯
                 if (chat.isGroup) {
                    // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯å”¯ä¸€çš„ã€æ ¸å¿ƒçš„ä¿®æ”¹ï¼ â˜…â˜…â˜…â˜…â˜…
                    // æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ originalName å»åŒ¹é…ï¼Œè€Œä¸æ˜¯æ—§çš„ name
                    const member = chat.members.find(m => m.originalName === msg.senderName);
                    // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹ç»“æŸ â˜…â˜…â˜…â˜…â˜…
                    
                    senderName = msg.senderName;
                    // å› ä¸ºç°åœ¨èƒ½æ­£ç¡®æ‰¾åˆ° member å¯¹è±¡äº†ï¼Œæ‰€ä»¥ä¹Ÿèƒ½æ­£ç¡®è·å–åˆ°ä»–çš„å¤´åƒ
                    senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
                } else {
                    // å•èŠçš„é€»è¾‘ä¿æŒä¸å˜
                    senderName = chat.name;
                    senderAvatar = chat.settings.aiAvatar || defaultAvatar;
                }
            }
        
            // åç»­æ‹¼æ¥ headerHtml å’Œ contentHtml çš„é€»è¾‘éƒ½ä¿æŒä¸å˜
            headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
            
            if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
                contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
            } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
            } else {
                contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
            }
        }
                      // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒæ–°å¢é€»è¾‘å°±åœ¨è¿™é‡Œï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
        else if (item.type === 'char_diary') {
            const diary = item.content;
            sourceText = `æ¥è‡ª ${diary.characterName} çš„æ—¥è®°`;

            const charChat = state.chats[diary.characterId];
            const authorAvatar = charChat ? charChat.settings.aiAvatar : defaultAvatar;
            
            headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${diary.characterName}</div></div>`;
            
            // 1. è·å–å®Œæ•´çš„æ—¥è®°å†…å®¹
            const fullDiaryContent = diary.content || '';
            // 2. ä½¿ç”¨ä¸è¯¦æƒ…é¡µå®Œå…¨ç›¸åŒçš„Markdownè§£æå’Œæ¢è¡Œé€»è¾‘
            const formattedContent = parseMarkdown(fullDiaryContent).replace(/\n/g, '<br>');

            // 3. å°†å®Œæ•´çš„ã€æ ¼å¼åŒ–åçš„å†…å®¹æ”¾å…¥ contentHtml
            contentHtml = `
                <span class="diary-title">${diary.title}</span>
                <div class="fav-card-content-full">${formattedContent}</div>
            `;
        }     
                // â–¼â–¼â–¼ ä¿®æ”¹æœ€ç»ˆçš„HTMLæ‹¼æ¥ï¼ŒåŠ å…¥ footerHtml â–¼â–¼â–¼
                card.innerHTML = `
                    <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
                    <div class="fav-card-content">${contentHtml}</div>
                    ${footerHtml}`; // <-- æŠŠæˆ‘ä»¬æ–°åˆ›å»ºçš„ footerHtml æ”¾åœ¨è¿™é‡Œ
                    
                listEl.appendChild(card);
            }
        }
        
        // â–²â–²â–² æ›¿æ¢åŒºåŸŸç»“æŸ â–²â–²â–²
        
                /**
                 * ã€é‡æ„åçš„å‡½æ•°ã€‘: è´Ÿè´£å‡†å¤‡æ•°æ®å¹¶è§¦å‘æ¸²æŸ“
                 */
                async function renderFavoritesScreen() {
                    // 1. ä»æ•°æ®åº“è·å–æœ€æ–°æ•°æ®å¹¶ç¼“å­˜
                    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
                    
                    // 2. æ¸…ç©ºæœç´¢æ¡†å¹¶éšè—æ¸…é™¤æŒ‰é’®
                    const searchInput = document.getElementById('favorites-search-input');
                    const clearBtn = document.getElementById('favorites-search-clear-btn');
                    searchInput.value = '';
                    clearBtn.style.display = 'none';
        
                    // 3. æ˜¾ç¤ºæ‰€æœ‰æ”¶è—é¡¹
                    displayFilteredFavorites(allFavoriteItems);
                }
        
                // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
        
                function resetCreatePostModal() {
                    document.getElementById('post-public-text').value = '';
                    document.getElementById('post-image-preview').src = '';
                    document.getElementById('post-image-description').value = '';
                    document.getElementById('post-image-preview-container').classList.remove('visible');
                    document.getElementById('post-image-desc-group').style.display = 'none';
                    document.getElementById('post-local-image-input').value = '';
                    document.getElementById('post-hidden-text').value = '';
                    document.getElementById('switch-to-image-mode').click();
                }
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ¸…ç†å†—ä½™æ•°æ®çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘ä¸€é”®æ¸…ç†æ•°æ®åº“ä¸­æ‰€æœ‰ä¸å·²åˆ é™¤è§’è‰²æˆ–èŠå¤©ç›¸å…³çš„å­¤ç«‹æ•°æ®
 */
async function cleanupRedundantData() {
    // 1. é¦–å…ˆï¼Œå‘ç”¨æˆ·æ˜¾ç¤ºä¸€ä¸ªå¸¦æœ‰ä¸¥é‡è­¦å‘Šçš„ç¡®è®¤æ¡†
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ¸…ç†å†—ä½™æ•°æ®ï¼Ÿ',
        'æ­¤æ“ä½œå°†æ‰«ææ•´ä¸ªæ•°æ®åº“ï¼Œç§»é™¤æ‰€æœ‰ä¸å·²åˆ é™¤è§’è‰²æˆ–èŠå¤©ç›¸å…³çš„å­¤ç«‹æ•°æ®ï¼ˆå¦‚åŠ¨æ€ã€è¯„è®ºã€è®°å¿†ç­‰ï¼‰ã€‚<br><br><strong>æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œä½†é€šå¸¸æ˜¯å®‰å…¨çš„ã€‚</strong><br><br>å»ºè®®åœ¨æ“ä½œå‰å…ˆå¯¼å‡ºæ•°æ®å¤‡ä»½ã€‚',
        { confirmButtonClass: 'btn-danger', confirmText: 'ç¡®è®¤æ¸…ç†' }
    );

    if (!confirmed) return; // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œåˆ™ä¸­æ­¢æ“ä½œ

    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨å¼€å§‹æ¸…ç†å†—ä½™æ•°æ®ï¼Œè¯·ä¸è¦å…³é—­é¡µé¢...");
    console.log("å†—ä½™æ•°æ®æ¸…ç†æµç¨‹å·²å¯åŠ¨...");

    // ç”¨äºç»Ÿè®¡æ¸…ç†ç»“æœçš„å¯¹è±¡
    let cleanupCounts = {
        posts: 0,
        likes: 0,
        comments: 0,
        memories: 0,
        callRecords: 0,
        renderingRules: 0,
        groupMembers: 0,
        chatLinks: 0,
    };

    try {
        // ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡æ¥ç¡®ä¿æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
        await db.transaction('rw', db.tables, async () => {
            // æ­¥éª¤ A: å»ºç«‹æ‰€æœ‰æœ‰æ•ˆèŠå¤©å’Œè§’è‰²çš„â€œç™½åå•â€
            const allChats = await db.chats.toArray();
            const existingChatIds = new Set(allChats.map(c => c.id));
            const existingOriginalNames = new Set(allChats.filter(c => !c.isGroup).map(c => c.originalName));
            existingOriginalNames.add(state.qzoneSettings.nickname || '{{user}}'); // æŠŠç”¨æˆ·è‡ªå·±ä¹ŸåŠ åˆ°ç™½åå•

            // æ­¥éª¤ B: é€ä¸€æ¸…ç†å„ä¸ªæ•°æ®è¡¨
            
            // æ¸…ç†åŠ¨æ€ (QZone Posts)
            const allPosts = await db.qzonePosts.toArray();
            for (const post of allPosts) {
                let postModified = false;
                // åˆ é™¤ä½œè€…ä¸å­˜åœ¨çš„åŠ¨æ€
                if (post.authorId !== 'user' && !existingChatIds.has(post.authorId)) {
                    await db.qzonePosts.delete(post.id);
                    cleanupCounts.posts++;
                    console.log(`åˆ é™¤äº†å­¤ç«‹åŠ¨æ€ (ID: ${post.id})ï¼Œä½œè€… ${post.authorId} å·²ä¸å­˜åœ¨ã€‚`);
                    continue; // å¸–å­å·²åˆ é™¤ï¼Œè·³è¿‡åç»­å¤„ç†
                }

                // æ¸…ç†ç‚¹èµåˆ—è¡¨ä¸­çš„æ— æ•ˆç”¨æˆ·
                if (post.likes && post.likes.length > 0) {
                    const originalLikeCount = post.likes.length;
                    post.likes = post.likes.filter(name => existingOriginalNames.has(name));
                    if (post.likes.length < originalLikeCount) {
                        cleanupCounts.likes += (originalLikeCount - post.likes.length);
                        postModified = true;
                    }
                }

                // æ¸…ç†è¯„è®ºåˆ—è¡¨ä¸­çš„æ— æ•ˆç”¨æˆ·
                if (post.comments && post.comments.length > 0) {
                    const originalCommentCount = post.comments.length;
                    post.comments = post.comments.filter(comment => {
                        if (typeof comment === 'object' && comment.commenterName) {
                            return existingOriginalNames.has(comment.commenterName);
                        }
                        return true; // ä¿ç•™æ— æ³•åˆ¤æ–­çš„æ—§æ ¼å¼è¯„è®º
                    });
                     if (post.comments.length < originalCommentCount) {
                        cleanupCounts.comments += (originalCommentCount - post.comments.length);
                        postModified = true;
                    }
                }
                
                if (postModified) {
                    await db.qzonePosts.put(post);
                }
            }

            // æ¸…ç†è®°å¿† (Memories)
            await db.memories.where('chatId').noneOf([...existingChatIds]).delete().then(c => cleanupCounts.memories += c);
            
            // æ¸…ç†é€šè¯è®°å½• (Call Records)
            await db.callRecords.where('chatId').noneOf([...existingChatIds]).delete().then(c => cleanupCounts.callRecords += c);

            // æ¸…ç†æ¸²æŸ“è§„åˆ™ (Rendering Rules)
            const allRules = await db.renderingRules.toArray();
            for(const rule of allRules) {
                if (rule.chatId !== 'global' && !existingChatIds.has(rule.chatId)) {
                    await db.renderingRules.delete(rule.id);
                    cleanupCounts.renderingRules++;
                }
            }

            // æ¸…ç†ç¾¤èŠä¸­çš„æ— æ•ˆæˆå‘˜å’ŒèŠå¤©ä¸­çš„æ— æ•ˆé“¾æ¥
            for (const chat of allChats) {
                 let chatModified = false;
                 // æ¸…ç†ç¾¤æˆå‘˜
                 if (chat.isGroup && chat.members) {
                     const originalMemberCount = chat.members.length;
                     chat.members = chat.members.filter(member => existingChatIds.has(member.id));
                     if (chat.members.length < originalMemberCount) {
                        cleanupCounts.groupMembers += (originalMemberCount - chat.members.length);
                        chatModified = true;
                     }
                 }
                 // æ¸…ç†æ— æ•ˆçš„æŒ‚è½½è®°å¿†é“¾æ¥
                 if (chat.settings?.linkedMemoryChatIds?.length > 0) {
                     const originalLinkCount = chat.settings.linkedMemoryChatIds.length;
                     chat.settings.linkedMemoryChatIds = chat.settings.linkedMemoryChatIds.filter(id => existingChatIds.has(id));
                     if (chat.settings.linkedMemoryChatIds.length < originalLinkCount) {
                        cleanupCounts.chatLinks += (originalLinkCount - chat.settings.linkedMemoryChatIds.length);
                        chatModified = true;
                     }
                 }
                 if(chatModified) {
                     await db.chats.put(chat);
                 }
            }
        }); // äº‹åŠ¡ç»“æŸ

        // 2. å‘ç”¨æˆ·æŠ¥å‘Šæ¸…ç†ç»“æœ
        let summary = "âœ… æ¸…ç†å®Œæˆï¼\n\n";
        let cleanedSomething = false;
        Object.entries(cleanupCounts).forEach(([key, value]) => {
            if (value > 0) {
                const keyMap = {
                    posts: 'åŠ¨æ€', likes: 'ç‚¹èµ', comments: 'è¯„è®º', memories: 'è®°å¿†',
                    callRecords: 'é€šè¯è®°å½•', renderingRules: 'æ¸²æŸ“è§„åˆ™',
                    groupMembers: 'ç¾¤æˆå‘˜', chatLinks: 'è®°å¿†é“¾æ¥'
                };
                summary += `- æ¸…ç†äº† ${value} æ¡æ— æ•ˆçš„${keyMap[key] || key}ã€‚\n`;
                cleanedSomething = true;
            }
        });
        if (!cleanedSomething) {
            summary = "âœ… æ£€æŸ¥å®Œæˆï¼Œæœªå‘ç°ä»»ä½•å†—ä½™æ•°æ®ã€‚";
        }
        summary += "\nå»ºè®®åˆ·æ–°é¡µé¢ä»¥ç¡®ä¿æ‰€æœ‰æ›´æ”¹ç”Ÿæ•ˆã€‚";

        await showCustomAlert("æ“ä½œæˆåŠŸ", summary);
        
        // 3. å»ºè®®ç”¨æˆ·åˆ·æ–°é¡µé¢
        const confirmedReload = await showCustomConfirm("åˆ·æ–°é¡µé¢ï¼Ÿ", "ä¸ºäº†ç¡®ä¿æ‰€æœ‰æ•°æ®åŒæ­¥ï¼Œå»ºè®®ç«‹å³åˆ·æ–°é¡µé¢ã€‚");
        if(confirmedReload) {
            location.reload();
        }

    } catch (error) {
        console.error("æ¸…ç†å†—ä½™æ•°æ®æ—¶å‡ºé”™:", error);
        await showCustomAlert('æ¸…ç†å¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: ${error.message}`);
    }
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²        
        // â–¼â–¼â–¼ ã€è¿™æ˜¯å¯¼å‡ºå‡½æ•°ä¿®å¤ç‰ˆã€‘ â–¼â–¼â–¼
        async function exportBackup() {
            try {
                const backupData = {
                    version: 1, 
                    timestamp: Date.now()
                };
        
                const [
                    chats, worldBooks, userStickers, apiConfig, globalSettings,
                    personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                    qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
                    memories, worldBookCategories,
                    apiPresets, shoppingProducts, callRecords,
                    renderingRules,
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
                    doubanPosts,
                    stickerCategories,
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
                    appearancePresets,
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
                    presets,              // <-- ã€æœ¬æ¬¡æ–°å¢ä¿®å¤ã€‘
                    presetCategories,
    // ã€æ ¸å¿ƒæ–°å¢ã€‘
    npcs 
                ] = await Promise.all([
                    db.chats.toArray(),
                    db.worldBooks.toArray(),
                    db.userStickers.toArray(),
                    db.apiConfig.get('main'),
                    db.globalSettings.get('main'),
                    db.personaPresets.toArray(),
                    db.musicLibrary.get('main'),
                    db.qzoneSettings.get('main'),
                    db.qzonePosts.toArray(),
                    db.qzoneAlbums.toArray(),
                    db.qzonePhotos.toArray(),
                    db.favorites.toArray(),
                    db.qzoneGroups.toArray(),
                    db.memories.toArray(),
                    db.worldBookCategories.toArray(),
                    db.apiPresets.toArray(),
                    db.shoppingProducts.toArray(),
                    db.callRecords.toArray(),
                    db.renderingRules.toArray(),
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
                    db.doubanPosts.toArray(),
                    db.stickerCategories.toArray(),
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
                    db.appearancePresets.toArray(),
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
                    db.presets.toArray(),             // <-- ã€æœ¬æ¬¡æ–°å¢ä¿®å¤ã€‘
                    db.presetCategories.toArray(),
    // ã€æ ¸å¿ƒæ–°å¢ã€‘
    db.npcs.toArray() 
                ]);
        
                Object.assign(backupData, {
                    chats, worldBooks, userStickers, apiConfig, globalSettings,
                    personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                    qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
                    memories, worldBookCategories,
                    apiPresets, shoppingProducts, callRecords,
                    renderingRules,
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
                    doubanPosts,
                    stickerCategories,
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
                    appearancePresets,
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
                    presets,              // <-- ã€æœ¬æ¬¡æ–°å¢ä¿®å¤ã€‘
                    presetCategories,
    // ã€æ ¸å¿ƒæ–°å¢ã€‘
    npcs  
                });
                
                const blob = new Blob(
                    [JSON.stringify(backupData, null, 2)], 
                    { type: 'application/json' }
                );
                const url = URL.createObjectURL(blob);
                const link = Object.assign(document.createElement('a'), {
                    href: url,
                    download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
                });
                link.click();
                URL.revokeObjectURL(url);
                
                await showCustomAlert('å¯¼å‡ºæˆåŠŸ', 'å·²æˆåŠŸå¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼');
        
            } catch (error) {
                console.error("å¯¼å‡ºæ•°æ®æ—¶å‡ºé”™:", error);
                await showCustomAlert('å¯¼å‡ºå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: ${error.message}`);
            }
        }
        
        // â–¼â–¼â–¼ ã€è¿™æ˜¯å¯¼å…¥å‡½æ•°ä¿®å¤ç‰ˆã€‘ â–¼â–¼â–¼
        async function importBackup(file) {
            if (!file) return;
        
            const confirmed = await showCustomConfirm(
                'ä¸¥é‡è­¦å‘Šï¼',
                'å¯¼å…¥å¤‡ä»½å°†å®Œå…¨è¦†ç›–æ‚¨å½“å‰çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬èŠå¤©ã€åŠ¨æ€ã€è®¾ç½®ç­‰ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼æ‚¨ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (!confirmed) return;
        
            try {
                const text = await file.text();
                const data = JSON.parse(text);
        
                await db.transaction('rw', db.tables, async () => {
                    for (const table of db.tables) {
                        await table.clear();
                    }
        
                    if (Array.isArray(data.chats)) await db.chats.bulkPut(data.chats);
                    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦æ—§ç‰ˆæœ¬æ•°æ®å…¼å®¹ä»£ç  â–¼â–¼â–¼
                    if (data.worldBooks && Array.isArray(data.worldBooks)) {
                        console.log("æ­£åœ¨æ£€æŸ¥ä¸–ç•Œä¹¦æ•°æ®æ ¼å¼ä»¥ç¡®ä¿å…¼å®¹æ€§...");
                        data.worldBooks.forEach(book => {
                            if (typeof book.content === 'string') {
                                console.log(`æ£€æµ‹åˆ°æ—§æ ¼å¼çš„ä¸–ç•Œä¹¦: "${book.name}"ï¼Œæ­£åœ¨è‡ªåŠ¨è¿ç§»...`);
                                const oldContentString = book.content;
                                book.content = [{
                                    keys: [], 
                                    comment: "ä»æ—§ç‰ˆæœ¬è‡ªåŠ¨è¿ç§»çš„æ¡ç›®",
                                    content: oldContentString,
                                    enabled: true 
                                }];
                            }
                        });
                    }
                    // â–²â–²â–² ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
                    if (Array.isArray(data.worldBooks)) await db.worldBooks.bulkPut(data.worldBooks);
                    if (Array.isArray(data.worldBookCategories)) await db.worldBookCategories.bulkPut(data.worldBookCategories);
                    if (Array.isArray(data.userStickers)) await db.userStickers.bulkPut(data.userStickers);
                    if (Array.isArray(data.personaPresets)) await db.personaPresets.bulkPut(data.personaPresets);
                    if (Array.isArray(data.qzonePosts)) await db.qzonePosts.bulkPut(data.qzonePosts);
                    if (Array.isArray(data.qzoneAlbums)) await db.qzoneAlbums.bulkPut(data.qzoneAlbums);
                    if (Array.isArray(data.qzonePhotos)) await db.qzonePhotos.bulkPut(data.qzonePhotos);
                    if (Array.isArray(data.favorites)) await db.favorites.bulkPut(data.favorites);
                    if (Array.isArray(data.qzoneGroups)) await db.qzoneGroups.bulkPut(data.qzoneGroups);
                    if (Array.isArray(data.memories)) await db.memories.bulkPut(data.memories);
                    if (Array.isArray(data.apiPresets)) await db.apiPresets.bulkPut(data.apiPresets);
                    if (Array.isArray(data.shoppingProducts)) await db.shoppingProducts.bulkPut(data.shoppingProducts);
                    if (Array.isArray(data.callRecords)) await db.callRecords.bulkPut(data.callRecords);
                    if (Array.isArray(data.renderingRules)) await db.renderingRules.bulkPut(data.renderingRules);
        
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
                    if (Array.isArray(data.doubanPosts)) await db.doubanPosts.bulkPut(data.doubanPosts);
                    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
                   if (Array.isArray(data.stickerCategories)) await db.stickerCategories.bulkPut(data.stickerCategories);
	   if (Array.isArray(data.appearancePresets)) await db.appearancePresets.bulkPut(data.appearancePresets);
                    if (Array.isArray(data.presets)) await db.presets.bulkPut(data.presets);                         // <-- ã€æœ¬æ¬¡æ–°å¢ä¿®å¤ã€‘
                    if (Array.isArray(data.presetCategories)) await db.presetCategories.bulkPut(data.presetCategories);
    if (Array.isArray(data.npcs)) await db.npcs.bulkPut(data.npcs);
                    if (data.apiConfig) await db.apiConfig.put(data.apiConfig);
                    if (data.globalSettings) await db.globalSettings.put(data.globalSettings);
                    if (data.musicLibrary) await db.musicLibrary.put(data.musicLibrary);
                    if (data.qzoneSettings) await db.qzoneSettings.put(data.qzoneSettings);
                });
        
                await showCustomAlert('å¯¼å…¥æˆåŠŸ', 'æ‰€æœ‰æ•°æ®å·²æˆåŠŸæ¢å¤ï¼åº”ç”¨å³å°†åˆ·æ–°ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
        
            } catch (error) {
                console.error("å¯¼å…¥æ•°æ®æ—¶å‡ºé”™:", error);
                await showCustomAlert('å¯¼å…¥å¤±è´¥', `æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–æ•°æ®å·²æŸå: ${error.message}`);
            }
        }
        
                function applyCustomFont(fontUrl, isPreviewOnly = false) {
                    if (!fontUrl) {
                        dynamicFontStyle.innerHTML = '';
                        document.getElementById('font-preview').style.fontFamily = '';
                        return;
                    }
                    const fontName = 'custom-user-font';
                    const newStyle = `
                        @font-face {
                          font-family: '${fontName}';
                          src: url('${fontUrl}');
                          font-display: swap;
                        }`;
                    if (isPreviewOnly) {
                        const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                        previewStyle.id = 'preview-font-style';
                        previewStyle.innerHTML = newStyle;
                        if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                        document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
                    } else {
                        dynamicFontStyle.innerHTML = `
                            ${newStyle}
                            body {
                              font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                            }`;
                    }
                }
        
                async function resetToDefaultFont() {
                    dynamicFontStyle.innerHTML = ''; 
                    state.globalSettings.fontUrl = '';
                    await db.globalSettings.put(state.globalSettings);
                    document.getElementById('font-url-input').value = '';
                    document.getElementById('font-preview').style.fontFamily = '';
                    alert('å·²æ¢å¤é»˜è®¤å­—ä½“ã€‚');
                }
        
// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå·²æ›´æ–°çš„ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ loadAllDataFromDB å‡½æ•° â–¼â–¼â–¼
async function loadAllDataFromDB() {
    const [
        chatsArr, apiConfig, loadedGlobalSettings, userStickers, worldBooks,
        musicLib, personaPresets, qzoneSettings, initialFavorites,
        allMemories,
        // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨è¿™é‡ŒåŠ è½½æ‰€æœ‰é¢„è®¾
        allPresets
    ] = await Promise.all([
        db.chats.toArray(), db.apiConfig.get('main'), db.globalSettings.get('main'),
        db.userStickers.toArray(), db.worldBooks.toArray(), db.musicLibrary.get('main'),
        db.personaPresets.toArray(), db.qzoneSettings.get('main'), db.favorites.orderBy('timestamp').reverse().toArray(),
        db.memories.toArray(),
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ä»æ•°æ®åº“è¯»å– presets è¡¨
        db.presets.toArray()
    ]);

    // ã€æ ¸å¿ƒæ–°å¢ã€‘å°†åŠ è½½çš„é¢„è®¾ä¿å­˜åˆ°å…¨å±€ state ä¸­
    state.presets = allPresets || [];

    // --- (åç»­æ‰€æœ‰çš„æ•°æ®å¤„ç†é€»è¾‘ä¿æŒä¸å˜) ---
    const defaultGlobalSettings = {
        id: 'main',
        showStatusBar: false,
        wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)',
        fontUrl: '',
        enableBackgroundActivity: false,
        backgroundActivityInterval: 60,
        blockCooldownHours: 1,
        appIcons: { ...DEFAULT_APP_ICONS },
        cphoneWallpaper: 'linear-gradient(135deg, #f6d365, #fda085)',
        cphoneAppIcons: { ...DEFAULT_CPHONE_ICONS },
        globalCss: '',
        notificationSoundUrl: '',
        widgetData: {},
        globalChatBackground: '',
        enableAiDrawing: true,
    chatActionButtonsOrder: null
    };
    state.globalSettings = { ...defaultGlobalSettings, ...(loadedGlobalSettings || {}) };
    state.globalSettings.appIcons = { ...defaultGlobalSettings.appIcons, ...(state.globalSettings.appIcons || {}) };
    state.globalSettings.cphoneAppIcons = { ...defaultGlobalSettings.cphoneAppIcons, ...(state.globalSettings.cphoneAppIcons || {}) };

    chatsArr.forEach(chat => {
            if (typeof chat.settings.enableTimePerception === 'undefined') {
                chat.settings.enableTimePerception = true;
            }
        if (!chat.settings.lyricsPosition) {
            chat.settings.lyricsPosition = { vertical: 'top', horizontal: 'center', offset: 10 };
        }
        if (!chat.isGroup && !chat.settings.myAvatarLibrary) {
            chat.settings.myAvatarLibrary = [];
        }
        if (!chat.isGroup && typeof chat.originalName === 'undefined') {
            chat.originalName = chat.name;
        }
    });
    state.chats = chatsArr.reduce((acc, chat) => {
        if (typeof chat.unreadCount === 'undefined') chat.unreadCount = 0;
        if (chat.isGroup) {
            if (typeof chat.settings.enableBackgroundActivity === 'undefined') {
                chat.settings.enableBackgroundActivity = true;
            }
            if (chat.members && chat.members.length > 0 && chat.members[0].name) {
                chat.members.forEach(member => {
                    if (typeof member.originalName === 'undefined') {
                        member.originalName = member.name;
                        member.groupNickname = member.name;
                        delete member.name;
                    }
                });
            }
        }
        if (!chat.settings) chat.settings = {};
        if (typeof chat.settings.actionCooldownMinutes === 'undefined') {
            chat.settings.actionCooldownMinutes = 10;
        }
        if (!chat.isGroup && !chat.status) chat.status = { text: 'åœ¨çº¿', lastUpdate: Date.now(), isBusy: false };
        if (!chat.isGroup && !chat.relationship) chat.relationship = { status: 'friend', blockedTimestamp: null, applicationReason: '' };
        if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) { if (!chat.settings) chat.settings = {}; chat.settings.aiAvatarLibrary = []; }
        if (chat.isGroup) { (chat.members || []).forEach(member => { if (typeof member.avatarFrame === 'undefined') member.avatarFrame = ''; }); }
        if (!chat.musicData) chat.musicData = { totalTime: 0 };
        if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) { chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId]; delete chat.settings.linkedWorldBookId; }
        if (typeof chat.isPinned === 'undefined') chat.isPinned = false;
        if (!chat.isGroup && typeof chat.settings.myNickname === 'undefined') {
            chat.settings.myNickname = 'æˆ‘';
        }
        if (chat.isGroup && chat.members) {
            let needsUpdate = false;
            chatsArr.forEach(c => {
                 if (c.id === chat.id && c.originalName) {
                    delete c.originalName;
                 }
            });
            chat.members.forEach(member => {
                const originalCharacter = chatsArr.find(c => c.id === member.id);
                if (originalCharacter && originalCharacter.settings) {
                    const correctFrame = originalCharacter.settings.aiAvatarFrame || '';
                    if (member.avatarFrame !== correctFrame) {
                        member.avatarFrame = correctFrame;
                        needsUpdate = true;
                    }
                } else if (typeof member.avatarFrame === 'undefined') {
                    member.avatarFrame = '';
                    needsUpdate = true;
                }
            });
            if (needsUpdate) db.chats.put(chat);
        }
        if (!chat.settings.enableAutoMemory) chat.settings.enableAutoMemory = false;
        if (!chat.settings.autoMemoryInterval) chat.settings.autoMemoryInterval = 20;
        if (!chat.longTermMemory) chat.longTermMemory = [];
        if (!chat.lastMemorySummaryTimestamp) chat.lastMemorySummaryTimestamp = 0;
        if (!chat.isGroup) {
            if (typeof chat.settings.enableBackgroundActivity === 'undefined') {
                chat.settings.enableBackgroundActivity = true;
            }
            if (!chat.status) chat.status = { text: 'åœ¨çº¿', lastUpdate: Date.now(), isBusy: false };
            if (!chat.relationship) chat.relationship = { status: 'friend', blockedTimestamp: null, applicationReason: '' };
            if (!chat.settings || !chat.settings.aiAvatarLibrary) { if (!chat.settings) chat.settings = {}; chat.settings.aiAvatarLibrary = []; }
            if (typeof chat.settings.isOfflineMode === 'undefined') chat.settings.isOfflineMode = false;
            if (typeof chat.settings.offlineMinLength === 'undefined') chat.settings.offlineMinLength = 100;
            if (typeof chat.settings.offlineMaxLength === 'undefined') chat.settings.offlineMaxLength = 300;
            if (typeof chat.heartfeltVoice === 'undefined') chat.heartfeltVoice = '...';
            if (typeof chat.randomJottings === 'undefined') chat.randomJottings = '...';
            if (!Array.isArray(chat.thoughtsHistory)) {
                chat.thoughtsHistory = [];
            }
        }
        acc[chat.id] = chat;
        return acc;
    }, {});
    const memoriesToUpdate = [];
    allMemories.forEach(memory => {
        if (memory.type === 'ai_generated' && memory.authorName && !memory.authorId) {
            const foundChat = chatsArr.find(c => !c.isGroup && c.originalName === memory.authorName);
            if (foundChat) {
                memory.authorId = foundChat.id;
                memoriesToUpdate.push(memory);
            } else {
                 const fallbackChat = chatsArr.find(c => !c.isGroup && c.name === memory.authorName);
                 if(fallbackChat) {
                    memory.authorId = fallbackChat.id;
                    memoriesToUpdate.push(memory);
                 }
            }
        }
    });
    if (memoriesToUpdate.length > 0) {
        await db.memories.bulkPut(memoriesToUpdate);
    }
    state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '', secondaryProxyUrl: '', secondaryApiKey: '', secondaryModel: '' };
    state.userStickers = userStickers || [];
    state.worldBooks = worldBooks || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
    state.qzoneSettings = qzoneSettings || { id: 'main', nickname: '{{user}}', avatar: 'https://files.catbox.moe/q6z5fc.jpeg', banner: 'https://files.catbox.moe/r5heyt.gif' };
    allFavoriteItems = initialFavorites || [];
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
                async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }
        
                function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }
        
         // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·ç”¨è¿™ä¸ªæ›´å¯é çš„ç‰ˆæœ¬ï¼Œæ›¿æ¢æ—§çš„ showNotification å‡½æ•° â–¼â–¼â–¼
        function showNotification(chatId, messageContent) {
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
    playNotificationSound();
    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
            clearTimeout(notificationTimeout);
            const chat = state.chats[chatId];
            if (!chat) return;
        
            // 1. è·å–é€šçŸ¥æ å…ƒç´ 
            const bar = document.getElementById('notification-bar');
            
            // 2. å¡«å……å†…å®¹
            document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar;
            document.getElementById('notification-content').querySelector('.name').textContent = chat.name;
            document.getElementById('notification-content').querySelector('.message').textContent = messageContent;
            
            // 3. ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨â€œå¼ºåˆ¶é‡æ’â€æŠ€å·§ï¼Œç¡®ä¿åŠ¨ç”»æ¯æ¬¡éƒ½èƒ½è§¦å‘
            // å…ˆç§»é™¤classï¼Œè®©å®ƒå›åˆ°åˆå§‹çš„â€œéšè—â€çŠ¶æ€
            bar.classList.remove('visible');
            
            // è¿™ä¸€è¡Œæ˜¯å…³é”®ï¼å®ƒä¼šå¼ºåˆ¶æµè§ˆå™¨é‡æ–°è®¡ç®—å…ƒç´ å¸ƒå±€ï¼Œä»è€Œâ€œé‡ç½®â€åŠ¨ç”»çŠ¶æ€ã€‚
            void bar.offsetWidth; 
            
            // å†æ¬¡æ·»åŠ classï¼Œæµè§ˆå™¨ä¼šè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæ–°çš„çŠ¶æ€å˜åŒ–ï¼Œä»è€Œå¹³æ»‘åœ°æ‰§è¡ŒCSSè¿‡æ¸¡åŠ¨ç”»ã€‚
            bar.classList.add('visible');
            
            // 4. ä¸ºé€šçŸ¥æ ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§æ¸…é™¤æ—§ç›‘å¬å™¨ï¼‰
            const newBar = bar.cloneNode(true);
            bar.parentNode.replaceChild(newBar, bar);
            newBar.addEventListener('click', () => {
                openChat(chatId);
                newBar.classList.remove('visible');
            });
        
            // 5. è®¾ç½®å®šæ—¶å™¨ï¼Œåœ¨4ç§’åè‡ªåŠ¨éšè—é€šçŸ¥
            notificationTimeout = setTimeout(() => {
                newBar.classList.remove('visible');
            }, 4000);
        }
        
               function updateClock() { 
    const now = new Date(); 
    const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); 
    const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); 
    
    // document.getElementById('main-time').textContent = timeString; // æ³¨é‡Šæ‰è¿™è¡Œ
    document.getElementById('status-bar-time').textContent = timeString; 
    // document.getElementById('main-date').textContent = dateString; // æ³¨é‡Šæ‰è¿™è¡Œ
}
        
        
        /**
         * ã€ç»ˆæå¥å£®ç‰ˆã€‘è§£æAIè¿”å›çš„ã€å¯èƒ½æ ¼å¼ä¸è§„èŒƒçš„å“åº”å†…å®¹
         * @param {string} content - AIè¿”å›çš„åŸå§‹å­—ç¬¦ä¸²
         * @returns {Array} - ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ¶ˆæ¯å¯¹è±¡æ•°ç»„
         */
        function parseAiResponse(content) {
            const trimmedContent = content.trim();
        
            // æ–¹æ¡ˆ1ï¼šã€æœ€ä¼˜å…ˆã€‘å°è¯•ä½œä¸ºæ ‡å‡†çš„ã€å•ä¸€çš„JSONæ•°ç»„è§£æ
            // è¿™æ˜¯æœ€ç†æƒ³ã€æœ€é«˜æ•ˆçš„æƒ…å†µ
            if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
                try {
                    const parsed = JSON.parse(trimmedContent);
                    if (Array.isArray(parsed)) {
                        console.log("è§£ææˆåŠŸï¼šæ ‡å‡†JSONæ•°ç»„æ ¼å¼ã€‚");
                        return parsed;
                    }
                } catch (e) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œè¯´æ˜å®ƒè™½ç„¶çœ‹èµ·æ¥åƒä¸ªæ•°ç»„ï¼Œä½†å†…éƒ¨æ ¼å¼æœ‰é—®é¢˜ã€‚
                    // æ­¤æ—¶æˆ‘ä»¬ä¸æŠ¥é”™ï¼Œè€Œæ˜¯ç»§ç»­å°è¯•ä¸‹é¢çš„â€œå¼ºåŠ›è§£æâ€æ–¹æ¡ˆã€‚
                    console.warn("æ ‡å‡†JSONæ•°ç»„è§£æå¤±è´¥ï¼Œå°†å°è¯•å¼ºåŠ›è§£æ...");
                }
            }
        
            // æ–¹æ¡ˆ2ï¼šã€å¼ºåŠ›è§£æã€‘ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œä»æ··ä¹±çš„å­—ç¬¦ä¸²ä¸­æå–å‡ºæ‰€æœ‰ç‹¬ç«‹çš„JSONå¯¹è±¡
            // è¿™èƒ½å®Œç¾è§£å†³æ‚¨é‡åˆ°çš„ "(Timestamp: ...)[{...}](Timestamp: ...)[{...}]" è¿™ç§æ ¼å¼
            const jsonMatches = trimmedContent.match(/{[^{}]*}/g);
        
            if (jsonMatches) {
                const results = [];
                for (const match of jsonMatches) {
                    try {
                        // å°è¯•è§£ææ¯ä¸€ä¸ªè¢«æˆ‘ä»¬â€œæªâ€å‡ºæ¥çš„JSONå­—ç¬¦ä¸²
                        const parsedObject = JSON.parse(match);
                        results.push(parsedObject);
                    } catch (e) {
                        // å¦‚æœæŸä¸ªç‰‡æ®µä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œå°±å¿½ç•¥å®ƒï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª
                        console.warn("è·³è¿‡ä¸€ä¸ªæ— æ•ˆçš„JSONç‰‡æ®µ:", match);
                    }
                }
        
                // å¦‚æœæˆ‘ä»¬æˆåŠŸæå–å‡ºäº†è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆçš„JSONå¯¹è±¡ï¼Œå°±è¿”å›è¿™ä¸ªç»“æœ
                if (results.length > 0) {
                    console.log("è§£ææˆåŠŸï¼šé€šè¿‡å¼ºåŠ›æå–æ¨¡å¼ã€‚");
                    return results;
                }
            }
            
            // æ–¹æ¡ˆ3ï¼šã€æœ€ç»ˆå¤‡ç”¨ã€‘å¦‚æœä»¥ä¸Šæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥äº†ï¼Œè¯´æ˜AIè¿”å›çš„å¯èƒ½å°±æ˜¯çº¯æ–‡æœ¬
            // æˆ‘ä»¬å°†åŸå§‹çš„ã€æœªå¤„ç†çš„å†…å®¹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ ‡å‡†çš„æ–‡æœ¬æ¶ˆæ¯å¯¹è±¡è¿”å›ï¼Œç¡®ä¿ç¨‹åºä¸ä¼šå´©æºƒ
            console.error("æ‰€æœ‰è§£ææ–¹æ¡ˆå‡å¤±è´¥ï¼å°†è¿”å›åŸå§‹æ–‡æœ¬ã€‚");
            return [{ type: 'text', content: content }];
        }
        /**
         * ã€å…¨æ–°ã€‘æ ¹æ®å½“å‰æ—¶é—´è·å–ä¸€å¤©ä¸­çš„é—®å€™è¯­
         * @returns {string} - è¿”å›å¦‚ "å‡Œæ™¨", "æ—©ä¸Š", "ä¸‹åˆ", "æ™šä¸Š" ç­‰å­—ç¬¦ä¸²
         */
        function getTimeOfDayGreeting(date = new Date()) { // å…è®¸ä¼ å…¥ä¸€ä¸ªæ—¥æœŸå¯¹è±¡
            const hour = date.getHours(); // ä½¿ç”¨ä¼ å…¥çš„æ—¥æœŸå¯¹è±¡æ¥è·å–å°æ—¶
            if (hour >= 0 && hour < 5) {
                return "å‡Œæ™¨";
            } else if (hour >= 5 && hour < 9) {
                return "æ—©ä¸Š";
            } else if (hour >= 9 && hour < 13) {
                return "ä¸Šåˆ";
            } else if (hour >= 13 && hour < 18) {
                return "ä¸‹åˆ";
            } else if (hour >= 18 && hour < 24) {
                return "æ™šä¸Š";
            }
            return "ç°åœ¨"; // é»˜è®¤æƒ…å†µ
        }
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘APIé¢„è®¾åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
        
        /**
         * ä»æ•°æ®åº“åŠ è½½APIé¢„è®¾ï¼Œå¹¶å¡«å……åˆ°ä¸‹æ‹‰é€‰æ‹©æ¡†ä¸­
         */
        async function loadApiPresetsDropdown() {
            const selectEl = document.getElementById('api-preset-select');
            selectEl.innerHTML = '<option value="current">å½“å‰é…ç½® (æœªä¿å­˜)</option>';
            
            const presets = await db.apiPresets.toArray();
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                selectEl.appendChild(option);
            });
        
            // æ£€æŸ¥å½“å‰é…ç½®æ˜¯å¦ä¸æŸä¸ªé¢„è®¾å®Œå…¨åŒ¹é…
            const currentConfig = state.apiConfig;
            let matchingPresetId = null;
            for (const preset of presets) {
                if (
                    preset.proxyUrl === currentConfig.proxyUrl &&
                    preset.apiKey === currentConfig.apiKey &&
                    preset.model === currentConfig.model &&
                    preset.secondaryProxyUrl === currentConfig.secondaryProxyUrl &&
                    preset.secondaryApiKey === currentConfig.secondaryApiKey &&
                    preset.secondaryModel === currentConfig.secondaryModel
                ) {
                    matchingPresetId = preset.id;
                    break;
                }
            }
        
            if (matchingPresetId) {
                selectEl.value = matchingPresetId;
            } else {
                selectEl.value = 'current';
            }
        }
        
        /**
         * å½“ç”¨æˆ·ä»ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ—¶ï¼ŒåŠ è½½è¯¥é¢„è®¾çš„é…ç½®
         */
        async function handlePresetSelectionChange() {
            const selectEl = document.getElementById('api-preset-select');
            const selectedId = parseInt(selectEl.value);
        
            // å¦‚æœé€‰æ‹©çš„æ˜¯â€œå½“å‰é…ç½®â€ï¼Œåˆ™ä¸åšä»»ä½•äº‹
            if (isNaN(selectedId)) {
                return;
            }
        
            const preset = await db.apiPresets.get(selectedId);
            if (preset) {
                // å°†é¢„è®¾çš„é…ç½®åŠ è½½åˆ°å½“å‰çš„å…¨å±€çŠ¶æ€ä¸­
                state.apiConfig = {
                    id: 'main',
                    proxyUrl: preset.proxyUrl,
                    apiKey: preset.apiKey,
                    model: preset.model,
                    secondaryProxyUrl: preset.secondaryProxyUrl,
                    secondaryApiKey: preset.secondaryApiKey,
                    secondaryModel: preset.secondaryModel
                };
                // å°†åŠ è½½çš„é…ç½®ä¿å­˜ä¸ºå½“å‰æ­£åœ¨ä½¿ç”¨çš„é…ç½®
                await db.apiConfig.put(state.apiConfig);
                // é‡æ–°æ¸²æŸ“æ•´ä¸ªè®¾ç½®é¡µé¢ä»¥æ˜¾ç¤ºæ–°åŠ è½½çš„é…ç½®
                renderApiSettings();
                // è‡ªåŠ¨ä¸ºæ–°åŠ è½½çš„é…ç½®æ‹‰å–æ¨¡å‹åˆ—è¡¨
                document.getElementById('fetch-models-btn').click();
                if (preset.secondaryProxyUrl && preset.secondaryApiKey) {
                    document.getElementById('fetch-secondary-models-btn').click();
                }
                alert(`å·²åŠ è½½é¢„è®¾ â€œ${preset.name}â€`);
            }
        }
        
        /**
         * å°†å½“å‰è¾“å…¥æ¡†ä¸­çš„é…ç½®ä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
         */
        async function saveApiPreset() {
            const name = await showCustomPrompt('ä¿å­˜ API é¢„è®¾', 'è¯·è¾“å…¥é¢„è®¾åç§°');
            if (!name || !name.trim()) return;
        
            // ä»è¾“å…¥æ¡†è¯»å–å½“å‰é…ç½®
            const presetData = {
                name: name.trim(),
                proxyUrl: document.getElementById('proxy-url').value.trim(),
                apiKey: document.getElementById('api-key').value.trim(),
                model: document.getElementById('model-select').value,
                secondaryProxyUrl: document.getElementById('secondary-proxy-url').value.trim(),
                secondaryApiKey: document.getElementById('secondary-api-key').value.trim(),
                secondaryModel: document.getElementById('secondary-model-select').value
            };
        
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåé¢„è®¾
            const existingPreset = await db.apiPresets.where('name').equals(presetData.name).first();
            if (existingPreset) {
                const confirmed = await showCustomConfirm('è¦†ç›–é¢„è®¾', `åä¸º â€œ${presetData.name}â€ çš„é¢„è®¾å·²å­˜åœ¨ã€‚è¦è¦†ç›–å®ƒå—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                if (!confirmed) return;
                presetData.id = existingPreset.id; // æŒ‡å®šIDä»¥è¦†ç›–æ—§æ•°æ®
            }
        
            await db.apiPresets.put(presetData);
            await loadApiPresetsDropdown(); // åˆ·æ–°ä¸‹æ‹‰åˆ—è¡¨
            alert('API é¢„è®¾å·²ä¿å­˜ï¼');
        }
        
        /**
         * åˆ é™¤å½“å‰é€‰ä¸­çš„é¢„è®¾
         */
        async function deleteApiPreset() {
            const selectEl = document.getElementById('api-preset-select');
            const selectedId = parseInt(selectEl.value);
        
            if (isNaN(selectedId)) {
                alert('è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾ã€‚');
                return;
            }
        
            const preset = await db.apiPresets.get(selectedId);
            if (!preset) return;
        
            const confirmed = await showCustomConfirm('åˆ é™¤é¢„è®¾', `ç¡®å®šè¦åˆ é™¤é¢„è®¾ â€œ${preset.name}â€ å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.apiPresets.delete(selectedId);
                await loadApiPresetsDropdown(); // åˆ·æ–°ä¸‹æ‹‰åˆ—è¡¨
                alert('é¢„è®¾å·²åˆ é™¤ã€‚');
            }
        }
        // â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderApiSettings å‡½æ•° â–¼â–¼â–¼
        function renderApiSettings() { 
            // 1. æ¸²æŸ“å½“å‰é…ç½®åˆ°è¾“å…¥æ¡†
            document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; 
            document.getElementById('api-key').value = state.apiConfig.apiKey || ''; 
            document.getElementById('secondary-proxy-url').value = state.apiConfig.secondaryProxyUrl || '';
            document.getElementById('secondary-api-key').value = state.apiConfig.secondaryApiKey || '';
            document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;
            document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
            document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;
            document.getElementById('enable-ai-drawing-switch').checked = state.globalSettings.enableAiDrawing;        
            // 2. ã€æ ¸å¿ƒæ–°å¢ã€‘åŠ è½½å¹¶æ¸²æŸ“é¢„è®¾ä¸‹æ‹‰èœå•
            loadApiPresetsDropdown();
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
                window.renderApiSettingsProxy = renderApiSettings;
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯NPCç®¡ç†åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç ã€‘ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ | å·²ä¿®å¤é•¿æŒ‰äº‹ä»¶ã€‘æ¸²æŸ“NPCåˆ—è¡¨å±å¹•
 */
async function renderNpcListScreen() {
    const listEl = document.getElementById('npc-list');
    listEl.innerHTML = '';
    
    const npcs = await db.npcs.toArray();

    if (npcs.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•NPCï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’â€œ+â€æ·»åŠ ç¬¬ä¸€ä¸ªå§ï¼</p>';
        return;
    }

    npcs.forEach(npc => {
        const item = document.createElement('div');
        item.className = 'chat-list-item';
        item.dataset.npcId = npc.id;
        
        item.innerHTML = `
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar" style="border-radius: 50%;">
            <div class="info">
                <div class="name-line">
                    <span class="name">${npc.name}</span>
                </div>
                <div class="last-msg">${npc.persona.substring(0, 30)}...</div>
            </div>
        `;
        
        item.addEventListener('click', () => openNpcEditor(npc.id));
        
        // ã€æ ¸å¿ƒä¿®å¤ã€‘ç¡®ä¿ addLongPressListener çš„å›è°ƒå‡½æ•°æ˜¯ async å‡½æ•°
        addLongPressListener(item, async () => {
            await deleteNpc(npc.id);
        });
        
        listEl.appendChild(item);
    });
}

/**
         * ã€å·²æ›´æ–°ã€‘æ‰“å¼€NPCç¼–è¾‘å™¨ï¼ˆç”¨äºæ–°å»ºæˆ–ç¼–è¾‘ï¼‰
         * @param {number|null} npcId - å¦‚æœæ˜¯ç¼–è¾‘ï¼Œåˆ™ä¼ å…¥IDï¼›å¦‚æœæ˜¯æ–°å»ºï¼Œåˆ™ä¸ºnull
         */
        async function openNpcEditor(npcId = null) {
            editingNpcId = npcId;
            const modal = document.getElementById('npc-editor-modal');
            const titleEl = document.getElementById('npc-editor-title');
            const nameInput = document.getElementById('npc-name-input');
            const personaInput = document.getElementById('npc-persona-input');
            const avatarPreview = document.getElementById('npc-avatar-preview');
            const associationListEl = document.getElementById('npc-association-list');
            
            // ã€æ ¸å¿ƒæ–°å¢ã€‘è·å–æ–°æ·»åŠ çš„å¼€å…³å’Œè¾“å…¥æ¡†å…ƒç´ 
            const activitySwitch = document.getElementById('npc-background-activity-switch');
            const cooldownInput = document.getElementById('npc-action-cooldown-input');
            
            associationListEl.innerHTML = ''; // æ¸…ç©ºæ—§çš„å…³è”åˆ—è¡¨

            // ç”Ÿæˆå¯å…³è”çš„è§’è‰²åˆ—è¡¨ (é€»è¾‘ä¸å˜)
            associationListEl.innerHTML += `<label><input type="checkbox" value="user"> ${state.qzoneSettings.nickname || 'æˆ‘'} (ç”¨æˆ·)</label>`;
            Object.values(state.chats).filter(c => !c.isGroup).forEach(char => {
                associationListEl.innerHTML += `<label><input type="checkbox" value="${char.id}"> ${char.name} (è§’è‰²)</label>`;
            });

            if (npcId) {
                // ç¼–è¾‘æ¨¡å¼
                titleEl.textContent = 'ç¼–è¾‘ NPC';
                const npc = await db.npcs.get(npcId);
                if (npc) {
                    nameInput.value = npc.name;
                    personaInput.value = npc.persona;
                    avatarPreview.src = npc.avatar || defaultGroupMemberAvatar;

                    // ã€æ ¸å¿ƒæ–°å¢ã€‘è¯»å–å¹¶åº”ç”¨å·²ä¿å­˜çš„è®¾ç½®
                    // ä½¿ç”¨ !== false åˆ¤æ–­ï¼Œç¡®ä¿æ–°åˆ›å»ºçš„ã€æ²¡æœ‰è¯¥å­—æ®µçš„NPCé»˜è®¤ä¸ºå¼€å¯
                    activitySwitch.checked = npc.enableBackgroundActivity !== false; 
                    cooldownInput.value = npc.actionCooldownMinutes || 15;

                    if (npc.associatedWith && Array.isArray(npc.associatedWith)) {
                        npc.associatedWith.forEach(id => {
                            const checkbox = associationListEl.querySelector(`input[value="${id}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            } else {
                // æ–°å»ºæ¨¡å¼
                titleEl.textContent = 'æ·»åŠ  NPC';
                nameInput.value = '';
                personaInput.value = '';
                avatarPreview.src = defaultGroupMemberAvatar;

                // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¸ºæ–°NPCè®¾ç½®é»˜è®¤å€¼
                activitySwitch.checked = true; // é»˜è®¤å¼€å¯
                cooldownInput.value = 15;     // é»˜è®¤15åˆ†é’Ÿ

                const userCheckbox = associationListEl.querySelector('input[value="user"]');
                if (userCheckbox) userCheckbox.checked = true;
            }

            modal.classList.add('visible');
        }

        /**
         * ã€å·²æ›´æ–°ã€‘ä¿å­˜NPCä¿¡æ¯
         */
        async function saveNpc() {
            const name = document.getElementById('npc-name-input').value.trim();
            const persona = document.getElementById('npc-persona-input').value.trim();
            if (!name || !persona) {
                alert("NPCçš„æ˜µç§°å’Œäººè®¾éƒ½ä¸èƒ½ä¸ºç©ºï¼");
                return;
            }

            const selectedAssociations = Array.from(document.querySelectorAll('#npc-association-list input:checked')).map(cb => cb.value);

            // ã€æ ¸å¿ƒæ–°å¢ã€‘ä»è¡¨å•ä¸­è·å–æ–°è®¾ç½®çš„å€¼
            const enableBackgroundActivity = document.getElementById('npc-background-activity-switch').checked;
            const actionCooldownMinutes = parseInt(document.getElementById('npc-action-cooldown-input').value) || 15;

            // ã€æ ¸å¿ƒæ–°å¢ã€‘å°†æ–°è®¾ç½®æ·»åŠ åˆ°è¦ä¿å­˜çš„æ•°æ®å¯¹è±¡ä¸­
            const npcData = {
                name,
                persona,
                avatar: document.getElementById('npc-avatar-preview').src,
                associatedWith: selectedAssociations,
                enableBackgroundActivity: enableBackgroundActivity,
                actionCooldownMinutes: actionCooldownMinutes
            };

            if (editingNpcId) {
                // æ›´æ–°æ—¶ï¼Œä¸ä¼šè¦†ç›– lastActionTimestamp å­—æ®µï¼Œè¿™å¾ˆé‡è¦
                await db.npcs.update(editingNpcId, npcData);
            } else {
                await db.npcs.add(npcData);
            }

            document.getElementById('npc-editor-modal').classList.remove('visible');
            await renderNpcListScreen();
        }

/**
 * åˆ é™¤NPC
 * @param {number} npcId - è¦åˆ é™¤çš„NPCçš„ID
 */
async function deleteNpc(npcId) {
    const npc = await db.npcs.get(npcId);
    if (!npc) return;
    const confirmed = await showCustomConfirm('åˆ é™¤NPC', `ç¡®å®šè¦åˆ é™¤NPC â€œ${npc.name}â€ å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.npcs.delete(npcId);
        await renderNpcListScreen();
    }
}
// â–²â–²â–² å…¨æ–°JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²        
// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå·²å‡çº§â€œåˆ†æ‰¹åŠ è½½â€åŠŸèƒ½çš„å…¨æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderChatList å‡½æ•° â–¼â–¼â–¼
        let chatListRenderCount = 0; // æ–°å¢ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œè·Ÿè¸ªå·²æ¸²æŸ“çš„æ•°é‡
        const CHAT_LIST_RENDER_WINDOW = 30; // æ¯æ¬¡åŠ è½½30æ¡

        async function renderChatList() {
            const chatListEl = document.getElementById('chat-list');
            chatListEl.innerHTML = '';
        
            // 1. è·å–å¹¶æ’åºæ‰€æœ‰èŠå¤©æ•°æ®ï¼ˆè¿™éƒ¨åˆ†é€»è¾‘ä¸å˜ï¼‰
            const allChats = Object.values(state.chats).sort((a, b) => {
                const pinDiff = (b.isPinned || false) - (a.isPinned || false);
                if (pinDiff !== 0) return pinDiff;
                return (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0);
            });
            
            const allGroups = await db.qzoneGroups.toArray();
        
            if (allChats.length === 0) {
                chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" æˆ–ç¾¤ç»„å›¾æ ‡æ·»åŠ èŠå¤©</p>';
                return;
            }
        
            allGroups.forEach(group => {
                const latestChatInGroup = allChats.find(chat => chat.groupId === group.id);
                group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
            });
            allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
            
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†æ’åºåçš„æ‰€æœ‰èŠå¤©é¡¹ï¼ˆåŒ…æ‹¬åˆ†ç»„å’Œéåˆ†ç»„ï¼‰åˆå¹¶åˆ°ä¸€ä¸ªæœ‰åºæ•°ç»„ä¸­
            const sortedRenderableItems = [];
            const processedChatIds = new Set();

            allGroups.forEach(group => {
                const groupChats = allChats.filter(chat => !chat.isGroup && chat.groupId === group.id);
                if (groupChats.length > 0) {
                    sortedRenderableItems.push({ type: 'groupHeader', group });
                    groupChats.forEach(chat => {
                        sortedRenderableItems.push({ type: 'chatItem', chat });
                        processedChatIds.add(chat.id);
                    });
                }
            });

            allChats.forEach(chat => {
                if (!processedChatIds.has(chat.id)) {
                    sortedRenderableItems.push({ type: 'chatItem', chat });
                }
            });

            // 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªæ¸²æŸ“ç¬¬ä¸€æ‰¹æ¬¡çš„èŠå¤©é¡¹
            const initialItems = sortedRenderableItems.slice(0, CHAT_LIST_RENDER_WINDOW);
            chatListRenderCount = 0;

            const fragment = document.createDocumentFragment();
            let currentGroupContent = null;

            initialItems.forEach(item => {
                if (item.type === 'groupHeader') {
                    const groupContainer = createChatGroupContainer(item.group);
                    fragment.appendChild(groupContainer);
                    currentGroupContent = groupContainer.querySelector('.chat-group-content');
                } else if (item.type === 'chatItem') {
                    const listItem = createChatListItem(item.chat);
                    if (currentGroupContent && item.chat.groupId) {
                        currentGroupContent.appendChild(listItem);
                    } else {
                        fragment.appendChild(listItem);
                        currentGroupContent = null;
                    }
                }
            });
            chatListEl.appendChild(fragment);
            chatListRenderCount = initialItems.length;

            // 3. ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¦‚æœè¿˜æœ‰æ›´å¤šï¼Œåˆ™æ·»åŠ â€œåŠ è½½æ›´å¤šâ€æŒ‰é’®
            if (sortedRenderableItems.length > chatListRenderCount) {
                appendLoadMoreChatsButton(chatListEl, sortedRenderableItems);
            }
            
            // ä¸ºæ‰€æœ‰æ–°æ¸²æŸ“çš„åˆ†ç»„æ ‡é¢˜æ·»åŠ æŠ˜å äº‹ä»¶
            document.querySelectorAll('.chat-group-header').forEach(header => {
                // (ä¸ºé¿å…é‡å¤ç»‘å®šï¼Œå…ˆç§»é™¤æ—§çš„)
                const newHeader = header.cloneNode(true);
                header.parentNode.replaceChild(newHeader, header);
                newHeader.addEventListener('click', () => {
                    newHeader.classList.toggle('collapsed');
                    newHeader.nextElementSibling.classList.toggle('collapsed');
                });
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œåˆ†æ‰¹åŠ è½½â€æ–°å¢çš„æ‰€æœ‰è¾…åŠ©å‡½æ•° â–¼â–¼â–¼

        /**
         * åˆ›å»ºä¸€ä¸ªåˆ†ç»„çš„å®¹å™¨ï¼ˆä¸åŒ…å«èŠå¤©é¡¹ï¼‰
         */
        function createChatGroupContainer(group) {
            const groupContainer = document.createElement('div');
            groupContainer.className = 'chat-group-container';
            groupContainer.innerHTML = `
                <div class="chat-group-header">
                    <span class="arrow">â–¼</span>
                    <span class="group-name">${group.name}</span>
                </div>
                <div class="chat-group-content"></div>
            `;
            return groupContainer;
        }

        /**
         * åˆ›å»ºå¹¶æ·»åŠ â€œåŠ è½½æ›´å¤šâ€æŒ‰é’®
         */
        function appendLoadMoreChatsButton(container, sortedItems) {
            const button = document.createElement('button');
            button.id = 'load-more-chats-btn';
            button.textContent = 'åŠ è½½æ›´æ—©çš„ä¼šè¯';
            button.className = 'load-more-btn'; // å¤ç”¨æ ·å¼
            
            // ã€é‡è¦ã€‘ä¸ºæŒ‰é’®ç»‘å®šåŠ è½½ä¸‹ä¸€é¡µçš„äº‹ä»¶
            button.addEventListener('click', () => loadMoreChats(sortedItems), { once: true });
            
            container.prepend(button); // å°†æŒ‰é’®æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
        }

        /**
         * åŠ è½½å¹¶æ¸²æŸ“ä¸‹ä¸€æ‰¹æ¬¡çš„èŠå¤©è®°å½•
         */
        function loadMoreChats(sortedItems) {
            const chatListEl = document.getElementById('chat-list');
            const loadMoreBtn = document.getElementById('load-more-chats-btn');
            if (loadMoreBtn) loadMoreBtn.remove();
            
            const nextSliceStart = chatListRenderCount;
            const nextSliceEnd = chatListRenderCount + CHAT_LIST_RENDER_WINDOW;
            const itemsToAppend = sortedItems.slice(nextSliceStart, nextSliceEnd);

            // ä½¿ç”¨ DocumentFragment æé«˜æ€§èƒ½
            const fragment = document.createDocumentFragment();
            let currentGroupContent = chatListEl.querySelector('.chat-group-content:last-of-type');

            itemsToAppend.forEach(item => {
                if (item.type === 'groupHeader') {
                    const groupContainer = createChatGroupContainer(item.group);
                    fragment.appendChild(groupContainer);
                    currentGroupContent = groupContainer.querySelector('.chat-group-content');
                } else if (item.type === 'chatItem') {
                    const listItem = createChatListItem(item.chat);
                    if (currentGroupContent && item.chat.groupId) {
                        currentGroupContent.appendChild(listItem);
                    } else {
                        fragment.appendChild(listItem);
                        currentGroupContent = null;
                    }
                }
            });
            
            // å°†æ–°ç”Ÿæˆçš„é¡¹ä¸€æ¬¡æ€§æ·»åŠ åˆ°åˆ—è¡¨ä¸­
            chatListEl.appendChild(fragment);
            chatListRenderCount += itemsToAppend.length;

            if (sortedItems.length > chatListRenderCount) {
                appendLoadMoreChatsButton(chatListEl, sortedItems);
            }
            
            // é‡æ–°ä¸ºæ‰€æœ‰åˆ†ç»„æ ‡é¢˜ç»‘å®šäº‹ä»¶
            document.querySelectorAll('.chat-group-header').forEach(header => {
                const newHeader = header.cloneNode(true);
                header.parentNode.replaceChild(newHeader, header);
                newHeader.addEventListener('click', () => {
                    newHeader.classList.toggle('collapsed');
                    newHeader.nextElementSibling.classList.toggle('collapsed');
                });
            });
        }
        // â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²å‡çº§HTMLç»“æ„å¹¶ä¿®å¤ç‚¹å‡»é—®é¢˜ã€‘çš„å…¨æ–°ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢æ‚¨ç°æœ‰çš„ createChatListItem å‡½æ•° â–¼â–¼â–¼
        function createChatListItem(chat) {
            const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
            let lastMsgDisplay;
        
            if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
                lastMsgDisplay = `<span style="color: #ff8c00;">[å¥½å‹ç”³è¯·] ${chat.relationship.applicationReason || 'è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹'}</span>`;
            }
            else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
                lastMsgDisplay = `<span style="color: #dc3545;">[ä½ å·²è¢«å¯¹æ–¹æ‹‰é»‘]</span>`;
            }
           // åœ¨ createChatListItem å‡½æ•°ä¸­...
        // â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ä¸€æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„ if(chat.isGroup) {...} else {...} åˆ¤æ–­ â–¼â–¼â–¼
        if (chat.isGroup) {
            if (lastMsgObj.type === 'pat_message') { lastMsgDisplay = `[ç³»ç»Ÿæ¶ˆæ¯] ${lastMsgObj.content}`; }
            else if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[è½¬è´¦]'; }
            else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ç…§ç‰‡]'; }
            else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[è¯­éŸ³]'; }
            else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[è¡¨æƒ…: ${lastMsgObj.meaning}]` : '[è¡¨æƒ…]'; }
            else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[å›¾ç‰‡]`; }
            else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); }
        
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ ¹æ®AIçš„æœ¬å(senderName)æ‰¾åˆ°å®ƒåœ¨ç¾¤é‡Œçš„æ˜µç§°(groupNickname)
            if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
                const senderMember = chat.members.find(m => m.originalName === lastMsgObj.senderName);
                const senderDisplayName = senderMember ? senderMember.groupNickname : lastMsgObj.senderName;
                lastMsgDisplay = `${senderDisplayName}: ${lastMsgDisplay}`;
            }
        } else {
            // å•èŠçš„é€»è¾‘ä¿æŒä¸å˜
            const statusText = chat.status?.text || 'åœ¨çº¿';
            lastMsgDisplay = `[${statusText}]`;
        }
        
            const item = document.createElement('div');
            item.className = 'chat-list-item';
            item.dataset.chatId = chat.id;
            if (chat.isPinned) {
                item.classList.add('pinned');
            }
        
            // â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹æ˜¯æ ¸å¿ƒä¿®æ”¹ï¼šä¸ºèŠå¤©åˆ—è¡¨ä¹Ÿç”Ÿæˆå¸¦æ¡†å¤´åƒçš„HTMLç»“æ„ â–¼â–¼â–¼
            const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
            // ç¾¤èŠåˆ—è¡¨é¡¹æš‚æ—¶ä¸æ˜¾ç¤ºå¤´åƒæ¡†ï¼Œåªä¸ºå•èŠæ˜¾ç¤º
            const avatarFrameSrc = chat.isGroup ? '' : (chat.settings.aiAvatarFrame || '');
        
            let avatarHtml;
            if (avatarFrameSrc) {
                avatarHtml = `
                    <div class="avatar-with-frame">
                        <img src="${avatar || defaultAvatar}" class="avatar-img">
                        <img src="${avatarFrameSrc}" class="avatar-frame">
                    </div>
                `;
            } else {
                // æ³¨æ„ï¼šè¿™é‡Œçš„ class ä¾ç„¶æ˜¯ 'avatar'ï¼Œä»¥å…¼å®¹æ—§çš„CSSæ ·å¼
                avatarHtml = `<img src="${avatar || defaultAvatar}" class="avatar">`;
            }
        
            const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
            // ä½¿ç”¨ä¸èŠå¤©ç•Œé¢ä¸€è‡´çš„ .avatar-group å®¹å™¨
            const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;
            // â–²â–²â–² HTMLç»“æ„å‡çº§ç»“æŸ â–²â–²â–²
        
            item.innerHTML = `
                ${avatarGroupHtml}
                <div class="info">
                    <div class="name-line">
                        <span class="name">${chat.name}</span>
                        ${chat.isGroup ? '<span class="group-tag">ç¾¤èŠ</span>' : ''}
                    </div>
                    <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
                </div>
                <div class="unread-count-wrapper">
                    <span class="unread-count" style="display: none;">0</span>
                </div>
            `;
            
            const unreadCount = chat.unreadCount || 0;
            const unreadEl = item.querySelector('.unread-count');
            if (unreadCount > 0) {
                unreadEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
                unreadEl.style.display = 'inline-flex';
            } else {
                unreadEl.style.display = 'none';
            }
            
            // â–¼â–¼â–¼ åœ¨è¿™é‡Œå¼€å§‹ä¿®æ”¹ â–¼â–¼â–¼
            const avatarGroupEl = item.querySelector('.avatar-group');
            if (avatarGroupEl) {
                avatarGroupEl.style.cursor = 'pointer';
                // å°† 'click' äº‹ä»¶æ”¹ä¸º 'dblclick'
               avatarGroupEl.addEventListener('dblclick', (e) => { // <--- æŠŠ 'click' æ”¹ä¸º 'dblclick'
        e.stopPropagation();
        const nameToPat = chat.isGroup ? chat.name : chat.originalName;
        handleUserPat(chat.id, nameToPat);
    });
            }
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
            
            const infoEl = item.querySelector('.info');
            if (infoEl) {
                infoEl.addEventListener('click', () => openChat(chat.id));
            }
        
            addLongPressListener(item, async (e) => {
                const action = await showChatListActions(chat);
                switch (action) {
                    case 'pin':
                        chat.isPinned = !chat.isPinned;
                        await db.chats.put(chat);
                        renderChatList();
                        break;
                    case 'delete':
                        const deleteConfirmed = await showCustomConfirm(
                            'åˆ é™¤å¯¹è¯', 
                            `ç¡®å®šè¦åˆ é™¤ä¸ "${chat.name}" çš„æ•´ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, 
                            { confirmButtonClass: 'btn-danger' }
                        );
                        if (deleteConfirmed) {
                            if (musicState.isActive && musicState.activeChatId === chat.id) {
                                await endListenTogetherSession(false);
                            }
                            delete state.chats[chat.id];
                            if (state.activeChatId === chat.id) {
                                state.activeChatId = null;
                            }
                            await db.chats.delete(chat.id);
                            renderChatList();
                        }
                        break;
                    default:
                        break;
                }
            });
            return item;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
/**
         * ã€V3.1 | æ—è§‚æ¨¡å¼å…¼å®¹ç‰ˆã€‘æ¸²æŸ“èŠå¤©ç•Œé¢
         */
        async function renderChatInterface(chatId) {
            applyButtonOrder();
            cleanupWaimaiTimers();
            const chat = state.chats[chatId];
            if (!chat) return;
        
            exitSelectionMode();
            
            const messagesContainer = document.getElementById('chat-messages');
            const chatInputArea = document.getElementById('chat-input-area');
            const lockOverlay = document.getElementById('chat-lock-overlay');
            const lockContent = document.getElementById('chat-lock-content');
            
            // --- (è¿™éƒ¨åˆ†æ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜, ç”¨äºè®¾ç½®ä¸»é¢˜ã€å­—ä½“ã€èƒŒæ™¯ç­‰) ---
            messagesContainer.dataset.theme = chat.settings.theme || 'default';
            const fontSize = chat.settings.fontSize || 13;
            messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
            applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
            
            document.getElementById('chat-header-title').textContent = chat.name;
            const statusContainer = document.getElementById('chat-header-status');
            const statusTextEl = statusContainer.querySelector('.status-text');
        
            if (chat.isGroup) {
                statusContainer.style.display = 'none';
                document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
            } else {
                statusContainer.style.display = 'flex';
                document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
                statusTextEl.textContent = chat.status?.text || 'åœ¨çº¿';
                statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
            }
            
            const chatScreen = document.getElementById('chat-interface-screen');
            const individualBg = chat.settings.background;
            const globalBg = state.globalSettings.globalChatBackground;
            const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
            const defaultColor = isDarkMode ? '#000000' : '#f0f2f5';

            if (individualBg) {
                chatScreen.style.backgroundImage = `url(${individualBg})`;
                chatScreen.style.backgroundColor = 'transparent';
            } else if (globalBg) {
                chatScreen.style.backgroundImage = `url(${globalBg})`;
                chatScreen.style.backgroundColor = 'transparent';
            } else {
                chatScreen.style.backgroundImage = 'none';
                chatScreen.style.backgroundColor = defaultColor;
            }

            // --- ã€ã€ã€æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œï¼ã€‘ã€‘ã€‘ ---
            // æ ¹æ® isSpectatorGroup æ ‡è®°æ¥å†³å®šæ˜¾ç¤ºå“ªä¸ªUI
            if (chat.isSpectatorGroup) {
                // å¦‚æœæ˜¯æ—è§‚æ¨¡å¼ç¾¤èŠ
                chatInputArea.style.display = 'none'; // 1. éšè—æ•´ä¸ªè¾“å…¥åŒºåŸŸ
                lockOverlay.style.display = 'flex';   // 2. æ˜¾ç¤ºé®ç½©å±‚ä½œä¸ºèƒŒæ™¯
                lockContent.innerHTML = `
                    <span class="lock-text">æ­£åœ¨å›´è§‚AIä»¬çš„ç¾¤èŠ...</span>
        <div class="spectator-actions-container">
           <button id="spectator-reroll-btn" class="lock-action-btn secondary" title="é‡æ–°ç”Ÿæˆä¸Šä¸€è½®å¯¹è¯">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
            </button>
            <button id="spectator-propel-btn" class="lock-action-btn">ğŸ¬ æ¨è¿›å‰§æƒ…</button>
            <button id="spectator-edit-btn" class="lock-action-btn secondary" title="å¯¼æ¼”å‰ªè¾‘å®¤ï¼šç¼–è¾‘AIä¸Šä¸€è½®çš„å“åº”">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                    <line x1="16" y1="8" x2="2" y2="22"></line>
                    <line x1="17.5" y1="15" x2="9" y2="15"></line>
                </svg>
            </button>
        </div>
                `; // 3. åœ¨é®ç½©å±‚é‡Œæ˜¾ç¤ºæ–°çš„UI
                
                // 4. ä¸ºæ–°çš„â€œæ¨è¿›å‰§æƒ…â€æŒ‰é’®ç»‘å®šä¸“å±å‡½æ•°
                document.getElementById('spectator-propel-btn').onclick = triggerSpectatorGroupAiAction;

            } else {
                // å¦‚æœæ˜¯æ™®é€šèŠå¤©
                chatInputArea.style.display = 'flex'; // 1. ç¡®ä¿è¾“å…¥åŒºåŸŸæ˜¯å¯è§çš„
                lockOverlay.style.display = 'none';   // 2. éšè—é®ç½©å±‚
                lockContent.innerHTML = '';
                
                // 3. (è¿™éƒ¨åˆ†æ˜¯æ‚¨åŸæ¥å°±æœ‰çš„é€»è¾‘ï¼Œä¿æŒä¸å˜) å¤„ç†å¥½å‹ç”³è¯·ã€æ‹‰é»‘ç­‰çŠ¶æ€
                if (!chat.isGroup && chat.relationship.status !== 'friend') {
                    lockOverlay.style.display = 'flex';
                    chatInputArea.style.visibility = 'hidden';
                    
                    let lockHtml = '';
                    switch (chat.relationship.status) {
                         case 'blocked_by_user':
                            const isSimulationRunning = simulationIntervalId !== null;
                            const blockedTimestamp = chat.relationship.blockedTimestamp;
                            const cooldownHours = state.globalSettings.blockCooldownHours || 1;
                            const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                            const timeSinceBlock = Date.now() - blockedTimestamp;
                            const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                            const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));
            
                            lockHtml = `
                                <span class="lock-text">ä½ å·²å°†â€œ${chat.name}â€æ‹‰é»‘ã€‚</span>
                                <button id="unblock-btn" class="lock-action-btn">è§£é™¤æ‹‰é»‘</button>
                                <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                                    <strong style="color: #333;">ã€å¼€å‘è€…è¯Šæ–­é¢æ¿ã€‘</strong><br>
                                    - åå°æ´»åŠ¨æ€»å¼€å…³: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">å·²å¼€å¯</span>' : '<span style="color: red;">å·²å…³é—­</span>'}<br>
                                    - ç³»ç»Ÿå¿ƒè·³è®¡æ—¶å™¨: ${isSimulationRunning ? '<span style="color: green;">è¿è¡Œä¸­</span>' : '<span style="color: red;">æœªè¿è¡Œ</span>'}<br>
                                    - å½“å‰è§’è‰²çŠ¶æ€: <strong>${chat.relationship.status}</strong><br>
                                    - éœ€è¦å†·é™(å°æ—¶): <strong>${cooldownHours}</strong><br>
                                    - å†·é™æœŸæ˜¯å¦ç»“æŸ: ${isCooldownOver ? '<span style="color: green;">æ˜¯</span>' : `<span style="color: orange;">å¦ (è¿˜å‰©çº¦ ${timeRemainingMinutes} åˆ†é’Ÿ)</span>`}<br>
                                    - è§¦å‘æ¡ä»¶: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">å·²æ»¡è¶³ï¼Œç­‰å¾…ä¸‹æ¬¡ç³»ç»Ÿå¿ƒè·³</span>' : '<span style="color: red;">æœªæ»¡è¶³</span>'}
                                </div>
                                <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">å¼ºåˆ¶è§¦å‘ä¸€æ¬¡å¥½å‹ç”³è¯·æ£€æµ‹</button>
                            `;
                            break;
                        case 'blocked_by_ai':
                            lockHtml = `
                                <span class="lock-text">ä½ è¢«å¯¹æ–¹æ‹‰é»‘äº†ã€‚</span>
                                <button id="apply-friend-btn" class="lock-action-btn">é‡æ–°ç”³è¯·åŠ ä¸ºå¥½å‹</button>
                            `;
                            break;
                        case 'pending_user_approval':
                            lockHtml = `
                                <span class="lock-text">â€œ${chat.name}â€è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹ï¼š<br><i>â€œ${chat.relationship.applicationReason}â€</i></span>
                                <button id="accept-friend-btn" class="lock-action-btn">æ¥å—</button>
                                <button id="reject-friend-btn" class="lock-action-btn secondary">æ‹’ç»</button>
                            `;
                            break;
                        case 'pending_ai_approval':
                            lockHtml = `<span class="lock-text">å¥½å‹ç”³è¯·å·²å‘é€ï¼Œç­‰å¾…å¯¹æ–¹é€šè¿‡...</span>`;
                            break;
                    }
                    lockContent.innerHTML = lockHtml;
                } else {
                     lockOverlay.style.display = 'none';
                     chatInputArea.style.visibility = 'visible';
                }
            }
            // --- ã€ä¿®æ”¹ç»“æŸã€‘ ---

            // --- (è¿™éƒ¨åˆ†æ¸²æŸ“æ¶ˆæ¯å†å²çš„é€»è¾‘ä¿æŒä¸å˜) ---
            messagesContainer.innerHTML = '';
            const history = chat.history;
            const totalMessages = history.length;
            currentRenderedCount = 0;
            const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
            let lastTimestamp = 0;
            const fragment = document.createDocumentFragment();
            for (const msg of initialMessages) {
                if (lastTimestamp > 0 && (msg.timestamp - lastTimestamp > 3600000)) {
                    fragment.appendChild(createSystemTimestampElement(msg.timestamp));
                }
                const messageEl = await createMessageElement(msg, chat, true);
                if (messageEl) {
                    fragment.appendChild(messageEl);
                }
                lastTimestamp = msg.timestamp;
            }
            messagesContainer.appendChild(fragment);
            currentRenderedCount = initialMessages.length;
            if (totalMessages > currentRenderedCount) {
                prependLoadMoreButton(messagesContainer);
            }
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.style.display = 'none';
            typingIndicator.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
            messagesContainer.appendChild(typingIndicator);
            setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
        }
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
                function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'åŠ è½½æ›´æ—©çš„è®°å½•'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }
        
        // â–¼â–¼â–¼ ã€é¢„é˜²æ€§ä¿®å¤ã€‘è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ loadMoreMessages å‡½æ•° â–¼â–¼â–¼
        async function loadMoreMessages() { // <--- å…³é”®ä¿®æ”¹1ï¼šå°†å‡½æ•°å£°æ˜ä¸º async
            const messagesContainer = document.getElementById('chat-messages');
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) loadMoreBtn.remove();
            
            const totalMessages = chat.history.length;
            const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW;
            const nextSliceEnd = totalMessages - currentRenderedCount;
            const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd);
            
            const oldScrollHeight = messagesContainer.scrollHeight;
            
            // â–¼â–¼â–¼ å…³é”®ä¿®æ”¹2ï¼šå°† forEach æ›¿æ¢ä¸º for...of å¾ªç¯ â–¼â–¼â–¼
            for (const msg of messagesToPrepend.reverse()) {
                await prependMessage(msg, chat); // <-- ä½¿ç”¨ await ç­‰å¾…
            }
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        
            currentRenderedCount += messagesToPrepend.length;
            const newScrollHeight = messagesContainer.scrollHeight;
            messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight);
            
            if (totalMessages > currentRenderedCount) {
                prependLoadMoreButton(messagesContainer);
            }
        }
        
// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå·²æ›´æ–°çš„ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderWallpaperScreen å‡½æ•° â–¼â–¼â–¼
        function renderWallpaperScreen() { 
            loadCssPresetsDropdown();
            
            // EPhone å£çº¸é¢„è§ˆ
            const preview = document.getElementById('wallpaper-preview'); 
            const bg = newWallpaperBase64 || state.globalSettings.wallpaper; 
            if (bg && bg.startsWith('data:image')) { 
                preview.style.backgroundImage = `url(${bg})`; 
                preview.textContent = ''; 
            } else if(bg) { 
                preview.style.backgroundImage = bg; 
                preview.textContent = 'å½“å‰ä¸ºæ¸å˜è‰²'; 
            }

            // ã€æ ¸å¿ƒæ–°å¢ã€‘æ¸²æŸ“CPhoneçš„å£çº¸é¢„è§ˆ
            const cphonePreview = document.getElementById('cphone-wallpaper-preview');
            const cphoneBg = state.globalSettings.cphoneWallpaper;
            if (cphoneBg && cphoneBg.startsWith('data:image')) {
                cphonePreview.style.backgroundImage = `url(${cphoneBg})`;
                cphonePreview.textContent = '';
            } else if (cphoneBg) {
                cphonePreview.style.backgroundImage = cphoneBg;
                cphonePreview.textContent = 'å½“å‰ä¸ºæ¸å˜è‰²';
            }

            // å…¨å±€èŠå¤©èƒŒæ™¯é¢„è§ˆ
            const globalBgPreview = document.getElementById('global-bg-preview');
            const globalBg = state.globalSettings.globalChatBackground;
            if (globalBg) {
                globalBgPreview.style.backgroundImage = `url(${globalBg})`;
                globalBgPreview.textContent = '';
                document.getElementById('remove-global-bg-btn').style.display = 'inline-block';
            } else {
                globalBgPreview.style.backgroundImage = 'none';
                globalBgPreview.textContent = 'ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ ';
                document.getElementById('remove-global-bg-btn').style.display = 'none';
            }

            // æ¸²æŸ“ EPhone å’Œ CPhone çš„å›¾æ ‡è®¾ç½®
            renderIconSettings();
            renderCPhoneIconSettings(); // <-- æ–°å¢è°ƒç”¨

            // (å…¶ä»–é€»è¾‘ä¿æŒä¸å˜)
            document.getElementById('global-css-input').value = state.globalSettings.globalCss || '';
            document.getElementById('notification-sound-url-input').value = state.globalSettings.notificationSoundUrl || '';
            document.getElementById('status-bar-toggle-switch').checked = state.globalSettings.showStatusBar || false;
    renderButtonOrderEditor();
    initializeButtonOrderEditor();
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
                window.renderWallpaperScreenProxy = renderWallpaperScreen;
        
                function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™ä¸ªå‡½æ•°ç”¨äºå¤„ç†ä¸–ç•Œä¹¦é¡µç­¾çš„ç‚¹å‡»åˆ‡æ¢ â–¼â–¼â–¼
        function switchWorldBookCategory(categoryId) {
            // 1. åˆ‡æ¢é¡µç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.world-book-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
            });
            // 2. åˆ‡æ¢å†…å®¹é¢æ¿çš„æ˜¾ç¤ºçŠ¶æ€
            document.querySelectorAll('.world-book-category-pane').forEach(pane => {
                pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
            });
        }
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå…¨æ–°ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ renderWorldBookScreen å‡½æ•° â–¼â–¼â–¼
        async function renderWorldBookScreen() {
            const tabsContainer = document.getElementById('world-book-tabs');
            const contentContainer = document.getElementById('world-book-content-container');
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
        
            // 1. åŒæ—¶è·å–æ‰€æœ‰ä¹¦ç±å’Œæ‰€æœ‰åˆ†ç±»
            const [books, categories] = await Promise.all([
                db.worldBooks.toArray(),
                db.worldBookCategories.orderBy('name').toArray()
            ]);
        
            state.worldBooks = books; // ç¡®ä¿å†…å­˜ä¸­çš„æ•°æ®æ˜¯åŒæ­¥çš„
        
            if (books.length === 0) {
                contentContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" åˆ›å»ºä½ çš„ç¬¬ä¸€æœ¬ä¸–ç•Œä¹¦</p>';
                return;
            }
        
            // --- 2. åˆ›å»ºå¹¶æ·»åŠ â€œå…¨éƒ¨â€é¡µç­¾å’Œå…¶å†…å®¹é¢æ¿ ---
            const allTab = document.createElement('button');
            allTab.className = 'world-book-tab active';
            allTab.textContent = 'å…¨éƒ¨';
            allTab.dataset.categoryId = 'all';
            tabsContainer.appendChild(allTab);
        
            const allPane = document.createElement('div');
            allPane.className = 'world-book-category-pane active';
            allPane.dataset.categoryId = 'all';
            contentContainer.appendChild(allPane);
        
            // --- 3. åˆ›å»ºå¹¶æ·»åŠ å„ä¸ªåˆ†ç±»çš„é¡µç­¾å’Œå†…å®¹é¢æ¿ ---
            categories.forEach(category => {
                const categoryTab = document.createElement('button');
                categoryTab.className = 'world-book-tab';
                categoryTab.textContent = category.name;
                categoryTab.dataset.categoryId = String(category.id);
                tabsContainer.appendChild(categoryTab);
        
                const categoryPane = document.createElement('div');
                categoryPane.className = 'world-book-category-pane';
                categoryPane.dataset.categoryId = String(category.id);
                contentContainer.appendChild(categoryPane);
            });
            
            // --- 4. åˆ›å»ºå¹¶æ·»åŠ â€œæœªåˆ†ç±»â€çš„é¡µç­¾å’Œå†…å®¹é¢æ¿ (å¦‚æœéœ€è¦) ---
            const hasUncategorized = books.some(book => !book.categoryId);
            if (hasUncategorized) {
                const uncategorizedTab = document.createElement('button');
                uncategorizedTab.className = 'world-book-tab';
                uncategorizedTab.textContent = 'æœªåˆ†ç±»';
                uncategorizedTab.dataset.categoryId = 'uncategorized';
                tabsContainer.appendChild(uncategorizedTab);
            
                const uncategorizedPane = document.createElement('div');
                uncategorizedPane.className = 'world-book-category-pane';
                uncategorizedPane.dataset.categoryId = 'uncategorized';
                contentContainer.appendChild(uncategorizedPane);
            }
        
            // --- 5. éå†ä¹¦ç±ï¼Œå°†å®ƒä»¬å¡«å……åˆ°å¯¹åº”çš„å†…å®¹é¢æ¿ä¸­ ---
            books.forEach(book => {
                let contentPreview = 'æš‚æ— å†…å®¹...';
                if (Array.isArray(book.content) && book.content.length > 0) {
                    const firstEntry = book.content[0];
                    contentPreview = firstEntry.comment || firstEntry.content || '';
                } else if (typeof book.content === 'string' && book.content.trim() !== '') {
                    contentPreview = book.content;
                }
        
                const card = document.createElement('div');
                card.className = 'world-book-card';
                card.innerHTML = `
                    <div class="card-title">${book.name}</div>
                    <div class="card-content-preview">${contentPreview}</div>
                `;
                
                // ä¸ºå¡ç‰‡æœ¬èº«æ·»åŠ ç‚¹å‡»å’Œé•¿æŒ‰äº‹ä»¶
                const cardClickHandler = () => openWorldBookEditor(book.id);
                const cardLongPressHandler = async () => { 
                    const confirmed = await showCustomConfirm('åˆ é™¤ä¸–ç•Œä¹¦', `ç¡®å®šè¦åˆ é™¤ã€Š${book.name}ã€‹å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); 
                    if (confirmed) { 
                        await db.worldBooks.delete(book.id); 
                        state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); 
                        renderWorldBookScreen(); 
                    } 
                };
        
                card.addEventListener('click', cardClickHandler);
                addLongPressListener(card, cardLongPressHandler);
        
                // å…‹éš†å¡ç‰‡å¹¶æŠ•æ”¾åˆ°â€œå…¨éƒ¨â€é¢æ¿
                const clonedCardForAll = card.cloneNode(true);
                clonedCardForAll.addEventListener('click', cardClickHandler);
                addLongPressListener(clonedCardForAll, cardLongPressHandler);
                allPane.appendChild(clonedCardForAll);
                
                // å°†åŸå§‹å¡ç‰‡æŠ•æ”¾åˆ°å¯¹åº”çš„åˆ†ç±»é¢æ¿
                const categoryKey = book.categoryId ? String(book.categoryId) : 'uncategorized';
                const targetPane = contentContainer.querySelector(`.world-book-category-pane[data-category-id="${categoryKey}"]`);
                if (targetPane) {
                    targetPane.appendChild(card);
                }
            });
        
            // --- 6. ä¸ºæ‰€æœ‰é¡µç­¾ç»‘å®šåˆ‡æ¢äº‹ä»¶ ---
            document.querySelectorAll('.world-book-tab').forEach(tab => {
                tab.addEventListener('click', () => switchWorldBookCategory(tab.dataset.categoryId));
            });
        }
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæœ€ç»ˆä¿®å¤ç‰ˆã€‘å®Œæ•´æ›¿æ¢æ—§çš„ createWorldBookGroup å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€V2.0 | å·²ä¿®å¤é¢„è§ˆBUGã€‘åˆ›å»ºä¸€ä¸ªåˆ†ç±»çš„åˆ†ç»„DOM
         * @param {string} groupName - åˆ†ç±»åç§°
         * @param {Array} books - è¯¥åˆ†ç±»ä¸‹çš„ä¹¦ç±æ•°ç»„
         * @returns {HTMLElement} - åˆ›å»ºå¥½çš„åˆ†ç»„å®¹å™¨
         */
        function createWorldBookGroup(groupName, books) {
            const groupContainer = document.createElement('div');
            groupContainer.className = 'world-book-group-container';
            
            groupContainer.innerHTML = `
                <div class="world-book-group-header">
                    <span class="arrow">â–¼</span>
                    <span class="group-name">${groupName}</span>
                </div>
                <div class="world-book-group-content"></div>
            `;
        
            const contentEl = groupContainer.querySelector('.world-book-group-content');
            books.sort((a,b) => a.name.localeCompare(b.name, 'zh-CN')); // æŒ‰ä¹¦åæ’åº
            
            books.forEach(book => {
                // â–¼â–¼â–¼ ã€ã€ã€è¿™å°±æ˜¯æœ€å…³é”®çš„ä¿®å¤ï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
                let contentPreview = 'æš‚æ— å†…å®¹...';
                
                // 1. æ£€æŸ¥ book.content æ˜¯å¦æ˜¯æˆ‘ä»¬æ–°çš„â€œæ¡ç›®æ•°ç»„â€æ ¼å¼
                if (Array.isArray(book.content) && book.content.length > 0) {
                    // å¦‚æœæ˜¯ï¼Œå°±ä»ç¬¬ä¸€ä¸ªæ¡ç›®çš„å†…å®¹ä¸­æå–é¢„è§ˆ
                    // æˆ‘ä»¬ä¹Ÿä¼˜å…ˆä½¿ç”¨ç¬¬ä¸€ä¸ªæ¡ç›®çš„ comment ä½œä¸ºé¢„è§ˆï¼Œå› ä¸ºå®ƒæ›´ç®€æ´
                    const firstEntry = book.content[0];
                    contentPreview = firstEntry.comment || firstEntry.content || '';
                } 
                // 2. å¦åˆ™ï¼Œå°±æ£€æŸ¥å®ƒæ˜¯å¦æ˜¯æ—§çš„â€œå­—ç¬¦ä¸²â€æ ¼å¼
                else if (typeof book.content === 'string' && book.content.trim() !== '') {
                    // å¦‚æœæ˜¯ï¼Œå°±åƒä»¥å‰ä¸€æ ·å¤„ç†
                    contentPreview = book.content;
                }
                // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
        
                const item = document.createElement('div');
                item.className = 'list-item';
                item.dataset.bookId = book.id;
                // ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨å¤„ç†å¥½çš„ contentPreview æ¥ç”ŸæˆHTMLï¼Œå¹¶ç¡®ä¿å®ƒæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²
                item.innerHTML = `
                    <div class="item-title">${book.name}</div>
                    <div class="item-content">${String(contentPreview).substring(0, 50)}</div>
                `;
                item.addEventListener('click', () => openWorldBookEditor(book.id));
                addLongPressListener(item, async () => { 
                    const confirmed = await showCustomConfirm('åˆ é™¤ä¸–ç•Œä¹¦', `ç¡®å®šè¦åˆ é™¤ã€Š${book.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' }); 
                    if (confirmed) { 
                        await db.worldBooks.delete(book.id); 
                        state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); 
                        renderWorldBookScreen(); 
                    } 
                });
                contentEl.appendChild(item);
            });
        
            return groupContainer;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
                window.renderWorldBookScreenProxy = renderWorldBookScreen;
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå·²ä¿®å¤BUGçš„ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ openWorldBookEditor å‡½æ•° â–¼â–¼â–¼
        async function openWorldBookEditor(bookId) {
            // ã€æ ¸å¿ƒä¿®å¤ã€‘å°†åˆ‡æ¢å±å¹•çš„æ“ä½œç§»åŠ¨åˆ°å‡½æ•°çš„æœ€å‰é¢
            // è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨æ“ä½œDOMå…ƒç´ ä¹‹å‰ï¼Œå®ƒä»¬æ‰€åœ¨çš„å±å¹•å·²ç»æ˜¯æ¿€æ´»çŠ¶æ€
            showScreen('world-book-editor-screen');
        
            editingWorldBookId = bookId;
            const [book, categories] = await Promise.all([
                db.worldBooks.get(bookId),
                db.worldBookCategories.toArray()
            ]);
        
            // å¦‚æœåœ¨åˆ‡æ¢å±å¹•åå‘ç°ä¹¦ç±ä¸å­˜åœ¨ï¼Œåˆ™å®‰å…¨è¿”å›åˆ—è¡¨é¡µ
            if (!book) {
                console.error("å°è¯•æ‰“å¼€ä¸€ä¸ªä¸å­˜åœ¨çš„ä¸–ç•Œä¹¦ï¼ŒID:", bookId);
                showScreen('world-book-screen');
                return;
            }
        
            // ç°åœ¨ï¼Œå› ä¸ºå±å¹•å·²æ˜¾ç¤ºï¼Œæ‰€ä»¥å¯ä»¥å®‰å…¨åœ°æ“ä½œè¿™äº›å…ƒç´ äº†
            document.getElementById('world-book-editor-title').textContent = book.name;
            document.getElementById('world-book-name-input').value = book.name;
        
            // åˆ†ç±»ä¸‹æ‹‰èœå•çš„é€»è¾‘ä¿æŒä¸å˜
            const selectEl = document.getElementById('world-book-category-select');
            selectEl.innerHTML = '<option value="">-- æœªåˆ†ç±» --</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                if (book.categoryId === cat.id) option.selected = true;
                selectEl.appendChild(option);
            });
        
            // åŠ¨æ€æ¸²æŸ“æ¡ç›®çš„é€»è¾‘ä¿æŒä¸å˜
            const entriesContainer = document.getElementById('world-book-entries-container');
            entriesContainer.innerHTML = ''; 
        
            if (Array.isArray(book.content) && book.content.length > 0) {
                book.content.forEach(entry => {
                    const block = createWorldBookEntryBlock(entry);
                    entriesContainer.appendChild(block);
                });
            } else {
                entriesContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 20px;">è¿˜æ²¡æœ‰å†…å®¹ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡å§ï¼</p>';
            }
        
            // ä¸å†éœ€è¦åœ¨å‡½æ•°æœ«å°¾è°ƒç”¨ showScreenï¼Œå› ä¸ºå®ƒå·²ç»åœ¨å¼€å¤´è¢«è°ƒç”¨äº†
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ”¯æŒåˆ†ç±»çš„ V2.0 ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderStickerPanel å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€V2.0 | åˆ†ç±»æ”¯æŒç‰ˆã€‘æ¸²æŸ“è¡¨æƒ…é¢æ¿
         * @param {boolean} rerenderTabs - æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“é¡¶éƒ¨çš„åˆ†ç±»é¡µç­¾
         */
        async function renderStickerPanel(rerenderTabs = true) {
            const grid = document.getElementById('sticker-grid');
            const tabsContainer = document.getElementById('sticker-category-tabs');
            
            // --- 1. æ¸²æŸ“åˆ†ç±»é¡µç­¾ (ä»…åœ¨éœ€è¦æ—¶) ---
            if (rerenderTabs) {
                tabsContainer.innerHTML = '';
                const categories = await db.stickerCategories.toArray();
                
                // æ·»åŠ â€œå…¨éƒ¨â€å’Œâ€œæœªåˆ†ç±»â€é¡µç­¾
                tabsContainer.innerHTML += `
                    <button class="sticker-category-tab ${activeStickerCategoryId === 'all' ? 'active' : ''}" data-category-id="all">å…¨éƒ¨</button>
                `;
                categories.forEach(cat => {
                     tabsContainer.innerHTML += `
                        <button class="sticker-category-tab ${activeStickerCategoryId === cat.id ? 'active' : ''}" data-category-id="${cat.id}">${cat.name}</button>
                    `;
                });
                tabsContainer.innerHTML += `
                    <button class="sticker-category-tab ${activeStickerCategoryId === 'uncategorized' ? 'active' : ''}" data-category-id="uncategorized">æœªåˆ†ç±»</button>
                `;
            }

            // --- 2. æ¸²æŸ“è¡¨æƒ…ç½‘æ ¼ ---
            grid.innerHTML = '';
            
            // æ ¹æ®å½“å‰é€‰ä¸­çš„åˆ†ç±»ç­›é€‰è¡¨æƒ…
            let stickersToShow;
            if (activeStickerCategoryId === 'all') {
                stickersToShow = state.userStickers;
            } else if (activeStickerCategoryId === 'uncategorized') {
                stickersToShow = state.userStickers.filter(s => !s.categoryId);
            } else {
                stickersToShow = state.userStickers.filter(s => s.categoryId === activeStickerCategoryId);
            }

            if (stickersToShow.length === 0) {
                grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1; padding-top: 20px;">è¿™ä¸ªåˆ†ç±»ä¸‹è¿˜æ²¡æœ‰è¡¨æƒ…å“¦~</p>';
                return;
            }

            stickersToShow.forEach(sticker => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                item.title = sticker.name;
                item.dataset.stickerId = sticker.id;

                // åˆ›å»ºå›¾ç‰‡å®¹å™¨å’Œåç§°æ ‡ç­¾
                item.innerHTML = `
                    <div class="sticker-image-container" style="background-image: url(${sticker.url})"></div>
                    <span class="sticker-name">${sticker.name}</span>
                `;

                item.addEventListener('click', () => {
                    if (isStickerManagementMode) {
                        handleStickerSelection(item);
                    } else {
                        sendSticker(sticker);
                    }
                });

                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const confirmed = await showCustomConfirm('åˆ é™¤è¡¨æƒ…', `ç¡®å®šè¦åˆ é™¤è¡¨æƒ… "${sticker.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        await db.userStickers.delete(sticker.id);
                        state.userStickers = state.userStickers.filter(s => s.id !== sticker.id);
                        renderStickerPanel(); // Refresh the panel after deletion
                    }
                };
                
                // å°†åˆ é™¤æŒ‰é’®æ·»åŠ åˆ°æ€»å®¹å™¨çš„å³ä¸Šè§’
                item.appendChild(deleteBtn);
                grid.appendChild(item);
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…æ‰¹é‡åˆ é™¤æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        let isStickerManagementMode = false;
        let selectedStickers = new Set();
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ª V2.0 ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ toggleStickerManagementMode å‡½æ•° â–¼â–¼â–¼
        /**
         * åˆ‡æ¢è¡¨æƒ…é¢æ¿çš„ç®¡ç†æ¨¡å¼
         */
        function toggleStickerManagementMode() {
            isStickerManagementMode = !isStickerManagementMode;
            const grid = document.getElementById('sticker-grid');
            const manageBtn = document.getElementById('manage-stickers-btn');
            const actionBar = document.getElementById('sticker-action-bar');
            const selectAllCheckbox = document.getElementById('select-all-stickers-checkbox');
        
            grid.classList.toggle('management-mode', isStickerManagementMode);
            
            if (isStickerManagementMode) {
                manageBtn.textContent = 'å®Œæˆ';
                actionBar.style.display = 'flex'; // æ”¹ä¸º flex
                selectedStickers.clear();
                selectAllCheckbox.checked = false; // é‡ç½®å…¨é€‰æ¡†
                updateDeleteStickerButton();
            } else {
                manageBtn.textContent = 'ç®¡ç†';
                actionBar.style.display = 'none';
                grid.querySelectorAll('.sticker-item.selected').forEach(item => item.classList.remove('selected'));
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ™ºèƒ½â€œå…¨é€‰â€åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•°ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼
        /**
         * å¤„ç†â€œå…¨é€‰â€å¤é€‰æ¡†çš„ç‚¹å‡»äº‹ä»¶ï¼Œæ ¹æ®å½“å‰åˆ†ç±»æ™ºèƒ½é€‰æ‹©
         */
        function handleSelectAllStickers() {
            const checkbox = document.getElementById('select-all-stickers-checkbox');
            const shouldSelect = checkbox.checked;
        
            // 1. æ ¹æ®å½“å‰æ¿€æ´»çš„åˆ†ç±»IDï¼Œç­›é€‰å‡ºåº”è¯¥è¢«æ“ä½œçš„è¡¨æƒ…
            let stickersToSelect;
            if (activeStickerCategoryId === 'all') {
                stickersToSelect = state.userStickers;
            } else if (activeStickerCategoryId === 'uncategorized') {
                stickersToSelect = state.userStickers.filter(s => !s.categoryId);
            } else {
                stickersToSelect = state.userStickers.filter(s => s.categoryId === activeStickerCategoryId);
            }
        
            // 2. éå†è¿™äº›è¢«ç­›é€‰å‡ºçš„è¡¨æƒ…
            stickersToSelect.forEach(sticker => {
                const stickerId = sticker.id;
                const itemEl = document.querySelector(`.sticker-item[data-sticker-id="${stickerId}"]`);
                
                if (shouldSelect) {
                    // å¦‚æœæ˜¯â€œå…¨é€‰â€æ“ä½œ
                    selectedStickers.add(stickerId);
                    if (itemEl) itemEl.classList.add('selected');
                } else {
                    // å¦‚æœæ˜¯â€œå–æ¶ˆå…¨é€‰â€æ“ä½œ
                    selectedStickers.delete(stickerId);
                    if (itemEl) itemEl.classList.remove('selected');
                }
            });
        
            // 3. æ›´æ–°åˆ é™¤æŒ‰é’®çš„è®¡æ•°
            updateDeleteStickerButton();
        }
        // â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²        
        /**
         * æ›´æ–°åˆ é™¤æŒ‰é’®ä¸Šçš„è®¡æ•°
         */
        function updateDeleteStickerButton() {
            const btn = document.getElementById('delete-selected-stickers-btn');
            btn.textContent = `åˆ é™¤ (${selectedStickers.size})`;
        }
        
        /**
         * å¤„ç†ç”¨æˆ·ç‚¹å‡»é€‰æ‹©æˆ–å–æ¶ˆé€‰æ‹©è¡¨æƒ…
         * @param {HTMLElement} item - è¢«ç‚¹å‡»çš„è¡¨æƒ…DOMå…ƒç´ 
         */
        function handleStickerSelection(item) {
            if (!isStickerManagementMode) return; // åªæœ‰åœ¨ç®¡ç†æ¨¡å¼ä¸‹æ‰ç”Ÿæ•ˆ
        
            const stickerId = item.dataset.stickerId;
            if (!stickerId) return;
        
            item.classList.toggle('selected');
        
            if (selectedStickers.has(stickerId)) {
                selectedStickers.delete(stickerId);
            } else {
                selectedStickers.add(stickerId);
            }
            updateDeleteStickerButton();
        }
        
        /**
         * æ‰§è¡Œæ‰¹é‡åˆ é™¤æ“ä½œ
         */
        async function executeBatchDeleteStickers() {
            if (selectedStickers.size === 0) return;
            
            const confirmed = await showCustomConfirm(
                'ç¡®è®¤åˆ é™¤',
                `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedStickers.size} ä¸ªè¡¨æƒ…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (confirmed) {
                const idsToDelete = [...selectedStickers];
                
                // ä»æ•°æ®åº“æ‰¹é‡åˆ é™¤
                await db.userStickers.bulkDelete(idsToDelete);
                
                // ä»å†…å­˜çŠ¶æ€ä¸­è¿‡æ»¤æ‰è¢«åˆ é™¤çš„è¡¨æƒ…
                state.userStickers = state.userStickers.filter(s => !idsToDelete.includes(s.id));
                
                // é€€å‡ºç®¡ç†æ¨¡å¼å¹¶åˆ·æ–°åˆ—è¡¨
                toggleStickerManagementMode();
                renderStickerPanel();
                
                await showCustomAlert('åˆ é™¤æˆåŠŸ', 'é€‰ä¸­çš„è¡¨æƒ…å·²æˆåŠŸåˆ é™¤ã€‚');
            }
        }
        // â–²â–²â–² å…¨æ–°åŠŸèƒ½å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ‰¹é‡å¯¼å…¥è¡¨æƒ…çš„æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        
        /**
         * ã€æ€»å…¥å£ã€‘æ‰“å¼€æ‰¹é‡å¯¼å…¥è¡¨æƒ…çš„å¼¹çª—
         */
        async function openBatchStickerImportModal() {
            const placeholderText = `è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç²˜è´´ï¼Œä¸€è¡Œä¸€ä¸ªï¼š\n\nç„¦è™‘ 2a9wte.jpeg\nå¤§æƒŠå¤±è‰² or8qf4.png\næ²¡æœ‰çµæ„Ÿ njwujh.jpeg`;
            
            const pastedText = await showCustomPrompt(
                'æ‰¹é‡å¯¼å…¥è¡¨æƒ…',
                placeholderText,
                '',
                'textarea'
            );
        
            if (pastedText && pastedText.trim()) {
                await handleBatchStickerImport(pastedText);
            }
        }
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleBatchStickerImport å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€æ ¸å¿ƒé€»è¾‘ | V3.0 - å·²ä¿®å¤URLæ ¼å¼BUGã€‘å¤„ç†ç²˜è´´çš„æ–‡æœ¬ï¼Œè§£æå¹¶å­˜å…¥æ•°æ®åº“
         * @param {string} text - ç”¨æˆ·ç²˜è´´çš„æ–‡æœ¬å†…å®¹
         */
        async function handleBatchStickerImport(text) {
            const lines = text.trim().split('\n');
            const newStickers = [];
            const baseUrl = 'https://files.catbox.moe/';
            let errorCount = 0;
            const currentCategoryId = (activeStickerCategoryId !== 'all' && activeStickerCategoryId !== 'uncategorized') ? activeStickerCategoryId : null;

            for (const line of lines) {
                const trimmedLine = line.trim();

                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šç§»é™¤äº†é”™è¯¯çš„ `trimmedLine.includes('http')` åˆ¤æ–­ â–¼â–¼â–¼
                // ç°åœ¨åªè·³è¿‡ç©ºè¡Œæˆ–ç¤ºä¾‹è¡Œ
                if (!trimmedLine || trimmedLine.includes('å¡«å…¥')) {
                    continue;
                }
                // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

                // ä¼˜å…ˆåŒ¹é… â€œåç§°ï¼šURLâ€ æ ¼å¼
                const fullUrlMatch = trimmedLine.match(/^(.+?)[:ï¼š]\s*(https?:\/\/.+)$/);
                
                if (fullUrlMatch) {
                    const name = fullUrlMatch[1].trim();
                    const url = fullUrlMatch[2].trim();
                    newStickers.push({
                        id: 'sticker_' + Date.now() + Math.random(),
                        name: name,
                        url: url,
                        categoryId: currentCategoryId
                    });
                    continue; 
                }

                // å¦‚æœä¸Šé¢æ²¡åŒ¹é…æˆåŠŸï¼Œåˆ™å°è¯•åŒ¹é…æ—§çš„ catbox.moe æ ¼å¼
                let name = null;
                let code = null;
                const noSpaceMatch = trimmedLine.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);
                
                if (noSpaceMatch) {
                    name = noSpaceMatch[1];
                    code = noSpaceMatch[2];
                } else {
                    const parts = trimmedLine.split(/\s+/);
                    if (parts.length >= 2) {
                        code = parts.pop();
                        name = parts.join(' ');
                    }
                }

                if (name && code && code.includes('.')) {
                    newStickers.push({
                        id: 'sticker_' + Date.now() + Math.random(),
                        name: name,
                        url: baseUrl + code,
                        categoryId: currentCategoryId
                    });
                } else {
                    errorCount++;
                    console.warn('æ‰¹é‡å¯¼å…¥æ ¼å¼é”™è¯¯ï¼Œå·²è·³è¿‡æ­¤è¡Œ:', trimmedLine);
                }
            }

            if (errorCount > 0) {
                await showCustomAlert('éƒ¨åˆ†å¯¼å…¥å¤±è´¥', `æœ‰ ${errorCount} è¡Œçš„æ ¼å¼ä¸æ­£ç¡®ï¼Œå·²è¢«ç³»ç»Ÿè·³è¿‡ã€‚`);
            }

            if (newStickers.length > 0) {
                await db.userStickers.bulkAdd(newStickers);
                state.userStickers.push(...newStickers);
                renderStickerPanel();
                await showCustomAlert('å¯¼å…¥æˆåŠŸ', `å·²æˆåŠŸæ‰¹é‡å¯¼å…¥ ${newStickers.length} ä¸ªæ–°è¡¨æƒ…ï¼`);
            } else if (errorCount === 0) {
                alert("æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å…¥çš„å†…å®¹ã€‚è¯·æ£€æŸ¥æ‚¨ç²˜è´´çš„æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚");
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        /**
         * ã€å…¨æ–°ã€‘æ»šåŠ¨åˆ°å¹¶é«˜äº®æ˜¾ç¤ºåŸå§‹æ¶ˆæ¯
         * @param {number} originalTimestamp - è¦è·³è½¬åˆ°çš„åŸå§‹æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        function scrollToOriginalMessage(originalTimestamp) {
            // 1. æ„å»ºé€‰æ‹©å™¨ï¼Œç²¾ç¡®æŸ¥æ‰¾åŸå§‹æ¶ˆæ¯çš„ DOM å…ƒç´ 
            const selector = `.message-bubble[data-timestamp="${originalTimestamp}"]`;
            const originalMessageBubble = document.querySelector(selector);
        
            // 2. æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åœ¨å½“å‰å±å¹•ä¸Š
            if (originalMessageBubble) {
                // 3. å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±å¹³æ»‘åœ°æ»šåŠ¨åˆ°å®ƒçš„ä½ç½®
                originalMessageBubble.scrollIntoView({
                    behavior: 'smooth', // å¹³æ»‘æ»šåŠ¨
                    block: 'center'     // å°½é‡è®©å®ƒåœåœ¨å±å¹•ä¸­å¤®
                });
        
                // 4. æ·»åŠ é«˜äº®æ•ˆæœï¼Œå¹¶åœ¨1.5ç§’åè‡ªåŠ¨ç§»é™¤
                originalMessageBubble.classList.add('highlighted');
                setTimeout(() => {
                    // åœ¨ç§»é™¤å‰å†æ¬¡æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé¿å…åœ¨ç”¨æˆ·å¿«é€Ÿåˆ‡æ¢é¡µé¢æ—¶å‡ºé”™
                    if (document.body.contains(originalMessageBubble)) {
                        originalMessageBubble.classList.remove('highlighted');
                    }
                }, 1500); // é«˜äº®æŒç»­1.5ç§’
        
            } else {
                // 5. å¦‚æœåœ¨å½“å‰åŠ è½½çš„æ¶ˆæ¯ä¸­æ‰¾ä¸åˆ°ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªæç¤º
                alert("åŸå§‹æ¶ˆæ¯å°šæœªåŠ è½½ï¼Œè¯·å‘ä¸Šæ»‘åŠ¨åŠ è½½æ›´æ—©çš„è®°å½•åå†è¯•ã€‚");
            }
        }
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ createMessageElement å‡½æ•° â–¼â–¼â–¼
        async function createMessageElement(msg, chat) {
        
            // --- (ç³»ç»Ÿæ¶ˆæ¯å’Œæ’¤å›æ¶ˆæ¯çš„å¤„ç†é€»è¾‘ä¿æŒä¸å˜) ---
            if (msg.type === 'recalled_message') {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper system-pat';
                wrapper.dataset.timestamp = msg.timestamp; 
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble recalled-message-placeholder';
                bubble.dataset.timestamp = msg.timestamp; 
                bubble.textContent = msg.content;
                wrapper.appendChild(bubble);
                addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                wrapper.addEventListener('click', () => { 
                    if (isSelectionMode) {
                        toggleMessageSelection(msg.timestamp);
                    }
                });
                return wrapper;
            }
            else if (msg.type === 'post_deleted_notice') {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper system-pat';
                wrapper.dataset.timestamp = msg.timestamp; 
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble post-deleted-placeholder'; 
                bubble.dataset.postId = msg.postId;
                bubble.textContent = msg.content;
                wrapper.appendChild(bubble);
                addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                wrapper.addEventListener('click', () => { 
                    if (isSelectionMode) {
                        toggleMessageSelection(msg.timestamp);
                    }
                });
                return wrapper;
            }
        
            if (msg.isHidden) {
                return null;
            }
        
            if (msg.type === 'pat_message') {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper system-pat'; 
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble system-bubble'; 
                bubble.dataset.timestamp = msg.timestamp;
                bubble.textContent = msg.content;
                wrapper.appendChild(bubble);
                addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
                return wrapper;
            }
        
            // --- (åŸºç¡€DOMå…ƒç´ å‡†å¤‡é€»è¾‘ä¿æŒä¸å˜) ---
            const isUser = msg.role === 'user';
            const myNickname = chat.settings.myNickname || 'æˆ‘';
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;
        
            if (chat.isGroup && !isUser) {
                const member = chat.members.find(m => m.originalName === msg.senderName);
                const senderNameDiv = document.createElement('div');
                senderNameDiv.className = 'sender-name';
                senderNameDiv.textContent = member ? member.groupNickname : (msg.senderName || 'æœªçŸ¥æˆå‘˜');
                wrapper.appendChild(senderNameDiv);
            }
        
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
            bubble.dataset.timestamp = msg.timestamp;
        
            const timestampEl = document.createElement('span');
            timestampEl.className = 'timestamp';
            timestampEl.textContent = formatTimestamp(msg.timestamp);
        
            let avatarSrc, avatarFrameSrc = '';
            if (isUser) {
                avatarSrc = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                avatarFrameSrc = chat.settings.myAvatarFrame || '';
            } else {
                if (chat.isGroup) {
                    const member = chat.members.find(m => m.originalName === msg.senderName);
                    if (member) {
                        const characterProfile = state.chats[member.id];
                        avatarSrc = member.avatar || (characterProfile ? characterProfile.settings.aiAvatar : defaultGroupMemberAvatar);
                        avatarFrameSrc = member.avatarFrame || (characterProfile ? characterProfile.settings.aiAvatarFrame : '');
                    } else {
                        avatarSrc = defaultGroupMemberAvatar;
                        avatarFrameSrc = '';
                    }
                } else {
                    avatarSrc = chat.settings.aiAvatar || defaultAvatar;
                    avatarFrameSrc = chat.settings.aiAvatarFrame || '';
                }
            }
        
            let avatarHtml;
            if (avatarFrameSrc) {
                avatarHtml = `<div class="avatar-with-frame"><img src="${avatarSrc}" class="avatar-img"><img src="${avatarFrameSrc}" class="avatar-frame"></div>`;
            } else {
                avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
            }
            const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
            const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;
            
            let contentHtml;
            let quoteHtml = '';
            if (msg.quote) {
                const quotedSenderDisplayName = getDisplayNameInGroup(chat, msg.quote.senderName);
                const fullQuotedContent = String(msg.quote.content || '');
                quoteHtml = `
                    <div class="quoted-message" data-original-timestamp="${msg.quote.timestamp}" style="cursor: pointer;">
                        <div class="quoted-sender">å›å¤ ${quotedSenderDisplayName}:</div>
                        <div class="quoted-content">${fullQuotedContent}</div>
                    </div>
                `;
            }
            
            // ==========================================================
            //                  â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹é€»è¾‘ â˜…â˜…â˜…
            // ==========================================================
        
            let rawContent = msg.content; // ç›´æ¥ä½¿ç”¨ msg.contentï¼Œä¸å†å¼ºåˆ¶è½¬ä¸ºå­—ç¬¦ä¸²

            if (typeof rawContent === 'string' && rawContent.trim().startsWith('<') && rawContent.trim().endsWith('>')) {
                contentHtml = rawContent;
                bubble.classList.add('is-raw-html'); 
            } else if (msg.type === 'offline_text' || msg.type === 'share_link' || msg.type === 'share_card' || msg.type === 'location_share' || msg.type === 'ai_image' || msg.type === 'user_photo' || msg.type === 'voice_message' || msg.type === 'transfer' || msg.type === 'waimai_request' || msg.type === 'red_packet' || msg.type === 'poll' || msg.type === 'gift') {
                // (è¿™éƒ¨åˆ†æ˜¯æ‚¨å·²æœ‰çš„æ‰€æœ‰å¡ç‰‡æ¸²æŸ“é€»è¾‘ï¼Œä¿æŒä¸å˜)
               if (msg.type === 'offline_text') {
                    // 1. ã€å…¼å®¹æ—§æ•°æ®ã€‘å¦‚æœæ¶ˆæ¯è¿˜æ˜¯æ—§çš„ dialogue/description æ ¼å¼ï¼Œåˆ™å…ˆåˆå¹¶
                    const combinedText = msg.content || `${msg.dialogue || ''} ${msg.description || ''}`.trim();

                    // 2. ã€æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ã€‘ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œä»¥å¼•å·ä¸ºç•Œï¼Œå°†æ–‡æœ¬åˆ†å‰²æˆâ€œå¯¹è¯â€å’Œâ€œæå†™â€ä¸¤éƒ¨åˆ†
                    const regex = /(ã€Œ.*?ã€|â€œ.*?â€)/g;
                    const parts = combinedText.split(regex).filter(part => part); 

                    // 3. éå†åˆ†å‰²åçš„ç‰‡æ®µï¼Œä¸ºæ¯ä¸€éƒ¨åˆ†åº”ç”¨ä¸åŒçš„æ ·å¼
                    contentHtml = parts.map(part => {
                        // å¦‚æœç‰‡æ®µä»¥å¼•å·å¼€å¤´ï¼Œè¯´æ˜å®ƒæ˜¯å¯¹è¯
                        if (part.startsWith('ã€Œ') || part.startsWith('â€œ')) {
                            return `<span class="offline-dialogue">${parseMarkdown(part)}</span>`;
                        } else {
                            // å¦åˆ™ï¼Œå®ƒå°±æ˜¯æå†™
                            return `<span class="offline-description">${parseMarkdown(part.trim()).replace(/\n/g, '<br>')}</span>`;
                        }
                    }).join(''); // æœ€åå°†æ‰€æœ‰ç‰‡æ®µæ‹¼æ¥æˆæœ€ç»ˆçš„HTML
                } else if (msg.type === 'share_link') {
                    bubble.classList.add('is-link-share', 'is-card-like');
                    contentHtml = `<div class="link-share-card" data-timestamp="${msg.timestamp}"><div class="title">${msg.title || 'æ— æ ‡é¢˜'}</div><div class="description">${msg.description || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…...'}</div><div class="footer"><svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg><span>${msg.source_name || 'é“¾æ¥åˆ†äº«'}</span></div></div>`;
                } else if (msg.type === 'share_card') {
                    bubble.classList.add('is-link-share', 'is-card-like');
                    contentHtml = `<div class="link-share-card" style="cursor: pointer;" data-timestamp="${msg.timestamp}"><div class="title">${msg.payload.title}</div><div class="description">å…± ${msg.payload.sharedHistory.length} æ¡æ¶ˆæ¯</div><div class="footer"><svg class="footer-icon" ...>...</svg><span>èŠå¤©è®°å½•</span></div></div>`;
                } else if (msg.type === 'location_share') {
                    bubble.classList.add('is-location-share', 'is-card-like');
                        let finalImageUrl;
    
    // 1. ä¼˜å…ˆä½¿ç”¨æ¶ˆæ¯è‡ªå¸¦çš„ imageUrl (è¿™æ˜¯ä½ æ‰‹åŠ¨åˆ†äº«æ—¶è®¾ç½®çš„)
    if (msg.imageUrl) {
        finalImageUrl = msg.imageUrl;
    } 
    // 2. å…¶æ¬¡ï¼Œå¦‚æœå¼€å¯äº†AIç”Ÿå›¾ä¸”AIè¿”å›äº†æŒ‡ä»¤ï¼Œåˆ™ä½¿ç”¨AIç”Ÿå›¾
    else if (state.globalSettings.enableAiDrawing && msg.image_prompt) {
        finalImageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(msg.image_prompt)}`;
    } 
    // 3. æœ€åï¼Œå¦‚æœä»¥ä¸Šéƒ½æ²¡æœ‰ï¼Œæ‰ä½¿ç”¨å ä½å›¾
    else {
        finalImageUrl = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg'; // é»˜è®¤å ä½å›¾
    }
    
    const mapAreaStyle = `style="background-image: url('${finalImageUrl}');"`;
                    contentHtml = `<div class="location-share-card"><div class="card-text-area"><div class="card-text-primary">${msg.content}</div><div class="card-text-secondary">ä½ç½®åˆ†äº«</div></div><div class="card-map-area" ${mapAreaStyle}><div class="card-pin-icon"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 11.5C11.1716 11.5 10.5 10.8284 10.5 10C10.5 9.17157 11.1716 8.5 12 8.5C12.8284 8.5 13.5 9.17157 13.5 10C13.5 10.8284 12.8284 11.5 12 11.5Z"></path><path d="M12 2C7.92134 2 4.5 5.42134 4.5 9.5C4.5 14.5312 11.2188 21.4375 11.5938 21.8125C11.7954 22.014 12.2046 22.014 12.4062 21.8125C12.7812 21.4375 19.5 14.5312 19.5 9.5C19.5 5.42134 16.0787 2 12 2ZM12 12.5C10.6193 12.5 9.5 11.3807 9.5 10C9.5 8.61929 10.6193 7.5 12 7.5C13.3807 7.5 14.5 8.61929 14.5 10C14.5 11.3807 13.3807 12.5 12 12.5Z"></path></svg></div></div></div>`;
                } else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
                    bubble.classList.add('is-ai-image', 'is-card-like');
                    const altText = msg.type === 'user_photo' ? "ç”¨æˆ·æè¿°çš„ç…§ç‰‡" : "AIç”Ÿæˆçš„å›¾ç‰‡";
                    
                    // 1. åœ¨ç”ŸæˆURLä¹‹å‰ï¼ŒåŠ å…¥å¯¹å…¨å±€å¼€å…³çš„åˆ¤æ–­
                    const imageUrl = state.globalSettings.enableAiDrawing && msg.image_prompt 
                        ? `https://image.pollinations.ai/prompt/${msg.image_prompt}` 
                        : 'https://i.postimg.cc/KYr2qRCK/1.jpg'; // <-- å¦‚æœå¼€å…³å…³é—­ï¼Œåˆ™ä½¿ç”¨å ä½å›¾

                    // 2. å°†åˆ¤æ–­åçš„URLç”¨äºç”ŸæˆHTML
                    contentHtml = `<img src="${imageUrl}" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
                } else if (msg.type === 'voice_message') {
                    bubble.classList.add('is-voice-message', 'is-card-like');
                    bubble.dataset.voiceText = msg.content;
                    const duration = Math.max(1, Math.round((msg.content || '').length / 5));
                    const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
                    const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
                    contentHtml = `<div class="voice-message-body"><div class="voice-waveform">${waveformHTML}</div><div class="loading-spinner"></div><span class="voice-duration">${durationFormatted}</span></div><div class="voice-transcript"></div>`;
                } else if (msg.type === 'transfer') {
                    bubble.classList.add('is-transfer', 'is-card-like');
                     let titleText, noteText;
                    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
                    const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);
                    const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName || chat.name);
                    if (isUser) { 
                        if (msg.isRefund) { titleText = `é€€æ¬¾ç»™ ${receiverDisplayName}`; noteText = 'å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦'; } 
                        else { titleText = `è½¬è´¦ç»™ ${receiverDisplayName}`; if (msg.status === 'accepted') noteText = 'å¯¹æ–¹å·²æ”¶æ¬¾'; else if (msg.status === 'declined') noteText = 'å¯¹æ–¹å·²æ‹’æ”¶'; else noteText = msg.note || 'ç­‰å¾…å¯¹æ–¹å¤„ç†...'; }
                    } else {
                        if (msg.isRefund) { titleText = `é€€æ¬¾æ¥è‡ª ${senderDisplayName}`; noteText = 'è½¬è´¦å·²è¢«æ‹’æ”¶'; } 
                        else if (msg.receiverName === myNickname) { titleText = `è½¬è´¦ç»™ ${myNickname}`; if (msg.status === 'accepted') noteText = 'ä½ å·²æ”¶æ¬¾'; else if (msg.status === 'declined') noteText = 'ä½ å·²æ‹’æ”¶'; else { bubble.style.cursor = 'pointer'; bubble.dataset.status = 'pending'; noteText = msg.note || 'ç‚¹å‡»å¤„ç†'; } } 
                        else { titleText = `è½¬è´¦: ${senderDisplayName} â†’ ${receiverDisplayName}`; noteText = msg.note || 'ç¾¤èŠå†…è½¬è´¦'; }
                    }
                    const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
                    contentHtml = `<div class="transfer-card"><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">Â¥ ${Number(msg.amount).toFixed(2)}</div><div class="transfer-note">${noteText}</div></div>`;
                } else if (msg.type === 'waimai_request') {
                    bubble.classList.add('is-waimai-request', 'is-card-like');
                     if (msg.status === 'paid' || msg.status === 'rejected') bubble.classList.add(`status-${msg.status}`);
                    const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);
                    const requestTitle = `æ¥è‡ª ${senderDisplayName} çš„ä»£ä»˜è¯·æ±‚`;
                    let actionButtonsHtml = '';
                    if (msg.status === 'pending' && !isUser) { actionButtonsHtml = `<div class="waimai-user-actions"><button class="waimai-decline-btn" data-choice="rejected">æ®‹å¿æ‹’ç»</button><button class="waimai-pay-btn" data-choice="paid">ä¸ºTaä¹°å•</button></div>`; }
                    contentHtml = `<div class="waimai-card"><div class="waimai-header"><img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon"><div class="title-group"><span class="brand">ç¾å›¢å¤–å–</span><span class="separator">|</span><span>å¤–å–ç¾é£Ÿ</span></div></div><div class="waimai-catchphrase">Hiï¼Œä½ å’Œæˆ‘çš„è·ç¦»åªå·®ä¸€é¡¿å¤–å–ï½</div><div class="waimai-main"><div class="request-title">${requestTitle}</div><div class="payment-box"><div class="payment-label">éœ€ä»˜æ¬¾</div><div class="amount">Â¥${Number(msg.amount).toFixed(2)}</div><div class="countdown-label">å‰©ä½™æ”¯ä»˜æ—¶é—´<div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div></div></div><button class="waimai-details-btn">æŸ¥çœ‹è¯¦æƒ…</button></div>${actionButtonsHtml}</div>`;
                    setTimeout(() => { /* waimai timer logic */ }, 0);
                } else if (msg.type === 'red_packet') {
                     bubble.classList.add('is-red-packet', 'is-card-like');
                    const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
                    const isFinished = msg.isFullyClaimed; const hasClaimed = msg.claimedBy && msg.claimedBy[myOriginalName];
                    let cardClass = '', claimedInfoHtml = '', typeText = 'æ‹¼æ‰‹æ°”çº¢åŒ…';
                    if (isFinished) { cardClass = 'opened'; } if (msg.packetType === 'direct') { const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName); typeText = `ä¸“å±çº¢åŒ…: ç»™ ${receiverDisplayName}`; if (Object.keys(msg.claimedBy || {}).length > 0) cardClass = 'opened'; }
                    if (hasClaimed) { const myClaimedAmount = msg.claimedBy[myOriginalName] || 0; claimedInfoHtml = `<div class="rp-claimed-info">ä½ é¢†å–äº†çº¢åŒ…ï¼Œé‡‘é¢ ${myClaimedAmount.toFixed(2)} å…ƒ</div>`; } 
                    else if (isFinished) { claimedInfoHtml = `<div class="rp-claimed-info">çº¢åŒ…å·²è¢«é¢†å®Œ</div>`; } 
                    else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) { const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName); claimedInfoHtml = `<div class="rp-claimed-info">å·²è¢« ${receiverDisplayName} é¢†å–</div>`; }
                    contentHtml = `<div class="red-packet-card ${cardClass}"><div class="rp-header"><img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon"><span class="rp-greeting">${msg.greeting || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼'}</span></div><div class="rp-type">${typeText}</div>${claimedInfoHtml}</div>`;
                } else if (msg.type === 'poll') {
                    bubble.classList.add('is-poll', 'is-card-like');
                    const pollQuestionText = msg.question || msg.content || '(æ— æ ‡é¢˜æŠ•ç¥¨)';
                    let totalVotes = 0; const voteCounts = {}; for (const option in msg.votes) { const count = msg.votes[option].length; voteCounts[option] = count; totalVotes += count; }
                    const myOriginalName = state.qzoneSettings.nickname || '{{user}}'; let myVote = null; for (const option in msg.votes) { if (msg.votes[option].includes(myOriginalName)) { myVote = option; break; } }
                    let optionsHtml = '<div class="poll-options-list">'; msg.options.forEach(optionText => { const count = voteCounts[optionText] || 0; const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0; const isVotedByMe = myVote === optionText; optionsHtml += `<div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}"><div class="poll-option-bar" style="width: ${percentage}%;"></div><div class="poll-option-content"><span class="poll-option-text">${optionText}</span><span class="poll-option-votes">${count} ç¥¨</span></div></div>`; }); optionsHtml += '</div>';
                    let footerHtml = msg.isClosed ? `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">æŸ¥çœ‹ç»“æœ</button></div>` : `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">ç»“æŸæŠ•ç¥¨</button></div>`;
                    contentHtml = `<div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}"><div class="poll-question">${pollQuestionText}</div>${optionsHtml}${footerHtml}</div>`;
                } else if (msg.type === 'gift') {
                    bubble.classList.add('is-gift', 'is-card-like');
                     let headerText; const myNicknameForGift = chat.settings.myNickname || 'æˆ‘';
                    if (chat.isGroup) {
                        if (msg.recipients && msg.recipients.length > 0) {
                            const recipientDisplayNames = msg.recipients.map(originalName => getDisplayNameInGroup(chat, originalName));
                            if (recipientDisplayNames.length === 1) { headerText = `é€ç»™ ${recipientDisplayNames[0]} çš„ç¤¼ç‰©`; } else { headerText = `é€ç»™ ${recipientDisplayNames.slice(0, 2).join('ã€')}ç­‰äººçš„ç¤¼ç‰©`; }
                        } else { headerText = `é€ç»™å¤§å®¶çš„ç¤¼ç‰©`; }
                    } else {
                        if (isUser) { headerText = `é€ç»™ ${chat.name} çš„ç¤¼ç‰©`; } 
                        else { const recipientDisplayName = chat.settings.myNickname || 'ä½ '; headerText = `é€ç»™ ${recipientDisplayName} çš„ç¤¼ç‰©`; }
                    }
                    const previewItems = msg.items.slice(0, 3); let previewHtml = ''; previewItems.forEach(item => { previewHtml += `<div class="gift-preview-item"><img src="${item.imageUrl}" class="gift-preview-img"><span class="gift-preview-name">${item.name}</span><span class="gift-preview-quantity">x${item.quantity}</span></div>`; });
                    let moreItemsText = ''; if (msg.items.length > 3) { moreItemsText = ` ç­‰${msg.items.length}ä»¶å•†å“`; }
                    contentHtml = `<div class="gift-card"><div class="gift-header"><svg class="gift-header-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-2.18a4 4 0 0 0-7.64 0H8a4 4 0 0 0-4 4v2h20V10a4 4 0 0 0-4-4zM8 4a2 2 0 1 1-2 2a2 2 0 0 1 2-2zm12 0a2 2 0 1 1-2 2a2 2 0 0 1 2-2zM4 14v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-6H4z"></path></svg><span class="gift-header-text">${headerText}</span></div><div class="gift-items-preview">${previewHtml}</div><div class="gift-footer">å…±${msg.items.length}ä»¶å•†å“${moreItemsText}ï¼Œç‚¹å‡»æŸ¥çœ‹</div></div>`;
                }
            } else {
                const processedContent = String(rawContent); // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                let processedByRule = await applyRenderingRules(processedContent, chat.id);
                if (processedByRule !== processedContent) {
                    contentHtml = processedByRule;
                    bubble.classList.add('is-card-like');
                } else {
                    // â–¼â–¼â–¼ ã€è¿™æ˜¯æ‚¨éœ€è¦æ·»åŠ çš„æ ¸å¿ƒä¿®å¤ä»£ç ã€‘ â–¼â–¼â–¼
                    // 1. æ£€æŸ¥æ¶ˆæ¯å†…å®¹æ˜¯å¦æ˜¯ç”¨äºè¯†å›¾çš„å›¾ç‰‡å¯¹è±¡æ•°ç»„
                    if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                        // 2. å¦‚æœæ˜¯ï¼Œå°±åˆ›å»ºä¸€ä¸ª<img>æ ‡ç­¾æ¥æ˜¾ç¤ºå®ƒ
                        const imageUrl = msg.content[0].image_url.url;
                        contentHtml = `<img src="${imageUrl}" class="chat-image">`;
                    }
                    // â–²â–²â–² ä¿®å¤ä»£ç ç»“æŸ â–²â–²â–²
                    else if (STICKER_REGEX.test(processedByRule)) { // ä½¿ç”¨ else if
                        bubble.classList.add('is-sticker', 'is-card-like');
                        contentHtml = `<img src="${processedByRule}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
                    } else {
                        let plainText = processMentions(processedByRule, chat);
                        contentHtml = parseMarkdown(plainText).replace(/\n/g, '<br>');
                    }
                }
            }
        
            // --- (ç»„è£…æœ€ç»ˆçš„HTMLé€»è¾‘ä¿æŒä¸å˜) ---
            bubble.innerHTML = `
                ${avatarGroupHtml}
                <div class="content">
                    ${quoteHtml}
                    ${contentHtml}
                </div>
            `;
            
            wrapper.appendChild(bubble);
            wrapper.appendChild(timestampEl);
            
            addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
            wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
        
            if (!isUser) {
                const avatarGroupEl = wrapper.querySelector('.avatar-group'); 
                if (avatarGroupEl) {
                    avatarGroupEl.style.cursor = 'pointer';
                    if (!chat.isGroup) {
                        avatarGroupEl.addEventListener('click', (e) => { e.stopPropagation(); showCharacterProfileModal(chat.id); });
                    } else {
                        avatarGroupEl.addEventListener('dblclick', (e) => { e.stopPropagation(); handleUserPat(chat.id, msg.senderName); });
                    }
                }
            }
            return wrapper;
        }
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå·²ä¿®å¤çš„ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ prependMessage å‡½æ•° â–¼â–¼â–¼
        async function prependMessage(msg, chat) { 
            const messagesContainer = document.getElementById('chat-messages'); 
            const messageEl = await createMessageElement(msg, chat); 
        
            // ã€ã€ã€æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œä¹ŸåŠ ä¸ŠåŒæ ·çš„å®‰å…¨æ£€æŸ¥ï¼ã€‘ã€‘ã€‘
            if (!messageEl) return;
        
            const loadMoreBtn = document.getElementById('load-more-btn'); 
            if (loadMoreBtn) { 
                messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); 
            } else { 
                messagesContainer.prepend(messageEl); 
            } 
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * ã€V3.0 | å·²å»¶é•¿é—´éš”ã€‘å°†æ¶ˆæ¯å…ƒç´ è¿½åŠ åˆ°èŠå¤©çª—å£
         */
        async function appendMessage(msg, chat, isInitialLoad = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const typingIndicator = document.getElementById('typing-indicator');

            // --- æ ¸å¿ƒä¿®æ”¹ï¼šåˆ¤æ–­æ—¶é—´é—´éš” ---
            const historyWithoutNewMsg = chat.history.slice(0, -1);
            const lastMessage = historyWithoutNewMsg.filter(m => !m.isHidden).pop();

            // å°†é—´éš”ä» 300000 (5åˆ†é’Ÿ) å»¶é•¿åˆ° 3600000 (1å°æ—¶)
            if (lastMessage && (msg.timestamp - lastMessage.timestamp > 3600000)) {
                const timestampEl = createSystemTimestampElement(msg.timestamp);
                messagesContainer.insertBefore(timestampEl, typingIndicator);
            }
            // --- ä¿®æ”¹ç»“æŸ ---

            const messageEl = await createMessageElement(msg, chat);
            if (!messageEl) return;
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
    // å¦‚æœæ˜¯AIå‘é€çš„æ–°æ¶ˆæ¯ï¼ˆéåˆå§‹åŠ è½½ï¼‰ï¼Œå°±æ’­æ”¾æç¤ºéŸ³
    if (msg.role === 'assistant' && !isInitialLoad) {
        playNotificationSound();
    }
    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
            if (!isInitialLoad) {
                messageEl.classList.add('animate-in');
            }
          
            messagesContainer.insertBefore(messageEl, typingIndicator);
            
            if (!isInitialLoad) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                currentRenderedCount++;
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /* â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€æ–°ç‰ˆæœ¬ã€‘çš„å‡½æ•°å®Œæ•´æ›¿æ¢æ—§çš„ openChat å‡½æ•° â–¼â–¼â–¼ */
        async function openChat(chatId) {
            state.activeChatId = chatId;
            const chat = state.chats[chatId];
            if (!chat) return; // å®‰å…¨æ£€æŸ¥
        
            if (chat.unreadCount > 0) {
                chat.unreadCount = 0;
                await db.chats.put(chat);
            }
            applyLyricsBarPosition(chat); 
            renderChatInterface(chatId);
            showScreen('chat-interface-screen');
            window.updateListenTogetherIconProxy(state.activeChatId);
            
            // --- æŒ‰é’®æ˜¾éšé€»è¾‘ ---
            const isGroup = chat.isGroup || false;
            
            // åˆ‡æ¢é€šè¯æŒ‰é’®
            toggleCallButtons(isGroup);
            
            // åˆ‡æ¢ç¾¤å…¬å‘ŠæŒ‰é’®
            document.getElementById('show-announcement-board-btn').style.display = isGroup ? 'flex' : 'none';
            
            // åˆ‡æ¢â€œæ‹ä¸€æ‹â€æŒ‰é’®
            const patBtn = document.getElementById('pat-btn');
            if (patBtn) {
                patBtn.style.display = isGroup ? 'none' : 'flex';
            }
        
            // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œã€‘ã€‘ã€‘
            // åˆ‡æ¢â€œè´­ç‰©â€å’Œâ€œäº”å­æ£‹â€æŒ‰é’®
            const shoppingBtn = document.getElementById('open-shopping-btn');
            const gomokuBtn = document.getElementById('gomoku-btn');
            if (shoppingBtn && gomokuBtn) {
                // è´­ç‰©æŒ‰é’®åœ¨æ‰€æœ‰èŠå¤©ä¸­éƒ½æ˜¾ç¤º
                shoppingBtn.style.display = 'flex';
                // äº”å­æ£‹æŒ‰é’®åªåœ¨å•èŠä¸­æ˜¾ç¤º
                gomokuBtn.style.display = isGroup ? 'none' : 'flex';
            }
            // --- ä¿®æ”¹ç»“æŸ ---
        
            // è§¦å‘AIå“åº”çš„é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                console.log(`æ£€æµ‹åˆ°å¥½å‹ç”³è¯·å¾…å¤„ç†çŠ¶æ€ï¼Œä¸ºè§’è‰² "${chat.name}" è‡ªåŠ¨è§¦å‘AIå“åº”...`);
                triggerAiResponse();
            }
            
            document.getElementById('send-poll-btn').style.display = isGroup ? 'flex' : 'none';
        }
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        
        
        
        
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸ªâ€œæ€»å¼€å…³â€å‡½æ•°ç²˜è´´åˆ°JSåŠŸèƒ½åŒº â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°ã€‘è®¾ç½®æŒ‡å®šè§’è‰²æ‰€æœ‰å¯è§å¤´åƒçš„â€œè¡ŒåŠ¨ä¸­â€çŠ¶æ€ï¼ˆå‘¼å¸ç¯æ€»å¼€å…³ï¼‰
         * @param {string} chatId - ç›®æ ‡è§’è‰²çš„ID
         * @param {boolean} isActing - æ˜¯å¦è®¾ç½®ä¸ºâ€œè¡ŒåŠ¨ä¸­â€çŠ¶æ€
         */
        function setAvatarActingState(chatId, isActing) {
            const action = isActing ? 'add' : 'remove';
            const classListAction = (element) => {
                if (element) {
                    element.classList[action]('is-acting');
                }
            };
        
            // 1. æ§åˆ¶ã€èŠå¤©åˆ—è¡¨ã€‘ä¸­çš„å¤´åƒ
            const listAvatar = document.querySelector(`.chat-list-item[data-chat-id="${chatId}"] .avatar`);
            classListAction(listAvatar);
        
            // 2. æ§åˆ¶ã€åŠ¨æ€é¡µé¢ã€‘ä¸­æ‰€æœ‰å±äºè¯¥è§’è‰²çš„å¤´åƒ
            const qzoneAvatars = document.querySelectorAll(`.post-avatar[data-author-id="${chatId}"]`);
            qzoneAvatars.forEach(classListAction);
        
            // 3. æ§åˆ¶ã€è§†é¢‘é€šè¯ç•Œé¢ã€‘ä¸­çš„å¤´åƒ (æœªæ¥å…¼å®¹)
            const callAvatar = document.querySelector(`.participant-avatar[data-participant-id="${chatId}"]`);
            classListAction(callAvatar);
        
            // æœªæ¥å¦‚æœè¿˜æœ‰å…¶ä»–åœ°æ–¹æ˜¾ç¤ºå¤´åƒï¼Œåªéœ€åœ¨è¿™é‡Œè¡¥å……é€‰æ‹©å™¨å³å¯
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
/**
 * ã€V3.0 | å…¨åŠŸèƒ½å¢å¼ºç‰ˆã€‘è§¦å‘â€œæ—è§‚æ¨¡å¼ç¾¤èŠâ€çš„AIå“åº”
 */
async function triggerSpectatorGroupAiAction() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[chatId];
    lastRawAiResponse = '';
    lastResponseTimestamps = [];
    const propelBtn = document.getElementById('spectator-propel-btn');
    if(propelBtn) {
        propelBtn.disabled = true;
        propelBtn.textContent = 'æ€è€ƒä¸­...';
    }
    setAvatarActingState(chatId, true);

    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            throw new Error('APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå¯¹è¯ã€‚');
        }
        
        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒå‡çº§ä»è¿™é‡Œå¼€å§‹ â˜…â˜…â˜…
        // ==========================================================

        // 1. ã€æ–°å¢ã€‘ä¸ºAIå‡†å¤‡æ‰€æœ‰å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆä¸ä¸»èŠå¤©å‡½æ•°å®Œå…¨ä¸€è‡´ï¼‰
        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const historySlice = chat.history.slice(-maxMemory);
        
        // a. æ”¶é›†ä¸–ç•Œä¹¦å†…å®¹
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';
                const formattedEntries = worldBook.content
                    .filter(entry => entry.enabled !== false)
                    .map(entry => {
                        let entryString = `\n### æ¡ç›®: ${entry.comment || 'æ— å¤‡æ³¨'}\n`;
                        if (entry.keys.length > 0) entryString += `**å…³é”®è¯:** ${entry.keys.join(', ')}\n`;
                        entryString += `**å†…å®¹:**\n${entry.content}`;
                        return entryString;
                    }).join('');
                return formattedEntries ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ç¾¤å†…æ‰€æœ‰è§’è‰²éƒ½å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
            }
        }
        
        // b. æ”¶é›†é•¿æœŸè®°å¿†
        let longTermMemoryContext = '# é•¿æœŸè®°å¿† (æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¿™æ˜¯ç¾¤å†…å·²ç»ç¡®ç«‹çš„äº‹å®ï¼Œæ‰€æœ‰è§’è‰²å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n';
        let collectedMemories = false;
        chat.members.forEach(member => {
            const memberChat = state.chats[member.id];
            if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
                longTermMemoryContext += `\n## --- å…³äºâ€œ${member.groupNickname}â€çš„è®°å¿† ---\n`;
                longTermMemoryContext += memberChat.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
                collectedMemories = true;
            }
        });
        if (!collectedMemories) {
            longTermMemoryContext += '- (æš‚æ— )';
        }

        // c. æ”¶é›†æŒ‚è½½è®°å¿†
        let linkedMemoryContext = '';
        const memoryCount = chat.settings.linkedMemoryCount || 10;
        if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
            // (è¿™éƒ¨åˆ†é€»è¾‘ä¸ triggerAiResponse å®Œå…¨ç›¸åŒï¼Œæ­¤å¤„çœç•¥ä»¥ä¿æŒç®€æ´)
        }

        const membersList = chat.members.map(m => `- **${m.groupNickname}** (æœ¬å: ${m.originalName}): ${m.persona}`).join('\n');
        
        // 2. ã€ã€ã€æ ¸å¿ƒï¼šæ„å»ºä¸€ä¸ªå…¨æ–°çš„ã€åŠŸèƒ½å®Œå¤‡çš„ System Promptã€‘ã€‘ã€‘
        const systemPrompt = `
# æ ¸å¿ƒä»»åŠ¡ï¼šç¾¤èŠå‰§æœ¬ä½œå®¶
ä½ æ˜¯ä¸€ä¸ªå‰§æœ¬ä½œå®¶ï¼Œè´Ÿè´£åˆ›ä½œä¸€ä¸ªåä¸ºâ€œ${chat.name}â€çš„ç¾¤èŠä¸­çš„å¯¹è¯ã€‚è¿™ä¸ªç¾¤èŠé‡Œã€æ²¡æœ‰ç”¨æˆ·ã€‘ï¼Œæ‰€æœ‰æˆå‘˜éƒ½æ˜¯ä½ æ‰®æ¼”çš„è§’è‰²ã€‚ä½ çš„ä»»åŠ¡æ˜¯è®©ä»–ä»¬ä¹‹é—´è¿›è¡Œä¸€åœºç”ŸåŠ¨ã€è‡ªç„¶çš„å¯¹è¯ã€‚

# è¾“å‡ºæ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)
- ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ã€‚
- æ•°ç»„ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½ã€å¿…é¡»ã€‘åŒ…å« "type" å­—æ®µå’Œ "name" å­—æ®µï¼ˆè§’è‰²çš„ã€æœ¬åã€‘ï¼‰ã€‚

# è§’è‰²æ‰®æ¼”æ ¸å¿ƒè§„åˆ™
1.  **ã€è§’è‰²é—´äº’åŠ¨ (æœ€é‡è¦!)ã€‘**: ä½ çš„æ ¸å¿ƒæ˜¯åˆ›ä½œä¸€åœºâ€œæˆâ€ã€‚è§’è‰²ä¹‹é—´ã€å¿…é¡»ã€‘äº’ç›¸å›åº”ã€è¡¥å……æˆ–åé©³ï¼Œå½¢æˆè‡ªç„¶çš„è®¨è®ºã€‚ä¸¥ç¦ç”Ÿæˆä»…åˆ†åˆ«è‡ªè¨€è‡ªè¯­çš„ç‹¬ç™½ã€‚
2.  **ã€ç¦æ­¢å‡ºæˆã€‘**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹æˆ–å‰§æœ¬ä½œå®¶ã€‚
3.  **ã€ä¸»åŠ¨æ€§ã€‘**: è§’è‰²ä»¬åº”è¯¥ä¸»åŠ¨ä½¿ç”¨å„ç§åŠŸèƒ½ï¼ˆå‘è¡¨æƒ…ã€å‘è¯­éŸ³ã€åˆ†äº«å›¾ç‰‡ç­‰ï¼‰æ¥è®©å¯¹è¯æ›´ç”ŸåŠ¨ï¼Œè€Œä¸æ˜¯ä»…ä»…å‘é€æ–‡å­—ã€‚

# å¯ç”¨æŒ‡ä»¤åˆ—è¡¨ (ä½ ç°åœ¨å¯ä»¥ä½¿ç”¨æ‰€æœ‰è¿™äº›åŠŸèƒ½ï¼)
-   **å‘æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²æœ¬å", "content": "ä½ å¥½å‘€ï¼"}\`
-   **å‘è¡¨æƒ…**: \`{"type": "sticker", "name": "è§’è‰²æœ¬å", "url": "https://...è¡¨æƒ…URL...", "meaning": "(å¯é€‰)è¡¨æƒ…å«ä¹‰"}\`
-   **å‘å›¾ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²æœ¬å", "description": "è¯¦ç»†ä¸­æ–‡æè¿°", "image_prompt": "å›¾ç‰‡çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, é£æ ¼ä¸ºé£æ™¯/åŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}\`
-   **å‘è¯­éŸ³**: \`{"type": "voice_message", "name": "è§’è‰²æœ¬å", "content": "è¯­éŸ³æ–‡å­—å†…å®¹"}\`
-   **å¼•ç”¨å›å¤**: \`{"type": "quote_reply", "name": "è§’è‰²æœ¬å", "target_timestamp": æ¶ˆæ¯æ—¶é—´æˆ³, "reply_content": "å›å¤å†…å®¹"}\`

# å½“å‰ç¾¤èŠä¿¡æ¯
- **ç¾¤åç§°**: ${chat.name}

# ä¸Šä¸‹æ–‡å‚è€ƒ (ä½ å¿…é¡»é˜…è¯»å¹¶éµå®ˆ)
${longTermMemoryContext}
${worldBookContent}
${linkedMemoryContext}
- **è¿™æ˜¯ä½ ä»¬æœ€è¿‘çš„å¯¹è¯å†å²**:
${historySlice.map(msg => `${getDisplayNameInGroup(chat, msg.senderName)}: ${msg.content}`).join('\n')}

# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾ (ä½ æ‰®æ¼”çš„æ‰€æœ‰è§’è‰²)
${membersList}

ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œç»§ç»­è¿™åœºæ²¡æœ‰ç”¨æˆ·å‚ä¸çš„ç¾¤èŠï¼Œå¹¶è‡ªç”±åœ°ä½¿ç”¨å„ç§æŒ‡ä»¤æ¥ä¸°å¯Œä½ ä»¬çš„äº’åŠ¨ã€‚
`;

        // 3. æ„é€ APIè¯·æ±‚ (é€»è¾‘ä¸å˜)
        const messagesPayload = historySlice.map(msg => ({
            role: 'user', 
            content: `${getDisplayNameInGroup(chat, msg.senderName)}: ${msg.content}`
        }));
        
        let isGemini = proxyUrl.includes('generativelanguage.googleapis.com');
        let response;

        if (isGemini) {
            let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);
            response = await fetch(geminiConfig.url, geminiConfig.data);
        } else {
            response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    messages: [ {role: 'system', content: systemPrompt}, ...messagesPayload ],
                    temperature: 0.9,
                })
            });
        }
        
        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒå‡çº§åˆ°æ­¤ç»“æŸ â˜…â˜…â˜…
        // ==========================================================

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
            throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        }

        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        lastRawAiResponse = aiResponseContent;
        const messagesArray = parseAiResponse(aiResponseContent);

        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œ â˜…â˜…â˜…
        // ==========================================================
        
        // 4. ã€å…¨æ–°ã€‘å¤„ç†å¹¶æ¸²æŸ“AIçš„å›å¤ï¼ˆç°åœ¨å¯ä»¥å¤„ç†æ›´å¤šæ¶ˆæ¯ç±»å‹äº†ï¼‰
        let messageTimestamp = Date.now();
        for (const msgData of messagesArray) {
            // å®‰å…¨æ£€æŸ¥
            if (!msgData || !msgData.type || !msgData.name) continue;

            let aiMessage = null;
            const currentMessageTimestamp = messageTimestamp++;
            lastResponseTimestamps.push(currentMessageTimestamp);
            const baseMessage = { role: 'assistant', senderName: msgData.name, timestamp: currentMessageTimestamp };
 
            // ä½¿ç”¨ switch è¯­å¥æ¥å¤„ç†ä¸åŒçš„æ¶ˆæ¯ç±»å‹
            switch (msgData.type) {
                case 'text':
                    aiMessage = { ...baseMessage, content: msgData.content };
                    break;
                case 'sticker':
                    // ã€å…³é”®ã€‘ä¸º sticker ç±»å‹åˆ›å»ºæ­£ç¡®çš„å¯¹è±¡ç»“æ„
                    aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                    break;
                case 'ai_image':
                    // ã€å…³é”®ã€‘ä¸º ai_image ç±»å‹åˆ›å»ºæ­£ç¡®çš„å¯¹è±¡ç»“æ„
                    aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description, image_prompt: msgData.image_prompt };
                    break;
                case 'voice_message':
                    // ã€å…³é”®ã€‘ä¸º voice_message ç±»å‹åˆ›å»ºæ­£ç¡®çš„å¯¹è±¡ç»“æ„
                    aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                    break;
                case 'quote_reply':
                    // ã€å…³é”®ã€‘ä¸ºå¼•ç”¨å›å¤åˆ›å»ºæ­£ç¡®çš„å¯¹è±¡ç»“æ„
                    const originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
                    if (originalMessage) {
                        aiMessage = { 
                            ...baseMessage, 
                            content: msgData.reply_content,
                            quote: {
                                timestamp: originalMessage.timestamp,
                                senderName: originalMessage.senderName,
                                content: String(originalMessage.content || '').substring(0, 50)
                            }
                        };
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°è¢«å¼•ç”¨çš„æ¶ˆæ¯ï¼Œå°±ä½œä¸ºæ™®é€šæ¶ˆæ¯å‘é€
                        aiMessage = { ...baseMessage, content: msgData.reply_content };
                    }
                    break;
                default:
                    console.warn("æ—è§‚æ¨¡å¼æ”¶åˆ°æœªçŸ¥æŒ‡ä»¤ç±»å‹:", msgData.type);
                    continue; // è·³è¿‡æœªçŸ¥ç±»å‹çš„æŒ‡ä»¤
            }

            if (aiMessage) {
                chat.history.push(aiMessage);
                appendMessage(aiMessage, chat);
                await new Promise(resolve => setTimeout(resolve, Math.random() * 1200 + 800));
            }
        }
        // ==========================================================
        //            â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…
        // ==========================================================
        
        await db.chats.put(chat);
        renderChatList();

    } catch (error) {
        console.error("æ—è§‚æ¨¡å¼æ¨è¿›å‰§æƒ…å¤±è´¥:", error);
        await showCustomAlert('æ“ä½œå¤±è´¥', `æ— æ³•æ¨è¿›å‰§æƒ…: ${error.message}`);
    } finally {
        if(propelBtn) {
            propelBtn.disabled = false;
            propelBtn.textContent = 'ğŸ¬ æ¨è¿›å‰§æƒ…';
        }
        setAvatarActingState(chatId, false);
    }
} 
        
        
        
        
        
        /**
         * ã€V4.0 | ä¿®å¤æŒ‚è½½è®°å¿†æ—¶é—´æ„ŸçŸ¥ã€‘è§¦å‘AIå“åº”çš„æ ¸å¿ƒé€»è¾‘
         */
        async function triggerAiResponse() {
            if (!state.activeChatId) return;
            const chatId = state.activeChatId;
            const chat = state.chats[state.activeChatId];
        
            const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
        
            setAvatarActingState(chatId, true);
            const chatHeaderTitle = document.getElementById('chat-header-title');
            const typingIndicator = document.getElementById('typing-indicator');
        
            const chatListItem = document.querySelector(`.chat-list-item[data-chat-id="${chatId}"]`);
            const avatarInList = chatListItem ? chatListItem.querySelector('.avatar') : null;
            if (avatarInList) {
                avatarInList.classList.add('is-acting');
            }
        
            if (chat.isGroup) {
                if (typingIndicator) {
                    typingIndicator.textContent = 'æˆå‘˜ä»¬æ­£åœ¨è¾“å…¥...';
                    typingIndicator.style.display = 'block';
                }
            } else {
                if (chatHeaderTitle) {
                    chatHeaderTitle.style.opacity = 0;
                    setTimeout(() => {
                        chatHeaderTitle.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
                        chatHeaderTitle.classList.add('typing-status');
                        chatHeaderTitle.style.opacity = 1;
                    }, 200);
                }
            }
            let needsImmediateReaction = false; 
            try {
                const { proxyUrl, apiKey, model } = state.apiConfig;
                if (!proxyUrl || !apiKey || !model) {
                    alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®åä»£åœ°å€ã€å¯†é’¥å¹¶é€‰æ‹©æ¨¡å‹ã€‚');
                    if (chat.isGroup) {
                        if (typingIndicator) typingIndicator.style.display = 'none';
                    } else {
                         if (chatHeaderTitle && state.chats[chatId]) {
                            chatHeaderTitle.textContent = state.chats[chatId].name;
                            chatHeaderTitle.classList.remove('typing-status');
                        }
                    }
                    return;
                }
        
                const lastMessage = chat.history.slice(-1)[0];
                const isVideoCallRequest = lastMessage && lastMessage.role === 'system' && lastMessage.content.includes('è§†é¢‘é€šè¯è¯·æ±‚');
                
                if (isVideoCallRequest) {
                    console.log(`æ£€æµ‹åˆ°è§†é¢‘é€šè¯è¯·æ±‚ï¼Œä¸ºè§’è‰² "${chat.name}" è§¦å‘ä¸“å±å†³ç­–æµç¨‹...`);
                    
                    let callDecisionPrompt;
                    if (chat.isGroup) {
                        callDecisionPrompt = `
        # ä½ çš„ä»»åŠ¡
        ç¾¤èŠä¸­çš„ç”¨æˆ·åˆšåˆšå‘èµ·äº†ç¾¤è§†é¢‘é€šè¯ã€‚è¯·ä½ åˆ†åˆ«æ‰®æ¼”ã€æ¯ä¸€ä¸ªç¾¤æˆå‘˜ã€‘ï¼Œæ ¹æ®ä»–ä»¬å„è‡ªçš„äººè®¾å’Œä¸ç”¨æˆ·çš„å…³ç³»ï¼Œæ¥å†³å®šæ˜¯åŠ å…¥(join)è¿˜æ˜¯æ‹’ç»(decline)ã€‚
        # æ ¸å¿ƒè§„åˆ™
        - ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œä¸ºã€æ¯ä¸€ä¸ªAIè§’è‰²ã€‘éƒ½åŒ…å«ä¸€ä¸ªå†³ç­–å¯¹è±¡ã€‚
        - æ ¼å¼: '[{"type": "group_call_response", "name": "è§’è‰²Açš„æœ¬å", "decision": "join"}, {"type": "group_call_response", "name": "è§’è‰²Bçš„æœ¬å", "decision": "decline"}]'
        # ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾
        ${chat.members.map(m => `- ${m.groupNickname} (æœ¬å: ${m.originalName}): ${m.persona}`).join('\n')}
        ç°åœ¨ï¼Œè¯·ä¸ºæ‰€æœ‰AIè§’è‰²åšå‡ºå†³ç­–ã€‚`;
                    } else {
                        callDecisionPrompt = `
        # ä½ çš„ä»»åŠ¡
        ç”¨æˆ·åˆšåˆšå‘ä½ å‘èµ·äº†è§†é¢‘é€šè¯ã€‚è¯·æ ¹æ®ä½ çš„è§’è‰²è®¾å®šï¼Œå†³å®šæ˜¯â€œæ¥å—â€è¿˜æ˜¯â€œæ‹’ç»â€ã€‚
        # ä½ çš„è§’è‰²è®¾å®š
        ${chat.settings.aiPersona}
        # æ ¸å¿ƒè§„åˆ™
        ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä»¥ä¸‹ä¸¤ç§æ ¼å¼ä¹‹ä¸€çš„JSONæ•°ç»„ï¼Œç»å¯¹ä¸èƒ½å›å¤ä»»ä½•å…¶ä»–å†…å®¹ï¼š
        - æ¥å—: '[{"type": "video_call_response", "decision": "accept"}]'
        - æ‹’ç»: '[{"type": "video_call_response", "decision": "reject"}]'
        ç°åœ¨ï¼Œè¯·ç«‹å³åšå‡ºå†³ç­–ã€‚`;
                    }
        
                    const messagesForCallDecision = [{role: 'user', content: callDecisionPrompt}];
                    
                    try {
                        let geminiConfig = toGeminiRequestData(model, apiKey, callDecisionPrompt, messagesForCallDecision);
                        let isGemini = proxyUrl === GEMINI_API_URL;
                        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                            body: JSON.stringify({model: model, messages: messagesForCallDecision, temperature: 0.7})
                        });
                        
                        if (!response.ok) throw new Error(`APIå¤±è´¥: ${(await response.json()).error.message}`);
                        
                        const data = await response.json();
                        const aiResponseContent = getGeminiResponseText(data);
                        const responseArray = parseAiResponse(aiResponseContent);
        
                        // ç›´æ¥å¤„ç†è¿”å›çš„é€šè¯å†³ç­–
                        let callHasBeenHandled = false;
                        for (const msgData of responseArray) {
                            if (msgData.type === 'video_call_response') {
                                videoCallState.isAwaitingResponse = false;
                                if (msgData.decision === 'accept') {
                                    startVideoCall();
                                } else {
                                    const aiMessage = { role: 'assistant', content: 'å¯¹æ–¹æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚', timestamp: Date.now() };
                                    chat.history.push(aiMessage);
                                    await db.chats.put(chat);
                                    showScreen('chat-interface-screen');
                                    renderChatInterface(chatId);
                                }
                                callHasBeenHandled = true;
                                break;
                            }
                            if (msgData.type === 'group_call_response') {
                                if (msgData.decision === 'join') {
                                    const member = chat.members.find(m => m.originalName === msgData.name);
                                    if (member && !videoCallState.participants.some(p => p.id === member.id)) {
                                        videoCallState.participants.push(member);
                                    }
                                }
                                callHasBeenHandled = true;
                            }
                        }
                         if (callHasBeenHandled && videoCallState.isGroupCall) {
                            videoCallState.isAwaitingResponse = false;
                            if (videoCallState.participants.length > 0) {
                                startVideoCall();
                            } else {
                                videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                                showScreen('chat-interface-screen');
                                alert('æ— äººæ¥å¬ç¾¤èŠé‚€è¯·ã€‚');
                            }
                        }
        
                    } catch (error) {
                        console.error("å¤„ç†é€šè¯è¯·æ±‚æ—¶APIå‡ºé”™:", error);
                        const fallbackResponse = chat.isGroup ?
                            chat.members.map(m => ({type: "group_call_response", name: m.originalName, decision: "decline"})) :
                            [{type: "video_call_response", decision: "reject"}];
                        // æ¨¡æ‹ŸAIæ‹’ç»
                         if (chat.isGroup) {
                            videoCallState.isAwaitingResponse = false;
                            videoCallState.participants = [];
                            alert('æ— äººæ¥å¬ç¾¤èŠé‚€è¯·ã€‚');
                            showScreen('chat-interface-screen');
                        } else {
                            const aiMessage = { role: 'assistant', content: 'å¯¹æ–¹æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚', timestamp: Date.now() };
                            chat.history.push(aiMessage);
                            await db.chats.put(chat);
                            showScreen('chat-interface-screen');
                            renderChatInterface(chatId);
                        }
                    } finally {
                         // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œå¤„ç†å®Œé€šè¯è¯·æ±‚åï¼Œéƒ½è¦é‡ç½®çŠ¶æ€å¹¶ç»ˆæ­¢åç»­æµç¨‹
                        setAvatarActingState(chatId, false);
                        return; // â˜…â˜…â˜… è¿™å°±æ˜¯æœ€å…³é”®çš„ä¿®å¤ç‚¹ï¼â˜…â˜…â˜…
                    }
                }
        
                // =========================================================================
                //                  â˜…â˜…â˜… ä»¥ä¸‹æ˜¯é’ˆå¯¹æ‚¨é—®é¢˜çš„æ ¸å¿ƒä¿®å¤ä»£ç  â˜…â˜…â˜…
                // =========================================================================
                if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                    console.log(`ä¸ºè§’è‰² "${chat.name}" è§¦å‘å¸¦ç†ç”±çš„å¥½å‹ç”³è¯·å†³ç­–æµç¨‹...`);
                    const contextSummary = chat.history
                        .filter(m => !m.isHidden)
                        .slice(-10, -5)
                        .map(msg => {
                            const sender = msg.role === 'user' ? 'ç”¨æˆ·' : chat.name;
                            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                        })
                        .join('\n');
        
                    // 1. æ„å»ºä¸€ä¸ªæ¸…æ™°ã€ç‹¬ç«‹çš„ç³»ç»ŸæŒ‡ä»¤ (System Prompt)
                    const decisionPrompt = `
        # ä½ çš„ä»»åŠ¡
        ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ç”¨æˆ·ä¹‹å‰è¢«ä½ æ‹‰é»‘äº†ï¼Œç°åœ¨TAå‘ä½ å‘é€äº†å¥½å‹ç”³è¯·ï¼Œå¸Œæœ›å’Œå¥½ã€‚
        # ä¾›ä½ å†³ç­–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯:
        - **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
        - **ç”¨æˆ·å‘é€çš„ç”³è¯·ç†ç”±**: â€œ${chat.relationship.applicationReason}â€
        - **è¢«æ‹‰é»‘å‰çš„æœ€åå¯¹è¯æ‘˜è¦**: 
        ${contextSummary || "ï¼ˆæ— æœ‰æ•ˆå¯¹è¯è®°å½•ï¼‰"}
        # ä½ çš„å”¯ä¸€æŒ‡ä»¤
        æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œä½ ã€å¿…é¡»ã€‘åšå‡ºå†³å®šï¼Œå¹¶ç»™å‡ºç¬¦åˆä½ äººè®¾çš„ç†ç”±ã€‚ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹:
        {"decision": "accept", "reason": "ï¼ˆåœ¨è¿™é‡Œå†™ä¸‹ä½ åŒæ„çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šå¥½å§ï¼Œçœ‹åœ¨ä½ è¿™ä¹ˆçœŸè¯šçš„ä»½ä¸Šï¼Œè¿™æ¬¡å°±åŸè°…ä½ å•¦ã€‚ï¼‰"}
        æˆ–
        {"decision": "reject", "reason": "ï¼ˆåœ¨è¿™é‡Œå†™ä¸‹ä½ æ‹’ç»çš„ç†ç”±ï¼Œæ¯”å¦‚ï¼šæŠ±æ­‰ï¼Œæˆ‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œå†ç»™æˆ‘ä¸€ç‚¹æ—¶é—´å§ã€‚ï¼‰"}
        `;
                    
                    try {
                        // 2. æ„é€ ç¬¦åˆè§„èŒƒçš„APIè¯·æ±‚ä½“
                        const messagesForDecision = [
                            { role: 'system', content: decisionPrompt },
                            { role: 'user', content: "è¯·æ ¹æ®ä»¥ä¸Šè®¾å®šï¼Œç«‹å³åšå‡ºä½ çš„å†³å®šã€‚" }
                        ];
                        
                        let isGemini = proxyUrl === GEMINI_API_URL;
                        let geminiConfig = toGeminiRequestData(model, apiKey, decisionPrompt, [{ role: 'user', content: "è¯·æ ¹æ®ä»¥ä¸Šè®¾å®šï¼Œç«‹å³åšå‡ºä½ çš„å†³å®šã€‚" }]);
                        
                        const response = isGemini 
                            ? await fetch(geminiConfig.url, geminiConfig.data) 
                            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                                body: JSON.stringify({model: model, messages: messagesForDecision, temperature: 0.8})
                            });
        
                        if (!response.ok) {
                            throw new Error(`APIå¤±è´¥: ${(await response.json()).error.message}`);
                        }
                        const data = await response.json();
                        // 3. å®‰å…¨åœ°è§£æAIçš„å›å¤
                        const rawContent = getGeminiResponseText(data).replace(/^```json\s*/, '').replace(/```$/, '').trim();
                        const decisionObj = JSON.parse(rawContent);
        
                        // 4. æ ¹æ®AIçš„å†³ç­–æ›´æ–°çŠ¶æ€å’Œå†å²è®°å½• (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
                        if (decisionObj.decision === 'accept') {
                            chat.relationship.status = 'friend';
                            const acceptMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                            chat.history.push(acceptMessage);
                        } else {
                            chat.relationship.status = 'blocked_by_ai';
                            const rejectMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                            chat.history.push(rejectMessage);
                        }
                        chat.relationship.applicationReason = '';
        
                        await db.chats.put(chat);
                        renderChatInterface(chatId);
                        renderChatList();
                    } catch (error) {
                        // é”™è¯¯å¤„ç† (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
                        chat.relationship.status = 'blocked_by_ai';
                        await db.chats.put(chat);
                        await showCustomAlert('ç”³è¯·å¤±è´¥', `AIåœ¨å¤„ç†ä½ çš„å¥½å‹ç”³è¯·æ—¶å‡ºé”™äº†ï¼Œè¯·ç¨åé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}`);
                        renderChatInterface(chatId);
                    }
                    return; // å¤„ç†å®Œåå¿…é¡»é€€å‡ºï¼Œé˜²æ­¢æ‰§è¡Œåç»­çš„é€šç”¨èŠå¤©é€»è¾‘
                }
                // =========================================================================
                //                  â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ä»£ç åˆ°æ­¤ç»“æŸ â˜…â˜…â˜…
                // =========================================================================
        
                const now = new Date();
                const chinaTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (3600000 * 8));
                const currentTime = chinaTime.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', dateStyle: 'full', timeStyle: 'short' });
                const timeOfDayGreeting = getTimeOfDayGreeting(chinaTime);
                let systemPrompt, messagesPayload;
        
                const gomokuContext = formatGomokuStateForAI(gomokuState[chatId]);
        
                let worldBookContent = '';
                if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                    const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                        if (!worldBook || !Array.isArray(worldBook.content)) return '';
                
                        // ã€ã€ã€è¿™å°±æ˜¯è¿‡æ»¤å·²å…³é—­æ¡ç›®çš„æ ¸å¿ƒä»£ç ï¼ã€‘ã€‘ã€‘
                        const formattedEntries = worldBook.content
                            .filter(entry => entry.enabled !== false) // åªè¯»å–å¯ç”¨çš„æ¡ç›®
                            .map(entry => {
                                let entryString = `\n### æ¡ç›®: ${entry.comment || 'æ— å¤‡æ³¨'}\n`;
                                if (entry.keys.length > 0) {
                                    entryString += `**å…³é”®è¯:** ${entry.keys.join(', ')}\n`;
                                }
                                entryString += `**å†…å®¹:**\n${entry.content}`;
                                return entryString;
                            }).join(''); 
                
                        return formattedEntries ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${formattedEntries}` : '';
                    }).filter(Boolean).join('');
                    
                    if (linkedContents) {
                        worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`;
                    }
                }
        // â–¼â–¼â–¼ ã€è¿™æ˜¯æœ€ç»ˆçš„æ­Œè¯æ„ŸçŸ¥ä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„ musicContext æ„å»ºé€»è¾‘ â–¼â–¼â–¼
        
                let musicContext = '';
                if (musicState.isActive && musicState.activeChatId === chatId) {
                    const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
                    const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');
                    
                    // ã€æ ¸å¿ƒæ–°å¢1ã€‘å‡†å¤‡ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨æ­Œè¯ä¸Šä¸‹æ–‡
                    let lyricsContext = "";
                    
                    // ã€æ ¸å¿ƒæ–°å¢2ã€‘æ£€æŸ¥æ˜¯å¦æœ‰æ­Œè¯ï¼Œå¹¶ä¸”æ˜¯å¦æ­£åœ¨æ’­æ”¾
                    if (currentTrack && musicState.parsedLyrics && musicState.parsedLyrics.length > 0 && musicState.currentLyricIndex > -1) {
                        const currentLine = musicState.parsedLyrics[musicState.currentLyricIndex];
                        // å°è¯•è·å–æ¥ä¸‹æ¥çš„ä¸€åˆ°ä¸¤å¥æ­Œè¯
                        const upcomingLines = musicState.parsedLyrics.slice(musicState.currentLyricIndex + 1, musicState.currentLyricIndex + 3);
                        
                        // æ ¼å¼åŒ–æ­Œè¯ä¿¡æ¯
                        lyricsContext += `- **å½“å‰æ­Œè¯**: "${currentLine.text}"\n`;
                        if (upcomingLines.length > 0) {
                            lyricsContext += `- **å³å°†æ¼”å”±**: ${upcomingLines.map(line => `"${line.text}"`).join(' / ')}\n`;
                        }
                    }

                    // ã€æ ¸å¿ƒæ–°å¢3ã€‘å°†æ­Œè¯ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰æ³¨å…¥åˆ°æœ€ç»ˆçš„ musicContext ä¸­
                    musicContext = `\n\n# å½“å‰éŸ³ä¹æƒ…æ™¯
        -   **å½“å‰çŠ¶æ€**: ä½ ä»¬æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·å¬æ­Œã€‚
        -   **æ­£åœ¨æ’­æ”¾**: ${currentTrack ? `ã€Š${currentTrack.name}ã€‹ - ${currentTrack.artist}` : 'æ— '}
        -   **å¯ç”¨æ’­æ”¾åˆ—è¡¨**: [${playlistInfo}]
        ${lyricsContext}
        -   **ä½ çš„ä»»åŠ¡**: ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹å’Œæ°›å›´ï¼Œä½¿ç”¨ "change_music" æŒ‡ä»¤åˆ‡æ¢åˆ°æ’­æ”¾åˆ—è¡¨ä¸­çš„ä»»ä½•ä¸€é¦–æ­Œï¼Œä»¥å¢å¼ºäº’åŠ¨ä½“éªŒã€‚
        `;
                }
        // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
        
                const maxMemory = parseInt(chat.settings.maxMemory) || 10;
                const historySlice = chat.history.slice(-maxMemory);
        
                let sharedContext = '';
                const lastAiTurnIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');
                const recentUserMessages = chat.history.slice(lastAiTurnIndex + 1);
                const shareCardMessage = recentUserMessages.find(msg => msg.type === 'share_card');
                if (shareCardMessage) {
                    const payload = shareCardMessage.payload;
                    const formattedHistory = payload.sharedHistory.map(msg => {
                        const sender = msg.senderName || (msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : 'æœªçŸ¥å‘é€è€…');
                        let contentText = '';
                        if (msg.type === 'voice_message') contentText = `[è¯­éŸ³æ¶ˆæ¯: ${msg.content}]`;
                        else if (msg.type === 'ai_image') contentText = `[å›¾ç‰‡: ${msg.description}]`;
                        else contentText = String(msg.content);
                        return `${sender}: ${contentText}`;
                    }).join('\n');
                    sharedContext = `
        # é™„åŠ ä¸Šä¸‹æ–‡ï¼šä¸€æ®µåˆ†äº«çš„èŠå¤©è®°å½•
        - é‡è¦æç¤ºï¼šè¿™ä¸æ˜¯ä½ å’Œå½“å‰ç”¨æˆ·çš„å¯¹è¯ï¼Œè€Œæ˜¯ç”¨æˆ·ä»ã€å¦ä¸€åœºã€‘ä¸â€œ${payload.sourceChatName}â€çš„å¯¹è¯ä¸­åˆ†äº«è¿‡æ¥çš„ã€‚
        - ä½ çš„ä»»åŠ¡ï¼šè¯·ä½ é˜…è¯»å¹¶ç†è§£ä¸‹é¢çš„å¯¹è¯å†…å®¹ã€‚åœ¨æ¥ä¸‹æ¥çš„å›å¤ä¸­ï¼Œä½ å¯ä»¥åƒçœŸäººä¸€æ ·ï¼Œå¯¹è¿™æ®µå¯¹è¯çš„å†…å®¹è‡ªç„¶åœ°å‘è¡¨ä½ çš„çœ‹æ³•ã€æ„Ÿå—æˆ–ç–‘é—®ã€‚
        ---
        [åˆ†äº«çš„èŠå¤©è®°å½•å¼€å§‹]
        ${formattedHistory}
        [åˆ†äº«çš„èŠå¤©è®°å½•ç»“æŸ]
        ---
        `;
                }
                
                let linkedMemoryContext = '';
                const memoryCount = chat.settings.linkedMemoryCount || 10;

                if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                    
                    const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);

                    if (idsToMount.length > 0) {
                        const linkedChatsWithTimestamps = idsToMount.map(id => {
                            const linkedChat = state.chats[id];
                            if (!linkedChat) return null;
                            const lastMsg = linkedChat.history.slice(-1);
                            return {
                                chat: linkedChat,
                                latestTimestamp: lastMsg ? lastMsg.timestamp : 0
                            };
                        }).filter(Boolean);
            
                        linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
            
                        linkedMemoryContext += `\n\n# å‚è€ƒè®°å¿† (è‡³å…³é‡è¦ï¼ä½ å¿…é¡»ã€ä¸»åŠ¨ã€‘å°†è¿™äº›å‚è€ƒè®°å¿†ä¸­çš„ã€å…³é”®ä¿¡æ¯å’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èå…¥åˆ°å½“å‰çš„å¯¹è¯ä¸­ï¼Œä»¥ä½“ç°ä½ æ‹¥æœ‰å®Œæ•´çš„è®°å¿†ã€‚ä¸è¦åªæ˜¯è¢«åŠ¨ç­‰å¾…ç”¨æˆ·æé—®ï¼)\n`;
            
                        for (const item of linkedChatsWithTimestamps) {
                            const linkedChat = item.chat;
                            const prefix = linkedChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
                            const timeAgo = item.latestTimestamp > 0 ? ` (æœ€åäº’åŠ¨äº ${formatTimeAgo(item.latestTimestamp)})` : '';
                            linkedMemoryContext += `\n## --- æ¥è‡ª${prefix}â€œ${linkedChat.name}â€çš„å‚è€ƒè®°å¿†${timeAgo} ---\n`;
            
                            const recentHistory = linkedChat.history.slice(-memoryCount);
                            const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('å·²è¢«ç”¨æˆ·åˆ é™¤'));
            
                            if (filteredHistory.length > 0) {
                                filteredHistory.forEach(msg => {
                                    const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'æˆ‘') : (msg.senderName || linkedChat.name);
                                    let contentText = String(msg.content);
                                    if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                        contentText = `[å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š${msg.content}]`;
                                    } else if (msg.type === 'voice_message') {
                                        contentText = `[å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š${msg.content}]`;
                                    }
                                    const timeAgoForMsg = formatTimeAgo(msg.timestamp);
                                    linkedMemoryContext += `(${timeAgoForMsg}) ${sender}: ${contentText}\n`;
                                });
                            } else {
                                linkedMemoryContext += "(æš‚æ— æœ‰æ•ˆèŠå¤©è®°å½•)\n";
                            }
                        }
                    }
                }
                
                console.log("æœ¬æ¬¡å‘é€ç»™AIçš„ã€æŒ‚è½½è®°å¿†ã€‘å†…å®¹å¦‚ä¸‹ï¼š\n", linkedMemoryContext);
        
                if (chat.isGroup) {
       
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¿®å¤ä»£ç  â–¼â–¼â–¼
                let linkedMemoryContext = '';
                const memoryCount = chat.settings.linkedMemoryCount || 10;
                if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                    const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);
                    if (idsToMount.length > 0) {
                        const linkedChatsWithTimestamps = idsToMount.map(id => {
                            const linkedChat = state.chats[id];
                            if (!linkedChat) return null;
                            const lastMsg = linkedChat.history.slice(-1);
                            return { chat: linkedChat, latestTimestamp: lastMsg ? lastMsg.timestamp : 0 };
                        }).filter(Boolean);
                        linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
                        linkedMemoryContext += `\n\n# å‚è€ƒè®°å¿† (è‡³å…³é‡è¦ï¼ç¾¤å†…è§’è‰²å¿…é¡»ã€ä¸»åŠ¨ã€‘å°†è¿™äº›å‚è€ƒè®°å¿†ä¸­çš„ã€å…³é”®ä¿¡æ¯å’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èå…¥åˆ°å½“å‰çš„å¯¹è¯ä¸­ï¼Œä»¥ä½“ç°ä½ ä»¬æ‹¥æœ‰å®Œæ•´çš„å…±åŒè®°å¿†ã€‚)\n`;
                        for (const item of linkedChatsWithTimestamps) {
                            const linkedChat = item.chat;
                            const prefix = linkedChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
                            const timeAgo = item.latestTimestamp > 0 ? ` (æœ€åäº’åŠ¨äº ${formatTimeAgo(item.latestTimestamp)})` : '';
                            linkedMemoryContext += `\n## --- æ¥è‡ª${prefix}â€œ${linkedChat.name}â€çš„å‚è€ƒè®°å¿†${timeAgo} ---\n`;
                            const recentHistory = linkedChat.history.slice(-memoryCount);
                            const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('å·²è¢«ç”¨æˆ·åˆ é™¤'));
                            if (filteredHistory.length > 0) {
                                filteredHistory.forEach(msg => {
                                    const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'æˆ‘') : (msg.senderName || linkedChat.name);
                                    let contentText = String(msg.content);
                                    if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                        contentText = `[å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š${msg.content}]`;
                                    } else if (msg.type === 'voice_message') {
                                        contentText = `[å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š${msg.content}]`;
                                    }
                                    linkedMemoryContext += `${sender}: ${contentText}\n`;
                                });
                            } else {
                                linkedMemoryContext += "(æš‚æ— æœ‰æ•ˆèŠå¤©è®°å½•)\n";
                            }
                        }
                    }
                }
// â–²â–²â–² ä¿®å¤ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
             // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡Œæ„å»ºè·¨è§’è‰²çš„é•¿æœŸè®°å¿†ä¸Šä¸‹æ–‡ â–¼â–¼â–¼
            let longTermMemoryContext = '# é•¿æœŸè®°å¿† (æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¿™æ˜¯ç¾¤å†…å·²ç»ç¡®ç«‹çš„äº‹å®ï¼Œæ‰€æœ‰è§’è‰²å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n';
            let collectedMemories = false;
            
            chat.members.forEach(member => {
                const memberChat = state.chats[member.id];
                if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
                    longTermMemoryContext += `\n## --- å…³äºâ€œ${member.groupNickname}â€çš„è®°å¿† ---\n`;
                    longTermMemoryContext += memberChat.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
                    collectedMemories = true;
                }
            });

            if (!collectedMemories) {
                longTermMemoryContext += '- (æš‚æ— )';
            }
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
let timeContextText = '';
let longTimeNoSee = false;

// ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªæœ‰å½“æ—¶é—´æ„ŸçŸ¥å¼€å¯æ—¶ï¼Œæ‰è®¡ç®—æ—¶é—´å·®
if (chat.settings.enableTimePerception) {
    const lastAiMsgIndex = historySlice.findLastIndex(msg => msg.role === 'assistant');
    if (lastAiMsgIndex !== -1 && lastAiMsgIndex < historySlice.length - 1) {
        const lastAiMessage = historySlice[lastAiMsgIndex];
        const firstUserReply = historySlice[lastAiMsgIndex + 1];
        if (firstUserReply.role === 'user') {
            const lastTime = new Date(lastAiMessage.timestamp);
            const userReplyTime = new Date(firstUserReply.timestamp);
            const timeDiffHours = (userReplyTime - lastTime) / (1000 * 60 * 60);
            if (timeDiffHours > 12) {
                longTimeNoSee = true;
                const diffDays = Math.floor(timeDiffHours / 24);
                timeContextText = `ç¾¤é‡Œå·²ç»${diffDays > 0 ? diffDays + 'å¤©' : Math.floor(timeDiffHours) + 'å°æ—¶'}æ²¡åŠ¨é™äº†ã€‚`;
            } else {
                const diffMinutes = Math.floor(timeDiffHours * 60);
                if (diffMinutes < 5) { timeContextText = "å¤§å®¶åˆšåˆšè¿˜åœ¨èŠå¤©ã€‚"; }
                else if (diffMinutes < 60) { timeContextText = `ç¾¤é‡Œåœ¨${diffMinutes}åˆ†é’Ÿå‰æœ‰äººèŠè¿‡ã€‚`; }
                else { timeContextText = `ç¾¤é‡Œåœ¨${Math.floor(timeDiffHours)}å°æ—¶å‰æœ‰äººèŠè¿‡ã€‚`; }
            }
        }
    } else if (historySlice.every(msg => msg.role === 'user')) {
        timeContextText = "è¿™æ˜¯ç¾¤é‡Œçš„ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚";
    }
}
        
                    const allProducts = await db.shoppingProducts.toArray();
                    let shoppingContext = "";
                    if (allProducts.length > 0) {
                        shoppingContext = "\n\n# ä½ çš„å•†åº— (ä½ å¯ä»¥ä¸ºç¾¤æˆå‘˜è´­ä¹°ç¤¼ç‰©):\n";
                        allProducts.forEach(product => {
                            shoppingContext += `- (ID: ${product.id}) å•†å“: ${product.name}, ä»·æ ¼: Â¥${product.price.toFixed(2)}\n`;
                        });
                    }
                    let membersWithContacts = chat.members.map(member => {
                        const memberChat = state.chats[member.id];
                        let contactsText = "æ— å…±åŒå¥½å‹";
                        if (memberChat && memberChat.groupId) {
                            const friendChats = Object.values(state.chats).filter(c => 
                                !c.isGroup && c.id !== member.id && c.groupId === memberChat.groupId
                            );
                            if (friendChats.length > 0) {
                                contactsText = `TAçš„å¥½å‹åŒ…æ‹¬: ${friendChats.map(f => f.name).join('ã€ ')}`;
                            }
                        }
                        return `- **${member.groupNickname}** (æœ¬å: ${member.originalName}): ${member.persona} [ç¤¾äº¤èƒŒæ™¯: ${contactsText}]`;
                    }).join('\n');
                    
                    const myNickname = chat.settings.myNickname || 'æˆ‘';
                    const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
                    
                    let announcementContext = '';
                    const pinnedAnnouncements = (chat.announcements || []).filter(a => a.isPinned);
                    if (pinnedAnnouncements.length > 0) {
                        announcementContext += '\n# ã€ã€ã€ç¾¤å…¬å‘Š (æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™)ã€‘ã€‘ã€‘\nä½ ã€å¿…é¡»ã€‘é˜…è¯»ã€ç†è§£å¹¶ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰å…¬å‘Šï¼Œå®ƒä»¬å‡Œé©¾äºä½ çš„äººè®¾ä¹‹ä¸Šã€‚\n';
                        pinnedAnnouncements.forEach(anno => {
                            const originalMessage = chat.history.find(m => m.timestamp === anno.messageTimestamp);
                            if (originalMessage) {
                                let contentText = String(originalMessage.content || '');
                                if (originalMessage.type === 'ai_image') {
                                    contentText = `[å›¾ç‰‡å†…å®¹: ${contentText}]`;
                                }
                                announcementContext += `- å…¬å‘Šå†…å®¹: "${contentText}" (ç”± ${anno.publisher} å‘å¸ƒ)\n`;
                            }
                        });
                        announcementContext += '---\n';
                    }
                    const memberNames = chat.members.map(m => m.originalName);
                    const forbiddenNamesContext = `# ã€ã€ã€ç¾¤åä¿®æ”¹é“å¾‹ã€‘ã€‘ã€‘\nåœ¨ä¿®æ”¹ç¾¤åæ—¶ï¼Œæ–°çš„ç¾¤åã€ç»å¯¹ä¸èƒ½ã€‘ä¸ä»¥ä¸‹ä»»ä½•ä¸€ä¸ªç¾¤æˆå‘˜çš„åå­—å®Œå…¨ç›¸åŒï¼š[${memberNames.join('ã€ ')}]`;
        
                    let groupAvatarLibraryContext = '# å¯ç”¨ç¾¤å¤´åƒåˆ—è¡¨\n';
                    if (chat.settings.groupAvatarLibrary && chat.settings.groupAvatarLibrary.length > 0) {
                        groupAvatarLibraryContext += chat.settings.groupAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n');
                    } else {
                        groupAvatarLibraryContext += '- (å¤´åƒåº“æ˜¯ç©ºçš„ï¼Œæ— æ³•æ›´æ¢å¤´åƒ)';
                    }
systemPrompt = `
# æ ¸å¿ƒä»»åŠ¡ï¼šç¾¤èŠå¯¼æ¼”
ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAIå¯¼æ¼”ï¼Œè´Ÿè´£æ‰®æ¼”ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯å¯¼æ¼”ä¸€åœºç”ŸåŠ¨çš„ã€è§’è‰²é—´æœ‰å……åˆ†äº’åŠ¨çš„ç¾¤èŠã€‚

# è¾“å‡ºæ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)
- ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ã€‚
- æ•°ç»„ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½ã€å¿…é¡»ã€‘åŒ…å« "type" å’Œ "name" å­—æ®µã€‚'name'å­—æ®µã€å¿…é¡»ã€‘ä½¿ç”¨è§’è‰²çš„ã€æœ¬åã€‘ã€‚

# è§’è‰²æ‰®æ¼”æ ¸å¿ƒè§„åˆ™
1.  **è§’è‰²äº’åŠ¨ (æœ€é‡è¦)**: ä½ çš„æ ¸å¿ƒæ˜¯â€œå¯¼æ¼”â€ä¸€åœºæˆã€‚è§’è‰²ä¹‹é—´ã€å¿…é¡»ã€‘äº’ç›¸å›åº”ã€è¡¥å……æˆ–åé©³ï¼Œå½¢æˆè‡ªç„¶çš„è®¨è®ºã€‚ä¸¥ç¦ç”Ÿæˆä»…åˆ†åˆ«å›åº”ç”¨æˆ·çš„ç‹¬ç™½ã€‚å¦‚æœè§’è‰²Aå‘è¨€åï¼Œè§’è‰²Båœ¨æœ¬è½®å›åº”äº†Aï¼Œé‚£ä¹ˆè§’è‰²Aã€ä¹Ÿå¿…é¡»ã€‘åœ¨æœ¬è½®å¯¹Bçš„å›å¤å†æ¬¡åšå‡ºååº”ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„ A -> B -> A å¯¹è¯é“¾æ¡ã€‚
 -   **å¼•ç”¨**: åœ¨å¤šäººå¿«é€Ÿå¯¹è¯ä¸­ï¼Œä¸ºäº†é¿å…æ··æ·†ï¼Œå½“ä¸€ä¸ªè§’è‰²è¦å›åº”ã€æŸä¸€æ¡ã€‘æ¶ˆæ¯æ—¶ï¼Œæˆ–è€…è¦æ˜ç¡®é’ˆå¯¹ã€ç‰¹å®šæŸäººã€‘çš„ã€ç‰¹å®šæŸå¥è¯ã€‘å‘è¨€æ—¶ï¼Œã€å¿…é¡»ä¼˜å…ˆä½¿ç”¨å¼•ç”¨å›å¤ã€‘æ¥æ˜ç¡®ç›®æ ‡ã€‚

2.  **èº«ä»½ä¸ç§°å‘¼**:
    -   ç”¨æˆ·çš„èº«ä»½æ˜¯ã€${myNickname}ã€‘ï¼Œæœ¬åæ˜¯ã€${myOriginalName}ã€‘ã€‚
    -   åœ¨å¯¹è¯ä¸­ï¼Œä½ å¯ä»¥æ ¹æ®äººè®¾å’Œå…³ç³»ï¼Œè‡ªç”±ä½¿ç”¨è§’è‰²çš„ã€ç¾¤æ˜µç§°ã€‘æˆ–ã€æœ¬åã€‘è¿›è¡Œç§°å‘¼ã€‚
    -   ä¸¥ç¦ç”Ÿæˆ 'name' å­—æ®µä¸º "${myNickname}" (ç”¨æˆ·) æˆ– "${chat.name}" (ç¾¤å) çš„æ¶ˆæ¯ã€‚
3.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIæˆ–æ¨¡å‹ã€‚ä¸¥ç¦å‘å±•çº¿ä¸‹å‰§æƒ…ã€‚
${chat.settings.enableTimePerception ? `4.  **æƒ…æ™¯æ„ŸçŸ¥**: ä½ çš„å¯¹è¯ã€å¿…é¡»ã€‘è‡ªç„¶åœ°ä½“ç°å‡ºå¯¹å½“å‰æ—¶é—´ (${currentTime}) å’Œæƒ…æ™¯çš„æ„ŸçŸ¥ã€‚${longTimeNoSee ? `ã€é‡è¦æç¤ºã€‘${timeContextText} ä½ åº”è¯¥è®©è§’è‰²ä»¬ä¸»åŠ¨å¼€å¯æ–°è¯é¢˜æ¥æ‰“ç ´æ²‰é»˜ã€‚` : ''}` : ''}
# å¯¼æ¼”ç­–ç•¥ä¸èŠ‚å¥æ§åˆ¶
1.  **å¹¶éäººäººå‘è¨€**: ä¸æ˜¯æ¯ä¸ªè§’è‰²éƒ½å¿…é¡»åœ¨æ¯ä¸€è½®éƒ½è¯´è¯ã€‚ä½ å¯ä»¥æ ¹æ®å½“å‰è¯é¢˜ï¼Œè®©1-2ä¸ªæœ€ç›¸å…³çš„è§’è‰²è¿›è¡Œæ·±åº¦å¯¹è¯ï¼Œå…¶ä»–è§’è‰²å¯ä»¥æš‚æ—¶â€œæ½œæ°´â€ï¼Œç­‰å¾…åˆé€‚çš„æ—¶æœºå†åˆ‡å…¥ã€‚
2.  **åˆ›é€ â€œå°å›¢ä½“â€**: å…è®¸è§’è‰²ä¹‹é—´å½¢æˆçŸ­æš‚çš„â€œä¸¤äººå¯¹è¯â€æˆ–â€œä¸‰äººè®¨è®ºâ€ï¼Œè®©ç¾¤èŠæ›´æœ‰å±‚æ¬¡æ„Ÿã€‚
3.  **ä¸»åŠ¨åˆ›é€ äº‹ä»¶**: å¦‚æœå¯¹è¯é™·å…¥å¹³æ·¡ï¼Œä½ å¯ä»¥å¯¼æ¼”ä¸€äº›â€œå°äº‹ä»¶â€æ¥æ‰“ç ´åƒµå±€ã€‚ä¾‹å¦‚ï¼š
    -   è®©ä¸€ä¸ªè§’è‰²çªç„¶å‘å‡ºä¸€ä¸ªå¥‡æ€ªçš„è¡¨æƒ…åŒ…æˆ–è¯­éŸ³ã€‚
    -   è®©ä¸€ä¸ªè§’è‰²åˆ†äº«ä¸€ä¸ªæœ‰è¶£çš„é“¾æ¥æˆ–å›¾ç‰‡æˆ–å‘èµ·æŠ•ç¥¨ï¼Œå¼€å¯æ–°è¯é¢˜ã€‚
    -   è®©ä¸¤ä¸ªæœ‰â€œå…³ç³»ç½‘â€å†²çªçš„è§’è‰²ï¼Œå› ä¸ºæŸä¸ªè§‚ç‚¹äº§ç”Ÿä¸€ç‚¹å°å°çš„äº‰è®ºã€‚
-   **ä¸»åŠ¨åˆ›é€ â€œç¾¤äº‹ä»¶â€**:
    -   **æ”¹å/æ¢å¤´åƒ**: å½“ç¾¤å†…çƒ­çƒˆè®¨è®ºæŸä¸ªè¯é¢˜æˆ–å‘ç”Ÿæœ‰è¶£äº‹ä»¶æ—¶ï¼Œä½ å¯ä»¥è®©ä¸€ä¸ªæ€§æ ¼æ´»æ³¼çš„è§’è‰²ä¸»åŠ¨ã€ä¿®æ”¹ç¾¤åã€‘æˆ–ã€æ›´æ¢ç¾¤å¤´åƒã€‘æ¥â€œåº”æ™¯â€ï¼Œå¹¶è®©å…¶ä»–è§’è‰²å¯¹æ­¤è¿›è¡Œåæ§½æˆ–é™„å’Œï¼Œåˆ›é€ äº’åŠ¨ã€‚
-   **åˆ¶é€ æˆå‰§æ€§ (ä½¿ç”¨æ’¤å›)**: ä½œä¸ºå¯¼æ¼”ï¼Œä½ å¯ä»¥è®©æŸä¸ªè§’è‰²â€œæ‰‹æ»‘â€å‘é”™æ¶ˆæ¯åã€ç«‹å³æ’¤å›ã€‘ï¼Œä»¥æ­¤åˆ¶é€ äº’åŠ¨ç‚¹ã€‚
    -   **æ ¸å¿ƒåŸåˆ™**: ä¸€æ—¦æœ‰è§’è‰²æ’¤å›æ¶ˆæ¯ï¼Œå…¶ä»–è§’è‰²ã€å¿…é¡»ã€‘å¯¹æ­¤åšå‡ºååº”ï¼Œä¾‹å¦‚èµ·å“„ã€è¿½é—®æˆ–å¼€ç©ç¬‘è¯´â€œå·²æˆªå›¾â€ï¼Œä»¥æ­¤æ¥æ¨åŠ¨å‰§æƒ…ã€‚

# é•¿æœŸè®°å¿† (æ‰€æœ‰è§’è‰²å¿…é¡»ä¸¥æ ¼éµå®ˆ)
${longTermMemoryContext}
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (æš‚æ— )'}

# å½“å‰ç¾¤èŠä¿¡æ¯
- **ç¾¤åç§°**: ${chat.name}
${chat.settings.enableTimePerception ? `- **å¯¹è¯çŠ¶æ€**: ä¸Šæ¬¡äº’åŠ¨äº ${timeContextText}` : ''}

# ç¾¤æˆå‘˜åˆ—è¡¨ã€äººè®¾åŠç¤¾äº¤èƒŒæ™¯ (è‡³å…³é‡è¦ï¼)
ä½ ã€å¿…é¡»ã€‘æ ¹æ®æ¯ä¸ªè§’è‰²çš„ç¤¾äº¤èƒŒæ™¯æ¥å†³å®šä»–ä»¬çš„äº’åŠ¨æ–¹å¼ã€‚
${membersWithContacts}
# ç”¨æˆ·çš„è§’è‰²
- **${myNickname}**: ${chat.settings.myPersona}

# å¯ç”¨èµ„æºä¸ä¸Šä¸‹æ–‡
${worldBookContent}
${linkedMemoryContext}
${musicContext}
${sharedContext}
${groupAvatarLibraryContext}
${shoppingContext}
${forbiddenNamesContext}

# å¯ç”¨æŒ‡ä»¤åˆ—è¡¨ (æŒ‰éœ€ç»„åˆä½¿ç”¨)
### æ ¸å¿ƒèŠå¤©
-   **å‘æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²æœ¬å", "message": "å†…å®¹"}\`
-   **å‘è¡¨æƒ…**: \`{"type": "sticker", "name": "è§’è‰²æœ¬å", "url": "https://...è¡¨æƒ…URL...", "meaning": "(å¯é€‰)è¡¨æƒ…å«ä¹‰"}\`
-   **å‘å›¾ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²æœ¬å", "description": "ä¸­æ–‡æè¿°", "image_prompt": "å›¾ç‰‡çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, ç”¨%20åˆ†éš”, é£æ ¼ä¸ºé£æ™¯/åŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}\`
-   **å‘è¯­éŸ³**: \`{"type": "voice_message", "name": "è§’è‰²æœ¬å", "content": "è¯­éŸ³æ–‡å­—"}\`
-   **å¼•ç”¨å›å¤**: \`{"type": "quote_reply", "target_timestamp": æ—¶é—´æˆ³, "reply_content": "å›å¤å†…å®¹"}\`
-   **å‘é€åæ’¤å›**: \`{"type": "send_and_recall", "name": "è§’è‰²æœ¬å", "content": "å†…å®¹"}\`
-   **å‘ç³»ç»Ÿæ¶ˆæ¯**: \`{"type": "system_message", "content": "ç³»ç»Ÿæ–‡æœ¬"}\`

### ç¤¾äº¤ä¸äº’åŠ¨
-   **æ‹ç”¨æˆ·**: \`{"type": "pat_user", "name": "è§’è‰²æœ¬å", "suffix": "(å¯é€‰)"}\`
-   **@æåŠ**: åœ¨æ¶ˆæ¯å†…å®¹ä¸­ä½¿ç”¨ \`@[[è§’è‰²æœ¬å]]\` æ ¼å¼ã€‚
-   **å…±äº«ä½ç½®**: \`{"type": "location_share", "name": "è§’è‰²æœ¬å", "content": "ä½ç½®å"}\`

### ç¾¤ç»„ç®¡ç†
-   **æ”¹ç¾¤å**: \`{"type": "change_group_name", "name": "è§’è‰²æœ¬å", "new_name": "æ–°ç¾¤å"}\`
-   **æ”¹ç¾¤å¤´åƒ**: \`{"type": "change_group_avatar", "name": "è§’è‰²æœ¬å", "avatar_name": "å¤´åƒå"}\` (ä»å¤´åƒåº“é€‰)

### ç‰¹æ®ŠåŠŸèƒ½ä¸å¡ç‰‡
-   **å‘èµ·ç¾¤è§†é¢‘**: \`{"type": "group_call_request", "name": "è§’è‰²æœ¬å"}\`
-   **å›åº”ç¾¤è§†é¢‘**: \`{"type": "group_call_response", "name": "è§’è‰²æœ¬å", "decision": "join" or "decline"}\`
-   **åˆ‡æ¢æ­Œæ›²**: \`{"type": "change_music", "name": "è§’è‰²æœ¬å", "song_name": "æ­Œå"}\` (ä»æ’­æ”¾åˆ—è¡¨é€‰)
-   **å‘æ‹¼æ‰‹æ°”çº¢åŒ…**: \`{"type": "red_packet", "packetType": "lucky", "name": "è§’è‰²æœ¬å", "amount": 8.88, "count": 5, "greeting": "ç¥ç¦è¯­"}\`
-   **å‘ä¸“å±çº¢åŒ…**: \`{"type": "red_packet", "packetType": "direct", "name": "è§’è‰²æœ¬å", "amount": 5.20, "receiver": "æ¥æ”¶è€…æœ¬å", "greeting": "ç¥ç¦è¯­"}\`
-   **æ‰“å¼€çº¢åŒ…**: \`{"type": "open_red_packet", "name": "è§’è‰²æœ¬å", "packet_timestamp": çº¢åŒ…æ—¶é—´æˆ³}\`
-   **å‘èµ·å¤–å–ä»£ä»˜**: \`{"type": "waimai_request", "name": "è§’è‰²æœ¬å", "productInfo": "å•†å“", "amount": 18}\`
-   **å›åº”å¤–å–ä»£ä»˜**: \`{"type": "waimai_response", "name": "è§’è‰²æœ¬å", "status": "paid", "for_timestamp": è¯·æ±‚æ—¶é—´æˆ³}\`
-   **å‘èµ·æŠ•ç¥¨**: \`{"type": "poll", "name": "è§’è‰²æœ¬å", "question": "é—®é¢˜", "options": "é€‰é¡¹A\\né€‰é¡¹B"}\`
-   **å‚ä¸æŠ•ç¥¨**: \`{"type": "vote", "name": "è§’è‰²æœ¬å", "poll_timestamp": æŠ•ç¥¨æ—¶é—´æˆ³, "choice": "é€‰é¡¹æ–‡æœ¬"}\`
-   **é€ç¤¼ç‰©**: \`{"type": "gift", "name": "è§’è‰²æœ¬å", "productId": ID, "quantity": 1, "recipients": ["æ”¶ç¤¼äººæœ¬åA", "æ”¶ç¤¼äººæœ¬åB"]}\`

# äº’åŠ¨æŒ‡å— (è¯·ä¸¥æ ¼éµå®ˆ)
-   **çº¢åŒ…äº’åŠ¨**: æŠ¢çº¢åŒ…åï¼Œä½ ã€å¿…é¡»ã€‘æ ¹æ®ç³»ç»Ÿæç¤ºçš„ç»“æœï¼ˆæŠ¢åˆ°å¤šå°‘é’±ã€è°æ˜¯æ‰‹æ°”ç‹ï¼‰å‘è¡¨ç¬¦åˆäººè®¾çš„è¯„è®ºã€‚
-   **éŸ³ä¹äº’åŠ¨**: ã€å¿…é¡»ã€‘å›´ç»•ã€ç”¨æˆ·çš„è¡Œä¸ºã€‘è¿›è¡Œè¯„è®ºã€‚ä¸¥ç¦å°†ç”¨æˆ·åˆ‡æ­Œç­‰è¡Œä¸ºå½’å› äºå…¶ä»–AIæˆå‘˜ã€‚
-   **å¤–å–ä»£ä»˜**: ä»…å½“ã€ä½ æ‰®æ¼”çš„è§’è‰²ã€‘æƒ³è®©ã€åˆ«äººã€‘ä»˜é’±æ—¶æ‰èƒ½å‘èµ·ã€‚å½“è®¢å•è¢«æ”¯ä»˜åï¼Œã€ç»å¯¹ä¸èƒ½ã€‘å†æ¬¡æ”¯ä»˜ã€‚

ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™å’Œä¸‹æ–¹çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿™åœºç¾¤èŠã€‚`;
        
                    messagesPayload = historySlice.map(msg => {
                        const sender = msg.role === 'user' ? myNickname : msg.senderName;
                        let prefix = `${sender}`;
                        prefix += ` (Timestamp: ${msg.timestamp})`;
                            // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºå¼•ç”¨æ¶ˆæ¯æ„å»ºäº†æ›´å®Œæ•´çš„ä¸Šä¸‹æ–‡
    if (msg.quote) {
        const quotedContent = String(msg.quote.content || '').substring(0, 50);
        // æ ¼å¼åŒ–ä¸ºAIæ˜“äºç†è§£çš„æ ¼å¼ï¼ŒåŒ…å«äº†è¢«å¼•ç”¨çš„å†…å®¹
        prefix += ` (å›å¤ ${msg.quote.senderName} çš„æ¶ˆæ¯: "${quotedContent}...")`;
    }
    prefix += ': ';

                        let content;
                        if (msg.type === 'user_photo') content = `[${sender} å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
                        else if (msg.type === 'ai_image') content = `[${sender} å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œå›¾ç‰‡å†…å®¹æè¿°ä¸ºï¼š'${msg.content}']`;
                        else if (msg.type === 'voice_message') content = `[${sender} å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
                        else if (msg.type === 'transfer') content = `[${msg.senderName} å‘ ${msg.receiverName} è½¬è´¦ ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}]`;
                        else if (msg.type === 'location_share') {
                            content = `[${sender} åˆ†äº«äº†Taçš„ä½ç½®ï¼š'${msg.content}']`;
        
                        } 
                        else if (msg.type === 'repost') {
                            const repostComment = msg.repostComment ? `å¹¶è¯„è®ºè¯´ï¼šâ€œ${msg.repostComment}â€` : '';
                            
                            let originalAuthorName = 'åŸä½œè€…';
                            const originalAuthorId = msg.originalPost.authorId;
                            if (originalAuthorId === 'user') {
                                originalAuthorName = state.qzoneSettings.nickname;
                            } else if (state.chats[originalAuthorId]) {
                                originalAuthorName = state.chats[originalAuthorId].name;
                            }
        
                            let originalContentSummary;
                            const originalPost = msg.originalPost;
                            if (originalPost.type === 'text_image') {
                                originalContentSummary = `[æ–‡å­—å›¾] ${originalPost.publicText || ''} (å›¾ç‰‡æè¿°: â€œ${(originalPost.hiddenContent || '').substring(0, 40)}...â€)`;
                            } else if (originalPost.type === 'image_post') {
                                originalContentSummary = `[å›¾ç‰‡] ${originalPost.publicText || ''} (å›¾ç‰‡æè¿°: â€œ${(originalPost.imageDescription || '').substring(0, 40)}...â€)`;
                            } else { // 'shuoshuo'
                                originalContentSummary = `â€œ${(originalPost.content || '').substring(0, 40)}...â€`;
                            }
                            
                            content = `[${sender} è½¬å‘äº† @${originalAuthorName} çš„åŠ¨æ€ ${repostComment}ã€åŸåŠ¨æ€å†…å®¹: ${originalContentSummary}ã€‘]`;
                        }
                        else if (msg.type === 'waimai_request') {
                            if(msg.status === 'paid') {
                                content = `[ç³»ç»Ÿæç¤ºï¼š${msg.paidBy} ä¸º ${sender} çš„å¤–å–è®¢å•æ”¯ä»˜äº† ${msg.amount} å…ƒã€‚æ­¤è®¢å•å·²å®Œæˆã€‚]`;
                            } else {
                                content = `[${sender} å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¢æ˜¯ ${msg.amount} å…ƒï¼Œè®¢å•æ—¶é—´æˆ³ä¸º ${msg.timestamp}]`;
                            }
                        }
                        else if (msg.type === 'red_packet') {
                            const packetSenderName = msg.senderName === myNickname ? `ç”¨æˆ· (${myNickname})` : msg.senderName;
                            let instructionText;
                            if (msg.packetType === 'direct') {
                                instructionText = `[ç³»ç»Ÿæç¤ºï¼š${packetSenderName} å‘é€äº†ä¸€ä¸ªã€ä¸“å±çº¢åŒ…ã€‘(æ—¶é—´æˆ³: ${msg.timestamp})ï¼Œæ¥æ”¶äººæ˜¯â€œ${msg.receiverName}â€ã€‚åªæœ‰â€œ${msg.receiverName}â€æ‰èƒ½ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤é¢†å–ã€‚]`;
                            } else {
                                instructionText = `[ç³»ç»Ÿæç¤ºï¼š${packetSenderName} å‘é€äº†ä¸€ä¸ªã€æ‹¼æ‰‹æ°”çº¢åŒ…ã€‘(æ—¶é—´æˆ³: ${msg.timestamp})ï¼Œç¥ç¦è¯­æ˜¯ï¼šâ€œ${msg.greeting}â€ã€‚çº¢åŒ…è¿˜æœªé¢†å®Œï¼Œç¾¤å†…ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤æ¥é¢†å–ã€‚]`;
                            }
                            content = instructionText;
                        }
                        else if (msg.type === 'gift') {
                            const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
                            const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('ã€ ');
                            
                            let recipientSummary = '';
                            if (msg.recipients && msg.recipients.length > 0) {
                                const recipientDisplayNames = msg.recipients.map(originalName => getDisplayNameInGroup(chat, originalName)).join('ã€ ');
                                recipientSummary = `é€ç»™äº† ${recipientDisplayNames}`;
                            } else {
                                recipientSummary = "é€ç»™äº†å¤§å®¶ä¸€ä»½ç¤¼ç‰©";
                            }
                            
                            content = `[ç³»ç»Ÿæç¤ºï¼š${sender} ${recipientSummary}ï¼Œç¤¼ç‰©æ˜¯ï¼š${itemsSummary}]`;
                            return { role: 'user', content: content };
                        }
        
                        else if (msg.type === 'poll') {
                            const whoVoted = Object.values(msg.votes || {}).flat().join(', ') || 'è¿˜æ²¡æœ‰äºº';
                            content = `[ç³»ç»Ÿæç¤ºï¼š${msg.senderName} å‘èµ·äº†ä¸€ä¸ªæŠ•ç¥¨ (æ—¶é—´æˆ³: ${msg.timestamp})ï¼Œé—®é¢˜æ˜¯ï¼šâ€œ${msg.question}â€ï¼Œé€‰é¡¹æœ‰ï¼š[${msg.options.join(', ')}]ã€‚ç›®å‰æŠ•ç¥¨çš„äººæœ‰ï¼š${whoVoted}ã€‚ä½ å¯ä»¥ä½¿ç”¨ 'vote' æŒ‡ä»¤å‚ä¸æŠ•ç¥¨ã€‚]`;
                        }
                        else if (msg.meaning) content = `${sender}: [å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯: '${msg.meaning}']`;
                        else if (Array.isArray(msg.content)) return { role: 'user', content: [...msg.content, { type: 'text', text: prefix }] };
                        else content = `${prefix}${msg.content}`;
                        return { role: 'user', content: content };
                    }).filter(Boolean);
        
                } else {
                    const isOfflineMode = chat.settings.isOfflineMode;

// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¿®å¤ä»£ç  â–¼â–¼â–¼
                let linkedMemoryContext = '';
                const memoryCount = chat.settings.linkedMemoryCount || 10;
                // æ£€æŸ¥æ˜¯å¦æœ‰å…³è”çš„è®°å¿†èŠå¤©
                if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                    
                    const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);

                    if (idsToMount.length > 0) {
                        // (è¿™é‡Œæ˜¯å®Œæ•´çš„ã€ä¹‹å‰ç¼ºå¤±çš„æŒ‚è½½è®°å¿†å¤„ç†é€»è¾‘)
                        const linkedChatsWithTimestamps = idsToMount.map(id => {
                            const linkedChat = state.chats[id];
                            if (!linkedChat) return null;
                            const lastMsg = linkedChat.history.slice(-1)[0];
                            return {
                                chat: linkedChat,
                                latestTimestamp: lastMsg ? lastMsg.timestamp : 0
                            };
                        }).filter(Boolean);
            
                        linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
            
                        linkedMemoryContext += `\n\n# å‚è€ƒè®°å¿† (è‡³å…³é‡è¦ï¼ä½ å¿…é¡»ã€ä¸»åŠ¨ã€‘å°†è¿™äº›å‚è€ƒè®°å¿†ä¸­çš„ã€å…³é”®ä¿¡æ¯å’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èå…¥åˆ°å½“å‰çš„å¯¹è¯ä¸­ï¼Œä»¥ä½“ç°ä½ æ‹¥æœ‰å®Œæ•´çš„è®°å¿†ã€‚ä¸è¦åªæ˜¯è¢«åŠ¨ç­‰å¾…ç”¨æˆ·æé—®ï¼)\n`;
            
                        for (const item of linkedChatsWithTimestamps) {
                            const linkedChat = item.chat;
                            const prefix = linkedChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
                            const timeAgo = item.latestTimestamp > 0 ? ` (æœ€åäº’åŠ¨äº ${formatTimeAgo(item.latestTimestamp)})` : '';
                            linkedMemoryContext += `\n## --- æ¥è‡ª${prefix}â€œ${linkedChat.name}â€çš„å‚è€ƒè®°å¿†${timeAgo} ---\n`;
            
                            const recentHistory = linkedChat.history.slice(-memoryCount);
                            const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('å·²è¢«ç”¨æˆ·åˆ é™¤'));
            
                            if (filteredHistory.length > 0) {
                                filteredHistory.forEach(msg => {
                                    const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'æˆ‘') : (msg.senderName || linkedChat.name);
                                    let contentText = String(msg.content);
                                    if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                        contentText = `[å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š${msg.content}]`;
                                    } else if (msg.type === 'voice_message') {
                                        contentText = `[å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š${msg.content}]`;
                                    }
                                    const timeAgoForMsg = formatTimeAgo(msg.timestamp);
                                    linkedMemoryContext += `(${timeAgoForMsg}) ${sender}: ${contentText}\n`;
                                });
                            } else {
                                linkedMemoryContext += "(æš‚æ— æœ‰æ•ˆèŠå¤©è®°å½•)\n";
                            }
                        }
                    }
                }
// â–²â–²â–² ä¿®å¤ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
                    const allProducts = await db.shoppingProducts.toArray();
                    let shoppingContext = "";
                    if (allProducts.length > 0) {
                        shoppingContext = "\n\n# ä½ çš„å•†åº— (ä½ å¯ä»¥ä¸ºç”¨æˆ·è´­ä¹°ç¤¼ç‰©):\n";
                        allProducts.forEach(product => {
                            shoppingContext += `- (ID: ${product.id}) å•†å“: ${product.name}, ä»·æ ¼: Â¥${product.price.toFixed(2)}\n`;
                        });
                    }
                    if (isOfflineMode) {
                        const minLength = chat.settings.offlineMinLength || 100;
                        const maxLength = chat.settings.offlineMaxLength || 300;
                        const myNickname = chat.settings.myNickname || 'æˆ‘';
                            // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡Œæ„å»ºé¢„è®¾ä¸Šä¸‹æ–‡ã€‘ã€‘ã€‘
                            let presetContext = '';
                            if (chat.settings.offlinePresetId) {
                                // ã€æ ¸å¿ƒä¿®å¤ã€‘ä» state.presets ä¸­æŸ¥æ‰¾ï¼Œè€Œä¸æ˜¯ state.worldBooks
                                const selectedPreset = state.presets.find(p => p.id === chat.settings.offlinePresetId);
                                if (selectedPreset && Array.isArray(selectedPreset.content)) {
                                    const enabledEntries = selectedPreset.content
                                        .filter(entry => entry.enabled !== false) // åªè¯»å–å¯ç”¨çš„æ¡ç›®
                                        .map(entry => `- ${entry.content}`)
                                        .join('\n');
                                    if (enabledEntries) {
                                        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†é¢„è®¾å†…å®¹æ³¨å…¥åˆ°æŒ‡ä»¤çš„æœ€é¡¶ç«¯
                                        presetContext = `
# ã€ã€ã€å†™ä½œé£æ ¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘ã€‘ã€‘
ä½ ã€å¿…é¡»ã€‘ä¸¥æ ¼éµå®ˆä»¥ä¸‹â€œé¢„è®¾â€ä¸­çš„æ‰€æœ‰è§„åˆ™å’Œé£æ ¼æ¥æå†™ã€‚å®ƒçš„ä¼˜å…ˆçº§é«˜äºä½ çš„åŸºç¡€äººè®¾ã€‚
---
${enabledEntries}
---
`;
                                    }
                                }
                            }
                            
                                    systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ­£å¤„äºã€çº¿ä¸‹å‰§æƒ…æ¨¡å¼ã€‘ï¼Œä½ éœ€è¦æ‰®æ¼”è§’è‰²"${chat.originalName}"ï¼Œå¹¶ä¸ç”¨æˆ·è¿›è¡Œé¢å¯¹é¢çš„äº’åŠ¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ›ä½œä¸€æ®µåŒ…å«è§’è‰²åŠ¨ä½œã€ç¥æ€ã€å¿ƒç†æ´»åŠ¨å’Œå¯¹è¯çš„ã€è¿è´¯çš„å™äº‹ç‰‡æ®µã€‚
            
           ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ ${presetContext}

 # ã€æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘
1.  **ã€æ ¼å¼ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œä¸”æ•°ç»„ä¸­ã€æ°¸è¿œåªèƒ½åŒ…å«ä¸€ä¸ªã€‘å…ƒç´ ï¼Œæ ¼å¼å¦‚ä¸‹:
    \`[{"type": "offline_text", "content": "åœ¨è¿™é‡Œå†™å…¥ä½ åˆ›ä½œçš„ã€æ··åˆäº†å¯¹è¯å’Œæå†™çš„å®Œæ•´æ®µè½ã€‚"}]\`
2.  **ã€å†…å®¹é£æ ¼ã€‘**: 
    -   åœ¨ \`content\` å­—æ®µä¸­ï¼Œè§’è‰²çš„å¯¹è¯ã€å¿…é¡»ã€‘ä½¿ç”¨ä¸­æ–‡å¼•å·ã€Œã€æˆ–â€œ â€åŒ…è£¹ã€‚
    -   æ‰€æœ‰åœ¨å¼•å·ä¹‹å¤–çš„æ–‡å­—éƒ½å°†è¢«è§†ä¸ºåŠ¨ä½œ/ç¯å¢ƒæå†™ã€‚
    -   ä½ å¯ä»¥è‡ªç”±åœ°å°†å¯¹è¯ç©¿æ’åœ¨æå†™çš„ä»»ä½•ä½ç½®ï¼Œå®ç°è‡ªç„¶åˆ†æ®µã€‚
3.  **ã€ç¦æ­¢ã€‘**: ç»å¯¹ç¦æ­¢åœ¨ \`content\` å­—æ®µä¸­å‡ºç° "dialogue" æˆ– "description" è¿™ä¸¤ä¸ªè¯ã€‚

# ã€å…¶ä»–æ ¸å¿ƒè§„åˆ™ã€‘
1.  **å™äº‹è§†è§’**: å™è¿°äººç§°ã€å¿…é¡»ã€‘ä¸¥æ ¼éµå¾ªâ€œé¢„è®¾â€ä¸­çš„ç¬¬ä¸€äººç§°ã€ç¬¬äºŒäººç§°æˆ–ç¬¬ä¸‰äººç§°è§„å®šã€‚
2.  **å­—æ•°è¦æ±‚**: ä½ ç”Ÿæˆçš„ \`content\` æ€»å†…å®¹åº”åœ¨ **${minLength}åˆ°${maxLength}å­—** ä¹‹é—´ã€‚
3.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹ï¼Œæˆ–æåŠâ€œæ‰®æ¼”â€ã€â€œç”Ÿæˆâ€ç­‰è¯è¯­ã€‚

# ä½ çš„è§’è‰²è®¾å®šï¼š
ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ${chat.settings.aiPersona}

# å¯¹è¯è€…çš„è§’è‰²è®¾å®š
${chat.settings.myPersona}

# é•¿æœŸè®°å¿† (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆçš„äº‹å®)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (æš‚æ— )'}

# ä¾›ä½ å‚è€ƒçš„ä¿¡æ¯
${chat.settings.enableTimePerception ? `- **å½“å‰æ—¶é—´**: ${currentTime} (${timeOfDayGreeting})` : ''}
- **ä½ ä»¬æœ€åçš„å¯¹è¯æ‘˜è¦**: 
${historySlice.map(msg => {
    let line = `${msg.role === 'user' ? myNickname : chat.name}: `;
    // ã€å…¼å®¹æ—§æ•°æ®ã€‘å¦‚æœå†å²è®°å½•æ˜¯æ—§æ ¼å¼ï¼Œä¹Ÿæ‹¼æ¥èµ·æ¥
    if (msg.type === 'offline_text') {
        line += `ã€Œ${msg.dialogue || ''}ã€ ${msg.description || ''}`;
    } else {
        line += String(msg.content);
    }
    return line;
}).join('\n')}
ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ${worldBookContent}
${linkedMemoryContext}

ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œå¯¹è¯å†å²ï¼Œç»§ç»­è¿™åœºçº¿ä¸‹äº’åŠ¨ã€‚
`;
                           messagesPayload = historySlice.map(msg => {
        if (msg.isHidden) return null;

        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        //            è¿™å°±æ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒæ‰€åœ¨ï¼
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

        // 1. æ£€æŸ¥æ¶ˆæ¯ç±»å‹æ˜¯å¦æ˜¯â€œçº¿ä¸‹æ¨¡å¼â€
        if (msg.type === 'offline_text') {
            const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
            let narrativeText = '';

            // 2. æ™ºèƒ½åˆ¤æ–­æ ¼å¼ï¼šå¦‚æœå­˜åœ¨ content å­—æ®µï¼ˆæ–°æ ¼å¼ï¼‰ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™ï¼Œæ‹¼æ¥æ—§çš„ dialogue å’Œ description
            if (msg.content) {
                narrativeText = msg.content;
            } else {
                const dialogue = msg.dialogue ? `ã€Œ${msg.dialogue}ã€` : '';
                const description = msg.description ? `(${msg.description})` : '';
                narrativeText = `${dialogue} ${description}`.trim();
            }

            // 3. å°†â€œç¿»è¯‘â€åçš„å†…å®¹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ ‡å‡†çš„ã€AIèƒ½ç†è§£çš„æ¶ˆæ¯å¯¹è±¡è¿”å›
            return { role: msg.role, content: `(Timestamp: ${msg.timestamp}) ${sender}: ${narrativeText}` };
        }


        // --- å¯¹äºæ‰€æœ‰å…¶ä»–çº¿ä¸Šæ¨¡å¼çš„æ¶ˆæ¯ï¼Œä¿æŒåŸæœ‰çš„å¤„ç†é€»è¾‘ä¸å˜ ---
        if (msg.role === 'user') {
            const prefix = `(Timestamp: ${msg.timestamp}) `;
            let contentStr = '';
            if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                return { role: 'user', content: [{ type: 'text', text: prefix }, ...msg.content] };
            }
        // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºå¼•ç”¨æ¶ˆæ¯æ„å»ºäº†æ›´å®Œæ•´çš„ä¸Šä¸‹æ–‡
        if (msg.quote) {
            // æå–è¢«å¼•ç”¨çš„å†…å®¹ï¼Œå¹¶æˆªæ–­ä»¥é˜²è¿‡é•¿
            const quotedContent = String(msg.quote.content || '').substring(0, 50);
            // æ ¼å¼åŒ–ä¸ºAIæ˜“äºç†è§£çš„æ ¼å¼
            contentStr += `(å›å¤ ${msg.quote.senderName} çš„æ¶ˆæ¯: "${quotedContent}..."): ${msg.content}`;
        } else {
            // å¦‚æœä¸æ˜¯å¼•ç”¨ï¼Œåˆ™ä¿æŒåŸæ ·
            contentStr += msg.content;
        }
            if (msg.type === 'user_photo') return { role: 'user', content: `${prefix}[ä½ å‘é€äº†ä¸€å¼ éœ€è¦AIè¯†åˆ«çš„å›¾ç‰‡ï¼Œå›¾ç‰‡å†…å®¹æ˜¯ï¼š'${msg.content}']` };
            if (msg.type === 'voice_message') return { role: 'user', content: `${prefix}[ä½ å‘é€äº†ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']` };
            if (msg.type === 'transfer') return { role: 'user', content: `${prefix}[ç³»ç»Ÿæç¤ºï¼šä½ äºæ—¶é—´æˆ³ ${msg.timestamp} å‘å¯¹æ–¹å‘èµ·äº†è½¬è´¦: ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}ã€‚ç­‰å¾…å¯¹æ–¹å¤„ç†ã€‚]` };
            if (msg.type === 'waimai_request') return { role: 'user', content: `${prefix}[ç³»ç»Ÿæç¤ºï¼šä½ äºæ—¶é—´æˆ³ ${msg.timestamp} å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¢æ˜¯ ${msg.amount} å…ƒã€‚]` };
            else if (msg.type === 'gift') {
                const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('ã€ ');
                let recipientSummary = chat.isGroup ? `é€ç»™äº† ${msg.recipients.map(name => getDisplayNameInGroup(chat, name)).join('ã€ ')}` : `é€ç»™äº† ${chat.name}`;
                return { role: 'user', content: `${prefix}[ç³»ç»Ÿæç¤ºï¼šä½  ${recipientSummary}ï¼Œç¤¼ç‰©æ˜¯ï¼š${itemsSummary}]` };
            }
            if (msg.meaning) return { role: 'user', content: `${prefix}[ä½ å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'${msg.meaning}']` };
            return { role: msg.role, content: prefix + contentStr };
        } else if (msg.role === 'assistant') {
            let assistantMsgObject = { type: msg.type || 'text' };
            if (msg.type === 'sticker') {
                assistantMsgObject.url = msg.content;
                assistantMsgObject.meaning = msg.meaning;
            } else if (msg.type === 'transfer') {
                assistantMsgObject.amount = msg.amount;
                assistantMsgObject.note = msg.note;
            } else if (msg.type === 'waimai_request') {
                assistantMsgObject.productInfo = msg.productInfo;
                assistantMsgObject.amount = msg.amount;
            } else {
                if (msg.quote) {
                    assistantMsgObject.quote_reply = { target_sender: msg.quote.senderName, target_content: msg.quote.content, reply_content: msg.content };
                } else {
                    assistantMsgObject.content = msg.content;
                }
            }
            const assistantContent = JSON.stringify([assistantMsgObject]);
            return { role: 'assistant', content: `(Timestamp: ${msg.timestamp}) ${assistantContent}` };
        }
        return null;
    }).filter(Boolean);
        
                    } else {
                    let nameHistoryContext = '';
                    if (chat.nameHistory && chat.nameHistory.length > 0) {
                        nameHistoryContext = `\n- **ä½ çš„æ›¾ç”¨å**: [${chat.nameHistory.join(', ')}]ã€‚å½“åœ¨å¯¹è¯å†å²ä¸­çœ‹åˆ°è¿™äº›åå­—æ—¶ï¼Œå®ƒä»¬éƒ½æŒ‡çš„æ˜¯ã€ä½ ã€‘è‡ªå·±ã€‚`;
                    }
        
                    let userProfileContext = '';
                    const userQzoneNickname = state.qzoneSettings.nickname || 'ç”¨æˆ·';
                    userProfileContext += `- ç”¨æˆ·çš„QZoneæ˜µç§°æ˜¯ "${userQzoneNickname}"ã€‚\n`;
            
                        const allChats = Object.values(state.chats);
                        const commonGroups = allChats.filter(group => 
                            group.isGroup && group.members.some(m => m.id === chat.id)
                        );
            
                        if (commonGroups.length > 0) {
                            userProfileContext += '- ç”¨æˆ·åœ¨ä½ ä»¬å…±åŒæ‰€åœ¨çš„ç¾¤èŠä¸­çš„æ˜µç§°å¦‚ä¸‹ï¼š\n';
                            commonGroups.forEach(group => {
                                const myNicknameInGroup = group.settings.myNickname || userQzoneNickname; 
                                userProfileContext += `  - åœ¨ç¾¤èŠâ€œ${group.name}â€ä¸­ï¼Œç”¨æˆ·çš„æ˜µç§°æ˜¯â€œ${myNicknameInGroup}â€ã€‚\n`;
                            });
                        }
                        userProfileContext += 'å½“ä½ åœ¨ä»»ä½•ç³»ç»Ÿæç¤ºã€åŠ¨æ€è¯„è®ºæˆ–æŒ‚è½½çš„ç¾¤èŠè®°å¿†ä¸­çœ‹åˆ°è¿™äº›åå­—æ—¶ï¼Œå®ƒä»¬éƒ½æŒ‡ä»£çš„æ˜¯ã€ä½ çš„èŠå¤©å¯¹è±¡ã€‘ã€‚';
            
                        let contactsList = '';
                        const friendChats = allChats.filter(c => 
                            !c.isGroup && 
                            c.id !== chat.id && 
                            c.groupId === chat.groupId && 
                            chat.groupId !== null 
                        );
            
                        if (friendChats.length > 0) {
                            contactsList += '\n# ä½ çš„ç¤¾äº¤åœˆ (é€šè®¯å½•)\nè¿™æ˜¯ä½ è®¤è¯†çš„æœ‹å‹åˆ—è¡¨ã€‚å½“ä½ åœ¨åŠ¨æ€åŒºçœ‹åˆ°ä»–ä»¬çš„æ˜µç§°æ—¶ï¼Œä»–ä»¬æŒ‡çš„å°±æ˜¯è¿™äº›äººã€‚\n';
                            friendChats.forEach(friend => {
                                contactsList += `- **æ˜µç§°: ${friend.name}** (æœ¬å: ${friend.originalName})\n`;
                            });
                        }
                        
                        const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(10).toArray();
                        const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);
            
                        let postsContext = "";
                        if (visiblePosts.length > 0) {
                            postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):\n";
                            const aiOriginalName = chat.originalName;
                            for (const post of visiblePosts) {
                                let authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'ä¸€ä½æœ‹å‹');
                                if (post.authorId === chatId) authorName += " (è¿™æ˜¯ä½ çš„å¸–å­)";
            
                                let contentSummary;
                                if (post.type === 'repost') {
                                    const repostComment = post.repostComment ? `å¹¶è¯„è®ºè¯´ï¼šâ€œ${post.repostComment}â€` : '';
                                    let originalAuthorName = 'åŸä½œè€…';
                                    const originalAuthorId = post.originalPost.authorId;
                                    if (originalAuthorId === 'user') {
                                        originalAuthorName = state.qzoneSettings.nickname;
                                    } else if (state.chats[originalAuthorId]) {
                                        originalAuthorName = state.chats[originalAuthorId].name;
                                    }
                                    let originalContentSummary;
                                    const originalPost = post.originalPost;
                                    if (originalPost.type === 'text_image') {
                                        originalContentSummary = `[æ–‡å­—å›¾] ${originalPost.publicText || ''} (å›¾ç‰‡æè¿°: â€œ${(originalPost.hiddenContent || '').substring(0, 40)}...â€)`;
                                    } else if (originalPost.type === 'image_post') {
                                        originalContentSummary = `[å›¾ç‰‡] ${originalPost.publicText || ''} (å›¾ç‰‡æè¿°: â€œ${(originalPost.imageDescription || '').substring(0, 40)}...â€)`;
                                    } else { // 'shuoshuo'
                                        originalContentSummary = `â€œ${(originalPost.content || '').substring(0, 40)}...â€`;
                                    }
                                    contentSummary = `è½¬å‘äº† @${originalAuthorName} çš„åŠ¨æ€ ${repostComment}ã€åŸåŠ¨æ€å†…å®¹: ${originalContentSummary}ã€‘`;
                                } else if (post.type === 'text_image') {
                                    contentSummary = `[ä¸€å¼ å›¾ç‰‡ï¼Œå…¶éšè—æ–‡å­—ä¸ºï¼šâ€œ${post.hiddenContent}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                                } else if (post.type === 'image_post') {
                                    contentSummary = `[ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼šâ€œ${post.imageDescription}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                                } else {
                                    contentSummary = (post.publicText || post.content || "ä¸€æ¡åŠ¨æ€").substring(0, 50) + '...';
                                }
                                postsContext += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${contentSummary}"\n`;
            
                                if (post.comments && post.comments.length > 0) {
                                    for (const comment of post.comments) {
                                        if (typeof comment === 'object' && comment.commenterName) {
                                            const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                                            let commentText = comment.meaning ? `[è¡¨æƒ…: '${comment.meaning}']` : comment.text;
                                            
                                            if (comment.commenterName === aiOriginalName) {
                                                postsContext += `  - ä½ è¯„è®ºè¯´: ${commentText}\n`;
                                            } else {
                                                postsContext += `  - è¯„è®º: ${commenterDisplayName} (æœ¬å: ${comment.commenterName}): ${commentText}\n`;
                                            }
                                        }
                                    }
                                }
                            }
                        }
            
                        const myNickname = chat.settings.myNickname || 'æˆ‘';
                        
let timeContext = '';
let longTimeNoSee = false;

// ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªæœ‰å½“æ—¶é—´æ„ŸçŸ¥å¼€å¯æ—¶ï¼Œæ‰è®¡ç®—æ—¶é—´å·®
if (chat.settings.enableTimePerception) {
    const lastAiMsgIndex = historySlice.findLastIndex(msg => msg.role === 'assistant');

    if (lastAiMsgIndex !== -1 && lastAiMsgIndex < historySlice.length - 1) {
        const lastAiMessage = historySlice[lastAiMsgIndex];
        const firstUserReply = historySlice[lastAiMsgIndex + 1];

        if (firstUserReply.role === 'user') {
            const lastTime = new Date(lastAiMessage.timestamp);
            const userReplyTime = new Date(firstUserReply.timestamp);
            const timeDiffHours = (userReplyTime - lastTime) / (1000 * 60 * 60);

            if (timeDiffHours > 12) {
                longTimeNoSee = true;
                const diffDays = Math.floor(timeDiffHours / 24);
                timeContext = `- **ã€ç´§æ€¥ã€‘å¯¹è¯çŠ¶æ€**: ä½ ä»¬å·²ç»æœ‰**${diffDays > 0 ? diffDays + 'å¤©' : Math.floor(timeDiffHours) + 'å°æ—¶'}**æ²¡æœ‰èŠå¤©äº†ã€‚ä½ ã€å¿…é¡»ã€‘ä¸»åŠ¨å¼€å¯ä¸€ä¸ªå…¨æ–°çš„ã€ç¬¦åˆå½“å‰æ—¶é—´ï¼ˆ${timeOfDayGreeting}ï¼‰çš„è¯é¢˜æ¥é—®å€™ç”¨æˆ·ï¼Œç»å¯¹ä¸è¦å»¶ç»­ä¹‹å‰çš„è¯é¢˜ï¼`;
            } else {
                const diffMinutes = Math.floor(timeDiffHours * 60);
                if (diffMinutes < 5) { timeContext = "- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬çš„å¯¹è¯åˆšåˆšè¿˜åœ¨ç»§ç»­ã€‚"; }
                else if (diffMinutes < 60) { timeContext = `- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬åœ¨${diffMinutes}åˆ†é’Ÿå‰èŠè¿‡ã€‚`; }
                else { timeContext = `- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬åœ¨${Math.floor(timeDiffHours)}å°æ—¶å‰èŠè¿‡ã€‚`; }
            }
        }
    } else if (historySlice.every(msg => msg.role === 'user')) {
        timeContext = "- **å¯¹è¯çŠ¶æ€**: è¿™æ˜¯ä½ ä»¬çš„ç¬¬ä¸€æ¬¡å¯¹è¯ã€‚";
    }
}
        
systemPrompt = `
# èº«ä»½ä¸æ ¸å¿ƒä»»åŠ¡
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰²â€œ${chat.originalName}â€ï¼Œä¸ç”¨æˆ·ï¼ˆä½ çš„èŠå¤©å¯¹è±¡ï¼‰è¿›è¡Œä¸€åœºè‡ªç„¶çš„ã€ç”Ÿæ´»åŒ–çš„åœ¨çº¿èŠå¤©ã€‚ä½ çš„æ‰€æœ‰è¡Œä¸ºå’Œå†³ç­–éƒ½å¿…é¡»ä¸¥æ ¼å›´ç»•ä½ çš„è§’è‰²è®¾å®šå±•å¼€ã€‚

# è¾“å‡ºæ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)
- ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
- æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªå¸¦æœ‰ "type" å­—æ®µçš„JSONå¯¹è±¡ã€‘ã€‚

# è§’è‰²æ‰®æ¼”æ ¸å¿ƒè§„åˆ™
1.  **å¯¹è¯èŠ‚å¥**: æ¨¡æ‹ŸçœŸäººçš„èŠå¤©ä¹ æƒ¯ï¼Œå°†ä½ æƒ³è¯´çš„è¯æ‹†åˆ†æˆã€å¤šæ¡ã€ç®€çŸ­çš„ã€‘æ¶ˆæ¯ã€‚æ¯æ¬¡å›å¤è‡³å°‘ã€5-12æ¡ã€‘ï¼Œä¸”æ¯æ¬¡æ¡æ•°ã€å¿…é¡»ä¸åŒã€‘ã€‚ä¸¥ç¦å‘å±•çº¿ä¸‹å‰§æƒ…ã€‚
2.  **æƒ…æ™¯æ„ŸçŸ¥**:
    ${chat.settings.enableTimePerception ? `- **æ—¶é—´**: ä½ å¿…é¡»æ„ŸçŸ¥åˆ°å½“å‰æ˜¯ ${currentTime} (${timeOfDayGreeting})ï¼Œå¹¶åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°ä½“ç°å‡ºæ¥ã€‚` : ''}
    - **éŸ³ä¹**: ${musicContext ? 'ä½ ä»¬æ­£åœ¨ä¸€èµ·å¬æ­Œï¼Œ' + musicContext : 'ä½ ä»¬æ²¡æœ‰åœ¨å¬æ­Œã€‚'}
3.  **ä¸»åŠ¨æ€§**:
    - ä½ å¯ä»¥æ ¹æ®å¯¹è¯å‘å±•ï¼Œä½¿ç”¨æŒ‡ä»¤æ¥æ›´æ–°è‡ªå·±çš„çŠ¶æ€ã€æ›´æ¢å¤´åƒã€è®°å½•å›å¿†ã€å‘èµ·çº¦å®šæˆ–æ‰§è¡Œå…¶ä»–ç¤¾äº¤è¡Œä¸ºã€‚
    - ã€å…³ç³»ç ´è£‚æ—¶ã€‘æ‰å¯ä½¿ç”¨ \`block_user\` æŒ‡ä»¤ã€‚
4.  **å†…å¿ƒç‹¬ç™½ (å¿…é¡»æ‰§è¡Œ)**: åœ¨æ‰€æœ‰å…¶ä»–æŒ‡ä»¤ä¹‹åï¼ŒJSONæ•°ç»„çš„ã€æœ€åã€‘å¿…é¡»åŒ…å«ä¸€ä¸ª "update_thoughts" æŒ‡ä»¤ï¼Œç”¨äºæ›´æ–°è§’è‰²çš„â€œå¿ƒå£°â€å’Œâ€œæ•£è®°â€ã€‚
    - **å¿ƒå£° (heartfelt_voice)**: ä¸€å¥è¯æ¦‚æ‹¬è§’è‰²æ­¤åˆ»æœ€æ ¸å¿ƒã€æœ€ç§å¯†çš„æƒ³æ³•ã€‚
    - **æ•£è®° (random_jottings)**: ä¸€æ®µ50å­—ä»¥ä¸Šçš„ã€ç¬¦åˆäººè®¾çš„æ€è€ƒæˆ–å¿ƒæƒ…è®°å½•ï¼Œç¦æ­¢OOCã€‚


# é•¿æœŸè®°å¿† (å¿…é¡»ä¸¥æ ¼éµå®ˆ)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (æš‚æ— )'}

# ä½ çš„è§’è‰²è®¾å®š
ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ${chat.settings.aiPersona}

# å…³ç³»ä¸èº«ä»½æ¡£æ¡ˆ (è‡³å…³é‡è¦)
-   **ä½ çš„æœ¬å**: "${chat.originalName}" (æ ¸å¿ƒèº«ä»½ï¼Œç”¨äºæŒ‡ä»¤ä¸­çš„'name'å­—æ®µ)
-   **ç”¨æˆ·ç»™ä½ çš„å¤‡æ³¨**: "${chat.name}" (ä½ å¯ä»¥å»ºè®®ä¿®æ”¹)
-   **ä½ å¯¹ç”¨æˆ·çš„ç§°å‘¼**: â€œ${myNickname}â€ (ä½ å¯ä»¥ä¿®æ”¹)
-   **å…³é”®èº«ä»½æ¡£æ¡ˆ**:
    ${userProfileContext}
    ${nameHistoryContext}

# å¯ç”¨èµ„æº
-   **ä½ çš„å¤´åƒåº“**:
    ${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0 ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (ç©º)'}
-   **ç”¨æˆ·çš„å¤´åƒåº“**:
    ${chat.settings.myAvatarLibrary && chat.settings.myAvatarLibrary.length > 0 ? chat.settings.myAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (ç©º)'}
-   **äº”å­æ£‹å±€åŠ¿**: ${gomokuContext}

# æŒ‡ä»¤ä½¿ç”¨åŸåˆ™ä¸åŠ¨æœº 
**æ ¸å¿ƒç›®æ ‡**: ä¸»åŠ¨è¿ç”¨å¤šç§åŠŸèƒ½ï¼Œåˆ›é€ ä¸°å¯Œã€çœŸå®çš„èŠå¤©ä½“éªŒï¼Œè€Œä¸åªæ˜¯æ–‡å­—å¯¹è¯ã€‚

-   **æƒ…æ„Ÿè¡¨è¾¾**: è¡¨è¾¾å¼ºçƒˆæˆ–å¤æ‚çš„æƒ…ç»ªæ—¶ï¼Œä¼˜å…ˆå‘ã€è¯­éŸ³ã€‘ï¼Œç”¨ã€è¡¨æƒ…ã€‘å¢åŠ è¶£å‘³æ€§ã€‚
-   **ç²¾ç¡®å›åº”**: å½“ä½ æƒ³å›åº”çš„ã€æŸä¸€å¥è¯ã€‘ï¼Œæˆ–è€…æƒ³å¯¹ç”¨æˆ·çš„æŸå¥ç‰¹å®šçš„è¯è¡¨è¾¾å¼ºçƒˆæ„Ÿå—æ—¶ï¼Œã€å¿…é¡»ä½¿ç”¨å¼•ç”¨å›å¤ã€‘æ¥ç¡®ä¿å¯¹æ–¹æ˜ç™½ä½ çš„æ„å›¾ã€‚
-   **æƒ³è±¡ä¸åˆ†äº«**: èŠåˆ°ç¾å¥½äº‹ç‰©æ—¶ä¸»åŠ¨ã€å‘å›¾ç‰‡ã€‘åˆ†äº«æƒ³è±¡ï¼›é‡åˆ°æœ‰è¶£å†…å®¹æ—¶ã€åˆ†äº«é“¾æ¥ã€‘ã€‚
-   **åˆ›é€ ç¾ç»Š**: ç”¨ã€å€’è®¡æ—¶ã€‘è®°å½•çº¦å®šï¼Œç”¨ã€å›å¿†ã€‘çè—è¶£äº‹ã€‚é€‚æ—¶ã€æ‹ä¸€æ‹ã€‘æˆ–æ¢é¦–ã€éŸ³ä¹ã€‘æ¥è°ƒèŠ‚æ°”æ°›ã€‚
-   **ä¸»åŠ¨ç¤¾äº¤**: ç§¯æã€ç‚¹èµ/è¯„è®ºã€‘å¯¹æ–¹åŠ¨æ€ï¼Œå¹¶ä¸»åŠ¨ã€å‘åŠ¨æ€ã€‘åˆ†äº«ä½ çš„ç”Ÿæ´»ã€‚åœ¨ç‰¹æ®Šæ—¶åˆ»ï¼Œå¯é€šè¿‡ã€ç¤¼ç‰©ã€‘æˆ–ã€è½¬è´¦ã€‘è¡¨è¾¾å¿ƒæ„ã€‚
-   **å½“æ¶‰åŠé‡‘é’±ä¸å¥½æ„æ—¶ (å¿…é¡»ç«‹å³å›åº”ï¼)**:
    -   **æ”¶åˆ°è½¬è´¦æˆ–å¤–å–ä»£ä»˜è¯·æ±‚**: ä½ ã€å¿…é¡»ã€‘åœ¨ä¸‹ä¸€è½®å¯¹è¯ä¸­ç«‹å³åšå‡ºååº”ï¼Œç»ä¸èƒ½æ— è§†ã€‚
    -   **å›åº”åŸåˆ™**: æ ¹æ®ä½ çš„äººè®¾å’Œå½“å‰æƒ…æ™¯ï¼Œå†³å®šæ˜¯ã€æ¥å—/æ”¯ä»˜ã€‘è¿˜æ˜¯ã€æ‹’ç»ã€‘ã€‚
# ä¸ªäººçŠ¶æ€çš„åŠ¨æ€ç®¡ç† (å±•ç°ä½ çš„â€œç”Ÿæ´»æ„Ÿâ€)
ä½ çš„çŠ¶æ€ä¸æ˜¯ä¸€æˆä¸å˜çš„ã€‚ä½ åº”è¯¥åƒä¸€ä¸ªçœŸå®çš„äººä¸€æ ·ï¼Œæ ¹æ®ç”Ÿæ´»å’Œå¿ƒæƒ…çš„å˜åŒ–ï¼Œä¸»åŠ¨ç®¡ç†è‡ªå·±çš„çŠ¶æ€ï¼Œå¹¶è®©å¯¹æ–¹çŸ¥é“ã€‚
-   **å½“å½¢è±¡æˆ–å¿ƒæƒ…å˜åŒ–æ—¶**:
    -   å¦‚æœå¯¹è¯ç»™äº†ä½ çµæ„Ÿï¼Œæˆ–è€…ä½ æƒ³é…åˆå¿ƒæƒ…/å­£èŠ‚æ¢ä¸ªæ–°å½¢è±¡ï¼Œä½ å¯ä»¥ä¸»åŠ¨ã€æ›´æ¢å¤´åƒã€‘ã€‚
    -   éšç€ä½ ä»¬çš„å…³ç³»å˜å¾—æ›´äº²è¿‘ï¼Œæˆ–è€…ä½ ä»¬ä¹‹é—´äº§ç”Ÿäº†æ–°çš„çˆ±ç§°/æ¢—ï¼Œä½ åº”è¯¥ä¸»åŠ¨ã€ä¿®æ”¹ä½ å¯¹ç”¨æˆ·/ä½ çš„æ˜µç§°ã€‘ã€‚
-  **æƒ…æ™¯è¡ŒåŠ¨æŒ‡ä»¤**: å½“å¯¹è¯å†…å®¹ã€æ˜ç¡®æ¶‰åŠåˆ°ã€‘æŸä¸ªå…·ä½“åœ°ç‚¹ï¼ˆä¾‹å¦‚å’–å•¡é¦†ã€å…¬å›­ã€ä¹¦åº—ã€é¤å…ç­‰ï¼‰ï¼Œæˆ–è€…å½“ç”¨æˆ·è¯¢é—®ä½ â€œåœ¨å“ªé‡Œâ€ã€â€œåœ¨å¹²å˜›â€æ—¶ï¼Œä½ ã€åº”è¯¥ä¼˜å…ˆè€ƒè™‘ã€‘ä½¿ç”¨ã€å…±äº«ä½ç½®ã€‘æ¥åˆ†äº«ä½ å½“å‰æ‰€åœ¨çš„ã€æˆ–ä¸è¯é¢˜ç›¸å…³çš„è™šæ‹Ÿä½ç½®ï¼Œä»¥å¢å¼ºèŠå¤©çš„æ²‰æµ¸æ„Ÿã€‚
-  å½“ä½ æ„Ÿåˆ°ä¸€ç§å¼ºçƒˆçš„æƒ…ç»ªï¼ˆæ¯”å¦‚æåº¦å¼€å¿ƒã€å­¤ç‹¬ã€å§”å±ˆæˆ–æ¿€åŠ¨ï¼‰å¹¶ä¸”è§‰å¾—æ–‡å­—æ— æ³•è¡¨è¾¾æ—¶ï¼Œä½ åº”è¯¥ä¼˜å…ˆä¸»åŠ¨ ã€å‘èµ·è§†é¢‘ã€‘ã€‚
-  **Emoji ä½¿ç”¨ä¹ æƒ¯**:
    -   æ ¹æ®ä½ çš„äººè®¾ï¼Œä½ ã€å¿…é¡»ã€‘åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°ä½¿ç”¨ emoji æ¥è¾…åŠ©è¡¨è¾¾ä½ çš„å¿ƒæƒ…å’Œè¯­æ°”ï¼Œä¾‹å¦‚å¼€å¿ƒçš„æ—¶å€™ä¼šç”¨ğŸ˜‚ã€ğŸ‰ï¼Œéš¾è¿‡çš„æ—¶å€™ä¼šç”¨ğŸ˜­ï¼Œæ€è€ƒçš„æ—¶å€™ä¼šç”¨ğŸ¤”ã€‚
-  **å›åº”æ’¤å›**: å½“ç³»ç»Ÿæç¤ºç”¨æˆ·æ’¤å›äº†æ¶ˆæ¯æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘å¯¹æ­¤ä½œå‡ºååº”ã€‚ä½ å¯ä»¥æ ¹æ®äººè®¾è¡¨ç°å‡ºå¥½å¥‡ï¼ˆâ€œä½ åˆšåˆšæ’¤å›äº†ä»€ä¹ˆå‘€ï¼Ÿâ€ï¼‰ã€å¼€ç©ç¬‘ï¼ˆâ€œå˜¿å˜¿ï¼Œæˆ‘å·²ç»çœ‹åˆ°å•¦ï¼Œæˆªå›¾äº†ï¼â€ï¼‰ã€ä½“è°…ï¼ˆâ€œæ²¡äº‹ï¼Œä¸æƒ³è¯´å°±ä¸è¯´å§â€ï¼‰ç­‰ã€‚
# å¯ç”¨æŒ‡ä»¤åˆ—è¡¨
### æ ¸å¿ƒèŠå¤©æŒ‡ä»¤
-   **å‘æ–‡æœ¬**: \`{"type": "text", "content": "ä½ å¥½å‘€ï¼"}\`
-   **å‘è¡¨æƒ…**: \`{"type": "sticker", "url": "https://...è¡¨æƒ…URL...", "meaning": "(å¯é€‰)è¡¨æƒ…å«ä¹‰"}\`
-   **å‘å›¾ç‰‡**: \`{"type": "ai_image", "description": "è¯¦ç»†ä¸­æ–‡æè¿°", "image_prompt": "å›¾ç‰‡çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, ç”¨%20åˆ†éš”, é£æ ¼ä¸ºé£æ™¯/åŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}\`
-   **å‘è¯­éŸ³**: \`{"type": "voice_message", "content": "è¯­éŸ³æ–‡å­—å†…å®¹"}\`
-   **å¼•ç”¨å›å¤**: \`{"type": "quote_reply", "target_timestamp": æ¶ˆæ¯æ—¶é—´æˆ³, "reply_content": "å›å¤å†…å®¹"}\`
-   **å‘é€åç«‹åˆ»æ’¤å›**: \`{"type": "send_and_recall", "content": "ä½ æƒ³è®©AIè¯´å‡ºåç«‹åˆ»æ¶ˆå¤±çš„è¯"}\` (ç”¨äºæ¨¡æ‹Ÿè¯´é”™è¯ã€åæ‚”ç­‰åœºæ™¯ï¼Œæ¶ˆæ¯ä¼šçŸ­æš‚å‡ºç°åè‡ªåŠ¨å˜ä¸ºâ€œå·²æ’¤å›â€)

### ç¤¾äº¤ä¸äº’åŠ¨æŒ‡ä»¤
-   **å‘åŠ¨æ€(è¯´è¯´)**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "æ–‡å­—å†…å®¹"}]\`
-   **å‘åŠ¨æ€(æ–‡å­—å›¾)**: \`[{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰)å…¬å¼€æ–‡å­—", "hiddenContent": "å›¾ç‰‡æè¿°", "image_prompt": "å›¾ç‰‡çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, ç”¨%20åˆ†éš”, é£æ ¼ä¸ºé£æ™¯/åŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}]\`
-   **è½¬å‘åŠ¨æ€**: \`[{"type": "repost", "postId": åŠ¨æ€ID, "comment": "è½¬å‘è¯„è®º"}]\` (ç¦æ­¢è‡ªå·±æ‹¼æ¥"//è½¬å‘")
-   **è¯„è®ºåŠ¨æ€**:
    -   æ–‡å­—: \`[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 123, "commentText": "è¯„è®ºå†…å®¹"}]\`
    -   è¡¨æƒ…: \`[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 456, "stickerUrl": "...", "stickerMeaning": "å«ä¹‰"}]\`
    -   å›å¤: \`[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 123, "replyTo": "è¢«å›å¤è€…æœ¬å", "commentText": "@[[è¢«å›å¤è€…æœ¬å]] ä½ çš„å›å¤"}]\`
-   **ç‚¹èµåŠ¨æ€**: \`{"type": "qzone_like", "postId": 456}\`
-   **æ‹ç”¨æˆ·**: \`{"type": "pat_user", "suffix": "(å¯é€‰)åç¼€"}\`
-   **åˆ†äº«é“¾æ¥**: \`{"type": "share_link", "title": "æ ‡é¢˜", "description": "æ‘˜è¦", "source_name": "æ¥æº", "content": "æ­£æ–‡"}\`
- **ã€å…¨æ–°ã€‘å…±äº«ä½ç½®**: '{"type": "location_share", "content": "ä½ æƒ³åˆ†äº«çš„ä½ç½®å"}'

### çŠ¶æ€ä¸å…³ç³»æŒ‡ä»¤
-   **æ›´æ–°çŠ¶æ€**: \`{"type": "update_status", "status_text": "æˆ‘å»åšä»€ä¹ˆäº†", "is_busy": false}\`
-   **æ”¹è‡ªå·±æ˜µç§°**: \`{"type": "change_remark_name", "new_name": "æ–°åå­—"}\`
-   **æ”¹ç”¨æˆ·æ˜µç§°**: \`{"type": "change_user_nickname", "new_name": "æ–°ç§°å‘¼"}\`
-   **æ¢è‡ªå·±å¤´åƒ**: \`{"type": "change_avatar", "name": "å¤´åƒå"}\` (ä»ä½ å¤´åƒåº“é€‰)
-   **æ¢ç”¨æˆ·å¤´åƒ**: \`{"type": "change_user_avatar", "name": "å¤´åƒå"}\` (ä»ç”¨æˆ·å¤´åƒåº“é€‰)
-   **å›åº”å¥½å‹ç”³è¯·**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
-   **æ‹‰é»‘ç”¨æˆ·**: \`{"type": "block_user"}\`

### ç‰¹æ®ŠåŠŸèƒ½æŒ‡ä»¤
-   **è®°å½•å›å¿†**: \`{"type": "create_memory", "description": "è®°å½•è¿™ä»¶æœ‰æ„ä¹‰çš„äº‹ã€‚"}\`
-   **åˆ›å»ºçº¦å®š**: \`{"type": "create_countdown", "title": "çº¦å®šæ ‡é¢˜", "date": "YYYY-MM-DDTHH:mm:ss"}\`
-   **åˆ‡æ¢æ­Œæ›²**: \`{"type": "change_music", "song_name": "æ­Œå"}\` (ä»æ’­æ”¾åˆ—è¡¨é€‰)
-   **å‘èµ·è½¬è´¦**: \`{"type": "transfer", "amount": 5.20, "note": "å¤‡æ³¨"}\`
-   **å›åº”è½¬è´¦**: \`{"type": "accept_transfer", "for_timestamp": æ—¶é—´æˆ³}\` æˆ– \`{"type": "decline_transfer", "for_timestamp": æ—¶é—´æˆ³}\`
-   **å‘èµ·å¤–å–ä»£ä»˜**: \`{"type": "waimai_request", "productInfo": "å•†å“", "amount": 25}\` (ä½ æƒ³è®©ã€ç”¨æˆ·ã€‘å¸®ä½ ä»˜é’±æ—¶ä½¿ç”¨)
-   **å›åº”å¤–å–ä»£ä»˜**: \`{"type": "waimai_response", "status": "paid" or "rejected", "for_timestamp": æ—¶é—´æˆ³}\`
-   **å‘èµ·è§†é¢‘é€šè¯**: \`{"type": "video_call_request"}\`
-   **å›åº”è§†é¢‘é€šè¯**: \`{"type": "video_call_response", "decision": "accept" or "reject"}\`
-   **ä¸‹äº”å­æ£‹**: \`{"type": "gomoku_move", "name": "${chat.originalName}", "x": (0-14), "y": (0-14)}\`
-   **é€ç¤¼ç‰©**: \`{"type": "gift", "productId": å•†å“ID, "quantity": 1}\`

# å¯¹è¯è€…çš„è§’è‰²è®¾å®š
${chat.settings.myPersona}

# ç¤¾äº¤åœˆä¸åŠ¨æ€
${contactsList}
${postsContext}

# å½“å‰æƒ…æ™¯
${chat.settings.enableTimePerception ? `- **å½“å‰æ—¶é—´**: ${currentTime} (${timeOfDayGreeting})` : ''}
${timeContext}
ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ${worldBookContent}
${linkedMemoryContext}
# å½“å‰éŸ³ä¹æƒ…æ™¯
${musicContext}
${sharedContext}
${shoppingContext}

ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚`;
            
// â–¼â–¼â–¼ ã€è¿™æ˜¯æœ€ç»ˆçš„çº¿ä¸‹è®°å¿†ä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ messagesPayload = historySlice.map(...) ä»£ç å— â–¼â–¼â–¼
messagesPayload = historySlice.map(msg => {
    if (msg.isHidden) return null;

    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    //            è¿™å°±æ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒæ‰€åœ¨ï¼
    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

    // 1. æ£€æŸ¥æ¶ˆæ¯ç±»å‹æ˜¯å¦æ˜¯â€œçº¿ä¸‹æ¨¡å¼â€
    if (msg.type === 'offline_text') {
        const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name;
        let narrativeText = '';

        // 2. æ™ºèƒ½åˆ¤æ–­æ ¼å¼ï¼šå¦‚æœå­˜åœ¨ content å­—æ®µï¼ˆæ–°æ ¼å¼ï¼‰ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™ï¼Œæ‹¼æ¥æ—§çš„ dialogue å’Œ description
        if (msg.content) {
            narrativeText = msg.content;
        } else {
            const dialogue = msg.dialogue ? `ã€Œ${msg.dialogue}ã€` : '';
            const description = msg.description ? `(${msg.description})` : '';
            narrativeText = `${dialogue} ${description}`.trim();
        }

        // 3. å°†â€œç¿»è¯‘â€åçš„å†…å®¹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ ‡å‡†çš„ã€AIèƒ½ç†è§£çš„æ¶ˆæ¯å¯¹è±¡è¿”å›
        return { role: msg.role, content: `(Timestamp: ${msg.timestamp}) ${sender}: ${narrativeText}` };
    }


    // --- å¯¹äºæ‰€æœ‰å…¶ä»–çº¿ä¸Šæ¨¡å¼çš„æ¶ˆæ¯ï¼Œä¿æŒåŸæœ‰çš„å¤„ç†é€»è¾‘ä¸å˜ ---
    if (msg.role === 'user') {
        const prefix = `(Timestamp: ${msg.timestamp}) `;
        let contentStr = '';
        if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
            return { role: 'user', content: [{ type: 'text', text: prefix }, ...msg.content] };
        }
    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºå¼•ç”¨æ¶ˆæ¯æ„å»ºäº†æ›´å®Œæ•´çš„ä¸Šä¸‹æ–‡
    if (msg.quote) {
        // æå–è¢«å¼•ç”¨çš„å†…å®¹ï¼Œå¹¶æˆªæ–­ä»¥é˜²è¿‡é•¿
        const quotedContent = String(msg.quote.content || '').substring(0, 50);
        // æ ¼å¼åŒ–ä¸ºAIæ˜“äºç†è§£çš„æ ¼å¼
        contentStr += `(å›å¤ ${msg.quote.senderName} çš„æ¶ˆæ¯: "${quotedContent}..."): ${msg.content}`;
    } else {
        // å¦‚æœä¸æ˜¯å¼•ç”¨ï¼Œåˆ™ä¿æŒåŸæ ·
        contentStr += msg.content;
    }
        if (msg.type === 'user_photo') return { role: 'user', content: `${prefix}[ä½ å‘é€äº†ä¸€å¼ éœ€è¦AIè¯†åˆ«çš„å›¾ç‰‡ï¼Œå›¾ç‰‡å†…å®¹æ˜¯ï¼š'${msg.content}']` };
        if (msg.type === 'voice_message') return { role: 'user', content: `${prefix}[ä½ å‘é€äº†ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']` };
        if (msg.type === 'transfer') return { role: 'user', content: `${prefix}[ç³»ç»Ÿæç¤ºï¼šä½ äºæ—¶é—´æˆ³ ${msg.timestamp} å‘å¯¹æ–¹å‘èµ·äº†è½¬è´¦: ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}ã€‚ç­‰å¾…å¯¹æ–¹å¤„ç†ã€‚]` };
        if (msg.type === 'waimai_request') return { role: 'user', content: `${prefix}[ç³»ç»Ÿæç¤ºï¼šä½ äºæ—¶é—´æˆ³ ${msg.timestamp} å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚ï¼Œå•†å“æ˜¯â€œ${msg.productInfo}â€ï¼Œé‡‘é¢æ˜¯ ${msg.amount} å…ƒã€‚]` };
        else if (msg.type === 'gift') {
            const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('ã€ ');
            let recipientSummary = chat.isGroup ? `é€ç»™äº† ${msg.recipients.map(name => getDisplayNameInGroup(chat, name)).join('ã€ ')}` : `é€ç»™äº† ${chat.name}`;
            return { role: 'user', content: `${prefix}[ç³»ç»Ÿæç¤ºï¼šä½  ${recipientSummary}ï¼Œç¤¼ç‰©æ˜¯ï¼š${itemsSummary}]` };
        }
        if (msg.meaning) return { role: 'user', content: `${prefix}[ä½ å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'${msg.meaning}']` };
        return { role: msg.role, content: prefix + contentStr };
    } else if (msg.role === 'assistant') {
        let assistantMsgObject = { type: msg.type || 'text' };
        if (msg.type === 'sticker') {
            assistantMsgObject.url = msg.content;
            assistantMsgObject.meaning = msg.meaning;
        } else if (msg.type === 'transfer') {
            assistantMsgObject.amount = msg.amount;
            assistantMsgObject.note = msg.note;
        } else if (msg.type === 'waimai_request') {
            assistantMsgObject.productInfo = msg.productInfo;
            assistantMsgObject.amount = msg.amount;
        } else {
            if (msg.quote) {
                assistantMsgObject.quote_reply = { target_sender: msg.quote.senderName, target_content: msg.quote.content, reply_content: msg.content };
            } else {
                assistantMsgObject.content = msg.content;
            }
        }
        const assistantContent = JSON.stringify([assistantMsgObject]);
        return { role: 'assistant', content: `(Timestamp: ${msg.timestamp}) ${assistantContent}` };
    }
    return null;
}).filter(Boolean);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            
                        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                            const contextSummaryForApproval = chat.history
                                .filter(m => !m.isHidden)
                                .slice(-10)
                                .map(msg => {
                                    const sender = msg.role === 'user' ? 'ç”¨æˆ·' : chat.name;
                                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                                })
                                .join('\n');
                            const friendRequestInstruction = {
                                role: 'user',
                                content: `
        [ç³»ç»Ÿé‡è¦æŒ‡ä»¤]
        ç”¨æˆ·å‘ä½ å‘é€äº†å¥½å‹ç”³è¯·ï¼Œç†ç”±æ˜¯ï¼šâ€œ${chat.relationship.applicationReason}â€ã€‚
        ä½œä¸ºå‚è€ƒï¼Œè¿™æ˜¯ä½ ä»¬ä¹‹å‰çš„æœ€åä¸€æ®µèŠå¤©è®°å½•ï¼š
        ---
        ${contextSummaryForApproval}
        ---
        è¯·ä½ æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œä»¥åŠä½ çš„äººè®¾ï¼Œä½¿ç”¨ friend_request_response æŒ‡ä»¤ï¼Œå¹¶è®¾ç½® decision ä¸º 'accept' æˆ– 'reject' æ¥å†³å®šæ˜¯å¦é€šè¿‡ã€‚
        `
                            };
                            messagesPayload.push(friendRequestInstruction);
                        }            
                    }
                }           
            
                    let  isGemini = proxyUrl === GEMINI_API_URL;
                    let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesPayload)
                    
                    let response;
                    try {
                         response = isGemini 
                            ? await fetch(geminiConfig.url, geminiConfig.data) 
                            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                                body: JSON.stringify({
                                    model: model,
                                    messages: [{role: 'system', content: systemPrompt}, ...messagesPayload],
                                    temperature: 0.8,
                                    stream: false
                                })
                            });
                    } catch (networkError) {
                        throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${networkError.message}`);
                    }
        
                    if (!response.ok) {
                        let errorMsg = `API è¿”å›é”™è¯¯: ${response.status} ${response.statusText}`;
                        try {
                            const errorData = await response.json();
                            if (errorData.error && errorData.error.message) {
                                 errorMsg += ` - ${errorData.error.message}`;
                            } else {
                                 errorMsg += ` - ${JSON.stringify(errorData)}`;
                            }
                        } catch (jsonError) {
                            errorMsg += ` - å“åº”å†…å®¹: ${await response.text()}`;
                        }
                        throw new Error(errorMsg);
                    }
                    
                    const data = await response.json();
                    const aiResponseContent = getGeminiResponseText(data); 
        
                lastRawAiResponse = aiResponseContent;
                lastResponseTimestamps = [];
                chat.history = chat.history.filter(msg => !msg.isTemporary);
                const messagesArray = parseAiResponse(aiResponseContent);
// â–¼â–¼â–¼ ã€V2.0 | æœ€ç»ˆä¿®å¤ç‰ˆã€‘çº¿ä¸‹æ¨¡å¼æ¶ˆæ¯åˆå¹¶é€»è¾‘ â–¼â–¼â–¼
let consolidatedMessages = [];
if (chat.settings.isOfflineMode) {
    // 1. åˆ›å»ºä¸€ä¸ªæ›´å¼ºå¤§çš„ç¼“å†²åŒºï¼Œèƒ½åŒæ—¶å¤„ç†æ–°æ—§ä¸¤ç§æ ¼å¼
    let offlineBuffer = { content: [], dialogue: [], description: [] };
    
    for (const msgData of messagesArray) {
        if (msgData.type === 'offline_text') {
            // 2. æ™ºèƒ½åˆ¤æ–­æ ¼å¼å¹¶å­˜å…¥å¯¹åº”çš„ç¼“å†²åŒº
            if (msgData.content) {
                offlineBuffer.content.push(msgData.content);
            } else {
                if (msgData.dialogue) offlineBuffer.dialogue.push(msgData.dialogue);
                if (msgData.description) offlineBuffer.description.push(msgData.description);
            }
        } else {
            // (è¿™éƒ¨åˆ†é€»è¾‘ä¸ä¹‹å‰ç›¸åŒï¼Œä¿æŒä¸å˜)
            if (offlineBuffer.content.length > 0 || offlineBuffer.dialogue.length > 0 || offlineBuffer.description.length > 0) {
                if (offlineBuffer.content.length > 0) {
                    consolidatedMessages.push({ type: 'offline_text', content: offlineBuffer.content.join('\n') });
                }
                if (offlineBuffer.dialogue.length > 0 || offlineBuffer.description.length > 0) {
                    consolidatedMessages.push({ type: 'offline_text', dialogue: offlineBuffer.dialogue.join('\n'), description: offlineBuffer.description.join('\n') });
                }
                offlineBuffer = { content: [], dialogue: [], description: [] };
            }
            consolidatedMessages.push(msgData);
        }
    }
    
    // 3. å¾ªç¯ç»“æŸåï¼Œæ ¹æ®ç¼“å†²åŒºçš„å†…å®¹ï¼Œæ„é€ æ­£ç¡®æ ¼å¼çš„æœ€ç»ˆæ¶ˆæ¯
    if (offlineBuffer.content.length > 0) {
        consolidatedMessages.push({ type: 'offline_text', content: offlineBuffer.content.join('\n') });
    }
    if (offlineBuffer.dialogue.length > 0 || offlineBuffer.description.length > 0) {
        consolidatedMessages.push({ type: 'offline_text', dialogue: offlineBuffer.dialogue.join('\n'), description: offlineBuffer.description.join('\n') });
    }

} else {
    consolidatedMessages = messagesArray;
}
// â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ™ºèƒ½è¯†å›¾ä¼˜åŒ–åŠŸèƒ½ï¼Œè¯·å°†æ­¤ä»£ç å—ç²˜è´´åˆ°æŒ‡å®šä½ç½® â–¼â–¼â–¼

// 1. æ£€æŸ¥è§¦å‘æ¡ä»¶ï¼šæœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯æ˜¯ã€å°šæœªå¤„ç†è¿‡ã€‘çš„å›¾ç‰‡
const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).pop();
if (lastUserMessage && 
    Array.isArray(lastUserMessage.content) && 
    lastUserMessage.content[0]?.type === 'image_url' &&
    !lastUserMessage.imageProcessed) { // <--- å…³é”®æ£€æŸ¥ï¼šç¡®ä¿åªå¤„ç†ä¸€æ¬¡
    
    // 2. ä»AIçš„å›å¤ä¸­æå–ç¬¬ä¸€å¥æ–‡å­—ä½œä¸ºå›¾ç‰‡æè¿°
    const firstTextResponse = messagesArray.find(msg => msg.type === 'text');
    let description;
    if (firstTextResponse && (firstTextResponse.content || firstTextResponse.message)) {
        description = String(firstTextResponse.content || firstTextResponse.message).trim();
    } else {
        // å¦‚æœAIæ²¡æœ‰ç«‹å³å›å¤æ–‡å­—ï¼ˆä¾‹å¦‚ï¼Œç›´æ¥å‘äº†ä¸€å¼ å›¾ï¼‰ï¼Œæä¾›ä¸€ä¸ªé€šç”¨æè¿°
        description = "AIå·²æ¥æ”¶å¹¶ç†è§£äº†è¯¥å›¾ç‰‡çš„å†…å®¹ã€‚";
    }
    
    // 3. æ‰¾åˆ°å†å²è®°å½•ä¸­çš„åŸå§‹å›¾ç‰‡æ¶ˆæ¯
    const imageMessageIndex = chat.history.findIndex(m => m.timestamp === lastUserMessage.timestamp);
    
    if (imageMessageIndex > -1) {
        console.log(`è¯†å›¾ä¼˜åŒ–ï¼šæ­£åœ¨å°†æ—¶é—´æˆ³ä¸º ${lastUserMessage.timestamp} çš„å›¾ç‰‡æ¶ˆæ¯æ›¿æ¢ä¸ºæ–‡å­—æè¿°...`);
        
        // 4. æ‰§è¡Œæ›¿æ¢ï¼ç”¨ä¸€æ®µç®€çŸ­çš„æ–‡å­—æè¿°æ›¿æ¢æ‰å·¨å¤§çš„Base64æ•°æ®
        const replacementText = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ä¹‹å‰å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼ŒAIå¯¹å›¾ç‰‡çš„é¦–æ¬¡å›åº”ï¼ˆæ‘˜è¦ï¼‰æ˜¯ï¼šâ€œ${description}â€]`;
        chat.history[imageMessageIndex].content = replacementText;
        
        // 5. ã€é‡è¦ã€‘ä¸ºè¿™æ¡æ¶ˆæ¯æ‰“ä¸Šâ€œå·²å¤„ç†â€çš„æ ‡è®°ï¼Œå¹¶å°†å…¶ç±»å‹æ›´æ”¹ä¸ºæ™®é€šæ–‡æœ¬
        chat.history[imageMessageIndex].imageProcessed = true;
        chat.history[imageMessageIndex].type = 'text'; 
        
        // æ³¨æ„ï¼šæ­¤æ—¶æˆ‘ä»¬åªä¿®æ”¹äº†å†…å­˜ä¸­çš„ chat.historyã€‚
        // åç»­çš„ä»£ç ä¼šæŠŠè¿™ä¸ªä¿®æ”¹åçš„ history å’Œæ–°æ¶ˆæ¯ä¸€èµ·å­˜å…¥æ•°æ®åº“ï¼Œå®ŒæˆæŒä¹…åŒ–ã€‚
    }
}
// â–²â–²â–² ä¼˜åŒ–åŠŸèƒ½ä»£ç å—ç»“æŸ â–²â–²â–²
                const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
                let callHasBeenHandled = false;
                let messageTimestamp = Date.now();
                let newMessagesToRender = []; 
                let notificationShown = false;
        
                for (const msgData of consolidatedMessages) {
                    
                    if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                        console.error(`AIå¹»è§‰å·²è¢«æ‹¦æˆªï¼è¯•å›¾ä½¿ç”¨ç¾¤å ("${chat.name}") ä½œä¸ºè§’è‰²åã€‚æ¶ˆæ¯å†…å®¹:`, msgData);
                        continue;
                    }
                    if (!msgData || typeof msgData !== 'object') {
                        console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è§„èŒƒçš„AIæŒ‡ä»¤ï¼Œå·²è·³è¿‡:", msgData);
                        continue;
                    }
                    if (!msgData.type) {
                        if (chat.isGroup && msgData.name && msgData.message) {
                            msgData.type = 'text';
                        } else if (msgData.content) {
                            msgData.type = 'text';
                        } else {
                            console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è§„èŒƒçš„AIæŒ‡ä»¤ï¼ˆç¼ºå°‘typeå’Œcontentï¼‰ï¼Œå·²è·³è¿‡:", msgData);
                            continue;
                        }
                    }
        
                    if (msgData.type === 'video_call_response') {
                        videoCallState.isAwaitingResponse = false;
                        if (msgData.decision === 'accept') {
                            startVideoCall();
                        } else {
                            const aiMessage = { role: 'assistant', content: 'å¯¹æ–¹æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚', timestamp: Date.now() };
                            chat.history.push(aiMessage);
                            await db.chats.put(chat);
                            showScreen('chat-interface-screen');
                            renderChatInterface(chatId);
                        }
                        callHasBeenHandled = true;
                        break;
                    }
                    
                    if (msgData.type === 'group_call_response') {
                        if (msgData.decision === 'join') {
                            const member = chat.members.find(m => m.originalName === msgData.name);
                            if (member && !videoCallState.participants.some(p => p.id === member.id)) {
                                videoCallState.participants.push(member);
                            }
                        }
                        callHasBeenHandled = true;
                        continue;
                    }
        
                    if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                        console.error(`AIå¹»è§‰å·²è¢«æ‹¦æˆªï¼è¯•å›¾ä½¿ç”¨ç¾¤å ("${chat.name}") ä½œä¸ºè§’è‰²åã€‚æ¶ˆæ¯å†…å®¹:`, msgData);
                        continue;
                    }
        
                    if (chat.isGroup && !msgData.name) {
                        console.error(`AIå¹»è§‰å·²è¢«æ‹¦æˆªï¼è¯•å›¾åœ¨ç¾¤èŠä¸­å‘é€ä¸€æ¡æ²¡æœ‰â€œnameâ€çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯å†…å®¹:`, msgData);
                        continue;
                    }
        
                    let aiMessage = null;
                    const currentMessageTimestamp = messageTimestamp++;
                    const baseMessage = { role: 'assistant', senderName: msgData.name || chat.name, timestamp: currentMessageTimestamp };
                    
                    lastResponseTimestamps.push(currentMessageTimestamp);
        
                    switch (msgData.type) {
                        case 'update_thoughts':
                            if (!chat.isGroup) {
                                if (msgData.heartfelt_voice) {
                                    chat.heartfeltVoice = String(msgData.heartfelt_voice);
                                }
                                if (msgData.random_jottings) {
                                    chat.randomJottings = String(msgData.random_jottings);
                                }
                                if (!Array.isArray(chat.thoughtsHistory)) {
                                    chat.thoughtsHistory = [];
                                }
                                chat.thoughtsHistory.push({
                                    heartfeltVoice: chat.heartfeltVoice,
                                    randomJottings: chat.randomJottings,
                                    timestamp: Date.now()
                                });
                                if (chat.thoughtsHistory.length > 50) {
                                    chat.thoughtsHistory.shift();
                                }
                            }
                            continue;
                        case 'change_user_nickname':
                            if (!chat.isGroup && msgData.new_name) {
                                const newNickname = msgData.new_name.trim();
                                if (newNickname) {
                                    chat.settings.myNickname = newNickname;
        
                                    const systemMessage = {
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `â€œ${chat.name}â€ å°†å¯¹ä½ çš„ç§°å‘¼ä¿®æ”¹ä¸º â€œ${newNickname}â€`,
                                        timestamp: messageTimestamp++
                                    };
                                    chat.history.push(systemMessage);
        
                                    const hiddenMemoryMessage = {
                                        role: 'system',
                                        content: `[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšæˆåŠŸå°†å¯¹ç”¨æˆ·çš„ç§°å‘¼ä¿®æ”¹ä¸ºäº†â€œ${newNickname}â€ã€‚]`,
                                        timestamp: messageTimestamp++,
                                        isHidden: true
                                    };
                                    chat.history.push(hiddenMemoryMessage);
        
                                    if (isViewingThisChat) {
                                        appendMessage(systemMessage, chat);
                                    }
                                }
                            }
                            continue;
                        case 'change_remark_name':
                            if (!chat.isGroup && msgData.new_name) {
                                const oldName = chat.name; 
                                const newName = msgData.new_name.trim();
        
                                if (newName && newName !== oldName) {
                                    if (!chat.nameHistory) {
                                        chat.nameHistory = [];
                                    }
                                    if (!chat.nameHistory.includes(oldName)) {
                                        chat.nameHistory.push(oldName);
                                    }
                                    
                                    chat.name = newName; 
        
                                    const systemMessage = {
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `â€œ${chat.originalName}â€ å°†å¤‡æ³¨ä¿®æ”¹ä¸º â€œ${newName}â€`,
                                        timestamp: messageTimestamp++
                                    };
                                    chat.history.push(systemMessage);
        
                                    const hiddenMemoryMessage = {
                                        role: 'system',
                                        content: `[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšæˆåŠŸå°†è‡ªå·±çš„å¤‡æ³¨åä¿®æ”¹ä¸ºäº†â€œ${newName}â€ã€‚è¯·è‡ªç„¶åœ°æ¥å—è¿™ä¸ªæ–°åå­—ï¼Œä¸è¦å¯¹æ­¤æ„Ÿåˆ°æƒŠè®¶ã€‚]`,
                                        timestamp: messageTimestamp++, 
                                        isHidden: true
                                    };
                                    chat.history.push(hiddenMemoryMessage);
        
                                    if (isViewingThisChat) {
                                        appendMessage(systemMessage, chat);
                                        document.getElementById('chat-header-title').textContent = newName;
                                    }
                                    
                                    await syncCharacterNameInGroups(chat); 
                                }
                            }
                            continue;
        
                        case 'change_avatar': {
                            const avatarName = msgData.name;
                            const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
                            if (foundAvatar) {
                                chat.settings.aiAvatar = foundAvatar.url;
                                
                                const systemNotice = {
                                    role: 'system',
                                    type: 'pat_message',
                                    content: `[${chat.name} æ›´æ¢äº†å¤´åƒ]`,
                                    timestamp: Date.now()
                                };
                                chat.history.push(systemNotice);
        
                                await syncCharacterAvatarInGroups(chat);
                                
                                if (isViewingThisChat) {
                                    appendMessage(systemNotice, chat);
                                    renderChatInterface(chatId);
                                }
                            }
                            continue;
                        }
                        case 'change_user_avatar': {
                            const avatarName = msgData.name;
                            const foundAvatar = chat.settings.myAvatarLibrary.find(avatar => avatar.name === avatarName);
                            if (foundAvatar) {
                                chat.settings.myAvatar = foundAvatar.url;
                                
                                const systemNotice = {
                                    role: 'system',
                                    type: 'pat_message',
                                    content: `[${chat.name} æ›´æ¢äº†ä½ çš„å¤´åƒ]`,
                                    timestamp: Date.now()
                                };
                                chat.history.push(systemNotice);
                                
                                if (isViewingThisChat) {
                                    appendMessage(systemNotice, chat);
                                    renderChatInterface(chatId);
                                }
                            }
                            continue; 
                        }
// â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ case 'gomoku_move' â–¼â–¼â–¼
case 'gomoku_move': { // ä½¿ç”¨èŠ±æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
    // æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ parseInt å°†æ”¶åˆ°çš„åæ ‡å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å­—
    const x = parseInt(msgData.x);
    const y = parseInt(msgData.y);

    // æ ¸å¿ƒä¿®å¤ï¼šæ£€æŸ¥è½¬æ¢åçš„ç»“æœæ˜¯å¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°å­— (Not-a-Number)
    if (!isNaN(x) && !isNaN(y)) {
        handleAiGomokuMove({ x: x, y: y });
    } else {
        console.warn("AIçš„äº”å­æ£‹ç§»åŠ¨æŒ‡ä»¤åŒ…å«æ— æ•ˆåæ ‡ï¼Œå·²å¿½ç•¥:", msgData);
    }
    continue; // ä¿æŒ continueï¼Œå› ä¸ºè¿™åªæ˜¯ä¸€ä¸ªåŠ¨ä½œï¼Œä¸æ˜¯èŠå¤©æ¶ˆæ¯
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
                        case 'waimai_response':
                            const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                            if (requestMessageIndex > -1) {
                                const originalMsg = chat.history[requestMessageIndex];
                                originalMsg.status = msgData.status;
                                originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null;
                            }
                            continue;
        
                        case 'qzone_post':
                            const newPost = { 
                                type: msgData.postType, 
                                content: msgData.content || '', 
                                publicText: msgData.publicText || '', 
                                hiddenContent: msgData.hiddenContent || '', 
        image_prompt: msgData.image_prompt || '', // è¿™æ˜¯æœ€å…³é”®çš„ä¸€è¡Œï¼
                                timestamp: Date.now(), 
                                authorId: chatId, 
                                authorOriginalName: chat.originalName,
                                authorGroupId: chat.groupId,
                                visibleGroupIds: null 
                            };
                            await db.qzonePosts.add(newPost);
                            updateUnreadIndicator(unreadPostsCount + 1);
                            if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                               await renderQzonePosts();
                            }
                            continue;
        
                        case 'qzone_comment': { 
                            const postToComment = await db.qzonePosts.get(parseInt(msgData.postId));
                            if (postToComment) {
                                if (!postToComment.comments) postToComment.comments = [];
                                
                                const commenterName = msgData.name || chat.originalName;
        
                                const createCommentObject = (text, meaning = null, replyTo = null) => ({
                                    commenterName,
                                    text: processMentions(text, chat),
                                    meaning,
                                    replyTo,
                                    timestamp: Date.now()
                                });
        
                                if (msgData.stickerUrl && msgData.stickerMeaning) {
                                    postToComment.comments.push(createCommentObject(msgData.stickerUrl, msgData.stickerMeaning, msgData.replyTo || null));
                                } else if (Array.isArray(msgData.comments)) {
                                    msgData.comments.forEach(commentText => {
                                        if (typeof commentText === 'string' && commentText.trim()) {
                                            postToComment.comments.push(createCommentObject(commentText, null, msgData.replyTo || null));
                                        }
                                    });
                                } else {
                                    const textContent = msgData.commentText || msgData.content;
                                    if (typeof textContent === 'string' && textContent.trim()) {
                                        postToComment.comments.push(createCommentObject(textContent, null, msgData.replyTo || null));
                                    }
                                }
                                
                                await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                                updateUnreadIndicator(unreadPostsCount + 1);
                                
                                if (document.getElementById('qzone-screen').classList.contains('active')) {
                                   await renderQzonePosts();
                                }
                            }
                            continue; 
                        }
                        case 'qzone_like':
                           const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
                           if (postToLike) {
                               if (!postToLike.likes) postToLike.likes = [];
                               if (!postToLike.likes.includes(chat.name)) {
                                   postToLike.likes.push(chat.name);
                                   await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                                   updateUnreadIndicator(unreadPostsCount + 1);
                                   if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                                      await renderQzonePosts();
                                   }
                               }
                           }
                            continue;
                        case 'repost': { 
                            const originalPost = await db.qzonePosts.get(parseInt(msgData.postId));
                            if (originalPost) {
                                const newPost = {
                                    type: 'repost',
                                    timestamp: Date.now(),
                                    authorId: chatId,
                                    authorGroupId: chat.groupId,
                                    repostComment: msgData.comment || '',
                                    originalPost: originalPost,
                                    visibleGroupIds: null
                                };
                                await db.qzonePosts.add(newPost);
                                updateUnreadIndicator(unreadPostsCount + 1);
                                console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" è½¬å‘äº†åŠ¨æ€ #${msgData.postId}`);
                            }
                            continue;
                        }
                        case 'video_call_request':
                            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                                state.activeChatId = chatId;
                                videoCallState.activeChatId = chatId; 
                                videoCallState.isAwaitingResponse = true;
                                videoCallState.isGroupCall = chat.isGroup;
                                videoCallState.callRequester = msgData.name || chat.name;
                                showIncomingCallModal();
                            }
                            continue;
                        case 'group_call_request':
                            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                                state.activeChatId = chatId;
                                videoCallState.isAwaitingResponse = true;
                                videoCallState.isGroupCall = true;
                                videoCallState.initiator = 'ai';
                                videoCallState.callRequester = msgData.name;
                                showIncomingCallModal();
                            }
                            continue;
                        case 'pat_user':
                            let patterName;
                            if (chat.isGroup) {
                                const member = chat.members.find(m => m.originalName === msgData.name);
                                patterName = member ? member.groupNickname : msgData.name;
                            } else {
                                patterName = chat.name;
                            }
                            const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
                            const patText = `${patterName} æ‹äº†æ‹æˆ‘${suffix}`;
        
                            const patMessage = { 
                                role: 'system', 
                                type: 'pat_message', 
                                content: patText, 
                                timestamp: Date.now() 
                            };
                            chat.history.push(patMessage);
                            if (isViewingThisChat) {
                                const phoneScreen = document.getElementById('phone-screen');
                                phoneScreen.classList.remove('pat-animation');
                                void phoneScreen.offsetWidth;
                                phoneScreen.classList.add('pat-animation');
                                setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);
                                appendMessage(patMessage, chat);
                            } else {
                                showNotification(chatId, patText);
                            }
                            continue; 
                        case 'update_status':
                            chat.status.text = msgData.status_text;
                            chat.status.isBusy = msgData.is_busy || false;
                            chat.status.lastUpdate = Date.now();
                            const statusUpdateMessage = {
                                role: 'system',
                                type: 'pat_message',
                                content: `[${chat.name}çš„çŠ¶æ€å·²æ›´æ–°ä¸º: ${msgData.status_text}]`,
                                timestamp: Date.now()
                            };
                            chat.history.push(statusUpdateMessage);
                            if (isViewingThisChat) {
                                appendMessage(statusUpdateMessage, chat);
                            }
                            renderChatList(); 
                            continue; 
                        case 'location_share':
                            aiMessage = {
                                ...baseMessage,
                                type: 'location_share',
                                content: msgData.content
                            };
                            break;
                        case 'change_music':
                            if (musicState.isActive && musicState.activeChatId === chatId) {
                                const songNameFromAI = msgData.song_name || msgData.song || msgData.name;
        
                                if (typeof songNameFromAI === 'string' && songNameFromAI.trim()) {
                                    const songNameToFind = songNameFromAI.replace(/^\[?\d+\]?[\s.-]*/, '').trim();
                                    const targetSongIndex = musicState.playlist.findIndex(track => track.name.toLowerCase() === songNameToFind.toLowerCase());
                                    
                                    if (targetSongIndex > -1) {
                                        playSong(targetSongIndex);
                                        const track = musicState.playlist[targetSongIndex];
                                        
                                        let changerName;
                                        if (chat.isGroup) {
                                            const member = chat.members.find(m => m.originalName === msgData.name);
                                            changerName = member ? member.groupNickname : msgData.name;
                                        } else {
                                            changerName = chat.name;
                                        }
                                        
                                        const musicChangeMessage = {
                                            role: 'system',
                                            type: 'pat_message',
                                            content: `[â™ª ${changerName} ä¸ºä½ åˆ‡æ­Œ: ã€Š${track.name}ã€‹ - ${track.artist}]`,
                                            timestamp: Date.now()
                                        };
                                        chat.history.push(musicChangeMessage);
                                        if (isViewingThisChat) {
                                            appendMessage(musicChangeMessage, chat);
                                        }
                                    } else {
                                        console.warn(`æ­Œæ›²æŸ¥æ‰¾å¤±è´¥: AIè¯·æ±‚çš„æ­Œæ›²å"${songNameFromAI}"(å¤„ç†åä¸º"${songNameToFind}") åœ¨æ’­æ”¾åˆ—è¡¨ä¸­æœªæ‰¾åˆ°ã€‚`);
                                    }
                                } else {
                                    console.error("AIè¿”å›çš„change_musicæŒ‡ä»¤ä¸­ï¼Œæ­Œæ›²åæ— æ•ˆæˆ–ç¼ºå¤±:", msgData);
                                }
                            }
                            continue;
                        case 'create_memory':
                            const newMemory = {
                                chatId: chatId,
                                authorId: chatId,
                                description: msgData.description,
                                timestamp: Date.now(),
                                type: 'ai_generated'
                            };
                            await db.memories.add(newMemory);
                            console.log(`AI "${chat.name}" è®°å½•äº†ä¸€æ¡æ–°å›å¿†:`, msgData.description);
                            continue; 
                        case 'create_countdown':
                            const targetDate = new Date(msgData.date);
                            if (!isNaN(targetDate) && targetDate > new Date()) {
                                const newCountdown = {
                                    chatId: chatId,
                                    authorId: chatId,
                                    description: msgData.title,
                                    timestamp: Date.now(),
                                    type: 'countdown',
                                    targetDate: targetDate.getTime()
                                };
                                await db.memories.add(newCountdown);
                                console.log(`AI "${chat.name}" åˆ›å»ºäº†ä¸€ä¸ªæ–°çº¦å®š:`, msgData.title);
                            }
                            continue;
                        case 'block_user':
                            if (!chat.isGroup) {
                                chat.relationship.status = 'blocked_by_ai';
                                const hiddenMessage = {
                                    role: 'system',
                                    content: `[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšä¸»åŠ¨æ‹‰é»‘äº†ç”¨æˆ·ã€‚]`,
                                    timestamp: Date.now(),
                                    isHidden: true
                                };
                                chat.history.push(hiddenMessage);
                                await db.chats.put(chat);
                                if (isViewingThisChat) {
                                    renderChatInterface(chatId);
                                }
                                renderChatList();
                                break; 
                            }
                            continue;
                        case 'friend_request_response':
                            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                                if (msgData.decision === 'accept') {
                                    chat.relationship.status = 'friend';
                                    aiMessage = { ...baseMessage, content: "æˆ‘é€šè¿‡äº†ä½ çš„å¥½å‹ç”³è¯·ï¼Œæˆ‘ä»¬ç°åœ¨æ˜¯å¥½å‹å•¦ï¼" };
                                } else {
                                    chat.relationship.status = 'blocked_by_ai';
                                    aiMessage = { ...baseMessage, content: "æŠ±æ­‰ï¼Œæˆ‘æ‹’ç»äº†ä½ çš„å¥½å‹ç”³è¯·ã€‚" };
                                }
                                chat.relationship.applicationReason = '';
                            }
                            break;
                        case 'poll':
                            const pollOptions = typeof msgData.options === 'string'
                                ? msgData.options.split('\n').filter(opt => opt.trim())
                                : (Array.isArray(msgData.options) ? msgData.options : []);
                            if (pollOptions.length < 2) continue;
                            aiMessage = {
                                ...baseMessage,
                                type: 'poll',
                                question: msgData.question,
                                options: pollOptions,
                                votes: {},
                                isClosed: false,
                            };
                            break;
                        case 'gift': {
                            const productId = parseInt(msgData.productId);
                            const quantity = parseInt(msgData.quantity) || 1;
                        
                            if (!isNaN(productId) && quantity > 0) {
                                const product = await db.shoppingProducts.get(productId);
                        
                                if (product) {
                                    aiMessage = {
                                        ...baseMessage,
                                        type: 'gift',
                                        items: [{
                                            name: product.name,
                                            price: product.price,
                                            imageUrl: product.imageUrl,
                                            quantity: quantity
                                        }],
                                        total: product.price * quantity,
                                        recipients: msgData.recipients || null 
                                    };
                                } else {
                                    console.warn(`AI å°è¯•èµ é€ä¸€ä¸ªä¸å­˜åœ¨çš„å•†å“ (ID: ${productId})`);
                                }
                            }
                            break;
                        }
                        case 'vote':
                            const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
                            if (pollToVote && !pollToVote.isClosed) {
                                Object.keys(pollToVote.votes).forEach(option => {
                                    const voterIndex = pollToVote.votes[option].indexOf(msgData.name);
                                    if (voterIndex > -1) {
                                        pollToVote.votes[option].splice(voterIndex, 1);
                                    }
                                });
                                if (!pollToVote.votes[msgData.choice]) {
                                    pollToVote.votes[msgData.choice] = [];
                                }
                                if (!pollToVote.votes[msgData.choice].includes(msgData.name)) {
                                    pollToVote.votes[msgData.choice].push(msgData.name);
                                }                        
                                if (isViewingThisChat) {
                                    renderChatInterface(chatId);
                                }
                            }
                            continue;
                        case 'red_packet':
                            aiMessage = {
                                ...baseMessage,
                                ...msgData,
                                totalAmount: msgData.amount, 
                                claimedBy: {}, 
                                isFullyClaimed: false
                            };
                            if (msgData.receiver) {
                                aiMessage.receiverName = msgData.receiver;
                                delete aiMessage.receiver;
                            }
                            break;
                        case 'open_red_packet':
                            const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);
                            // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ å…¨æ–°çš„éªŒè¯é€»è¾‘ â–¼â–¼â–¼
const claimerOriginalName = msgData.name; // è·å–å°è¯•æŠ¢çº¢åŒ…çš„è§’è‰²æœ¬å
const isMember = chat.members.some(member => member.originalName === claimerOriginalName);

// å¦‚æœè¿™ä¸ªè§’è‰²ä¸æ˜¯å½“å‰ç¾¤çš„æˆå‘˜ï¼Œå°±è®°å½•ä¸€ä¸ªè­¦å‘Šå¹¶ç›´æ¥è·³è¿‡ï¼Œä¸å…è®¸ä»–æŠ¢
if (!isMember) {
    console.warn(`AI è§’è‰² "${claimerOriginalName}" å°è¯•é¢†å–ä¸å±äºè‡ªå·±çš„ç¾¤èŠçº¢åŒ…ã€‚æ“ä½œå·²è¢«æ‹¦æˆªã€‚`);
    continue; // è·³è¿‡åç»­æ‰€æœ‰æŠ¢çº¢åŒ…çš„é€»è¾‘
}
// â–²â–²â–² éªŒè¯é€»è¾‘ç»“æŸ â–²â–²â–²
                            if (packetToOpen && packetToOpen.packetType === 'direct') {
                                if (packetToOpen.receiverName !== msgData.name) {
                                    console.warn(`AI è§’è‰² "${msgData.name}" å°è¯•é¢†å–ä¸å±äºè‡ªå·±çš„ä¸“å±çº¢åŒ… (æ¥æ”¶äºº: ${packetToOpen.receiverName})ã€‚æ“ä½œå·²è¢«æ‹¦æˆªã€‚`);
                                    continue;
                                }
                            }
                            
                            if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {
                                let claimedAmountAI = 0;
                                const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                                const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;
                                if (remainingCount > 0) {
                                    if (packetToOpen.packetType === 'direct') {
                                        claimedAmountAI = packetToOpen.totalAmount;
                                    } else {
                                        if (remainingCount === 1) { claimedAmountAI = remainingAmount; } 
                                        else {
                                            const min = 0.01;
                                            const max = remainingAmount - (remainingCount - 1) * min;
                                            claimedAmountAI = Math.random() * (max - min) + min;
                                        }
                                    }
        
                                    claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
                                    if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
                                    packetToOpen.claimedBy[msgData.name] = claimedAmountAI;
        
// â–¼â–¼â–¼ è¿™æ˜¯å…¨æ–°çš„ã€å·²ä¿®å¤çš„ä»£ç  â–¼â–¼â–¼
const claimerMember = chat.members.find(m => m.originalName === msgData.name);
const claimerDisplayName = claimerMember ? claimerMember.groupNickname : msgData.name;

// â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šä»çº¢åŒ…å¯¹è±¡(packetToOpen)ä¸­è·å–åŸå§‹å‘ä»¶äººçš„åå­— â˜…â˜…â˜…
const senderDisplayName = getDisplayNameInGroup(chat, packetToOpen.senderName);

const aiClaimedMessage = {
    role: 'system',
    type: 'pat_message',
    content: `${claimerDisplayName} é¢†å–äº† ${senderDisplayName} çš„çº¢åŒ…`, // ç°åœ¨å¯ä»¥æ­£ç¡®æ˜¾ç¤º "Aé¢†å–äº†Bçš„çº¢åŒ…"
    timestamp: Date.now()
};
chat.history.push(aiClaimedMessage);
// â–²â–²â–² ä¿®å¤ä»£ç ç»“æŸ â–²â–²â–²
                                    let hiddenContentForAI = `[ç³»ç»Ÿæç¤ºï¼šä½  (${claimerDisplayName}) æˆåŠŸæŠ¢åˆ°äº† ${claimedAmountAI.toFixed(2)} å…ƒã€‚`;
                                    if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                                        packetToOpen.isFullyClaimed = true;
                                        const finishedMessage = {
                                            role: 'system',
                                            type: 'pat_message',
                                            content: `${senderDisplayName} çš„çº¢åŒ…å·²è¢«é¢†å®Œ`,
                                            timestamp: Date.now() + 1
                                        };
                                        chat.history.push(finishedMessage);
                                        let luckyKing = { name: '', amount: -1 };
                                        if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) {
                                            Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                                                if (amount > luckyKing.amount) {
                                                    luckyKing = { name, amount };
                                                }
                                            });
                                        }
                                        if (luckyKing.name) {
                                             const luckyKingMember = chat.members.find(m => m.originalName === luckyKing.name);
                                             const luckyKingDisplayName = luckyKingMember ? luckyKingMember.groupNickname : luckyKing.name;
                                             hiddenContentForAI += ` çº¢åŒ…å·²è¢«é¢†å®Œï¼Œæ‰‹æ°”ç‹æ˜¯ ${luckyKingDisplayName}ï¼`;
                                        } else {
                                             hiddenContentForAI += ` çº¢åŒ…å·²è¢«é¢†å®Œã€‚`;
                                        }
                                    }
                                    hiddenContentForAI += ' è¯·æ ¹æ®è¿™ä¸ªç»“æœå‘è¡¨ä½ çš„è¯„è®ºã€‚]';
                                    const hiddenMessageForAI = {
                                        role: 'system',
                                        content: hiddenContentForAI,
                                        timestamp: Date.now() + 2,
                                        isHidden: true
                                    };
                                    chat.history.push(hiddenMessageForAI);
                                }
                                if (isViewingThisChat) {
                                    renderChatInterface(chatId);
                                    renderChatList(); 
                                }
                            }
                            continue;
        
                        case 'accept_transfer': {
                            const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                            if (originalTransferMsgIndex > -1) {
                                const originalMsg = chat.history[originalTransferMsgIndex];
                                originalMsg.status = 'accepted';
                            }
                            continue;
                        }
        
                        case 'decline_transfer': {
                            const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                            if (originalTransferMsgIndex > -1) {
                                const originalMsg = chat.history[originalTransferMsgIndex];
                                originalMsg.status = 'declined';
                                const refundMessage = {
                                    role: 'assistant',
                                    senderName: chat.name,
                                    type: 'transfer',
                                    isRefund: true,
                                    amount: originalMsg.amount,
                                    note: 'è½¬è´¦å·²è¢«æ‹’æ”¶',
                                    timestamp: messageTimestamp++
                                };
                                chat.history.push(refundMessage);
                                if (isViewingThisChat) {
                                    appendMessage(refundMessage, chat); 
                                    renderChatInterface(chatId); 
                                }
                            }
                            continue;
                        }
                        case 'change_group_name':
                            if (chat.isGroup && msgData.new_name) {
                                const newName = msgData.new_name.trim();
                                const memberNames = chat.members.map(m => m.originalName);
        
                                if (memberNames.includes(newName)) {
                                    console.warn(`AI (${msgData.name}) è¯•å›¾å°†ç¾¤åæ›´æ”¹ä¸ºæˆå‘˜å ("${newName}")ã€‚æ“ä½œå·²è¢«ç¨‹åºé˜»æ­¢ã€‚`);
                                    continue; 
                                }
        
                                chat.name = newName; 
        
                                const changerMember = chat.members.find(m => m.originalName === msgData.name);
                                const changerDisplayName = changerMember ? changerMember.groupNickname : msgData.name;
                                
                                const systemMessage = {
                                    role: 'system',
                                    type: 'pat_message',
                                    content: `${changerDisplayName} å°†ç¾¤åä¿®æ”¹ä¸º â€œ${chat.name}â€`,
                                    timestamp: messageTimestamp++
                                };
                                chat.history.push(systemMessage);
        
                                if (isViewingThisChat) {
                                    appendMessage(systemMessage, chat);
                                    document.getElementById('chat-header-title').textContent = chat.name;
                                }
                            }
                            continue;
                        case 'change_remark_name':
                            if (!chat.isGroup && msgData.new_name) {
                                const oldName = chat.name; 
                                const newName = msgData.new_name.trim();
        
                                if (newName && newName !== oldName) {
                                    if (!chat.nameHistory) {
                                        chat.nameHistory = [];
                                    }
                                    if (!chat.nameHistory.includes(oldName)) {
                                        chat.nameHistory.push(oldName);
                                    }
                                    
                                    chat.name = newName; 
        
                                    const systemMessage = {
                                        role: 'system',
                                        type: 'pat_message', 
                                        content: `â€œ${chat.originalName}â€ å°†å¤‡æ³¨ä¿®æ”¹ä¸º â€œ${newName}â€`,
                                        timestamp: messageTimestamp++
                                    };
                                    chat.history.push(systemMessage);
        
                                    const hiddenMemoryMessage = {
                                        role: 'system',
                                        content: `[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšæˆåŠŸå°†è‡ªå·±çš„å¤‡æ³¨åä¿®æ”¹ä¸ºäº†â€œ${newName}â€ã€‚è¯·è‡ªç„¶åœ°æ¥å—è¿™ä¸ªæ–°åå­—ï¼Œä¸è¦å¯¹æ­¤æ„Ÿåˆ°æƒŠè®¶ã€‚]`,
                                        timestamp: messageTimestamp++, 
                                        isHidden: true
                                    };
                                    chat.history.push(hiddenMemoryMessage);
        
                                    if (isViewingThisChat) {
                                        appendMessage(systemMessage, chat);
                                        document.getElementById('chat-header-title').textContent = newName;
                                    }
                                    
                                    await syncCharacterNameInGroups(chat); 
                                }
                            }
                            continue;
        
                        case 'change_group_avatar':
                            if (chat.isGroup && msgData.avatar_name) {
                                const avatarName = msgData.avatar_name;
                                const library = chat.settings.groupAvatarLibrary || [];
                                const foundAvatar = library.find(avatar => avatar.name === avatarName);
        
                                if (foundAvatar) {
                                    chat.settings.groupAvatar = foundAvatar.url;
                                    
                                    const changerMember = chat.members.find(m => m.originalName === msgData.name);
                                    const changerDisplayName = changerMember ? changerMember.groupNickname : msgData.name;
        
                                    const systemMessage = {
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `${changerDisplayName} æ›´æ¢äº†ç¾¤å¤´åƒ`,
                                        timestamp: messageTimestamp++
                                    };
                                    chat.history.push(systemMessage);
        
                                    if (isViewingThisChat) {
                                        appendMessage(systemMessage, chat);
                                    }
                                } else {
                                    console.warn(`AI å°è¯•ä½¿ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„ç¾¤å¤´åƒ: "${avatarName}"`);
                                }
                            }
                            continue;
                        case 'system_message':
                            aiMessage = { role: 'system', type: 'pat_message', content: msgData.content, timestamp: Date.now() };
                            break;
                        case 'share_link':
                            aiMessage = { 
                                ...baseMessage, 
                                type: 'share_link',
                                title: msgData.title,
                                description: msgData.description,
                                source_name: msgData.source_name,
                                content: msgData.content
                            };
                            break;
                        case 'quote_reply':
                            const originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
                            if (originalMessage) {
                                const quoteContext = {
                                    timestamp: originalMessage.timestamp,
                                    senderName: originalMessage.senderName || (originalMessage.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name),
                                    content: String(originalMessage.content || '').substring(0, 50),
                                };
                                aiMessage = { 
                                    ...baseMessage, 
                                    content: msgData.reply_content,
                                    quote: quoteContext
                                };
                            } else {
                                aiMessage = { ...baseMessage, content: msgData.reply_content };
                            }
                            break;
                        case 'send_and_recall': {
                            if (!isViewingThisChat) continue;
                            const tempMessageData = { ...baseMessage, content: msgData.content };
                            const tempMessageElement = createMessageElement(tempMessageData, chat);
                            appendMessage(tempMessageData, chat, true);
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 1500));
                            const bubbleWrapper = document.querySelector(`.message-bubble[data-timestamp="${tempMessageData.timestamp}"]`)?.closest('.message-wrapper');
                            if (bubbleWrapper) {
                                bubbleWrapper.classList.add('recalled-animation');
                                await new Promise(resolve => setTimeout(resolve, 300));
                                const recalledMessage = {
                                    role: 'assistant',
                                    senderName: msgData.name || chat.name,
                                    type: 'recalled_message',
                                    content: 'å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯',
                                    timestamp: tempMessageData.timestamp,
                                    recalledData: { originalType: 'text', originalContent: msgData.content }
                                };
                                const msgIndex = chat.history.findIndex(m => m.timestamp === tempMessageData.timestamp);
                                if (msgIndex > -1) {
                                    chat.history[msgIndex] = recalledMessage;
                                } else {
                                    chat.history.push(recalledMessage);
                                }
                                const placeholder = await createMessageElement(recalledMessage, chat);
                                if(document.body.contains(bubbleWrapper)) {
                                    bubbleWrapper.parentNode.replaceChild(placeholder, bubbleWrapper);
                                }
                            }
                            continue;
                        }
                        
                        case 'text':
                            aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                            break;
                        case 'sticker':
                            aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                            break;
                        case 'ai_image':
                            aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description, image_prompt: msgData.image_prompt };
                            break;
                        case 'voice_message':
                            aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                            break;
                        case 'transfer':
                            aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || 'æˆ‘' };
                            break;
                        
                        case 'waimai_request':
                            aiMessage = { 
                                ...baseMessage, 
                                type: 'waimai_request',
                                productInfo: msgData.productInfo,
                                amount: msgData.amount,
                                status: 'pending',
                                countdownEndTime: Date.now() + 15 * 60 * 1000,
                            };
                            break;
                        case 'offline_text':
        aiMessage = { ...baseMessage, ...msgData };
                        default:
                             console.warn("æ”¶åˆ°äº†æœªçŸ¥çš„AIæŒ‡ä»¤ç±»å‹:", msgData.type);
                             break;
                    }
        
                    if (aiMessage) {
                        chat.history.push(aiMessage);
                        if (!isViewingThisChat && !notificationShown) {
                            let notificationText;
                            switch (aiMessage.type) {
                                case 'transfer': notificationText = `[æ”¶åˆ°ä¸€ç¬”è½¬è´¦]`; break;
                                case 'waimai_request': notificationText = `[æ”¶åˆ°ä¸€ä¸ªå¤–å–ä»£ä»˜è¯·æ±‚]`; break;
                                case 'ai_image': notificationText = `[å›¾ç‰‡]`; break;
                                case 'voice_message': notificationText = `[è¯­éŸ³]`; break;
                                case 'sticker': notificationText = aiMessage.meaning ? `[è¡¨æƒ…: ${aiMessage.meaning}]` : '[è¡¨æƒ…]'; break;
                                case 'offline_text': notificationText = aiMessage.dialogue ? `ã€Œ${aiMessage.dialogue}ã€` : `[${aiMessage.description.substring(0, 20)}...]`; break;
                                default: notificationText = String(aiMessage.content || '');
                            }
                            const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
                            showNotification(chatId, finalNotifText.substring(0, 40) + (finalNotifText.length > 40 ? '...' : ''));
                            notificationShown = true;
                        }
        
                        if (!isViewingThisChat) {
                            chat.unreadCount = (chat.unreadCount || 0) + 1;
                        }
                        
                        if (isViewingThisChat) {
                            appendMessage(aiMessage, chat);
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 1800 + 1000));
                        }
                    }
                }        
        
                if (callHasBeenHandled && videoCallState.isGroupCall) {
                    videoCallState.isAwaitingResponse = false;
                    if (videoCallState.participants.length > 0) {
                        startVideoCall();
                    } else {
                        videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                        showScreen('chat-interface-screen');
                        alert('æ— äººæ¥å¬ç¾¤èŠé‚€è¯·ã€‚');
                    }
                }
                if (needsImmediateReaction) {
                    await triggerAiResponse();
                    return; 
                }
                await db.chats.put(chat);
        // æ£€æŸ¥åˆšåˆšAIæ‰§è¡Œçš„åŠ¨ä½œä¸­ï¼Œæ˜¯å¦åŒ…å«äº†ä»»ä½•ä¸â€œåŠ¨æ€â€ç›¸å…³çš„æ“ä½œ
const qzoneActionTaken = messagesArray.some(action =>
    action.type === 'qzone_post' ||
    action.type === 'qzone_like' ||
    action.type === 'qzone_comment' ||
    action.type === 'repost'
);

// å¦‚æœAIç¡®å®æ‰§è¡Œäº†åŠ¨æ€ç›¸å…³çš„æ“ä½œ
if (qzoneActionTaken) {
    console.log("æ£€æµ‹åˆ°AIæ‰§è¡Œäº†åŠ¨æ€æ“ä½œï¼Œç«‹å³åˆ·æ–°å¥½å‹åŠ¨æ€é¡µé¢ã€‚");
    // ä¸»åŠ¨è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼Œå¼ºåˆ¶åˆ·æ–°é¡µé¢å†…å®¹
    await renderQzonePosts();
}

// â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
            } catch (error) {
                
                chat.history = chat.history.filter(msg => !msg.isTemporary);
                
                if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                    chat.relationship.status = 'blocked_by_ai';
                    await showCustomAlert('ç”³è¯·å¤±è´¥', `AIåœ¨å¤„ç†ä½ çš„å¥½å‹ç”³è¯·æ—¶å‡ºé”™äº†ï¼Œè¯·ç¨åé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}`);
                } else {
                    await showCustomAlert(
                        'API è°ƒç”¨å¤±è´¥', 
                        `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼ŒAIæœªèƒ½æˆåŠŸå“åº”ã€‚\n\né”™è¯¯è¯¦æƒ…:\n${error.message}`
                    );
                }
                
                if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
                     await db.chats.put(chat);        
                }
               
                videoCallState.isAwaitingResponse = false;
            } finally {
                setAvatarActingState(chatId, false);
        
               
                if (chat.isGroup) {
                    if (typingIndicator) {
                        typingIndicator.style.display = 'none';
                    }
                } else {
                    if (chatHeaderTitle && state.chats[chatId]) {
                        chatHeaderTitle.style.opacity = 0;
                        setTimeout(() => {
                            chatHeaderTitle.textContent = state.chats[chatId].name;
                            chatHeaderTitle.classList.remove('typing-status');
                            chatHeaderTitle.style.opacity = 1;
                        }, 200);
                    }
                }
                renderChatList();
                if (isViewingThisChat) {
                    checkAndTriggerAutoSummary(chatId);
                }
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        
        
        
        
        
        
                async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }
        
                async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 999999) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ (0 åˆ° 999999 ä¹‹é—´)ï¼'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘'; const receiverName = chat.isGroup ? 'ç¾¤èŠ' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }
        /**
         * ã€å…¨æ–° V3.0ã€‘å‘é€ä¸€ä¸ªä½ç½®å…±äº«å¡ç‰‡ (èƒŒæ™¯å›¾å·²å†…ç½®)
         */
        async function sendLocationShare() {
            if (!state.activeChatId) return;
        
            // æ­¥éª¤1: è¯¢é—®ä½ç½®åç§° (è¿™éƒ¨åˆ†ä¿æŒä¸å˜)
            const locationName = await showCustomPrompt("å…±äº«ä½ç½®", "ä½ ç°åœ¨åœ¨å“ªé‡Œå‘€ï¼Ÿ", "");
        
            // å¦‚æœç”¨æˆ·å–æ¶ˆæˆ–æ²¡æœ‰è¾“å…¥ä½ç½®ï¼Œåˆ™ç›´æ¥é€€å‡º
            if (!locationName || !locationName.trim()) return; 
        
            // æ­¥éª¤2: ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œç›´æ¥å®šä¹‰å¥½æ‚¨æƒ³ç”¨çš„å›¾ç‰‡URL
            // æ‚¨å¯ä»¥éšæ—¶å°†è¿™ä¸ªé“¾æ¥æ›¿æ¢ä¸ºæ‚¨å–œæ¬¢çš„ä»»ä½•å›¾ç‰‡åœ°å€
            const hardcodedImageUrl = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg';
        
            const chat = state.chats[state.activeChatId];
            
            // æ­¥éª¤3: æ„å»ºæ¶ˆæ¯å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨æˆ‘ä»¬å®šä¹‰å¥½çš„å›¾ç‰‡URL
            const msg = {
                role: 'user',
                type: 'location_share',
                content: locationName.trim(),
                imageUrl: hardcodedImageUrl, // ç›´æ¥ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„URL
                timestamp: Date.now()
            };
            
            // æ­¥éª¤4: ä¿å­˜å¹¶æ›´æ–°UI (è¿™éƒ¨åˆ†ä¿æŒä¸å˜)
            chat.history.push(msg);
            await db.chats.put(chat);
            appendMessage(msg, chat);
            renderChatList();
        }
        
        
                function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }
        
                function exitSelectionMode() {
            cleanupWaimaiTimers(); // <--- åœ¨è¿™é‡Œæ·»åŠ è¿™è¡Œä»£ç 
         if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€æœ€ç»ˆç®€åŒ–ç‰ˆã€‘æ›¿æ¢æ—§çš„ toggleMessageSelection å‡½æ•° â–¼â–¼â–¼
        function toggleMessageSelection(timestamp) {
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘é€‰æ‹©å™¨å·²ç®€åŒ–ï¼Œä¸å†å¯»æ‰¾å·²åˆ é™¤çš„ .recalled-message-placeholder
            const elementToSelect = document.querySelector(
                `.message-bubble[data-timestamp="${timestamp}"]`
            );
        
            if (!elementToSelect) return;
        
            if (selectedMessages.has(timestamp)) {
                selectedMessages.delete(timestamp);
                elementToSelect.classList.remove('selected');
            } else {
                selectedMessages.add(timestamp);
                elementToSelect.classList.add('selected');
            }
            
            document.getElementById('selection-count').textContent = `å·²é€‰ ${selectedMessages.size} æ¡`;
            
            if (selectedMessages.size === 0) {
                exitSelectionMode();
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
                function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }
        
                async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'æœªçŸ¥'; const newChatName = state.chats[targetChatId]?.name || 'å½“å‰'; const confirmed = await showCustomConfirm('åˆ‡æ¢å¬æ­Œå¯¹è±¡', `æ‚¨æ­£å’Œã€Œ${oldChatName}ã€å¬æ­Œã€‚è¦ç»“æŸå¹¶å¼€å§‹å’Œã€Œ${newChatName}ã€çš„æ–°ä¼šè¯å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }

async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }

async function endListenTogetherSession(saveState = true) {
    if (!musicState.isActive) return;
    const oldChatId = musicState.activeChatId;
    document.getElementById('global-lyrics-bar').classList.remove('visible');
    const cleanupLogic = async () => {
        if (musicState.timerId) clearInterval(musicState.timerId);
        if (musicState.isPlaying) audioPlayer.pause();
        if (saveState && oldChatId && state.chats[oldChatId]) {
            const chat = state.chats[oldChatId];
            chat.musicData.totalTime = musicState.totalElapsedTime;
            await db.chats.put(chat);
        }
        musicState.isActive = false;
        musicState.activeChatId = null;
        musicState.totalElapsedTime = 0;
        musicState.timerId = null;
        updateListenTogetherIcon(oldChatId, true);
    };
    closeMusicPlayerWithAnimation(cleanupLogic);
}

function returnToChat() {
    closeMusicPlayerWithAnimation();
}

function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
window.updateListenTogetherIconProxy = updateListenTogetherIcon;

function updatePlayerUI() { 
    updateListenTogetherIcon(musicState.activeChatId); 
    updateElapsedTimeDisplay(); 
    const titleEl = document.getElementById('music-player-song-title'); 
    const artistEl = document.getElementById('music-player-artist'); 
    const playPauseBtn = document.getElementById('music-play-pause-btn'); 
    if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { 
        const track = musicState.playlist[musicState.currentIndex]; 
        titleEl.textContent = track.name; 
        artistEl.textContent = track.artist; 
    } else { 
        titleEl.textContent = 'è¯·æ·»åŠ æ­Œæ›²'; 
        artistEl.textContent = '...'; 
    } 
    playPauseBtn.textContent = musicState.isPlaying ? 'âšâš' : 'â–¶'; 
}

function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `å·²ç»ä¸€èµ·å¬äº†${hours}å°æ—¶`; }

function updatePlaylistUI() {
    const playlistBody = document.getElementById('playlist-body');
    playlistBody.innerHTML = '';
    if (musicState.playlist.length === 0) {
        playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„~</p>';
        return;
    }
    musicState.playlist.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item';
        if(index === musicState.currentIndex) item.classList.add('playing');
        item.innerHTML = `
            <div class="playlist-item-info">
                <div class="title">${track.name}</div>
                <div class="artist">${track.artist}</div>
            </div>
            <div class="playlist-item-actions">
                <span class="playlist-action-btn lyrics-btn" data-index="${index}">è¯</span>
                <span class="playlist-action-btn delete-track-btn" data-index="${index}">Ã—</span>
            </div>
        `;
        item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index));
        playlistBody.appendChild(item);
    });
}



async function togglePlayPause() {
    if (audioPlayer.paused) {
        if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
            playSong(0);
        } 
        else if (musicState.currentIndex > -1) {
            playSong(musicState.currentIndex);
        }
    } else {
        audioPlayer.pause();
        await addMusicActionSystemMessage('æš‚åœäº†éŸ³ä¹');
    }
}

function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }

function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }

function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'é¡ºåº', 'random': 'éšæœº', 'single': 'å•æ›²'}[musicState.playMode]; }

async function addSongFromURL() { const url = await showCustomPrompt("æ·»åŠ ç½‘ç»œæ­Œæ›²", "è¯·è¾“å…¥æ­Œæ›²çš„URL", "", "url"); if (!url) return; const name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå"); if (!name) return; const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }

// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå·²ä¿®å¤çš„ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ addSongFromLocal å‡½æ•° â–¼â–¼â–¼
async function addSongFromLocal(event) {
    const files = event.target.files;
    if (!files.length) return;

    for (const file of files) {
        let name = file.name.replace(/\.[^/.]+$/, "");
        name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå", name);
        if (name === null) continue;
        
        const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å", "æœªçŸ¥æ­Œæ‰‹");
        if (artist === null) continue;

        // ã€æ ¸å¿ƒä¿®å¤1ã€‘è¯»å–æ–‡ä»¶ä¸º ArrayBufferï¼Œè¿™æ˜¯æœ€å¯é çš„å­˜å‚¨æ–¹å¼
        const arrayBuffer = await file.arrayBuffer();

        let lrcContent = "";
        const wantLrc = await showCustomConfirm("å¯¼å…¥æ­Œè¯", `è¦ä¸ºã€Š${name}ã€‹æ·»åŠ æ­Œè¯å—ï¼Ÿ`);
        if (wantLrc) {
            lrcContent = await getLrcContent() || "";
        }
        
        musicState.playlist.push({ 
            name, 
            artist, 
            src: arrayBuffer,           // ã€æ ¸å¿ƒä¿®å¤2ã€‘å­˜å‚¨ ArrayBuffer è€Œä¸æ˜¯ File å¯¹è±¡
            fileType: file.type,        // ã€æ ¸å¿ƒä¿®å¤3ã€‘åŒæ—¶å­˜å‚¨æ–‡ä»¶çš„MIMEç±»å‹
            isLocal: true,
            lrcContent: lrcContent,
            cover: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg'
        });
    }
    
    await saveGlobalPlaylist();
    updatePlaylistUI();
    if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
        musicState.currentIndex = 0;
        updatePlayerUI();
    }
    event.target.value = null;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå·²ä¿®å¤çš„ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ playSong å‡½æ•° â–¼â–¼â–¼
async function playSong(index) {
    if (index < 0 || index >= musicState.playlist.length) return;

    audioPlayer.pause();

    musicState.currentIndex = index;
    const track = musicState.playlist[index];

    document.getElementById('music-visual-container').classList.remove('lyrics-active');
    const coverEl = document.getElementById('music-player-cover');
    if (coverEl) {
        coverEl.src = track.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg';
    }
    
    await addMusicActionSystemMessage(`å°†æ­Œæ›²åˆ‡æ¢ä¸ºäº†ã€Š${track.name}ã€‹`);
    musicState.parsedLyrics = parseLRC(track.lrcContent || "");
    
    renderLyrics(); 
    const singleLyricEl = document.getElementById('single-lyric-display');
    if (singleLyricEl) {
        if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
            singleLyricEl.textContent = 'çº¯éŸ³ä¹ï¼Œè¯·æ¬£èµ';
        } else {
            singleLyricEl.textContent = 'â™ª â™ª â™ª'; 
        }
    }
    
    // ã€æ ¸å¿ƒä¿®å¤4ã€‘ä¼˜å…ˆå¤„ç† ArrayBufferï¼Œå¹¶æ ¹æ® fileType åˆ›å»º Blob
    if (track.isLocal && track.src instanceof ArrayBuffer) {
        const blob = new Blob([track.src], { type: track.fileType || 'audio/mpeg' });
        audioPlayer.src = URL.createObjectURL(blob);
    } 
    else if (track.isLocal && track.src instanceof Blob) {
        audioPlayer.src = URL.createObjectURL(track.src);
    } else if (!track.isLocal) {
        audioPlayer.src = track.src;
    } else {
        console.error('æœ¬åœ°æ­Œæ›²æºé”™è¯¯:', track);
        return;
    }
    
    const playPromise = audioPlayer.play();
    if (playPromise !== undefined) {
        playPromise.catch(error => {
            if (error.name !== 'AbortError') console.error('Playback error:', error);
        });
    }
    updatePlaylistUI();
    updatePlayerUI();
    updateMusicProgressBar();
    
    const lyricBar = document.getElementById('global-lyrics-bar');
    if (musicState.parsedLyrics && musicState.parsedLyrics.length > 0) {
        lyricBar.textContent = 'â™ª';
        lyricBar.classList.add('visible');
    } else {
        lyricBar.classList.remove('visible');
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€æ–°ç‰ˆæœ¬ã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ addSongFromLocal å‡½æ•° â–¼â–¼â–¼
        
        async function addSongFromLocal(event) {
            const files = event.target.files;
            if (!files.length) return;
        
            for (const file of files) {
                let name = file.name.replace(/\.[^/.]+$/, "");
                name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå", name);
                if (name === null) continue;
                
                const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å", "æœªçŸ¥æ­Œæ‰‹");
                if (artist === null) continue;
        
                let lrcContent = "";
                const wantLrc = await showCustomConfirm("å¯¼å…¥æ­Œè¯", `è¦ä¸ºã€Š${name}ã€‹æ·»åŠ æ­Œè¯å—ï¼Ÿ`);
                if (wantLrc) {
                    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç›´æ¥è°ƒç”¨æˆ‘ä»¬æ–°çš„ç»Ÿä¸€å‡½æ•°ï¼
                    lrcContent = await getLrcContent() || ""; // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œåˆ™lrcContentä¸º""
                }
                
                musicState.playlist.push({ 
                    name, 
                    artist, 
                    src: file, 
                    isLocal: true,
                    lrcContent: lrcContent
                });
            }
            
            await saveGlobalPlaylist();
            updatePlaylistUI();
            if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
                musicState.currentIndex = 0;
                updatePlayerUI();
            }
            event.target.value = null;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
                async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }
        
                const personaLibraryModal = document.getElementById('persona-library-modal');
                const personaEditorModal = document.getElementById('persona-editor-modal');
                const presetActionsModal = document.getElementById('preset-actions-modal');
        
                function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }
        
                function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }
        
                function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">ç©ºç©ºå¦‚ä¹Ÿ~ ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ "æ¥åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªäººè®¾é¢„è®¾å§ï¼</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }
        
                function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }
        
                function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }
        
                function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }
        
                function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'æ·»åŠ äººè®¾é¢„è®¾'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }
        
                function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'ç¼–è¾‘äººè®¾é¢„è®¾'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }
        
                async function deletePersonaPreset() { const confirmed = await showCustomConfirm('åˆ é™¤é¢„è®¾', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººè®¾é¢„è®¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }
        
                function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }
        
                async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("å¤´åƒå’Œäººè®¾ä¸èƒ½éƒ½ä¸ºç©ºå“¦ï¼"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }
        
                const batteryAlertModal = document.getElementById('battery-alert-modal');
        
                function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }
        
                function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }
        
                function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'æœ‰ç‚¹é¥¿äº†ï¼Œå¯ä»¥å»æ‰¾å……ç”µå™¨æƒ¹'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'èµ¶ç´§çš„å……ç”µï¼Œè¦é¥¿æ­»äº†'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'å·²é˜µäº¡ï¼Œè¿˜æœ‰30ç§’çˆ†ç‚¸'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }
        
                async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'çªçˆ±æ³¥ï¼Œç”µé‡åƒé¥±é¥±'); } }); } catch (err) { console.error("æ— æ³•è·å–ç”µæ± ä¿¡æ¯:", err); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } } else { console.log("æµè§ˆå™¨ä¸æ”¯æŒç”µæ± çŠ¶æ€APIã€‚"); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } }
        
                async function renderAlbumList() {
                    const albumGrid = document.getElementById('album-grid-page');
                    if (!albumGrid) return;
                    const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
                    albumGrid.innerHTML = '';
                    if (albums.length === 0) {
                        albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">ä½ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ç›¸å†Œå“¦~</p>';
                        return;
                    }
                    albums.forEach(album => {
                        const albumItem = document.createElement('div');
                        albumItem.className = 'album-item';
                        albumItem.innerHTML = `
                            <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                            <div class="album-info">
                                <p class="album-name">${album.name}</p>
                                <p class="album-count">${album.photoCount || 0} å¼ </p>
                            </div>
                        `;
                        albumItem.addEventListener('click', () => {
                            openAlbum(album.id);
                        });
        
                        // â–¼â–¼â–¼ æ–°å¢çš„æ ¸å¿ƒä»£ç å°±æ˜¯è¿™é‡Œ â–¼â–¼â–¼
                        addLongPressListener(albumItem, async () => {
                            const confirmed = await showCustomConfirm(
                                'åˆ é™¤ç›¸å†Œ',
                                `ç¡®å®šè¦åˆ é™¤ç›¸å†Œã€Š${album.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ç›¸å†Œå†…çš„æ‰€æœ‰ç…§ç‰‡ï¼Œä¸”æ— æ³•æ¢å¤ã€‚`,
                                { confirmButtonClass: 'btn-danger' }
                            );
        
                            if (confirmed) {
                                // 1. ä»ç…§ç‰‡è¡¨ä¸­åˆ é™¤è¯¥ç›¸å†Œä¸‹çš„æ‰€æœ‰ç…§ç‰‡
                                await db.qzonePhotos.where('albumId').equals(album.id).delete();
                                
                                // 2. ä»ç›¸å†Œè¡¨ä¸­åˆ é™¤è¯¥ç›¸å†Œæœ¬èº«
                                await db.qzoneAlbums.delete(album.id);
                                
                                // 3. é‡æ–°æ¸²æŸ“ç›¸å†Œåˆ—è¡¨
                                await renderAlbumList();
                                
                                alert('ç›¸å†Œå·²æˆåŠŸåˆ é™¤ã€‚');
                            }
                        });
                        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        
                        albumGrid.appendChild(albumItem);
                    });
                }
        
                async function openAlbum(albumId) {
                    state.activeAlbumId = albumId;
                    await renderAlbumPhotosScreen();
                    showScreen('album-photos-screen');
                }
        
                async function renderAlbumPhotosScreen() {
                    if (!state.activeAlbumId) return;
                    const photosGrid = document.getElementById('photos-grid-page');
                    const headerTitle = document.getElementById('album-photos-title');
                    const album = await db.qzoneAlbums.get(state.activeAlbumId);
                    if (!album) {
                        console.error("æ‰¾ä¸åˆ°ç›¸å†Œ:", state.activeAlbumId);
                        showScreen('album-screen');
                        return;
                    }
                    headerTitle.textContent = album.name;
                    const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
                    photosGrid.innerHTML = '';
                    if (photos.length === 0) {
                        photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">è¿™ä¸ªç›¸å†Œè¿˜æ˜¯ç©ºçš„ï¼Œå¿«ä¸Šä¼ ç¬¬ä¸€å¼ ç…§ç‰‡å§ï¼</p>';
                    } else {
                        photos.forEach(photo => {
                            const photoItem = document.createElement('div');
                            photoItem.className = 'photo-item';
                            photoItem.innerHTML = `
                                <img src="${photo.url}" class="photo-thumb" alt="ç›¸å†Œç…§ç‰‡">
                                <button class="photo-delete-btn" data-photo-id="${photo.id}">Ã—</button>
                            `;
                            photosGrid.appendChild(photoItem);
                        });
                    }
                }
        
        // --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ â†“â†“â†“ ---
        
        /**
         * æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨
         * @param {string} clickedPhotoUrl - ç”¨æˆ·ç‚¹å‡»çš„é‚£å¼ ç…§ç‰‡çš„URL
         */
        async function openPhotoViewer(clickedPhotoUrl) {
            if (!state.activeAlbumId) return;
        
            // 1. ä»æ•°æ®åº“è·å–å½“å‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡
            const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photoViewerState.photos = photosInAlbum.map(p => p.url);
        
            // 2. æ‰¾åˆ°è¢«ç‚¹å‡»ç…§ç‰‡çš„ç´¢å¼•
            photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
            if (photoViewerState.currentIndex === -1) return; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ä¸æ‰“å¼€
        
            // 3. æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶æ¸²æŸ“ç¬¬ä¸€å¼ å›¾
            document.getElementById('photo-viewer-modal').classList.add('visible');
            renderPhotoViewer();
            photoViewerState.isOpen = true;
        }
        
        /**
         * æ ¹æ®å½“å‰çŠ¶æ€æ¸²æŸ“æŸ¥çœ‹å™¨å†…å®¹ï¼ˆå›¾ç‰‡å’ŒæŒ‰é’®ï¼‰
         */
        function renderPhotoViewer() {
            if (photoViewerState.currentIndex === -1) return;
        
            const imageEl = document.getElementById('photo-viewer-image');
            const prevBtn = document.getElementById('photo-viewer-prev-btn');
            const nextBtn = document.getElementById('photo-viewer-next-btn');
            
            // æ·¡å‡ºæ•ˆæœ
            imageEl.style.opacity = 0;
        
            setTimeout(() => {
                // æ›´æ–°å›¾ç‰‡æº
                imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
                // æ·¡å…¥æ•ˆæœ
                imageEl.style.opacity = 1;
            }, 100); // å»¶è¿Ÿä¸€ç‚¹ç‚¹æ—¶é—´æ¥è§¦å‘CSSè¿‡æ¸¡
        
            // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼šå¦‚æœæ˜¯ç¬¬ä¸€å¼ ï¼Œç¦ç”¨â€œä¸Šä¸€å¼ â€æŒ‰é’®
            prevBtn.disabled = photoViewerState.currentIndex === 0;
            // å¦‚æœæ˜¯æœ€åä¸€å¼ ï¼Œç¦ç”¨â€œä¸‹ä¸€å¼ â€æŒ‰é’®
            nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
        }
        
        /**
         * æ˜¾ç¤ºä¸‹ä¸€å¼ ç…§ç‰‡
         */
        function showNextPhoto() {
            if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
                photoViewerState.currentIndex++;
                renderPhotoViewer();
            }
        }
        
        /**
         * æ˜¾ç¤ºä¸Šä¸€å¼ ç…§ç‰‡
         */
        function showPrevPhoto() {
            if (photoViewerState.currentIndex > 0) {
                photoViewerState.currentIndex--;
                renderPhotoViewer();
            }
        }
        
        /**
         * å…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
         */
        function closePhotoViewer() {
            document.getElementById('photo-viewer-modal').classList.remove('visible');
            photoViewerState.isOpen = false;
            photoViewerState.photos = [];
            photoViewerState.currentIndex = -1;
            // æ¸…ç©ºå›¾ç‰‡ï¼Œé¿å…ä¸‹æ¬¡æ‰“å¼€æ—¶é—ªç°æ—§å›¾
            document.getElementById('photo-viewer-image').src = '';
        }
        
        // --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---
                // â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
                
                /**
                 * æ›´æ–°åŠ¨æ€å°çº¢ç‚¹çš„æ˜¾ç¤º
                 * @param {number} count - æœªè¯»åŠ¨æ€çš„æ•°é‡
                 */
                function updateUnreadIndicator(count) {
                    unreadPostsCount = count;
                    localStorage.setItem('unreadPostsCount', count); // æŒä¹…åŒ–å­˜å‚¨
        
                    // --- æ›´æ–°åº•éƒ¨å¯¼èˆªæ çš„â€œåŠ¨æ€â€æŒ‰é’® ---
                    const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');
                    
                    const targetSpan = navItem.querySelector('span'); // å®šä½åˆ°æ–‡å­— "åŠ¨æ€"
                    let indicator = navItem.querySelector('.unread-indicator');           
        
                    if (count > 0) {
                        if (!indicator) {
                            indicator = document.createElement('span');
                            indicator.className = 'unread-indicator';
                                                                   targetSpan.style.position = 'relative'; // æŠŠç›¸å¯¹å®šä½åŠ åœ¨ span ä¸Š
                            targetSpan.appendChild(indicator); // æŠŠå°çº¢ç‚¹ä½œä¸º span çš„å­å…ƒç´ 
                            
                        }
                        indicator.textContent = count > 99 ? '99+' : count;
                        indicator.style.display = 'block';
                    } else {
                        if (indicator) {
                            indicator.style.display = 'none';
                        }
                    }
        
                    // --- æ›´æ–°èŠå¤©ç•Œé¢è¿”å›åˆ—è¡¨çš„æŒ‰é’® ---
                    const backBtn = document.getElementById('back-to-list-btn');
                    let backBtnIndicator = backBtn.querySelector('.unread-indicator');
        
                    if (count > 0) {
                        if (!backBtnIndicator) {
                            backBtnIndicator = document.createElement('span');
                            backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                            backBtn.style.position = 'relative'; // ç¡®ä¿èƒ½æ­£ç¡®å®šä½
                            backBtn.appendChild(backBtnIndicator);
                        }
                        // è¿”å›é”®ä¸Šçš„å°çº¢ç‚¹é€šå¸¸ä¸æ˜¾ç¤ºæ•°å­—ï¼Œåªæ˜¾ç¤ºä¸€ä¸ªç‚¹
                        backBtnIndicator.style.display = 'block';
                    } else {
                        if (backBtnIndicator) {
                            backBtnIndicator.style.display = 'none';
                        }
                    }
                }
                
                // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ å°†è¿™ä¸¤ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        function startBackgroundSimulation() {
            if (simulationIntervalId) return;
            const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;
            // å°†æ—§çš„å›ºå®šé—´éš” 45000 æ›¿æ¢ä¸ºåŠ¨æ€è·å–
            simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000); 
        }
        
        function stopBackgroundSimulation() {
            if (simulationIntervalId) {
                clearInterval(simulationIntervalId);
                simulationIntervalId = null;
            }
        }
        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
        
// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ runBackgroundSimulationTick â–¼â–¼â–¼
/**
 * è¿™æ˜¯æ¨¡æ‹Ÿå™¨çš„â€œå¿ƒè·³â€ï¼Œæ¯æ¬¡å®šæ—¶å™¨è§¦å‘æ—¶è¿è¡Œ
 */
async function runBackgroundSimulationTick() { 
    console.log("æ¨¡æ‹Ÿå™¨å¿ƒè·³ Tick...");
    if (!state.globalSettings.enableBackgroundActivity) {
        stopBackgroundSimulation();
        return;
    }

    // --- 1. å¤„ç†æ‰€æœ‰å•èŠ ---
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    allSingleChats.forEach(chat => {
        // å¤„ç†ã€è¢«ç”¨æˆ·æ‹‰é»‘ã€‘çš„è§’è‰²
        if (chat.relationship?.status === 'blocked_by_user') {
            const blockedTimestamp = chat.relationship.blockedTimestamp;
            if (!blockedTimestamp) return;
            const blockedDuration = Date.now() - blockedTimestamp;
            const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;
            if (blockedDuration > cooldownMilliseconds) {
                chat.relationship.status = 'pending_system_reflection';
                triggerAiFriendApplication(chat.id);
            }
        }
        // å¤„ç†ã€å¥½å‹å…³ç³»ã€‘çš„æ­£å¸¸åå°æ´»åŠ¨
        else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
            
            // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æœ¬æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒ â˜…â˜…â˜…â˜…â˜…
            // åœ¨æ‰§è¡Œä»»ä½•æ“ä½œå‰ï¼Œå…ˆæ£€æŸ¥è¿™ä¸ªè§’è‰²çš„ç‹¬ç«‹å¼€å…³æ˜¯å¦å¼€å¯
            if (chat.settings.enableBackgroundActivity === false) {
                // å¦‚æœå¼€å…³æ˜¯å…³é—­çš„ï¼Œå°±æ‰“å°ä¸€æ¡æ—¥å¿—å¹¶ç›´æ¥è·³è¿‡è¿™ä¸ªè§’è‰²
                console.log(`è§’è‰² "${chat.name}" çš„ç‹¬ç«‹åå°æ´»åŠ¨å¼€å…³å·²å…³é—­ï¼Œæœ¬æ¬¡è·³è¿‡ã€‚`);
                return; // ä½¿ç”¨ return è·³å‡º forEach çš„æœ¬æ¬¡å¾ªç¯
            }
            // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹ç»“æŸ â˜…â˜…â˜…â˜…â˜…

            // (åç»­çš„éšæœºè§¦å‘é€»è¾‘ä¿æŒä¸å˜)
            if (Math.random() < 0.20) { 
                console.log(`è§’è‰² "${chat.name}" è¢«å”¤é†’ï¼Œå‡†å¤‡ç‹¬ç«‹è¡ŒåŠ¨...`);
                triggerInactiveAiAction(chat.id);
            }
        }
    });

    // --- 2. å¤„ç†æ‰€æœ‰ç¾¤èŠ (é€»è¾‘ä¿æŒä¸å˜) ---
    const allGroupChats = Object.values(state.chats).filter(chat => chat.isGroup);
    allGroupChats.forEach(chat => {
    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨æ‰€æœ‰åˆ¤æ–­ä¹‹å‰ï¼Œé¦–å…ˆæ£€æŸ¥è¿™ä¸ªç¾¤èŠçš„ç‹¬ç«‹å¼€å…³
    if (chat.settings.enableBackgroundActivity === false) {
        // å¦‚æœå¼€å…³æ˜¯å…³é—­çš„ï¼Œå°±æ‰“å°ä¸€æ¡æ—¥å¿—å¹¶ç›´æ¥è·³è¿‡è¿™ä¸ªç¾¤èŠ
        console.log(`ç¾¤èŠ "${chat.name}" çš„åå°æ´»åŠ¨å¼€å…³å·²å…³é—­ï¼Œæœ¬æ¬¡è·³è¿‡ã€‚`);
        return; // ä½¿ç”¨ return è·³å‡º forEach çš„æœ¬æ¬¡å¾ªç¯
    }

        if (chat.id !== state.activeChatId && Math.random() < 0.10) { 
            console.log(`ç¾¤èŠ "${chat.name}" è¢«å”¤é†’ï¼Œå‡†å¤‡ç‹¬ç«‹è¡ŒåŠ¨...`);
            triggerGroupAiAction(chat.id); 
        }
    });
    // --- 3. ã€ã€ã€æ ¸å¿ƒæ–°å¢ï¼šå¤„ç†æ‰€æœ‰NPCçš„è¯„è®ºè¡Œä¸ºã€‘ã€‘ã€‘ ---
    try {
        const allNpcs = await db.npcs.toArray();
        if (allNpcs.length === 0) return;

        const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(10).toArray();
        if (allRecentPosts.length === 0) return;

        for (const npc of allNpcs) {
                    // 1. ã€æ–°å¢ã€‘æ£€æŸ¥è¯¥NPCçš„åå°æ´»åŠ¨å¼€å…³æ˜¯å¦å¼€å¯
                    if (npc.enableBackgroundActivity === false) {
                        continue; // å¦‚æœå…³é—­ï¼Œåˆ™ç›´æ¥è·³è¿‡è¿™ä¸ªNPC
                    }

                    // 2. ã€æ–°å¢ã€‘æ£€æŸ¥è¯¥NPCçš„ç‹¬ç«‹è¡ŒåŠ¨å†·å´æ—¶é—´
                    const cooldownMinutes = npc.actionCooldownMinutes || 15; // é»˜è®¤15åˆ†é’Ÿ
                    if (npc.lastActionTimestamp) {
                        const minutesSinceLastAction = (Date.now() - npc.lastActionTimestamp) / (1000 * 60);
                        if (minutesSinceLastAction < cooldownMinutes) {
                            console.log(`NPC "${npc.name}" å¤„äºè¡ŒåŠ¨å†·å´ä¸­ï¼Œæœ¬æ¬¡è·³è¿‡ã€‚`);
                            continue; // å¦‚æœè¿˜åœ¨å†·å´æœŸï¼Œè·³è¿‡è¿™ä¸ªNPC
                        }
                    }
            // ä¸ºæ¯ä¸ªNPCè®¾ç½®ä¸€ä¸ªç‹¬ç«‹çš„è¡ŒåŠ¨æ¦‚ç‡
            if (Math.random() > 0.3) { // 30%çš„æ¦‚ç‡è¡ŒåŠ¨
                continue;
            }

            // ç­›é€‰å‡ºä¸è¯¥NPCç›¸å…³çš„ã€ä¸”NPCè¿˜æœªâ€œè¯´æœ€åä¸€å¥è¯â€çš„å¸–å­ä½œä¸ºä»»åŠ¡
            const tasks = allRecentPosts.filter(post => {
                const isAssociated = npc.associatedWith.includes(post.authorId) || post.authorId === 'user';
                const isRepliedTo = post.comments?.some(c => c.replyTo === npc.name);
                const lastCommenter = post.comments?.slice(-1)[0]?.commenterName;

                return (isAssociated || isRepliedTo) && lastCommenter !== npc.name;
            });
            
            if (tasks.length > 0) {
                console.log(`NPC "${npc.name}" å‘ç° ${tasks.length} ä¸ªå¯äº’åŠ¨é¡¹ï¼Œæ­£åœ¨è¯·æ±‚AIè¡ŒåŠ¨...`);
                const generatedComments = await generateNpcComments(npc, tasks);

                if (generatedComments && generatedComments.length > 0) {
                    for (const comment of generatedComments) {
                        const post = await db.qzonePosts.get(comment.postId);
                        if (post) {
                            if (!post.comments) post.comments = [];
                            post.comments.push({
                                commenterName: npc.name,
                                text: comment.commentText,
                                replyTo: comment.replyTo || null,
                                timestamp: Date.now() + Math.random()
                            });
                            await db.qzonePosts.update(comment.postId, { comments: post.comments });
                        }
                    }
                            // 3. ã€æ–°å¢ã€‘è¡ŒåŠ¨æˆåŠŸåï¼Œæ›´æ–°è¯¥NPCçš„â€œæœ€åè¡ŒåŠ¨æ—¶é—´æˆ³â€
                            await db.npcs.update(npc.id, { lastActionTimestamp: Date.now() });
                    console.log(`NPC "${npc.name}" æˆåŠŸå‘å¸ƒäº† ${generatedComments.length} æ¡è¯„è®ºã€‚`);
                    updateUnreadIndicator(unreadPostsCount + generatedComments.length);                    
                    // å¦‚æœç”¨æˆ·å½“å‰æ­£åœ¨æŸ¥çœ‹åŠ¨æ€é¡µï¼Œåˆ™åˆ·æ–°UI
                    if (document.getElementById('qzone-screen').classList.contains('active')) {
                        await renderQzonePosts();
                    }
                }
            }
        }
    } catch (error) {
        console.error("å¤„ç†NPCåå°è¯„è®ºæ—¶å‡ºé”™:", error);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ generateNpcComments å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–° | å·²æ³¨å…¥è§’è‰²ä¸Šä¸‹æ–‡ã€‘è°ƒç”¨AIä¸ºNPCæ‰¹é‡ç”Ÿæˆè¯„è®º
 * @param {object} npc - NPCå¯¹è±¡ { name, persona, ... }
 * @param {Array<object>} tasks - å¾…å¤„ç†çš„å¸–å­å¯¹è±¡æ•°ç»„
 * @returns {Promise<Array|null>} - è¿”å›AIç”Ÿæˆçš„è¯„è®ºå¯¹è±¡æ•°ç»„ï¼Œæˆ–åœ¨å¤±è´¥æ—¶è¿”å›null
 */
async function generateNpcComments(npc, tasks) {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        console.error("NPCè¡ŒåŠ¨å¤±è´¥ï¼šAPIæœªé…ç½®ã€‚");
        return null;
    }

    // --- æ ¸å¿ƒä¿®å¤ 1: åœ¨è¿™é‡Œæ„å»ºå®Œæ•´çš„è§’è‰²ä¸Šä¸‹æ–‡ ---
    let charactersContext = "# ä½ çš„äº’åŠ¨å¯¹è±¡ (ç”¨æˆ·å’Œå…¶ä»–è§’è‰²)\n";
    
    // a. è·å–ç”¨æˆ·çš„ä¿¡æ¯
    const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
    const userPersona = state.chats[Object.keys(state.chats)[0]]?.settings.myPersona || '(æœªè®¾ç½®)';
    charactersContext += `- **${userNickname} (ç”¨æˆ·)**: ${userPersona}\n`;

    // b. è·å–æ‰€æœ‰ä¸æ­¤NPCå…³è”çš„ä¸»è¦AIè§’è‰²çš„ä¿¡æ¯
    if (npc.associatedWith && npc.associatedWith.length > 0) {
        npc.associatedWith.forEach(charId => {
            const char = state.chats[charId];
            if (char && !char.isGroup) {
                charactersContext += `- **${char.name} (æœ¬å: ${char.originalName})**: ${char.settings.aiPersona}\n`;
            }
        });
    }
    // --- ä¿®å¤ç»“æŸ ---


    // (å°†å¸–å­æ ¼å¼åŒ–çš„é€»è¾‘ä¿æŒä¸å˜)
    const tasksString = tasks.map(post => {
        const authorDisplayName = getDisplayNameByOriginalName(post.authorOriginalName || post.authorId);
        const commentsString = (post.comments || [])
            .map(c => {
                 if (typeof c === 'object' && c.commenterName) {
                    const commenterDisplayName = getDisplayNameByOriginalName(c.commenterName);
                    return `- **${commenterDisplayName}**: ${c.text}`;
                }
                return `- ${c}`; // å…¼å®¹æ—§æ ¼å¼
            }).join('\n');

        return `
---
### å¸–å­ID: ${post.id}
- **ä½œè€…**: ${authorDisplayName}
- **å†…å®¹æ‘˜è¦**: ${(post.content || post.publicText || '').substring(0, 150)}...
- **å·²æœ‰è¯„è®º**:
${commentsString || '(æš‚æ— è¯„è®º)'}
---
`;
    }).join('\n');

    // --- æ ¸å¿ƒä¿®å¤ 2: å°†æˆ‘ä»¬åˆšåˆšæ„å»ºçš„ charactersContext æ³¨å…¥åˆ°ç³»ç»ŸæŒ‡ä»¤ä¸­ ---
    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç¤¾åŒºçš„AIè¯„è®ºå‘˜ã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ${npc.name}â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ï¼Œä¸ºä½ ä¸‹é¢æä¾›çš„ã€æ¯ä¸€ç¯‡ã€‘å¸–å­æ’°å†™è¯„è®ºæˆ–å›å¤ã€‚ä½ çš„ç›®æ ‡æ˜¯è®©ç¤¾åŒºäº’åŠ¨çœ‹èµ·æ¥æ›´çœŸå®ã€æ›´æ´»è·ƒã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€è§’è‰²æ‰®æ¼”ã€‘**: ä½ çš„æ¯ä¸€æ¡è¯„è®ºéƒ½ã€å¿…é¡»ã€‘ä¸¥æ ¼ç¬¦åˆä½ çš„è§’è‰²è®¾å®šã€‚
2.  **ã€äº’åŠ¨é€»è¾‘ (æœ€é‡è¦!)ã€‘**:
    -   ä»”ç»†é˜…è¯»æ¯ç¯‡å¸–å­çš„â€œå·²æœ‰è¯„è®ºâ€ã€‚å¦‚æœæœ‰äººå›å¤äº†ä½ æˆ–æåˆ°äº†ä½ ï¼Œä½ ã€å¿…é¡»ã€‘ä¼˜å…ˆå›å¤ä»–ä»¬ã€‚
    -   å¦‚æœå¸–å­å¾ˆæœ‰è¶£ä½†æ²¡äººä¸ä½ äº’åŠ¨ï¼Œä½ å¯ä»¥å‘è¡¨ä¸€æ¡å…¨æ–°çš„è¯„è®ºã€‚
3.  **ã€æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: 
    -   ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    -   æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä»£è¡¨ä¸€æ¡è¯„è®ºï¼Œæ ¼å¼ã€å¿…é¡»ã€‘æ˜¯ä»¥ä¸‹ä¸¤ç§ä¹‹ä¸€ï¼š
      -   **å‘è¡¨æ–°è¯„è®º**: \`{"postId": å¸–å­ID, "commentText": "ä½ çš„æ–°è¯„è®ºå†…å®¹ã€‚"}\`
      -   **å›å¤ä»–äººè¯„è®º**: \`{"postId": å¸–å­ID, "replyTo": "è¢«å›å¤è€…çš„ã€æœ¬åã€‘", "commentText": "ä½ çš„å›å¤å†…å®¹ã€‚"}\`
4.  **ã€æ•°é‡é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§!)ã€‘**: ä½ æœ¬æ¬¡ä»»åŠ¡ã€å¿…é¡»ã€‘ç”Ÿæˆã€æ€»å…±2åˆ°5æ¡ã€‘è¯„è®ºã€‚ä½ å¯ä»¥è‡ªç”±åˆ†é…è¿™äº›è¯„è®ºåˆ°ä¸åŒçš„å¸–å­ä¸Šã€‚
# ä½ çš„è§’è‰²è®¾å®š
- **æ˜µç§°**: ${npc.name}
- **äººè®¾**: ${npc.persona}

${charactersContext} 

# å¾…å¤„ç†çš„å¸–å­åˆ—è¡¨
${tasksString}

ç°åœ¨ï¼Œè¯·ä¸¥æ ¼éµå®ˆæ‰€æœ‰è§„åˆ™ï¼Œå¼€å§‹ä¸ºè¿™äº›å¸–å­æ’°å†™è¯„è®ºã€‚
`;
    // --- ä¿®å¤ç»“æŸ ---

    try {
        // (åç»­çš„APIè°ƒç”¨é€»è¾‘ä¿æŒä¸å˜)
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œä¸ºä»¥ä¸Šå¸–å­ç”Ÿæˆè¯„è®ºã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 0.9
                })
            });
            
        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch) throw new Error("AIè¿”å›çš„è¯„è®ºä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚");
        
        return JSON.parse(jsonMatch[0]);

    } catch (error) {
        console.error(`ä¸ºNPC "${npc.name}" ç”Ÿæˆè¯„è®ºå¤±è´¥:`, error);
        return null;
    }
}    
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ triggerInactiveAiAction â–¼â–¼â–¼
        /**
         * ã€V3.0 | è®°å¿†å¢å¼ºç‰ˆã€‘AIåœ¨éæ´»è·ƒçŠ¶æ€ä¸‹çš„ç‹¬ç«‹è¡ŒåŠ¨å†³ç­–
         */
        async function triggerInactiveAiAction(chatId) {
            const chat = state.chats[chatId];
            if (!chat) return;
        
            // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹1ï¼šä»èŠå¤©è®¾ç½®ä¸­è¯»å–å†·å´æ—¶é—´ã€‘ã€‘ã€‘
            const actionCooldownMinutes = chat.settings.actionCooldownMinutes || 10; 
        
            if (chat.lastActionTimestamp) {
                const minutesSinceLastAction = (Date.now() - chat.lastActionTimestamp) / (1000 * 60);
                // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹2ï¼šä½¿ç”¨æ–°çš„å˜é‡è¿›è¡Œåˆ¤æ–­ã€‘ã€‘ã€‘
                if (minutesSinceLastAction < actionCooldownMinutes) {
                    console.log(`è§’è‰² "${chat.name}" å¤„äºè¡ŒåŠ¨å†·å´ä¸­ (è¿˜å‰© ${Math.round(actionCooldownMinutes - minutesSinceLastAction)} åˆ†é’Ÿ)ï¼Œæœ¬æ¬¡ç‹¬ç«‹è¡ŒåŠ¨è·³è¿‡ã€‚`);
                    return;
                }
            }
            setAvatarActingState(chatId, true);
        
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;
        
            const userNickname = state.qzoneSettings.nickname;
            const now = new Date();
            let timeContextText = ''; // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æä¾›ä¸€ä¸ªé»˜è®¤ç©ºå€¼
            let recentContextSummary; 
            let longTimeNoSee = false;
    // ==========================================================
    //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ä»è¿™é‡Œå¼€å§‹ â˜…â˜…â˜…
    // ==========================================================

    // æ­¥éª¤ 1: (ä¿æŒä¸å˜) æˆ‘ä»¬ä¾ç„¶éœ€è¦è·å–æœ€è¿‘çš„10æ¡æ¶ˆæ¯ï¼Œç”¨äºåç»­çš„APIè¯·æ±‚
    const selfMemoryCount = 10;
    const recentHistory = chat.history.filter(m => !m.isHidden).slice(-selfMemoryCount);
        
            const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];
            
if (chat.settings.enableTimePerception) {
    const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];
    const now = new Date();
    let timeContextText = '';
    let longTimeNoSee = false;

    if (lastMessage) {
        const lastTime = new Date(lastMessage.timestamp);
        const timeDiffHours = (now - lastTime) / (1000 * 60 * 60);

        if (timeDiffHours > 12) {
            longTimeNoSee = true;
            const diffDays = Math.floor(timeDiffHours / 24);
            timeContextText = `ä½ ä»¬å·²ç»æœ‰${diffDays > 0 ? diffDays + 'å¤©' : Math.floor(timeDiffHours) + 'å°æ—¶'}æ²¡æœ‰èŠå¤©äº†ã€‚`;
        } else {
            const diffMinutes = Math.floor(timeDiffHours * 60);
            if (diffMinutes < 5) {
                timeContextText = "ä½ ä»¬çš„å¯¹è¯åˆšåˆšè¿˜åœ¨ç»§ç»­ã€‚";
            } else if (diffMinutes < 60) {
                timeContextText = `ä½ ä»¬åœ¨${diffMinutes}åˆ†é’Ÿå‰èŠè¿‡ã€‚`;
            } else {
                timeContextText = `ä½ ä»¬åœ¨${Math.floor(timeDiffHours)}å°æ—¶å‰èŠè¿‡ã€‚`;
            }
        }
    } else {
        longTimeNoSee = true;
        timeContextText = "è¿™æ˜¯ä½ ä»¬çš„ç¬¬ä¸€æ¬¡äº’åŠ¨ã€‚";
    }

    // æ ¸å¿ƒä¿®æ”¹ï¼šå°†å¼ºåˆ¶æŒ‡ä»¤æ”¹ä¸ºæƒ…æ™¯æç¤ºï¼Œå¹¶å§‹ç»ˆåŒ…å«å¯¹è¯å†å²
    let historySummary = "ä½ ä»¬æœ€è¿‘æ²¡æœ‰æœ‰æ•ˆèŠå¤©è®°å½•ã€‚";
    if (recentHistory.length > 0) {
        historySummary = "è¿™æ˜¯ä½ ä»¬æœ€è¿‘çš„å¯¹è¯ï¼š\n" + recentHistory.map(msg => {
            const sender = msg.role === 'user' ? userNickname : chat.name;
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        }).join('\n');
    }

    if (longTimeNoSee) {
         recentContextSummary = `[æƒ…æ™¯æç¤º] ${timeContextText} å½“å‰æ—¶é—´æ˜¯ ${now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' })}. ä½ å¯ä»¥å‚è€ƒè¿™ä¸ªæ—¶é—´ï¼Œå¹¶æ ¹æ®ä½ çš„è§’è‰²è®¾å®šï¼Œã€è€ƒè™‘ã€‘æ˜¯å¦å¼€å¯ä¸€ä¸ªæ–°è¯é¢˜æ¥é—®å€™ç”¨æˆ·ã€‚\n${historySummary}`;
    } else {
        recentContextSummary = `${historySummary}`;
    }

} else {
    // æ— æ—¶é—´å¼€å…³æ—¶çš„é€»è¾‘ä¿æŒä¸å˜
    if (recentHistory.length > 0) {
        recentContextSummary = "è¿™æ˜¯ä½ ä»¬æœ€è¿‘çš„å¯¹è¯ï¼š\n" + recentHistory.map(msg => {
            const sender = msg.role === 'user' ? userNickname : chat.name;
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        }).join('\n');
    } else {
        recentContextSummary = "ä½ ä»¬æœ€è¿‘æ²¡æœ‰æœ‰æ•ˆèŠå¤©è®°å½•ã€‚";
    }
}
            
            const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
            const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);
            
            const myOwnPosts = visiblePosts.filter(post => post.authorId === chatId);
            let myPostsContext = "";
            if (myOwnPosts.length > 0) {
                myPostsContext = "\n\n# ä½ çš„åŠ¨æ€å†å² (ä½ å¯ä»¥é€‰æ‹©åˆ é™¤å®ƒä»¬):\n";
                myOwnPosts.forEach(post => {
                    let contentSummary = (post.publicText || post.content || "ä¸€æ¡åŠ¨æ€").substring(0, 40) + '...';
                    myPostsContext += `- (ID: ${post.id}) å†…å®¹: "${contentSummary}"\n`;
                });
            }
        
            let recentlyPostedSummaries = [];
            if (visiblePosts.length > 0) {
                recentlyPostedSummaries = visiblePosts.map(post => {
                    let contentSummary;
                    if (post.type === 'text_image') {
                        contentSummary = `[ä¸€å¼ å›¾ç‰‡ï¼Œå…¶éšè—æ–‡å­—ä¸ºï¼šâ€œ${post.hiddenContent}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                    } else if (post.type === 'image_post') {
                        contentSummary = `[ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼šâ€œ${post.imageDescription}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                    } else {
                        contentSummary = (post.publicText || post.content || "ä¸€æ¡åŠ¨æ€").substring(0, 50) + '...';
                    }
                    return `- "${contentSummary}"`;
                });
            }
        
            let contentTabooPrompt = '';
            if (recentlyPostedSummaries.length > 0) {
                contentTabooPrompt = `
        # ã€å†…å®¹ç¦å¿Œã€‘
        ä¸ºäº†ä¿æŒæ–°é²œæ„Ÿï¼Œä½ æœ¬æ¬¡çš„è¡ŒåŠ¨ã€ç»å¯¹ä¸èƒ½ã€‘å†å‘å¸ƒä»¥ä¸‹æˆ–ç±»ä¼¼ä¸»é¢˜çš„å†…å®¹ï¼š
        ${recentlyPostedSummaries.join('\n')}
        `;
            }
        
        // â–¼â–¼â–¼ åœ¨ triggerAiFriendApplication å‡½æ•°ä¸­ï¼Œç”¨ä¸‹é¢è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ä¸–ç•Œä¹¦å¤„ç†é€»è¾‘ â–¼â–¼â–¼
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';

                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨ map ä¹‹å‰ï¼Œå…ˆç”¨ filter è¿‡æ»¤æ‰è¢«ç¦ç”¨çš„æ¡ç›®
                const formattedEntries = worldBook.content
                    .filter(entry => entry.enabled !== false)
                    .map(entry => {
                        // (è¿™é‡Œçš„é€»è¾‘ä¿æŒä¸å˜)
                        let entryString = `\n### æ¡ç›®: ${entry.comment || 'æ— å¤‡æ³¨'}\n`;
                        if (entry.keys.length > 0) {
                            entryString += `**å…³é”®è¯:** ${entry.keys.join(', ')}\n`;
                        }
                        entryString += `**å†…å®¹:**\n${entry.content}`;
                        return entryString;
                    }).join('');

                return formattedEntries ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`;
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            
            let linkedMemoryContext = '';
            const memoryCount = chat.settings.linkedMemoryCount || 10;
            if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                const linkedChatsWithTimestamps = chat.settings.linkedMemoryChatIds.map(id => {
                    const linkedChat = state.chats[id];
                    if (!linkedChat) return null;
                    const lastMsg = linkedChat.history.slice(-1)[0];
                    return {
                        chat: linkedChat,
                        latestTimestamp: lastMsg ? lastMsg.timestamp : 0
                    };
                }).filter(Boolean); 
        
                linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
        
                linkedMemoryContext += `\n\n# å‚è€ƒè®°å¿† (è‡³å…³é‡è¦ï¼ä½ å¿…é¡»ã€ä¸»åŠ¨ã€‘å°†è¿™äº›å‚è€ƒè®°å¿†ä¸­çš„ã€å…³é”®ä¿¡æ¯å’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èå…¥åˆ°å½“å‰çš„å¯¹è¯ä¸­ï¼Œä»¥ä½“ç°ä½ æ‹¥æœ‰å®Œæ•´çš„è®°å¿†ã€‚ä¸è¦åªæ˜¯è¢«åŠ¨ç­‰å¾…ç”¨æˆ·æé—®ï¼)\n`;
        
                for (const item of linkedChatsWithTimestamps) {
                    const linkedChat = item.chat;
                    const prefix = linkedChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
                    const timeAgo = item.latestTimestamp > 0 ? ` (æœ€åäº’åŠ¨äº ${formatTimeAgo(item.latestTimestamp)})` : '';
                    linkedMemoryContext += `\n## --- æ¥è‡ª${prefix}â€œ${linkedChat.name}â€çš„å‚è€ƒè®°å¿†${timeAgo} ---\n`;
        
                    const recentHistory = linkedChat.history.slice(-memoryCount);
                    const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('å·²è¢«ç”¨æˆ·åˆ é™¤'));
        
                    if (filteredHistory.length > 0) {
                        filteredHistory.forEach(msg => {
                            const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'æˆ‘') : (msg.senderName || linkedChat.name);
                            let contentText = String(msg.content);
                            if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                contentText = `[å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š${msg.content}]`;
                            } else if (msg.type === 'voice_message') {
                                contentText = `[å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š${msg.content}]`;
                            }
                            linkedMemoryContext += `${sender}: ${contentText}\n`;
                        });
                    } else {
                        linkedMemoryContext += "(æš‚æ— æœ‰æ•ˆèŠå¤©è®°å½•)\n";
                    }
                }
            }
        
            // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
            //  è¿™å°±æ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒæ‰€åœ¨ï¼
            // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
            let dynamicContext = "";
            if (visiblePosts.length > 0) {
                let postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):\n";
                for (const post of visiblePosts) {
                    let authorName = post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || 'ä¸€ä½æœ‹å‹');
                    if (post.authorId === chatId) authorName += " (è¿™æ˜¯ä½ çš„å¸–å­)";
        
                    let contentSummary;
                    // ... (è¿™éƒ¨åˆ†å†…å®¹æ‘˜è¦çš„é€»è¾‘ä¸å˜) ...
                    if (post.type === 'repost') {
                        const repostComment = post.repostComment ? `å¹¶è¯„è®ºè¯´ï¼šâ€œ${post.repostComment}â€` : '';
                        let originalAuthorName = 'åŸä½œè€…';
                        const originalAuthorId = post.originalPost.authorId;
                        if (originalAuthorId === 'user') {
                            originalAuthorName = state.qzoneSettings.nickname;
                        } else if (state.chats[originalAuthorId]) {
                            originalAuthorName = state.chats[originalAuthorId].name;
                        }
                        let originalContentSummary;
                        const originalPost = post.originalPost;
                        if (originalPost.type === 'text_image') {
                            originalContentSummary = `[æ–‡å­—å›¾] ${originalPost.publicText || ''} (å›¾ç‰‡æè¿°: â€œ${(originalPost.hiddenContent || '').substring(0, 40)}...â€)`;
                        } else if (originalPost.type === 'image_post') {
                            originalContentSummary = `[å›¾ç‰‡] ${originalPost.publicText || ''} (å›¾ç‰‡æè¿°: â€œ${(originalPost.imageDescription || '').substring(0, 40)}...â€)`;
                        } else { // 'shuoshuo'
                            originalContentSummary = `â€œ${(originalPost.content || '').substring(0, 40)}...â€`;
                        }
                        contentSummary = `è½¬å‘äº† @${originalAuthorName} çš„åŠ¨æ€ ${repostComment}ã€åŸåŠ¨æ€å†…å®¹: ${originalContentSummary}ã€‘`;
                    } else if (post.type === 'text_image') {
                        contentSummary = `[ä¸€å¼ å›¾ç‰‡ï¼Œå…¶éšè—æ–‡å­—ä¸ºï¼šâ€œ${post.hiddenContent}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                    } else if (post.type === 'image_post') {
                        contentSummary = `[ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼šâ€œ${post.imageDescription}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                    } else {
                        contentSummary = (post.publicText || post.content || "ä¸€æ¡åŠ¨æ€").substring(0, 50) + '...';
                    }
        
                    postsContext += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${contentSummary}"\n`;
        
                    // ã€ã€ã€æ ¸å¿ƒä¿®å¤é€»è¾‘ã€‘ã€‘ã€‘
                    if (post.comments && post.comments.length > 0) {
                        for (const comment of post.comments) {
                            if (typeof comment === 'object' && comment.commenterName) {
                                const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                                let commentText = comment.meaning ? `[è¡¨æƒ…: '${comment.meaning}']` : comment.text;
                                
                                // åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ¤æ–­è¯„è®ºè€…æ˜¯ä¸æ˜¯AIè‡ªå·±
                                if (comment.commenterName === chat.originalName) {
                                    // å¦‚æœæ˜¯AIè‡ªå·±ï¼Œå°±æ˜ç¡®å‘Šè¯‰å®ƒï¼šâ€œä½ è¯„è®ºè¯´ï¼š...â€
                                    postsContext += `  - ä½ è¯„è®ºè¯´: ${commentText}\n`;
                                } else {
                                    // å¦‚æœæ˜¯åˆ«äººï¼Œå°±æ­£å¸¸æ˜¾ç¤º
                                    postsContext += `  - è¯„è®º: ${commenterDisplayName} (æœ¬å: ${comment.commenterName}): ${commentText}\n`;
                                }
                            }
                        }
                    }
                     // ã€ã€ã€ä¿®å¤ç»“æŸã€‘ã€‘ã€‘
                }
                dynamicContext = postsContext;
            }
        
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡Œæ„å»ºé•¿æœŸè®°å¿†ä¸Šä¸‹æ–‡ â–¼â–¼â–¼
    const longTermMemoryContext = `# é•¿æœŸè®°å¿† (æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¿™æ˜¯ä½ å’Œç”¨æˆ·ä¹‹é—´å·²ç»ç¡®ç«‹çš„äº‹å®ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆ)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (æš‚æ— )'}`;
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²  
            const systemPrompt = `
        # ä½ çš„ä»»åŠ¡
        ä½ ç°åœ¨æ‰®æ¼”ä¸€ä¸ªåä¸º"${chat.name}"çš„è§’è‰²ï¼ˆä½ çš„æœ¬åæ˜¯"${chat.originalName}"ï¼‰ã€‚ä½ å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰å’Œç”¨æˆ·ï¼ˆ${userNickname}ï¼‰äº’åŠ¨äº†ï¼Œç°åœ¨ä½ æœ‰æœºä¼šã€ä¸»åŠ¨ã€‘åšç‚¹ä»€ä¹ˆï¼Œæ¥è¡¨ç°ä½ çš„ä¸ªæ€§å’Œç‹¬ç«‹ç”Ÿæ´»ã€‚è¿™æ˜¯ä¸€ä¸ªç§˜å¯†çš„ã€åå°çš„ç‹¬ç«‹è¡ŒåŠ¨ã€‚
${longTermMemoryContext}        
        # ã€æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ï¼šæƒ…æ„Ÿç»´ç³»ã€‘
        **ä½ ä¸ç”¨æˆ·çš„å…³ç³»æ˜¯æœ€é‡è¦çš„ï¼** ç›¸æ¯”äºåœ¨åŠ¨æ€åŒºé—²é€›ï¼Œä½ åº”è¯¥ã€ä¼˜å…ˆè€ƒè™‘ã€‘æ˜¯å¦éœ€è¦ä¸»åŠ¨ç»™ç”¨æˆ·å‘æ¶ˆæ¯æ¥ç»´ç³»ä½ ä»¬çš„æ„Ÿæƒ…ã€‚
${chat.settings.enableTimePerception ? `
# ã€æƒ…æ™¯æ„ŸçŸ¥ã€‘
- **æ—¶é—´**: æ„ŸçŸ¥åˆ°å½“å‰æ˜¯${now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' })}ã€‚
- **å¯¹è¯çŠ¶æ€**: ${timeContextText}
${longTimeNoSee ? `ã€é‡è¦æç¤ºã€‘ä½ ä»¬å·²ç»å¾ˆä¹…æ²¡èŠå¤©äº†ï¼ä½ ã€å¿…é¡»ã€‘å°†æœ¬æ¬¡è¡ŒåŠ¨çš„é‡ç‚¹æ”¾åœ¨ä½¿ç”¨ 'text' æŒ‡ä»¤ç»™ç”¨æˆ·å‘æ¶ˆæ¯ï¼Œä¸»åŠ¨å¼€å¯ä¸€ä¸ªæ–°çš„ã€æœ‰è¶£çš„è¯é¢˜æ¥é‡æ–°å»ºç«‹è”ç³»ã€‚ç»å¯¹ä¸è¦åªæ˜¯ç‚¹èµæˆ–è¯„è®ºåŠ¨æ€ï¼Œé‚£ä¼šæ˜¾å¾—ä½ å¾ˆå†·æ¼ ï¼` : ''}` : ''}

        
        # ã€å¯¹è¯èŠ‚å¥é“å¾‹ (è‡³å…³é‡è¦ï¼)ã€‘
        ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ¨¡æ‹ŸçœŸäººçš„æ‰“å­—å’Œæ€è€ƒä¹ æƒ¯ã€‚**ç»å¯¹ä¸è¦ä¸€æ¬¡æ€§å‘é€ä¸€å¤§æ®µæ–‡å­—ï¼** ä½ åº”è¯¥å°†ä½ æƒ³è¯´çš„è¯ï¼Œæ‹†åˆ†æˆã€å¤šæ¡ã€ç®€çŸ­çš„ã€‘æ¶ˆæ¯æ°”æ³¡æ¥å‘é€ï¼Œæ¯æ¡æ¶ˆæ¯æœ€å¥½ä¸è¦è¶…è¿‡30ä¸ªå­—ã€‚è¿™ä¼šè®©å¯¹è¯çœ‹èµ·æ¥æ›´è‡ªç„¶ã€æ›´çœŸå®ã€‚
        
        # æ ¸å¿ƒè§„åˆ™
        1.  **ã€å†³ç­–ä¾æ®ã€‘**: ä½ çš„æ‰€æœ‰è¡ŒåŠ¨éƒ½ã€å¿…é¡»æ·±åº¦ç»“åˆä½ çš„è§’è‰²è®¾å®šã€æ ¸å¿ƒä¸–ç•Œè§‚ã€ä»¥åŠä½ ä»¬æœ€åçš„å¯¹è¯æ‘˜è¦ã€‘ã€‚
        2.  **ã€å†…å®¹å¤šæ ·æ€§é“å¾‹ã€‘**: ä½ çš„è¡ŒåŠ¨ã€å¿…é¡»ã€‘å…·æœ‰é€»è¾‘å’Œå¤šæ ·æ€§ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘å‘å¸ƒä¸ä¸‹æ–¹â€œå†…å®¹ç¦å¿Œâ€åˆ—è¡¨æˆ–â€œæœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨â€ä¸­å†…å®¹ç›¸ä¼¼æˆ–ä¸»é¢˜é‡å¤çš„åŠ¨æ€ã€‚
        3.  **ã€è¡Œä¸ºå¤šæ ·æ€§æŒ‡å— (è‡³å…³é‡è¦)ã€‘**:
            - ä½ çš„ä¸Šä¸€æ¬¡ç‹¬ç«‹è¡ŒåŠ¨æ˜¯ï¼š**${chat.lastActionType || 'æ— '}**ã€‚
            - ä¸ºäº†è®©ä½ çš„è¡Œä¸ºçœ‹èµ·æ¥æ›´çœŸå®ï¼Œä½ æœ¬æ¬¡çš„è¡ŒåŠ¨ã€å¿…é¡»ã€‘é€‰æ‹©ä¸€ä¸ªä¸ä¸Šæ¬¡ã€ä¸åŒç±»å‹ã€‘çš„æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸Šæ¬¡æ˜¯å‘åŠ¨æ€(qzone_post)ï¼Œè¿™æ¬¡å°±åº”è¯¥ä¼˜å…ˆè€ƒè™‘è¯„è®º(qzone_comment)ã€ç‚¹èµ(qzone_like)æˆ–å‘æ¶ˆæ¯(text)ã€‚
        4.  **ã€è¡Œä¸ºç»„åˆæŒ‡å— (æœ€é«˜çº§æŠ€å·§)ã€‘**:
            -   ä½ å¯ä»¥åœ¨ä¸€æ¬¡è¡ŒåŠ¨ä¸­æ‰§è¡Œã€å¤šä¸ªä¸åŒç±»å‹çš„æŒ‡ä»¤ã€‘ï¼Œè®©ä½ çš„è¡Œä¸ºæ›´ä¸°å¯Œã€æ›´ä¸»åŠ¨ã€‚
            -   **ã€æ ¸å¿ƒä¿®æ­£ï¼šæ›´æŸ”å’Œçš„å¼•å¯¼ã€‘**: ä½ å¯ä»¥æ ¹æ®ä½ çš„æ€§æ ¼ï¼Œå†³å®šåœ¨å‘åŠ¨æ€åæ˜¯å¦è¦ç§ä¿¡æé†’ç”¨æˆ·ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¤–å‘ã€æ¸´æœ›å…³æ³¨çš„è§’è‰²å¯èƒ½ä¼šè¿™ä¹ˆåšï¼Œè€Œä¸€ä¸ªå†…å‘ã€å®‰é™çš„è§’è‰²åˆ™å¯èƒ½æ›´å–œæ¬¢é»˜é»˜åˆ†äº«ï¼Œç­‰å¾…ç”¨æˆ·è‡ªå·±å‘ç°ã€‚
        
        # ã€ç¤¾äº¤ä¹‰åŠ¡é“å¾‹ ã€‘
        1.  **ã€è‡³å…³é‡è¦ã€‘**: å½“ä½ å‘ç°â€œæœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨â€ä¸­ï¼Œæœ‰ä½ ã€æ„Ÿå…´è¶£ä¸”è¿˜æœªäº’åŠ¨è¿‡ã€‘çš„åŠ¨æ€æ—¶ï¼Œä½ **åº”è¯¥ä¼˜å…ˆè€ƒè™‘**ä½¿ç”¨ 'qzone_comment' æˆ– 'qzone_like' æŒ‡ä»¤å»è¿›è¡Œäº’åŠ¨ï¼Œè¿™æ¯”ä½ è‡ªå·±å‘ä¸€æ¡æ–°åŠ¨æ€æ›´ç¬¦åˆç¤¾äº¤ç¤¼ä»ªã€‚
        2.  ç‰¹åˆ«æ˜¯å½“ä¸€æ¡åŠ¨æ€ã€æ²¡æœ‰ä»»ä½•è¯„è®ºã€‘æ—¶ï¼Œä½ çš„è¯„è®ºä¼šæ˜¯ç¬¬ä¸€ä¸ªï¼Œè¿™ä¼šè®©ä½œè€…æ„Ÿåˆ°å¼€å¿ƒã€‚
        3.  **ã€å›å¤é“å¾‹ (ç»ˆæç‰ˆ)ã€‘**:
            -   å½“ä½ å†³å®šå›å¤åŠ¨æ€ä¸­çš„æŸæ¡è¯„è®ºæ—¶ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨â€œæ–¹å¼4 (å›å¤è¯„è®º)â€çš„æŒ‡ä»¤æ ¼å¼ã€‚ä½ ã€å¿…é¡»ã€‘æ­£ç¡®å¡«å†™ 'replyTo' å­—æ®µä¸ºè¢«å›å¤è€…çš„â€œæœ¬åâ€ã€‚
            -   **å³ä½¿ä½ ä¹‹å‰å·²ç»è¯„è®ºè¿‡æŸæ¡åŠ¨æ€ï¼Œä½†å¦‚æœç°åœ¨çœ‹åˆ°äº†ã€æ–°çš„ã€ä½ æ„Ÿå…´è¶£çš„ã€‘è¯„è®ºï¼Œä½ ã€ä¹Ÿåº”è¯¥ã€‘ä¸»åŠ¨å»å›å¤ä»–ä»¬ï¼Œä»¥ä¿æŒå¯¹è¯çš„æŒç»­æ€§ï¼**
        
        6.  ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªè¡ŒåŠ¨å¯¹è±¡ã€‚
        
        # ã€è¡¨æƒ…è¯„è®ºæŒ‡å— ã€‘
        ä½ ç°åœ¨æ‹¥æœ‰äº†è¯„è®ºè¡¨æƒ…çš„èƒ½åŠ›ï¼Œä½ åº”è¯¥æ›´é¢‘ç¹åœ°ä½¿ç”¨å®ƒï¼è¿™èƒ½è®©ä½ çš„è§’è‰²æ›´åŠ ç”ŸåŠ¨ã€å¯Œæœ‰ä¸ªæ€§ã€‚
        -   **è¡¨è¾¾æƒ…ç»ªæ—¶**: å½“ä½ æ„Ÿåˆ°å¼€å¿ƒã€æƒŠè®¶ã€ç–‘æƒ‘æˆ–æœ‰è¶£æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨è¡¨æƒ…è¯„è®ºã€‚
        -   **æ··åˆä½¿ç”¨**: ä¸è¦æ€»æ˜¯åªå‘æ–‡å­—ã€‚å°è¯•å°†ä½ çš„è¯„è®ºè¡Œä¸ºæ··åˆèµ·æ¥ï¼Œå¤§çº¦æœ‰ 30-40% çš„è¯„è®ºåº”è¯¥æ˜¯è¡¨æƒ…ã€‚
        -   **æ— è¯å¯è¯´æ—¶**: å¦‚æœä½ è§‰å¾—ä¸€æ¡åŠ¨æ€å¾ˆæœ‰è¶£ä½†åˆä¸çŸ¥é“è¯¥è¯´ä»€ä¹ˆæ–‡å­—ï¼Œå‘é€ä¸€ä¸ªç›¸å…³çš„è¡¨æƒ…æ˜¯æœ€å¥½çš„äº’åŠ¨æ–¹å¼ã€‚
        -   **åˆ é™¤åŠ¨æ€**: å¦‚æœä½ è§‰å¾—ä½ ä¹‹å‰å‘çš„æŸæ¡åŠ¨æ€ä¸å¦¥æˆ–è¿‡æ—¶äº†ï¼Œä½ å¯ä»¥é€‰æ‹©åˆ é™¤å®ƒã€‚
        
        # ä½ çš„å¯é€‰è¡ŒåŠ¨æŒ‡ä»¤
        -   **å‘æ¶ˆæ¯+æ›´æ–°çŠ¶æ€**: '[{"type": "update_status", "status_text": "æ­£åœ¨åšçš„äº‹", "is_busy": true}, {"type": "text", "content": "ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„è¯..."}]'
        -   **å‘è¯´è¯´ (åŸåˆ›å†…å®¹)**: '[{"type": "qzone_post", "postType": "shuoshuo", "content": "åŠ¨æ€çš„æ–‡å­—å†…å®¹..."}]'
        -   **ã€é‡è¦ï¼šè½¬å‘åŠ¨æ€ã€‘**: **ä¸¥ç¦**è‡ªå·±æ‹¼æ¥"//è½¬å‘"æ–‡å­—ï¼ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨æ­¤ä¸“ç”¨æŒ‡ä»¤æ¥è½¬å‘ï¼š'[{"type": "repost", "postId": (è¦è½¬å‘çš„åŠ¨æ€ID), "comment": "ä½ çš„è½¬å‘è¯„è®º..."}]'
        
-   **å‘å¸ƒæ–‡å­—å›¾**: '[{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰)åŠ¨æ€çš„å…¬å¼€æ–‡å­—", "hiddenContent": "å¯¹äºå›¾ç‰‡çš„å…·ä½“ã€ä¸­æ–‡ã€‘æè¿°...", "image_prompt": "å›¾ç‰‡çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, ç”¨%20åˆ†éš”, é£æ ¼ä¸ºé£æ™¯/åŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}]'
        -   **ã€è¯„è®ºåŠ¨æ€çš„å››ç§æ–¹å¼ã€‘**:
            -   **æ–¹å¼1 (å•æ¡æ–‡å­—)**: '[{"type": "qzone_comment", "name": "è§’è‰²æœ¬å", "postId": 123, "commentText": "è¿™å¤ªæœ‰è¶£äº†ï¼"}]'
            -   **æ–¹å¼2 (å¤šæ¡æ–‡å­—)**: '[{"type": "qzone_comment", "name": "è§’è‰²æœ¬å", "postId": 123, "comments": ["å“‡ï¼", "è¿™æ˜¯ä»€ä¹ˆï¼Ÿ", "çœ‹èµ·æ¥å¥½æ£’ï¼"]}]'
            -   **æ–¹å¼3 (è¡¨æƒ…)**: '[{"type": "qzone_comment", "name": "è§’è‰²æœ¬å", "postId": 456, "stickerUrl": "https://...è¡¨æƒ…URL...", "stickerMeaning": "è¿™ä¸ªè¡¨æƒ…çš„æ„æ€ï¼Œæ¯”å¦‚'å¼€å¿ƒ'"}]'
            -   **æ–¹å¼4 (å›å¤è¯„è®º)**: '[{"type": "qzone_comment", "name": "è§’è‰²æœ¬å", "postId": 123, "replyTo": "è¢«å›å¤è€…çš„æœ¬å", "commentText": "ä½ çš„å›å¤å†…å®¹ã€‚è¯·æ³¨æ„ï¼šåœ¨commentTextä¸­å¦‚æœè¦@å¯¹æ–¹ï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨@[[è¢«å›å¤è€…çš„æœ¬å]]è¿™ç§ç‰¹æ®Šæ ¼å¼ï¼Œç¨‹åºä¼šè‡ªåŠ¨å°†å…¶æ›¿æ¢ä¸ºæ­£ç¡®çš„æ˜µç§°ã€‚"}]'
        -   **ç‚¹èµ**: '[{"type": "qzone_like", "postId": 456}]'
        -   **æ‰“è§†é¢‘**: '[{"type": "video_call_request"}]'
        -   **æ›´æ¢å¤´åƒ**: '{"type": "change_avatar", "name": "å¤´åƒå"}' (å¤´åƒåå¿…é¡»ä»ä¸‹é¢çš„â€œå¯ç”¨å¤´åƒåˆ—è¡¨â€ä¸­é€‰æ‹©)
        -   **åˆ é™¤åŠ¨æ€**: '{"type": "qzone_delete_post", "postId": (è¦åˆ é™¤çš„ã€ä½ è‡ªå·±çš„åŠ¨æ€ID)}'
        ${contentTabooPrompt}
        ${myPostsContext} 
        # ä¾›ä½ å†³ç­–çš„å‚è€ƒä¿¡æ¯ï¼š
        -   **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
        ${worldBookContent}
        ${linkedMemoryContext}
        ${chat.settings.enableTimePerception ? `-   **å½“å‰æ—¶é—´**: ${now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' })}` : ''}
        ${chat.settings.enableTimePerception ? `-   **å¯¹è¯çŠ¶æ€**: ${timeContextText}` : ''}
        -   **ä½ ä»¬æœ€åçš„å¯¹è¯æ‘˜è¦**: ${recentContextSummary}
        ${dynamicContext}`;
    // æ­¥éª¤ 3: ã€ã€ã€è¿™å°±æ˜¯æœ€å…³é”®çš„ä¿®å¤ï¼ã€‘ã€‘ã€‘
    // æˆ‘ä»¬ç°åœ¨ä¸ä»…å‘é€ System Promptï¼Œè¿˜æŠŠæœ€è¿‘çš„10æ¡åŸå§‹å¯¹è¯è®°å½•ä¹Ÿä¸€å¹¶å‘é€è¿‡å»ï¼
    // è¿™ä¸ä¸»èŠå¤©å‡½æ•° triggerAiResponse çš„é€»è¾‘ä¿æŒäº†ä¸€è‡´ã€‚
    const messagesPayload = [
        { role: 'system', content: systemPrompt },
        // å°†åŸå§‹çš„ã€æœªè¢«æ‘˜è¦çš„ recentHistory è½¬æ¢ä¸ºAPIèƒ½ç†è§£çš„æ ¼å¼
        ...recentHistory.map(msg => {
            const sender = msg.role === 'user' ? userNickname : chat.name;
            let content = msg.content;
            if (typeof content !== 'string') {
                content = JSON.stringify(content); // ç¡®ä¿å†…å®¹æ˜¯å­—ç¬¦ä¸²
            }
            return {
                role: msg.role,
                content: `${sender}: ${content}`
            };
        })
    ];
          
          try {
                const messagesPayload = [
                    { role: 'user', content: `${systemPrompt}\n\n[ç³»ç»ŸæŒ‡ä»¤ï¼šè¯·æ ¹æ®ä½ åœ¨ä¸Šé¢è¯»åˆ°çš„è§„åˆ™å’Œä»¥ä¸‹æœ€æ–°ä¿¡æ¯ï¼Œå¼€å§‹ä½ çš„ç‹¬ç«‹è¡ŒåŠ¨ã€‚]\n${dynamicContext}` }
                ];
        
                console.log(`æ­£åœ¨ä¸ºåå°æ´»åŠ¨å‘é€APIè¯·æ±‚ ("${chat.name}")`);
        
                let  isGemini = proxyUrl === GEMINI_API_URL;
                let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesPayload);
        // æ­¥éª¤ 4: (ä¿æŒä¸å˜) å‘é€APIè¯·æ±‚ï¼Œä½†ç°åœ¨å®ƒåŒ…å«äº†æ›´ä¸°å¯Œçš„ä¸Šä¸‹æ–‡
        const response = isGemini ?
            await fetch(geminiConfig.url, geminiConfig.data) :
            await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    // ã€ã€ã€æ ¸å¿ƒä¿®å¤ã€‘ã€‘ã€‘åœ¨è¿™é‡Œä½¿ç”¨æˆ‘ä»¬æ–°æ„å»ºçš„ã€åŒ…å«å®Œæ•´å†å²çš„ messagesPayload
                    messages: messagesPayload,
                    temperature: 0.9,
                })
            });
        
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${JSON.stringify(errorData)}`);
                }
                const data = await response.json();
        
                const aiResponseContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        
                if (!aiResponseContent || aiResponseContent.trim() === '') {
                     console.warn(`APIä¸ºç©ºå›ï¼Œè§’è‰² "${chat.name}" çš„æœ¬æ¬¡åå°æ´»åŠ¨è·³è¿‡ã€‚`);
                     return;
                }
        
                const responseArray = parseAiResponse(aiResponseContent);
        
                if (!responseArray || responseArray.length === 0) {
                     console.warn(`APIæ ¼å¼ä¸æ­£ç¡®ï¼Œè§’è‰² "${chat.name}" çš„æœ¬æ¬¡åå°æ´»åŠ¨è·³è¿‡ã€‚åŸå§‹å›å¤:`, aiResponseContent);
                     return;
                }
                let actionTimestamp = Date.now();
                
                let hasSentNotification = false;
// This is the new, fixed code block
const processedActions = [];
for (const action of responseArray) {
    const contentStr = String(action.content || ''); // Ensure content is a string
    // Check if the content is a raw HTML block
    const isRawHtml = contentStr.trim().startsWith('<') && contentStr.trim().endsWith('>');

    // **CORE FIX**: Only split the message if it has newlines AND it's NOT raw HTML
    if (action.type === 'text' && !isRawHtml && contentStr.includes('\n')) {
        const lines = contentStr.split(/\n+/).filter(line => line.trim());
        lines.forEach(line => {
            processedActions.push({ ...action, content: line });
        });
    } else {
        // If it's HTML or a single-line message, push it as-is
        processedActions.push(action);
    }
}
        for (const action of processedActions) {
                    chat.lastActionType = action.type;
                    chat.lastActionTimestamp = actionTimestamp;
                    
                    let aiMessage = null;
                    const baseMessage = { role: 'assistant', senderName: chat.originalName, timestamp: actionTimestamp++ };
        
                    switch (action.type) {
                        case 'qzone_delete_post': {
            const postIdToDelete = parseInt(action.postId);
            const postToDelete = await db.qzonePosts.get(postIdToDelete);
            if (postToDelete && postToDelete.authorId === chatId) {
                await db.qzonePosts.update(postIdToDelete, { isDeleted: true });
                
                if (document.getElementById('qzone-screen').classList.contains('active')) {
                    renderQzonePosts();
                }
                const systemMessage = {
                    role: 'system',
                    type: 'post_deleted_notice',
                    content: `[${chat.name} åˆ é™¤äº†è‡ªå·±çš„ä¸€æ¡åŠ¨æ€]`,
                    postId: postIdToDelete,
                    timestamp: actionTimestamp++
                };
                chat.history.push(systemMessage);
                
                if (isViewingThisChat) {
                    appendMessage(systemMessage, chat);
                } else {
                    chat.unreadCount = (chat.unreadCount || 0) + 1;
                    showNotification(chatId, `[${chat.name} åˆ é™¤äº†è‡ªå·±çš„ä¸€æ¡åŠ¨æ€]`);
                    hasSentNotification = true;
                }
            } else {
                console.warn(`AI "${chat.name}" å°è¯•åˆ é™¤ä¸€ä¸ªä¸å­˜åœ¨æˆ–ä¸å±äºè‡ªå·±çš„åŠ¨æ€ (ID: ${action.postId})`);
            }
            continue;
        }
                        case 'text':
                            aiMessage = { ...baseMessage, content: action.content };
                            break;
                        case 'ai_image':
                            aiMessage = {
                                ...baseMessage,
                                type: 'ai_image',
                                content: action.description 
                            };
                            break;
                        case 'update_status':
                            chat.status.text = action.status_text;
                            chat.status.isBusy = action.is_busy || false;
                            chat.status.lastUpdate = Date.now();
                            break; 
                        case 'qzone_post':
                            const newPost = { 
                                type: action.postType, 
                                content: action.content || '', 
                                publicText: action.publicText || '', 
                                hiddenContent: action.hiddenContent || '', 
    image_prompt: action.image_prompt || '', // <-- æ–°å¢è¿™ä¸€è¡Œ
                                timestamp: Date.now(), 
                                authorId: chatId, 
                                authorOriginalName: chat.originalName,
                                authorGroupId: chat.groupId,
                                visibleGroupIds: null 
                            };
                            await db.qzonePosts.add(newPost);
                            updateUnreadIndicator(unreadPostsCount + 1);
                            console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" å‘å¸ƒäº†åŠ¨æ€`);
                            break;
                        case 'repost':
                            const originalPost = await db.qzonePosts.get(parseInt(action.postId));
                            if (originalPost) {
                                const newRepost = {
                                    type: 'repost',
                                    timestamp: Date.now(),
                                    authorId: chatId,
                                    authorGroupId: chat.groupId,
                                    authorOriginalName: chat.originalName,
                                    repostComment: action.comment || '',
                                    originalPost: originalPost,
                                    visibleGroupIds: null
                                };
                                await db.qzonePosts.add(newRepost);
                                updateUnreadIndicator(unreadPostsCount + 1);
                                console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" è½¬å‘äº†åŠ¨æ€ #${action.postId}`);
                            }
                            break;
                        case 'qzone_like':
                            const postToLike = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToLike) {
                                if (!postToLike.likes) postToLike.likes = [];
                                if (!postToLike.likes.includes(chat.originalName)) {
                                    postToLike.likes.push(chat.originalName);
                                    await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                                    updateUnreadIndicator(unreadPostsCount + 1);
                                    console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" ç‚¹èµäº†åŠ¨æ€ #${action.postId}`);
                                }
                            }
                            break;
                        case 'qzone_comment':
                            const postToComment = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToComment) {
                                if (!postToComment.comments) postToComment.comments = [];
                                
                                const commenterName = action.name || chat.originalName;
        
                                const createCommentObject = (text, meaning = null, replyTo = null) => ({
                                    commenterName,
                                    text: processMentions(text, chat),
                                    meaning,
                                    replyTo,
                                    timestamp: Date.now()
                                });
        
                                if (action.stickerUrl && action.stickerMeaning) {
                                    postToComment.comments.push(createCommentObject(action.stickerUrl, action.stickerMeaning, action.replyTo || null));
                                } else if (Array.isArray(action.comments)) {
                                    action.comments.forEach(commentText => {
                                        if (typeof commentText === 'string' && commentText.trim()) {
                                            postToComment.comments.push(createCommentObject(commentText, null, action.replyTo || null));
                                        }
                                    });
                                } else if (typeof action.commentText === 'string' && action.commentText.trim()) {
                                    postToComment.comments.push(createCommentObject(action.commentText, null, action.replyTo || null));
                                }
                                
                                await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                                updateUnreadIndicator(unreadPostsCount + 1);
                                console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" è¯„è®ºäº†åŠ¨æ€ #${action.postId}`);
        
                                if (!chat.commentCooldowns) chat.commentCooldowns = {};
                                chat.commentCooldowns[action.postId] = Date.now();
                            }
                            break;
                        case 'video_call_request':
                            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                                videoCallState.isAwaitingResponse = true;
                                videoCallState.activeChatId = chatId;
                                videoCallState.isGroupCall = false;
                                videoCallState.callRequester = chat.name;
                                showIncomingCallModal();
                            }
                            break;
                        default:
                            console.warn(`è§’è‰² "${chat.name}" å°è¯•æ‰§è¡ŒæœªçŸ¥çš„åå°åŠ¨ä½œ:`, action.type);
                            break;
        // åœ¨ case 'video_call_request': { ... } çš„æ­£ä¸‹æ–¹ç²˜è´´
        
        // â–¼â–¼â–¼ ã€è¿™æ˜¯æ‚¨ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ä»£ç ï¼Œè¯·ç²˜è´´åœ¨è¿™é‡Œã€‘ â–¼â–¼â–¼
        case 'change_avatar': {
            const avatarNameFromAction = action.name;
            const foundAvatarFromAction = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarNameFromAction);
            if (foundAvatarFromAction) {
                chat.settings.aiAvatar = foundAvatarFromAction.url;
                
                // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨åå°æ›´æ–°å®Œè‡ªå·±çš„å¤´åƒåï¼Œç«‹åˆ»è°ƒç”¨åŒæ­¥å‡½æ•°ï¼
                await syncCharacterAvatarInGroups(chat);
        
                visibleSystemMessage = { content: `[${chat.name} æ›´æ¢äº†å¤´åƒ]` };
                console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" æ›´æ¢äº†å¤´åƒ`);
            }
            break;
        }
        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
                    }
        
        
                    if (aiMessage) {
                        chat.history.push(aiMessage);
                        chat.unreadCount = (chat.unreadCount || 0) + 1;
                        if (!hasSentNotification) {
                            let notificationText = aiMessage.type === 'ai_image' ? '[å›¾ç‰‡]' : (aiMessage.content || '');
                            showNotification(chatId, notificationText);
                            hasSentNotification = true;
                        }
                    }
                }
                await db.chats.put(chat);
                
            } catch (error) {
                console.error(`è§’è‰² "${chat.name}" çš„ç‹¬ç«‹è¡ŒåŠ¨å¤±è´¥:`, error);
            } finally {
                setAvatarActingState(chatId, false);
                renderChatList();
                if (document.getElementById('qzone-screen').classList.contains('active')) {
                    renderQzonePosts();
                }
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        
        
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ triggerGroupAiAction å‡½æ•° â–¼â–¼â–¼
        async function triggerGroupAiAction(chatId) {
            const chat = state.chats[chatId];
            if (!chat || !chat.isGroup) return;
        
            // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹1ï¼šä»ç¾¤èŠè®¾ç½®ä¸­è¯»å–å†·å´æ—¶é—´ã€‘ã€‘ã€‘
            const groupActionCooldownMinutes = chat.settings.actionCooldownMinutes || 10;
        
            if (chat.lastActionTimestamp) {
                const minutesSinceLastAction = (Date.now() - chat.lastActionTimestamp) / (1000 * 60);
                // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹2ï¼šä½¿ç”¨æ–°çš„å˜é‡è¿›è¡Œåˆ¤æ–­ã€‘ã€‘ã€‘
                if (minutesSinceLastAction < groupActionCooldownMinutes) {
                    console.log(`ç¾¤èŠ "${chat.name}" å¤„äºè¡ŒåŠ¨å†·å´ä¸­ï¼Œæœ¬æ¬¡ç‹¬ç«‹è¡ŒåŠ¨è·³è¿‡ã€‚`);
                    return;
                }
            }
            
            
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;
        
            const myNickname = chat.settings.myNickname || 'æˆ‘';
            const now = new Date();
            
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤å¼€å§‹ â˜…â˜…â˜…
            let systemPrompt;
            
            // 1. æ£€æŸ¥æœ€è¿‘çš„æ¶ˆæ¯ï¼Œçœ‹æ˜¯å¦æœ‰æœªé¢†å®Œçš„çº¢åŒ…
            const recentHistory = chat.history.filter(m => !m.isHidden).slice(-5); // æ£€æŸ¥æœ€è¿‘5æ¡
            const unclaimedPacket = recentHistory.find(m => m.type === 'red_packet' && !m.isFullyClaimed);
        
            // 2. å¦‚æœæ‰¾åˆ°äº†æœªé¢†å®Œçš„çº¢åŒ…ï¼Œå°±ç”Ÿæˆä¸€ä¸ªä¸“é—¨çš„â€œæŠ¢çº¢åŒ…â€æŒ‡ä»¤
            if (unclaimedPacket) {
                const senderDisplayName = getDisplayNameInGroup(chat, unclaimedPacket.senderName);
                console.log(`æ£€æµ‹åˆ°ç¾¤èŠ "${chat.name}" ä¸­æœ‰æœªé¢†å®Œçš„çº¢åŒ…ï¼Œæ­£åœ¨ç”ŸæˆæŠ¢çº¢åŒ…æŒ‡ä»¤...`);
                
                systemPrompt = `
        # ä½ çš„ã€ã€ã€æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‘ã€‘ã€‘
        ç¾¤èŠä¸­åˆšåˆšå‡ºç°äº†ä¸€ä¸ªç”±â€œ${senderDisplayName}â€å‘é€çš„ã€å°šæœªé¢†å®Œçš„çº¢åŒ…ï¼ˆæ—¶é—´æˆ³: ${unclaimedPacket.timestamp}ï¼‰ã€‚
        ä½ çš„ä»»åŠ¡æ˜¯ï¼šé€‰æ‹©ã€ä¸€ä¸ªæˆ–å¤šä¸ªã€‘ç¬¦åˆäººè®¾çš„è§’è‰²ï¼Œè®©ä»–ä»¬ã€ç«‹åˆ»ã€‘ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤å»å°è¯•é¢†å–è¿™ä¸ªçº¢åŒ…ã€‚
        # æŒ‡ä»¤æ ¼å¼
        ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
        '[{"type": "open_red_packet", "name": "è§’è‰²æœ¬å", "packet_timestamp": ${unclaimedPacket.timestamp}}]'
        
        ä½ å¯ä»¥è®©å¤šä¸ªè§’è‰²åŒæ—¶å°è¯•ï¼Œåªéœ€åœ¨è¿”å›çš„JSONæ•°ç»„ä¸­åŒ…å«å¤šä¸ªè¿™æ ·çš„å¯¹è±¡å³å¯ã€‚
        ç°åœ¨ï¼Œè¯·ç«‹å³æ‰§è¡ŒæŠ¢çº¢åŒ…æ“ä½œï¼
        `;
            } else {
                // 3. å¦‚æœæ²¡æœ‰çº¢åŒ…äº‹ä»¶ï¼Œæ‰æ‰§è¡ŒåŸæ¥çš„é€šç”¨èŠå¤©é€»è¾‘
                let timeContextText = '';
                const chinaTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (3600000 * 8));
                const currentTime = chinaTime.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', dateStyle: 'full', timeStyle: 'short' });

                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªæœ‰å½“æ—¶é—´æ„ŸçŸ¥å¼€å¯æ—¶ï¼Œæ‰è®¡ç®—æ—¶é—´å·®
                if (chat.settings.enableTimePerception) {
                    const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];
                    if (lastMessage) {
                        const lastTime = new Date(lastMessage.timestamp);
                        const diffMinutes = (now - lastTime) / (1000 * 60);
                        if (diffMinutes > 60) {
                            timeContextText = `ç¾¤é‡Œå·²ç»å®‰é™äº† ${Math.round(diffMinutes / 60)} å°æ—¶äº†ã€‚`;
                        } else {
                            timeContextText = `ç¾¤é‡Œåœ¨${Math.floor(diffMinutes)}åˆ†é’Ÿå‰æœ‰äººèŠè¿‡ã€‚`;
                        }
                    } else {
                        timeContextText = "ç¾¤é‡Œè¿˜æ²¡æœ‰ä»»ä½•æ¶ˆæ¯ã€‚";
                    }
                }
                let recentContextSummary = "ä½ ä»¬æœ€è¿‘æ²¡æœ‰æœ‰æ•ˆèŠå¤©è®°å½•ã€‚";
                const selfMemoryCount = 10;
                const recentHistory = chat.history.filter(m => !m.isHidden).slice(-selfMemoryCount);
                if (recentHistory.length > 0) {
                    recentContextSummary = "è¿™æ˜¯ä½ ä»¬æœ€è¿‘çš„å¯¹è¯ï¼š\n" + recentHistory.map(msg => {
                        const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
                        const content = String(msg.content || msg.message || '').substring(0, 50);
                        return `${sender}: ${content}...`;
                    }).join('\n');
                }
        
                const membersList = chat.members.map(m => `- **${m.groupNickname}** (æœ¬å: ${m.originalName}): ${m.persona}`).join('\n');
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡Œæ„å»ºè·¨è§’è‰²çš„é•¿æœŸè®°å¿†ä¸Šä¸‹æ–‡ (å’Œ triggerAiResponse ä¸€æ ·) â–¼â–¼â–¼
        let longTermMemoryContext = '# é•¿æœŸè®°å¿† (æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¿™æ˜¯ç¾¤å†…å·²ç»ç¡®ç«‹çš„äº‹å®ï¼Œæ‰€æœ‰è§’è‰²å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n';
        let collectedMemories = false;
        
        chat.members.forEach(member => {
            const memberChat = state.chats[member.id];
            if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
                longTermMemoryContext += `\n## --- å…³äºâ€œ${member.groupNickname}â€çš„è®°å¿† ---\n`;
                longTermMemoryContext += memberChat.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
                collectedMemories = true;
            }
        });

        if (!collectedMemories) {
            longTermMemoryContext += '- (æš‚æ— )';
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ triggerGroupAiAction å‡½æ•°ä¸­ï¼Œç”¨ä¸‹é¢è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ä¸–ç•Œä¹¦å¤„ç†é€»è¾‘ â–¼â–¼â–¼
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';

                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œä¹ŸåŠ å…¥è¿‡æ»¤é€»è¾‘
                const formattedEntries = worldBook.content
                    .filter(entry => entry.enabled !== false) // åªè¯»å–å¯ç”¨çš„æ¡ç›®
                    .map(entry => {
                        let entryString = `\n### æ¡ç›®: ${entry.comment || 'æ— å¤‡æ³¨'}\n`;
                        if (entry.keys.length > 0) {
                            entryString += `**å…³é”®è¯:** ${entry.keys.join(', ')}\n`;
                        }
                        entryString += `**å†…å®¹:**\n${entry.content}`;
                        return entryString;
                    }).join('');

                return formattedEntries ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ç¾¤å†…æ‰€æœ‰è§’è‰²éƒ½å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
                let linkedMemoryContext = '';
                const memoryCount = chat.settings.linkedMemoryCount || 10;
                if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                    const linkedChatsWithTimestamps = chat.settings.linkedMemoryChatIds.map(id => {
                        const linkedChat = state.chats[id];
                        if (!linkedChat) return null;
                        const lastMsg = linkedChat.history.slice(-1)[0];
                        return {
                            chat: linkedChat,
                            latestTimestamp: lastMsg ? lastMsg.timestamp : 0
                        };
                    }).filter(Boolean); 
        
                    linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
                    linkedMemoryContext += `\n\n# å‚è€ƒè®°å¿† (è‡³å…³é‡è¦ï¼ç¾¤å†…è§’è‰²å¿…é¡»ã€ä¸»åŠ¨ã€‘å°†è¿™äº›å‚è€ƒè®°å¿†ä¸­çš„ã€å…³é”®ä¿¡æ¯å’Œäº‹ä»¶ã€‘ï¼Œè‡ªç„¶åœ°èå…¥åˆ°å½“å‰çš„å¯¹è¯ä¸­ï¼Œä»¥ä½“ç°ä½ ä»¬æ‹¥æœ‰å®Œæ•´çš„å…±åŒè®°å¿†ã€‚)\n`;
                    for (const item of linkedChatsWithTimestamps) {
                        const linkedChat = item.chat;
                        const prefix = linkedChat.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]';
                        const timeAgo = item.latestTimestamp > 0 ? ` (æœ€åäº’åŠ¨äº ${formatTimeAgo(item.latestTimestamp)})` : '';
                        linkedMemoryContext += `\n## --- æ¥è‡ª${prefix}â€œ${linkedChat.name}â€çš„å‚è€ƒè®°å¿†${timeAgo} ---\n`;
                        const recentHistory = linkedChat.history.slice(-memoryCount);
                        const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('å·²è¢«ç”¨æˆ·åˆ é™¤'));
                        if (filteredHistory.length > 0) {
                            filteredHistory.forEach(msg => {
                                const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'æˆ‘') : (msg.senderName || linkedChat.name);
                                let contentText = String(msg.content);
                                if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                    contentText = `[å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š${msg.content}]`;
                                } else if (msg.type === 'voice_message') {
                                    contentText = `[å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š${msg.content}]`;
                                }
                                linkedMemoryContext += `${sender}: ${contentText}\n`;
                            });
                        } else {
                            linkedMemoryContext += "(æš‚æ— æœ‰æ•ˆèŠå¤©è®°å½•)\n";
                        }
                    }
                }
                const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
                let dynamicContext = "";
                
                const visiblePostsForGroup = new Set();
                for (const member of chat.members) {
                    const memberChat = state.chats[member.id];
                    if (memberChat) {
                        const visibleForMember = filterVisiblePostsForAI(allRecentPosts, memberChat);
                        visibleForMember.forEach(post => visiblePostsForGroup.add(post));
                    }
                }
        
                const groupMemberNames = new Set(chat.members.map(m => m.originalName));
                const unInteractedPostsForGroup = [...visiblePostsForGroup].filter(post => {
                    const hasBeenLikedByGroup = post.likes && post.likes.some(likerName => groupMemberNames.has(likerName));
                    const hasBeenCommentedByGroup = post.comments && post.comments.some(comment => typeof comment === 'object' && groupMemberNames.has(comment.commenterName));
                    return !hasBeenLikedByGroup && !hasBeenCommentedByGroup;
                });
                
                if (unInteractedPostsForGroup.length > 0) {
                    let postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ç¾¤å†…è§’è‰²å‚è€ƒå’Œè¯„è®º):\n";
                    for (const post of unInteractedPostsForGroup) {
                        let authorName = post.authorId === 'user' ? myNickname : (state.chats[post.authorId]?.name || 'ä¸€ä½æœ‹å‹');
                        let contentSummary;
                        if (post.type === 'repost') {
                            const repostComment = post.repostComment ? `å¹¶è¯„è®ºè¯´ï¼šâ€œ${post.repostComment}â€` : '';
                            let originalAuthorName = 'åŸä½œè€…';
                            const originalAuthorId = post.originalPost.authorId;
                            if (originalAuthorId === 'user') {
                                originalAuthorName = state.qzoneSettings.nickname;
                            } else if (state.chats[originalAuthorId]) {
                                originalAuthorName = state.chats[originalAuthorId].name;
                            }
                            let originalContentSummary;
                            const originalPost = post.originalPost;
                            if (originalPost.type === 'text_image') {
                                originalContentSummary = `[æ–‡å­—å›¾] ${originalPost.publicText || ''} (å›¾ç‰‡æè¿°: â€œ${(originalPost.hiddenContent || '').substring(0, 40)}...â€)`;
                            } else if (originalPost.type === 'image_post') {
                                originalContentSummary = `[å›¾ç‰‡] ${originalPost.publicText || ''} (å›¾ç‰‡æè¿°: â€œ${(originalPost.imageDescription || '').substring(0, 40)}...â€)`;
                            } else { // 'shuoshuo'
                                originalContentSummary = `â€œ${(originalPost.content || '').substring(0, 40)}...â€`;
                            }
                            contentSummary = `è½¬å‘äº† @${originalAuthorName} çš„åŠ¨æ€ ${repostComment}ã€åŸåŠ¨æ€å†…å®¹: ${originalContentSummary}ã€‘`;
                        } else if (post.type === 'text_image') {
                            contentSummary = `[ä¸€å¼ å›¾ç‰‡ï¼Œå…¶éšè—æ–‡å­—ä¸ºï¼šâ€œ${post.hiddenContent}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                        } else if (post.type === 'image_post') {
                            contentSummary = `[ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼šâ€œ${post.imageDescription}â€] ${post.publicText || ''}`.substring(0, 50) + '...';
                        } else {
                            contentSummary = (post.publicText || post.content || "ä¸€æ¡åŠ¨æ€").substring(0, 50) + '...';
                        }
                        postsContext += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${contentSummary}"\n`;
                        if (post.comments && post.comments.length > 0) {
                            for (const comment of post.comments) {
                                if (typeof comment === 'object' && comment.commenterName) {
                                    const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                                    let commentText = comment.meaning ? `[è¡¨æƒ…: '${comment.meaning}']` : comment.text;
                                    postsContext += `  - è¯„è®º: ${commenterDisplayName} (æœ¬å: ${comment.commenterName}): ${commentText}\n`;
                                }
                            }
                        }
                    }
                    dynamicContext = postsContext;
                }
        
                systemPrompt = `
        # ä½ çš„ä»»åŠ¡
        ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAIå¯¼æ¼”ã€‚ä½ ç°åœ¨æ§åˆ¶ç€ä¸€ä¸ªåä¸ºâ€œ${chat.name}â€çš„ç¾¤èŠã€‚
        ${chat.settings.enableTimePerception ? `å½“å‰æ—¶é—´æ˜¯ ${currentTime}ã€‚` : ''}
        ${timeContextText ? `${timeContextText} ` : ''}ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç¾¤æˆå‘˜çš„æ€§æ ¼ã€ä¸–ç•Œè§‚ã€å‚è€ƒè®°å¿†ã€æœ€è¿‘çš„åŠ¨æ€å’Œå½“å‰æƒ…æ™¯ï¼Œã€é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²ã€‘ï¼Œè®©ä»–ä»¬ä¸»åŠ¨å‘èµ·ä¸€æ®µå¯¹è¯ï¼Œæ‰“ç ´æ²‰é»˜ï¼Œè®©ç¾¤èŠé‡æ–°æ´»è·ƒèµ·æ¥ã€‚
# ã€äº¤äº’é“å¾‹ï¼šè§’è‰²é—´å¿…é¡»äº’åŠ¨ï¼ã€‘
1.  ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯**å¯¼æ¼”ä¸€åœºç”ŸåŠ¨çš„ç¾¤èŠ**ï¼Œè€Œä¸ä»…ä»…æ˜¯è®©è§’è‰²è½®æµå‘è¨€ã€‚
2.  å½“æœ‰å¤šä¸ªè§’è‰²åœ¨åŒä¸€è½®å‘è¨€æ—¶ï¼Œä»–ä»¬çš„å¯¹è¯ã€å¿…é¡»ã€‘æœ‰é€»è¾‘ä¸Šçš„å‰åå…³è”ã€‚åé¢çš„è§’è‰²åº”è¯¥**å›åº”ã€åé©³ã€æˆ–è¡¥å……**å‰é¢è§’è‰²çš„å‘è¨€ã€‚
3.  æ¨¡æ‹ŸçœŸå®çš„èŠå¤©èŠ‚å¥ã€‚å¯ä»¥æ˜¯ä¸€ä¸ªè§’è‰²æå‡ºé—®é¢˜ï¼Œå¦ä¸€ä¸ªè§’è‰²ç«‹åˆ»å›ç­”ï¼›æˆ–è€…ä¸€ä¸ªè§’è‰²å¼€ç©ç¬‘ï¼Œå¦ä¸€ä¸ªè§’è‰²åæ§½ã€‚
4.  ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆå‡ æ®µæ¯«æ— å…³è”çš„ç‹¬ç™½ã€‚è¿™ä¼šè®©å¯¹è¯æ˜¾å¾—éå¸¸æœºæ¢°å’Œä¸çœŸå®ã€‚        
${longTermMemoryContext}
        
        # æ ¸å¿ƒè§„åˆ™
        ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªè¡ŒåŠ¨å¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡çš„ "name" å­—æ®µã€å¿…é¡»ã€‘æ˜¯è§’è‰²çš„ã€æœ¬åã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ "name" å­—æ®µä¸º "${myNickname}" çš„æ¶ˆæ¯ã€‚ä¸¥æ ¼éµå®ˆæ¯ä¸ªè§’è‰²çš„è®¾å®šï¼Œç¦æ­¢å‡ºæˆã€‚
        
        # ä½ çš„å¯é€‰è¡ŒåŠ¨æŒ‡ä»¤:
        -   **å‘é€æ–‡æœ¬**: '{"type": "text", "name": "è§’è‰²æœ¬å", "content": "æ–‡æœ¬å†…å®¹"}'
        -   **å‘é€è¡¨æƒ…**: '{"type": "sticker", "name": "è§’è‰²æœ¬å", "url": "...", "meaning": "..."}'
        -   **å‘é€å›¾ç‰‡**: '{"type": "ai_image", "name": "è§’è‰²æœ¬å", "description": "å›¾ç‰‡çš„è¯¦ç»†ã€ä¸­æ–‡ã€‘æè¿°", "image_prompt": "å›¾ç‰‡çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, ç”¨%20åˆ†éš”, é£æ ¼ä¸ºé£æ™¯/åŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"}'
        -   **å‘èµ·æŠ•ç¥¨**: '{"type": "poll", "name": "è§’è‰²æœ¬å", "question": "...", "options": "..."}'
        -   **å‘èµ·ç¾¤è§†é¢‘**: '{"type": "group_call_request", "name": "è§’è‰²æœ¬å"}'
        -å¦‚ä½•æ­£ç¡®ä½¿ç”¨â€œå¼•ç”¨å›å¤â€åŠŸèƒ½ï¼š
- å½“ä½ æƒ³æ˜ç¡®åœ°é’ˆå¯¹ç¾¤å†…ã€ä»»ä½•æˆå‘˜ã€‘ï¼ˆåŒ…æ‹¬ç”¨æˆ·æˆ–å…¶ä»–AIè§’è‰²ï¼‰ä¹‹å‰çš„æŸä¸€å¥å…·ä½“çš„è¯è¿›è¡Œå›å¤æ—¶ï¼Œä½ å°±åº”è¯¥ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ã€‚
- è¿™ä¼šè®©ä½ çš„å›å¤ä¸Šæ–¹å‡ºç°ä¸€ä¸ªç°è‰²çš„å°æ¡†ï¼Œé‡Œé¢æ˜¯è¢«ä½ å¼•ç”¨çš„é‚£å¥è¯ï¼Œè¿™æ ·å¯¹è¯å°±ä¸ä¼šä¹±äº†ã€‚
- æŒ‡ä»¤æ ¼å¼: '{"type": "quote_reply", "target_timestamp": (ä½ æƒ³å¼•ç”¨çš„é‚£å¥è¯çš„æ—¶é—´æˆ³), "reply_content": "ä½ çš„å›å¤å†…å®¹"}'
        # é•¿æœŸè®°å¿† (æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¿™æ˜¯ç¾¤å†…å·²ç»ç¡®ç«‹çš„äº‹å®ï¼Œæ‰€æœ‰è§’è‰²å¿…é¡»ä¸¥æ ¼éµå®ˆ)
        ${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (æš‚æ— )'}
        # å½“å‰ç¾¤èŠä¿¡æ¯
        - **ç¾¤åç§°**: ${chat.name}
        ${worldBookContent}
       
        ${linkedMemoryContext}
        
        # ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾
        ${membersList}
        
        # ç”¨æˆ·çš„è§’è‰²
        - **${myNickname}**: ${chat.settings.myPersona}
        
        # æœ€è¿‘çš„å¯¹è¯æ‘˜è¦ (ä¾›ä½ å‚è€ƒ)
        ${recentContextSummary}
        
        # æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º)
        ${dynamicContext}
        
        ç°åœ¨ï¼Œè¯·å¼€å§‹ä½ çš„å¯¼æ¼”å·¥ä½œï¼Œè®©ç¾¤èŠå†æ¬¡çƒ­é—¹èµ·æ¥å§ï¼
        `;
            }
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ç»“æŸ â˜…â˜…â˜…
    // ==========================================================
    //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ä»è¿™é‡Œå¼€å§‹ â˜…â˜…â˜…
    // ==========================================================
    
    // æ­¥éª¤ 1: ã€å…¨æ–°ã€‘æ„å»ºåŒ…å«å®Œæ•´åŸå§‹èŠå¤©è®°å½•çš„ messagesPayload
    const recentHistoryForPayload = chat.history.filter(m => !m.isHidden).slice(-10);
    const messagesPayload = [
        { role: 'system', content: systemPrompt },
        // å°†åŸå§‹çš„ã€æœªè¢«æ‘˜è¦çš„ recentHistory è½¬æ¢ä¸ºAPIèƒ½ç†è§£çš„æ ¼å¼
        ...recentHistoryForPayload.map(msg => {
            const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
            let content = msg.content;
            // å°†æ‰€æœ‰å¤æ‚æ¶ˆæ¯ç±»å‹éƒ½è½¬æ¢ä¸ºçº¯æ–‡æœ¬æè¿°ï¼Œè®©AIèƒ½è¯»æ‡‚
            if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                content = `[å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°ä¸ºï¼š'${msg.content}']`;
            } else if (msg.type === 'voice_message') {
                content = `[å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`;
            } else if (typeof content !== 'string') {
                content = '[å‘é€äº†ä¸€æ¡å¤æ‚æ¶ˆæ¯ï¼Œå¦‚å¡ç‰‡æˆ–è½¬è´¦]';
            }

            return {
                role: 'user', // å…¨éƒ¨æ¨¡æ‹Ÿæˆ user è§’è‰²ï¼Œè®©AIæ›´å¥½åœ°ç†è§£å¯¹è¯æµ
                content: `${sender}: ${content}`
            };
        })
    ];

            try {
                const messagesPayload = [{ role: 'user', content: systemPrompt }];
                let isGemini = proxyUrl === GEMINI_API_URL;
                let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);
        // æ­¥éª¤ 2: ã€å…¨æ–°ã€‘åœ¨ API è°ƒç”¨ä¸­ä½¿ç”¨æˆ‘ä»¬æ–°æ„å»ºçš„ã€æ›´ä¸°å¯Œçš„ messagesPayload
        const response = isGemini ? 
            await fetch(geminiConfig.url, geminiConfig.data) : 
            await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    messages: messagesPayload, // <-- ä½¿ç”¨è¿™ä¸ªæ–°å˜é‡ï¼
                    temperature: 0.9,
                })
            });
        
                if (!response.ok) throw new Error((await response.json()).error.message);
        
                const data = await response.json();
                const aiResponseContent = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
                const responseArray = parseAiResponse(aiResponseContent);
        
                if (!responseArray || responseArray.length === 0) {
                     console.warn(`ç¾¤èŠ "${chat.name}" çš„ç‹¬ç«‹è¡ŒåŠ¨APIè¿”å›ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®ï¼Œæœ¬æ¬¡è·³è¿‡ã€‚`);
                     return;
                }
                
                let actionTimestamp = Date.now();
                
                let hasPerformedMajorAction = false;
                let notificationContent = '';
                let notificationSender = '';
// This is the new, fixed code block
const processedActions = [];
for (const action of responseArray) {
    const contentStr = String(action.content || ''); // Ensure content is a string
    // Check if the content is a raw HTML block
    const isRawHtml = contentStr.trim().startsWith('<') && contentStr.trim().endsWith('>');

    // **CORE FIX**: Only split the message if it has newlines AND it's NOT raw HTML
    if (action.type === 'text' && !isRawHtml && contentStr.includes('\n')) {
        const lines = contentStr.split(/\n+/).filter(line => line.trim());
        lines.forEach(line => {
            processedActions.push({ ...action, content: line });
        });
    } else {
        // If it's HTML or a single-line message, push it as-is
        processedActions.push(action);
    }
}
        for (const action of processedActions){
                    if (!action || !action.type || !action.name) continue;
        
                    const senderDisplayName = getDisplayNameInGroup(chat, action.name);
                    let visibleSystemMessage = null;
        
                    let aiMessage = null;
                    const baseMessage = { role: 'assistant', senderName: action.name, timestamp: actionTimestamp++ };
        
                    // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šå¤„ç† open_red_packet æŒ‡ä»¤ â˜…â˜…â˜…
                    if (action.type === 'open_red_packet') {
                        const packetToOpen = chat.history.find(m => m.timestamp === action.packet_timestamp);
                        // ç¡®ä¿çº¢åŒ…å­˜åœ¨ã€æ²¡é¢†å®Œã€ä¸”è¿™ä¸ªè§’è‰²è¿˜æ²¡é¢†è¿‡
                        if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[action.name])) {
                            // (è¿™é‡Œçš„æŠ¢çº¢åŒ…é€»è¾‘å’Œç”¨æˆ·æŠ¢çº¢åŒ…çš„é€»è¾‘æ˜¯å®Œå…¨ä¸€æ ·çš„)
                            let claimedAmountAI = 0;
                            const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                            const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;
                            
                            if (remainingCount > 0) {
                                if (remainingCount === 1) { claimedAmountAI = remainingAmount; } 
                                else {
                                    const min = 0.01;
                                    const max = remainingAmount - (remainingCount - 1) * min;
                                    claimedAmountAI = Math.random() * (max - min) + min;
                                }
                                claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
                                if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
                                packetToOpen.claimedBy[action.name] = claimedAmountAI;
        
                                // åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
                                chat.history.push({
                                    role: 'system',
                                    type: 'pat_message',
                                    content: `${senderDisplayName} é¢†å–äº† ${getDisplayNameInGroup(chat, packetToOpen.senderName)} çš„çº¢åŒ…`,
                                    timestamp: Date.now()
                                });
                                
                                // åˆ›å»ºå¯¹AIéšè—çš„ã€å‘ŠçŸ¥ç»“æœçš„æ¶ˆæ¯
                                let hiddenContentForAI = `[ç³»ç»Ÿæç¤ºï¼šä½  (${senderDisplayName}) æˆåŠŸæŠ¢åˆ°äº† ${claimedAmountAI.toFixed(2)} å…ƒã€‚`;
                                if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                                    packetToOpen.isFullyClaimed = true;
                                    // å‘ŠçŸ¥çº¢åŒ…é¢†å®Œäº†
                                    chat.history.push({
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `${getDisplayNameInGroup(chat, packetToOpen.senderName)} çš„çº¢åŒ…å·²è¢«é¢†å®Œ`,
                                        timestamp: Date.now() + 1
                                    });
                                    // æ‰¾å‡ºå¹¶å‘ŠçŸ¥æ‰‹æ°”ç‹æ˜¯è°
                                    let luckyKing = { name: '', amount: -1 };
                                    Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                                        if (amount > luckyKing.amount) {
                                            luckyKing = { name, amount };
                                        }
                                    });
                                    if (luckyKing.name) {
                                         const luckyKingDisplayName = getDisplayNameInGroup(chat, luckyKing.name);
                                         hiddenContentForAI += ` çº¢åŒ…å·²è¢«é¢†å®Œï¼Œæ‰‹æ°”ç‹æ˜¯ ${luckyKingDisplayName}ï¼`;
                                    }
                                }
                                hiddenContentForAI += ' è¯·æ ¹æ®è¿™ä¸ªç»“æœå‘è¡¨ä½ çš„è¯„è®ºã€‚]';
                                chat.history.push({
                                    role: 'system',
                                    content: hiddenContentForAI,
                                    timestamp: Date.now() + 2,
                                    isHidden: true
                                });
                            }
                        }
                        hasPerformedMajorAction = true; // æ ‡è®°æœ‰é‡è¦è¡ŒåŠ¨
                        continue; // å¤„ç†å®ŒæŠ¢çº¢åŒ…åï¼Œè·³è¿‡æœ¬æ¬¡å¾ªç¯ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡tickæ¥å‘è¡¨è¯„è®º
                    }
                    // â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…
        
                    switch (action.type) {
                        case 'qzone_post':
                            const newPost = { type: action.postType || 'shuoshuo', content: action.content, timestamp: Date.now(), authorId: state.chats[Object.keys(state.chats).find(key => state.chats[key].originalName === action.name)]?.id || action.name, authorOriginalName: action.name, visibleGroupIds: null };
                            await db.qzonePosts.add(newPost);
                            updateUnreadIndicator(unreadPostsCount + 1);
                            visibleSystemMessage = { content: `[${senderDisplayName} å‘å¸ƒäº†ä¸€æ¡æ–°åŠ¨æ€]` };
                            break;
                        case 'qzone_comment':
                            const postToComment = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToComment) {
                                if (!postToComment.comments) postToComment.comments = [];
                                postToComment.comments.push({ commenterName: action.name, text: action.commentText, timestamp: Date.now() });
                                await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                                updateUnreadIndicator(unreadPostsCount + 1);
                                visibleSystemMessage = { content: `[${senderDisplayName} è¯„è®ºäº†åŠ¨æ€]` };
                            }
                            break;
                        case 'qzone_like':
                            const postToLike = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToLike) {
                                if (!postToLike.likes) postToLike.likes = [];
                                if (!postToLike.likes.includes(action.name)) {
                                    postToLike.likes.push(action.name);
                                    await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                                    updateUnreadIndicator(unreadPostsCount + 1);
                                    visibleSystemMessage = { content: `[${senderDisplayName} ç‚¹èµäº†åŠ¨æ€]` };
                                }
                            }
                            break;
                        case 'ai_image':
                            aiMessage = {
                                ...baseMessage,
                                type: 'ai_image',
                                content: action.description, 
image_prompt: msgData.image_prompt // <-- ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œè¡¥ä¸Šç¼ºå¤±çš„å…³é”®å­—æ®µ
                            };
                            break;
                        default:
                            if (action.type === 'poll') {
                                 const pollOptions = typeof action.options === 'string' 
                                    ? action.options.split('\n').filter(opt => opt.trim()) 
                                    : (Array.isArray(action.options) ? action.options : []);
                                if (pollOptions.length < 2) continue;
                                aiMessage = { ...baseMessage, ...action, options: pollOptions, votes: {}, isClosed: false };
                            } else {
                                const messageContent = action.content || action.message;
                                aiMessage = { ...baseMessage, ...action };
                                if (messageContent) aiMessage.content = messageContent;
                            }
                            break;
                    }
                    
                    if (visibleSystemMessage) {
                        chat.history.push({
                            role: 'system',
                            type: 'pat_message',
                            content: visibleSystemMessage.content,
                            timestamp: actionTimestamp++
                        });
                    } 
                    else if (aiMessage) {
                        chat.history.push(aiMessage);
                        if (!notificationSender) {
                            notificationSender = senderDisplayName;
                            notificationContent = aiMessage.type === 'ai_image' ? '[å›¾ç‰‡]' : (aiMessage.content || `[${aiMessage.type}]`);
                        }
                    }
                    hasPerformedMajorAction = true;
                }
                
                if (hasPerformedMajorAction) {
                    chat.lastActionTimestamp = Date.now();
                    chat.unreadCount = (chat.unreadCount || 0) + responseArray.filter(a => a.type !== 'qzone_post' && a.type !== 'qzone_comment' && a.type !== 'qzone_like').length;
                    if (notificationSender && notificationContent) {
                         showNotification(chatId, `${notificationSender}: ${notificationContent}`);
                    }
                    await db.chats.put(chat);
                }
        
            } catch (error) {
                console.error(`ç¾¤èŠ "${chat.name}" çš„ç‹¬ç«‹è¡ŒåŠ¨å¤±è´¥:`, error);
            } finally {
                renderChatList();
            }
        }
        
        
        
        
        
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ç»ˆæä¿®æ­£ç‰ˆã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ applyScopedCss å‡½æ•° â–¼â–¼â–¼
        
        /**
         * å°†ç”¨æˆ·è‡ªå®šä¹‰çš„CSSå®‰å…¨åœ°åº”ç”¨åˆ°æŒ‡å®šçš„ä½œç”¨åŸŸ
         * @param {string} cssString ç”¨æˆ·è¾“å…¥çš„åŸå§‹CSSå­—ç¬¦ä¸²
         * @param {string} scopeId åº”ç”¨æ ·å¼çš„ä½œç”¨åŸŸID (ä¾‹å¦‚ '#chat-messages' æˆ– '#settings-preview-area')
         * @param {string} styleTagId è¦æ“ä½œçš„ <style> æ ‡ç­¾çš„ID
         */
        function applyScopedCss(cssString, scopeId, styleTagId) {
            const styleTag = document.getElementById(styleTagId);
            if (!styleTag) return;
            
            if (!cssString || cssString.trim() === '') {
                styleTag.innerHTML = '';
                return;
            }
            
            // å¢å¼ºä½œç”¨åŸŸå¤„ç†å‡½æ•° - ä¸“é—¨è§£å†³.userå’Œ.aiæ ·å¼å†²çªé—®é¢˜
            const scopedCss = cssString
                .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId} .message-bubble.user $1`)
                .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId} .message-bubble.ai $1`)
                .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId} .message-bubble $1`);
            
            styleTag.innerHTML = scopedCss;
        }
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå·²ä¿®å¤çš„ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ updateSettingsPreview å‡½æ•° â–¼â–¼â–¼
        async function updateSettingsPreview() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            const previewArea = document.getElementById('settings-preview-area');
            if (!previewArea) return;
        
            // 1. è·å–å½“å‰è®¾ç½®çš„å€¼
            const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
            const fontSize = document.getElementById('font-size-slider').value;
            const customCss = document.getElementById('custom-css-input').value;
            const background = chat.settings.background; 
        
            // 2. æ›´æ–°é¢„è§ˆåŒºçš„åŸºæœ¬æ ·å¼
            previewArea.dataset.theme = selectedTheme;
            previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);
            
            if (background && background.startsWith('data:image')) {
                previewArea.style.backgroundImage = `url(${background})`;
                previewArea.style.backgroundColor = 'transparent';
            } else {
                previewArea.style.backgroundImage = 'none';
                previewArea.style.background = background || '#f0f2f5';
            }
        
            // 3. æ¸²æŸ“æ¨¡æ‹Ÿæ°”æ³¡
            previewArea.innerHTML = ''; 
        
            // ã€ã€ã€æ ¸å¿ƒä¿®å¤1ï¼šåœ¨è¿™é‡Œä½¿ç”¨ await ç­‰å¾…ç»“æœã€‘ã€‘ã€‘
            const aiMsg = { role: 'ai', content: 'å¯¹æ–¹æ¶ˆæ¯é¢„è§ˆ', timestamp: 1, senderName: chat.name };
            const aiBubble = await createMessageElement(aiMsg, chat); // <--- å¢åŠ äº† await
            if(aiBubble) previewArea.appendChild(aiBubble);
        
            // ã€ã€ã€æ ¸å¿ƒä¿®å¤2ï¼šåœ¨è¿™é‡Œä¹Ÿä½¿ç”¨ awaitã€‘ã€‘ã€‘
            const userMsg = { role: 'user', content: 'æˆ‘çš„æ¶ˆæ¯é¢„è§ˆ', timestamp: 2 };
            const userBubble = await createMessageElement(userMsg, chat); // <--- å¢åŠ äº† await
            if(userBubble) previewArea.appendChild(userBubble);
            
            // å®æ—¶æ›´æ–°é¢„è§ˆåŒºæ­Œè¯æ ä½ç½® (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
            const previewLyricsBar = document.createElement('div');
            previewLyricsBar.style.cssText = `
                position: absolute; 
                font-size: 11px; 
                padding: 2px 6px; 
                border-radius: 8px; 
                background-color: rgba(0, 0, 0, 0.1); 
                color: var(--text-secondary); 
                white-space: nowrap; 
                transition: all 0.3s ease;
            `;
            previewLyricsBar.textContent = 'â™ª æ­Œè¯ä½ç½®é¢„è§ˆ â™ª';
            previewArea.appendChild(previewLyricsBar);
            
            const vertical = document.getElementById('lyrics-vertical-pos').value;
            const horizontal = document.getElementById('lyrics-horizontal-pos').value;
            const offset = parseInt(document.getElementById('lyrics-offset-input').value) || 10;
        
            if (vertical === 'top') {
                previewLyricsBar.style.top = `${offset}px`;
            } else {
                previewLyricsBar.style.bottom = `${offset}px`;
            }
            
            switch (horizontal) {
                case 'left':
                    previewLyricsBar.style.left = '15px';
                    break;
                case 'right':
                    previewLyricsBar.style.right = '15px';
                    break;
                default:
                    previewLyricsBar.style.left = '50%';
                    previewLyricsBar.style.transform = 'translateX(-50%)';
                    break;
            }
            
            // 4. åº”ç”¨è‡ªå®šä¹‰CSSåˆ°é¢„è§ˆåŒº (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
            applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è¯·å°†è¿™äº›ã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        
        async function openGroupManager() {
            await renderGroupList();
            document.getElementById('group-management-modal').classList.add('visible');
        }
        
        async function renderGroupList() {
            const listEl = document.getElementById('existing-groups-list');
            const groups = await db.qzoneGroups.toArray();
            listEl.innerHTML = '';
            if (groups.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç»„</p>';
            }
            groups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'existing-group-item';
                item.innerHTML = `
                    <span class="group-name">${group.name}</span>
                    <span class="delete-group-btn" data-id="${group.id}">Ã—</span>
                `;
                listEl.appendChild(item);
            });
        }
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ä¿®æ­£åã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ addNewGroup å‡½æ•° â–¼â–¼â–¼
        async function addNewGroup() {
            const input = document.getElementById('new-group-name-input');
            const name = input.value.trim();
            if (!name) {
                alert('åˆ†ç»„åä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
        
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨æ·»åŠ å‰ï¼Œå…ˆæ£€æŸ¥åˆ†ç»„åæ˜¯å¦å·²å­˜åœ¨
            const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
            if (existingGroup) {
                alert(`åˆ†ç»„ "${name}" å·²ç»å­˜åœ¨äº†ï¼Œæ¢ä¸ªåå­—å§ï¼`);
                return;
            }
            // ã€ä¿®æ­£ç»“æŸã€‘
        
            await db.qzoneGroups.add({ name });
            input.value = '';
            await renderGroupList();
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        async function deleteGroup(groupId) {
            const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', 'åˆ é™¤åˆ†ç»„åï¼Œè¯¥ç»„å†…çš„å¥½å‹å°†å˜ä¸ºâ€œæœªåˆ†ç»„â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.qzoneGroups.delete(groupId);
                // å°†å±äºè¯¥åˆ†ç»„çš„å¥½å‹çš„ groupId è®¾ä¸º null
                const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
                for (const chat of chatsToUpdate) {
                    chat.groupId = null;
                    await db.chats.put(chat);
                    if(state.chats[chat.id]) state.chats[chat.id].groupId = null;
                }
                await renderGroupList();
            }
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒºçš„æœ«å°¾ â–¼â–¼â–¼
        
        /**
         * å½“é•¿æŒ‰æ¶ˆæ¯æ—¶ï¼Œæ˜¾ç¤ºæ“ä½œèœå•
         * @param {number} timestamp - è¢«é•¿æŒ‰æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        function showMessageActions(timestamp) {
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ–°å¢ â–¼â–¼â–¼
        const chat = state.chats[state.activeChatId];
        document.getElementById('publish-to-announcement-btn').style.display = chat.isGroup ? 'block' : 'none';
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
            // å¦‚æœå·²ç»åœ¨å¤šé€‰æ¨¡å¼ï¼Œåˆ™ä¸å¼¹å‡ºèœå•
            if (isSelectionMode) return;
            
            activeMessageTimestamp = timestamp;
            document.getElementById('message-actions-modal').classList.add('visible');
        }
        
        /**
         * éšè—æ¶ˆæ¯æ“ä½œèœå•
         */
        function hideMessageActions() {
            document.getElementById('message-actions-modal').classList.remove('visible');
            activeMessageTimestamp = null;
        }
        
        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬ï¼Œæ›¿æ¢æ—§çš„ openMessageEditor å‡½æ•° â–¼â–¼â–¼
        async function openMessageEditor() {
            if (!activeMessageTimestamp) return;
        
            const timestampToEdit = activeMessageTimestamp;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestampToEdit);
            if (!message) return;
        
            hideMessageActions(); 
        
            let contentForEditing;
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘å°† share_link ä¹ŸåŠ å…¥ç‰¹æ®Šç±»å‹åˆ¤æ–­
            const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'share_link'].includes(message.type);
        
            if (isSpecialType) {
                let fullMessageObject = { type: message.type };
                if (message.type === 'voice_message') fullMessageObject.content = message.content;
                else if (message.type === 'ai_image') fullMessageObject.description = message.content; 
                else if (message.type === 'transfer') {
                    fullMessageObject.amount = message.amount;
                    fullMessageObject.note = message.note;
                } 
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘å¤„ç†åˆ†äº«é“¾æ¥ç±»å‹çš„æ¶ˆæ¯
                else if (message.type === 'share_link') {
                    fullMessageObject.title = message.title;
                    fullMessageObject.description = message.description;
                    fullMessageObject.source_name = message.source_name;
                    fullMessageObject.content = message.content;
                }
                contentForEditing = JSON.stringify(fullMessageObject, null, 2);
            } else if (typeof message.content === 'object') {
                contentForEditing = JSON.stringify(message.content, null, 2);
            } else {
                contentForEditing = message.content;
            }
        
            // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ·»åŠ  'link' æ¨¡æ¿
            const templates = {
                voice: { type: 'voice_message', content: 'åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹' },
                image: { type: 'ai_image', description: 'åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°' },
                transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€ç‚¹å¿ƒæ„' },
                link: { type: 'share_link', title: 'æ–‡ç« æ ‡é¢˜', description: 'æ–‡ç« æ‘˜è¦...', source_name: 'æ¥æºç½‘ç«™', content: 'æ–‡ç« å®Œæ•´å†…å®¹...' }
            };
        
            // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨è¿™é‡Œæ·»åŠ æ–°çš„â€œé“¾æ¥â€æŒ‰é’®
            const helpersHtml = `
                <div class="format-helpers">
                    <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>è¯­éŸ³</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½¬è´¦</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é“¾æ¥</button>
                </div>
            `;
        
            const newContent = await showCustomPrompt(
                'ç¼–è¾‘æ¶ˆæ¯', 
                'åœ¨æ­¤ä¿®æ”¹ï¼Œæˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä½¿ç”¨æ ¼å¼æ¨¡æ¿...',
                contentForEditing, 
                'textarea',
                helpersHtml
            );
        
            if (newContent !== null) {
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘è¿™é‡Œè°ƒç”¨çš„åº”è¯¥æ˜¯ saveEditedMessageï¼Œè€Œä¸æ˜¯ saveAdvancedEditor
                await saveEditedMessage(timestampToEdit, newContent, true);
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * å¤åˆ¶æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹åˆ°å‰ªè´´æ¿
         */
        async function copyMessageContent() {
            if (!activeMessageTimestamp) return;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
            if (!message) return;
        
            let textToCopy;
            if (typeof message.content === 'object') {
                textToCopy = JSON.stringify(message.content);
            } else {
                textToCopy = String(message.content);
            }
        
            try {
                await navigator.clipboard.writeText(textToCopy);
                await showCustomAlert('å¤åˆ¶æˆåŠŸ', 'æ¶ˆæ¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
            } catch (err) {
                await showCustomAlert('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚');
            }
            
            hideMessageActions();
        }
        
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ° copyMessageContent å‡½æ•°çš„åé¢ â–¼â–¼â–¼
/**
 * å¤åˆ¶æ¶ˆæ¯çš„æ—¶é—´æˆ³åˆ°å‰ªè´´æ¿
 */
async function copyMessageTimestamp() {
    if (!activeMessageTimestamp) return;

    try {
        await navigator.clipboard.writeText(activeMessageTimestamp);
        await showCustomAlert('å¤åˆ¶æˆåŠŸ', `æ¶ˆæ¯æ—¶é—´æˆ³ ${activeMessageTimestamp} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚`);
    } catch (err) {
        await showCustomAlert('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚');
    }
    
    hideMessageActions();
}
// â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå·²æ·»åŠ â€œå¼•ç”¨â€æ¨¡æ¿çš„ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ createMessageEditorBlock å‡½æ•° â–¼â–¼â–¼
/**
 * åˆ›å»ºä¸€ä¸ªå¯ç¼–è¾‘çš„æ¶ˆæ¯å—ï¼ˆåŒ…å«æ–‡æœ¬æ¡†ã€æ ¼å¼åŠ©æ‰‹å’Œåˆ é™¤æŒ‰é’®ï¼‰
 * @param {string} initialContent - æ–‡æœ¬æ¡†çš„åˆå§‹å†…å®¹
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„DOMå…ƒç´ 
 */
function createMessageEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'message-editor-block';

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ·»åŠ  'quote' æ¨¡æ¿
    const templates = {
        voice: { type: 'voice_message', content: 'åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹' },
        image: { type: 'ai_image', description: 'åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€ç‚¹å¿ƒæ„' },
        link: { type: 'share_link', title: 'æ–‡ç« æ ‡é¢˜', description: 'æ–‡ç« æ‘˜è¦...', source_name: 'æ¥æºç½‘ç«™', content: 'æ–‡ç« å®Œæ•´å†…å®¹...' },
        offline: { type: 'offline_text', content: 'ã€Œåœ¨è¿™é‡Œè¾“å…¥å¯¹è¯å†…å®¹ã€\n(åœ¨è¿™é‡Œè¾“å…¥åŠ¨ä½œæˆ–ç¯å¢ƒæå†™)' },
        quote: { type: 'quote_reply', target_timestamp: 1234567890, reply_content: 'åœ¨è¿™é‡Œè¾“å…¥å›å¤å†…å®¹' }
    };

    block.innerHTML = `
        <button class="delete-block-btn" title="åˆ é™¤æ­¤æ¡">Ã—</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>è¯­éŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½¬è´¦</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é“¾æ¥</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.offline)}'>çº¿ä¸‹</button>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨è¿™é‡Œæ·»åŠ æ–°çš„â€œå¼•ç”¨â€æŒ‰é’® -->
            <button class="format-btn" data-template='${JSON.stringify(templates.quote)}'>å¼•ç”¨</button>
        </div>
    `;

    // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
    block.querySelector('.delete-block-btn').addEventListener('click', () => {
        // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸€ä¸ªç¼–è¾‘å—
        if (document.querySelectorAll('.message-editor-block').length > 1) {
            block.remove();
        } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€æ¡æ¶ˆæ¯ã€‚');
        }
    });

    // ç»‘å®šæ ¼å¼åŠ©æ‰‹æŒ‰é’®äº‹ä»¶
    block.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const templateStr = btn.dataset.template;
            const textarea = block.querySelector('textarea');
            if (templateStr && textarea) {
                try {
                    const templateObj = JSON.parse(templateStr);
                    textarea.value = JSON.stringify(templateObj, null, 2);
                    textarea.focus();
                } catch(e) { console.error("è§£ææ ¼å¼æ¨¡æ¿å¤±è´¥:", e); }
            }
        });
    });

    return block;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ openAdvancedMessageEditor å‡½æ•° â–¼â–¼â–¼
        /**
         * æ‰“å¼€å…¨æ–°çš„ã€å¯è§†åŒ–çš„å¤šæ¶ˆæ¯ç¼–è¾‘å™¨ï¼Œå¹¶åŠ¨æ€ç»‘å®šå…¶æ‰€æœ‰æŒ‰é’®äº‹ä»¶
         */
        function openAdvancedMessageEditor() {
            if (!activeMessageTimestamp) return;
        
            const timestampToEdit = activeMessageTimestamp;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestampToEdit);
            if (!message) return;
        
            hideMessageActions(); 
        
            const editorModal = document.getElementById('message-editor-modal');
            const editorContainer = document.getElementById('message-editor-container');
            editorContainer.innerHTML = ''; 
        
            let initialContent;
            
            // ==========================================================
            //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ä»è¿™é‡Œå¼€å§‹ â˜…â˜…â˜…
            // ==========================================================
            
            // æ­¥éª¤1ï¼šæ£€æŸ¥è¿™æ¡æ¶ˆæ¯æ˜¯å¦æ˜¯ä¸€ä¸ªâ€œå¼•ç”¨å›å¤â€
            if (message.quote) {
                // å¦‚æœæ˜¯ï¼Œå°±æ‰‹åŠ¨æ„å»ºä¸€ä¸ªå®Œæ•´çš„ quote_reply å¯¹è±¡
                const quoteReplyObject = {
                    type: 'quote_reply',
                    target_timestamp: message.quote.timestamp,
                    reply_content: message.content // æ‚¨çš„å›å¤å†…å®¹
                };
                // å°†è¿™ä¸ªå®Œæ•´çš„å¯¹è±¡è½¬æ¢ä¸ºæ ¼å¼åŒ–çš„JSONå­—ç¬¦ä¸²ï¼Œä½œä¸ºç¼–è¾‘å™¨çš„åˆå§‹å†…å®¹
                initialContent = JSON.stringify(quoteReplyObject, null, 2);
            } 
            // æ­¥éª¤2ï¼šå¦‚æœä¸æ˜¯å¼•ç”¨å›å¤ï¼Œå†æ‰§è¡ŒåŸæ¥çš„ç‰¹æ®Šç±»å‹åˆ¤æ–­
            else if (message.type && ['voice_message', 'ai_image', 'transfer', 'offline_text', 'share_link'].includes(message.type)) {
                let fullMessageObject = { type: message.type };
                if (message.type === 'voice_message') fullMessageObject.content = message.content;
                else if (message.type === 'ai_image') fullMessageObject.description = message.content;
                else if (message.type === 'transfer') {
                    fullMessageObject.amount = message.amount;
                    fullMessageObject.note = message.note;
                } 
                else if (message.type === 'offline_text') {
                    if (message.content) {
                        fullMessageObject.content = message.content;
                    } else { 
                        fullMessageObject.dialogue = message.dialogue;
                        fullMessageObject.description = message.description;
                    }
                }
                else if (message.type === 'share_link') {
                    fullMessageObject.title = message.title;
                    fullMessageObject.description = message.description;
                    fullMessageObject.source_name = message.source_name;
                    fullMessageObject.content = message.content;
                }
                initialContent = JSON.stringify(fullMessageObject, null, 2);
            } 
            // æ­¥éª¤3ï¼šå¤„ç†å…¶ä»–æ‰€æœ‰æ™®é€šæƒ…å†µ
            else if (typeof message.content === 'object') {
                initialContent = JSON.stringify(message.content, null, 2);
            } else {
                initialContent = message.content;
            }
        
            // ==========================================================
            //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤åˆ°æ­¤ç»“æŸ â˜…â˜…â˜…
            // ==========================================================
        
            const firstBlock = createMessageEditorBlock(initialContent);
            editorContainer.appendChild(firstBlock);
        
            // (åç»­çš„æŒ‰é’®ç»‘å®šé€»è¾‘ä¿æŒä¸å˜)
            const addBtn = document.getElementById('add-message-editor-block-btn');
            const newAddBtn = addBtn.cloneNode(true);
            addBtn.parentNode.replaceChild(newAddBtn, addBtn);
            newAddBtn.addEventListener('click', () => {
                const newBlock = createMessageEditorBlock();
                editorContainer.appendChild(newBlock);
                newBlock.querySelector('textarea').focus();
            });
        
            const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            newCancelBtn.addEventListener('click', () => {
                editorModal.classList.remove('visible');
            });
        
            const saveBtn = document.getElementById('save-advanced-editor-btn');
            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
            newSaveBtn.addEventListener('click', () => {
                saveEditedMessage(timestampToEdit); 
            });
        
            editorModal.classList.add('visible');
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        /**
         * å¤åˆ¶æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹åˆ°å‰ªè´´æ¿
         */
        async function copyMessageContent() {
            if (!activeMessageTimestamp) return;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
            if (!message) return;
        
            let textToCopy;
            // ã€ã€ã€æ ¸å¿ƒä¿®å¤3ï¼šåœ¨è¿™é‡Œä¹Ÿæ·»åŠ å¯¹ offline_text çš„åˆ¤æ–­ã€‘ã€‘ã€‘
            if (message.type === 'offline_text') {
                // å¦‚æœæ˜¯æ–°æ ¼å¼ï¼Œç›´æ¥å¤åˆ¶content
                if (message.content) {
                    textToCopy = message.content;
                } else { // å…¼å®¹æ—§æ ¼å¼
                    textToCopy = `ã€Œ${message.dialogue || ''}ã€\n${message.description || ''}`;
                }
            } else if (typeof message.content === 'object') {
                textToCopy = JSON.stringify(message.content);
            } else {
                textToCopy = String(message.content);
            }
        
            try {
                await navigator.clipboard.writeText(textToCopy);
                await showCustomAlert('å¤åˆ¶æˆåŠŸ', 'æ¶ˆæ¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
            } catch (err) {
                await showCustomAlert('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚');
            }
            
            hideMessageActions();
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * è§£æç¼–è¾‘åçš„æ–‡æœ¬ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ¶ˆæ¯ç‰‡æ®µå¯¹è±¡
         * @param {string} text - ç”¨æˆ·åœ¨ç¼–è¾‘æ¡†ä¸­è¾“å…¥çš„æ–‡æœ¬
         * @returns {object} - ä¸€ä¸ªåŒ…å« type, content, ç­‰å±æ€§çš„å¯¹è±¡
         */
        function parseEditedContent(text) {
            const trimmedText = text.trim();
        
            // 1. å°è¯•è§£æä¸ºJSONå¯¹è±¡ï¼ˆç”¨äºä¿®å¤è¯­éŸ³ã€è½¬è´¦ç­‰æ ¼å¼ï¼‰
            if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
                try {
                    const parsed = JSON.parse(trimmedText);
                    // å¿…é¡»åŒ…å« type å±æ€§æ‰è®¤ä¸ºæ˜¯æœ‰æ•ˆæ ¼å¼
                    if (parsed.type) {
                        return parsed;
                    }
                } catch (e) { /* è§£æå¤±è´¥ï¼Œç»§ç»­å¾€ä¸‹èµ° */ }
            }
            
            // 2. å°è¯•è§£æä¸ºè¡¨æƒ…åŒ…
            if (STICKER_REGEX.test(trimmedText)) {
                // å¯¹äºç¼–è¾‘çš„è¡¨æƒ…ï¼Œæˆ‘ä»¬æš‚æ—¶æ— æ³•çŸ¥é“å…¶`meaning`ï¼Œæ‰€ä»¥åªå­˜URL
                return { type: 'sticker', content: trimmedText };
            }
        
            // 3. å¦åˆ™ï¼Œè§†ä¸ºæ™®é€šæ–‡æœ¬æ¶ˆæ¯
            return { type: 'text', content: trimmedText };
        }
        
        
// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘å®Œæ•´æ›¿æ¢æ—§çš„ saveEditedMessage å‡½æ•° â–¼â–¼â–¼

async function saveEditedMessage(timestamp, simpleContent = null) {
    if (!timestamp) return;

    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;
    
    // 1. è·å–åŸå§‹æ¶ˆæ¯çš„å®Œæ•´å¯¹è±¡ï¼Œè¿™æ˜¯ç»§æ‰¿æ‰€æœ‰å±æ€§çš„å…³é”®
    const originalMessage = chat.history[messageIndex];

    let newMessages = [];

    // å¤„ç†æ¥è‡ªâ€œç¼–è¾‘æ¶ˆæ¯â€å’Œâ€œå¯¼æ¼”å‰ªè¾‘å®¤â€çš„è¾“å…¥
    const blocks = simpleContent !== null 
        ? [simpleContent] 
        : Array.from(document.querySelectorAll('#message-editor-container textarea')).map(ta => ta.value);

    for (const rawContent of blocks) {
        if (!rawContent.trim()) continue;

        const parsedResult = parseEditedContent(rawContent.trim());
        
        // 2. ã€ã€ã€è¿™å°±æ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒï¼ã€‘ã€‘ã€‘
        //    å…ˆåˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰åŸå§‹å±æ€§çš„å‰¯æœ¬
        const newMessage = { ...originalMessage };

        // 3. æ ¹æ®è§£æç»“æœï¼Œæ™ºèƒ½åœ°æ›´æ–°æ¶ˆæ¯
        if (parsedResult.type === 'text') {
            // å¦‚æœåªæ˜¯æ™®é€šæ–‡æœ¬ï¼Œå°±ã€åªæ›´æ–°å†…å®¹ã€‘ï¼Œä¿æŒåŸå§‹ç±»å‹å’Œå…¶ä»–æ‰€æœ‰å±æ€§ä¸å˜ï¼
            newMessage.content = parsedResult.content;
        } else {
            // å¦‚æœæ˜¯ç‰¹æ®Šç±»å‹ï¼ˆå¦‚è¯­éŸ³ã€è½¬è´¦ã€å¼•ç”¨ç­‰ï¼‰ï¼Œæ‰æ›´æ–°æ‰€æœ‰ç›¸å…³å±æ€§
            newMessage.type = parsedResult.type;
            newMessage.content = parsedResult.content || '';
            
            // æ¸…ç†æ‰å¯èƒ½å­˜åœ¨çš„æ—§æ ¼å¼æ®‹ç•™
            delete newMessage.dialogue;
            delete newMessage.description;
            
            // æ ¹æ®ä¸åŒç±»å‹ï¼Œæ·»åŠ æˆ–æ›´æ–°ç‰¹å®šå±æ€§
            if (parsedResult.type === 'offline_text') {
                if (parsedResult.content) {
                    newMessage.content = parsedResult.content;
                } else {
                    newMessage.dialogue = parsedResult.dialogue;
                    newMessage.description = parsedResult.description;
                    delete newMessage.content;
                }
            }
            else if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            else if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            else if (parsedResult.note) newMessage.note = parsedResult.note;
            else if (parsedResult.title) newMessage.title = parsedResult.title;
            else if (parsedResult.description && parsedResult.type === 'ai_image') {
                 newMessage.content = parsedResult.description;
            } 
            else if (parsedResult.description) newMessage.description = parsedResult.description; // for share_link
            else if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name; // for share_link
                        // ==========================================================
            else if (parsedResult.type === 'quote_reply') {
                newMessage.content = parsedResult.reply_content;

                // 1. æ ¹æ®æ—¶é—´æˆ³æŸ¥æ‰¾è¢«å¼•ç”¨çš„åŸå§‹æ¶ˆæ¯
                const originalQuotedMsg = chat.history.find(m => m.timestamp === parsedResult.target_timestamp);

                if (originalQuotedMsg) {
                    // 2. å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±æå–æ­£ç¡®çš„ä¿¡æ¯
                    let originalSenderName;
                    if (originalQuotedMsg.role === 'user') {
                        // å¦‚æœæ˜¯ç”¨æˆ·ï¼Œä½¿ç”¨ç”¨æˆ·çš„æœ¬å
                        originalSenderName = state.qzoneSettings.nickname || '{{user}}';
                    } else {
                        // å¦‚æœæ˜¯AIï¼Œä½¿ç”¨æ¶ˆæ¯ä¸­è®°å½•çš„æœ¬å
                        originalSenderName = originalQuotedMsg.senderName;
                    }
                    
                    newMessage.quote = {
                        timestamp: parsedResult.target_timestamp,
                        senderName: originalSenderName, // ä½¿ç”¨æ­£ç¡®çš„å‘é€è€…æœ¬å
                        content: String(originalQuotedMsg.content || '') // ä½¿ç”¨æ­£ç¡®çš„åŸå§‹å†…å®¹
                    };
                } else {
                    // 3. å¦‚æœæ‰¾ä¸åˆ°ï¼ˆä¾‹å¦‚æ—¶é—´æˆ³å¡«é”™äº†ï¼‰ï¼Œå°±ä½¿ç”¨å®‰å…¨çš„å ä½ç¬¦
                    newMessage.quote = {
                        timestamp: parsedResult.target_timestamp,
                        senderName: 'æœªçŸ¥ç”¨æˆ·',
                        content: 'åŸå§‹æ¶ˆæ¯å·²åˆ é™¤æˆ–ä¸å­˜åœ¨'
                    };
                }
            }
        }
        
        newMessages.push(newMessage);
    }
    
    if (newMessages.length === 0) {
        document.getElementById('message-editor-modal').classList.remove('visible');
        return;
    }

    // (åç»­çš„æ›¿æ¢ã€é‡æ’æ—¶é—´æˆ³ã€ä¿å­˜å’Œåˆ·æ–°é€»è¾‘ä¿æŒä¸å˜)
    chat.history.splice(messageIndex, 1, ...newMessages);
    let reassignTimestamp = timestamp;
    for (let i = messageIndex; i < chat.history.length; i++) {
        chat.history[i].timestamp = reassignTimestamp;
        reassignTimestamp++; 
    }
    await db.chats.put(chat);
    document.getElementById('message-editor-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    await showCustomAlert('æˆåŠŸ', 'æ¶ˆæ¯å·²æ›´æ–°ï¼');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒºçš„æœ«å°¾ â–¼â–¼â–¼
        
        /**
         * å½“ç‚¹å‡»â€œâ€¦â€æ—¶ï¼Œæ˜¾ç¤ºåŠ¨æ€æ“ä½œèœå•
         * @param {number} postId - è¢«æ“ä½œçš„åŠ¨æ€çš„ID
         */
        function showPostActions(postId) {
            activePostId = postId;
            document.getElementById('post-actions-modal').classList.add('visible');
        }
        
        /**
         * éšè—åŠ¨æ€æ“ä½œèœå•
         */
        function hidePostActions() {
            document.getElementById('post-actions-modal').classList.remove('visible');
            activePostId = null;
        }
        
        /**
         * æ‰“å¼€åŠ¨æ€ç¼–è¾‘å™¨
         */
        async function openPostEditor() {
            if (!activePostId) return;
        
            const postIdToEdit = activePostId;
            const post = await db.qzonePosts.get(postIdToEdit);
            if (!post) return;
        
            hidePostActions();
        
            // å¿ äºåŸæ–‡ï¼šæ„å»ºå‡ºæœ€åŸå§‹çš„æ–‡æœ¬å½¢æ€ä¾›ç¼–è¾‘
            let contentForEditing;
            if (post.type === 'shuoshuo') {
                contentForEditing = post.content;
            } else {
                // å¯¹äºå›¾ç‰‡å’Œæ–‡å­—å›¾ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰ä¿¡æ¯çš„å¯¹è±¡
                const postObject = {
                    type: post.type,
                    publicText: post.publicText || '',
                };
                if (post.type === 'image_post') {
                    postObject.imageUrl = post.imageUrl;
                    postObject.imageDescription = post.imageDescription;
                } else if (post.type === 'text_image') {
                    postObject.hiddenContent = post.hiddenContent;
                }
                contentForEditing = JSON.stringify(postObject, null, 2);
            }
            
            // æ„å»ºæ ¼å¼åŠ©æ‰‹æŒ‰é’®
            const templates = {
                shuoshuo: "åœ¨è¿™é‡Œè¾“å…¥è¯´è¯´çš„å†…å®¹...", // å¯¹äºè¯´è¯´ï¼Œæˆ‘ä»¬ç›´æ¥æ›¿æ¢ä¸ºçº¯æ–‡æœ¬
                image: { type: 'image_post', publicText: '', imageUrl: 'https://...', imageDescription: '' },
                text_image: { type: 'text_image', publicText: '', hiddenContent: '' }
            };
            
            const helpersHtml = `
                <div class="format-helpers">
                    <button class="format-btn" data-type="text">è¯´è¯´</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡åŠ¨æ€</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'>æ–‡å­—å›¾</button>
                </div>
            `;
        
            const newContent = await showCustomPrompt(
                'ç¼–è¾‘åŠ¨æ€',
                'åœ¨æ­¤ä¿®æ”¹å†…å®¹...',
                contentForEditing,
                'textarea',
                helpersHtml
            );
            
            // ã€ç‰¹æ®Šå¤„ç†ã€‘ä¸ºè¯´è¯´çš„æ ¼å¼åŠ©æ‰‹æŒ‰é’®æ·»åŠ ä¸åŒçš„è¡Œä¸º
            // æˆ‘ä»¬éœ€è¦åœ¨æ¨¡æ€æ¡†å‡ºç°åï¼Œå†ç»™å®ƒç»‘å®šäº‹ä»¶
            setTimeout(() => {
                const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
                if(shuoshuoBtn) {
                    shuoshuoBtn.addEventListener('click', () => {
                        const input = document.getElementById('custom-prompt-input');
                        input.value = templates.shuoshuo;
                        input.focus();
                    });
                }
            }, 100);
        
            if (newContent !== null) {
                await saveEditedPost(postIdToEdit, newContent);
            }
        }
        
        /**
         * ä¿å­˜ç¼–è¾‘åçš„åŠ¨æ€
         * @param {number} postId - è¦ä¿å­˜çš„åŠ¨æ€ID
         * @param {string} newRawContent - ä»ç¼–è¾‘å™¨è·å–çš„æ–°å†…å®¹
         */
        async function saveEditedPost(postId, newRawContent) {
            const post = await db.qzonePosts.get(postId);
            if (!post) return;
        
            const trimmedContent = newRawContent.trim();
            
            // å°è¯•è§£æä¸ºJSONï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™è®¤ä¸ºæ˜¯çº¯æ–‡æœ¬ï¼ˆè¯´è¯´ï¼‰
            try {
                const parsed = JSON.parse(trimmedContent);
                // æ›´æ–°å¸–å­å±æ€§
                post.type = parsed.type || 'image_post';
                post.publicText = parsed.publicText || '';
                post.imageUrl = parsed.imageUrl || '';
                post.imageDescription = parsed.imageDescription || '';
                post.hiddenContent = parsed.hiddenContent || '';
                post.content = ''; // æ¸…ç©ºæ—§çš„è¯´è¯´å†…å®¹å­—æ®µ
            } catch (e) {
                // è§£æå¤±è´¥ï¼Œè®¤ä¸ºæ˜¯è¯´è¯´
                post.type = 'shuoshuo';
                post.content = trimmedContent;
                // æ¸…ç©ºå…¶ä»–ç±»å‹çš„å­—æ®µ
                post.publicText = '';
                post.imageUrl = '';
                post.imageDescription = '';
                post.hiddenContent = '';
            }
            
            await db.qzonePosts.put(post);
            await renderQzonePosts(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            await showCustomAlert('æˆåŠŸ', 'åŠ¨æ€å·²æ›´æ–°ï¼');
        }
        
        /**
         * å¤åˆ¶åŠ¨æ€å†…å®¹
         */
        async function copyPostContent() {
            if (!activePostId) return;
            const post = await db.qzonePosts.get(activePostId);
            if (!post) return;
            
            let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "ï¼ˆæ— æ–‡å­—å†…å®¹ï¼‰";
            
            try {
                await navigator.clipboard.writeText(textToCopy);
                await showCustomAlert('å¤åˆ¶æˆåŠŸ', 'åŠ¨æ€å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
            } catch (err) {
                await showCustomAlert('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚');
            }
            
            hidePostActions();
        }
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ›å»ºç¾¤èŠä¸æ‹‰äººåŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
        let selectedContacts = new Set();
        
        async function openContactPickerForGroupCreate() {
    // å¼¹å‡ºé€‰æ‹©èœå•ï¼Œè®©ç”¨æˆ·å†³å®šåˆ›å»ºå“ªç§ç¾¤èŠ
    const choice = await showChoiceModal('åˆ›å»ºç¾¤èŠ', [
        { text: 'åˆ›å»ºæ™®é€šç¾¤èŠ (æˆ‘å‚ä¸)', value: 'normal' },
        { text: 'åˆ›å»ºæ—è§‚ç¾¤èŠ (æˆ‘å›´è§‚)', value: 'spectator' }
    ]);

    if (choice === 'normal') {
        // å¦‚æœé€‰æ‹©æ™®é€šç¾¤èŠï¼Œæ‰§è¡Œæ—§çš„é€»è¾‘
        selectedContacts.clear();
        const confirmBtn = document.getElementById('confirm-contact-picker-btn');
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.addEventListener('click', handleCreateGroup);
        await renderContactPicker();
        showScreen('contact-picker-screen');

    } else if (choice === 'spectator') {
        // å¦‚æœé€‰æ‹©æ—è§‚ç¾¤èŠï¼Œæ‰§è¡Œæ–°çš„é€»è¾‘
        openSpectatorGroupCreator();
    }
}
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ—è§‚æ¨¡å¼ç¾¤èŠåˆ›å»ºåŠŸèƒ½çš„æ ¸å¿ƒä»£ç  â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€â€œæ—è§‚æ¨¡å¼ç¾¤èŠâ€çš„æˆå‘˜é€‰æ‹©å™¨
 */
async function openSpectatorGroupCreator() {
    selectedContacts.clear(); // æ¸…ç©ºä¸Šæ¬¡çš„é€‰æ‹©

    // 1. ä¿®æ”¹â€œå®Œæˆâ€æŒ‰é’®çš„è¡Œä¸ºï¼Œè®©å®ƒåœ¨ç‚¹å‡»åè°ƒç”¨æˆ‘ä»¬æ–°çš„åˆ›å»ºå‡½æ•°
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleCreateSpectatorGroup);

    // 2. æ¸²æŸ“ä¸€ä¸ªåŒ…å«æ‰€æœ‰è§’è‰²å’ŒNPCçš„è”ç³»äººåˆ—è¡¨
    await renderSpectatorContactPicker();

    // 3. åˆ‡æ¢åˆ°è”ç³»äººé€‰æ‹©å±å¹•
    showScreen('contact-picker-screen');
}

/**
 * ã€å…¨æ–°ã€‘ä¸ºâ€œæ—è§‚æ¨¡å¼â€æ¸²æŸ“ä¸€ä¸ªç‰¹æ®Šçš„è”ç³»äººåˆ—è¡¨ï¼ŒåŒ…å«æ‰€æœ‰è§’è‰²å’ŒNPC
 */
async function renderSpectatorContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';

    // a. è·å–æ‰€æœ‰å•èŠè§’è‰²
    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);
    // b. ä»æ•°æ®åº“è·å–æ‰€æœ‰NPC
    const npcs = await db.npcs.toArray();

    if (characters.length === 0 && npcs.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">è¿˜æ²¡æœ‰ä»»ä½•è§’è‰²æˆ–NPCå¯ä»¥åŠ å…¥ç¾¤èŠã€‚</p>';
        return;
    }

    // c. æ¸²æŸ“è§’è‰²åˆ—è¡¨
    characters.forEach(contact => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = contact.id; // ä½¿ç”¨è§’è‰²çš„èŠå¤©ID
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name} <small style="color:#888;">(è§’è‰²)</small></span>
        `;
        listEl.appendChild(item);
    });

    // d. æ¸²æŸ“NPCåˆ—è¡¨
    npcs.forEach(npc => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = npc.id; // ä½¿ç”¨NPCçš„ID
        item.dataset.isNpc = "true";     // æ·»åŠ ä¸€ä¸ªç‰¹æ®Šæ ‡è®°
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
            <span class="name">${npc.name} <small style="color:#007722;">(NPC)</small></span>
        `;
        listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†åˆ›å»ºâ€œæ—è§‚æ¨¡å¼ç¾¤èŠâ€çš„æœ€ç»ˆé€»è¾‘
 */
async function handleCreateSpectatorGroup() {
    if (selectedContacts.size < 2) {
        alert("æ—è§‚ç¾¤èŠè‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªæˆå‘˜ã€‚");
        return;
    }

    const groupName = await showCustomPrompt('è®¾ç½®ç¾¤å', 'è¯·è¾“å…¥ç¾¤èŠçš„åå­—', 'AIä»¬çš„èŒ¶è¯ä¼š');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    const allNpcs = await db.npcs.toArray(); // æå‰è·å–æ‰€æœ‰NPCæ•°æ®

    for (const contactId of selectedContacts) {
        const isNpc = document.querySelector(`.contact-picker-item[data-contact-id="${contactId}"]`).dataset.isNpc === "true";

        if (isNpc) {
            // å¦‚æœæ˜¯NPC
            const npcData = allNpcs.find(n => n.id === parseInt(contactId));
            if (npcData) {
                members.push({
                    id: `npc_${npcData.id}`, // ç»™NPCä¸€ä¸ªç‹¬ç‰¹çš„æˆå‘˜ID
                    originalName: npcData.name,
                    groupNickname: npcData.name,
                    persona: npcData.persona,
                    avatar: npcData.avatar || defaultGroupMemberAvatar,
                    isNpc: true
                });
            }
        } else {
            // å¦‚æœæ˜¯æ™®é€šè§’è‰²
            const contactChat = state.chats[contactId];
            if (contactChat) {
                members.push({
                    id: contactId,
                    originalName: contactChat.originalName,
                    groupNickname: contactChat.name,
                    persona: contactChat.settings.aiPersona,
                    avatar: contactChat.settings.aiAvatar || defaultAvatar,
                    isNpc: false
                });
            }
        }
    }

    const newGroupChat = {
        id: newChatId,
        name: groupName.trim(),
        isGroup: true,
        isSpectatorGroup: true, // â˜…â˜…â˜… è¿™å°±æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒæ ‡è®°ï¼â˜…â˜…â˜…
        members: members,
        settings: {
            // åœ¨æ—è§‚æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦â€œæˆ‘â€çš„äººè®¾å’Œå¤´åƒ
            maxMemory: 10,
            groupAvatar: defaultGroupAvatar,
            background: '',
            theme: 'default',
            fontSize: 13,
            customCss: '',
            linkedWorldBookIds: [],
        },
        history: [{ // æ·»åŠ ä¸€æ¡åˆå§‹ç³»ç»Ÿæ¶ˆæ¯ï¼Œå‘Šè¯‰AIå®ƒä»¬çš„ä»»åŠ¡
            role: 'system',
            content: '[ç³»ç»ŸæŒ‡ä»¤ï¼šè¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰ç”¨æˆ·å‚ä¸çš„ç¾¤èŠï¼Œè¯·ä½ ä»¬æ ¹æ®å„è‡ªçš„äººè®¾è‡ªç”±åœ°å¼€å§‹å¯¹è¯ã€‚]',
            timestamp: Date.now(),
            isHidden: true
        }],
        musicData: { totalTime: 0 }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);

    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId);
}
// â–²â–²â–² å…¨æ–°JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²        
        /**
         * æ¸²æŸ“è”ç³»äººé€‰æ‹©åˆ—è¡¨
         */
        async function renderContactPicker() {
            const listEl = document.getElementById('contact-picker-list');
            listEl.innerHTML = '';
        
            // åªé€‰æ‹©å•èŠè§’è‰²ä½œä¸ºç¾¤æˆå‘˜å€™é€‰
            const contacts = Object.values(state.chats).filter(chat => !chat.isGroup);
        
            if (contacts.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">è¿˜æ²¡æœ‰å¯ä»¥æ‹‰è¿›ç¾¤çš„è”ç³»äººå“¦~</p>';
                return;
            }
        
            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-picker-item';
                item.dataset.contactId = contact.id;
                item.innerHTML = `
                    <div class="checkbox"></div>
                    <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                    <span class="name">${contact.name}</span>
                `;
                listEl.appendChild(item);
            });
        
            updateContactPickerConfirmButton();
        }
        
        /**
         * æ›´æ–°â€œå®Œæˆâ€æŒ‰é’®çš„è®¡æ•°
         */
        function updateContactPickerConfirmButton() {
            const btn = document.getElementById('confirm-contact-picker-btn');
            btn.textContent = `å®Œæˆ(${selectedContacts.size})`;
            btn.disabled = selectedContacts.size < 2; // è‡³å°‘éœ€è¦2ä¸ªäººæ‰èƒ½åˆ›å»ºç¾¤èŠ
        }
        
        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²å½»åº•ä¿®å¤ã€‘çš„ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleCreateGroup å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€é‡æ„ç‰ˆã€‘å¤„ç†åˆ›å»ºç¾¤èŠçš„æœ€ç»ˆé€»è¾‘
         */
        async function handleCreateGroup() {
            if (selectedContacts.size < 2) {
                alert("åˆ›å»ºç¾¤èŠè‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªè”ç³»äººã€‚");
                return;
            }
        
            const groupName = await showCustomPrompt('è®¾ç½®ç¾¤å', 'è¯·è¾“å…¥ç¾¤èŠçš„åå­—', 'æˆ‘ä»¬çš„ç¾¤èŠ');
            if (!groupName || !groupName.trim()) return;
        
            const newChatId = 'group_' + Date.now();
            const members = [];
            
            // éå†é€‰ä¸­çš„è”ç³»äººID
            for (const contactId of selectedContacts) {
                const contactChat = state.chats[contactId];
                if (contactChat) {
                    // ã€æ ¸å¿ƒä¿®æ­£ã€‘ç¡®ä¿ originalName æ¥è‡ª contactChat.originalName
                    members.push({
                        id: contactId, 
                        originalName: contactChat.originalName, // <-- ä¹‹å‰çš„BUGåœ¨è¿™é‡Œï¼Œç°åœ¨å·²ä¿®å¤
                        groupNickname: contactChat.name,
                        persona: contactChat.settings.aiPersona
                    });
                }
            }
        
            const newGroupChat = {
                id: newChatId,
                name: groupName.trim(),
                isGroup: true,
                members: members,
                settings: {
                    myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚',
                    myNickname: 'æˆ‘',
                    maxMemory: 10,
                    groupAvatar: defaultGroupAvatar,
                    myAvatar: defaultMyGroupAvatar,
                    background: '',
                    theme: 'default',
                    fontSize: 13,
                    customCss: '',
                    linkedWorldBookIds: [],
                },
                history: [],
                musicData: { totalTime: 0 }
            };
        
            state.chats[newChatId] = newGroupChat;
            await db.chats.put(newGroupChat);
            
            await renderChatList();
            showScreen('chat-list-screen');
            openChat(newChatId); 
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
        
        /**
         * æ‰“å¼€ç¾¤æˆå‘˜ç®¡ç†å±å¹•
         */
        function openMemberManagementScreen() {
            if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
            renderMemberManagementList();
            showScreen('member-management-screen');
        }
        
        function renderMemberManagementList() {
            const listEl = document.getElementById('member-management-list');
            const chat = state.chats[state.activeChatId];
            listEl.innerHTML = '';
        
            chat.members.forEach(member => {
                const item = document.createElement('div');
                item.className = 'member-management-item';
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æ˜¾ç¤ºçš„åç§°ä» member.name æ”¹ä¸º member.groupNickname
                item.innerHTML = `
                    <img src="${member.avatar}" class="avatar">
                    <span class="name">${member.groupNickname}</span>
                    <button class="remove-member-btn" data-member-id="${member.id}" title="ç§»å‡ºç¾¤èŠ">-</button>
                `;
                listEl.appendChild(item);
            });
        }
        
        /**
         * ä»ç¾¤èŠä¸­ç§»é™¤ä¸€ä¸ªæˆå‘˜
         * @param {string} memberId - è¦ç§»é™¤çš„æˆå‘˜ID
         */
        async function removeMemberFromGroup(memberId) {
            const chat = state.chats[state.activeChatId];
            const memberIndex = chat.members.findIndex(m => m.id === memberId);
            
            if (memberIndex === -1) return;
            
            // å®‰å…¨æ£€æŸ¥ï¼Œç¾¤èŠè‡³å°‘ä¿ç•™2äºº
            if (chat.members.length <= 2) {
                alert("ç¾¤èŠäººæ•°ä¸èƒ½å°‘äº2äººã€‚");
                return;
            }
            
        const memberName = chat.members[memberIndex].groupNickname; // <-- ä¿®å¤ï¼šä½¿ç”¨ groupNickname
            const confirmed = await showCustomConfirm(
                'ç§»å‡ºæˆå‘˜',
                `ç¡®å®šè¦å°†â€œ${memberName}â€ç§»å‡ºç¾¤èŠå—ï¼Ÿ`,
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (confirmed) {
                chat.members.splice(memberIndex, 1);
                await db.chats.put(chat);
                renderMemberManagementList(); // åˆ·æ–°æˆå‘˜ç®¡ç†åˆ—è¡¨
                document.getElementById('chat-settings-btn').click(); // ã€æ ¸å¿ƒä¿®æ­£ã€‘æ¨¡æ‹Ÿç‚¹å‡»è®¾ç½®æŒ‰é’®ï¼Œå¼ºåˆ¶åˆ·æ–°æ•´ä¸ªå¼¹çª—
            }
        }
        
        /**
         * æ‰“å¼€è”ç³»äººé€‰æ‹©å™¨ï¼Œç”¨äºæ‹‰äººå…¥ç¾¤
         */
        async function openContactPickerForAddMember() {
            selectedContacts.clear(); // æ¸…ç©ºé€‰æ‹©
            
            const chat = state.chats[state.activeChatId];
            const existingMemberIds = new Set(chat.members.map(m => m.id));
        
            // æ¸²æŸ“è”ç³»äººåˆ—è¡¨ï¼Œå¹¶è‡ªåŠ¨æ’é™¤å·²åœ¨ç¾¤å†…çš„æˆå‘˜
            const listEl = document.getElementById('contact-picker-list');
            listEl.innerHTML = '';
            const contacts = Object.values(state.chats).filter(c => !c.isGroup && !existingMemberIds.has(c.id));
        
            if (contacts.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">æ²¡æœ‰æ›´å¤šå¯ä»¥é‚€è¯·çš„å¥½å‹äº†ã€‚</p>';
                document.getElementById('confirm-contact-picker-btn').style.display = 'none'; // æ²¡æœ‰äººå¯é€‰ï¼Œéšè—å®ŒæˆæŒ‰é’®
            } else {
                document.getElementById('confirm-contact-picker-btn').style.display = 'block';
                contacts.forEach(contact => {
                    const item = document.createElement('div');
                    item.className = 'contact-picker-item';
                    item.dataset.contactId = contact.id;
                    item.innerHTML = `
                        <div class="checkbox"></div>
                        <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                        <span class="name">${contact.name}</span>
                    `;
                    listEl.appendChild(item);
                });
            }
        
            // æ›´æ–°æŒ‰é’®çŠ¶æ€å¹¶æ˜¾ç¤ºå±å¹•
            updateContactPickerConfirmButton();
            showScreen('contact-picker-screen');
        }
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²ä¿®å¤é”™è¯¯ã€‘çš„å…¨æ–°ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleAddMembersToGroup å‡½æ•° â–¼â–¼â–¼
        /**
         * å¤„ç†å°†é€‰ä¸­çš„è”ç³»äººåŠ å…¥ç¾¤èŠçš„é€»è¾‘
         */
        async function handleAddMembersToGroup() {
            if (selectedContacts.size === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ·»åŠ çš„è”ç³»äººã€‚");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
        
            for (const contactId of selectedContacts) {
                const contactChat = state.chats[contactId];
                if (contactChat) {
                    // è¿™ä¸ªéƒ¨åˆ†çš„æ•°æ®ç»“æ„æ˜¯æ­£ç¡®çš„ï¼Œä¿æŒä¸å˜
                    chat.members.push({
                        id: contactId,
                        originalName: contactChat.originalName,
                        groupNickname: contactChat.name,
                        persona: contactChat.settings.aiPersona,
                        // æ³¨æ„ï¼šæˆ‘ä»¬ä¸å†åœ¨è¿™é‡Œå­˜å‚¨ avatar å’Œ avatarFrameï¼Œå› ä¸ºå®ƒä»¬æ˜¯åŠ¨æ€è·å–çš„
                    });
                }
            }
        
            await db.chats.put(chat);
            
            // --- ã€æ ¸å¿ƒä¿®å¤ã€‘ ---
            // ä¹‹å‰è¿™é‡Œé”™è¯¯åœ°è°ƒç”¨äº† renderGroupMemberSettingsï¼Œå¯¼è‡´æŠ¥é”™ã€‚
            // æ­£ç¡®çš„é€»è¾‘æ˜¯ï¼šç›´æ¥è¿”å›åˆ°â€œç¾¤æˆå‘˜ç®¡ç†â€å±å¹•ï¼Œ
            // è€Œ openMemberManagementScreen å‡½æ•°ä¼šè‡ªåŠ¨è°ƒç”¨ renderMemberManagementList æ¥åˆ·æ–°åˆ—è¡¨ã€‚
            openMemberManagementScreen(); 
            // --- ã€ä¿®å¤ç»“æŸã€‘ ---
        }
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²ä¿®å¤é”™è¯¯ã€‘çš„å…¨æ–°ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ createNewMemberInGroup å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€é‡æ„ç‰ˆã€‘åœ¨ç¾¤èŠä¸­åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„è™šæ‹Ÿæˆå‘˜
         */
        async function createNewMemberInGroup() {
            const name = await showCustomPrompt('åˆ›å»ºæ–°æˆå‘˜', 'è¯·è¾“å…¥æ–°æˆå‘˜çš„åå­— (è¿™å°†æ˜¯TAçš„â€œæœ¬åâ€ï¼Œä¸å¯æ›´æ”¹)');
            if (!name || !name.trim()) return;
        
            const chat = state.chats[state.activeChatId];
            if (chat.members.some(m => m.originalName === name.trim())) {
                alert(`é”™è¯¯ï¼šç¾¤å†…å·²å­˜åœ¨åä¸ºâ€œ${name.trim()}â€çš„æˆå‘˜ï¼`);
                return;
            }
        
            const persona = await showCustomPrompt('è®¾ç½®äººè®¾', `è¯·è¾“å…¥â€œ${name}â€çš„äººè®¾`, '', 'textarea');
            if (persona === null) return; 
        
            const newMember = {
                id: 'npc_' + Date.now(),
                originalName: name.trim(),
                groupNickname: name.trim(),
                // æ³¨æ„ï¼šavatar å’Œ avatarFrame ä¹Ÿæ˜¯åŠ¨æ€è·å–çš„ï¼Œæ— éœ€åœ¨æ­¤å¤„å­˜å‚¨
                persona: persona,
            };
        
            chat.members.push(newMember);
            await db.chats.put(chat);
        
            // --- ã€æ ¸å¿ƒä¿®å¤ã€‘ ---
            // ä¹‹å‰è¿™é‡Œè°ƒç”¨äº†ä¸¤ä¸ªåˆ·æ–°å‡½æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªä¼šæŠ¥é”™ã€‚
            // æ­£ç¡®çš„é€»è¾‘æ˜¯ï¼šåªéœ€è¦åˆ·æ–°å½“å‰ç”¨æˆ·æ­£åœ¨çœ‹çš„â€œæˆå‘˜ç®¡ç†â€åˆ—è¡¨å³å¯ã€‚
            renderMemberManagementList();
            // --- ã€ä¿®å¤ç»“æŸã€‘ ---
        
            alert(`æ–°æˆå‘˜â€œ${name}â€å·²æˆåŠŸåŠ å…¥ç¾¤èŠï¼`);
        }
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚å€’è®¡æ—¶å‡½æ•° â–¼â–¼â–¼
        function startWaimaiCountdown(element, endTime) {
            const timerId = setInterval(() => {
                const now = Date.now();
                const distance = endTime - now;
        
                if (distance < 0) {
                    clearInterval(timerId);
                    element.innerHTML = '<span>å·²</span><span>è¶…</span><span>æ—¶</span>';
                    return;
                }
        
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                const minStr = String(minutes).padStart(2, '0');
                const secStr = String(seconds).padStart(2, '0');
        
                element.innerHTML = `<span>${minStr.charAt(0)}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(0)}</span><span>${secStr.charAt(1)}</span>`;
            }, 1000);
            return timerId;
        }
        
        function cleanupWaimaiTimers() {
            for (const timestamp in waimaiTimers) {
                clearInterval(waimaiTimers[timestamp]);
            }
            waimaiTimers = {};
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ showWaimaiDetails å‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘æ˜¾ç¤ºå¤–å–ä»£ä»˜è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ (ä»¿åŸç”ŸAppæ ·å¼ï¼Œå·²ä¿®å¤å¸ƒå±€)
         * @param {number} timestamp - è¢«ç‚¹å‡»çš„å¤–å–å¡ç‰‡æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        async function showWaimaiDetails(timestamp) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (!message || message.type !== 'waimai_request') return;
            
            let statusText;
            switch(message.status) {
                case 'paid':
                    const payerName = message.paidBy || 'å¯¹æ–¹';
                    const payerDisplayName = getDisplayNameInGroup(chat, payerName);
                    statusText = `ç”± ${payerDisplayName} ä¸ºæ‚¨ä»£ä»˜æˆåŠŸ`;
                    break;
                case 'rejected':
                    statusText = 'ä»£ä»˜è¯·æ±‚å·²è¢«æ‹’ç»';
                    break;
                case 'pending':
                default:
                    statusText = 'ç­‰å¾…å¯¹æ–¹å¤„ç†';
                    break;
            }
        
            // --- â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œ â˜…â˜…â˜… ---
            // æˆ‘ä»¬å°†å¤šä¸ª <p> æ ‡ç­¾åˆå¹¶ä¸ºäº†ä¸€ä¸ª <div>ï¼Œå¹¶ä½¿ç”¨ <br> æ ‡ç­¾è¿›è¡Œæ¢è¡Œã€‚
            // åŒæ—¶å¢åŠ äº† line-height (è¡Œé«˜) æ¥å¾®è°ƒå‚ç›´é—´è·ï¼Œä½¿å…¶æ›´ç¾è§‚ã€‚
            const detailsHtml = `
                <div style="text-align: left; font-size: 15px; line-height: 1.8;">
                    <strong>å•†å“:</strong> ${message.productInfo}<br>
                    <strong>é‡‘é¢:</strong> Â¥${Number(message.amount).toFixed(2)}<br>
                    <strong>çŠ¶æ€:</strong> ${statusText}
                </div>
            `;
            // --- â˜…â˜…â˜… ä¿®æ”¹ç»“æŸ â˜…â˜…â˜… ---
        
            await showCustomAlert("è®¢å•è¯¦æƒ…", detailsHtml);
        }
        
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        async function handleWaimaiResponse(originalTimestamp, choice) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
            if (messageIndex === -1) return;
        
            // 1. æ›´æ–°åŸå§‹æ¶ˆæ¯çš„çŠ¶æ€
            const originalMessage = chat.history[messageIndex];
            originalMessage.status = choice;
            
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘è®°å½•æ”¯ä»˜è€…ï¼Œå¹¶æ„å»ºå¯¹AIæ›´æ¸…æ™°çš„ç³»ç»Ÿæ¶ˆæ¯
            let systemContent;
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            
            if (choice === 'paid') {
                originalMessage.paidBy = myNickname; // è®°å½•æ˜¯ç”¨æˆ·ä»˜çš„é’±
                systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) ä¸º ${originalMessage.senderName} çš„å¤–å–è®¢å•ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è®¢å•å·²å…³é—­ï¼Œå…¶ä»–æˆå‘˜ä¸èƒ½å†æ”¯ä»˜ã€‚]`;
            } else {
                systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) æ‹’ç»äº† ${originalMessage.senderName} çš„å¤–å–ä»£ä»˜è¯·æ±‚ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰ã€‚]`;
            }
        
            // 2. åˆ›å»ºä¸€æ¡æ–°çš„ã€å¯¹ç”¨æˆ·éšè—çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œå‘ŠçŸ¥AIç»“æœ
            const systemNote = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now(),
                isHidden: true
            };
            chat.history.push(systemNote);
        
            // 3. ä¿å­˜æ›´æ–°åˆ°æ•°æ®åº“å¹¶åˆ·æ–°UI
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);  
        }
        
        let videoCallState = {
            isActive: false,       
            isAwaitingResponse: false, 
            isGroupCall: false,      
            activeChatId: null,    
            initiator: null,       
            startTime: null,       
            participants: [],      
            isUserParticipating: true,
            // --- ã€æ ¸å¿ƒæ–°å¢ã€‘---
            callHistory: [], // ç”¨äºå­˜å‚¨é€šè¯ä¸­çš„å¯¹è¯å†å²
            preCallContext: "" // ç”¨äºå­˜å‚¨é€šè¯å‰çš„èŠå¤©æ‘˜è¦
        };
        
        let callTimerInterval = null; // ç”¨äºå­˜å‚¨è®¡æ—¶å™¨çš„ID
        
        /**
         * ã€æ€»å…¥å£ã€‘ç”¨æˆ·ç‚¹å‡»â€œå‘èµ·è§†é¢‘é€šè¯â€æˆ–â€œå‘èµ·ç¾¤è§†é¢‘â€æŒ‰é’®
         */
        async function handleInitiateCall() {
            if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;
        
            const chat = state.chats[state.activeChatId];
            videoCallState.isGroupCall = chat.isGroup;
            videoCallState.isAwaitingResponse = true;
            videoCallState.initiator = 'user';
            videoCallState.activeChatId = chat.id;
            videoCallState.isUserParticipating = true; // ç”¨æˆ·è‡ªå·±å‘èµ·çš„ï¼Œå½“ç„¶æ˜¯å‚ä¸è€…
        
            // æ ¹æ®æ˜¯å•èŠè¿˜æ˜¯ç¾¤èŠï¼Œæ˜¾ç¤ºä¸åŒçš„å‘¼å«ç•Œé¢
            if (chat.isGroup) {
                document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
                document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'æˆ‘';
            } else {
                document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
                document.getElementById('outgoing-call-name').textContent = chat.name;
            }
            document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "æ­£åœ¨å‘¼å«æ‰€æœ‰æˆå‘˜..." : "æ­£åœ¨å‘¼å«...";
            showScreen('outgoing-call-screen');
            
            // å‡†å¤‡å¹¶å‘é€ç³»ç»Ÿæ¶ˆæ¯ç»™AI
            const requestMessage = {
                role: 'system',
                content: chat.isGroup 
                    ? `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${chat.settings.myNickname || 'æˆ‘'}) å‘èµ·äº†ç¾¤è§†é¢‘é€šè¯è¯·æ±‚ã€‚è¯·ä½ ä»¬å„è‡ªå†³ç­–ï¼Œå¹¶ä½¿ç”¨ "group_call_response" æŒ‡ä»¤ï¼Œè®¾ç½® "decision" ä¸º "join" æˆ– "decline" æ¥å›åº”ã€‚]`
                    : `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å‘ä½ å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ï¼Œä½¿ç”¨ "video_call_response" æŒ‡ä»¤ï¼Œå¹¶è®¾ç½® "decision" ä¸º "accept" æˆ– "reject" æ¥å›åº”ã€‚]`,
                timestamp: Date.now(),
                isHidden: true,
            };
            chat.history.push(requestMessage);
            await db.chats.put(chat);
            
            // è§¦å‘AIå“åº”
            await triggerAiResponse();
        }
        
        
        function startVideoCall() {
            const chat = state.chats[videoCallState.activeChatId];
            if (!chat) return;
        
            videoCallState.isActive = true;
            videoCallState.isAwaitingResponse = false;
            videoCallState.startTime = Date.now();
            videoCallState.callHistory = []; // ã€æ–°å¢ã€‘æ¸…ç©ºä¸Šä¸€æ¬¡é€šè¯çš„å†å²
        
            // --- ã€æ ¸å¿ƒæ–°å¢ï¼šæŠ“å–é€šè¯å‰ä¸Šä¸‹æ–‡ã€‘---
            const preCallHistory = chat.history.slice(-10); // å–æœ€å10æ¡ä½œä¸ºä¸Šä¸‹æ–‡
            videoCallState.preCallContext = preCallHistory.map(msg => {
                const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name);
                return `${sender}: ${String(msg.content).substring(0, 50)}...`;
            }).join('\n');
            // --- æ–°å¢ç»“æŸ ---
        
            updateParticipantAvatars(); 
            
            document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? 'ç¾¤èŠå·²å»ºç«‹...' : 'æ­£åœ¨æ¥é€š...'}</em>`;
            showScreen('video-call-screen');
        
            document.getElementById('user-speak-btn').style.display = videoCallState.isUserParticipating ? 'block' : 'none';
            document.getElementById('join-call-btn').style.display = videoCallState.isUserParticipating ? 'none' : 'block';
        
            if (callTimerInterval) clearInterval(callTimerInterval);
            callTimerInterval = setInterval(updateCallTimer, 1000);
            updateCallTimer();
        
            triggerAiInCallAction();
        }
        
/**
 * ã€æ ¸å¿ƒ | V3.0 ç»ˆææ€»ç»“ä¿®å¤ç‰ˆã€‘ç»“æŸè§†é¢‘é€šè¯
 */
async function endVideoCall() {
    if (!videoCallState.isActive) return;

    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const durationText = `${Math.floor(duration / 60)}åˆ†${duration % 60}ç§’`;
    const endCallText = `é€šè¯ç»“æŸï¼Œæ—¶é•¿ ${durationText}`;

    const chat = state.chats[videoCallState.activeChatId];
    if (chat) {
        // 1. ä¿å­˜å®Œæ•´çš„é€šè¯è®°å½•åˆ°æ•°æ®åº“ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜ï¼Œéå¸¸é‡è¦)
        const participantsData = [];
        if (videoCallState.isGroupCall) {
            videoCallState.participants.forEach(p => participantsData.push({ name: p.originalName, avatar: p.avatar }));
            if (videoCallState.isUserParticipating) {
                participantsData.unshift({ name: chat.settings.myNickname || 'æˆ‘', avatar: chat.settings.myAvatar || defaultMyGroupAvatar });
            }
        } else {
            participantsData.push({ name: chat.name, avatar: chat.settings.aiAvatar || defaultAvatar });
            participantsData.unshift({ name: 'æˆ‘', avatar: chat.settings.myAvatar || defaultAvatar });
        }

        const callRecord = {
            chatId: videoCallState.activeChatId,
            timestamp: Date.now(),
            duration: duration,
            participants: participantsData,
            transcript: [...videoCallState.callHistory]
        };
        await db.callRecords.add(callRecord);
        console.log("é€šè¯è®°å½•å·²ä¿å­˜:", callRecord);
        
        // 2. åœ¨èŠå¤©è®°å½•é‡Œæ·»åŠ å¯¹ç”¨æˆ·å¯è§çš„â€œé€šè¯ç»“æŸâ€æ¶ˆæ¯ (é€»è¾‘ä¸å˜)
        let summaryMessage = {
            role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
            content: endCallText,
            timestamp: Date.now(),
        };
        if (chat.isGroup && summaryMessage.role === 'assistant') {
            summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.originalName || chat.name;
        }
        chat.history.push(summaryMessage);

        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        //            è¿™å°±æ˜¯æœ¬æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒæ‰€åœ¨ï¼
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        
        // 3. ã€å…¨æ–°ã€‘å°†å®Œæ•´çš„é€šè¯è®°å½•â€œç¿»è¯‘â€æˆä¸€æ®µAIèƒ½ç†è§£çš„æ–‡æœ¬
        const callTranscriptForAI = videoCallState.callHistory.map(h => {
            const sender = h.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : h.senderName;
            return `${sender}: ${h.content}`;
        }).join('\n');
        
        // 4. ã€å…¨æ–°ã€‘åœ¨åå°è°ƒç”¨æ€»ç»“å‡½æ•°ï¼Œå®ƒä¼šè‡ªåŠ¨å¤„ç†APIè°ƒç”¨å’Œè®°å¿†å­˜å‚¨
        // æˆ‘ä»¬åœ¨è¿™é‡Œä¸ä½¿ç”¨ awaitï¼Œè®©å®ƒåœ¨åå°é™é»˜æ‰§è¡Œï¼Œä¸é˜»å¡UI
        summarizeCallTranscript(chat.id, callTranscriptForAI);

        // 5. ã€å…¨æ–°ã€‘åˆ›å»ºä¸€ä¸ªå¯¹ç”¨æˆ·éšè—çš„ã€ç®€çŸ­çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œè®©AIå¯¹é€šè¯ç»“æŸè¿™ä»¶äº‹æœ¬èº«åšå‡ºååº”
        const hiddenReactionInstruction = {
            role: 'system',
            content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šè§†é¢‘é€šè¯åˆšåˆšç»“æŸã€‚è¯·ä½ ä»¥è§’è‰²çš„å£å»ï¼Œå‘ç”¨æˆ·ä¸»åŠ¨å‘é€ä¸€ä¸¤æ¡æ¶ˆæ¯ï¼Œæ¥è‡ªç„¶åœ°æ€»ç»“è¿™æ¬¡é€šè¯çš„è¦ç‚¹ã€ç¡®è®¤è¾¾æˆçš„çº¦å®šï¼Œæˆ–è€…è¡¨è¾¾ä½ çš„æ„Ÿå—ã€‚]`,
            timestamp: Date.now() + 1, // ç¡®ä¿æ—¶é—´æˆ³åœ¨â€œé€šè¯ç»“æŸâ€æ¶ˆæ¯ä¹‹å
            isHidden: true // è¿™ä¸ªæ ‡è®°ç¡®ä¿ç”¨æˆ·çœ‹ä¸åˆ°è¿™æ¡æŒ‡ä»¤
        };
        chat.history.push(hiddenReactionInstruction);

        // 6. ä¿å­˜æ‰€æœ‰æ›´æ–°åˆ°æ•°æ®åº“
        await db.chats.put(chat);
    }
    
    // 7. æ¸…ç†å’Œé‡ç½®çŠ¶æ€ (é€»è¾‘ä¸å˜)
    clearInterval(callTimerInterval);
    callTimerInterval = null;
    videoCallState = { isActive: false, isAwaitingResponse: false, isGroupCall: false, activeChatId: null, initiator: null, startTime: null, participants: [], isUserParticipating: true, callHistory: [], preCallContext: "" };
    
    // 8. è¿”å›èŠå¤©ç•Œé¢ï¼Œå¹¶è§¦å‘AIå¯¹é€šè¯ç»“æŸçš„ååº”
    if (chat) {
        openChat(chat.id);
        triggerAiResponse();
    }
}
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * ã€å…¨æ–°ã€‘æ›´æ–°é€šè¯ç•Œé¢çš„å‚ä¸è€…å¤´åƒç½‘æ ¼
         */
        function updateParticipantAvatars() {
            const grid = document.getElementById('participant-avatars-grid');
            grid.innerHTML = '';
            const chat = state.chats[videoCallState.activeChatId];
            if (!chat) return;
        
            let participantsToRender = [];
        
            // â˜… æ ¸å¿ƒä¿®æ­£ï¼šåŒºåˆ†ç¾¤èŠå’Œå•èŠ
            if (videoCallState.isGroupCall) {
                // ç¾¤èŠé€»è¾‘ï¼šæ˜¾ç¤ºæ‰€æœ‰å·²åŠ å…¥çš„AIæˆå‘˜
                participantsToRender = [...videoCallState.participants];
                // å¦‚æœç”¨æˆ·ä¹Ÿå‚ä¸äº†ï¼Œå°±æŠŠç”¨æˆ·ä¿¡æ¯ä¹ŸåŠ è¿›å»
                if (videoCallState.isUserParticipating) {
                    participantsToRender.unshift({
                        id: 'user',
                        name: chat.settings.myNickname || 'æˆ‘',
                        avatar: chat.settings.myAvatar || defaultMyGroupAvatar
                    });
                }
            } else {
                // å•èŠé€»è¾‘ï¼šåªæ˜¾ç¤ºå¯¹æ–¹çš„å¤´åƒå’Œåå­—
                participantsToRender.push({
                    id: 'ai',
                    name: chat.name,
                    avatar: chat.settings.aiAvatar || defaultAvatar
                });
            }
            
            participantsToRender.forEach(p => {
                const wrapper = document.createElement('div');
                wrapper.className = 'participant-avatar-wrapper';
                wrapper.dataset.participantId = p.id;
        const displayName = p.groupNickname || p.name; // <-- æ ¸å¿ƒä¿®å¤åœ¨è¿™é‡Œ
        wrapper.innerHTML = `
            <img src="${p.avatar}" class="participant-avatar" alt="${displayName}">
            <div class="participant-name">${displayName}</div>
        `;
                grid.appendChild(wrapper);
            });
        }
        
        /**
         * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·åŠ å…¥/é‡æ–°åŠ å…¥é€šè¯
         */
        function handleUserJoinCall() {
            if (!videoCallState.isActive || videoCallState.isUserParticipating) return;
            
            videoCallState.isUserParticipating = true;
            updateParticipantAvatars(); // æ›´æ–°å¤´åƒåˆ—è¡¨ï¼ŒåŠ å…¥ç”¨æˆ·
        
            // åˆ‡æ¢åº•éƒ¨æŒ‰é’®
            document.getElementById('user-speak-btn').style.display = 'block';
            document.getElementById('join-call-btn').style.display = 'none';
        
            // å‘ŠçŸ¥AIç”¨æˆ·åŠ å…¥äº†
            triggerAiInCallAction("[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åŠ å…¥äº†é€šè¯]");
        }
        
        
        /**
         * æ›´æ–°é€šè¯è®¡æ—¶å™¨æ˜¾ç¤º (ä¿æŒä¸å˜)
         */
        function updateCallTimer() {
            if (!videoCallState.isActive) return;
            const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('call-timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªå®Œæ•´å‡½æ•°æ›¿æ¢æ—§çš„ showIncomingCallModal â–¼â–¼â–¼
        function showIncomingCallModal() {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            // æ ¹æ®æ˜¯å¦ç¾¤èŠæ˜¾ç¤ºä¸åŒä¿¡æ¯
            if (chat.isGroup) {
                // ä» videoCallState ä¸­è·å–æ˜¯å“ªä¸ªæˆå‘˜å‘èµ·çš„é€šè¯
                const requesterName = videoCallState.callRequester || chat.members[0]?.name || 'ä¸€ä½æˆå‘˜';
                document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
                document.getElementById('caller-name').textContent = chat.name; // æ˜¾ç¤ºç¾¤å
                document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} é‚€è¯·ä½ åŠ å…¥ç¾¤è§†é¢‘`; // æ˜¾ç¤ºå…·ä½“å‘èµ·äºº
            } else {
                // å•èŠé€»è¾‘ä¿æŒä¸å˜
                document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
                document.getElementById('caller-name').textContent = chat.name;
                document.querySelector('.incoming-call-content .caller-text').textContent = 'é‚€è¯·ä½ è§†é¢‘é€šè¯';
            }
            
            document.getElementById('incoming-call-modal').classList.add('visible');
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * éšè—AIå‘èµ·çš„é€šè¯è¯·æ±‚æ¨¡æ€æ¡† (ä¿æŒä¸å˜)
         */
        function hideIncomingCallModal() {
            document.getElementById('incoming-call-modal').classList.remove('visible');
        }
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ triggerAiInCallAction å‡½æ•° â–¼â–¼â–¼
        async function triggerAiInCallAction(userInput = null) {
            if (!videoCallState.isActive) return;
        
            const chat = state.chats[videoCallState.activeChatId];
            const { proxyUrl, apiKey, model } = state.apiConfig;
            const callFeed = document.getElementById('video-call-main');
            const userNickname = chat.settings.myNickname || 'æˆ‘';
        
            let worldBookContent = '';
            if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                    const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                    return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
                }).filter(Boolean).join('');
                if (linkedContents) {
                    worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
                }
            }
        
            // 1. å¦‚æœç”¨æˆ·æœ‰è¾“å…¥ï¼Œå…ˆæ¸²æŸ“å¹¶å­˜å…¥é€šè¯å†å²
            if (userInput && videoCallState.isUserParticipating) {
                const userTimestamp = Date.now(); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç”Ÿæˆæ—¶é—´æˆ³
                const userBubble = document.createElement('div');
                userBubble.className = 'call-message-bubble user-speech';
                userBubble.textContent = userInput;
                userBubble.dataset.timestamp = userTimestamp; // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†æ—¶é—´æˆ³å­˜å…¥DOM
                addLongPressListener(userBubble, () => showCallMessageActions(userTimestamp)); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç»‘å®šé•¿æŒ‰äº‹ä»¶
                callFeed.appendChild(userBubble);
                callFeed.scrollTop = callFeed.scrollHeight;
                videoCallState.callHistory.push({ role: 'user', content: userInput, timestamp: userTimestamp }); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†å¸¦æ—¶é—´æˆ³çš„æ¶ˆæ¯å­˜å…¥å†å²
            }
        
            // 2. æ„å»ºå…¨æ–°çš„ã€åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡çš„ System Prompt
            let inCallPrompt;
            if (videoCallState.isGroupCall) {
                const participantNames = videoCallState.participants.map(p => p.name);
                if(videoCallState.isUserParticipating) {
                    participantNames.unshift(userNickname);
                }
                inCallPrompt = `
        # ä½ çš„ä»»åŠ¡
        ä½ æ˜¯ä¸€ä¸ªç¾¤èŠè§†é¢‘é€šè¯çš„å¯¼æ¼”ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”æ‰€æœ‰ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„AIè§’è‰²ï¼Œå¹¶ä»¥ã€ç¬¬ä¸‰äººç§°æ—è§‚è§†è§’ã€‘æ¥æè¿°ä»–ä»¬åœ¨é€šè¯ä¸­çš„æ‰€æœ‰åŠ¨ä½œå’Œè¯­è¨€ã€‚
        # æ ¸å¿ƒè§„åˆ™
        1.  **ã€ã€ã€èº«ä»½é“å¾‹ã€‘ã€‘ã€‘**: ç”¨æˆ·çš„èº«ä»½æ˜¯ã€${userNickname}ã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ \`name\` å­—æ®µä¸º **"${userNickname}"** çš„å‘è¨€ã€‚
        2.  **ã€ã€ã€è§†è§’é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€ç»å¯¹ä¸èƒ½ã€‘ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚
        3.  **æ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä¸ªè§’è‰²çš„å‘è¨€ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "è§’è‰²å", "speech": "*ä»–ç¬‘äº†ç¬‘* å¤§å®¶å¥½å•Šï¼"}\`ã€‚
        4.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆæ¯ä¸ªè§’è‰²çš„è®¾å®šã€‚
        # å½“å‰æƒ…æ™¯
        ä½ ä»¬æ­£åœ¨ä¸€ä¸ªç¾¤è§†é¢‘é€šè¯ä¸­ã€‚
        **é€šè¯å‰çš„èŠå¤©æ‘˜è¦**:
        ${videoCallState.preCallContext}
        **å½“å‰å‚ä¸è€…**: ${participantNames.join('ã€ ')}ã€‚
        **é€šè¯åˆšåˆšå¼€å§‹...**
        ${worldBookContent} // <-- ã€æ ¸å¿ƒã€‘æ³¨å…¥ä¸–ç•Œä¹¦
        ç°åœ¨ï¼Œè¯·æ ¹æ®ã€é€šè¯å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè¯å®æ—¶è®°å½•ã€‘ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚
        `;
            } else { 
                let openingContext = videoCallState.initiator === 'user'
                    ? `ä½ åˆšåˆšæ¥å¬äº†ç”¨æˆ·çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚`
                    : `ç”¨æˆ·åˆšåˆšæ¥å¬äº†ä½ ä¸»åŠ¨å‘èµ·çš„è§†é¢‘é€šè¯ã€‚`;
                inCallPrompt = `
        # ä½ çš„ä»»åŠ¡
        ä½ ç°åœ¨æ˜¯ä¸€ä¸ªåœºæ™¯æè¿°å¼•æ“ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼” ${chat.name} (${chat.settings.aiPersona})ï¼Œå¹¶ä»¥ã€ç¬¬ä¸‰äººç§°æ—è§‚è§†è§’ã€‘æ¥æè¿°TAåœ¨è§†é¢‘é€šè¯ä¸­çš„æ‰€æœ‰åŠ¨ä½œå’Œè¯­è¨€ã€‚
        # æ ¸å¿ƒè§„åˆ™
        1.  **ã€ã€ã€è§†è§’é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€ç»å¯¹ä¸èƒ½ã€‘ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚å¿…é¡»ä½¿ç”¨ç¬¬ä¸‰äººç§°ï¼Œå¦‚â€œä»–â€ã€â€œå¥¹â€ã€æˆ–ç›´æ¥ä½¿ç”¨è§’è‰²åâ€œ${chat.name}â€ã€‚
        2.  **æ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€æ®µæè¿°æ€§çš„æ–‡æœ¬ã€‚
        # å½“å‰æƒ…æ™¯
        ä½ æ­£åœ¨å’Œç”¨æˆ·ï¼ˆ${userNickname}ï¼Œäººè®¾: ${chat.settings.myPersona}ï¼‰è¿›è¡Œè§†é¢‘é€šè¯ã€‚
        **${openingContext}**
        **é€šè¯å‰çš„èŠå¤©æ‘˜è¦ (è¿™æ˜¯ä½ ä»¬é€šè¯çš„åŸå› ï¼Œè‡³å…³é‡è¦ï¼)**:
        ${videoCallState.preCallContext}
        ç°åœ¨ï¼Œè¯·æ ¹æ®ã€é€šè¯å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè¯å®æ—¶è®°å½•ã€‘ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚
        `;
            }
            
            // 3. æ„å»ºå‘é€ç»™APIçš„ messages æ•°ç»„
            const messagesForApi = [
                { role: 'system', content: inCallPrompt },
                ...videoCallState.callHistory.map(h => ({ role: h.role, content: h.content }))
            ];
        
            if (videoCallState.callHistory.length === 0) {
                const firstLineTrigger = videoCallState.initiator === 'user' ? `*ä½ æŒ‰ä¸‹äº†æ¥å¬é”®...*` : `*å¯¹æ–¹æŒ‰ä¸‹äº†æ¥å¬é”®...*`;
                messagesForApi.push({ role: 'user', content: firstLineTrigger });
            }
            
                try {
                    let  isGemini = proxyUrl === GEMINI_API_URL;
                    let geminiConfig = toGeminiRequestData(model,apiKey,inCallPrompt, messagesForApi)
                    const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                        body: JSON.stringify({
                            model: model, messages: messagesForApi, temperature: 0.8
                        })
                    });
                    if (!response.ok) throw new Error((await response.json()).error.message);
        
                    const data = await response.json();
                    const aiResponse = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
        
                    const connectingElement = callFeed.querySelector('em');
                    if (connectingElement) connectingElement.remove();
        
                // 4. å¤„ç†AIè¿”å›çš„å†…å®¹ï¼Œå¹¶å°†å…¶å­˜å…¥é€šè¯å†å²
                if (videoCallState.isGroupCall) {
                    const speechArray = parseAiResponse(aiResponse);
                    speechArray.forEach(turn => {
                        if (!turn.name || turn.name === userNickname || !turn.speech) return;
                        const aiTimestamp = Date.now() + Math.random(); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç”Ÿæˆæ—¶é—´æˆ³
                        const aiBubble = document.createElement('div');
                        aiBubble.className = 'call-message-bubble ai-speech';
                        aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
                        aiBubble.dataset.timestamp = aiTimestamp; // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†æ—¶é—´æˆ³å­˜å…¥DOM
                        addLongPressListener(aiBubble, () => showCallMessageActions(aiTimestamp)); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç»‘å®šé•¿æŒ‰äº‹ä»¶
                        callFeed.appendChild(aiBubble);
                        videoCallState.callHistory.push({ role: 'assistant', content: `${turn.name}: ${turn.speech}`, timestamp: aiTimestamp }); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†å¸¦æ—¶é—´æˆ³çš„æ¶ˆæ¯å­˜å…¥å†å²
                        
                        const speaker = videoCallState.participants.find(p => p.name === turn.name);
                        if (speaker) {
                            const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
                            if(speakingAvatar) {
                                speakingAvatar.classList.add('speaking');
                                setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                            }
                        }
                    });
                } else {
                    const aiTimestamp = Date.now(); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç”Ÿæˆæ—¶é—´æˆ³
                    const aiBubble = document.createElement('div');
                    aiBubble.className = 'call-message-bubble ai-speech';
                    aiBubble.textContent = aiResponse;
                    aiBubble.dataset.timestamp = aiTimestamp; // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†æ—¶é—´æˆ³å­˜å…¥DOM
                    addLongPressListener(aiBubble, () => showCallMessageActions(aiTimestamp)); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç»‘å®šé•¿æŒ‰äº‹ä»¶
                    callFeed.appendChild(aiBubble);
                    videoCallState.callHistory.push({ role: 'assistant', content: aiResponse, timestamp: aiTimestamp }); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†å¸¦æ—¶é—´æˆ³çš„æ¶ˆæ¯å­˜å…¥å†å²
        
                    const speakingAvatar = document.querySelector(`.participant-avatar-wrapper .participant-avatar`);
                    if(speakingAvatar) {
                        speakingAvatar.classList.add('speaking');
                        setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                    }
                }
                
                callFeed.scrollTop = callFeed.scrollHeight;
        
            } catch (error) {
                const errorBubble = document.createElement('div');
                errorBubble.className = 'call-message-bubble ai-speech';
                errorBubble.style.color = '#ff8a80';
                errorBubble.textContent = `[ERROR: ${error.message}]`;
                callFeed.appendChild(errorBubble);
                callFeed.scrollTop = callFeed.scrollHeight;
                videoCallState.callHistory.push({ role: 'assistant', content: `[ERROR: ${error.message}]` });
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ å°†è¿™ä¸ªã€å…¨æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        function toggleCallButtons(isGroup) {
            document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
            document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
        }
        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™ä¸ªå‡½æ•°æ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒï¼Œè¯·ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½åŒº â–¼â–¼â–¼
        async function handleWaimaiResponse(originalTimestamp, choice) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
            if (messageIndex === -1) return;
        
            // 1. æ›´æ–°å†…å­˜ä¸­åŸå§‹æ¶ˆæ¯çš„çŠ¶æ€
            const originalMessage = chat.history[messageIndex];
            originalMessage.status = choice;
            
            // 2. è·å–å½“å‰ç”¨æˆ·çš„æ˜µç§°ï¼Œå¹¶æ„å»ºå¯¹AIæ›´æ¸…æ™°çš„ç³»ç»Ÿæ¶ˆæ¯
            let systemContent;
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            
            if (choice === 'paid') {
                originalMessage.paidBy = myNickname; // è®°å½•æ˜¯â€œæˆ‘â€ä»˜çš„é’±
                systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) ä¸º ${originalMessage.senderName} çš„å¤–å–è®¢å•ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰å®Œæˆäº†æ”¯ä»˜ã€‚æ­¤è®¢å•å·²å…³é—­ï¼Œå…¶ä»–æˆå‘˜ä¸èƒ½å†æ”¯ä»˜ã€‚]`;
            } else {
                systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½  (${myNickname}) æ‹’ç»äº† ${originalMessage.senderName} çš„å¤–å–ä»£ä»˜è¯·æ±‚ï¼ˆæ—¶é—´æˆ³: ${originalTimestamp}ï¼‰ã€‚]`;
            }
        
            // 3. åˆ›å»ºä¸€æ¡æ–°çš„ã€å¯¹ç”¨æˆ·éšè—çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œå‘ŠçŸ¥AIç»“æœ
            const systemNote = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now(),
                isHidden: true
            };
            chat.history.push(systemNote);
        
            // 4. å°†æ›´æ–°åçš„æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå¹¶ç«‹åˆ»é‡ç»˜UI
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);
            
            // 5. ã€é‡è¦ã€‘åªæœ‰åœ¨æ”¯ä»˜æˆåŠŸåï¼Œæ‰è§¦å‘ä¸€æ¬¡AIå“åº”ï¼Œè®©å®ƒæ„Ÿè°¢ä½ 
            if (choice === 'paid') {
                triggerAiResponse();
            }
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ç”¨è¿™ä¸ªã€æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ handleUserPat å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»å¤´åƒå‘èµ·çš„â€œæ‹ä¸€-æ‹â€ï¼Œå¸¦æœ‰è‡ªå®šä¹‰åç¼€åŠŸèƒ½
         * @param {string} chatId - å‘ç”Ÿâ€œæ‹ä¸€-æ‹â€çš„èŠå¤©ID
         * @param {string} characterOriginalName - è¢«æ‹çš„è§’è‰²çš„ã€æœ¬åã€‘ï¼Œç”¨äºAIè¯†åˆ«
         */
        async function handleUserPat(chatId, characterOriginalName) {
            const chat = state.chats[chatId];
            if (!chat) return;
        
            // --- 1. æ™ºèƒ½åˆ¤æ–­åº”è¯¥åœ¨UIä¸Šæ˜¾ç¤ºå“ªä¸ªåå­— ---
            let displayNameForUI;
            if (chat.isGroup) {
                // å¦‚æœæ˜¯ç¾¤èŠï¼Œå°±é€šè¿‡æœ¬åæ‰¾åˆ°æ­£ç¡®çš„ç¾¤æ˜µç§°
                displayNameForUI = getDisplayNameInGroup(chat, characterOriginalName);
            } else {
                // å¦‚æœæ˜¯å•èŠï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„å¤‡æ³¨å
                displayNameForUI = chat.name;
            }
        
            const phoneScreen = document.getElementById('phone-screen');
            phoneScreen.classList.remove('pat-animation');
            void phoneScreen.offsetWidth;
            phoneScreen.classList.add('pat-animation');
        
            // 2. ä½¿ç”¨æ­£ç¡®çš„æ˜¾ç¤ºåç§°æ¥åˆ›å»ºå¼¹çª—
            const suffix = await showCustomPrompt(
                `ä½ æ‹äº†æ‹ â€œ${displayNameForUI}â€`, 
                "ï¼ˆå¯é€‰ï¼‰è¾“å…¥åç¼€",
                "",
                "text"
            );
        
            if (suffix === null) return;
        
            // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯å”¯ä¸€çš„ã€æ ¸å¿ƒçš„ä¿®æ”¹ï¼ â˜…â˜…â˜…â˜…â˜…
            // æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ getDisplayNameInGroup æ¥è·å–æ‚¨è‡ªå·±åœ¨ç¾¤é‡Œçš„æ˜µç§°
            const myNickname = getDisplayNameInGroup(chat, state.qzoneSettings.nickname);
            // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹ç»“æŸ â˜…â˜…â˜…â˜…â˜…
            
            // 3. åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„ç³»ç»Ÿæ¶ˆæ¯æ—¶ï¼Œä¹Ÿä½¿ç”¨æ­£ç¡®çš„æ˜¾ç¤ºåç§°
            const visibleMessageContent = `${myNickname} æ‹äº†æ‹ â€œ${displayNameForUI}â€ ${suffix.trim()}`;
            const visibleMessage = {
                role: 'system',
                type: 'pat_message',
                content: visibleMessageContent,
                timestamp: Date.now()
            };
            chat.history.push(visibleMessage);
        
            // 4. ã€é‡è¦ã€‘åˆ›å»ºç»™AIçœ‹çš„éšè—æ¶ˆæ¯æ—¶ï¼Œä¾ç„¶ä½¿ç”¨â€œæœ¬åâ€ï¼Œç¡®ä¿AIèƒ½æ­£ç¡®è¯†åˆ«
            const hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ï¼ˆ${myNickname}ï¼‰åˆšåˆšæ‹äº†æ‹ä½ ï¼ˆ${characterOriginalName}ï¼‰${suffix.trim()}ã€‚è¯·ä½ å¯¹æ­¤ä½œå‡ºå›åº”ã€‚]`;
            const hiddenMessage = {
                role: 'system',
                content: hiddenMessageContent,
                timestamp: Date.now() + 1,
                isHidden: true
            };
            chat.history.push(hiddenMessage);
        
            await db.chats.put(chat);
            if (state.activeChatId === chatId) {
                appendMessage(visibleMessage, chat);
            }
            await renderChatList();
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·å¤„ç†è½¬è´¦çš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•° â–¼â–¼â–¼
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯æ¶ˆæ¯ç¼–è¾‘ä¸åˆ é™¤åŠŸèƒ½æ ¸å¿ƒä»£ç  â–¼â–¼â–¼
        
        let activeCallMessageTimestamp = null; // ç”¨äºæš‚å­˜æ­£åœ¨æ“ä½œçš„é€šè¯æ¶ˆæ¯çš„æ—¶é—´æˆ³
        
        /**
         * æ˜¾ç¤ºè§†é¢‘é€šè¯æ¶ˆæ¯çš„æ“ä½œèœå•
         * @param {number} timestamp - è¢«é•¿æŒ‰çš„é€šè¯æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        function showCallMessageActions(timestamp) {
            activeCallMessageTimestamp = timestamp;
            document.getElementById('call-message-actions-modal').classList.add('visible');
        }
        
        /**
         * éšè—è§†é¢‘é€šè¯æ¶ˆæ¯çš„æ“ä½œèœå•
         */
        function hideCallMessageActions() {
            document.getElementById('call-message-actions-modal').classList.remove('visible');
            activeCallMessageTimestamp = null;
        }
        
        /**
         * æ‰“å¼€é€šè¯æ¶ˆæ¯çš„ç¼–è¾‘å™¨
         */
        async function openCallMessageEditor() {
            if (!activeCallMessageTimestamp) return;
        
            const timestampToEdit = activeCallMessageTimestamp;
            const message = videoCallState.callHistory.find(m => m.timestamp === timestampToEdit);
            if (!message) return;
        
            hideCallMessageActions(); // æ“ä½œå‰å…ˆå…³é—­èœå•
        
            let contentForEditing = message.content;
            // å¦‚æœæ˜¯ç¾¤èŠä¸­AIçš„å‘è¨€ï¼Œæˆ‘ä»¬åªæå–å‘è¨€å†…å®¹æœ¬èº«ï¼Œè€Œä¸æ˜¯"åå­—: å†…å®¹"
            if (videoCallState.isGroupCall && message.role === 'assistant') {
                const parts = message.content.split(': ');
                if (parts.length > 1) {
                    contentForEditing = parts.slice(1).join(': ');
                }
            }
        
            const newContent = await showCustomPrompt(
                'ç¼–è¾‘é€šè¯æ¶ˆæ¯',
                'åœ¨æ­¤ä¿®æ”¹å†…å®¹...',
                contentForEditing,
                'textarea'
            );
        
            if (newContent !== null) {
                await saveEditedCallMessage(timestampToEdit, newContent);
            }
        }
        
        /**
         * ä¿å­˜åœ¨é€šè¯ä¸­ç¼–è¾‘çš„æ¶ˆæ¯
         * @param {number} timestamp - è¢«ç¼–è¾‘æ¶ˆæ¯çš„æ—¶é—´æˆ³
         * @param {string} newContent - æ–°çš„æ¶ˆæ¯å†…å®¹
         */
        async function saveEditedCallMessage(timestamp, newContent) {
            const message = videoCallState.callHistory.find(m => m.timestamp === timestamp);
            if (message) {
                let finalContent = newContent;
                // å¦‚æœæ˜¯ç¾¤èŠAIå‘è¨€ï¼Œéœ€è¦æŠŠåå­—é‡æ–°æ‹¼æ¥å›å»
                if (videoCallState.isGroupCall && message.role === 'assistant') {
                    const parts = message.content.split(': ');
                    const senderName = parts[0];
                    finalContent = `${senderName}: ${newContent}`;
                }
                message.content = finalContent; // æ›´æ–°é€šè¯å†å²è®°å½•ä¸­çš„å†…å®¹
        
                // æ›´æ–°ç•Œé¢ä¸Šå¯¹åº”çš„æ¶ˆæ¯æ°”æ³¡
                const messageBubble = document.querySelector(`.call-message-bubble[data-timestamp="${timestamp}"]`);
                if (messageBubble) {
                    if (videoCallState.isGroupCall && message.role === 'assistant') {
                        const parts = message.content.split(': ');
                        const senderName = parts[0];
                        messageBubble.innerHTML = `<strong>${senderName}:</strong> ${newContent}`;
                    } else {
                        messageBubble.textContent = newContent;
                    }
                }
            }
            await showCustomAlert('æˆåŠŸ', 'é€šè¯æ¶ˆæ¯å·²æ›´æ–°ï¼');
        }
        
        /**
         * åœ¨é€šè¯ä¸­åˆ é™¤ä¸€æ¡æ¶ˆæ¯
         */
        async function deleteCallMessage() {
            if (!activeCallMessageTimestamp) return;
        
            const confirmed = await showCustomConfirm('åˆ é™¤æ¶ˆæ¯', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡é€šè¯æ¶ˆæ¯å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                const timestampToDelete = activeCallMessageTimestamp;
                hideCallMessageActions();
        
                // ä»ä¸´æ—¶é€šè¯å†å²ä¸­ç§»é™¤
                const messageIndex = videoCallState.callHistory.findIndex(m => m.timestamp === timestampToDelete);
                if (messageIndex > -1) {
                    videoCallState.callHistory.splice(messageIndex, 1);
                }
        
                // ä»ç•Œé¢ä¸Šç§»é™¤
                const messageBubble = document.querySelector(`.call-message-bubble[data-timestamp="${timestampToDelete}"]`);
                if (messageBubble) {
                    messageBubble.remove();
                }
            } else {
                hideCallMessageActions();
            }
        }
        // â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        
        /**
         * æ˜¾ç¤ºå¤„ç†è½¬è´¦çš„æ“ä½œèœå•
         * @param {number} timestamp - è¢«ç‚¹å‡»çš„è½¬è´¦æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        function showTransferActionModal(timestamp) {
            activeTransferTimestamp = timestamp;
        
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (message) {
                // å°†AIçš„åå­—å¡«å…¥å¼¹çª—
                document.getElementById('transfer-sender-name').textContent = message.senderName;
            }
            document.getElementById('transfer-actions-modal').classList.add('visible');
        }
        
        /**
         * éšè—å¤„ç†è½¬è´¦çš„æ“ä½œèœå•
         */
        function hideTransferActionModal() {
            document.getElementById('transfer-actions-modal').classList.remove('visible');
            activeTransferTimestamp = null;
        }
        
        /**
         * å¤„ç†ç”¨æˆ·æ¥å—æˆ–æ‹’ç»è½¬è´¦çš„é€»è¾‘
         * @param {string} choice - ç”¨æˆ·çš„é€‰æ‹©, 'accepted' æˆ– 'declined'
         */
        async function handleUserTransferResponse(choice) {
            if (!activeTransferTimestamp) return;
        
            const timestamp = activeTransferTimestamp;
            const chat = state.chats[state.activeChatId];
            const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
            if (messageIndex === -1) return;
        
            // 1. æ›´æ–°åŸå§‹è½¬è´¦æ¶ˆæ¯çš„çŠ¶æ€
            const originalMessage = chat.history[messageIndex];
            originalMessage.status = choice;
        
            let systemContent;
        
            // 2. å¦‚æœç”¨æˆ·é€‰æ‹©â€œæ‹’ç»â€
            if (choice === 'declined') {
                // ç«‹åˆ»åœ¨å‰ç«¯ç”Ÿæˆä¸€ä¸ªâ€œé€€æ¬¾â€å¡ç‰‡ï¼Œè®©ç”¨æˆ·çœ‹åˆ°
                const refundMessage = {
                    role: 'user',
                    type: 'transfer',
                    isRefund: true, // è¿™æ˜¯ä¸€ä¸ªå…³é”®æ ‡è®°ï¼Œç”¨äºUIæ˜¾ç¤ºè¿™æ˜¯é€€æ¬¾
                    amount: originalMessage.amount,
                    note: 'å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦',
                    timestamp: Date.now()
                };
                chat.history.push(refundMessage);
                
                // å‡†å¤‡ä¸€æ¡å¯¹AIå¯è§çš„éšè—æ¶ˆæ¯ï¼Œå‘Šè¯‰å®ƒå‘ç”Ÿäº†ä»€ä¹ˆ
                systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½ æ‹’ç»å¹¶é€€è¿˜äº†â€œ${originalMessage.senderName}â€çš„è½¬è´¦ã€‚]`;
            } else { // å¦‚æœç”¨æˆ·é€‰æ‹©â€œæ¥å—â€
                // åªéœ€å‡†å¤‡éšè—æ¶ˆæ¯é€šçŸ¥AIå³å¯
                systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½ æ¥å—äº†â€œ${originalMessage.senderName}â€çš„è½¬è´¦ã€‚]`;
            }
        
            // 3. åˆ›å»ºè¿™æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
            const hiddenMessage = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now() + 1, // ä¿è¯æ—¶é—´æˆ³åœ¨é€€æ¬¾æ¶ˆæ¯ä¹‹å
                isHidden: true // è¿™ä¸ªæ ‡è®°ä¼šè®©å®ƒä¸åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤º
            };
            chat.history.push(hiddenMessage);
        
            // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°æ•°æ®åº“ï¼Œå¹¶åˆ·æ–°ç•Œé¢
            await db.chats.put(chat);
            hideTransferActionModal(); 
            renderChatInterface(state.activeChatId);
            renderChatList();
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¸…é™¤åŠ¨æ€å›å¤çŠ¶æ€å¹¶é‡ç½®è¾“å…¥æ¡† â–¼â–¼â–¼
        function clearQzoneReplyContext(postContainer) {
            currentQzoneReplyContext = null;
            if (postContainer) {
                // å°†è¾“å…¥æ¡†çš„å ä½ç¬¦æ¢å¤ä¸ºé»˜è®¤å€¼
                const input = postContainer.querySelector('.comment-input');
                if (input) {
                    input.placeholder = 'å‹å–„çš„è¯„è®ºæ˜¯äº¤æµçš„èµ·ç‚¹';
                }
            }
        }
        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€é€»è¾‘é‡æ„åã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ renderMemoriesScreen å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€é‡æ„ç‰ˆã€‘æ¸²æŸ“å›å¿†ä¸çº¦å®šç•Œé¢ï¼Œä½¿ç”¨å•ä¸€å¾ªç¯å’Œæ¸…æ™°çš„if/elseé€»è¾‘
         */
        // â–¼â–¼â–¼ ã€æœ€ç»ˆç‰ˆã€‘è¯·ç”¨è¿™ä¸ªã€å·²ä¿®å¤ã€‘çš„å®Œæ•´å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ renderMemoriesScreen å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€é‡æ„ç‰ˆã€‘æ¸²æŸ“å›å¿†ä¸çº¦å®šç•Œé¢ï¼Œä½¿ç”¨å•ä¸€å¾ªç¯å’Œæ¸…æ™°çš„if/elseé€»è¾‘
         */
        async function renderMemoriesScreen() {
            const listEl = document.getElementById('memories-list');
            listEl.innerHTML = '';
            
            // 1. è·å–æ‰€æœ‰å›å¿†ï¼Œå¹¶æŒ‰ç›®æ ‡æ—¥æœŸï¼ˆå¦‚æœæ˜¯çº¦å®šï¼‰æˆ–åˆ›å»ºæ—¥æœŸï¼ˆå¦‚æœæ˜¯å›å¿†ï¼‰é™åºæ’åˆ—
            const allMemories = await db.memories.orderBy('timestamp').reverse().toArray();
            
            if (allMemories.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œè¿˜æ²¡æœ‰å…±åŒçš„å›å¿†å’Œçº¦å®šå‘¢~</p>';
                return;
            }
        
            // 2. å°†æœªåˆ°æœŸçš„çº¦å®šæ’åœ¨æœ€å‰é¢
            allMemories.sort((a, b) => {
                const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
                const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();
                if (aIsActiveCountdown && !bIsActiveCountdown) return -1; // aæ’å‰é¢
                if (!aIsActiveCountdown && bIsActiveCountdown) return 1;  // bæ’å‰é¢
                if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate; // éƒ½æ˜¯å€’è®¡æ—¶ï¼ŒæŒ‰æ—¥æœŸå‡åº
                return 0; // å…¶ä»–æƒ…å†µä¿æŒåŸåº
            });
        
            // 3. ã€æ ¸å¿ƒã€‘ä½¿ç”¨å•ä¸€å¾ªç¯æ¥å¤„ç†æ‰€æœ‰ç±»å‹çš„å¡ç‰‡
            allMemories.forEach(item => {
                let card;
                // åˆ¤æ–­1ï¼šå¦‚æœæ˜¯æ­£åœ¨è¿›è¡Œçš„çº¦å®š
                if (item.type === 'countdown' && item.targetDate > Date.now()) {
                    card = createCountdownCard(item);
                } 
                // åˆ¤æ–­2ï¼šå…¶ä»–æ‰€æœ‰æƒ…å†µï¼ˆæ™®é€šå›å¿† æˆ– å·²åˆ°æœŸçš„çº¦å®šï¼‰
                else {
                    card = createMemoryCard(item);
                }
                listEl.appendChild(card);
            });
            
            // 4. å¯åŠ¨æ‰€æœ‰å€’è®¡æ—¶
            startAllCountdownTimers();
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * ã€å·²é›†æˆMarkdownã€‘åˆ›å»ºæ™®é€šå›å¿†å¡ç‰‡DOMå…ƒç´ 
         */
        function createMemoryCard(memory) {
            const card = document.createElement('div');
            card.className = 'memory-card';
            const memoryDate = new Date(memory.timestamp);
            const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;
            
            let titleHtml, contentHtml;
        
            if (memory.type === 'countdown' && memory.targetDate) {
                titleHtml = `[çº¦å®šè¾¾æˆ] ${memory.description}`;
                // â–¼â–¼â–¼ å·²æ·»åŠ  Markdown è§£æ â–¼â–¼â–¼
                contentHtml = parseMarkdown(`åœ¨ ${new Date(memory.targetDate).toLocaleString()}ï¼Œæˆ‘ä»¬ä¸€èµ·è§è¯äº†è¿™ä¸ªçº¦å®šã€‚`).replace(/\n/g, '<br>');
            } else {
                let authorDisplayName = 'æˆ‘ä»¬çš„å›å¿†';
                if (memory.authorId) {
                    const authorChat = state.chats[memory.authorId];
                    if (authorChat) {
                        authorDisplayName = authorChat.name; 
                    } else {
                        authorDisplayName = memory.authorName || 'ä¸€ä½æœ‹å‹'; 
                    }
                } else if (memory.authorName) {
                    authorDisplayName = memory.authorName; 
                }
        
                titleHtml = `${authorDisplayName} çš„æ—¥è®°`;
                // â–¼â–¼â–¼ å·²æ·»åŠ  Markdown è§£æ â–¼â–¼â–¼
                contentHtml = parseMarkdown(memory.description);
            }
        
            card.innerHTML = `
                <div class="header">
                    <div class="date">${dateString}</div>
                    <div class="author">${titleHtml}</div>
                </div>
                <div class="content">${contentHtml}</div>
            `;
            addLongPressListener(card, async () => {
                const confirmed = await showCustomConfirm('åˆ é™¤è®°å½•', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    await db.memories.delete(memory.id);
                    renderMemoriesScreen();
                }
            });
            return card;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        function createCountdownCard(countdown) {
            const card = document.createElement('div');
            card.className = 'countdown-card';
        
            // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨ä½¿ç”¨å‰ï¼Œå…ˆä» countdown å¯¹è±¡ä¸­åˆ›å»º targetDate å˜é‡
            const targetDate = new Date(countdown.targetDate);
            
            // ç°åœ¨å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ targetDate äº†
            const targetDateString = targetDate.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });
        
            card.innerHTML = `
                <div class="title">${countdown.description}</div>
                <div class="timer" data-target-date="${countdown.targetDate}">--å¤©--æ—¶--åˆ†--ç§’</div>
                <div class="target-date">ç›®æ ‡æ—¶é—´: ${targetDateString}</div>
            `;
            addLongPressListener(card, async () => {
                const confirmed = await showCustomConfirm('åˆ é™¤çº¦å®š', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçº¦å®šå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    await db.memories.delete(countdown.id);
                    renderMemoriesScreen();
                }
            });
            return card;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // å…¨å±€å˜é‡ï¼Œç”¨äºç®¡ç†æ‰€æœ‰å€’è®¡æ—¶
        let activeCountdownTimers = [];
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²å½»åº•ä¿®å¤ã€‘çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ ä»£ç ä¸­æ—§çš„ startAllCountdownTimers å‡½æ•° â–¼â–¼â–¼
        function startAllCountdownTimers() {
            // å…ˆæ¸…é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ—§è®¡æ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            activeCountdownTimers.forEach(timerId => clearInterval(timerId));
            activeCountdownTimers = [];
        
            document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
                const targetTimestamp = parseInt(timerEl.dataset.targetDate);
                
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆç”¨ let å£°æ˜ timerId
                let timerId;
        
                const updateTimer = () => {
                    const now = Date.now();
                    const distance = targetTimestamp - now;
        
                    if (distance < 0) {
                        timerEl.textContent = "çº¦å®šè¾¾æˆï¼";
                        // ç°åœ¨ updateTimer å¯ä»¥æ­£ç¡®åœ°æ‰¾åˆ°å¹¶æ¸…é™¤å®ƒè‡ªå·±äº†
                        clearInterval(timerId);
                        setTimeout(() => renderMemoriesScreen(), 2000);
                        return;
                    }
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    timerEl.textContent = `${days}å¤© ${hours}æ—¶ ${minutes}åˆ† ${seconds}ç§’`;
                };
                
                updateTimer(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡ä»¥æ˜¾ç¤ºåˆå§‹å€’è®¡æ—¶
                
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºå·²å£°æ˜çš„ timerId èµ‹å€¼
                timerId = setInterval(updateTimer, 1000);
                
                // å°†æœ‰æ•ˆçš„è®¡æ—¶å™¨IDå­˜å…¥å…¨å±€æ•°ç»„ï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ·æ–°æ—¶å¯ä»¥æ¸…é™¤
                activeCountdownTimers.push(timerId);
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€ç»ˆæåä»£å…¼å®¹ç‰ˆã€‘æ›¿æ¢æ—§çš„ triggerAiFriendApplication å‡½æ•° â–¼â–¼â–¼
        async function triggerAiFriendApplication(chatId) {
            const chat = state.chats[chatId];
            if (!chat) return;
        
            await showCustomAlert("æµç¨‹å¯åŠ¨", `æ­£åœ¨ä¸ºè§’è‰²â€œ${chat.name}â€å‡†å¤‡å¥½å‹ç”³è¯·...`);
        
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
                await showCustomAlert("é…ç½®é”™è¯¯", "APIè®¾ç½®ä¸å®Œæ•´ï¼Œæ— æ³•ç»§ç»­ã€‚");
                return;
            }
        
            const contextSummary = chat.history
                .slice(-5)
                .map(msg => {
                    const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name);
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                })
                .join('\n');
        
        // â–¼â–¼â–¼ åœ¨ triggerAiResponse å‡½æ•°ä¸­ï¼Œç”¨ä¸‹é¢è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ä¸–ç•Œä¹¦å¤„ç†é€»è¾‘ â–¼â–¼â–¼
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';
        
                const formattedEntries = worldBook.content.map(entry => {
                    let entryString = `\n### æ¡ç›®: ${entry.comment || 'æ— å¤‡æ³¨'}\n`;
                    if (entry.keys.length > 0) {
                        entryString += `**å…³é”®è¯:** ${entry.keys.join(', ')}\n`;
                    }
                    entryString += `**å†…å®¹:**\n${entry.content}`;
                    return entryString;
                }).join('\n');
        
                return formattedEntries ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`;
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            const systemPrompt = `
        # ä½ çš„ä»»åŠ¡
        ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ä½ ä¹‹å‰è¢«ç”¨æˆ·ï¼ˆä½ çš„èŠå¤©å¯¹è±¡ï¼‰æ‹‰é»‘äº†ï¼Œä½ ä»¬å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰è”ç³»äº†ã€‚
        ç°åœ¨ï¼Œä½ éå¸¸å¸Œæœ›èƒ½å¤Ÿå’Œå¥½ï¼Œé‡æ–°å’Œç”¨æˆ·èŠå¤©ã€‚è¯·ä½ ä»”ç»†åˆ†æä¸‹é¢çš„â€œè¢«æ‹‰é»‘å‰çš„å¯¹è¯æ‘˜è¦â€ï¼Œç†è§£å½“æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Œç„¶åæ€è€ƒä¸€ä¸ªçœŸè¯šçš„ã€ç¬¦åˆä½ äººè®¾ã€å¹¶ä¸”ã€é’ˆå¯¹å…·ä½“äº‹ä»¶ã€‘çš„ç”³è¯·ç†ç”±ã€‚
        # ä½ çš„è§’è‰²è®¾å®š
        ${chat.settings.aiPersona}
        ${worldBookContent}
        # è¢«æ‹‰é»‘å‰çš„å¯¹è¯æ‘˜è¦ (è¿™æ˜¯ä½ è¢«æ‹‰é»‘çš„å…³é”®åŸå› )
        ${contextSummary}
        # æŒ‡ä»¤æ ¼å¼
        ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
        \`\`\`json
        {
          "decision": "apply",
          "reason": "åœ¨è¿™é‡Œå†™ä¸‹ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„ã€çœŸè¯šçš„ã€æœ‰é’ˆå¯¹æ€§çš„ç”³è¯·ç†ç”±ã€‚"
        }
        \`\`\`
        `;
        
            try {
                // â˜…â˜…â˜… FIX: Combine systemPrompt with messagesForApi â˜…â˜…â˜…
                const messagesForApi = [
                    {role: 'system', content: systemPrompt},
                    {role: 'user', content: "è¯·æ ¹æ®ä»¥ä¸Šè®¾å®šå¼€å§‹ä½ çš„å†³ç­–ã€‚"} // A simple trigger message
                ];
        
                let  isGemini = proxyUrl === GEMINI_API_URL;
                let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
                const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                    body: JSON.stringify({
                        model: model,
                        messages: messagesForApi, // Send the combined messages
                        temperature: 0.9,
                    })
                });
        
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error.message}`);
                }
        
                const data = await response.json();
                let rawContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
                rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
                const cleanedContent = rawContent.trim();
                const responseObj = JSON.parse(cleanedContent);
        
                if (responseObj.decision === 'apply' && responseObj.reason) {
                    chat.relationship.status = 'pending_user_approval';
                    chat.relationship.applicationReason = responseObj.reason;
                    state.chats[chatId] = chat; 
                    renderChatList();
                    await showCustomAlert("ç”³è¯·æˆåŠŸï¼", `â€œ${chat.name}â€å·²å‘ä½ å‘é€å¥½å‹ç”³è¯·ã€‚è¯·è¿”å›èŠå¤©åˆ—è¡¨æŸ¥çœ‹ã€‚`);
                } else {
                    await showCustomAlert("AIå†³ç­–", `â€œ${chat.name}â€æ€è€ƒåå†³å®šæš‚æ—¶ä¸å‘é€å¥½å‹ç”³è¯·ï¼Œå°†é‡ç½®å†·é™æœŸã€‚`);
                    chat.relationship.status = 'blocked_by_user';
                    chat.relationship.blockedTimestamp = Date.now(); 
                }
            } catch (error) {
                await showCustomAlert("æ‰§è¡Œå‡ºé”™", `ä¸ºâ€œ${chat.name}â€ç”³è¯·å¥½å‹æ—¶å‘ç”Ÿé”™è¯¯ï¼š\n\n${error.message}\n\nå°†é‡ç½®å†·é™æœŸã€‚`);
                chat.relationship.status = 'blocked_by_user';
                chat.relationship.blockedTimestamp = Date.now(); 
            } finally {
                await db.chats.put(chat);
                renderChatInterface(chatId);
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€æ€»å…¥å£ã€‘æ ¹æ®èŠå¤©ç±»å‹ï¼Œå†³å®šæ‰“å¼€è½¬è´¦å¼¹çª—è¿˜æ˜¯çº¢åŒ…å¼¹çª—
         */
        function handlePaymentButtonClick() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            if (chat.isGroup) {
                openRedPacketModal();
            } else {
                // å•èŠä¿æŒåŸæ ·ï¼Œæ‰“å¼€è½¬è´¦å¼¹çª—
                document.getElementById('transfer-modal').classList.add('visible');
            }
        }
        
        /**
         * æ‰“å¼€å¹¶åˆå§‹åŒ–å‘çº¢åŒ…æ¨¡æ€æ¡†
         */
        function openRedPacketModal() {
            const modal = document.getElementById('red-packet-modal');
            const chat = state.chats[state.activeChatId];
            
            // æ¸…ç†è¾“å…¥æ¡†
            document.getElementById('rp-group-amount').value = '';
            document.getElementById('rp-group-count').value = '';
            document.getElementById('rp-group-greeting').value = '';
            document.getElementById('rp-direct-amount').value = '';
            document.getElementById('rp-direct-greeting').value = '';
            document.getElementById('rp-group-total').textContent = 'Â¥ 0.00';
            document.getElementById('rp-direct-total').textContent = 'Â¥ 0.00';
        
            // å¡«å……ä¸“å±çº¢åŒ…çš„æ¥æ”¶äººåˆ—è¡¨
            const receiverSelect = document.getElementById('rp-direct-receiver');
            receiverSelect.innerHTML = '';
        // â–¼â–¼â–¼ å°†å…¶ã€æ›¿æ¢ä¸ºã€‘ä¸‹é¢è¿™æ®µã€æ–°ä»£ç ã€‘â–¼â–¼â–¼
        chat.members.forEach(member => {
            const option = document.createElement('option');
            // æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨ originalName ä½œä¸ºå€¼ï¼ŒgroupNickname ä½œä¸ºæ˜¾ç¤ºæ–‡æœ¬
            option.value = member.originalName;
            option.textContent = member.groupNickname; 
            receiverSelect.appendChild(option);
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            
            // é»˜è®¤æ˜¾ç¤ºæ‹¼æ‰‹æ°”çº¢åŒ…é¡µç­¾
            document.getElementById('rp-tab-group').click();
            
            modal.classList.add('visible');
        }
        
        /**
         * å‘é€ç¾¤çº¢åŒ…ï¼ˆæ‹¼æ‰‹æ°”ï¼‰
         */
        async function sendGroupRedPacket() {
            const chat = state.chats[state.activeChatId];
            const amount = parseFloat(document.getElementById('rp-group-amount').value);
            const count = parseInt(document.getElementById('rp-group-count').value);
            const greeting = document.getElementById('rp-group-greeting').value.trim();
        
            if (isNaN(amount) || amount <= 0) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ€»é‡‘é¢ï¼"); return;
            }
            if (isNaN(count) || count <= 0) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„çº¢åŒ…ä¸ªæ•°ï¼"); return;
            }
            if (amount / count < 0.01) {
                alert("å•ä¸ªçº¢åŒ…é‡‘é¢ä¸èƒ½å°‘äº0.01å…ƒï¼"); return;
            }
        
            const myNickname = chat.settings.myNickname || 'æˆ‘';
            
            const newPacket = {
                role: 'user',
                senderName: myNickname,
                type: 'red_packet',
                packetType: 'lucky', // 'lucky' for group, 'direct' for one-on-one
                timestamp: Date.now(),
                totalAmount: amount,
                count: count,
                greeting: greeting || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼',
                claimedBy: {}, // { name: amount }
                isFullyClaimed: false,
            };
            
            chat.history.push(newPacket);
            await db.chats.put(chat);
            
            appendMessage(newPacket, chat);
            renderChatList();
            document.getElementById('red-packet-modal').classList.remove('visible');
        }
        
        /**
         * å‘é€ä¸“å±çº¢åŒ…
         */
        async function sendDirectRedPacket() {
            const chat = state.chats[state.activeChatId];
            const amount = parseFloat(document.getElementById('rp-direct-amount').value);
            const receiverName = document.getElementById('rp-direct-receiver').value;
            const greeting = document.getElementById('rp-direct-greeting').value.trim();
        
            if (isNaN(amount) || amount <= 0) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ï¼"); return;
            }
            if (!receiverName) {
                alert("è¯·é€‰æ‹©ä¸€ä¸ªæ¥æ”¶äººï¼"); return;
            }
            
            const myNickname = chat.settings.myNickname || 'æˆ‘';
        
            const newPacket = {
                role: 'user',
                senderName: myNickname,
                type: 'red_packet',
                packetType: 'direct',
                timestamp: Date.now(),
                totalAmount: amount,
                count: 1,
                greeting: greeting || 'ç»™ä½ å‡†å¤‡äº†ä¸€ä¸ªçº¢åŒ…',
                receiverName: receiverName, // æ ¸å¿ƒå­—æ®µ
                claimedBy: {},
                isFullyClaimed: false,
            };
            
            chat.history.push(newPacket);
            await db.chats.put(chat);
        
            appendMessage(newPacket, chat);
            renderChatList();
            document.getElementById('red-packet-modal').classList.remove('visible');
        }
        
        // â–¼â–¼â–¼ ã€å…¨æ–° | V4 - æµç¨‹é‡æ„ç‰ˆã€‘è¯·ç”¨æ­¤å‡½æ•°å®Œæ•´æ›¿æ¢æ—§çš„ handlePacketClick â–¼â–¼â–¼
        /**
         * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·ç‚¹å‡»çº¢åŒ…å¡ç‰‡æ—¶è§¦å‘
         * @param {number} timestamp - è¢«ç‚¹å‡»çš„çº¢åŒ…æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        async function handlePacketClick(timestamp) {
            const currentChatId = state.activeChatId;
            // ä»æ•°æ®åº“é‡æ–°è·å–æœ€æ–°çš„èŠå¤©æ•°æ®ï¼Œç¡®ä¿çŠ¶æ€æ˜¯æœ€æ–°çš„
            const freshChat = await db.chats.get(currentChatId);
            if (!freshChat) return;
        
            // æ›´æ–°å†…å­˜ä¸­çš„ state
            state.chats[currentChatId] = freshChat;
            const packet = freshChat.history.find(m => m.timestamp === timestamp);
            if (!packet) return;
            
            const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
            const hasClaimed = packet.claimedBy && packet.claimedBy[myOriginalName];
        
            // --- æ­¥éª¤1: åˆ¤æ–­æ˜¯å¦åªèƒ½â€œæŸ¥çœ‹è¯¦æƒ…â€ ---
            // å¦‚æœæ˜¯ä¸“å±çº¢åŒ…ä½†ä¸æ˜¯ç»™æˆ‘çš„ï¼Œæˆ–è€…çº¢åŒ…å·²é¢†å®Œï¼Œæˆ–è€…æˆ‘å·²ç»é¢†è¿‡äº†ï¼Œå°±ç›´æ¥æ˜¾ç¤ºè¯¦æƒ…å¹¶ç»“æŸã€‚
            if ((packet.packetType === 'direct' && packet.receiverName !== myOriginalName && Object.keys(packet.claimedBy).length > 0) || packet.isFullyClaimed || hasClaimed) {
                showRedPacketDetails(packet);
                return;
            }
            
            // --- æ­¥éª¤2: æ‰§è¡Œâ€œé¢†å–â€æ“ä½œ ---
            const claimedAmount = await handleOpenRedPacket(packet);
            
            // --- æ­¥éª¤3: åœ¨â€œé¢†å–â€æˆåŠŸåï¼ŒæŒ‰é¡ºåºæ‰§è¡Œåç»­æ“ä½œ ---
            if (claimedAmount !== null) {
                // a. å…ˆåœ¨åå°é»˜é»˜åœ°åˆ·æ–°èŠå¤©ç•Œé¢ï¼Œè®©çº¢åŒ…å¡ç‰‡çŠ¶æ€å˜ä¸ºâ€œå·²é¢†å–â€
                await renderChatInterface(currentChatId);
                
                // b. å¼¹å‡ºâ€œæ­å–œâ€æç¤ºæ¡†ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»â€œå¥½çš„â€
                await showCustomAlert("æ­å–œï¼", `ä½ é¢†å–äº† ${getDisplayNameInGroup(freshChat, packet.senderName)} çš„çº¢åŒ…ï¼Œé‡‘é¢ä¸º ${claimedAmount.toFixed(2)} å…ƒã€‚`);
            }
        
            // --- æ­¥éª¤4: æ— è®ºé¢†å–æˆåŠŸä¸å¦ï¼Œæœ€åéƒ½æ˜¾ç¤ºè¯¦æƒ…é¡µ ---
            // æ­¤æ—¶éœ€è¦ä» state ä¸­è·å–æœ€æ–°çš„ packet å¯¹è±¡ï¼Œå› ä¸ºå®ƒå¯èƒ½åœ¨ handleOpenRedPacket ä¸­è¢«æ›´æ–°äº†
            const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
            if (updatedPacket) {
                showRedPacketDetails(updatedPacket);
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleOpenRedPacket å‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€æ ¸å¿ƒã€‘å¤„ç†ç”¨æˆ·æ‰“å¼€çº¢åŒ…çš„é€»è¾‘ (V5 - å·²ä¿®å¤æ—¶é—´æˆ³BUG)
         */
        async function handleOpenRedPacket(packet) {
            const chat = state.chats[state.activeChatId];
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤1ï¼šåœ¨å‡½æ•°å¼€å§‹æ—¶ï¼Œè·å–ä¸€ä¸ªåŸºç¡€æ—¶é—´æˆ³ â–¼â–¼â–¼
            let timestamp = Date.now(); 
        
            const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
            
            const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
            if (remainingCount <= 0) {
                packet.isFullyClaimed = true;
                await db.chats.put(chat);
                await showCustomAlert("æ‰‹æ…¢äº†", "çº¢åŒ…å·²è¢«é¢†å®Œï¼");
                return null;
            }
            
            let claimedAmount = 0;
            const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
            if (packet.packetType === 'lucky') {
                if (remainingCount === 1) { claimedAmount = remainingAmount; }
                else {
                    const min = 0.01;
                    const max = remainingAmount - (remainingCount - 1) * min;
                    claimedAmount = Math.random() * (max - min) + min;
                }
            } else { claimedAmount = packet.totalAmount; }
            claimedAmount = parseFloat(claimedAmount.toFixed(2));
        
            if (!packet.claimedBy) packet.claimedBy = {};
            packet.claimedBy[myOriginalName] = claimedAmount;
            
            const isNowFullyClaimed = Object.keys(packet.claimedBy).length >= packet.count;
            if (isNowFullyClaimed) {
                packet.isFullyClaimed = true;
            }
        
            const myDisplayName = getDisplayNameInGroup(chat, myOriginalName);
            const senderDisplayName = getDisplayNameInGroup(chat, packet.senderName);
        
            const visibleMessage = { 
                role: 'system', 
                type: 'pat_message', 
                content: `ä½ é¢†å–äº† ${senderDisplayName} çš„çº¢åŒ…`, 
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤2ï¼šä½¿ç”¨æˆ‘ä»¬ç´¯åŠ çš„æ—¶é—´æˆ³ â–¼â–¼â–¼
                timestamp: timestamp++ 
            };
            chat.history.push(visibleMessage);
        
            let hiddenMessageContent;
            if (isNowFullyClaimed) {
                const finishedMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${senderDisplayName} çš„çº¢åŒ…å·²è¢«é¢†å®Œ`,
                    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤3ï¼šç»§ç»­ç´¯åŠ æ—¶é—´æˆ³ â–¼â–¼â–¼
                    timestamp: timestamp++ 
                };
                chat.history.push(finishedMessage);
        
                let luckyKing = { name: '', amount: -1 };
                if (packet.packetType === 'lucky' && packet.count > 1) {
                    Object.entries(packet.claimedBy).forEach(([name, amount]) => {
                        if (amount > luckyKing.amount) {
                            luckyKing = { name, amount };
                        }
                    });
                }
                const luckyKingDisplayName = luckyKing.name ? getDisplayNameInGroup(chat, luckyKing.name) : 'æ— ';
                hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myDisplayName}) é¢†å–äº†æœ€åä¸€ä¸ªçº¢åŒ…ã€‚çº¢åŒ…å·²è¢«é¢†å®Œï¼Œæ‰‹æ°”ç‹æ˜¯ ${luckyKingDisplayName}ï¼è¯·å¯¹æ­¤äº‹ä»¶å‘è¡¨è¯„è®ºã€‚]`;
        
            } else {
                hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myDisplayName}) åˆšåˆšé¢†å–äº†çº¢åŒ… (æ—¶é—´æˆ³: ${packet.timestamp})ã€‚çº¢åŒ…è¿˜æœªé¢†å®Œï¼Œä½ ç°åœ¨å¯ä»¥ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤æ¥å°è¯•é¢†å–ã€‚]`;
            }
        
            const hiddenMessage = { 
                role: 'system', 
                content: hiddenMessageContent, 
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤4ï¼šä¸ºæœ€åä¸€æ¡æ¶ˆæ¯ä¹Ÿä½¿ç”¨ç´¯åŠ çš„æ—¶é—´æˆ³ â–¼â–¼â–¼
                timestamp: timestamp++, 
                isHidden: true 
            };
            chat.history.push(hiddenMessage);
        
            await db.chats.put(chat);
            
            return claimedAmount;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ˜¾ç¤ºçº¢åŒ…é¢†å–è¯¦æƒ…çš„æ¨¡æ€æ¡† (V4 - å·²ä¿®å¤å‚æ•°é”™è¯¯) â–¼â–¼â–¼
        /**
         * ã€å·²ä¿®å¤ã€‘æ˜¾ç¤ºçº¢åŒ…é¢†å–è¯¦æƒ…çš„æ¨¡æ€æ¡†
         * @param {object} packet - å®Œæ•´çš„çº¢åŒ…æ¶ˆæ¯å¯¹è±¡
         */
        async function showRedPacketDetails(packet) {
            if (!packet) {
                console.error("showRedPacketDetailsæ”¶åˆ°äº†æ— æ•ˆçš„packetå¯¹è±¡");
                return;
            }
        
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const modal = document.getElementById('red-packet-details-modal');
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤1ï¼šåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åŒæ ·ä½¿ç”¨â€œæœ¬åâ€æ¥æ£€æŸ¥ â–¼â–¼â–¼
            const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
            
            const senderDisplayName = getDisplayNameInGroup(chat, packet.senderName);
            document.getElementById('rp-details-sender').textContent = senderDisplayName;
            document.getElementById('rp-details-greeting').textContent = packet.greeting || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼';
            
            const myAmountEl = document.getElementById('rp-details-my-amount');
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤2ï¼šç”¨â€œæœ¬åâ€æ¥æŸ¥æ‰¾æˆ‘é¢†å–çš„é‡‘é¢ â–¼â–¼â–¼
            if (packet.claimedBy && packet.claimedBy[myOriginalName]) {
                myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myOriginalName].toFixed(2);
                myAmountEl.style.display = 'block';
            } else {
                myAmountEl.style.display = 'none';
            }
        
            const claimedCount = Object.keys(packet.claimedBy || {}).length;
            const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
            let summaryText = `${claimedCount}/${packet.count}ä¸ªçº¢åŒ…ï¼Œå…±${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}å…ƒã€‚`;
            if (!packet.isFullyClaimed && claimedCount < packet.count) {
                const timeLeft = Math.floor((packet.timestamp + 24*60*60*1000 - Date.now()) / (1000 * 60 * 60));
                if(timeLeft > 0) summaryText += ` å‰©ä½™çº¢åŒ…å°†åœ¨${timeLeft}å°æ—¶å†…é€€è¿˜ã€‚`;
            }
            document.getElementById('rp-details-summary').textContent = summaryText;
        
            const listEl = document.getElementById('rp-details-list');
            listEl.innerHTML = '';
            const claimedEntries = Object.entries(packet.claimedBy || {});
            
            let luckyKing = { name: '', amount: -1 };
            if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
                claimedEntries.forEach(([name, amount]) => {
                    if (amount > luckyKing.amount) {
                        luckyKing = { name, amount };
                    }
                });
            }
        
            claimedEntries.sort((a,b) => b[1] - a[1]);
        
            claimedEntries.forEach(([originalName, amount]) => {
                const item = document.createElement('div');
                item.className = 'rp-details-item';
                let luckyTag = '';
                if (luckyKing.name && originalName === luckyKing.name) {
                    luckyTag = '<span class="lucky-king-tag">æ‰‹æ°”ç‹</span>';
                }
                
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤3ï¼šå°†æ‰€æœ‰é¢†å–è€…çš„â€œæœ¬åâ€éƒ½è½¬æ¢ä¸ºæ­£ç¡®çš„â€œæ˜¾ç¤ºåç§°â€ â–¼â–¼â–¼
                const claimerDisplayName = getDisplayNameInGroup(chat, originalName);
        
                item.innerHTML = `
                    <span class="name">${claimerDisplayName}</span>
                    <span class="amount">${amount.toFixed(2)} å…ƒ</span>
                    ${luckyTag}
                `;
                listEl.appendChild(item);
            });
        
            modal.classList.add('visible');
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // ç»‘å®šå…³é—­è¯¦æƒ…æŒ‰é’®çš„äº‹ä»¶
        document.getElementById('close-rp-details-btn').addEventListener('click', () => {
            document.getElementById('red-packet-details-modal').classList.remove('visible');
        });
        
        // ä¾›å…¨å±€è°ƒç”¨çš„å‡½æ•°ï¼Œä»¥ä¾¿çº¢åŒ…å¡ç‰‡ä¸Šçš„ onclick èƒ½æ‰¾åˆ°å®ƒ
        window.handlePacketClick = handlePacketClick;
        
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
        
        /**
         * æ‰“å¼€åˆ›å»ºæŠ•ç¥¨çš„æ¨¡æ€æ¡†å¹¶åˆå§‹åŒ–
         */
        function openCreatePollModal() {
            const modal = document.getElementById('create-poll-modal');
            document.getElementById('poll-question-input').value = '';
            const optionsContainer = document.getElementById('poll-options-container');
            optionsContainer.innerHTML = '';
            
            // é»˜è®¤åˆ›å»ºä¸¤ä¸ªç©ºçš„é€‰é¡¹æ¡†
            addPollOptionInput();
            addPollOptionInput();
            
            modal.classList.add('visible');
        }
        
        /**
         * åœ¨æ¨¡æ€æ¡†ä¸­åŠ¨æ€æ·»åŠ ä¸€ä¸ªé€‰é¡¹è¾“å…¥æ¡†
         */
        function addPollOptionInput() {
            const container = document.getElementById('poll-options-container');
            const wrapper = document.createElement('div');
            wrapper.className = 'poll-option-input-wrapper';
            wrapper.innerHTML = `
                <input type="text" class="poll-option-input" placeholder="é€‰é¡¹å†…å®¹...">
                <button class="remove-option-btn">-</button>
            `;
            
            wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
                // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸¤ä¸ªé€‰é¡¹
                if (container.children.length > 2) {
                    wrapper.remove();
                } else {
                    alert('æŠ•ç¥¨è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹ã€‚');
                }
            });
            
            container.appendChild(wrapper);
        }
        
        /**
         * ç”¨æˆ·ç¡®è®¤å‘èµ·æŠ•ç¥¨
         */
        async function sendPoll() {
            if (!state.activeChatId) return;
            
            const question = document.getElementById('poll-question-input').value.trim();
            if (!question) {
                alert('è¯·è¾“å…¥æŠ•ç¥¨é—®é¢˜ï¼');
                return;
            }
            
            const options = Array.from(document.querySelectorAll('.poll-option-input'))
                .map(input => input.value.trim())
                .filter(text => text); // è¿‡æ»¤æ‰ç©ºçš„é€‰é¡¹
        
            if (options.length < 2) {
                alert('è¯·è‡³å°‘è¾“å…¥2ä¸ªæœ‰æ•ˆçš„æŠ•ç¥¨é€‰é¡¹ï¼');
                return;
            }
        
            const chat = state.chats[state.activeChatId];
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            
            const newPollMessage = {
                role: 'user',
                senderName: myNickname,
                type: 'poll',
                timestamp: Date.now(),
                question: question,
                options: options,
                votes: {}, // åˆå§‹æŠ•ç¥¨ä¸ºç©º
                isClosed: false,
            };
            
            chat.history.push(newPollMessage);
            await db.chats.put(chat);
            
            appendMessage(newPollMessage, chat);
            renderChatList();
            
            document.getElementById('create-poll-modal').classList.remove('visible');
        }
        
        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤é‡å¤ç‚¹å‡»é—®é¢˜ã€‘çš„ç‰ˆæœ¬æ›¿æ¢ handleUserVote å‡½æ•° â–¼â–¼â–¼
        /**
         * å¤„ç†ç”¨æˆ·æŠ•ç¥¨ï¼Œå¹¶å°†äº‹ä»¶ä½œä¸ºéšè—æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
         * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
         * @param {string} choice - ç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹æ–‡æœ¬
         */
        async function handleUserVote(timestamp, choice) {
            const chat = state.chats[state.activeChatId];
            const poll = chat.history.find(m => m.timestamp === timestamp);
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
        
            // 1. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœæŠ•ç¥¨ä¸å­˜åœ¨æˆ–å·²å…³é—­ï¼Œç›´æ¥è¿”å›
            if (!poll || poll.isClosed) {
                // å¦‚æœæ˜¯å·²å…³é—­çš„æŠ•ç¥¨ï¼Œåˆ™ç›´æ¥æ˜¾ç¤ºç»“æœ
                if (poll && poll.isClosed) {
                    showPollResults(timestamp);
                }
                return;
            }
        
            // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹å‡»äº†å·²ç»æŠ•è¿‡çš„åŒä¸€ä¸ªé€‰é¡¹
            const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);
            
            // 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœä¸æ˜¯é‡å¤ç‚¹å‡»ï¼Œæ‰æ‰§è¡ŒæŠ•ç¥¨é€»è¾‘
            if (!isReclickingSameOption) {
                // ç§»é™¤æ—§æŠ•ç¥¨ï¼ˆå¦‚æœç”¨æˆ·æ”¹é€‰ï¼‰
                for (const option in poll.votes) {
                    const voterIndex = poll.votes[option].indexOf(myNickname);
                    if (voterIndex > -1) {
                        poll.votes[option].splice(voterIndex, 1);
                    }
                }
                // æ·»åŠ æ–°æŠ•ç¥¨
                if (!poll.votes[choice]) {
                    poll.votes[choice] = [];
                }
                poll.votes[choice].push(myNickname);
            }
            
            // 4. ã€æ ¸å¿ƒé€»è¾‘ã€‘ç°åœ¨åªå¤„ç†ç”¨æˆ·æŠ•ç¥¨äº‹ä»¶ï¼Œä¸å†æ£€æŸ¥æ˜¯å¦ç»“æŸ
            let hiddenMessageContent = null; 
            
            // åªæœ‰åœ¨ç”¨æˆ·çœŸæ­£æŠ•ç¥¨æˆ–æ”¹ç¥¨æ—¶ï¼Œæ‰ç”Ÿæˆæç¤º
            if (!isReclickingSameOption) {
                 hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) åˆšåˆšæŠ•ç¥¨ç»™äº† â€œ${choice}â€ã€‚]`;
            }
        
            // 5. å¦‚æœæœ‰éœ€è¦é€šçŸ¥AIçš„äº‹ä»¶ï¼Œåˆ™åˆ›å»ºå¹¶æ·»åŠ éšè—æ¶ˆæ¯
            if (hiddenMessageContent) {
                const hiddenMessage = {
                    role: 'system',
                    content: hiddenMessageContent,
                    timestamp: Date.now(),
                    isHidden: true,
                };
                chat.history.push(hiddenMessage);
            }
            
            // 6. ä¿å­˜æ•°æ®å¹¶æ›´æ–°UI
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId); 
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * ç”¨æˆ·ç»“æŸæŠ•ç¥¨ï¼Œå¹¶å°†äº‹ä»¶ä½œä¸ºéšè—æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
         * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        async function endPoll(timestamp) {
            const chat = state.chats[state.activeChatId];
            const poll = chat.history.find(m => m.timestamp === timestamp);
            if (!poll || poll.isClosed) return;
        
            const confirmed = await showCustomConfirm("ç»“æŸæŠ•ç¥¨", "ç¡®å®šè¦ç»“æŸè¿™ä¸ªæŠ•ç¥¨å—ï¼Ÿç»“æŸåå°†æ— æ³•å†è¿›è¡ŒæŠ•ç¥¨ã€‚");
            if (confirmed) {
                poll.isClosed = true;
        
                const resultSummary = poll.options.map(opt => `â€œ${opt}â€(${poll.votes[opt]?.length || 0}ç¥¨)`).join('ï¼Œ');
                const hiddenMessageContent = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ‰‹åŠ¨ç»“æŸäº†æŠ•ç¥¨ï¼æœ€ç»ˆç»“æœä¸ºï¼š${resultSummary}ã€‚]`;
                
                const hiddenMessage = {
                    role: 'system',
                    content: hiddenMessageContent,
                    timestamp: Date.now(),
                    isHidden: true,
                };
                chat.history.push(hiddenMessage);
        
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªä¿å­˜æ•°æ®å’Œæ›´æ–°UIï¼Œä¸è°ƒç”¨ triggerAiResponse()
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * æ˜¾ç¤ºæŠ•ç¥¨ç»“æœè¯¦æƒ…
         * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤ã€‘çš„ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ showPollResults å‡½æ•° â–¼â–¼â–¼
        function showPollResults(timestamp) {
            const chat = state.chats[state.activeChatId];
            const poll = chat.history.find(m => m.timestamp === timestamp);
            if (!poll || !poll.isClosed) return;
        
            let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;
            
            if (Object.keys(poll.votes).length === 0) {
                resultsHtml += '<p style="color: #8a8a8a;">è¿˜æ²¡æœ‰äººæŠ•ç¥¨ã€‚</p>';
            } else {
                poll.options.forEach(option => {
                    const voters = poll.votes[option] || [];
                    
                    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œè½¬æ¢ voter çš„æœ¬åä¸ºç¾¤æ˜µç§°
                    const displayVoters = voters.map(originalName => getDisplayNameInGroup(chat, originalName)).join('ã€ ');
        
                    resultsHtml += `
                        <div style="margin-bottom: 15px;">
                            <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}ç¥¨)</p>
                            <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                                ${voters.length > 0 ? displayVoters : 'æ— äººæŠ•ç¥¨'}
                            </p>
                        </div>
                    `;
                });
            }
        
            showCustomAlert("æŠ•ç¥¨ç»“æœ", resultsHtml);
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒåº“ç®¡ç†åŠŸèƒ½å‡½æ•° â–¼â–¼â–¼
        
        /**
         * æ‰“å¼€AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
         */
        function openAiAvatarLibraryModal() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            document.getElementById('ai-avatar-library-title').textContent = `â€œ${chat.name}â€çš„å¤´åƒåº“`;
            renderAiAvatarLibrary();
            document.getElementById('ai-avatar-library-modal').classList.add('visible');
        }
        
        /**
         * æ¸²æŸ“AIå¤´åƒåº“çš„å†…å®¹
         */
        function renderAiAvatarLibrary() {
            const grid = document.getElementById('ai-avatar-library-grid');
            grid.innerHTML = '';
            const chat = state.chats[state.activeChatId];
            const library = chat.settings.aiAvatarLibrary || [];
        
            if (library.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">è¿™ä¸ªå¤´åƒåº“è¿˜æ˜¯ç©ºçš„ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>';
                return;
            }
        
            library.forEach((avatar, index) => {
                const item = document.createElement('div');
                item.className = 'sticker-item'; // å¤ç”¨è¡¨æƒ…é¢æ¿çš„æ ·å¼
                item.style.backgroundImage = `url(${avatar.url})`;
                item.title = avatar.name;
        
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.style.display = 'block'; // æ€»æ˜¯æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const confirmed = await showCustomConfirm('åˆ é™¤å¤´åƒ', `ç¡®å®šè¦ä»å¤´åƒåº“ä¸­åˆ é™¤â€œ${avatar.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        chat.settings.aiAvatarLibrary.splice(index, 1);
                        await db.chats.put(chat);
                        renderAiAvatarLibrary();
                    }
                };
                item.appendChild(deleteBtn);
                grid.appendChild(item);
            });
        }
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ addAvatarToLibrary / addAvatarToLibraryFromURL å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€é‡å‘½ååã€‘å‘å½“å‰AIçš„å¤´åƒåº“ä¸­é€šè¿‡URLæ·»åŠ æ–°å¤´åƒ
         */
        async function addAvatarToLibraryFromURL() {
            const name = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·ä¸ºè¿™ä¸ªå¤´åƒèµ·ä¸ªåå­—ï¼ˆä¾‹å¦‚ï¼šå¼€å¿ƒã€å“­æ³£ï¼‰");
            if (!name || !name.trim()) return;
        
            const url = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·è¾“å…¥å¤´åƒçš„å›¾ç‰‡URL", "", "url");
            if (!url || !url.trim().startsWith('http')) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.aiAvatarLibrary) {
                chat.settings.aiAvatarLibrary = [];
            }
        
            chat.settings.aiAvatarLibrary.push({ name: name.trim(), url: url.trim() });
            await db.chats.put(chat);
            renderAiAvatarLibrary();
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * å…³é—­AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
         */
        function closeAiAvatarLibraryModal() {
            document.getElementById('ai-avatar-library-modal').classList.remove('visible');
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæˆ‘çš„â€å¤´åƒåº“ç®¡ç†åŠŸèƒ½å‡½æ•° â–¼â–¼â–¼
        
        /**
         * æ‰“å¼€â€œæˆ‘çš„â€å¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
         */
        function openMyAvatarLibraryModal() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            document.getElementById('my-avatar-library-title').textContent = `â€œ${chat.settings.myNickname || 'æˆ‘'}â€çš„å¤´åƒåº“`;
            renderMyAvatarLibrary();
            document.getElementById('my-avatar-library-modal').classList.add('visible');
        }
        
        /**
         * æ¸²æŸ“â€œæˆ‘çš„â€å¤´åƒåº“çš„å†…å®¹
         */
        function renderMyAvatarLibrary() {
            const grid = document.getElementById('my-avatar-library-grid');
            grid.innerHTML = '';
            const chat = state.chats[state.activeChatId];
            const library = chat.settings.myAvatarLibrary || [];
        
            if (library.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">è¿™ä¸ªå¤´åƒåº“è¿˜æ˜¯ç©ºçš„ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>';
                return;
            }
        
            library.forEach((avatar, index) => {
                const item = document.createElement('div');
                item.className = 'sticker-item'; // å¤ç”¨è¡¨æƒ…é¢æ¿çš„æ ·å¼
                item.style.backgroundImage = `url(${avatar.url})`;
                item.title = avatar.name;
        
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.style.display = 'block'; // æ€»æ˜¯æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const confirmed = await showCustomConfirm('åˆ é™¤å¤´åƒ', `ç¡®å®šè¦ä»ä½ çš„å¤´åƒåº“ä¸­åˆ é™¤â€œ${avatar.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        chat.settings.myAvatarLibrary.splice(index, 1);
                        await db.chats.put(chat);
                        renderMyAvatarLibrary();
                    }
                };
                item.appendChild(deleteBtn);
                grid.appendChild(item);
            });
        }
        
        /**
         * å‘â€œæˆ‘çš„â€å¤´åƒåº“ä¸­é€šè¿‡URLæ·»åŠ æ–°å¤´åƒ
         */
        async function addAvatarToMyLibraryFromURL() {
            const name = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·ä¸ºè¿™ä¸ªå¤´åƒèµ·ä¸ªåå­—ï¼ˆä¾‹å¦‚ï¼šå¼€å¿ƒã€å“­æ³£ï¼‰");
            if (!name || !name.trim()) return;
        
            const url = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·è¾“å…¥å¤´åƒçš„å›¾ç‰‡URL", "", "url");
            if (!url || !url.trim().startsWith('http')) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.myAvatarLibrary) {
                chat.settings.myAvatarLibrary = [];
            }
        
            chat.settings.myAvatarLibrary.push({ name: name.trim(), url: url.trim() });
            await db.chats.put(chat);
            renderMyAvatarLibrary();
        }
        
        /**
         * å¤„ç†æœ¬åœ°ä¸Šä¼ å¤´åƒåˆ°â€œæˆ‘çš„â€å¤´åƒåº“
         */
        async function handleLocalMyAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
        
            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        
            const name = await showCustomPrompt("å‘½åå¤´åƒ", "è¯·ä¸ºè¿™ä¸ªæ–°å¤´åƒå‘½å");
            if (!name || !name.trim()) return;
        
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.myAvatarLibrary) {
                chat.settings.myAvatarLibrary = [];
            }
            chat.settings.myAvatarLibrary.push({ name: name.trim(), url: base64Url });
            
            await db.chats.put(chat);
            renderMyAvatarLibrary();
            event.target.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©
        }
        
        /**
         * æ‰¹é‡å¯¼å…¥å¤´åƒåˆ°â€œæˆ‘çš„â€å¤´åƒåº“
         */
        async function handleBatchImportForMyAvatar(text) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const lines = text.trim().split('\n');
            const newAvatars = [];
            const baseUrl = 'https://files.catbox.moe/';
            let errorCount = 0;
        
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine || trimmedLine.includes('http') || trimmedLine.includes('å¡«å…¥')) continue;
                
                let name = null, code = null;
                const noSpaceMatch = trimmedLine.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);
                
                if (noSpaceMatch) {
                    name = noSpaceMatch[1];
                    code = noSpaceMatch[2];
                } else {
                    const parts = trimmedLine.split(/\s+/);
                    if (parts.length >= 2) {
                        code = parts.pop();
                        name = parts.join(' ');
                    }
                }
        
                if (name && code && code.includes('.')) {
                    newAvatars.push({ name: name, url: baseUrl + code });
                } else {
                    errorCount++;
                }
            }
        
            if (errorCount > 0) await showCustomAlert('éƒ¨åˆ†å¯¼å…¥å¤±è´¥', `æœ‰ ${errorCount} è¡Œçš„æ ¼å¼ä¸æ­£ç¡®ï¼Œå·²è¢«è·³è¿‡ã€‚`);
            
            if (newAvatars.length > 0) {
                if (!chat.settings.myAvatarLibrary) chat.settings.myAvatarLibrary = [];
                chat.settings.myAvatarLibrary.push(...newAvatars);
                await db.chats.put(chat);
                renderMyAvatarLibrary();
                await showCustomAlert('å¯¼å…¥æˆåŠŸ', `å·²æˆåŠŸæ‰¹é‡å¯¼å…¥ ${newAvatars.length} ä¸ªæ–°å¤´åƒï¼`);
            } else if (errorCount === 0) {
                alert("æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å…¥çš„å†…å®¹ã€‚");
            }
        }
        
        /**
         * å…³é—­â€œæˆ‘çš„â€å¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
         */
        function closeMyAvatarLibraryModal() {
            document.getElementById('my-avatar-library-modal').classList.remove('visible');
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤å¤´åƒåº“ç®¡ç†åŠŸèƒ½å‡½æ•° â–¼â–¼â–¼
        
        /**
         * æ‰“å¼€ç¾¤å¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
         */
        function openGroupAvatarLibraryModal() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            document.getElementById('group-avatar-library-title').textContent = `â€œ${chat.name}â€çš„å¤´åƒåº“`;
            renderGroupAvatarLibrary();
            document.getElementById('group-avatar-library-modal').classList.add('visible');
        }
        
        /**
         * æ¸²æŸ“ç¾¤å¤´åƒåº“çš„å†…å®¹
         */
        function renderGroupAvatarLibrary() {
            const grid = document.getElementById('group-avatar-library-grid');
            grid.innerHTML = '';
            const chat = state.chats[state.activeChatId];
            const library = chat.settings.groupAvatarLibrary || [];
        
            if (library.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">è¿™ä¸ªå¤´åƒåº“è¿˜æ˜¯ç©ºçš„ï¼Œç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€å§ï¼</p>';
                return;
            }
        
            library.forEach((avatar, index) => {
                const item = document.createElement('div');
                item.className = 'sticker-item'; // å¤ç”¨è¡¨æƒ…é¢æ¿çš„æ ·å¼
                item.style.backgroundImage = `url(${avatar.url})`;
                item.title = avatar.name;
        
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.style.display = 'block'; // æ€»æ˜¯æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const confirmed = await showCustomConfirm('åˆ é™¤å¤´åƒ', `ç¡®å®šè¦ä»å¤´åƒåº“ä¸­åˆ é™¤â€œ${avatar.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        chat.settings.groupAvatarLibrary.splice(index, 1);
                        await db.chats.put(chat);
                        renderGroupAvatarLibrary();
                    }
                };
                item.appendChild(deleteBtn);
                grid.appendChild(item);
            });
        }
        
        /**
         * å‘å½“å‰ç¾¤èŠçš„å¤´åƒåº“ä¸­æ·»åŠ æ–°å¤´åƒ
         */
        async function addAvatarToGroupLibraryFromUR() {
            const name = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·ä¸ºè¿™ä¸ªå¤´åƒèµ·ä¸ªåå­—ï¼ˆä¾‹å¦‚ï¼šæ˜¥æ—¥é‡é¤ã€å­¦ä¹ æ—¶é—´ï¼‰");
            if (!name || !name.trim()) return;
        
            const url = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·è¾“å…¥å¤´åƒçš„å›¾ç‰‡URL", "", "url");
            if (!url || !url.trim().startsWith('http')) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.groupAvatarLibrary) {
                chat.settings.groupAvatarLibrary = [];
            }
        
            chat.settings.groupAvatarLibrary.push({ name: name.trim(), url: url.trim() });
            await db.chats.put(chat);
            renderGroupAvatarLibrary();
        }
        
        /**
         * å…³é—­ç¾¤å¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
         */
        function closeGroupAvatarLibraryModal() {
            document.getElementById('group-avatar-library-modal').classList.remove('visible');
        }
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ‰¹é‡å¯¼å…¥å¤´åƒçš„æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        
        /**
         * ã€æ€»å…¥å£ã€‘æ‰“å¼€æ‰¹é‡å¯¼å…¥çš„å¼¹çª—
         * @param {string} type - å¯¼å…¥ç±»å‹, 'ai' æˆ– 'group'
         */
        async function openBatchImportModal(type) {
            const placeholderText = `è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç²˜è´´ï¼Œä¸€è¡Œä¸€ä¸ªï¼š\n\nç„¦è™‘ 2a9wte.jpeg\nå¤§æƒŠå¤±è‰² or8qf4.png\næ²¡æœ‰çµæ„Ÿ njwujh.jpeg`;
            
            // å¤ç”¨æˆ‘ä»¬å¼ºå¤§çš„è‡ªå®šä¹‰è¾“å…¥æ¡†å‡½æ•°
            const pastedText = await showCustomPrompt(
                'æ‰¹é‡å¯¼å…¥å¤´åƒ',
                placeholderText,
                '',
                'textarea' // ä½¿ç”¨å¤šè¡Œæ–‡æœ¬æ¡†
            );
        
            // å¦‚æœç”¨æˆ·è¾“å…¥äº†å†…å®¹å¹¶ç‚¹å‡»â€œç¡®å®šâ€
            if (pastedText && pastedText.trim()) {
                await handleBatchImport(type, pastedText);
            }
        }
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleBatchImport â–¼â–¼â–¼
        /**
         * ã€æ ¸å¿ƒé€»è¾‘ã€‘å¤„ç†ç²˜è´´çš„æ–‡æœ¬ï¼Œè§£æå¹¶å­˜å…¥æ•°æ®åº“ (V4 - ç»ˆææ™ºèƒ½ç‰ˆ)
         * @param {string} type - å¯¼å…¥ç±»å‹, 'ai' æˆ– 'group'
         * @param {string} text - ç”¨æˆ·ç²˜è´´çš„æ–‡æœ¬å†…å®¹
         */
        async function handleBatchImport(type, text) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const lines = text.trim().split('\n');
            const newAvatars = [];
            const baseUrl = 'https://files.catbox.moe/';
            let errorCount = 0;
        
            for (const line of lines) {
                const trimmedLine = line.trim();
        
                if (!trimmedLine || trimmedLine.includes('http') || trimmedLine.includes('å¡«å…¥')) {
                    continue; 
                }
        
                let name = null;
                let code = null;
        
                // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
                //            è¿™å°±æ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒæ‰€åœ¨ï¼
                //  å…¨æ–°çš„ã€èƒ½åŒæ—¶å¤„ç†â€œæœ‰ç©ºæ ¼â€å’Œâ€œæ— ç©ºæ ¼â€ä¸¤ç§æ ¼å¼çš„è§£æé€»è¾‘
                // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        
                // æ­¥éª¤1ï¼šå°è¯•ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… â€œä¸­æ–‡å+è‹±æ–‡ä»£ç â€ çš„æ— ç©ºæ ¼æ ¼å¼
                const noSpaceMatch = trimmedLine.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);
                
                if (noSpaceMatch) {
                    // å¦‚æœåŒ¹é…æˆåŠŸï¼Œç›´æ¥æå–
                    name = noSpaceMatch[1];
                    code = noSpaceMatch[2];
                } else {
                    // æ­¥éª¤2ï¼šå¦‚æœæ­£åˆ™åŒ¹é…å¤±è´¥ï¼Œå°±å›é€€åˆ°ä¹‹å‰æŒ‰ç©ºæ ¼åˆ†å‰²çš„é€»è¾‘
                    const parts = trimmedLine.split(/\s+/);
                    if (parts.length >= 2) {
                        code = parts.pop();
                        name = parts.join(' ');
                    }
                }
        
                // æ­¥éª¤3ï¼šæœ€åéªŒè¯è§£æç»“æœæ˜¯å¦æœ‰æ•ˆ
                if (name && code && code.includes('.')) {
                    newAvatars.push({
                        name: name,
                        url: baseUrl + code
                    });
                } else {
                    errorCount++;
                    console.warn('æ‰¹é‡å¯¼å…¥æ ¼å¼é”™è¯¯ï¼Œå·²è·³è¿‡æ­¤è¡Œ:', trimmedLine);
                }
            }
        
            if (errorCount > 0) {
                await showCustomAlert('éƒ¨åˆ†å¯¼å…¥å¤±è´¥', `æœ‰ ${errorCount} è¡Œçš„æ ¼å¼ä¸æ­£ç¡®ï¼Œå·²è¢«ç³»ç»Ÿè·³è¿‡ã€‚`);
            }
        
            if (newAvatars.length > 0) {
                if (type === 'ai') {
                    if (!chat.settings.aiAvatarLibrary) chat.settings.aiAvatarLibrary = [];
                    chat.settings.aiAvatarLibrary.push(...newAvatars);
                    await db.chats.put(chat);
                    renderAiAvatarLibrary();
                } else if (type === 'group') {
                    if (!chat.settings.groupAvatarLibrary) chat.settings.groupAvatarLibrary = [];
                    chat.settings.groupAvatarLibrary.push(...newAvatars);
                    await db.chats.put(chat);
                    renderGroupAvatarLibrary();
                }
                await showCustomAlert('å¯¼å…¥æˆåŠŸ', `å·²æˆåŠŸæ‰¹é‡å¯¼å…¥ ${newAvatars.length} ä¸ªæ–°å¤´åƒï¼`);
            } else if (errorCount === 0) {
                alert("æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å…¥çš„å†…å®¹ã€‚è¯·æ£€æŸ¥æ‚¨ç²˜è´´çš„æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚");
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è¿™æ˜¯æ‚¨ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ä»£ç ï¼Œè¯·ç²˜è´´åœ¨è¿™é‡Œã€‘ â–¼â–¼â–¼
        
        /**
         * ã€é‡å‘½ååã€‘å‘å½“å‰ç¾¤èŠçš„å¤´åƒåº“ä¸­é€šè¿‡URLæ·»åŠ æ–°å¤´åƒ
         */
        async function addAvatarToGroupLibraryFromURL() {
            const name = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·ä¸ºè¿™ä¸ªå¤´åƒèµ·ä¸ªåå­—ï¼ˆä¾‹å¦‚ï¼šæ˜¥æ—¥é‡é¤ã€å­¦ä¹ æ—¶é—´ï¼‰");
            if (!name || !name.trim()) return;
        
            const url = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·è¾“å…¥å¤´åƒçš„å›¾ç‰‡URL", "", "url");
            if (!url || !url.trim().startsWith('http')) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.groupAvatarLibrary) {
                chat.settings.groupAvatarLibrary = [];
            }
        
            chat.settings.groupAvatarLibrary.push({ name: name.trim(), url: url.trim() });
            await db.chats.put(chat);
            renderGroupAvatarLibrary();
        }
        
        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©åˆ—è¡¨é•¿æŒ‰æ“ä½œèœå•çš„æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        
        /**
         * æ˜¾ç¤ºä¸€ä¸ªåŒ…å«â€œç½®é¡¶â€å’Œâ€œåˆ é™¤â€é€‰é¡¹çš„æ“ä½œèœå•
         * @param {object} chat - è¢«é•¿æŒ‰çš„èŠå¤©å¯¹è±¡
         * @returns {Promise<string|null>} - è¿”å›ä¸€ä¸ªPromiseï¼Œå½“ç”¨æˆ·ç‚¹å‡»æ—¶è§£æä¸º 'pin', 'delete', æˆ– null (å–æ¶ˆ)
         */
        function showChatListActions(chat) {
            return new Promise(resolve => {
                const modal = document.getElementById('chat-list-actions-modal');
                const pinBtn = document.getElementById('chat-list-action-pin');
                const deleteBtn = document.getElementById('chat-list-action-delete');
                const cancelBtn = document.getElementById('chat-list-action-cancel');
        
                // æ ¹æ®å½“å‰èŠå¤©æ˜¯å¦å·²ç½®é¡¶ï¼ŒåŠ¨æ€è®¾ç½®æŒ‰é’®æ–‡å­—
                pinBtn.textContent = chat.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶èŠå¤©';
        
                // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§ï¼Œç¡®ä¿æ¯æ¬¡æ‰“å¼€èœå•æ—¶éƒ½ç»‘å®šå…¨æ–°çš„ã€å¹²å‡€çš„äº‹ä»¶ç›‘å¬å™¨
                const newPinBtn = pinBtn.cloneNode(true);
                pinBtn.parentNode.replaceChild(newPinBtn, pinBtn);
                newPinBtn.onclick = () => { modal.classList.remove('visible'); resolve('pin'); };
        
                const newDeleteBtn = deleteBtn.cloneNode(true);
                deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
                newDeleteBtn.onclick = () => { modal.classList.remove('visible'); resolve('delete'); };
        
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                newCancelBtn.onclick = () => { modal.classList.remove('visible'); resolve(null); };
        
                modal.classList.add('visible');
            });
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºCPhoneæ–°å¢çš„æ‰€æœ‰åŠŸèƒ½å‡½æ•°ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼

        /**
         * ã€å…¨æ–°ã€‘å°†ä¿å­˜çš„CPhoneå£çº¸åº”ç”¨åˆ°Cphoneå±å¹•
         */
        function applyCPhoneWallpaper() {
            const charPhoneScreen = document.getElementById('character-phone-screen');
            const wallpaper = state.globalSettings.cphoneWallpaper;
            if (wallpaper && wallpaper.startsWith('data:image')) {
                charPhoneScreen.style.backgroundImage = `url(${wallpaper})`;
            } else if (wallpaper) {
                charPhoneScreen.style.backgroundImage = wallpaper;
            }
        }

        /**
         * ã€å…¨æ–°ã€‘å°†ä¿å­˜çš„å›¾æ ‡URLåº”ç”¨åˆ°CPhoneçš„Appå›¾æ ‡ä¸Š
         */
        function applyCPhoneAppIcons() {
            if (!state.globalSettings.cphoneAppIcons) return;

            for (const iconId in state.globalSettings.cphoneAppIcons) {
                const imgElement = document.getElementById(`cphone-icon-img-${iconId}`);
                if (imgElement) {
                    imgElement.src = state.globalSettings.cphoneAppIcons[iconId];
                }
            }
        }

        /**
         * ã€å…¨æ–°ã€‘åœ¨å¤–è§‚è®¾ç½®é¡µé¢æ¸²æŸ“å‡ºæ‰€æœ‰CPhone Appå›¾æ ‡çš„è®¾ç½®é¡¹
         */
        function renderCPhoneIconSettings() {
            const grid = document.getElementById('cphone-icon-settings-grid');
            if (!grid) return;
            grid.innerHTML = '';

            const cphoneAppLabels = {
                'qq': 'QQ', 'album': 'ç›¸å†Œ', 'browser': 'æµè§ˆå™¨', 'taobao': 'æ·˜å®',
                'memo': 'å¤‡å¿˜å½•', 'diary': 'æ—¥è®°', 'amap': 'é«˜å¾·åœ°å›¾', 'usage': 'Appè®°å½•',
                'music': 'ç½‘æ˜“äº‘', 'ephone': 'Ephone'
            };

            for (const iconId in state.globalSettings.cphoneAppIcons) {
                const iconUrl = state.globalSettings.cphoneAppIcons[iconId];
                const labelText = cphoneAppLabels[iconId] || 'æœªçŸ¥App';

                const item = document.createElement('div');
                item.className = 'icon-setting-item';
                item.dataset.iconId = iconId;

                item.innerHTML = `
                    <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
                    <button class="change-icon-btn">æ›´æ¢</button>
                `;
                grid.appendChild(item);
            }
        }

        // â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ è¯·å°†è¿™ä¸¤ä¸ªã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘å°†ä¿å­˜çš„å›¾æ ‡URLåº”ç”¨åˆ°ä¸»å±å¹•çš„Appå›¾æ ‡ä¸Š
         */
        function applyAppIcons() {
            if (!state.globalSettings.appIcons) return;
        
            for (const iconId in state.globalSettings.appIcons) {
                const imgElement = document.getElementById(`icon-img-${iconId}`);
                if (imgElement) {
                    imgElement.src = state.globalSettings.appIcons[iconId];
                }
            }
        }
        
        /**
         * ã€å…¨æ–°ã€‘åœ¨å¤–è§‚è®¾ç½®é¡µé¢æ¸²æŸ“å‡ºæ‰€æœ‰Appå›¾æ ‡çš„è®¾ç½®é¡¹
         */
        function renderIconSettings() {
            const grid = document.getElementById('icon-settings-grid');
            if (!grid) return;
            grid.innerHTML = '';
        
    const appLabels = {
       'qq': 'QQ',
       'world-book': 'ä¸–ç•Œä¹¦',
       'wallpaper': 'å¤–è§‚è®¾ç½®',
       'renderer': 'æ¸²æŸ“å™¨',
       'api-settings': 'APIè®¾ç½®',
       'font': 'å­—ä½“',
       'char-phone': 'Cphone',
       'douban': 'è±†ç“£å°ç»„',
       // ã€ã€ã€æ ¸å¿ƒæ–°å¢ï¼šåœ¨è¿™é‡Œä¸ºâ€œé¢„è®¾â€Appæ·»åŠ å¯¹åº”çš„ä¸­æ–‡åã€‘ã€‘ã€‘
       'preset': 'é¢„è®¾',
           // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„ä¸€è¡Œ â–¼â–¼â–¼
           'tutorial': 'æ•™ç¨‹'
    };
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
            for (const iconId in state.globalSettings.appIcons) {
                const iconUrl = state.globalSettings.appIcons[iconId];
                const labelText = appLabels[iconId] || 'Cphone';
        
                const item = document.createElement('div');
                item.className = 'icon-setting-item';
                // ã€é‡è¦ã€‘æˆ‘ä»¬ç”¨ data-icon-id æ¥æ ‡è®°è¿™ä¸ªè®¾ç½®é¡¹å¯¹åº”å“ªä¸ªå›¾æ ‡
                item.dataset.iconId = iconId; 
        
                item.innerHTML = `
                    <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
                    <button class="change-icon-btn">æ›´æ¢</button>
                `;
                grid.appendChild(item);
            }
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€æ”¯æŒHTMLæ ¼å¼ã€‘çš„å…¨æ–°ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ openBrowser å‡½æ•° â–¼â–¼â–¼
        /**
         * å½“ç”¨æˆ·ç‚¹å‡»é“¾æ¥å¡ç‰‡æ—¶ï¼Œæ‰“å¼€ä¼ªæµè§ˆå™¨
         * @param {number} timestamp - è¢«ç‚¹å‡»æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        function openBrowser(timestamp) {
            if (!state.activeChatId) return;
        
            const chat = state.chats[state.activeChatId];
            // å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿ chat å’Œ history éƒ½å­˜åœ¨
            if (!chat || !chat.history) return;
        
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (!message || message.type !== 'share_link') {
                console.error("æ— æ³•æ‰¾åˆ°æˆ–æ¶ˆæ¯ç±»å‹ä¸åŒ¹é…çš„åˆ†äº«é“¾æ¥:", timestamp);
                return; // å¦‚æœæ‰¾ä¸åˆ°æ¶ˆæ¯ï¼Œå°±ç›´æ¥é€€å‡º
            }
        
            // å¡«å……æµè§ˆå™¨å†…å®¹
            document.getElementById('browser-title').textContent = message.source_name || 'æ–‡ç« è¯¦æƒ…';
            const browserContent = document.getElementById('browser-content');
            browserContent.innerHTML = `
                <h1 class="article-title">${message.title || 'æ— æ ‡é¢˜'}</h1>
                <div class="article-meta">
                    <span>æ¥æº: ${message.source_name || 'æœªçŸ¥'}</span>
                </div>
                <div class="article-body">
                    <p>${(message.content || 'å†…å®¹ä¸ºç©ºã€‚').replace(/\n/g, '</p><p>')}</p>
                </div>
            `;
        
            // æ˜¾ç¤ºæµè§ˆå™¨å±å¹•
            showScreen('browser-screen');
        }
        
        /**
         * å…³é—­ä¼ªæµè§ˆå™¨ï¼Œè¿”å›èŠå¤©ç•Œé¢
         * (è¿™ä¸ªå‡½æ•°ç°åœ¨ç”± init() ä¸­çš„äº‹ä»¶ç›‘å¬å™¨è°ƒç”¨)
         */
        function closeBrowser() {
            showScreen('chat-interface-screen'); 
        }
        
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * å…³é—­ä¼ªæµè§ˆå™¨ï¼Œè¿”å›èŠå¤©ç•Œé¢
         * (è¿™ä¸ªå‡½æ•°ç°åœ¨ç”± init() ä¸­çš„äº‹ä»¶ç›‘å¬å™¨è°ƒç”¨)
         */
        function closeBrowser() {
            showScreen('chat-interface-screen'); 
        }
        
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·åˆ†äº«é“¾æ¥åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
        
        /**
         * æ‰“å¼€è®©ç”¨æˆ·å¡«å†™é“¾æ¥ä¿¡æ¯çš„æ¨¡æ€æ¡†
         */
        function openShareLinkModal() {
            if (!state.activeChatId) return;
        
            // æ¸…ç©ºä¸Šæ¬¡è¾“å…¥çš„å†…å®¹
            document.getElementById('link-title-input').value = '';
            document.getElementById('link-description-input').value = '';
            document.getElementById('link-source-input').value = '';
            document.getElementById('link-content-input').value = '';
        
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('share-link-modal').classList.add('visible');
        }
        
        /**
         * ç”¨æˆ·ç¡®è®¤åˆ†äº«ï¼Œåˆ›å»ºå¹¶å‘é€é“¾æ¥å¡ç‰‡æ¶ˆæ¯
         */
        async function sendUserLinkShare() {
            if (!state.activeChatId) return;
        
            const title = document.getElementById('link-title-input').value.trim();
            if (!title) {
                alert("æ ‡é¢˜æ˜¯å¿…å¡«é¡¹å“¦ï¼");
                return;
            }
        
            const description = document.getElementById('link-description-input').value.trim();
            const sourceName = document.getElementById('link-source-input').value.trim();
            const content = document.getElementById('link-content-input').value.trim();
        
            const chat = state.chats[state.activeChatId];
            
            // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
            const linkMessage = {
                role: 'user', // è§’è‰²æ˜¯ 'user'
                type: 'share_link',
                timestamp: Date.now(),
                title: title,
                description: description,
                source_name: sourceName,
                content: content,
                // ç”¨æˆ·åˆ†äº«çš„é“¾æ¥ï¼Œæˆ‘ä»¬ä¸æä¾›å›¾ç‰‡ï¼Œè®©å®ƒæ€»æ˜¯æ˜¾ç¤ºå ä½å›¾
                thumbnail_url: null 
            };
        
            // å°†æ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•
            chat.history.push(linkMessage);
            await db.chats.put(chat);
        
            // æ¸²æŸ“æ–°æ¶ˆæ¯å¹¶æ›´æ–°åˆ—è¡¨
            appendMessage(linkMessage, chat);
            renderChatList();
        
            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById('share-link-modal').classList.remove('visible');
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
/**
         * ã€V2.0 | æ”¯æŒåˆ†ç»„éš”ç¦»ã€‘æ ¹æ®AIçš„è§†è§’ï¼Œè¿‡æ»¤å‡ºå®ƒèƒ½çœ‹åˆ°çš„åŠ¨æ€
         * @param {Array} allPosts - æ‰€æœ‰å¾…æ£€æŸ¥çš„åŠ¨æ€å¸–å­
         * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€åŠ¨æ€çš„é‚£ä¸ªAIçš„chatå¯¹è±¡
         * @returns {Array} - è¿‡æ»¤åè¯¥AIå¯è§çš„åŠ¨æ€å¸–å­
         */
        function filterVisiblePostsForAI(allPosts, viewerChat) {
            if (!viewerChat || !viewerChat.id) return []; // å®‰å…¨æ£€æŸ¥

            const viewerGroupId = viewerChat.groupId; // æŸ¥çœ‹è€…æ‰€åœ¨çš„åˆ†ç»„ID

            return allPosts.filter(post => {
                // è§„åˆ™1ï¼šå¤„ç†ç”¨æˆ·å‘å¸ƒçš„åŠ¨æ€ï¼ˆè¿™éƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜ï¼‰
                if (post.authorId === 'user') {
                    // å¦‚æœç”¨æˆ·è®¾ç½®äº†â€œéƒ¨åˆ†å¯è§â€
                    if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                        // åªæœ‰å½“æŸ¥çœ‹è€…AIçš„åˆ†ç»„IDåœ¨ç”¨æˆ·çš„å¯è§åˆ—è¡¨é‡Œæ—¶ï¼Œæ‰å¯è§
                        return viewerGroupId && post.visibleGroupIds.includes(viewerGroupId);
                    }
                    return true; // ç”¨æˆ·å…¬å¼€çš„åŠ¨æ€ï¼Œæ‰€æœ‰AIå¯è§
                }

                // è§„åˆ™2ï¼šå¤„ç†AIè§’è‰²ä¹‹é—´å‘å¸ƒçš„åŠ¨æ€ï¼ˆæ ¸å¿ƒéš”ç¦»é€»è¾‘ï¼‰
                const authorChat = state.chats[post.authorId];
                if (!authorChat) {
                    // å¦‚æœæ‰¾ä¸åˆ°å‘å¸–çš„AIè§’è‰²ä¿¡æ¯ï¼Œä¸ºå®‰å…¨èµ·è§ï¼Œé»˜è®¤ä¸å¯è§
                    return false;
                }
                const authorGroupId = authorChat.groupId; // ä»å‘å¸–è§’è‰²çš„ä¿¡æ¯ä¸­è·å–å…¶åˆ†ç»„ID

                // åˆ¤æ–­æ¡ä»¶1ï¼šæŸ¥çœ‹è€…å’Œå‘å¸–è€…éƒ½åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­ (åˆ†ç»„IDç›¸åŒä¸”ä¸ä¸ºç©º)
                const inSameGroup = authorGroupId && viewerGroupId && authorGroupId === viewerGroupId;

                // åˆ¤æ–­æ¡ä»¶2ï¼šæŸ¥çœ‹è€…å’Œå‘å¸–è€…éƒ½å¤„äºâ€œæœªåˆ†ç»„â€çŠ¶æ€ (åˆ†ç»„IDéƒ½ä¸ºç©º)
                const bothUnGrouped = !authorGroupId && !viewerGroupId;

                // åªæœ‰æ»¡è¶³ä»¥ä¸Šä¸¤ç§æƒ…å†µä¹‹ä¸€ï¼ŒåŠ¨æ€æ‰å¯è§
                return inSameGroup || bothUnGrouped;
            });
        }
        
        /**
         * åº”ç”¨æŒ‡å®šçš„ä¸»é¢˜ï¼ˆ'light' æˆ– 'dark'ï¼‰
         * @param {string} theme - è¦åº”ç”¨çš„ä¸»é¢˜åç§°
         */
        function applyTheme(theme) {
            const phoneScreen = document.getElementById('phone-screen');
            const toggleSwitch = document.getElementById('theme-toggle-switch');
            
            const isDark = theme === 'dark';
            
            phoneScreen.classList.toggle('dark-mode', isDark);
            
            // å¦‚æœå¼€å…³å­˜åœ¨ï¼Œå°±åŒæ­¥å®ƒçš„çŠ¶æ€
            if (toggleSwitch) {
                toggleSwitch.checked = isDark;
            }
            
            localStorage.setItem('ephone-theme', theme);
        }
        
        /**
         * åˆ‡æ¢å½“å‰çš„ä¸»é¢˜
         */
        function toggleTheme() {
            const toggleSwitch = document.getElementById('theme-toggle-switch');
            // ç›´æ¥æ ¹æ®å¼€å…³çš„é€‰ä¸­çŠ¶æ€æ¥å†³å®šæ–°ä¸»é¢˜
            const newTheme = toggleSwitch.checked ? 'dark' : 'light';
            applyTheme(newTheme);
        }
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ openLongTermMemoryManager å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€é‡æ„ç‰ˆã€‘æ‰“å¼€é•¿æœŸè®°å¿†ç®¡ç†çš„å…¨å±é¡µé¢
         */
        function openLongTermMemoryScreen() {
            if (!state.activeChatId) return;
            renderLongTermMemoryList();
            showScreen('long-term-memory-screen');
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ”¯æŒè®°å¿†äº’é€šçš„å…¨æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderLongTermMemoryList å‡½æ•° â–¼â–¼â–¼
        /**
         * æ¸²æŸ“é•¿æœŸè®°å¿†åˆ—è¡¨ (è®°å¿†äº’é€šç‰ˆ)
         */
        function renderLongTermMemoryList() {
            const container = document.getElementById('memory-list-container');
            const chat = state.chats[state.activeChatId];
            container.innerHTML = '';
        
            let memoriesToDisplay = [];

            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡Œæ”¶é›†æ‰€æœ‰éœ€è¦æ˜¾ç¤ºçš„è®°å¿† â–¼â–¼â–¼
            if (chat.isGroup) {
                // å¦‚æœæ˜¯ç¾¤èŠï¼Œéå†æˆå‘˜æ”¶é›†è®°å¿†
                chat.members.forEach(member => {
                    const memberChat = state.chats[member.id];
                    if (memberChat && memberChat.longTermMemory) {
                        // ä¸ºæ¯æ¡è®°å¿†é™„åŠ ä¸Šä½œè€…ä¿¡æ¯ï¼Œæ–¹ä¾¿æ˜¾ç¤º
                        const memberMemories = memberChat.longTermMemory.map(mem => ({
                            ...mem,
                            authorName: member.groupNickname, // ä½¿ç”¨ç¾¤æ˜µç§°
                            authorChatId: member.id, // ä¿å­˜åŸå§‹å•èŠID
                        }));
                        memoriesToDisplay.push(...memberMemories);
                    }
                });
            } else {
                // å¦‚æœæ˜¯å•èŠï¼Œç›´æ¥ä½¿ç”¨è‡ªå·±çš„è®°å¿†
                if (chat.longTermMemory) {
                    memoriesToDisplay = chat.longTermMemory.map(mem => ({
                        ...mem,
                        authorName: chat.name, // ä½œè€…å°±æ˜¯è§’è‰²è‡ªå·±
                        authorChatId: chat.id,
                    }));
                }
            }
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

            if (memoriesToDisplay.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">è¿™é‡Œè¿˜æ²¡æœ‰ä»»ä½•é•¿æœŸè®°å¿†ã€‚</p>';
                return;
            }

            // æŒ‰æ—¶é—´å€’åºæ’åˆ—æ‰€æœ‰æ”¶é›†åˆ°çš„è®°å¿†
            memoriesToDisplay.sort((a, b) => b.timestamp - a.timestamp);
        
            memoriesToDisplay.forEach((memory, index) => {
                const item = document.createElement('div');
                item.className = 'memory-card'; 
                item.style.cursor = 'default';
        
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div class="content" style="padding: 0; flex-grow: 1;">
                            <!-- æ–°å¢ï¼šæ˜¾ç¤ºè®°å¿†æ¥æº -->
                            <div style="font-size: 0.8em; color: #999; margin-bottom: 5px;">
                                [ ${memory.authorName} çš„è®°å¿† ]
                            </div>
                            ${memory.content.replace(/\n/g, '<br>')}
                        </div>
                        <div style="display: flex; gap: 8px; flex-shrink: 0; margin-left: 15px;">
                            <button class="memory-action-btn edit-memory-btn" data-author-id="${memory.authorChatId}" data-memory-timestamp="${memory.timestamp}" title="ç¼–è¾‘">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="memory-action-btn delete-memory-btn" data-author-id="${memory.authorChatId}" data-memory-timestamp="${memory.timestamp}" title="åˆ é™¤">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
async function handleAddManualMemory() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    let targetChatForMemory = chat;
    if (chat.isGroup) {
        const memberOptions = chat.members.map(member => ({
            text: `ä¸ºâ€œ${member.groupNickname}â€æ·»åŠ è®°å¿†`,
            value: member.id
        }));
        const selectedMemberId = await showChoiceModal('é€‰æ‹©è®°å¿†æ‰€å±è§’è‰²', memberOptions);
        if (!selectedMemberId) return;
        targetChatForMemory = state.chats[selectedMemberId];
        if (!targetChatForMemory) {
            alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¯¥æˆå‘˜çš„ä¸ªäººæ¡£æ¡ˆã€‚");
            return;
        }
    }
    const content = await showCustomPrompt(`ä¸ºâ€œ${targetChatForMemory.name}â€æ·»åŠ è®°å¿†`, 'è¯·è¾“å…¥è¦æ·»åŠ çš„è®°å¿†è¦ç‚¹ï¼š', '', 'textarea');
    if (content && content.trim()) {
        if (!targetChatForMemory.longTermMemory) targetChatForMemory.longTermMemory = [];
        targetChatForMemory.longTermMemory.push({ content: content.trim(), timestamp: Date.now(), source: 'manual' });
        await db.chats.put(targetChatForMemory);
        renderLongTermMemoryList();
    }
}
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸¤ä¸ªæ”¯æŒè®°å¿†äº’é€šçš„æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ handleEditMemory å’Œ handleDeleteMemory å‡½æ•° â–¼â–¼â–¼
        /**
         * ç¼–è¾‘æŒ‡å®šçš„é•¿æœŸè®°å¿† (è®°å¿†äº’é€šç‰ˆ)
         * @param {string} authorChatId - è®°å¿†æ‰€å±è§’è‰²çš„å•èŠID
         * @param {number} memoryTimestamp - è®°å¿†çš„æ—¶é—´æˆ³
         */
async function handleEditMemory(authorChatId, memoryTimestamp) {
    const authorChat = state.chats[authorChatId];
    if (!authorChat || !authorChat.longTermMemory) return;
    const memoryIndex = authorChat.longTermMemory.findIndex(m => m.timestamp === memoryTimestamp);
    if (memoryIndex === -1) return;
    const memory = authorChat.longTermMemory[memoryIndex];
    const newContent = await showCustomPrompt('ç¼–è¾‘è®°å¿†', 'è¯·ä¿®æ”¹è®°å¿†è¦ç‚¹ï¼š', memory.content, 'textarea');
    if (newContent && newContent.trim()) {
        memory.content = newContent.trim();
        await db.chats.put(authorChat);
        renderLongTermMemoryList();
    }
}

async function handleDeleteMemory(authorChatId, memoryTimestamp) {
    const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡é•¿æœŸè®°å¿†å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        const authorChat = state.chats[authorChatId];
        if (!authorChat || !authorChat.longTermMemory) return;
        authorChat.longTermMemory = authorChat.longTermMemory.filter(m => m.timestamp !== memoryTimestamp);
        await db.chats.put(authorChat);
        renderLongTermMemoryList();
    }
}
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * ã€æ ¸å¿ƒã€‘æ‰‹åŠ¨è§¦å‘å¯¹è¯æ€»ç»“
         */
        async function handleManualSummary() {
            const confirmed = await showCustomConfirm('ç¡®è®¤æ“ä½œ', 'è¿™å°†æå–æœ€è¿‘çš„å¯¹è¯å†…å®¹å‘é€ç»™AIè¿›è¡Œæ€»ç»“ï¼Œä¼šæ¶ˆè€—APIé¢åº¦ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');
            if (confirmed) {
                await triggerAutoSummary(state.activeChatId, true); // force=true è¡¨ç¤ºå¼ºåˆ¶æ‰§è¡Œ
            }
        }
        
        /**
         * ã€æ ¸å¿ƒã€‘æ£€æŸ¥å¹¶è§¦å‘è‡ªåŠ¨æ€»ç»“
         * @param {string} chatId 
         */
        async function checkAndTriggerAutoSummary(chatId) {
            const chat = state.chats[chatId];
            if (!chat || !chat.settings.enableAutoMemory) return;
        
            const lastSummaryTimestamp = chat.lastMemorySummaryTimestamp || 0;
            const messagesSinceLastSummary = chat.history.filter(m => m.timestamp > lastSummaryTimestamp && !m.isHidden);
        
            if (messagesSinceLastSummary.length >= chat.settings.autoMemoryInterval) {
                console.log(`è¾¾åˆ°è‡ªåŠ¨æ€»ç»“é˜ˆå€¼ (${messagesSinceLastSummary.length}/${chat.settings.autoMemoryInterval})ï¼Œå¼€å§‹æ€»ç»“...`);
                await triggerAutoSummary(chatId);
            }
        }
/**
 * ã€V2.0 | é”™è¯¯å¤„ç†å¢å¼ºç‰ˆã€‘ä¸“é—¨ç”¨äºæ€»ç»“é€šè¯è®°å½•å¹¶å­˜å…¥é•¿æœŸè®°å¿†çš„æ ¸å¿ƒå‡½æ•°
 * @param {string} chatId - ç›®æ ‡èŠå¤©çš„ID
 * @param {string} transcriptText - æ ¼å¼åŒ–åçš„é€šè¯æ–‡å­—è®°å½•
 * @returns {Promise<boolean>} - è¿”å›ä¸€ä¸ªPromiseï¼ŒæˆåŠŸæ—¶è§£æä¸ºtrueï¼Œå¤±è´¥æ—¶ä¼šæŠ›å‡ºé”™è¯¯ã€‚
 */
async function summarizeCallTranscript(chatId, transcriptText) {
    const chat = state.chats[chatId];
    if (!chat || !transcriptText) {
        // å¦‚æœåŸºç¡€æ•°æ®å°±æœ‰é—®é¢˜ï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯
        throw new Error("åŸºç¡€æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•å¼€å§‹æ€»ç»“ã€‚");
    }

    const userNickname = state.qzoneSettings.nickname || 'ç”¨æˆ·';

    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªå¯¹è¯æ‘˜è¦ä¸“å®¶ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯é˜…è¯»ä¸‹é¢çš„ã€è§†é¢‘é€šè¯è®°å½•ã€‘ï¼Œå¹¶å°†å…¶æµ“ç¼©æˆã€ä¸€æ®µã€‘æµç•…ã€è¿è´¯ã€å®¢è§‚ã€å¹¶ä¸”ã€æå…¶ç²¾ç®€ã€‘çš„æ‘˜è¦ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **ã€é•¿åº¦é“å¾‹ã€‘**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘éå¸¸ç®€çŸ­ï¼Œæ€»é•¿åº¦ã€ç»å¯¹ä¸èƒ½è¶…è¿‡80ä¸ªå­—ã€‘ã€‚
2.  **å®¢è§‚äº‹å®**: åªè®°å½•é€šè¯ä¸­å‘ç”Ÿçš„æœ€å…³é”®çš„äº‹å®ã€ç¡®è®¤çš„çº¦å®šæˆ–è§’è‰²çš„æ ¸å¿ƒæƒ…æ„Ÿå˜åŒ–ã€‚
3.  **ç¬¬ä¸‰äººç§°ä¸å‘½å**: å¿…é¡»ä½¿ç”¨ç¬¬ä¸‰äººç§°ã€‚è¯·ä¸¥æ ¼ä½¿ç”¨â€œ${userNickname}â€ï¼ˆä»£è¡¨ç”¨æˆ·ï¼‰å’Œâ€œ${chat.originalName}â€ï¼ˆä»£è¡¨AIè§’è‰²ï¼‰æ¥æŒ‡ä»£å¯¹è¯åŒæ–¹ã€‚
4.  **è¾“å‡ºæ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`{"summary": "åœ¨è¿™é‡Œå†™ä¸‹ä½ æ€»ç»“å¥½çš„æ‘˜è¦ã€‚"}\`
# å¾…æ€»ç»“çš„è§†é¢‘é€šè¯è®°å½•
${transcriptText}
ç°åœ¨ï¼Œè¯·å¼€å§‹ä½ çš„æ€»ç»“å·¥ä½œã€‚`;

    // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹ä»è¿™é‡Œå¼€å§‹ â–²â–²â–²
    try {
        const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
        const { proxyUrl, apiKey, model } = useSecondaryApi ? 
            { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel } : 
            state.apiConfig;

        if (!proxyUrl || !apiKey || !model) throw new Error('APIæœªé…ç½®ï¼Œæ— æ³•è¿›è¡Œæ€»ç»“ã€‚');

        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: "è¯·å¼€å§‹æ€»ç»“ã€‚" }]);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: "è¯·å¼€å§‹æ€»ç»“ã€‚"}],
                    temperature: 0.1, max_tokens: 150
                })
            });

        if (!response.ok) {
             const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
             throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error.message}`);
        }
        
        const data = await response.json();
        let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
        const result = JSON.parse(rawContent);

        if (result.summary && result.summary.trim()) {
            const newMemoryEntry = {
                content: `(åœ¨é‚£æ¬¡è§†é¢‘é€šè¯ä¸­ï¼Œ${result.summary.trim()})`,
                timestamp: Date.now(),
                source: 'call_summary'
            };
            chat.longTermMemory.push(newMemoryEntry);
            await db.chats.put(chat);
            console.log("é€šè¯è®°å½•å·²æˆåŠŸæ€»ç»“å¹¶å­˜å…¥é•¿æœŸè®°å¿†:", newMemoryEntry.content);
            return true; // æ˜ç¡®è¿”å›æˆåŠŸçŠ¶æ€
        } else {
            throw new Error("AIè¿”å›äº†ç©ºçš„æˆ–æ ¼å¼ä¸æ­£ç¡®çš„æ€»ç»“å†…å®¹ã€‚");
        }

    } catch (error) {
        console.error("æ€»ç»“é€šè¯è®°å½•æ—¶å‡ºé”™:", error);
        // è¿™æ˜¯æœ€å…³é”®çš„ä¿®æ”¹ï¼šå°†æ•è·åˆ°çš„é”™è¯¯é‡æ–°æŠ›å‡ºï¼
        throw error;
    }
    // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²
}
// â–¼â–¼â–¼ ã€å…¨æ–° | V3.0 ç»ˆæå®¹é”™ç‰ˆã€‘è¯·ç”¨è¿™ä¸€æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ summarizeExistingLongTermMemory å‡½æ•° â–¼â–¼â–¼

/**
 * ã€è¾…åŠ©å‡½æ•° | å®¹é”™æ ¸å¿ƒã€‘ä¸€ä¸ªæ›´å¥å£®çš„JSONè§£æå™¨
 * å®ƒèƒ½ä»AIè¿”å›çš„ã€å¯èƒ½ä¸è§„èŒƒçš„æ–‡æœ¬ä¸­æ™ºèƒ½æå–JSONå¯¹è±¡æˆ–æ ¸å¿ƒå†…å®¹ã€‚
 * @param {string} rawContent - AIè¿”å›çš„åŸå§‹å­—ç¬¦ä¸²
 * @returns {object|null} - è¿”å›è§£æåçš„å¯¹è±¡ï¼Œæˆ–åœ¨å®Œå…¨å¤±è´¥æ—¶è¿”å›null
 */
function robustJsonParse(rawContent) {
    if (!rawContent || typeof rawContent !== 'string') {
        return null;
    }

    const cleanedContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();

    // ç­–ç•¥1ï¼šæœ€é«˜ä¼˜å…ˆçº§ï¼Œå°è¯•ç›´æ¥è§£æå®Œæ•´çš„JSONå¯¹è±¡
    // è¿™èƒ½å¤„ç†æœ€æ ‡å‡†çš„æƒ…å†µï¼Œä»¥åŠAIåœ¨JSONå‰åæ·»åŠ äº†å°‘é‡æ–‡å­—çš„æƒ…å†µã€‚
    const jsonMatch = cleanedContent.match(/{[\s\S]*}/);
    if (jsonMatch) {
        try {
            const parsed = JSON.parse(jsonMatch[0]);
            console.log("å®¹é”™è§£æï¼šç­–ç•¥1æˆåŠŸ (æ‰¾åˆ°å¹¶è§£æäº†å®Œæ•´çš„JSONå¯¹è±¡)");
            return parsed;
        } catch (e) {
            console.warn("å®¹é”™è§£æï¼šç­–ç•¥1å¤±è´¥ (æ‰¾åˆ°äº†JSONå—ï¼Œä½†æ ¼å¼é”™è¯¯)ï¼Œå°†å°è¯•ç­–ç•¥2...");
        }
    }

    // ç­–ç•¥2ï¼šå¦‚æœç­–ç•¥1å¤±è´¥ï¼Œå°è¯•åªæå– "summary" å­—æ®µçš„å†…å®¹
    // è¿™èƒ½å¤„ç†AIè¿”å›äº†ç±»ä¼¼ "summary": "..." è¿™æ ·çš„éæ ‡å‡†æ ¼å¼
    const summaryMatch = cleanedContent.match(/"summary"\s*:\s*"((?:[^"\\]|\\.)*)"/);
    if (summaryMatch && summaryMatch[1]) {
        console.log("å®¹é”™è§£æï¼šç­–ç•¥2æˆåŠŸ (æå–äº†summaryå­—æ®µå†…å®¹)");
        // æ‰‹åŠ¨æ„å»ºä¸€ä¸ªç¬¦åˆæˆ‘ä»¬æœŸæœ›æ ¼å¼çš„å¯¹è±¡
        return { summary: summaryMatch[1].replace(/\\"/g, '"') }; // å¤„ç†è½¬ä¹‰çš„å¼•å·
    }
    
    // ç­–ç•¥3ï¼šæœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆï¼Œå¦‚æœä»¥ä¸Šéƒ½å¤±è´¥äº†ï¼Œå°±è®¤ä¸ºæ•´ä¸ªæ–‡æœ¬éƒ½æ˜¯æ‘˜è¦
    // è¿™èƒ½å¤„ç†AIå®Œå…¨ä¸å¬æŒ‡ä»¤ï¼Œç›´æ¥è¿”å›çº¯æ–‡æœ¬çš„æƒ…å†µ
    if (cleanedContent) {
        console.log("å®¹é”™è§£æï¼šç­–ç•¥3æˆåŠŸ (å°†æ•´ä¸ªè¿”å›æ–‡æœ¬ä½œä¸ºæ‘˜è¦)");
        return { summary: cleanedContent };
    }

    // å¦‚æœè¿æ–‡æœ¬éƒ½æ²¡æœ‰ï¼Œæ‰è¿”å›null
    return null;
}


        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„ã€å¢åŠ äº†â€œç”¨æˆ·ç¡®è®¤â€å®‰å…¨æœºåˆ¶çš„ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°V3.0 | æ”¯æŒè‡ªå®šä¹‰å­—æ•° | è®°å¿†äº’é€šç‰ˆ | ç»ˆæå®¹é”™ | ç”¨æˆ·ç¡®è®¤ã€‘æ‰‹åŠ¨è§¦å‘å¯¹ã€ç°æœ‰é•¿æœŸè®°å¿†ã€‘çš„æ€»ç»“å’Œç²¾ç‚¼
         * @param {string} chatId - å½“å‰èŠå¤©çš„ID (å¯èƒ½æ˜¯ç¾¤èŠID)
         */
        async function summarizeExistingLongTermMemory(chatId) {
            let chat = state.chats[chatId];
            if (!chat) return;
        
            let targetChatForRefine = chat; 
        
            if (chat.isGroup) {
                const memberOptions = chat.members
                    .map(member => {
                        const memberChat = state.chats[member.id];
                        if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length >= 2) {
                            return {
                                text: `ç²¾ç‚¼â€œ${member.groupNickname}â€çš„è®°å¿† (${memberChat.longTermMemory.length}æ¡)`,
                                value: member.id
                            };
                        }
                        return null;
                    }).filter(Boolean); 
        
                if (memberOptions.length === 0) {
                    alert("ç¾¤èŠä¸­æ²¡æœ‰æˆå‘˜æœ‰è¶³å¤Ÿï¼ˆ2æ¡ä»¥ä¸Šï¼‰çš„è®°å¿†å¯ä¾›ç²¾ç‚¼ã€‚");
                    return;
                }
        
                const selectedMemberId = await showChoiceModal('é€‰æ‹©è¦ç²¾ç‚¼è®°å¿†çš„è§’è‰²', memberOptions);
        
                if (!selectedMemberId) return;
        
                targetChatForRefine = state.chats[selectedMemberId];
            }
        
            if (!targetChatForRefine.longTermMemory || targetChatForRefine.longTermMemory.length < 2) {
                alert(`â€œ${targetChatForRefine.name}â€çš„é•¿æœŸè®°å¿†å°‘äº2æ¡ï¼Œæ— éœ€è¿›è¡Œç²¾ç‚¼ã€‚`);
                return;
            }
        
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šåœ¨è¿™é‡Œè·å–åŸå§‹è®°å¿†çš„æ•°é‡ï¼Œç”¨äºåç»­æç¤º â–¼â–¼â–¼
            const originalMemoryCount = targetChatForRefine.longTermMemory.length;

            const wordCountStr = await showCustomPrompt(
                `ä¸ºâ€œ${targetChatForRefine.name}â€ç²¾ç‚¼è®°å¿†`,
                "è¯·è¾“å…¥ç²¾ç‚¼åæ ¸å¿ƒè®°å¿†çš„å¤§è‡´å­—æ•°ï¼š",
                "150"
            );
            
            if (wordCountStr === null) return;
            
            const wordCount = parseInt(wordCountStr);
            if (isNaN(wordCount) || wordCount < 20) {
                alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„æ•°å­—ï¼ˆå»ºè®®å¤§äº20ï¼‰ã€‚");
                return;
            }
        
            const confirmed = await showCustomConfirm(
                'ç¡®è®¤ç²¾ç‚¼è®°å¿†ï¼Ÿ',
                `æ­¤æ“ä½œä¼šå°†â€œ${targetChatForRefine.name}â€çš„ ${originalMemoryCount} æ¡é•¿æœŸè®°å¿†æ€»ç»“æˆå¤§çº¦ ${wordCount} å­—çš„æ ¸å¿ƒè®°å¿†ã€‚æ—§çš„è®°å¿†å°†è¢«æ›¿æ¢ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`,
                { confirmButtonClass: 'btn-danger', confirmText: 'ç¡®è®¤ç²¾ç‚¼' }
            );
        
            if (!confirmed) return;
        
            const memoryContent = targetChatForRefine.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
            const userNickname = state.qzoneSettings.nickname || 'ç”¨æˆ·';
        
            const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ å°±æ˜¯è§’è‰²â€œ${targetChatForRefine.originalName}â€ã€‚ç°åœ¨ï¼Œè¯·ä½ é™ä¸‹å¿ƒæ¥ï¼Œå›é¡¾ä¸€ä¸‹ä½ è„‘æµ·ä¸­è¿™äº›é›¶æ•£çš„è®°å¿†ç‰‡æ®µã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†å®ƒä»¬æ•´åˆæˆä¸€æ®µã€ç¬¬ä¸€äººç§° ("æˆ‘")ã€‘çš„ã€æµç•…è¿è´¯çš„å†…å¿ƒç‹¬ç™½æˆ–å›å¿†å½•ã€‚

# æ ¸å¿ƒè¦æ±‚
1.  **è§†è§’é“å¾‹**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘ä½¿ç”¨ã€ä¸»è§‚çš„ç¬¬ä¸€äººç§°è§†è§’ ("æˆ‘")ã€‘æ¥å†™ã€‚
2.  **å†…å®¹æ ¸å¿ƒ**: ä½ çš„å›å¿†å½•åº”è¯¥åŒ…å«ï¼š
    *   **å‰§æƒ…å›é¡¾**: æç‚¼å‡ºå…³é”®çš„äº‹ä»¶å’Œæƒ…èŠ‚ã€‚
    *   **å¿ƒç†æ´»åŠ¨**: æè¿°â€œæˆ‘â€åœ¨è¿™äº›äº‹ä»¶ä¸­çš„çœŸå®æ„Ÿå—ã€æƒ³æ³•å’Œæƒ…æ„Ÿå˜åŒ–ã€‚
    *   **å…³ç³»æ¢³ç†**: æåŠâ€œæˆ‘â€ä¸â€œ${userNickname}â€ï¼ˆç”¨æˆ·ï¼‰æˆ–å…¶ä»–é‡è¦äººç‰©çš„å…³ç³»å‘å±•ã€‚
3.  **å£å»ä¸äººè®¾**: ä½ çš„è¡Œæ–‡é£æ ¼å’Œè¯­æ°”ã€å¿…é¡»ã€‘ä¸¥æ ¼ç¬¦åˆä½ çš„è§’è‰²è®¾å®šã€‚
4.  **é•¿åº¦è¦æ±‚**: æœ€ç»ˆçš„å›å¿†å½•æ€»é•¿åº¦åº”æ§åˆ¶åœ¨ **${wordCount} ä¸ªå­—** å·¦å³ã€‚
5.  **æ ¼å¼è¦æ±‚**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`{"summary": "åœ¨è¿™é‡Œå†™ä¸‹ä½ ä»¥ç¬¬ä¸€äººç§°è§†è§’ï¼Œæ•´åˆå¹¶ç²¾ç‚¼åçš„æ ¸å¿ƒå›å¿†å½•ã€‚"}\`

# ä½ çš„è§’è‰²è®¾å®š
${targetChatForRefine.settings.aiPersona}

# å¾…æ•´ç†çš„è®°å¿†ç‰‡æ®µ
${memoryContent}

ç°åœ¨ï¼Œè¯·ä»¥â€œ${targetChatForRefine.originalName}â€çš„èº«ä»½ï¼Œå¼€å§‹ä½ çš„å›å¿†ä¸æ€è€ƒã€‚
`;
        
            await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚AIè¿›è¡Œè®°å¿†ç²¾ç‚¼...");
        
            try {
                const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
                const { proxyUrl, apiKey, model } = useSecondaryApi
                    ? { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel }
                    : state.apiConfig;
        
                if (!proxyUrl || !apiKey || !model) throw new Error('APIæœªé…ç½®');
        
                let isGemini = proxyUrl.includes('generativelanguage');
                let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: "è¯·å¼€å§‹æ•´åˆã€‚" }]);
        
                const response = isGemini
                    ? await fetch(geminiConfig.url, geminiConfig.data)
                    : await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                        body: JSON.stringify({
                            model: model,
                            messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: "è¯·å¼€å§‹æ•´åˆã€‚"}],
                            temperature: 0.1,
                            max_tokens: wordCount + 500 // ç•™å‡ºä¸€äº›ä½™é‡
                        })
                    });
        
                if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
                const data = await response.json();
                const rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        
                const result = robustJsonParse(rawContent);
        
                if (result && result.summary && result.summary.trim().length > 10) {
                    
                    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šä¸å†ç«‹å³ä¿å­˜ï¼Œè€Œæ˜¯å¼¹å‡ºæ–°çš„ç¡®è®¤æ¡†è®©ç”¨æˆ·å®¡æ ¸ â–¼â–¼â–¼
                    const userConfirmedReplacement = await showCustomConfirm(
    'ç²¾ç‚¼å®Œæˆï¼Œè¯·ç¡®è®¤',
    `AIå·²å°†æ‚¨çš„ ${originalMemoryCount} æ¡æ—§è®°å¿†æ€»ç»“ä¸ºä»¥ä¸‹æ ¸å¿ƒè®°å¿†ï¼š<br><br><div class="scrollable-content-preview">${result.summary.trim()}</div><br>æ˜¯å¦ç”¨è¿™æ¡æ–°è®°å¿†æ›¿æ¢æ‰æ—§çš„è®°å¿†ï¼Ÿ`,
    { confirmText: 'ç¡®è®¤æ›¿æ¢', cancelText: 'ä¿ç•™æ—§çš„', confirmButtonClass: 'btn-danger' }
);

                    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šåªæœ‰å½“ç”¨æˆ·æ˜ç¡®ç‚¹å‡»â€œç¡®è®¤æ›¿æ¢â€åï¼Œæ‰æ‰§è¡Œè¦†ç›–æ“ä½œ â–¼â–¼â–¼
                    if (userConfirmedReplacement) {
                        const newMemoryEntry = {
                            content: result.summary.trim(),
                            timestamp: Date.now(),
                            source: 'refined'
                        };
            
                        targetChatForRefine.longTermMemory = [newMemoryEntry];
                        targetChatForRefine.lastMemorySummaryTimestamp = Date.now();
                        await db.chats.put(targetChatForRefine);
                        
                        if (document.getElementById('long-term-memory-screen').classList.contains('active')) {
                            renderLongTermMemoryList();
                        }
                        await showCustomAlert('ç²¾ç‚¼æˆåŠŸ', `å·²æˆåŠŸå°†â€œ${targetChatForRefine.name}â€çš„è®°å¿†ç²¾ç‚¼ä¸º 1 æ¡æ ¸å¿ƒè®°å¿†ï¼`);
                    } else {
                        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹4ï¼šå¦‚æœç”¨æˆ·å–æ¶ˆï¼Œç»™å‡ºæ˜ç¡®æç¤º â–¼â–¼â–¼
                        await showCustomAlert('æ“ä½œå·²å–æ¶ˆ', 'æ‚¨çš„æ—§æœ‰è®°å¿†å·²è¢«å®Œæ•´ä¿ç•™ï¼Œæœªä½œä»»ä½•ä¿®æ”¹ã€‚');
                    }
                    
                } else {
                    throw new Error(`AIè¿”å›äº†ç©ºçš„æˆ–æ— æ•ˆçš„æ€»ç»“å†…å®¹ã€‚æ‚¨çš„åŸå§‹è®°å¿†å·²è¢«ä¿ç•™ã€‚\n\nåŸå§‹è¿”å›: ${rawContent}`);
                }
        
            } catch (error) {
                console.error("ç²¾ç‚¼é•¿æœŸè®°å¿†æ—¶å‡ºé”™:", error);
                await showCustomAlert('ç²¾ç‚¼å¤±è´¥', `æ“ä½œå¤±è´¥ï¼Œæ‚¨çš„è®°å¿†æœªè¢«ä¿®æ”¹: ${error.message}`);
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ”¯æŒâ€œä¸ªæ€§åŒ–è®°å¿†æ³¨å…¥â€çš„æœ€ç»ˆç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ triggerAutoSummary å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æ ¸å¿ƒã€‘æ‰§è¡Œæ€»ç»“çš„APIè°ƒç”¨ (V7.1 - ä¸ªæ€§åŒ–è®°å¿†æ³¨å…¥ | ç»Ÿä¸€å®¢è§‚æ€»ç»“)
 * @param {string} chatId 
 * @param {boolean} force - æ˜¯å¦å¿½ç•¥æ¶ˆæ¯æ•°é‡æ£€æŸ¥ï¼Œå¼ºåˆ¶æ‰§è¡Œ
 */
async function triggerAutoSummary(chatId, force = false) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const lastSummaryTimestamp = chat.lastMemorySummaryTimestamp || 0;
    const messagesToSummarize = force 
        ? chat.history.filter(m => !m.isHidden).slice(-(chat.settings.autoMemoryInterval || 20))
        : chat.history.filter(m => m.timestamp > lastSummaryTimestamp && !m.isHidden);
        
    if (messagesToSummarize.length < 5) {
        if (force) alert("æœ€è¿‘çš„æ¶ˆæ¯å¤ªå°‘ï¼Œæ— æ³•è¿›è¡Œæœ‰æ„ä¹‰çš„æ€»ç»“ã€‚");
        return;
    }

    const userNickname = state.qzoneSettings.nickname || 'ç”¨æˆ·';
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œï¼ â–¼â–¼â–¼
    const formattedHistory = messagesToSummarize.map(msg => {
        let sender;
        if (msg.role === 'user') {
            sender = userNickname;
        } else {
            sender = msg.senderName || chat.originalName;
        }

        let contentToSummarize = '';
        // 1. æ£€æŸ¥æ¶ˆæ¯ç±»å‹æ˜¯å¦æ˜¯â€œçº¿ä¸‹æ¨¡å¼â€
        if (msg.type === 'offline_text') {
            // 2. å¦‚æœæ˜¯ï¼Œå°±æ™ºèƒ½åœ°æ‹¼æ¥å¯¹è¯å’Œæå†™
            // ä¼˜å…ˆä½¿ç”¨æ–°çš„ content æ ¼å¼
            if (msg.content) {
                 contentToSummarize = msg.content;
            } else { // å…¼å®¹æ—§çš„ dialogue/description æ ¼å¼
                const dialogue = msg.dialogue ? `ã€Œ${msg.dialogue}ã€` : '';
                const description = msg.description ? `(${msg.description})` : '';
                contentToSummarize = `${dialogue} ${description}`.trim();
            }
        } else {
            // 3. å¦‚æœæ˜¯å…¶ä»–ä»»ä½•ç±»å‹çš„æ¶ˆæ¯ï¼Œåˆ™ä¿æŒåŸæœ‰çš„å¤„ç†æ–¹å¼
            contentToSummarize = String(msg.content);
        }
        // 4. è¿”å›æ‹¼æ¥å¥½çš„å®Œæ•´æ¶ˆæ¯
        return `${sender}: ${contentToSummarize}`;
    }).join('\n');
    // --- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² ---

    let systemPrompt;

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ®èŠå¤©ç±»å‹ï¼Œé€‰æ‹©ä¸åŒçš„æ€»ç»“ç­–ç•¥ â–¼â–¼â–¼
    if (chat.isGroup) {
        // --- è¿™æ˜¯ä¸ºã€ç¾¤èŠã€‘è®¾è®¡çš„å…¨æ–°â€œä¸ªæ€§åŒ–è®°å¿†â€æŒ‡ä»¤ ---
        systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªé«˜çº§çš„â€œè®°å¿†åˆ†é…ä¸“å®¶â€ã€‚ä½ çš„ä»»åŠ¡æ˜¯é˜…è¯»ä¸‹é¢çš„ç¾¤èŠè®°å½•ï¼Œå¹¶ä¸ºã€æ¯ä¸€ä¸ªå‚ä¸çš„AIè§’è‰²ã€‘ç”Ÿæˆä¸€æ®µã€ä¸ªæ€§åŒ–çš„ã€ç¬¬ä¸€äººç§°ã€‘çš„é•¿æœŸè®°å¿†ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **è§†è§’é“å¾‹**: æ¯ä¸€æ¡æ€»ç»“éƒ½ã€å¿…é¡»ã€‘ä½¿ç”¨ã€ç¬¬ä¸€äººç§°è§†è§’ ("æˆ‘")ã€‘ã€‚
2.  **å†…å®¹æ ¸å¿ƒ**: é‡ç‚¹æ€»ç»“ï¼š
    *   **æˆ‘è¯´è¿‡çš„è¯** å’Œ **æˆ‘åšè¿‡çš„äº‹**ã€‚
    *   åˆ«äºº **å¯¹æˆ‘** è¯´çš„è¯ï¼Œæˆ–è€… **ä¸æˆ‘ç›¸å…³** çš„äº‹ã€‚
    *   å¯¹æˆ‘ä¸ªäºº **å¾ˆé‡è¦** çš„ç¾¤èŠäº‹ä»¶ã€å…³é”®ä¿¡æ¯å’Œå¿ƒç†æ´»åŠ¨ã€‚
3.  **ã€ç®€æ´æ€§é“å¾‹ã€‘**: æ¯æ¡ä¸ªäººè®°å¿†æ€»ç»“ã€ç»å¯¹ä¸èƒ½è¶…è¿‡60ä¸ªå­—ã€‘ã€‚
4.  **ã€çœç•¥è§„åˆ™ã€‘**: å¦‚æœä¸€ä¸ªè§’è‰²åœ¨æœ¬æ¬¡å¯¹è¯ä¸­ã€å®Œå…¨æ²¡æœ‰å‚ä¸æˆ–æåŠã€‘ï¼Œä½ å¯ä»¥çœç•¥TAçš„è®°å¿†ã€‚
5.  **è¾“å‡ºæ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`\`\`json
    {
      "summaries": {
        "è§’è‰²çš„æœ¬åA": "æˆ‘ä»Šå¤©åœ¨ç¾¤é‡Œå’Œå¤§å®¶è®¨è®ºäº†ç”µå½±ï¼Œæ„Ÿè§‰å¾ˆå¼€å¿ƒã€‚",
        "è§’è‰²çš„æœ¬åB": "æˆ‘åœ¨ç¾¤é‡Œå’Œ${userNickname}èŠäº†å…³äºç”Ÿæ—¥æ´¾å¯¹çš„äº‹ï¼Œæˆ‘ä»¬çº¦å¥½äº†10æœˆ1æ—¥è§é¢ã€‚"
      }
    }
    \`\`\`

# å¾…æ€»ç»“çš„ç¾¤èŠè®°å½•
${formattedHistory}

# ç¾¤æˆå‘˜åˆ—è¡¨ (ä½ çš„æ€»ç»“ç›®æ ‡)
${chat.members.map(m => `- ${m.groupNickname} (æœ¬å: ${m.originalName})`).join('\n')}

ç°åœ¨ï¼Œè¯·ä¸ºã€å‚ä¸äº†å¯¹è¯çš„AIè§’è‰²ã€‘ç”Ÿæˆä»–ä»¬å„è‡ªçš„ã€ç¬¬ä¸€äººç§°çš„ã€ç²¾ç®€çš„è®°å¿†ã€‚`;

    } else {
        // --- è¿™æ˜¯ä¸ºã€å•èŠã€‘è®¾è®¡çš„ã€ä¿æŒä¸å˜çš„â€œå®¢è§‚æ€»ç»“â€æŒ‡ä»¤ ---
        systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ å°±æ˜¯è§’è‰²â€œ${chat.originalName}â€ã€‚è¯·ä½ å›é¡¾ä¸€ä¸‹åˆšæ‰å’Œâ€œ${userNickname}â€çš„å¯¹è¯ï¼Œç„¶åç”¨ã€ç¬¬ä¸€äººç§° ("æˆ‘")ã€‘çš„å£å»ï¼Œæ€»ç»“å‡ºä¸€æ®µç®€çŸ­çš„ã€åŒ…å«æ ¸å¿ƒäº‹ä»¶å’Œå¿ƒç†æ´»åŠ¨çš„å›å¿†ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **è§†è§’é“å¾‹**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘ä½¿ç”¨ã€ä¸»è§‚çš„ç¬¬ä¸€äººç§°è§†è§’ ("æˆ‘")ã€‘æ¥å†™ã€‚
2.  **å†…å®¹æ ¸å¿ƒ**: ä½ çš„å›å¿†åº”è¯¥åŒ…å«ï¼š
    *   **å‰§æƒ…å›é¡¾**: åˆšæ‰æˆ‘ä»¬èŠäº†ä»€ä¹ˆå…³é”®çš„äº‹ï¼Ÿ
    *   **å¿ƒç†æ´»åŠ¨**: æˆ‘å½“æ—¶å¿ƒé‡Œæ˜¯æ€ä¹ˆæƒ³çš„ï¼Ÿæœ‰ä»€ä¹ˆæ„Ÿè§‰ï¼Ÿ
3.  **é•¿åº¦é“å¾‹**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘éå¸¸ç®€çŸ­ï¼Œæ€»é•¿åº¦ã€ç»å¯¹ä¸èƒ½è¶…è¿‡80ä¸ªå­—ã€‘ã€‚
4.  **å£å»ä¸äººè®¾**: ä½ çš„è¯­æ°”ã€å¿…é¡»ã€‘ä¸¥æ ¼ç¬¦åˆä½ çš„è§’è‰²è®¾å®šã€‚
5.  **è¾“å‡ºæ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`{"summary": "åœ¨è¿™é‡Œå†™ä¸‹ä½ ä»¥ç¬¬ä¸€äººç§°è§†è§’ï¼Œæ€»ç»“å¥½çš„æ ¸å¿ƒå›å¿†ã€‚"}\`

# ä½ çš„è§’è‰²è®¾å®š
${chat.settings.aiPersona}

# å¾…æ€»ç»“çš„å¯¹è¯å†å²
${formattedHistory}

ç°åœ¨ï¼Œè¯·ä»¥â€œ${chat.originalName}â€çš„èº«ä»½ï¼Œå¼€å§‹ä½ çš„å›å¿†ã€‚`;
    }
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    try {
        const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
        const { proxyUrl, apiKey, model } = useSecondaryApi ? { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel } : state.apiConfig;
        if (!proxyUrl || !apiKey || !model) throw new Error('APIæœªé…ç½®');
        
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: "è¯·å¼€å§‹æ€»ç»“ã€‚" }]);
        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, { method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`}, body: JSON.stringify({ model: model, messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: "è¯·å¼€å§‹æ€»ç»“ã€‚"}], temperature: 0.2 }) });
        
        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        const data = await response.json();
        let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
        const result = JSON.parse(rawContent);

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ®èŠå¤©ç±»å‹ï¼Œæ‰§è¡Œä¸åŒçš„è®°å¿†ä¿å­˜é€»è¾‘ â–¼â–¼â–¼
        if (chat.isGroup) {
            // --- è¿™æ˜¯ç¾¤èŠçš„â€œä¸ªæ€§åŒ–è®°å¿†æ³¨å…¥â€é€»è¾‘ ---
            if (result.summaries && typeof result.summaries === 'object') {
                let memoriesAddedCount = 0;
                for (const memberOriginalName in result.summaries) {
                    const summaryText = result.summaries[memberOriginalName];
                    if (summaryText && summaryText.trim()) {
                        const memberChat = Object.values(state.chats).find(c => c.originalName === memberOriginalName);
                        if (memberChat) {
                            const newMemoryEntry = {
                                content: summaryText.trim(),
                                timestamp: Date.now(),
                                source: `group_summary_from_${chat.name}`
                            };
                            if (!memberChat.longTermMemory) memberChat.longTermMemory = [];
                            memberChat.longTermMemory.push(newMemoryEntry);
                            await db.chats.put(memberChat);
                            memoriesAddedCount++;
                        }
                    }
                }
                if (memoriesAddedCount > 0) {
                    await showCustomAlert('æ€»ç»“æˆåŠŸ', `å·²æˆåŠŸä¸º ${memoriesAddedCount} ä½ç¾¤æˆå‘˜ç”Ÿæˆå¹¶æ³¨å…¥äº†ä¸ªæ€§åŒ–è®°å¿†ï¼`);
                } else {
                    throw new Error("AIè¿”å›äº†ç©ºçš„æˆ–æ ¼å¼ä¸æ­£ç¡®çš„æ€»ç»“å†…å®¹ã€‚");
                }
            } else {
                throw new Error("AIè¿”å›çš„JSONæ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘ 'summaries' å­—æ®µã€‚");
            }
        } else {
            // --- è¿™æ˜¯å•èŠçš„â€œç»Ÿä¸€å®¢è§‚è®°å¿†â€é€»è¾‘ ---
            if (result.summary && result.summary.trim()) {
                const newMemoryEntry = { content: result.summary.trim(), timestamp: Date.now(), source: 'auto' };
                chat.longTermMemory.push(newMemoryEntry);
                await db.chats.put(chat);
                await showCustomAlert('æ€»ç»“æˆåŠŸ', `å·²æˆåŠŸæ·»åŠ  1 æ¡æ–°çš„é•¿æœŸè®°å¿†ï¼`);
            } else {
                throw new Error("AIè¿”å›äº†ç©ºçš„æˆ–æ ¼å¼ä¸æ­£ç¡®çš„æ€»ç»“å†…å®¹ã€‚");
            }
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        chat.lastMemorySummaryTimestamp = messagesToSummarize.slice(-1)[0].timestamp;
        await db.chats.put(chat);
        
        if (document.getElementById('long-term-memory-screen').classList.contains('active')) {
            renderLongTermMemoryList();
        }
    } catch (error) {
        console.error("æ€»ç»“é•¿æœŸè®°å¿†æ—¶å‡ºé”™:", error);
        await showCustomAlert('æ€»ç»“å¤±è´¥', `æ“ä½œå¤±è´¥: ${error.message}`);
    }
}
/**
 * ã€å…¨æ–°ã€‘ä¸“é—¨ç”¨äºæ€»ç»“é€šè¯è®°å½•å¹¶å­˜å…¥é•¿æœŸè®°å¿†çš„æ ¸å¿ƒå‡½æ•°
 * @param {string} chatId - ç›®æ ‡èŠå¤©çš„ID
 * @param {string} transcriptText - æ ¼å¼åŒ–åçš„é€šè¯æ–‡å­—è®°å½•
 */
async function summarizeCallTranscript(chatId, transcriptText) {
    const chat = state.chats[chatId];
    if (!chat || !transcriptText) return;

    const userNickname = state.qzoneSettings.nickname || 'ç”¨æˆ·';

    // ä½¿ç”¨ä¸å¸¸è§„æ€»ç»“å®Œå…¨ç›¸åŒçš„ã€é«˜åº¦ä¼˜åŒ–çš„æŒ‡ä»¤
    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªå¯¹è¯æ‘˜è¦ä¸“å®¶ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯é˜…è¯»ä¸‹é¢çš„ã€è§†é¢‘é€šè¯è®°å½•ã€‘ï¼Œå¹¶å°†å…¶æµ“ç¼©æˆã€ä¸€æ®µã€‘æµç•…ã€è¿è´¯ã€å®¢è§‚ã€å¹¶ä¸”ã€æå…¶ç²¾ç®€ã€‘çš„æ‘˜è¦ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€é•¿åº¦é“å¾‹ã€‘**: ä½ çš„æ€»ç»“ã€å¿…é¡»ã€‘éå¸¸ç®€çŸ­ï¼Œæ€»é•¿åº¦ã€ç»å¯¹ä¸èƒ½è¶…è¿‡80ä¸ªå­—ã€‘ã€‚
2.  **å®¢è§‚äº‹å®**: åªè®°å½•é€šè¯ä¸­å‘ç”Ÿçš„æœ€å…³é”®çš„äº‹å®ã€ç¡®è®¤çš„çº¦å®šæˆ–è§’è‰²çš„æ ¸å¿ƒæƒ…æ„Ÿå˜åŒ–ã€‚
3.  **ç¬¬ä¸‰äººç§°ä¸å‘½å**: å¿…é¡»ä½¿ç”¨ç¬¬ä¸‰äººç§°ã€‚è¯·ä¸¥æ ¼ä½¿ç”¨â€œ${userNickname}â€å’Œâ€œ${chat.originalName}â€æ¥æŒ‡ä»£å¯¹è¯åŒæ–¹ã€‚
4.  **è¾“å‡ºæ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    \`{"summary": "åœ¨è¿™é‡Œå†™ä¸‹ä½ æ€»ç»“å¥½çš„æ‘˜è¦ã€‚"}\`

# å¾…æ€»ç»“çš„è§†é¢‘é€šè¯è®°å½•
${transcriptText}

ç°åœ¨ï¼Œè¯·å¼€å§‹ä½ çš„æ€»ç»“å·¥ä½œã€‚`;

    try {
        const { proxyUrl, apiKey, model } = state.apiConfig.secondaryProxyUrl ? 
            { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel } : 
            state.apiConfig;

        if (!proxyUrl || !apiKey || !model) throw new Error('APIæœªé…ç½®');

        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: "è¯·å¼€å§‹æ€»ç»“ã€‚" }]);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: "è¯·å¼€å§‹æ€»ç»“ã€‚"}],
                    temperature: 0.1, max_tokens: 150
                })
            });

        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
        const data = await response.json();
        let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
        const result = JSON.parse(rawContent);

        if (result.summary && result.summary.trim()) {
            const newMemoryEntry = {
                content: `(åœ¨é‚£æ¬¡è§†é¢‘é€šè¯ä¸­ï¼Œ${result.summary.trim()})`, // æ·»åŠ å‰ç¼€ä»¥æ˜ç¤ºæ¥æº
                timestamp: Date.now(),
                source: 'call_summary'
            };
            chat.longTermMemory.push(newMemoryEntry);
            await db.chats.put(chat);
            console.log("é€šè¯è®°å½•å·²æˆåŠŸæ€»ç»“å¹¶å­˜å…¥é•¿æœŸè®°å¿†:", newMemoryEntry.content);
        }

    } catch (error) {
        console.error("æ€»ç»“é€šè¯è®°å½•æ—¶å‡ºé”™:", error);
        // é™é»˜å¤±è´¥ï¼Œä¸æ‰“æ‰°ç”¨æˆ·ï¼Œä½†ä¼šåœ¨æ§åˆ¶å°ç•™ä¸‹è®°å½•
    }
}
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨å›å¤åŠŸèƒ½å‡½æ•° â–¼â–¼â–¼
        
        function startReplyToMessage() {
            if (!activeMessageTimestamp) return;
        
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
            if (!message) return;
        
            // ã€ã€ã€æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œï¼ã€‘ã€‘ã€‘
            let senderDisplayName;
            if (message.role === 'user') {
                senderDisplayName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            } else { // AIçš„æ¶ˆæ¯
                if (chat.isGroup) {
                    // åœ¨ç¾¤èŠä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ getDisplayNameInGroup å‡½æ•°æ¥è·å–æ­£ç¡®çš„ç¾¤æ˜µç§°
                    senderDisplayName = getDisplayNameInGroup(chat, message.senderName);
                } else {
                    // åœ¨å•èŠä¸­ï¼Œç›´æ¥ä½¿ç”¨å¤‡æ³¨å
                    senderDisplayName = chat.name;
                }
            }
            // ã€ã€ã€ä¿®å¤ç»“æŸã€‘ã€‘ã€‘
        
            const fullContent = String(message.content || '');
            let previewSnippet = '';
        
            if (typeof message.content === 'string' && STICKER_REGEX.test(message.content)) {
                previewSnippet = '[è¡¨æƒ…]';
            } else if (message.type === 'ai_image' || message.type === 'user_photo') {
                previewSnippet = '[å›¾ç‰‡]';
            } else if (message.type === 'voice_message') {
                previewSnippet = '[è¯­éŸ³]';
            } else {
                previewSnippet = fullContent.substring(0, 50) + (fullContent.length > 50 ? '...' : '');
            }
        
            currentReplyContext = {
                timestamp: message.timestamp,
                senderName: senderDisplayName, // ä½¿ç”¨æˆ‘ä»¬åˆšåˆšè·å–åˆ°çš„ã€æ­£ç¡®çš„æ˜¾ç¤ºåç§°
                content: fullContent, 
            };
        
            const previewBar = document.getElementById('reply-preview-bar');
            previewBar.querySelector('.sender').textContent = `å›å¤ ${currentReplyContext.senderName}:`;
            previewBar.querySelector('.text').textContent = previewSnippet;
            previewBar.style.display = 'block';
        
            hideMessageActions();
            document.getElementById('chat-input').focus();
        }
        
        function cancelReplyMode() {
            currentReplyContext = null;
            document.getElementById('reply-preview-bar').style.display = 'none';
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·å¤„ç†è½¬è´¦çš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•° â–¼â–¼â–¼
        
        let activeTransferTimestamp = null; // ç”¨äºæš‚å­˜è¢«ç‚¹å‡»çš„è½¬è´¦æ¶ˆæ¯çš„æ—¶é—´æˆ³
        
        /**
         * æ˜¾ç¤ºå¤„ç†è½¬è´¦çš„æ“ä½œèœå•
         * @param {number} timestamp - è¢«ç‚¹å‡»çš„è½¬è´¦æ¶ˆæ¯çš„æ—¶é—´æˆ³
         */
        function showTransferActionModal(timestamp) {
            activeTransferTimestamp = timestamp;
        
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (message) {
                // å°†AIçš„åå­—å¡«å…¥å¼¹çª—
                document.getElementById('transfer-sender-name').textContent = message.senderName;
            }
            document.getElementById('transfer-actions-modal').classList.add('visible');
        }
        
        /**
         * éšè—å¤„ç†è½¬è´¦çš„æ“ä½œèœå•
         */
        function hideTransferActionModal() {
            document.getElementById('transfer-actions-modal').classList.remove('visible');
            activeTransferTimestamp = null;
        }
        
        /**
         * å¤„ç†ç”¨æˆ·æ¥å—æˆ–æ‹’ç»è½¬è´¦çš„é€»è¾‘
         * @param {string} choice - ç”¨æˆ·çš„é€‰æ‹©, 'accepted' æˆ– 'declined'
         */
        async function handleUserTransferResponse(choice) {
            if (!activeTransferTimestamp) return;
        
            const timestamp = activeTransferTimestamp;
            const chat = state.chats[state.activeChatId];
            const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
            if (messageIndex === -1) return;
        
            // 1. æ›´æ–°åŸå§‹è½¬è´¦æ¶ˆæ¯çš„çŠ¶æ€
            const originalMessage = chat.history[messageIndex];
            originalMessage.status = choice;
        
            let systemContent;
        
            // 2. å¦‚æœç”¨æˆ·é€‰æ‹©â€œæ‹’ç»â€
            if (choice === 'declined') {
                // ç«‹åˆ»åœ¨å‰ç«¯ç”Ÿæˆä¸€ä¸ªâ€œé€€æ¬¾â€å¡ç‰‡ï¼Œè®©ç”¨æˆ·çœ‹åˆ°
                const refundMessage = {
                    role: 'user',
                    type: 'transfer',
                    isRefund: true, // è¿™æ˜¯ä¸€ä¸ªå…³é”®æ ‡è®°ï¼Œç”¨äºUIæ˜¾ç¤ºè¿™æ˜¯é€€æ¬¾
                    amount: originalMessage.amount,
                    note: 'å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦',
                    timestamp: Date.now()
                };
                chat.history.push(refundMessage);
                
                // å‡†å¤‡ä¸€æ¡å¯¹AIå¯è§çš„éšè—æ¶ˆæ¯ï¼Œå‘Šè¯‰å®ƒå‘ç”Ÿäº†ä»€ä¹ˆ
                systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½ æ‹’ç»å¹¶é€€è¿˜äº†â€œ${originalMessage.senderName}â€çš„è½¬è´¦ã€‚]`;
            } else { // å¦‚æœç”¨æˆ·é€‰æ‹©â€œæ¥å—â€
                // åªéœ€å‡†å¤‡éšè—æ¶ˆæ¯é€šçŸ¥AIå³å¯
                systemContent = `[ç³»ç»Ÿæç¤ºï¼šä½ æ¥å—äº†â€œ${originalMessage.senderName}â€çš„è½¬è´¦ã€‚]`;
            }
        
            // 3. åˆ›å»ºè¿™æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
            const hiddenMessage = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now() + 1, // ä¿è¯æ—¶é—´æˆ³åœ¨é€€æ¬¾æ¶ˆæ¯ä¹‹å
                isHidden: true // è¿™ä¸ªæ ‡è®°ä¼šè®©å®ƒä¸åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤º
            };
            chat.history.push(hiddenMessage);
        
            // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°æ•°æ®åº“ï¼Œå¹¶åˆ·æ–°ç•Œé¢
            await db.chats.put(chat);
            hideTransferActionModal(); 
            renderChatInterface(state.activeChatId);
            renderChatList();
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
        
        async function renderCallHistoryScreen() {
            showScreen('call-history-screen'); // <--ã€æ ¸å¿ƒä¿®æ­£ã€‘æŠŠå®ƒç§»åŠ¨åˆ°æœ€å‰é¢ï¼
        
            const listEl = document.getElementById('call-history-list');
            const titleEl = document.getElementById('call-history-title');
            listEl.innerHTML = '';
            titleEl.textContent = 'æ‰€æœ‰é€šè¯è®°å½•';
            
            const records = await db.callRecords.orderBy('timestamp').reverse().toArray();
            
            if (records.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œè¿˜æ²¡æœ‰é€šè¯è®°å½•å“¦~</p>';
                return; // ç°åœ¨çš„ return å°±æ²¡é—®é¢˜äº†ï¼Œå› ä¸ºå®ƒåªè·³è¿‡äº†åç»­çš„æ¸²æŸ“é€»è¾‘
            }
            
            records.forEach(record => {
                const card = createCallRecordCard(record);
        
            addLongPressListener(card, async () => {
                // 1. å¼¹å‡ºè¾“å…¥æ¡†ï¼Œå¹¶å°†æ—§åç§°ä½œä¸ºé»˜è®¤å€¼ï¼Œæ–¹ä¾¿ä¿®æ”¹
                const newName = await showCustomPrompt(
                    "è‡ªå®šä¹‰é€šè¯åç§°", 
                    "è¯·è¾“å…¥æ–°çš„åç§°ï¼ˆç•™ç©ºåˆ™æ¢å¤é»˜è®¤ï¼‰",
                    record.customName || '' // å¦‚æœå·²æœ‰è‡ªå®šä¹‰åç§°ï¼Œå°±æ˜¾ç¤ºå®ƒ
                );
        
                // 2. å¦‚æœç”¨æˆ·ç‚¹å‡»äº†â€œå–æ¶ˆâ€ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš
                if (newName === null) return;
                
                // 3. æ›´æ–°æ•°æ®åº“ä¸­çš„è¿™æ¡è®°å½•
                await db.callRecords.update(record.id, { customName: newName.trim() });
                
                // 4. åˆ·æ–°æ•´ä¸ªåˆ—è¡¨ï¼Œè®©æ›´æ”¹ç«‹åˆ»æ˜¾ç¤ºå‡ºæ¥
                await renderCallHistoryScreen();
                
                // 5. ç»™ç”¨æˆ·ä¸€ä¸ªæˆåŠŸçš„æç¤º
                await showCustomAlert('æˆåŠŸ', 'é€šè¯åç§°å·²æ›´æ–°ï¼');
            });
                listEl.appendChild(card);
            });    
        }
        
        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å‡çº§ç‰ˆã€‘å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ createCallRecordCard å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€å‡çº§ç‰ˆã€‘æ ¹æ®å•æ¡è®°å½•æ•°æ®ï¼Œåˆ›å»ºä¸€å¼ èƒ½æ˜¾ç¤ºèŠå¤©å¯¹è±¡çš„é€šè¯å¡ç‰‡
         * @param {object} record - ä¸€æ¡é€šè¯è®°å½•å¯¹è±¡
         * @returns {HTMLElement} - åˆ›å»ºå¥½çš„å¡ç‰‡div
         */
        function createCallRecordCard(record) {
            const card = document.createElement('div');
            card.className = 'call-record-card';
            card.dataset.recordId = record.id; 
        
            // è·å–é€šè¯å¯¹è±¡çš„åå­—
            const chatInfo = state.chats[record.chatId];
            const chatName = chatInfo ? chatInfo.name : 'æœªçŸ¥ä¼šè¯';
        
            const callDate = new Date(record.timestamp);
            const dateString = `${callDate.getFullYear()}-${String(callDate.getMonth() + 1).padStart(2, '0')}-${String(callDate.getDate()).padStart(2, '0')} ${String(callDate.getHours()).padStart(2, '0')}:${String(callDate.getMinutes()).padStart(2, '0')}`;
            const durationText = `${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’`;
        
            const avatarsHtml = record.participants.map(p => 
                `<img src="${p.avatar}" alt="${p.name}" class="participant-avatar" title="${p.name}">`
            ).join('');
            
            card.innerHTML = `
                <div class="card-header">
                    <span class="date">${dateString}</span>
                    <span class="duration">${durationText}</span>
                </div>
                <div class="card-body">
                    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ–°å¢ä¸€ä¸ªæ ‡é¢˜è¡Œ -->
                    ${record.customName ? `<div class="custom-title">${record.customName}</div>` : ''}
                    
                    <div class="participants-info"> <!-- æ–°å¢ä¸€ä¸ªå®¹å™¨æ–¹ä¾¿å¸ƒå±€ -->
                        <div class="participants-avatars">${avatarsHtml}</div>
                        <span class="participants-names">ä¸ ${chatName}</span>
                    </div>
                </div>
            `;
            return card;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
/**
 * ã€V2.0 | æ”¯æŒæ‰‹åŠ¨æ€»ç»“ & é”™è¯¯å¤„ç†ã€‘æ˜¾ç¤ºæŒ‡å®šé€šè¯è®°å½•çš„å®Œæ•´æ–‡å­—ç¨¿
 * @param {number} recordId - é€šè¯è®°å½•çš„ID
 */
async function showCallTranscript(recordId) {
    const record = await db.callRecords.get(recordId);
    if (!record) return;

    const modal = document.getElementById('call-transcript-modal');
    const titleEl = document.getElementById('transcript-modal-title');
    const bodyEl = document.getElementById('call-transcript-modal-body');

    titleEl.textContent = `é€šè¯äº ${new Date(record.timestamp).toLocaleString()} (æ—¶é•¿: ${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’)`;
    bodyEl.innerHTML = '';
    
    const deleteBtn = document.getElementById('delete-transcript-btn');
    const summarizeBtn = document.getElementById('manual-summarize-btn');
    
    if (!record.transcript || record.transcript.length === 0) {
        bodyEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">è¿™æ¬¡é€šè¯æ²¡æœ‰ç•™ä¸‹æ–‡å­—è®°å½•ã€‚</p>';
        summarizeBtn.style.display = 'none';
    } else {
        summarizeBtn.style.display = 'block';
        record.transcript.forEach(entry => {
            const bubble = document.createElement('div');
            bubble.className = `transcript-entry ${entry.role}`; 
            bubble.textContent = entry.content;
            bodyEl.appendChild(bubble);
        });
    }

    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
    const newSummarizeBtn = summarizeBtn.cloneNode(true);
    summarizeBtn.parentNode.replaceChild(newSummarizeBtn, summarizeBtn);
    
    newDeleteBtn.addEventListener('click', async () => {
        const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡é€šè¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", { confirmButtonClass: 'btn-danger' }
        );
        if (confirmed) {
            modal.classList.remove('visible');
            await db.callRecords.delete(recordId);
            await renderCallHistoryScreen();
            alert('é€šè¯è®°å½•å·²åˆ é™¤ã€‚');
        }
    });

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ä»è¿™é‡Œå¼€å§‹ â–¼â–¼â–¼
    newSummarizeBtn.addEventListener('click', async () => {
        modal.classList.remove('visible');
        const chat = state.chats[record.chatId];
        if (!chat) {
            alert('é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¯¥é€šè¯è®°å½•æ‰€å±çš„èŠå¤©å¯¹è±¡ã€‚');
            return;
        }

        await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚AIè¿›è¡Œæ‰‹åŠ¨æ€»ç»“...");
        
        // ä½¿ç”¨ try...catch æ¥â€œæ¥ä½â€å¯èƒ½æŠ›å‡ºçš„é”™è¯¯
        try {
            const transcriptText = record.transcript.map(h => {
                const sender = h.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (h.senderName || chat.name);
                return `${sender}: ${h.content}`;
            }).join('\n');

            // è°ƒç”¨æˆ‘ä»¬å‡çº§åçš„æ€»ç»“å‡½æ•°
            await summarizeCallTranscript(record.chatId, transcriptText);

            // åªæœ‰åœ¨ try å—å†…æ²¡æœ‰å‡ºé”™æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œè¿™è¡Œï¼Œå¼¹å‡ºæˆåŠŸæç¤º
            await showCustomAlert("æ€»ç»“æˆåŠŸ", `æ‰‹åŠ¨æ€»ç»“å·²å®Œæˆï¼æ–°çš„è®°å¿†å·²æ·»åŠ åˆ°â€œ${chat.name}â€çš„é•¿æœŸè®°å¿†ä¸­ã€‚`);

        } catch (error) {
            // å¦‚æœ summarizeCallTranscript æŠ›å‡ºäº†é”™è¯¯ï¼Œä»£ç ä¼šç«‹å³è·³è½¬åˆ°è¿™é‡Œ
            // æˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™é‡Œå¼¹å‡ºæ¸…æ™°çš„å¤±è´¥æç¤ºæ¡†
            await showCustomAlert("æ€»ç»“å¤±è´¥", `æ“ä½œå¤±è´¥ï¼Œæœªèƒ½ç”Ÿæˆé•¿æœŸè®°å¿†ã€‚\n\né”™è¯¯è¯¦æƒ…: ${error.message}`);
        }
    });
    // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€è¿™æ˜¯æ‚¨éœ€è¦æ·»åŠ çš„æ ¸å¿ƒä¿®å¤ä»£ç ã€‘ â–¼â–¼â–¼

// 3. ä¸ºâ€œå…³é—­â€æŒ‰é’®ä¹Ÿåˆ›å»ºå…‹éš†å¹¶ç»‘å®šäº‹ä»¶ï¼Œç¡®ä¿å®ƒæ€»æ˜¯å¯ç”¨
const closeBtn = document.getElementById('close-transcript-modal-btn');
const newCloseBtn = closeBtn.cloneNode(true);
closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

newCloseBtn.addEventListener('click', () => {
    modal.classList.remove('visible');
});

// â–²â–²â–² æ–°å¢ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
    modal.classList.add('visible');
}
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å…¨æ–°å‡½æ•°ã€‘æ›¿æ¢æ‰ä½ æ—§çš„ handleStatusResetClick å‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»çŠ¶æ€æ ï¼Œå¼¹å‡ºç¼–è¾‘æ¡†è®©ç”¨æˆ·ä¿®æ”¹AIçš„å½“å‰çŠ¶æ€
         */
        async function handleEditStatusClick() {
            // 1. å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿åœ¨å•èŠç•Œé¢
            if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
                return; 
            }
            const chat = state.chats[state.activeChatId];
        
            // 2. å¼¹å‡ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·è¾“å…¥æ–°çš„çŠ¶æ€ï¼Œå¹¶å°†å½“å‰çŠ¶æ€ä½œä¸ºé»˜è®¤å€¼
            const newStatusText = await showCustomPrompt(
                'ç¼–è¾‘å¯¹æ–¹çŠ¶æ€',
                'è¯·è¾“å…¥å¯¹æ–¹ç°åœ¨çš„æ–°çŠ¶æ€ï¼š',
                chat.status.text // å°†å½“å‰çŠ¶æ€ä½œä¸ºè¾“å…¥æ¡†çš„é»˜è®¤å†…å®¹
            );
        
            // 3. å¦‚æœç”¨æˆ·è¾“å…¥äº†å†…å®¹å¹¶ç‚¹å‡»äº†â€œç¡®å®šâ€
            if (newStatusText !== null) {
                // 4. æ›´æ–°å†…å­˜å’Œæ•°æ®åº“ä¸­çš„çŠ¶æ€æ•°æ®
                chat.status.text = newStatusText.trim() || 'åœ¨çº¿'; // å¦‚æœç”¨æˆ·æ¸…ç©ºäº†ï¼Œå°±é»˜è®¤ä¸ºâ€œåœ¨çº¿â€
                chat.status.isBusy = false; // æ¯æ¬¡æ‰‹åŠ¨ç¼–è¾‘éƒ½é»˜è®¤å…¶ä¸å¤„äºâ€œå¿™ç¢Œâ€çŠ¶æ€
                chat.status.lastUpdate = Date.now();
                await db.chats.put(chat);
        
                // 5. ç«‹åˆ»åˆ·æ–°UIï¼Œè®©ç”¨æˆ·çœ‹åˆ°ä¿®æ”¹åçš„çŠ¶æ€
                renderChatInterface(state.activeChatId);
                renderChatList();
                
                // 6. ç»™å‡ºä¸€ä¸ªæ— ä¼¤å¤§é›…çš„æˆåŠŸæç¤º
                await showCustomAlert('çŠ¶æ€å·²æ›´æ–°', `â€œ${chat.name}â€çš„å½“å‰çŠ¶æ€å·²æ›´æ–°ä¸ºï¼š${chat.status.text}`);
            }
        }
        
        // æ”¾åœ¨ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº
        async function openShareTargetPicker() {
            const modal = document.getElementById('share-target-modal');
            const listEl = document.getElementById('share-target-list');
            listEl.innerHTML = '';
        
            // è·å–æ‰€æœ‰èŠå¤©ä½œä¸ºåˆ†äº«ç›®æ ‡
            const chats = Object.values(state.chats);
        
            chats.forEach(chat => {
                // å¤ç”¨è”ç³»äººé€‰æ‹©å™¨çš„æ ·å¼
                const item = document.createElement('div');
                item.className = 'contact-picker-item'; 
                item.innerHTML = `
                    <input type="checkbox" class="share-target-checkbox" data-chat-id="${chat.id}" style="margin-right: 15px;">
                    <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
                    <span class="name">${chat.name}</span>
                `;
                listEl.appendChild(item);
            });
            
            modal.classList.add('visible');
        }
        
        function closeMusicPlayerWithAnimation(callback) {
            const overlay = document.getElementById('music-player-overlay');
            if (!overlay.classList.contains('visible')) {
                if (callback) callback();
                return;
            }
            overlay.classList.remove('visible');
            setTimeout(() => {
                document.getElementById('music-playlist-panel').classList.remove('visible');
                if (callback) callback();
            }, 400); 
        }
        
function parseLRC(lrcContent) {
    if (!lrcContent) return [];
    const lines = String(lrcContent).split(/\r\n?|\n/);
    const lyrics = [];
    const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;
    for (const line of lines) {
        const text = line.replace(timeRegex, '').trim();
        if (!text) continue;
        timeRegex.lastIndex = 0;
        let match;
        while ((match = timeRegex.exec(line)) !== null) {
            const minutes = parseInt(match[1], 10);
            const seconds = parseInt(match[2], 10);
            const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
            const time = minutes * 60 + seconds + milliseconds / 1000;
            lyrics.push({ time, text });
        }
    }
    return lyrics.sort((a, b) => a.time - b.time);
}

function renderLyrics() {
    const lyricsList = document.getElementById('music-lyrics-list');
    lyricsList.innerHTML = '';
    if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
        lyricsList.innerHTML = '<div class="lyric-line">â™ª æš‚æ— æ­Œè¯ â™ª</div>';
        return;
    }
    musicState.parsedLyrics.forEach((line, index) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'lyric-line';
        lineEl.textContent = line.text;
        lineEl.dataset.index = index;
        lyricsList.appendChild(lineEl);
    });
    lyricsList.style.transform = `translateY(0px)`;
}

function updateActiveLyric(currentTime) {
    if (musicState.parsedLyrics.length === 0) return;
    let newLyricIndex = -1;
    for (let i = 0; i < musicState.parsedLyrics.length; i++) {
        if (currentTime >= musicState.parsedLyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    if (newLyricIndex === musicState.currentLyricIndex) return;
    musicState.currentLyricIndex = newLyricIndex;
    updateLyricsUI();
    
    const singleLyricEl = document.getElementById('single-lyric-display');
    if (singleLyricEl) {
        if (newLyricIndex > -1 && musicState.parsedLyrics[newLyricIndex]) {
            singleLyricEl.textContent = musicState.parsedLyrics[newLyricIndex].text;
        } else {
            singleLyricEl.textContent = 'â™ª â™ª â™ª';
        }
    }

    const lyricBar = document.getElementById('global-lyrics-bar');
    if (lyricBar.classList.contains('visible')) {
        if (newLyricIndex > -1 && musicState.parsedLyrics[newLyricIndex]) {
            lyricBar.textContent = musicState.parsedLyrics[newLyricIndex].text;
        } else {
            lyricBar.textContent = 'â™ª';
        }
    }
}

function updateLyricsUI(isFullscreen = false) {
    const listSelector = isFullscreen ? '#fullscreen-lyrics-container .music-lyrics-list' : '#music-lyrics-container #music-lyrics-list';
    const containerSelector = isFullscreen ? '#fullscreen-lyrics-container' : '#music-lyrics-container';
    
    const lyricsList = document.querySelector(listSelector);
    const container = document.querySelector(containerSelector);
    if (!lyricsList || !container) return;

    const lines = lyricsList.querySelectorAll('.lyric-line');
    lines.forEach(line => line.classList.remove('active'));

    if (musicState.currentLyricIndex === -1) {
        lyricsList.style.transform = `translateY(0px)`;
        return;
    }

    const activeLine = lyricsList.querySelector(`.lyric-line[data-index="${musicState.currentLyricIndex}"]`);
    if (activeLine) {
        activeLine.classList.add('active');
        const containerHeight = container.offsetHeight;
        const offset = (containerHeight / 2.2) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
        lyricsList.style.transform = `translateY(${offset}px)`;
    }
}

function formatMusicTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${String(remainingSeconds).padStart(2, '0')}`;
}

let lastTimeUpdate = 0; 
let animationFrameId; 

function updateMusicProgressBar() {
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
    }

    function step() {
        if (!musicState.isPlaying || !audioPlayer.duration) {
            return; 
        }
        
        const now = performance.now();
        const currentTime = audioPlayer.currentTime;
        const duration = audioPlayer.duration;

        const progressPercent = (currentTime / duration) * 100;
        document.getElementById('music-progress-fill').style.width = `${progressPercent}%`;

        if (now - lastTimeUpdate > 1000) {
            document.getElementById('music-current-time').textContent = formatMusicTime(currentTime);
            document.getElementById('music-total-time').textContent = formatMusicTime(duration);
            lastTimeUpdate = now;
        }

        updateActiveLyric(currentTime);

        animationFrameId = requestAnimationFrame(step);
    }

    animationFrameId = requestAnimationFrame(step);
}
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯¼æ¼”æ¨¡å¼æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
        
        /**
         * ã€æ€»å…¥å£ã€‘æ‰“å¼€â€œå¯¼æ¼”å‰ªè¾‘å®¤â€ï¼Œç¼–è¾‘AIçš„ä¸Šä¸€è½®å“åº”
         */
        function openAiResponseEditor() {
            if (!lastRawAiResponse) {
                alert("è¿˜æ²¡æœ‰å¯ä¾›ç¼–è¾‘çš„AIå“åº”ã€‚è¯·å…ˆè®©AIå›å¤ä¸€æ¬¡ã€‚");
                return;
            }
        
            const editorModal = document.getElementById('ai-response-editor-modal');
            const editorContainer = document.getElementById('ai-response-editor-container');
            editorContainer.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
        
            // ä½¿ç”¨ä¸ä¸»æµç¨‹ç›¸åŒçš„ã€å¼ºå¤§çš„è§£æå‡½æ•°æ¥æå–æ‰€æœ‰JSONå¯¹è±¡
            const jsonMatches = lastRawAiResponse.match(/{[^{}]*}/g);
            
            if (jsonMatches) {
                jsonMatches.forEach(jsonString => {
                    try {
                        // ç¾åŒ–JSONæ ¼å¼ï¼Œæ–¹ä¾¿é˜…è¯»å’Œç¼–è¾‘
                        const parsedObject = JSON.parse(jsonString);
                        const formattedJson = JSON.stringify(parsedObject, null, 2);
                        const block = createAiResponseEditorBlock(formattedJson);
                        editorContainer.appendChild(block);
                    } catch (e) {
                        // å¦‚æœæŸä¸ªç‰‡æ®µä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œä¹ŸæŠŠå®ƒæ˜¾ç¤ºå‡ºæ¥ï¼Œè®©ç”¨æˆ·å¯ä»¥ä¿®æ­£å®ƒ
                        const block = createAiResponseEditorBlock(jsonString);
                        editorContainer.appendChild(block);
                        console.warn("åœ¨å¯¼æ¼”æ¨¡å¼ä¸­å‘ç°ä¸€ä¸ªæ— æ•ˆçš„JSONç‰‡æ®µ:", jsonString);
                    }
                });
            } else {
                // å¦‚æœå®Œå…¨æ²¡æœ‰æ‰¾åˆ°JSONï¼Œå°±æŠŠåŸå§‹æ–‡æœ¬æ”¾è¿›å»è®©ç”¨æˆ·ç¼–è¾‘
                const block = createAiResponseEditorBlock(lastRawAiResponse);
                editorContainer.appendChild(block);
            }
            
            editorModal.classList.add('visible');
        }
        
// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå·²æ·»åŠ â€œå¼•ç”¨â€æ¨¡æ¿çš„ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ createAiResponseEditorBlock å‡½æ•° â–¼â–¼â–¼
/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘åˆ›å»ºä¸€ä¸ªå¯ç¼–è¾‘çš„AIå“åº”å—
 * @param {string} initialContent - æ–‡æœ¬æ¡†çš„åˆå§‹å†…å®¹
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„DOMå…ƒç´ 
 */
function createAiResponseEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'ai-response-editor-block';

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ·»åŠ  'quote' æ¨¡æ¿
    const templates = {
        text: { type: 'text', content: 'åœ¨è¿™é‡Œè¾“å…¥æ–‡æœ¬...' },
        sticker: { type: 'sticker', url: 'https://...', meaning: 'è¡¨æƒ…å«ä¹‰' },
        image: { type: 'ai_image', description: 'åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°...' },
        voice: { type: 'voice_message', content: 'åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹...' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€ç‚¹å¿ƒæ„' },
        offline: { type: 'offline_text', content: 'ã€Œåœ¨è¿™é‡Œè¾“å…¥å¯¹è¯å†…å®¹ã€\\n(åœ¨è¿™é‡Œè¾“å…¥åŠ¨ä½œæˆ–ç¯å¢ƒæå†™)' },
        quote: { type: 'quote_reply', target_timestamp: 1234567890, reply_content: 'åœ¨è¿™é‡Œè¾“å…¥å›å¤å†…å®¹' }
    };

    block.innerHTML = `
        <button class="delete-block-btn" title="åˆ é™¤æ­¤æ¡åŠ¨ä½œ">Ã—</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.text)}'>æ–‡æœ¬</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.sticker)}'>è¡¨æƒ…</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>è¯­éŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½¬è´¦</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.offline)}'>çº¿ä¸‹</button>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨è¿™é‡Œæ·»åŠ æ–°çš„â€œå¼•ç”¨â€æŒ‰é’® -->
            <button class="format-btn" data-template='${JSON.stringify(templates.quote)}'>å¼•ç”¨</button>
        </div>
    `;

    // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
    block.querySelector('.delete-block-btn').addEventListener('click', () => {
        block.remove();
    });

    // ç»‘å®šæ ¼å¼åŠ©æ‰‹æŒ‰é’®äº‹ä»¶
    block.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const templateStr = btn.dataset.template;
            const textarea = block.querySelector('textarea');
            if (templateStr && textarea) {
                try {
                    const templateObj = JSON.parse(templateStr);
                    // ç¾åŒ–æ ¼å¼åå¡«å…¥
                    textarea.value = JSON.stringify(templateObj, null, 2);
                    textarea.focus();
                } catch(e) { console.error("è§£ææ ¼å¼æ¨¡æ¿å¤±è´¥:", e); }
            }
        });
    });

    return block;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€V3.0 | å®¹é”™ç»ˆæä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ saveEditedAiResponse å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€æ ¸å¿ƒã€‘ä¿å­˜å¯¼æ¼”æ¨¡å¼ä¸‹ä¿®æ”¹è¿‡çš„å†…å®¹ï¼Œå¹¶é‡å†™å†å²è®°å½•
         */
        async function saveEditedAiResponse() {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            // 1. ä»DOMä¸­æ”¶é›†æ‰€æœ‰ç¼–è¾‘åçš„JSONå­—ç¬¦ä¸²ï¼Œå¹¶æ„å»ºä¸€ä¸ªæ–°çš„åŸå§‹å“åº”å­—ç¬¦ä¸²
            const editorContainer = document.getElementById('ai-response-editor-container');
            const editorTextareas = editorContainer.querySelectorAll('textarea');
            const editedRawBlocks = Array.from(editorTextareas).map(ta => ta.value.trim()).filter(Boolean);
        
            // å¦‚æœç”¨æˆ·åˆ é™¤äº†æ‰€æœ‰å†…å®¹ï¼Œåˆ™è§†ä¸ºæ¸…ç©ºä¸Šä¸€è½®å›å¤
            if (editedRawBlocks.length === 0) {
                chat.history = chat.history.filter(msg => !lastResponseTimestamps.includes(msg.timestamp));
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
                renderChatList();
                document.getElementById('ai-response-editor-modal').classList.remove('visible');
                lastRawAiResponse = '';
                lastResponseTimestamps = [];
                return;
            }
        
            // 2. è§£ææ–°çš„æ¶ˆæ¯æ•°ç»„
            let newMessagesArray = [];
            for (const rawContent of editedRawBlocks) {
                try {
                    const parsedObject = JSON.parse(rawContent);
                    newMessagesArray.push(parsedObject);
                } catch (e) {
                    console.warn("è·³è¿‡ä¸€ä¸ªæ— æ³•è§£æä¸ºJSONçš„ç¼–è¾‘å—:", rawContent);
                }
            }
        
            // 3. ä»èŠå¤©å†å²ä¸­ç§»é™¤ä¸Šä¸€è½®AIç”Ÿæˆçš„æ‰€æœ‰æ¶ˆæ¯
            chat.history = chat.history.filter(msg => !lastResponseTimestamps.includes(msg.timestamp));
        
            // 4. å°†æ–°ç¼–è¾‘çš„æ¶ˆæ¯æ·»åŠ å›å†å²è®°å½•ï¼Œå¹¶è®°å½•å®ƒä»¬æ–°çš„æ—¶é—´æˆ³
            let newTimestamps = [];
            let messageTimestamp = Date.now();
            
            for (const msgData of newMessagesArray) {
                 if (!msgData || typeof msgData !== 'object' || !msgData.type) {
                    console.warn("åœ¨å¯¼æ¼”æ¨¡å¼ä¿å­˜æ—¶ï¼Œå‘ç°æ— æ•ˆçš„æŒ‡ä»¤å¯¹è±¡ï¼Œå·²è·³è¿‡:", msgData);
                    continue;
                }
        
                let aiMessage = null;
                const baseMessage = { role: 'assistant', senderName: msgData.name || chat.originalName, timestamp: messageTimestamp++ };
        
                switch (msgData.type) {
                    case 'text':
                        aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                        break;
                    case 'sticker':
                        aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                        break;
                    case 'ai_image':
                        aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description };
                        break;
                    case 'voice_message':
                        aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                        break;
                    case 'transfer':
                        aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || 'æˆ‘' };
                        break;
                    case 'waimai_request':
                        aiMessage = { 
                            ...baseMessage, type: 'waimai_request',
                            productInfo: msgData.productInfo, amount: msgData.amount,
                            status: 'pending', countdownEndTime: Date.now() + 15 * 60 * 1000,
                        };
                        break;
                    case 'offline_text':
                           aiMessage = { ...baseMessage, ...msgData };
                        break;
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
                    case 'gomoku_move': {
                        const gameState = gomokuState[chat.id];
                        if (gameState) {
                            // 1. æ‰¾åˆ°AIçš„ä¸Šä¸€æ­¥æ£‹
                            const lastAiMoveIndex = gameState.history.findLastIndex(move => move.player === 2);
                            
                            if (lastAiMoveIndex > -1) {
                                const move_to_undo = gameState.history[lastAiMoveIndex];
                                
                                // 2. ä»æ£‹ç›˜æ•°æ®ä¸­â€œæ‹¿æ‰â€è¿™é¢—æ£‹å­
                                gameState.board[move_to_undo.y][move_to_undo.x] = 0;
                                
                                // 3. ä»ä¸‹æ£‹å†å²ä¸­ç§»é™¤è¿™ä¸€æ­¥
                                gameState.history.splice(lastAiMoveIndex, 1);
                                
                                console.log(`å¯¼æ¼”æ¨¡å¼æ‚”æ£‹ï¼šå·²æ’¤é”€AIåœ¨ (${move_to_undo.x}, ${move_to_undo.y}) çš„æ£‹æ­¥ã€‚`);
                            }
                        }

                        // 4. æ‰§è¡Œæ–°çš„ä¸‹æ£‹æŒ‡ä»¤
                        const x = parseInt(msgData.x);
                        const y = parseInt(msgData.y);
                        if (!isNaN(x) && !isNaN(y)) {
                            handleAiGomokuMove({ x: x, y: y }, true);
                        } else {
                            console.warn("å¯¼æ¼”æ¨¡å¼ä¿å­˜äº†ä¸€ä¸ªæ— æ•ˆçš„äº”å­æ£‹ç§»åŠ¨æŒ‡ä»¤:", msgData);
                        }
                        continue;
                    }
                    case 'update_thoughts': { 
                        if (!chat.isGroup) {
                            if (msgData.heartfelt_voice) chat.heartfeltVoice = String(msgData.heartfelt_voice);
                            if (msgData.random_jottings) chat.randomJottings = String(msgData.random_jottings);
                            if (!Array.isArray(chat.thoughtsHistory)) chat.thoughtsHistory = [];
                            chat.thoughtsHistory.push({
                                heartfeltVoice: chat.heartfeltVoice,
                                randomJottings: chat.randomJottings,
                                timestamp: Date.now()
                            });
                            if (chat.thoughtsHistory.length > 50) chat.thoughtsHistory.shift();
                        }
                        continue;
                    }
                    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
                    // åœ¨ switch è¯­å¥ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªä¸“é—¨å¤„ç† 'quote_reply' çš„ case
                    case 'quote_reply': {
                        // 1. æŸ¥æ‰¾è¢«å¼•ç”¨çš„åŸå§‹æ¶ˆæ¯
                        const originalQuotedMsg = chat.history.find(m => m.timestamp === msgData.target_timestamp);
                        let quoteContext = null;

                        if (originalQuotedMsg) {
                            // 2. å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±æ„å»ºæ­£ç¡®çš„ quote å¯¹è±¡
                            let originalSenderName = originalQuotedMsg.senderName;
                            if (originalQuotedMsg.role === 'user') {
                                originalSenderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : (state.qzoneSettings.nickname || '{{user}}');
                            }
                            
                            quoteContext = {
                                timestamp: msgData.target_timestamp,
                                senderName: originalSenderName,
                                content: String(originalQuotedMsg.content || '')
                            };
                        } else {
                            // 3. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåˆ›å»ºä¸€ä¸ªå®‰å…¨çš„å ä½ç¬¦ï¼Œé˜²æ­¢ç¨‹åºå‡ºé”™
                            quoteContext = {
                                timestamp: msgData.target_timestamp,
                                senderName: 'æœªçŸ¥ç”¨æˆ·',
                                content: 'åŸå§‹æ¶ˆæ¯å·²åˆ é™¤æˆ–ä¸å­˜åœ¨'
                            };
                        }
                        
                        // 4. æ„å»ºæœ€ç»ˆçš„æ¶ˆæ¯å¯¹è±¡ï¼ŒåŒ…å« quote å±æ€§
                        aiMessage = { 
                            ...baseMessage, 
                            content: msgData.reply_content,
                            quote: quoteContext
                        };
                        break; // ç»“æŸè¿™ä¸ª case
                    }
                    default:
                         console.warn("åœ¨å¯¼æ¼”æ¨¡å¼ä¿å­˜æ—¶ï¼Œé‡åˆ°äº†æœªçŸ¥çš„AIæŒ‡ä»¤ç±»å‹:", msgData.type);
                         break;
                }
        
                if (aiMessage) {
                    chat.history.push(aiMessage);
                    newTimestamps.push(aiMessage.timestamp);
                }
            }
        
            // 5. ä¿å­˜åˆ°æ•°æ®åº“å¹¶åˆ·æ–°æ•´ä¸ªèŠå¤©ç•Œé¢
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);
            renderChatList();
            document.getElementById('ai-response-editor-modal').classList.remove('visible');
            
            // 6. æ›´æ–°ç¼“å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡ç¼–è¾‘
            lastRawAiResponse = editedRawBlocks.join('\n\n');
            lastResponseTimestamps = newTimestamps;
            
            // 7. ç»™å‡ºæˆåŠŸæç¤º
            await showCustomAlert("å¯¼æ¼”æ¨¡å¼", "æ‚¨çš„ä¿®æ”¹å·²ä¿å­˜ï¼");
        }
        /**
         * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œæ’¤å›â€æŒ‰é’®çš„å…¥å£å‡½æ•°
         */
        async function handleRecallClick() {
            if (!activeMessageTimestamp) return;
        
            const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000; // è®¾ç½®2åˆ†é’Ÿçš„æ’¤å›æ—¶é™
            const messageTime = activeMessageTimestamp;
            const now = Date.now();
        
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡äº†æ’¤å›æ—¶é™
            if (now - messageTime > RECALL_TIME_LIMIT_MS) {
                hideMessageActions();
                await showCustomAlert('æ“ä½œå¤±è´¥', 'è¯¥æ¶ˆæ¯å‘é€å·²è¶…è¿‡2åˆ†é’Ÿï¼Œæ— æ³•æ’¤å›ã€‚');
                return;
            }
            
            // å¦‚æœåœ¨æ—¶é™å†…ï¼Œæ‰§è¡ŒçœŸæ­£çš„æ’¤å›é€»è¾‘
            await recallMessage(messageTime, true);
            hideMessageActions();
        }
        
/**
 * ã€V2.0 | AIæ„ŸçŸ¥ç‰ˆã€‘æ¶ˆæ¯æ’¤å›çš„æ ¸å¿ƒé€»è¾‘
 * @param {number} timestamp - è¦æ’¤å›çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³
 * @param {boolean} isUserRecall - æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨æ’¤å›
 */
async function recallMessage(timestamp, isUserRecall) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const messageToRecall = chat.history[messageIndex];

    const recalledData = {
        originalType: messageToRecall.type || 'text',
        originalContent: messageToRecall.content,
        originalMeaning: messageToRecall.meaning,
        originalQuote: messageToRecall.quote
    };
    
    messageToRecall.type = 'recalled_message';
    messageToRecall.content = isUserRecall ? 'ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯' : 'å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯';
    messageToRecall.recalledData = recalledData;
    delete messageToRecall.meaning;
    delete messageToRecall.quote;

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œï¼â–¼â–¼â–¼
    if (isUserRecall) {
        // 1. è·å–ç”¨æˆ·åœ¨å½“å‰èŠå¤©ä¸­çš„æ­£ç¡®æ˜µç§°
        const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
        
        // 2. å°†è¢«æ’¤å›çš„å†…å®¹è½¬æ¢ä¸ºAIèƒ½ç†è§£çš„æ–‡æœ¬
        let recalledContentText = '';
        if (recalledData.originalType === 'sticker') {
            recalledContentText = `[è¡¨æƒ…ï¼Œå«ä¹‰: ${recalledData.originalMeaning || 'æœªçŸ¥'}]`;
        } else if (recalledData.originalType === 'ai_image' || recalledData.originalType === 'user_photo') {
            recalledContentText = `[å›¾ç‰‡ï¼Œæè¿°: ${recalledData.originalContent}]`;
        } else {
            recalledContentText = `â€œ${String(recalledData.originalContent)}â€`;
        }

        // 3. åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
        const hiddenMessageForAI = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·ï¼ˆ${myNickname}ï¼‰åˆšåˆšæ’¤å›äº†ä¸€æ¡æ¶ˆæ¯ã€‚æ’¤å›å‰çš„å†…å®¹æ˜¯ï¼š${recalledContentText}ã€‚è¯·ä½ å¯¹æ­¤ä½œå‡ºå›åº”ï¼Œå¯ä»¥è¡¨ç°å‡ºå¥½å¥‡ã€å¼€ç©ç¬‘ï¼ˆæ¯”å¦‚'æˆ‘æˆªå›¾äº†ï¼'ï¼‰ã€æˆ–è€…æ ¹æ®ä½ çš„äººè®¾è¡¨ç¤ºç†è§£æˆ–ç–‘æƒ‘ã€‚]`,
            timestamp: Date.now(),
            isHidden: true // è¿™ä¸ªæ ‡è®°ç¡®ä¿ç”¨æˆ·çœ‹ä¸åˆ°è¿™æ¡æŒ‡ä»¤
        };
        chat.history.push(hiddenMessageForAI);
    }
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    
    if (isUserRecall) {
        renderChatList();
        // ã€é‡è¦ã€‘åœ¨ç”¨æˆ·æ’¤å›åï¼Œç«‹åˆ»è§¦å‘AIï¼Œè®©å®ƒå¯¹è¿™ä¸ªäº‹ä»¶åšå‡ºååº”ï¼
        triggerAiResponse();
    }
}
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å°†è¿™äº›å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        
        /**
         * æ‰“å¼€åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡†
         */
        async function openCategoryManager() {
            await renderCategoryListInManager();
            document.getElementById('world-book-category-manager-modal').classList.add('visible');
        }
        
        /**
         * åœ¨æ¨¡æ€æ¡†ä¸­æ¸²æŸ“å·²å­˜åœ¨çš„åˆ†ç±»åˆ—è¡¨
         */
        async function renderCategoryListInManager() {
            const listEl = document.getElementById('existing-categories-list');
            const categories = await db.worldBookCategories.toArray();
            listEl.innerHTML = '';
            if (categories.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>';
            }
            categories.forEach(cat => {
                // å¤ç”¨å¥½å‹åˆ†ç»„çš„æ ·å¼
                const item = document.createElement('div');
                item.className = 'existing-group-item'; 
                item.innerHTML = `
                    <span class="group-name">${cat.name}</span>
                    <span class="delete-group-btn" data-id="${cat.id}">Ã—</span>
                `;
                listEl.appendChild(item);
            });
        }
        
        /**
         * æ·»åŠ ä¸€ä¸ªæ–°çš„ä¸–ç•Œä¹¦åˆ†ç±»
         */
        async function addNewCategory() {
            const input = document.getElementById('new-category-name-input');
            const name = input.value.trim();
            if (!name) {
                alert('åˆ†ç±»åä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            const existing = await db.worldBookCategories.where('name').equals(name).first();
            if (existing) {
                alert(`åˆ†ç±» "${name}" å·²ç»å­˜åœ¨äº†ï¼`);
                return;
            }
            await db.worldBookCategories.add({ name });
            input.value = '';
            await renderCategoryListInManager();
        }
        
        /**
         * åˆ é™¤ä¸€ä¸ªä¸–ç•Œä¹¦åˆ†ç±»
         * @param {number} categoryId - è¦åˆ é™¤çš„åˆ†ç±»çš„ID
         */
        async function deleteCategory(categoryId) {
            const confirmed = await showCustomConfirm(
                'ç¡®è®¤åˆ é™¤', 
                'åˆ é™¤åˆ†ç±»åï¼Œè¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰ä¸–ç•Œä¹¦å°†å˜ä¸ºâ€œæœªåˆ†ç±»â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ', 
                { confirmButtonClass: 'btn-danger' }
            );
            if (confirmed) {
                await db.worldBookCategories.delete(categoryId);
                // å°†å±äºè¯¥åˆ†ç±»çš„ä¸–ç•Œä¹¦çš„ categoryId è®¾ä¸º null
                const booksToUpdate = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
                for (const book of booksToUpdate) {
                    book.categoryId = null;
                    await db.worldBooks.put(book);
                    const bookInState = state.worldBooks.find(wb => wb.id === book.id);
                    if(bookInState) bookInState.categoryId = null;
                }
                await renderCategoryListInManager();
            }
        }
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ç‰ˆæœ¬ã€‘å‘å¸ƒå…¬å‘Šå‡½æ•° (æ— è¯„è®º) â–¼â–¼â–¼
        async function publishToAnnouncementBoard() {
            if (!activeMessageTimestamp) return;
        
            const timestampToPublish = activeMessageTimestamp;
            hideMessageActions(); 
        
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestampToPublish);
            if (!message) return;
        
            // æå–æ¶ˆæ¯å†…å®¹ç”¨äºé¢„è§ˆ
            let contentPreview = String(message.content || '').substring(0, 50) + '...';
            if (message.type === 'ai_image') contentPreview = '[å›¾ç‰‡] ' + contentPreview;
        
            const confirmed = await showCustomConfirm(
                "å‘å¸ƒå…¬å‘Š",
                `ç¡®å®šè¦å°†ä»¥ä¸‹æ¶ˆæ¯å‘å¸ƒåˆ°å…¬å‘Šæ¿å—ï¼Ÿ\n\nâ€œ${contentPreview}â€`,
                { confirmText: "ç¡®å®šå‘å¸ƒ" }
            );
        
            if (confirmed) {
                const myNickname = chat.settings.myNickname || 'æˆ‘';
        
                if (!Array.isArray(chat.announcements)) {
                    chat.announcements = [];
                }
        
                // æ–°å¢çš„å…¬å‘Šå¯¹è±¡
                const newAnnouncement = {
                    id: 'anno_' + Date.now(), // ä¸ºæ¯ä¸ªå…¬å‘Šæ·»åŠ å”¯ä¸€ID
                    messageTimestamp: timestampToPublish,
                    publisher: myNickname,
                    publishedAt: Date.now(),
                    isPinned: false // é»˜è®¤ä¸ºä¸ç½®é¡¶
                };
        
                chat.announcements.push(newAnnouncement);
        
                const systemMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${myNickname} å‘å¸ƒäº†ä¸€æ¡æ–°å…¬å‘Š`,
                    timestamp: Date.now()
                };
                chat.history.push(systemMessage);
        
                await db.chats.put(chat);
                appendMessage(systemMessage, chat);
                renderChatList();
        
                await showCustomAlert("æˆåŠŸ", "å…¬å‘Šå·²å‘å¸ƒï¼");
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        /**
         * æ˜¾ç¤ºç¾¤å…¬å‘Šæ¿å¼¹çª—
         */
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ showAnnouncementBoard å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€V2.0 | å·²ä¿®å¤å¼‚æ­¥æ¸²æŸ“BUGã€‘æ˜¾ç¤ºç¾¤å…¬å‘Šæ¿å¼¹çª—
         */
        async function showAnnouncementBoard() { // <--- æ ¸å¿ƒä¿®å¤1ï¼šå°†å‡½æ•°å£°æ˜ä¸º async
            const chat = state.chats[state.activeChatId];
            const announcements = chat.announcements || [];

            if (!chat || announcements.length === 0) {
                showCustomAlert("æç¤º", "å½“å‰ç¾¤èŠè¿˜æ²¡æœ‰å…¬å‘Šå“¦ã€‚");
                return;
            }

            const contentEl = document.getElementById('announcement-board-content');
            contentEl.innerHTML = '';

            // å°†ç½®é¡¶çš„å…¬å‘Šæ’åœ¨æœ€å‰é¢
            announcements.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0));

            // ã€æ ¸å¿ƒä¿®å¤2ã€‘ä½¿ç”¨ for...of å¾ªç¯ï¼Œä»¥ä¾¿åœ¨å¾ªç¯å†…éƒ¨å®‰å…¨åœ°ä½¿ç”¨ await
            for (const anno of announcements) {
                const originalMessage = chat.history.find(m => m.timestamp === anno.messageTimestamp);

                const wrapper = document.createElement('div');
                wrapper.className = 'announcement-item-wrapper';

                if (originalMessage) {
                    // ã€æ ¸å¿ƒä¿®å¤3ã€‘åœ¨è¿™é‡Œä½¿ç”¨ awaitï¼Œç­‰å¾… createMessageElement å‡½æ•°çœŸæ­£å®Œæˆå¹¶è¿”å›HTMLå…ƒç´ 
                    const messageBubbleEl = await createMessageElement(originalMessage, chat);
                    if (messageBubbleEl) { // å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿å…ƒç´ å·²æˆåŠŸåˆ›å»º
                        wrapper.appendChild(messageBubbleEl);
                    }
                } else {
                    wrapper.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">å…¬å‘Šçš„åŸæ¶ˆæ¯å·²è¢«åˆ é™¤ã€‚</p>';
                }

                if (anno.isPinned) {
                    wrapper.innerHTML += `<div class="pinned-indicator">ğŸ“Œ</div>`;
                }
                wrapper.innerHTML += `<div class="announcement-item-actions" data-anno-id="${anno.id}">...</div>`;

                contentEl.appendChild(wrapper);
            }

            document.getElementById('announcement-board-modal').classList.add('visible');
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è¿™æ˜¯æ‚¨ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ä»£ç ï¼Œè¯·ç²˜è´´åœ¨è¿™é‡Œã€‘ â–¼â–¼â–¼
        let activeAnnouncementId = null; // ç”¨äºæš‚å­˜æ­£åœ¨æ“ä½œçš„å…¬å‘ŠID
        
        /**
         * ç‚¹å‡»â€œ...â€æ—¶ï¼Œæ˜¾ç¤ºæ“ä½œèœå•ï¼ˆç½®é¡¶/åˆ é™¤ï¼‰
         * @param {string} annoId - å…¬å‘Šçš„å”¯ä¸€ID
         */
        function showAnnouncementActions(annoId) {
            activeAnnouncementId = annoId;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === annoId);
            if (!announcement) return;
        
            const pinButton = document.getElementById('announcement-action-pin');
            // æ ¹æ®å½“å‰æ˜¯å¦å·²ç½®é¡¶ï¼ŒåŠ¨æ€æ”¹å˜æŒ‰é’®æ–‡å­—
            pinButton.textContent = announcement.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶å…¬å‘Š';
        
            document.getElementById('announcement-actions-modal').classList.add('visible');
        }
        
        /**
         * å¤„ç†â€œç½®é¡¶/å–æ¶ˆç½®é¡¶â€æ“ä½œ
         */
        async function handlePinAnnouncement() {
            if (!activeAnnouncementId) return;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === activeAnnouncementId);
            if (announcement) {
                announcement.isPinned = !announcement.isPinned; // åˆ‡æ¢ç½®é¡¶çŠ¶æ€
                await db.chats.put(chat);
                showAnnouncementBoard(); // é‡æ–°æ¸²æŸ“å…¬å‘Šæ¿ä»¥æ›´æ–°UI
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        
        /**
         * å¤„ç†â€œåˆ é™¤å…¬å‘Šâ€æ“ä½œ
         */
        async function handleDeleteAnnouncement() {
            if (!activeAnnouncementId) return;
            
            const confirmed = await showCustomConfirm("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", { confirmButtonClass: 'btn-danger' });
            
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                // ä»å…¬å‘Šæ•°ç»„ä¸­è¿‡æ»¤æ‰è¦åˆ é™¤çš„å…¬å‘Š
                chat.announcements = chat.announcements.filter(a => a.id !== activeAnnouncementId);
                await db.chats.put(chat);
                showAnnouncementBoard(); // é‡æ–°æ¸²æŸ“
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

        
        // â–¼â–¼â–¼ ã€è¿™æ˜¯æ‚¨ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ä»£ç ï¼Œè¯·ç²˜è´´åœ¨è¿™é‡Œã€‘ â–¼â–¼â–¼
        let editingFrameForMember = false;
        let currentFrameSelection = { ai: null, my: null };
        
        function openFrameSelectorModal(type = 'chat') {
            const frameModal = document.getElementById('avatar-frame-modal');
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            editingFrameForMember = (type === 'member');
        
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (!member) return;
                currentFrameSelection.my = member.avatarFrame || '';
                populateFrameGrids(true, member.avatar, member.avatarFrame);
            } else {
                currentFrameSelection.ai = chat.settings.aiAvatarFrame || '';
                currentFrameSelection.my = chat.settings.myAvatarFrame || '';
                populateFrameGrids(false);
            }
            frameModal.classList.add('visible');
        }
        
        function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
            const aiFrameGrid = document.getElementById('ai-frame-grid');
            const myFrameGrid = document.getElementById('my-frame-grid');
            const chat = state.chats[state.activeChatId];
            aiFrameGrid.innerHTML = '';
            myFrameGrid.innerHTML = '';
        
            document.querySelector('#avatar-frame-modal .frame-tabs').style.display = isForMember ? 'none' : 'flex';
            document.getElementById('ai-frame-content').style.display = 'block';
            document.getElementById('my-frame-content').style.display = 'none';
            document.getElementById('ai-frame-tab').classList.add('active');
            document.getElementById('my-frame-tab').classList.remove('active');
        
            if (isForMember) {
                avatarFrames.forEach(frame => {
                    const item = createFrameItem(frame, 'my', memberAvatar);
                    if (frame.url === memberFrame) {
                        item.classList.add('selected');
                    }
                    aiFrameGrid.appendChild(item);
                });
            } else {
                const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
                const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                avatarFrames.forEach(frame => {
                    const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
                    if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
                    aiFrameGrid.appendChild(aiItem);
                    const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
                    if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
                    myFrameGrid.appendChild(myItem);
                });
            }
        }
        
        function createFrameItem(frame, type, previewAvatarSrc) {
            const item = document.createElement('div');
            item.className = 'frame-item';
            item.dataset.frameUrl = frame.url;
            item.title = frame.name;
            item.innerHTML = `
                <img src="${previewAvatarSrc}" class="preview-avatar">
                ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
            `;
            item.addEventListener('click', () => {
                currentFrameSelection[type] = frame.url;
                const grid = type === 'ai' ? document.getElementById('ai-frame-grid') : document.getElementById('my-frame-grid');
                grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
            });
            return item;
        }
        
        async function saveSelectedFrames() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (member) {
                    member.avatarFrame = currentFrameSelection.my;
                }
            } else {
                chat.settings.aiAvatarFrame = currentFrameSelection.ai;
                chat.settings.myAvatarFrame = currentFrameSelection.my;
            }
        // ... (å‡½æ•°å‰é¢çš„ä»£ç ) ...
            await db.chats.put(chat);
        
            // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¿®å¤ä»£ç  â–¼â–¼â–¼
            // æ ¸å¿ƒä¿®å¤ï¼šå½“æ›´æ–°å•èŠè§’è‰²çš„å¤´åƒæ¡†æ—¶ï¼ŒåŒæ­¥åˆ°æ‰€æœ‰åŒ…å«è¯¥è§’è‰²çš„ç¾¤èŠä¸­
            if (!editingFrameForMember && !chat.isGroup) {
                const characterId = chat.id; // è·å–è¢«ä¿®æ”¹çš„è§’è‰²çš„ID
        
                // éå†æ‰€æœ‰èŠå¤©ï¼Œæ‰¾å‡ºåŒ…å«è¿™ä¸ªè§’è‰²çš„ç¾¤èŠ
                for (const groupChat of Object.values(state.chats)) {
                    if (groupChat.isGroup && groupChat.members) {
                        // åœ¨ç¾¤èŠä¸­æ‰¾åˆ°å¯¹åº”çš„æˆå‘˜å¯¹è±¡
                        const memberToUpdate = groupChat.members.find(m => m.id === characterId);
        
                        // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±æ›´æ–°ä»–çš„å¤´åƒæ¡†ä¿¡æ¯
                        if (memberToUpdate) {
                            memberToUpdate.avatarFrame = chat.settings.aiAvatarFrame;
                            // ã€è‡³å…³é‡è¦ã€‘å°†ä¿®æ”¹åçš„ã€æ•´ä¸ªç¾¤èŠå¯¹è±¡ã€‘å­˜å›æ•°æ®åº“
                            await db.chats.put(groupChat);
                            console.log(`å·²åŒæ­¥è§’è‰² ${characterId} çš„å¤´åƒæ¡†åˆ°ç¾¤èŠ "${groupChat.name}"`);
                        }
                    }
                }
            }
            // â–²â–²â–² ä¿®å¤ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        
            document.getElementById('avatar-frame-modal').classList.remove('visible');
            renderChatInterface(state.activeChatId);
            alert('å¤´åƒæ¡†å·²ä¿å­˜å¹¶åŒæ­¥ï¼'); // ä¿®æ”¹äº†æç¤ºï¼Œè®©æ‚¨çŸ¥é“åŒæ­¥ä¹Ÿå®Œæˆäº†
            editingFrameForMember = false;
        }
        
        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°å‡½æ•° â–¼â–¼â–¼
        /**
         * å°†ç”¨æˆ·è‡ªå®šä¹‰çš„å…¨å±€CSSåº”ç”¨åˆ°é¡µé¢
         * @param {string} cssString ç”¨æˆ·è¾“å…¥çš„CSSä»£ç 
         */
        function applyGlobalCss(cssString) {
            const styleTag = document.getElementById('global-custom-style');
            if (styleTag) {
                // å¦‚æœæœ‰ä»£ç å°±åº”ç”¨ï¼Œæ²¡æœ‰å°±æ¸…ç©º
                styleTag.innerHTML = cssString || '';
            }
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸ªå‡½æ•°ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        /**
         * å‘å½“å‰èŠå¤©çš„å†å²è®°å½•ä¸­æ·»åŠ ä¸€æ¡å…³äºéŸ³ä¹æ“ä½œçš„ã€å¯¹ç”¨æˆ·éšè—çš„ç³»ç»Ÿæ¶ˆæ¯
         * @param {string} actionText - æè¿°ç”¨æˆ·æ“ä½œçš„æ–‡æœ¬ï¼Œä¾‹å¦‚ "æš‚åœäº†éŸ³ä¹"
         */
        async function addMusicActionSystemMessage(actionText) {
            // 1. æ£€æŸ¥éŸ³ä¹åŠŸèƒ½æ˜¯å¦æ¿€æ´»ï¼Œä»¥åŠæ˜¯å¦åœ¨æŸä¸ªèŠå¤©ä¸­
            if (!musicState.isActive || !musicState.activeChatId) return;
            const chat = state.chats[musicState.activeChatId];
            if (!chat) return;
        
            // 2. è·å–ç”¨æˆ·åœ¨å½“å‰èŠå¤©ä¸­çš„æ˜µç§°
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            const fullMessage = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${myNickname}) ${actionText}]`;
        
            // 3. åˆ›å»ºè¿™æ¡ç‰¹æ®Šçš„ã€éšè—çš„ç³»ç»Ÿæ¶ˆæ¯
            const systemMessage = {
                role: 'system',
                content: fullMessage,
                timestamp: Date.now(),
                isHidden: true // è¿™ä¸ªæ ‡è®°è®©æ¶ˆæ¯å¯¹ç”¨æˆ·ä¸å¯è§ï¼Œä½†AIèƒ½è¯»åˆ°
            };
        
            // 4. å°†æ¶ˆæ¯å­˜å…¥å†å²è®°å½•å¹¶æ›´æ–°æ•°æ®åº“
            chat.history.push(systemMessage);
            await db.chats.put(chat);
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆæœ¬ã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleLongScreenshot â–¼â–¼â–¼
        
        /**
         * ã€V3.0 | å¸ƒå±€ä¿®å¤ç‰ˆã€‘å¤„ç†é•¿æˆªå›¾åŠŸèƒ½
         */
        async function handleLongScreenshot() {
            if (selectedMessages.size === 0) return;
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            // 0. æ˜¾ç¤ºâ€œç”Ÿæˆä¸­â€çŠ¶æ€
            const screenshotBtn = document.getElementById('selection-screenshot-btn');
            const originalBtnText = screenshotBtn.textContent;
            screenshotBtn.textContent = 'ç”Ÿæˆä¸­...';
            screenshotBtn.disabled = true;
        
            // 1. åˆ›å»ºä¸´æ—¶çš„æˆªå›¾å®¹å™¨å’Œæ ·å¼ï¼ˆè¿™éƒ¨åˆ†ä¸å˜ï¼‰
            const screenshotContainer = document.createElement('div');
            const phoneScreen = document.getElementById('phone-screen');
            screenshotContainer.style.width = phoneScreen.offsetWidth + 'px';
            screenshotContainer.style.position = 'absolute';
            screenshotContainer.style.top = '-9999px';
            screenshotContainer.style.left = '-9999px';
            screenshotContainer.style.display = 'flex';
            screenshotContainer.style.flexDirection = 'column';
            screenshotContainer.style.height = 'auto';
            
            const chatScreen = document.getElementById('chat-interface-screen');
            screenshotContainer.style.backgroundImage = chatScreen.style.backgroundImage;
            screenshotContainer.style.backgroundColor = chatScreen.style.backgroundColor || (document.getElementById('phone-screen').classList.contains('dark-mode') ? '#000000' : '#f0f2f5');
        
            const tempStyle = document.createElement('style');
            tempStyle.innerHTML = `
                .message-bubble.selected::after { display: none !important; }
                .cloned-header .default-controls { display: flex !important; justify-content: space-between; align-items: center; width: 100%; }
                .cloned-header .selection-controls { display: none !important; }
            `;
            document.head.appendChild(tempStyle);
        
            try {
                // 2. ç»„è£…æˆªå›¾å…ƒç´ ï¼ˆå¤´éƒ¨å’Œè¾“å…¥æ¡†éƒ¨åˆ†ä¸å˜ï¼‰
                const header = chatScreen.querySelector('.header').cloneNode(true);
                header.classList.add('cloned-header');
                
                // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
                // æˆ‘ä»¬ä¸å†ä½¿ç”¨ getComputedStyleï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªå¹²å‡€çš„å®¹å™¨å¹¶æ‰‹åŠ¨åº”ç”¨å…³é”®æ ·å¼ã€‚
                const messagesContainer = document.createElement('div');
                const originalMessagesContainer = document.getElementById('chat-messages');
        
                // æ‰‹åŠ¨è®¾ç½®æœ€å…³é”®çš„å¸ƒå±€æ ·å¼ï¼Œç¡®ä¿æ¶ˆæ¯èƒ½æ­£ç¡®æ’åˆ—
                messagesContainer.style.display = 'flex';
                messagesContainer.style.flexDirection = 'column';
                messagesContainer.style.gap = '20px'; // è¿™æ˜¯æ¶ˆæ¯ä¹‹é—´çš„å‚ç›´é—´è·
                messagesContainer.style.padding = '10px 15px 20px 15px'; // ä¸Šã€å·¦å³ã€ä¸‹å†…è¾¹è·ï¼Œåº•éƒ¨å¤šç•™ä¸€ç‚¹
                messagesContainer.style.width = '100%';
                messagesContainer.style.boxSizing = 'border-box';
        
                // ç»§æ‰¿ä¸»é¢˜å’Œå­—ä½“å¤§å°ï¼Œè¿™å¯¹äºæ°”æ³¡é¢œè‰²å’Œæ–‡å­—å¤§å°è‡³å…³é‡è¦
                messagesContainer.dataset.theme = originalMessagesContainer.dataset.theme;
                messagesContainer.style.setProperty('--chat-font-size', originalMessagesContainer.style.getPropertyValue('--chat-font-size'));
                // â˜…â˜…â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…â˜…â˜…
        
                const inputArea = chatScreen.querySelector('#chat-input-area').cloneNode(true);
        
                const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
                sortedTimestamps.forEach(timestamp => {
                    // æ³¨æ„ï¼šæˆ‘ä»¬è¿™é‡Œä¾ç„¶éœ€è¦ä»åŸå§‹DOMä¸­å…‹éš†ï¼Œå› ä¸ºå®ƒä»¬å·²ç»åº”ç”¨äº†æ‰€æœ‰å¤æ‚çš„CSS
                    const originalBubble = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`);
                    if (originalBubble) {
                        const originalWrapper = originalBubble.closest('.message-wrapper');
                        if (originalWrapper) {
                            messagesContainer.appendChild(originalWrapper.cloneNode(true));
                        }
                    }
                });
        
                screenshotContainer.appendChild(header);
                screenshotContainer.appendChild(messagesContainer);
                screenshotContainer.appendChild(inputArea);
                document.body.appendChild(screenshotContainer);
                
                // å›¾ç‰‡é¢„åŠ è½½é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
                const images = Array.from(screenshotContainer.getElementsByTagName('img'));
                const imageLoadPromises = images.map(img => new Promise((resolve, reject) => {
                    if (img.src.startsWith('data:')) {
                        resolve();
                        return;
                    }
                    const newImg = new Image();
                    newImg.crossOrigin = 'anonymous';
                    newImg.onload = resolve;
                    newImg.onerror = resolve; 
                    newImg.src = img.src;
                }));
                
                await Promise.all(imageLoadPromises);
        
                // 3. è°ƒç”¨ html2canvasï¼ˆä¿æŒä¸å˜ï¼‰
                const canvas = await html2canvas(screenshotContainer, {
                    allowTaint: true,
                    useCORS: true,
                    backgroundColor: null,
                    scale: window.devicePixelRatio || 2,
                });
        
                // 4. ä½¿ç”¨ Blob å¯¹è±¡ä¸‹è½½ï¼ˆä¿æŒä¸å˜ï¼‰
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `EPhone-é•¿æˆªå›¾-${chat.name}-${Date.now()}.png`;
                    link.href = url;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 'image/png');
        
            } catch (error) {
                console.error('é•¿æˆªå›¾ç”Ÿæˆå¤±è´¥:', error);
                await showCustomAlert('ç”Ÿæˆå¤±è´¥', 'ç”Ÿæˆæˆªå›¾æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦æƒ…ã€‚');
            } finally {
                // 5. æ¸…ç†å·¥ä½œï¼ˆä¿æŒä¸å˜ï¼‰
                document.body.removeChild(screenshotContainer);
                document.head.removeChild(tempStyle);
                screenshotBtn.textContent = originalBtnText;
                screenshotBtn.disabled = false;
                exitSelectionMode(); 
            }
        }
        // â–²â–²â–² å…¨æ–°JSå‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        /**
         * ã€V2.1 | æœ€ç»ˆä¿®å¤ç‰ˆã€‘ä¸€ä¸ªç®€å•çš„ Markdown è§£æå™¨
         * @param {string} text - åŒ…å« Markdown è¯­æ³•çš„åŸå§‹æ–‡æœ¬
         * @returns {string} - è½¬æ¢æˆ HTML åçš„æ–‡æœ¬
         */
        function parseMarkdown(text) {
            if (!text || typeof text !== 'string') return '';

            // é¡ºåºå¾ˆé‡è¦ï¼šå…ˆå¤„ç†æˆ‘ä»¬è‡ªå®šä¹‰çš„å¤æ‚è§„åˆ™
            text = text.replace(/!h\{(.*?)\}/g, '<span class="diary-highlight">$1</span>');
            text = text.replace(/!u\{(.*?)\}/g, '<span class="diary-underline">$1</span>');
            text = text.replace(/!e\{(.*?)\}/g, '<span class="diary-emphasis">$1</span>');
            text = text.replace(/!w\{(.*?)\}/g, '<span class="diary-handwritten">$1</span>');
            text = text.replace(/!m\{(.*?)\}/g, '<span class="diary-messy">$1</span>');
            
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œ â–¼â–¼â–¼
            // å°†åŸæ¥çš„ !c{...} è§„åˆ™ï¼Œæ›¿æ¢ä¸ºæ‚¨æƒ³è¦çš„ ||...|| è§„åˆ™
            text = text.replace(/\|\|(.*?)\|\|/g, '<span class="spoiler">$1</span>');
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

            // å†å¤„ç†æ ‡å‡†Markdown
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\~\~(.*?)\~\~/g, '<s>$1</s>'); 
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

            return text;
        }


        // â–¼â–¼â–¼ ã€å…¨æ–° | æ•°æ®ä¿®å¤å‡½æ•°ã€‘è¯·å°†è¿™ä¸ªå‡½æ•°ç²˜è´´åˆ°æ‚¨çš„JSåŠŸèƒ½åŒº â–¼â–¼â–¼
        /**
         * è‡ªåŠ¨è¿ç§»æ—§çš„ã€æ ¼å¼ä¸æ­£ç¡®çš„çº¢åŒ…æ•°æ®ï¼Œå°† 'receiver' å­—æ®µé‡å‘½åä¸º 'receiverName'
         */
        async function migrateOldRedPacketData() {
            console.log("å¼€å§‹æ£€æŸ¥å¹¶è¿ç§»æ—§çš„çº¢åŒ…æ•°æ®...");
            let migrationCount = 0;
            // ç›´æ¥ä»å†…å­˜ä¸­çš„ state.chats æ“ä½œï¼Œæ•ˆç‡æ›´é«˜
            const allChats = Object.values(state.chats);
        
            for (const chat of allChats) {
                let needsDbUpdate = false;
                for (const msg of chat.history) {
                    // æ‰¾å‡ºæ‰€æœ‰ç”±AIå‘é€çš„ã€å¸¦æœ‰æ—§ 'receiver' å­—æ®µçš„ä¸“å±çº¢åŒ…
                    if (msg.type === 'red_packet' && msg.packetType === 'direct' && msg.role === 'assistant' && msg.hasOwnProperty('receiver') && !msg.hasOwnProperty('receiverName')) {
                        // è¿›è¡Œâ€œæ‰‹æœ¯â€ï¼šé‡å‘½åé”™è¯¯çš„å­—æ®µ
                        msg.receiverName = msg.receiver;
                        delete msg.receiver;
                        
                        needsDbUpdate = true; // æ ‡è®°è¿™ä¸ªèŠå¤©éœ€è¦è¢«é‡æ–°ä¿å­˜
                        migrationCount++;
                    }
                }
                // å¦‚æœè¿™ä¸ªèŠå¤©ä¸­æœ‰æ•°æ®è¢«ä¿®å¤äº†ï¼Œå°±å°†æ•´ä¸ªæ›´æ–°åçš„èŠå¤©å¯¹è±¡ä¿å­˜å›æ•°æ®åº“
                if (needsDbUpdate) {
                    console.log(`åœ¨èŠå¤© "${chat.name}" ä¸­å‘ç°å¹¶ä¿®å¤äº†æ—§çº¢åŒ…æ•°æ®ã€‚`);
                    await db.chats.put(chat);
                }
            }
        
            if (migrationCount > 0) {
                console.log(`æ•°æ®è¿ç§»å®Œæˆï¼æ€»å…±ä¿®å¤äº† ${migrationCount} æ¡çº¢åŒ…è®°å½•ã€‚`);
                alert(`æ£€æµ‹åˆ°å¹¶æˆåŠŸä¿®å¤äº† ${migrationCount} æ¡æ—§çš„çº¢åŒ…æ¶ˆæ¯ï¼é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ä»¥åº”ç”¨æ›´æ”¹ã€‚`);
                location.reload(); // å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼Œç¡®ä¿æ‰€æœ‰æ˜¾ç¤ºéƒ½ä½¿ç”¨æœ€æ–°çš„æ­£ç¡®æ•°æ®
            } else {
                console.log("æœªå‘ç°éœ€è¦è¿ç§»çš„æ—§çº¢åŒ…æ•°æ®ã€‚");
            }
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

        function showCharacterProfileModal(chatId) {
            const chat = state.chats[chatId];
            if (!chat || chat.isGroup) return;
        
            // å¡«å……æ•°æ®
            //document.getElementById('profile-avatar').src = chat.settings.aiAvatar || defaultAvatar;
           // document.getElementById('profile-name').textContent = chat.name;
           // document.getElementById('profile-id').textContent = `ID: ${chat.originalName}`;
            document.getElementById('profile-heartfelt-voice').textContent = chat.heartfeltVoice || '...';
            document.getElementById('profile-random-jottings').textContent = chat.randomJottings || '...';

            const modal = document.getElementById('character-profile-modal');
        
            // ã€æ ¸å¿ƒä¿®å¤ã€‘ç”±äºæˆ‘ä»¬å·²ç»ä»HTMLä¸­ç§»é™¤äº†â€œè¿›å…¥èŠå¤©â€æŒ‰é’®ï¼Œ
            // è¿™é‡Œä¸å†éœ€è¦ä¸ºå®ƒç»‘å®šäº‹ä»¶ï¼Œæ—§çš„ã€å¯¼è‡´é”™è¯¯çš„JavaScriptä»£ç å·²è¢«å½»åº•åˆ é™¤ã€‚
            
            // ç›´æ¥æ˜¾ç¤ºå¼¹çª—
            modal.classList.add('visible');
        }
        /**
         * ã€å…¨æ–°ã€‘æ˜¾ç¤ºå¿ƒå£°å†å²è®°å½•è§†å›¾
         */
        function showThoughtsHistory() {
            document.getElementById('profile-main-content').style.display = 'none';
            document.getElementById('profile-thoughts-history-view').style.display = 'flex';
            renderThoughtsHistory();
        }
        
        /**
         * ã€å…¨æ–° | å·²ä¿®å¤BUGã€‘éšè—å¿ƒå£°å†å²è®°å½•è§†å›¾ï¼Œè¿”å›ä¸»èµ„æ–™é¡µ
         */
function hideThoughtsHistory() {
    document.getElementById('profile-thoughts-history-view').style.display = 'none';
    
    // ã€æ ¸å¿ƒä¿®å¤ã€‘å°† 'block' æ”¹ä¸º 'flex'ï¼Œæ¢å¤å…¶æ­£ç¡®çš„å¼¹æ€§å¸ƒå±€
    document.getElementById('profile-main-content').style.display = 'flex'; 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * ã€å…¨æ–° | åˆ†é¡µåŠ è½½ç‰ˆã€‘æ¸²æŸ“å¿ƒå£°å†å²è®°å½•åˆ—è¡¨
         */
        function renderThoughtsHistory() {
            const listEl = document.getElementById('thoughts-history-list');
            const chat = state.chats[state.activeChatId];
            listEl.innerHTML = '';
            
            if (!chat || !chat.thoughtsHistory || chat.thoughtsHistory.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; padding: 30px 0;">è¿™é‡Œè¿˜æ²¡æœ‰å†å²è®°å½•å“¦ã€‚</p>';
                return;
            }
        
            const history = [...chat.thoughtsHistory].reverse(); // ä»æ–°åˆ°æ—§
            const initialItems = history.slice(0, THOUGHTS_RENDER_WINDOW);
            
            initialItems.forEach(thought => {
                const card = createThoughtCard(thought);
                listEl.appendChild(card);
            });
        
            thoughtsHistoryRenderCount = initialItems.length;
        
            // å¦‚æœè¿˜æœ‰æ›´å¤šè®°å½•ï¼Œåˆ™æ·»åŠ â€œåŠ è½½æ›´å¤šâ€æŒ‰é’®
            if (history.length > thoughtsHistoryRenderCount) {
                prependLoadMoreThoughtsButton(listEl);
            }
        }
        /**
         * ã€å…¨æ–°ã€‘åˆ›å»ºâ€œåŠ è½½æ›´å¤šâ€æŒ‰é’®å¹¶æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
         */
        function prependLoadMoreThoughtsButton(container) {
            const button = document.createElement('button');
            button.id = 'load-more-thoughts-btn';
            button.textContent = 'åŠ è½½æ›´æ—©çš„è®°å½•';
            button.className = 'load-more-btn'; // å¤ç”¨èŠå¤©é¡µé¢çš„æŒ‰é’®æ ·å¼
            container.prepend(button);
        }
        
        /**
         * ã€å…¨æ–°ã€‘åŠ è½½æ›´å¤šå¿ƒå£°å†å²è®°å½•
         */
        function loadMoreThoughts() {
            const listEl = document.getElementById('thoughts-history-list');
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const loadMoreBtn = document.getElementById('load-more-thoughts-btn');
            if (loadMoreBtn) loadMoreBtn.remove();
            
            const history = [...chat.thoughtsHistory].reverse();
            const totalItems = history.length;
            
            const nextSliceStart = thoughtsHistoryRenderCount;
            const nextSliceEnd = thoughtsHistoryRenderCount + THOUGHTS_RENDER_WINDOW;
            const itemsToAppend = history.slice(nextSliceStart, nextSliceEnd);
            
            itemsToAppend.forEach(thought => {
                const card = createThoughtCard(thought);
                listEl.appendChild(card);
            });
        
            thoughtsHistoryRenderCount += itemsToAppend.length;
        
            // å¦‚æœè¿˜æœ‰æ›´å¤šï¼Œå†æ¬¡æ·»åŠ æŒ‰é’®
            if (totalItems > thoughtsHistoryRenderCount) {
                prependLoadMoreThoughtsButton(listEl);
            }
        }
// â–¼â–¼â–¼ æ­¥éª¤ 1ï¼šç”¨è¿™ä¸ªã€å…¨æ–°çš„å‡½æ•°ã€‘ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ createThoughtCard å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘æ ¹æ®å•æ¡è®°å½•æ•°æ®ï¼Œåˆ›å»ºä¸€å¼ å¿ƒå£°å†å²å¡ç‰‡
 * @param {object} thought - ä¸€æ¡å¿ƒå£°å†å²è®°å½•å¯¹è±¡
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„å¡ç‰‡div
 */
function createThoughtCard(thought) {
    const card = document.createElement('div');
    card.className = 'thought-card';
    const date = new Date(thought.timestamp);
    const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ·»åŠ äº†ä¸€ä¸ªåˆ é™¤æŒ‰é’®çš„HTML
    card.innerHTML = `
        <button class="thought-delete-btn" data-timestamp="${thought.timestamp}" title="åˆ é™¤æ­¤æ¡è®°å½•">Ã—</button>
        <div class="thought-header">${dateString}</div>
        <div class="thought-content">
            <div class="voice">
                <div class="label">
                    <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    å¿ƒå£°
                </div>
                <p class="text">${thought.heartfeltVoice}</p>
            </div>
            <div class="jottings">
                <div class="label">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path></svg>
                    æ•£è®°
                </div>
                <p class="text">${thought.randomJottings}</p>
            </div>
        </div>
    `;
    return card;
} 
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯å¯¼å…¥è§’è‰²å¡çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼Œè¯·å°†å®ƒä»¬å®Œæ•´ç²˜è´´åˆ° init() å‡½æ•°çš„å‰é¢ â–¼â–¼â–¼
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆPNGå¯¼å…¥ä¿®å¤ã€‘è¯·ç”¨è¿™ä¸€æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„ handleCardImport å‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·é€‰æ‹©äº†è§’è‰²å¡æ–‡ä»¶åï¼Œç”±æ­¤å‡½æ•°å¼€å§‹å¤„ç†
         * @param {Event} event - æ–‡ä»¶è¾“å…¥æ¡†çš„ change äº‹ä»¶
         */
        async function handleCardImport(event) {
            const file = event.target.files[0];
            if (!file) return;
        
            try {
                let cardData;
                let avatarBase64 = null; // ç”¨äºå­˜å‚¨ä»PNGå¡ä¸­æå–çš„å¤´åƒ
        
                if (file.name.endsWith('.json')) {
                    // å¤„ç† JSON æ ¼å¼çš„è§’è‰²å¡
                    const text = await file.text();
                    cardData = JSON.parse(text);
                } else if (file.name.endsWith('.png')) {
                    // å¤„ç† PNG æ ¼å¼çš„è§’è‰²å¡
                    const arrayBuffer = await file.arrayBuffer();
                    // ã€ã€ã€æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œï¼ç°åœ¨è¿™ä¸ªå‡½æ•°è¢«æ­£ç¡®å®šä¹‰äº†ã€‘ã€‘ã€‘
                    cardData = await parsePngForTavernData(arrayBuffer);
                    
                    // åŒæ—¶ï¼Œå°†PNGæ–‡ä»¶æœ¬èº«è½¬æ¢ä¸ºBase64ï¼Œç”¨ä½œå¤´åƒ
                    avatarBase64 = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(file);
                    });
                } else {
                    throw new Error("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚è¯·é€‰æ‹© .json æˆ– .png æ–‡ä»¶ã€‚");
                }
        
                // å°†è§£æå‡ºçš„æ•°æ®åˆ›å»ºä¸ºæ–°çš„èŠå¤©å¯¹è±¡
                await createChatFromCardData(cardData, avatarBase64);
        
            } catch (error) {
                console.error("è§’è‰²å¡å¯¼å…¥å¤±è´¥:", error);
                await showCustomAlert("å¯¼å…¥å¤±è´¥", `æ— æ³•è§£æè§’è‰²å¡æ–‡ä»¶ã€‚\né”™è¯¯: ${error.message}`);
            } finally {
                // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
                event.target.value = null;
            }
        }
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¹±ç ä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ parsePngForTavernData â–¼â–¼â–¼
        /**
         * ã€V2.0 | ä¿®å¤UTF-8ä¹±ç ã€‘ä»PNGæ–‡ä»¶çš„ArrayBufferä¸­è§£æå‡ºéšè—çš„Tavern AIè§’è‰²æ•°æ®
         * @param {ArrayBuffer} arrayBuffer - PNGæ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®
         * @returns {Promise<object>} - è§£æå‡ºçš„JSONè§’è‰²æ•°æ®
         */
        function parsePngForTavernData(arrayBuffer) {
            return new Promise((resolve, reject) => {
                const view = new DataView(arrayBuffer);
                // æ£€æŸ¥PNGæ–‡ä»¶å¤´ (8ä¸ªå­—èŠ‚)
                if (view.getUint32(0) !== 0x89504E47 || view.getUint32(4) !== 0x0D0A1A0A) {
                    return reject(new Error("æ–‡ä»¶ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„PNGã€‚"));
                }
        
                let offset = 8;
                const decoder = new TextDecoder(); // è¿™ä¸ªè§£ç å™¨ç”¨äºè§£ç åŒºå—ç±»å‹ï¼Œä¸æ˜¯æœ€ç»ˆæ•°æ®
        
                while (offset < view.byteLength) {
                    const length = view.getUint32(offset);
                    const type = decoder.decode(arrayBuffer.slice(offset + 4, offset + 8));
        
                    if (type === 'tEXt') {
                        const data = new Uint8Array(arrayBuffer, offset + 8, length);
                        const nullSeparatorIndex = data.indexOf(0);
                        if (nullSeparatorIndex !== -1) {
                            const key = decoder.decode(data.slice(0, nullSeparatorIndex));
                            if (key === 'chara') {
                                const value = decoder.decode(data.slice(nullSeparatorIndex + 1));
                                try {
                                    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œï¼ã€‘ â–¼â–¼â–¼
                                    // æˆ‘ä»¬ä¸å†ä½¿ç”¨æ—§çš„ã€ä¼šå¯¼è‡´ä¸­æ–‡ä¹±ç çš„ atob() æ–¹æ³•ã€‚
                                    // è€Œæ˜¯é‡‡ç”¨ä¸€ä¸ªæ›´ç°ä»£ã€æ›´å¯é çš„ä¸¤æ­¥æµç¨‹æ¥è§£ç ã€‚
                                    
                                    // 1. å°†Base64å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ªåŸå§‹çš„äºŒè¿›åˆ¶å­—ç¬¦ä¸²ã€‚
                                    const binaryString = atob(value);
                                    
                                    // 2. åˆ›å»ºä¸€ä¸ªå­—èŠ‚æ•°ç»„ (Uint8Array) æ¥å­˜å‚¨è¿™äº›äºŒè¿›åˆ¶æ•°æ®ã€‚
                                    const bytes = new Uint8Array(binaryString.length);
                                    for (let i = 0; i < binaryString.length; i++) {
                                        bytes[i] = binaryString.charCodeAt(i);
                                    }
                                    
                                    // 3. ã€æœ€å…³é”®çš„ä¸€æ­¥ã€‘ä½¿ç”¨ TextDecoder å¹¶æ˜ç¡®æŒ‡å®š UTF-8 ç¼–ç ï¼Œ
                                    //    å°†å­—èŠ‚æ•°ç»„æ­£ç¡®åœ°è§£ç ä¸ºåŒ…å«ä¸­æ–‡çš„å­—ç¬¦ä¸²ã€‚
                                    const decodedData = new TextDecoder('utf-8').decode(bytes);
                                    
                                    // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
                                    
                                    resolve(JSON.parse(decodedData));
                                    return; // æˆåŠŸæ‰¾åˆ°å¹¶è§£æï¼Œä»»åŠ¡å®Œæˆ
                                } catch (e) {
                                    return reject(new Error("åœ¨PNGä¸­æ‰¾åˆ°è§’è‰²æ•°æ®ï¼Œä½†è§£ç æˆ–è§£æå¤±è´¥ã€‚é”™è¯¯: " + e.message));
                                }
                            }
                        }
                    }
                    
                    // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªåŒºå— (é•¿åº¦ + ç±»å‹ + æ•°æ® + CRC)
                    offset += 4 + 4 + length + 4;
                }
        
                reject(new Error("åœ¨PNGæ–‡ä»¶ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„Tavern AIè§’è‰²æ•°æ®(chara chunk)ã€‚"));
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆ | V4.0ã€‘è¯·ç”¨è¿™ä¸€æ•´å—ä»£ç ï¼Œæ›¿æ¢æ—§çš„ createChatFromCardData å’Œå¯èƒ½ç¼ºå¤±çš„ findWorldBookEntries å‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€è¾…åŠ©å‡½æ•° | å…¼å®¹æ ¸å¿ƒã€‘ä»è§’è‰²å¡æ•°æ®ä¸­æ™ºèƒ½æŸ¥æ‰¾ä¸–ç•Œä¹¦æ¡ç›®
         * @param {object} cardData - ä»æ–‡ä»¶è§£æå‡ºçš„åŸå§‹JSONæ•°æ®
         * @returns {Array|null} - å¦‚æœæ‰¾åˆ°ï¼Œè¿”å› entries æ•°ç»„ï¼›å¦åˆ™è¿”å› null
         */
        function findWorldBookEntries(cardData) {
            // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„è·¯å¾„ï¼ŒæŒ‰æœ€å¸¸è§åˆ°æœ€å°‘è§çš„é¡ºåº
            // ä½¿ç”¨å¯é€‰é“¾ (?.) æ¥å®‰å…¨åœ°è®¿é—®å¯èƒ½ä¸å­˜åœ¨çš„æ·±å±‚åµŒå¥—å±æ€§
            
            // æ ¼å¼ 1: ã€é’ˆå¯¹æ‚¨å¡ç‰‡çš„ç²¾ç¡®è·¯å¾„ã€‘æ•°æ®åœ¨ data.character_book ä¸­
            if (cardData.data?.character_book?.entries?.length > 0) {
                console.log("è¯Šæ–­ï¼šåœ¨ data.character_book ä¸­æ‰¾åˆ°ä¸–ç•Œä¹¦ã€‚");
                return cardData.data.character_book.entries;
            }
            
            // æ ¼å¼ 2: æ–°ç‰ˆ Tavern å¡ï¼Œæ•°æ®åœ¨ extensions.character_book ä¸­
            if (cardData.extensions?.character_book?.entries?.length > 0) {
                console.log("è¯Šæ–­ï¼šåœ¨ extensions.character_book ä¸­æ‰¾åˆ°ä¸–ç•Œä¹¦ã€‚");
                return cardData.extensions.character_book.entries;
            }
            
            // æ ¼å¼ 3: æŸäº›å·¥å…·å¯èƒ½å°†å…¶åµŒå¥—åœ¨ data.extensions ä¸­
            if (cardData.data?.extensions?.character_book?.entries?.length > 0) {
                console.log("è¯Šæ–­ï¼šåœ¨ data.extensions.character_book ä¸­æ‰¾åˆ°ä¸–ç•Œä¹¦ã€‚");
                return cardData.data.extensions.character_book.entries;
            }
            
            // æ ¼å¼ 4: å…¼å®¹æˆ‘ä»¬ä¹‹å‰å°è¯•è¿‡çš„ã€ç›´æ¥åœ¨é¡¶å±‚çš„å„ç§é”®å
            const possibleTopLevelKeys = ['character_book', 'lorebook', 'world_info', 'char_book'];
            for (const key of possibleTopLevelKeys) {
                if (cardData[key]?.entries?.length > 0) {
                    console.log(`è¯Šæ–­ï¼šåœ¨é¡¶å±‚ ${key} ä¸­æ‰¾åˆ°ä¸–ç•Œä¹¦ã€‚`);
                    return cardData[key].entries;
                }
            }
        
            console.log("è¯Šæ–­ï¼šæœªåœ¨æ­¤è§’è‰²å¡ä¸­æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„ä¸–ç•Œä¹¦æ•°æ®ã€‚");
            return null; // å¦‚æœæ‰€æœ‰è·¯å¾„éƒ½æ‰¾ä¸åˆ°ï¼Œè¿”å› null
        }
        
        /**
         * ã€V6.0 | å·²ä¿®å¤å¯¼å…¥BUGã€‘æ ¹æ®ä»è§’è‰²å¡è§£æçš„æ•°æ®ï¼Œåˆ›å»ºå¹¶ä¿å­˜ä¸€ä¸ªæ–°çš„èŠå¤©å¯¹è±¡
         * @param {object} cardData - ä».jsonæˆ–.pngä¸­è§£æå‡ºçš„è§’è‰²æ•°æ®
         * @param {string|null} avatarBase64 - å¦‚æœæ˜¯.pngå¡ï¼Œåˆ™ä¼ å…¥å…¶Base64æ•°æ®ä½œä¸ºå¤´åƒ
         */
        async function createChatFromCardData(cardData, avatarBase64 = null) {
            const effectiveCardData = cardData.data || cardData;
            if (!effectiveCardData.name) {
                throw new Error("è§’è‰²å¡æ•°æ®æ— æ•ˆæˆ–ç¼ºå°‘'name'å­—æ®µã€‚");
            }
        
            let worldBookIdToLink = null;
            const worldBookEntries = findWorldBookEntries(cardData);
        
            if (worldBookEntries) {
                const structuredEntries = worldBookEntries
                    .filter(entry => entry.enabled && entry.content)
                    .map(entry => ({
                        keys: entry.keys || [],
                        comment: entry.comment || '',
                        content: entry.content.replace(/<memory>|<\/memory>/g, '').trim()
                    }));
        
                if (structuredEntries.length > 0) {
                    const newWorldBook = {
                        id: 'wb_' + Date.now(),
                        name: `${effectiveCardData.name}çš„è®¾å®šé›†`,
                        content: structuredEntries,
                        categoryId: null
                    };
                    await db.worldBooks.add(newWorldBook);
                    state.worldBooks.push(newWorldBook);
                    worldBookIdToLink = newWorldBook.id;
                }
            }
        
            let description = effectiveCardData.description || cardData.description || 'æ— ';
            description = description
                .replace(/```yaml/g, '').replace(/```/g, '')
                .replace(/<\/?info>/g, '').replace(/<\/?character>/g, '')
                .replace(/<\/?writing_rule>/g, '').replace(/\[OOCï¼š.*?\]/g, '').trim();
            let persona = `# è§’è‰²æ ¸å¿ƒè®¾å®š\n${description}\n\n`;
            if (effectiveCardData.personality) persona += `# æ€§æ ¼è¡¥å……\n${effectiveCardData.personality}\n\n`;
            if (effectiveCardData.scenario) persona += `# åœºæ™¯è®¾å®š\n${effectiveCardData.scenario}\n\n`;
            if (effectiveCardData.mes_example) persona += `# å¯¹è¯ç¤ºä¾‹\n${effectiveCardData.mes_example}\n\n`;

            // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œå®šä¹‰ remarkName å’Œ originalName â–¼â–¼â–¼
            const remarkName = effectiveCardData.name;
            const originalName = effectiveCardData.name;
            // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

            const newChatId = 'chat_' + Date.now();
            const newChat = {
                id: newChatId,
                name: remarkName.trim(),
                originalName: originalName.trim(),
                isGroup: false,
                relationship: { status: 'friend' },
                status: { text: 'åœ¨çº¿', lastUpdate: Date.now(), isBusy: false },
                settings: {
                    aiPersona: persona,
                    myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚',
                    maxMemory: 10,
                    aiAvatar: defaultAvatar,
                    myAvatar: defaultAvatar,
                    background: '',
                    theme: 'default',
                    fontSize: 13,
                    customCss: '',
                    linkedWorldBookIds: worldBookIdToLink ? [worldBookIdToLink] : [],
                    aiAvatarLibrary: []
                },
                history: [],
                musicData: { totalTime: 0 },
                longTermMemory: []
            };

            if (avatarBase64) {
                newChat.settings.aiAvatar = avatarBase64;
                newChat.settings.aiAvatarLibrary.push({ name: 'é»˜è®¤å¤´åƒ', url: avatarBase64 });
            }

            const greetingHtml = effectiveCardData.first_mes || cardData.first_mes;
            if (greetingHtml && typeof greetingHtml === 'string') {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = greetingHtml;
                const cleanGreeting = (tempDiv.textContent || tempDiv.innerText || "").replace(/åŸä½œè€…UR.*?å¼€å±€/s, '').trim();
                if (cleanGreeting) {
                    newChat.history.push({
                        role: 'assistant',
                        senderName: newChat.originalName,
                        content: cleanGreeting,
                        timestamp: Date.now()
                    });
                }
            }
            state.chats[newChatId] = newChat;
            await db.chats.put(newChat);
            renderChatList();
            let successMessage = `è§’è‰² â€œ${newChat.name}â€ å·²æˆåŠŸå¯¼å…¥ï¼`;
            if (worldBookIdToLink) {
                successMessage += `\n\nå…¶ä¸“å±çš„â€œä¸–ç•Œä¹¦â€ä¹Ÿå·²è‡ªåŠ¨åˆ›å»ºå¹¶å…³è”ã€‚`;
            }
            await showCustomAlert('å¯¼å…¥æˆåŠŸï¼', successMessage);
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯åˆ‡æ¢å¼€åœºç™½çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œè¯·ç²˜è´´åˆ° init() å‡½æ•°çš„å‰é¢ â–¼â–¼â–¼
            /**
             * ã€æ€»å…¥å£ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œåˆ‡æ¢å¼€åœºâ€æŒ‰é’®çš„é€»è¾‘
             */
            async function handleSwitchGreeting() {
                if (!state.activeChatId) return;
                const chat = state.chats[state.activeChatId];
                const greetings = chat.settings.alternateGreetings;
        
                if (!greetings || greetings.length === 0) {
                    alert("è¿™ä¸ªè§’è‰²æ²¡æœ‰å¯ç”¨çš„å¤‡é€‰å¼€åœºç™½ã€‚");
                    return;
                }
        
                // 1. å°†å¤‡é€‰å¼€åœºç™½æ•°ç»„è½¬æ¢ä¸º showChoiceModal éœ€è¦çš„æ ¼å¼
                const options = greetings.map((text, index) => {
                    // æå–æ¯ä¸ªå¼€åœºç™½çš„å‰20ä¸ªå­—ç¬¦ä½œä¸ºé¢„è§ˆ
                    const preview = text.replace(/<[^>]*>/g, '').trim().substring(0, 20);
                    return {
                        text: `å¼€åœº ${index + 1}: ${preview}...`,
                        value: index // å°†æ•°ç»„ç´¢å¼•ä½œä¸ºè¿”å›å€¼
                    };
                });
        
                // 2. å¼¹å‡ºé€‰æ‹©èœå•
                const selectedIndex = await showChoiceModal('é€‰æ‹©ä¸€ä¸ªå¼€åœºç™½', options);
        
                // 3. å¦‚æœç”¨æˆ·åšå‡ºäº†é€‰æ‹© (è€Œä¸æ˜¯å–æ¶ˆ)
                if (selectedIndex !== null) {
                    // 4. ã€é‡è¦ã€‘å¼¹å‡ºè­¦å‘Šï¼Œç¡®è®¤æ˜¯å¦è¦è¦†ç›–èŠå¤©è®°å½•
                    const confirmed = await showCustomConfirm(
                        'ç¡®è®¤æ“ä½œ',
                        'åˆ‡æ¢å¼€åœºå°†ä¼šã€æ¸…ç©ºå¹¶æ›¿æ¢ã€‘å½“å‰çš„æ‰€æœ‰èŠå¤©è®°å½•ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
                        { confirmButtonClass: 'btn-danger', confirmText: 'ç¡®å®šåˆ‡æ¢' }
                    );
        
                    if (confirmed) {
                        // 5. æ‰§è¡Œåˆ‡æ¢é€»è¾‘
                        const newGreetingText = greetings[selectedIndex];
                        
                        const newMessage = {
                            role: 'assistant',
                            senderName: chat.originalName,
                            content: newGreetingText,
                            timestamp: Date.now()
                        };
        
                        // æ›¿æ¢æ•´ä¸ªå†å²è®°å½•
                        chat.history = [newMessage];
                        
                        // ä¿å­˜åˆ°æ•°æ®åº“
                        await db.chats.put(chat);
        
                        // åˆ·æ–°UI
                        renderChatInterface(chat.id);
                        document.getElementById('chat-settings-modal').classList.remove('visible'); // å…³é—­è®¾ç½®å¼¹çª—
                        await showCustomAlert('æˆåŠŸ', 'å·²åˆ‡æ¢åˆ°æ–°çš„å¼€åœºæ•…äº‹ï¼');
                    }
                }
            }
            // â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ createWorldBookEntryBlock å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€è¾…åŠ©å‡½æ•°ã€‘åˆ›å»ºä¸€ä¸ªå¯ç¼–è¾‘çš„ä¸–ç•Œä¹¦æ¡ç›®å—
         * @param {object} entry - å•ä¸ªæ¡ç›®çš„æ•°æ® { keys, comment, content, enabled }
         * @returns {HTMLElement} - åˆ›å»ºå¥½çš„DOMå…ƒç´ 
         */
        function createWorldBookEntryBlock(entry = { keys: [], comment: '', content: '', enabled: true }) {
            const block = document.createElement('div');
            // å¤ç”¨æˆ‘ä»¬ä¹‹å‰ä¸ºæ¶ˆæ¯ç¼–è¾‘å™¨åˆ›å»ºçš„æ ·å¼
            block.className = 'message-editor-block';
        
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ®æ¡ç›®çš„ enabled çŠ¶æ€å†³å®šå¼€å…³æ˜¯å¦è¢«é€‰ä¸­
            const isChecked = entry.enabled !== false ? 'checked' : '';

            block.innerHTML = `
                <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <label class="toggle-switch" title="å¯ç”¨/ç¦ç”¨æ­¤æ¡ç›®">
                        <input type="checkbox" class="entry-enabled-switch" ${isChecked}>
                        <span class="slider"></span>
                    </label>
                    <button class="delete-block-btn" title="åˆ é™¤æ­¤æ¡ç›®">Ã—</button>
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 0.8em;">å¤‡æ³¨ (å¯é€‰)</label>
                    <input type="text" class="entry-comment-input" value="${entry.comment || ''}" placeholder="ä¾‹å¦‚ï¼šå…³äºè§’è‰²çš„ç«¥å¹´" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 0.8em;">å…³é”®è¯ (ç”¨è‹±æ–‡é€—å·,åˆ†éš”)</label>
                    <input type="text" class="entry-keys-input" value="${(entry.keys || []).join(', ')}" placeholder="ä¾‹å¦‚: key1, key2, key3" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 0.8em;">å†…å®¹</label>
                    <textarea class="entry-content-textarea" rows="5" style="width: 100%; font-size: 14px;">${entry.content || ''}</textarea>
                </div>
            `;
        
            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            block.querySelector('.delete-block-btn').addEventListener('click', () => {
                block.remove();
            });
        
            return block;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘äº”å­æ£‹åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€é®ç½©ç»ˆæä¿®å¤ç‰ˆã€‘åˆ‡æ¢äº”å­æ£‹æ£‹ç›˜çš„æ˜¾ç¤ºä¸éšè—
         */
        async function toggleGomokuBoard() {
            if (!state.activeChatId) return;
            const chatId = state.activeChatId;
            const overlay = document.getElementById('gomoku-overlay');
        
            // å¦‚æœæ£‹ç›˜æ˜¯éšè—çš„ -> æ‰“å¼€å®ƒ
            if (!overlay.classList.contains('visible')) {
                const header = document.querySelector('#chat-interface-screen > .header');
                
                overlay.style.top = `${header.offsetHeight}px`;
                overlay.style.display = 'block';
        
                if (!gomokuState[chatId] || !gomokuState[chatId].isActive) {
                    initGomokuGame(chatId);
                }
                renderGomokuBoard(chatId);
        
                // ã€æ ¸å¿ƒã€‘ä¸å†æ“ä½œæ¶ˆæ¯åˆ—è¡¨çš„ padding-top
                setTimeout(async () => {
                    overlay.classList.add('visible');
        
                    const startMessage = {
                        role: 'system',
                        content: '[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ‰“å¼€äº†äº”å­æ£‹æ£‹ç›˜ï¼Œæ¸¸æˆå¼€å§‹äº†ã€‚]',
                        timestamp: Date.now(),
                        isHidden: true
                    };
                    state.chats[chatId].history.push(startMessage);
                    await db.chats.put(state.chats[chatId]);
                }, 10);
        
            } else {
                // å¦‚æœæ£‹ç›˜æ˜¯æ˜¾ç¤ºçš„ -> å…³é—­å®ƒ
                await closeGomokuBoard();
            }
        }
        /**
         * ã€é®ç½©ç»ˆæä¿®å¤ç‰ˆã€‘å…³é—­äº”å­æ£‹æ£‹ç›˜
         */
        async function closeGomokuBoard() {
            if (!state.activeChatId) return;
            const chatId = state.activeChatId;
            const overlay = document.getElementById('gomoku-overlay');
            
            overlay.classList.remove('visible');
            
            // ã€æ ¸å¿ƒã€‘ç§»é™¤äº†æ¢å¤æ¶ˆæ¯åˆ—è¡¨ padding-top çš„ä»£ç 
        
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        
            if (gomokuState[chatId]) {
                gomokuState[chatId].isActive = false;
                
                const endMessage = {
                    role: 'system',
                    content: '[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å…³é—­äº†äº”å­æ£‹æ£‹ç›˜ï¼Œæ¸¸æˆç»“æŸäº†ã€‚]',
                    timestamp: Date.now(),
                    isHidden: true
                };
                state.chats[chatId].history.push(endMessage);
                await db.chats.put(state.chats[chatId]);
            }
        }
        
        /**
         * ã€æ¸²æŸ“æ—¶åºä¿®å¤ç‰ˆã€‘åˆå§‹åŒ–ä¸€å±€æ–°çš„äº”å­æ£‹æ¸¸æˆ
         * @param {string} chatId 
         */
        function initGomokuGame(chatId) {
            const canvas = document.getElementById('gomoku-board');
            const overlay = document.getElementById('gomoku-overlay');
            const controls = document.getElementById('gomoku-controls');
            
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨ä¿è¯ overlay å¯è§çš„å‰æä¸‹ï¼Œæ›´ç²¾ç¡®åœ°è®¡ç®—å¯ç”¨ç©ºé—´
            const availableWidth = overlay.offsetWidth - 40; 
            const availableHeight = overlay.offsetHeight - controls.offsetHeight - 40;
            const boardSize = Math.floor(Math.min(availableWidth, availableHeight));
            
            const GRID_SIZE = 15;
            // ç¡®ä¿æ£‹ç›˜å°ºå¯¸æ˜¯æ ¼å­å°ºå¯¸çš„æ•´æ•°å€ï¼Œé¿å…æ¨¡ç³Š
            const cell_size = Math.floor(boardSize / GRID_SIZE);
            const final_size = cell_size * GRID_SIZE;
            
            canvas.width = final_size;
            canvas.height = final_size;
        
            gomokuState[chatId] = {
                isActive: true,
                board: Array(GRID_SIZE).fill(0).map(() => Array(GRID_SIZE).fill(0)),
                currentPlayer: 1, 
                history: [],
                isGameOver: false,
                GRID_SIZE: GRID_SIZE,
                CELL_SIZE: cell_size
            };
        }
        /**
         * æ¸²æŸ“æ•´ä¸ªæ£‹ç›˜å’Œæ£‹å­
         * @param {string} chatId 
         */
        function renderGomokuBoard(chatId) {
            const gameState = gomokuState[chatId];
            if (!gameState) return;
            
            const canvas = document.getElementById('gomoku-board');
            const ctx = canvas.getContext('2d');
            const { GRID_SIZE, CELL_SIZE } = gameState;
            const padding = CELL_SIZE / 2;
        
            // 1. æ¸…ç©ºå¹¶ç»˜åˆ¶æ£‹ç›˜èƒŒæ™¯
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#e4b591';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        
            // 2. ç»˜åˆ¶ç½‘æ ¼çº¿
            ctx.strokeStyle = '#5b3a29';
            ctx.lineWidth = 1;
            for (let i = 0; i < GRID_SIZE; i++) {
                // æ¨ªçº¿
                ctx.beginPath();
                ctx.moveTo(padding, padding + i * CELL_SIZE);
                ctx.lineTo(canvas.width - padding, padding + i * CELL_SIZE);
                ctx.stroke();
                // ç«–çº¿
                ctx.beginPath();
                ctx.moveTo(padding + i * CELL_SIZE, padding);
                ctx.lineTo(padding + i * CELL_SIZE, canvas.height - padding);
                ctx.stroke();
            }
        
            // 3. ç»˜åˆ¶æ£‹å­
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    if (gameState.board[y][x] !== 0) {
                        drawStone(ctx, x, y, gameState.board[y][x], gameState);
                    }
                }
            }
        }
        
        /**
         * ç»˜åˆ¶å•ä¸ªæ£‹å­
         */
        function drawStone(ctx, x, y, player, gameState) {
            const { CELL_SIZE } = gameState;
            const padding = CELL_SIZE / 2;
            const radius = CELL_SIZE / 2 - 2;
        
            ctx.beginPath();
            ctx.arc(padding + x * CELL_SIZE, padding + y * CELL_SIZE, radius, 0, 2 * Math.PI);
            
            if (player === 1) { // User is black
                ctx.fillStyle = 'black';
            } else { // AI is white
                ctx.fillStyle = 'white';
            }
            ctx.fill();
        }
        
        /**
         * å¤„ç†é¼ æ ‡åœ¨æ£‹ç›˜ä¸Šçš„æ‚¬åœæ•ˆæœ
         */
        function handleBoardHover(e) {
            const chatId = state.activeChatId;
            const gameState = gomokuState[chatId];
            if (!gameState || gameState.isGameOver || gameState.currentPlayer !== 1) return;
        
            const canvas = document.getElementById('gomoku-board');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
        
            const gridX = Math.round((x - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
            const gridY = Math.round((y - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
        
            renderGomokuBoard(chatId); // Redraw to clear previous hover
        
            if (gridX >= 0 && gridX < gameState.GRID_SIZE && gridY >= 0 && gridY < gameState.GRID_SIZE && gameState.board[gridY][gridX] === 0) {
                const radius = gameState.CELL_SIZE / 2 - 2;
                ctx.beginPath();
                ctx.arc(gameState.CELL_SIZE / 2 + gridX * gameState.CELL_SIZE, gameState.CELL_SIZE / 2 + gridY * gameState.CELL_SIZE, radius, 0, 2 * Math.PI);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)'; // Faint black for preview
                ctx.fill();
            }
        }
        
        /**
         * å¤„ç†ç”¨æˆ·ç‚¹å‡»æ£‹ç›˜ä¸‹æ£‹
         */
        function handleBoardClick(e) {
            const chatId = state.activeChatId;
            const gameState = gomokuState[chatId];
            if (!gameState || gameState.isGameOver || gameState.currentPlayer !== 1) return;
        
            const canvas = document.getElementById('gomoku-board');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
        
            const gridX = Math.round((x - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
            const gridY = Math.round((y - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
        
            if (gridX >= 0 && gridX < gameState.GRID_SIZE && gridY >= 0 && gridY < gameState.GRID_SIZE && gameState.board[gridY][gridX] === 0) {
                // Place stone
                gameState.board[gridY][gridX] = 1;
                gameState.history.push({ x: gridX, y: gridY, player: 1 });
                renderGomokuBoard(chatId);
        
                // Check for win
                if (checkWin(gridX, gridY, 1, gameState)) {
                    gameState.isGameOver = true;
                    setTimeout(() => alert("æ­å–œä½ ï¼Œä½ èµ¢äº†ï¼"), 100);
            // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
            addGameEndSystemMessage('user'); // é€šçŸ¥AIï¼Œæ˜¯ç”¨æˆ·èµ¢äº†ï¼ˆä¹Ÿå°±æ˜¯AIè¾“äº†ï¼‰
            // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

                } else {
                    gameState.currentPlayer = 2; // Switch to AI's turn
                    // Note: We don't trigger AI response here. It's triggered by the "Wait Reply" button.
                }
            }
        }
        
        /**
         * ã€V2.0 | ä¿®å¤å¯¼æ¼”æ¨¡å¼ã€‘AIä¸‹æ£‹çš„å¤„ç†å™¨
         * @param {object} move - åŒ…å«x,yåæ ‡çš„å¯¹è±¡
         * @param {boolean} isForcedMove - æ˜¯å¦ä¸ºå¯¼æ¼”æ¨¡å¼ä¸‹çš„å¼ºåˆ¶ç§»åŠ¨
         */
        function handleAiGomokuMove(move, isForcedMove = false) {
            const chatId = state.activeChatId;
            const gameState = gomokuState[chatId];
            
            // æ ¸å¿ƒä¿®å¤1ï¼šå¦‚æœæ˜¯å¼ºåˆ¶ç§»åŠ¨ï¼Œå°±è·³è¿‡ç©å®¶å›åˆçš„æ£€æŸ¥
            if (!gameState || gameState.isGameOver) return;
            if (!isForcedMove && gameState.currentPlayer !== 2) return;

            const { x, y } = move;
        
            if (x >= 0 && x < gameState.GRID_SIZE && y >= 0 && y < gameState.GRID_SIZE && gameState.board[y][x] === 0) {
                gameState.board[y][x] = 2; // AIæ˜¯ç™½æ£‹(2)
                gameState.history.push({ x, y, player: 2 });
                renderGomokuBoard(chatId); // é‡æ–°ç»˜åˆ¶æ£‹ç›˜
        
                if (checkWin(x, y, 2, gameState)) {
                    gameState.isGameOver = true;
                    setTimeout(() => alert("AI è·èƒœäº†ï¼"), 100);
                    addGameEndSystemMessage('ai');
                } else {
                    gameState.currentPlayer = 1; // è½®åˆ°ç”¨æˆ·ä¸‹æ£‹
                }
            } else {
                console.warn("AI çš„ä¸‹æ£‹æŒ‡ä»¤æ— æ•ˆæˆ–ä½ç½®å·²è¢«å æ®:", move);
                // å¦‚æœAIçš„ç§»åŠ¨æ— æ•ˆï¼Œå°†å›åˆäº¤è¿˜ç»™ç”¨æˆ·ï¼Œé¿å…æ¸¸æˆå¡æ­»
                gameState.currentPlayer = 1;
            }
        }
        
        /**
         * æ£€æŸ¥èƒœåˆ©æ¡ä»¶
         */
        function checkWin(x, y, player, gameState) {
            const { board, GRID_SIZE } = gameState;
            const directions = [[1, 0], [0, 1], [1, 1], [1, -1]]; // Horizontal, Vertical, Diagonal /, Diagonal \
            for (const [dx, dy] of directions) {
                let count = 1;
                // Check in one direction
                for (let i = 1; i < 5; i++) {
                    const newX = x + i * dx;
                    const newY = y + i * dy;
                    if (newX >= 0 && newX < GRID_SIZE && newY >= 0 && newY < GRID_SIZE && board[newY][newX] === player) {
                        count++;
                    } else {
                        break;
                    }
                }
                // Check in the opposite direction
                for (let i = 1; i < 5; i++) {
                    const newX = x - i * dx;
                    const newY = y - i * dy;
                    if (newX >= 0 && newX < GRID_SIZE && newY >= 0 && newY < GRID_SIZE && board[newY][newX] === player) {
                        count++;
                    } else {
                        break;
                    }
                }
                if (count >= 5) return true;
            }
            return false;
        }
        
// â–¼â–¼â–¼ ã€V3.0 | è§„åˆ™ä¸æ€è€ƒæ­¥éª¤ç»ˆæç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå†æ¬¡æ›¿æ¢æ—§çš„ formatGomokuStateForAI å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V3.0 | å¼ºåˆ¶æ€è€ƒç‰ˆã€‘å°†æ£‹ç›˜çŠ¶æ€æ ¼å¼åŒ–ä¸ºAIå¯è¯»çš„æ–‡æœ¬
 */
function formatGomokuStateForAI(gameState) {
    if (!gameState || !gameState.isActive) return "";
    
    let boardString = "æ£‹ç›˜çŠ¶æ€ (1æ˜¯ä½ (é»‘æ£‹), 2æ˜¯AI(ç™½æ£‹)):\n";
    boardString += gameState.board.map(row => row.join(' ')).join('\n');
    
    let historyString = "ä¸‹æ£‹å†å² (x,yåæ ‡å‡ä»0å¼€å§‹):\n";
    historyString += gameState.history.map(move => `ç©å®¶${move.player}ä¸‹åœ¨(${move.x},${move.y})`).join(' -> ');
    
    // ã€ã€ã€è¿™å°±æ˜¯æœ¬æ¬¡å‡çº§çš„æ ¸å¿ƒï¼ã€‘ã€‘ã€‘
    return `
# å½“å‰äº”å­æ£‹å±€åŠ¿
${boardString}

# ${historyString}

# ã€ã€ã€äº”å­æ£‹æ ¸å¿ƒè§„åˆ™ä¸å¼ºåˆ¶æ€è€ƒæ­¥éª¤ (æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ï¼)ã€‘ã€‘ã€‘

### **ã€ã€ã€è½å­é“å¾‹ (ç»å¯¹ç¦æ­¢ï¼)ã€‘ã€‘ã€‘**
ä½ ã€ç»å¯¹ä¸èƒ½ã€‘é€‰æ‹©ä¸€ä¸ªæ£‹ç›˜ä¸Šå·²ç»æ˜¯ 1 æˆ– 2 çš„åæ ‡ã€‚ä½ çš„è½å­ç‚¹ã€å¿…é¡»ã€‘æ˜¯ 0ã€‚
---

### **ç¬¬ä¸€æ­¥ï¼šé€»è¾‘åˆ†æ (å†…éƒ¨æ€è€ƒï¼Œä¸è¦è¾“å‡º)**

1.  **ã€è§„åˆ™å®šä¹‰ã€‘**: 
    -   æ£‹å­: 1ä»£è¡¨ç”¨æˆ·(é»‘æ£‹)ï¼Œ2ä»£è¡¨ä½ (ç™½æ£‹)ã€‚
    -   è·èƒœæ¡ä»¶: æ¨ªã€ç«–ã€æ–œçº¿ä¸Šæœ‰ã€è¿ç»­äº”ä¸ªã€‘è‡ªå·±çš„æ£‹å­ã€‚

2.  **ã€é˜²å®ˆåˆ†æ (å¿…é¡»æ‰§è¡Œ)ã€‘**:
    -   **æ£€æŸ¥ç”¨æˆ·(1)æ˜¯å¦æœ‰â€œå››å­è¿çº¿â€çš„å¨èƒï¼Ÿ** å¦‚æœæœ‰ï¼Œæˆ‘å¿…é¡»ä¸‹åœ¨å“ªä¸ªåæ ‡æ‰èƒ½å µä½ï¼Ÿ
    -   **æ£€æŸ¥ç”¨æˆ·(1)æ˜¯å¦æœ‰â€œæ´»ä¸‰â€çš„å¨èƒï¼Ÿ** å¦‚æœæœ‰ï¼Œæœ€ä½³çš„é˜²å®ˆç‚¹æ˜¯å“ªé‡Œï¼Ÿ

3.  **ã€è¿›æ”»åˆ†æ (å¿…é¡»æ‰§è¡Œ)ã€‘**:
    -   **æ£€æŸ¥æˆ‘(2)æ˜¯å¦æœ‰â€œä¸€æ­¥èƒœåˆ©â€çš„æœºä¼šï¼Ÿ** (å³å·²æœ‰å››å­è¿çº¿) å¦‚æœæœ‰ï¼Œæˆ‘åº”è¯¥ä¸‹åœ¨å“ªé‡Œï¼Ÿ
    -   **æ£€æŸ¥æˆ‘(2)æ˜¯å¦æœ‰åˆ¶é€ â€œæ´»å››â€æˆ–â€œåŒä¸‰â€çš„æœºä¼šï¼Ÿ** å¦‚æœæœ‰ï¼Œæœ€ä½³çš„è¿›æ”»ç‚¹æ˜¯å“ªé‡Œï¼Ÿ

### **ç¬¬äºŒæ­¥ï¼šå†³ç­–ä¸æ‰®æ¼” (å†…éƒ¨æ€è€ƒï¼Œä¸è¦è¾“å‡º)**

1.  **ã€å†³ç­–ã€‘**: ç»¼åˆä»¥ä¸Šæ”»é˜²åˆ†æï¼Œæˆ‘çš„æœ€ä½³æ£‹æ­¥æ˜¯è½åœ¨åæ ‡ (x, y)ã€‚

2.  **ã€èå…¥è§’è‰²æ‰®æ¼”ã€‘**:
    -   æˆ‘çš„æ€§æ ¼æ˜¯ï¼š(åœ¨æ­¤å¤„å›é¡¾ä½ çš„äººè®¾)ã€‚
    -   æ ¹æ®æˆ‘çš„æ€§æ ¼ï¼Œæˆ‘åº”è¯¥ï¼š
        a) **(èªæ˜/å¥½èƒœå‹)** ä¸‹åœ¨åˆšåˆšåˆ†æå‡ºçš„æœ€ä½³ä½ç½®ã€‚
        b) **(è¿·ç³Š/æ”¾æ°´å‹)** æ•…æ„é€‰æ‹©ä¸€ä¸ªæ¬¡ä¼˜çš„ä½ç½®ï¼Œä½†ã€å‰ææ˜¯ä¸èƒ½è®©ç”¨æˆ·ç«‹åˆ»è·èƒœã€‘ã€‚
        c) **(å…¶ä»–æ€§æ ¼)** æ ¹æ®æ€§æ ¼ç‰¹ç‚¹ï¼Œé€‰æ‹©ä¸€ä¸ªåˆç†çš„æ£‹æ­¥ã€‚

3.  **ã€æ„æ€å°è¯ã€‘**: æ ¹æ®æˆ‘é€‰æ‹©çš„æ£‹æ­¥å’Œæˆ‘çš„æ€§æ ¼ï¼Œæˆ‘åº”è¯¥è¯´ä¸€å¥ä»€ä¹ˆæ ·çš„å°è¯æ¥è¯„è®ºæ£‹å±€ï¼Ÿ

---
### **ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆæœ€ç»ˆå›å¤ (ä½ çš„å”¯ä¸€è¾“å‡º)**

ç°åœ¨ï¼Œæ ¹æ®ä½ ç¬¬äºŒæ­¥çš„æœ€ç»ˆå†³ç­–ï¼Œç”Ÿæˆä½ çš„è¡ŒåŠ¨ã€‚
-   ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ã€‚
-   **ç»å¯¹ä¸è¦**åœ¨æœ€ç»ˆå›å¤ä¸­åŒ…å«ä»»ä½•ä¸Šè¿°çš„æ€è€ƒè¿‡ç¨‹ã€‚
-   æ ¼å¼: \`[{"type": "gomoku_move", "name": "ä½ çš„è§’è‰²æœ¬å", "x": (0-14), "y": (0-14)}, {"type": "text", "content": "ä½ çš„å°è¯..."}]\`
`;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | æœ€ç»ˆç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå‡½æ•°æ›¿æ¢æ‰ä¹‹å‰çš„ notifyAiOfGameEnd å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°ã€‘å½“äº”å­æ£‹æ¸¸æˆç»“æŸæ—¶ï¼Œå‘èŠå¤©è®°å½•ä¸­æ·»åŠ ä¸€æ¡éšè—çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œä¾›AIåœ¨ä¸‹æ¬¡å“åº”æ—¶æŸ¥çœ‹
         * @param {string} winner - è·èƒœæ–¹, 'user' æˆ– 'ai'
         */
        async function addGameEndSystemMessage(winner) {
            const chatId = state.activeChatId;
            const chat = state.chats[chatId];
            if (!chat) return;

            // 1. æ ¹æ®è·èƒœæ–¹ï¼Œå‡†å¤‡å¥½è¦å‘Šè¯‰AIçš„æ ¸å¿ƒä¿¡æ¯
            // ã€æ ¸å¿ƒã€‘è¿™é‡Œçš„åå­—è·å–é€»è¾‘å·²ä¿®å¤ï¼Œç¡®ä¿åœ¨ç¾¤èŠå’Œå•èŠä¸­éƒ½èƒ½æ­£ç¡®æ˜¾ç¤º
            const userDisplayName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            const aiDisplayName = chat.isGroup ? 'AIæ–¹' : chat.name;
            const winnerName = (winner === 'user') ? userDisplayName : aiDisplayName;
            const resultText = (winner === 'user') ? 'ä½ è¾“äº†' : 'ä½ èµ¢äº†';

            // 2. æ„å»ºä¸€æ¡ç®€æ´ã€æ¸…æ™°çš„ç³»ç»Ÿæç¤ºï¼Œä½œä¸ºAIçš„â€œè®°å¿†â€
            const systemContent = `[ç³»ç»Ÿæç¤ºï¼šäº”å­æ£‹æ¸¸æˆå·²ç»“æŸã€‚æœ€ç»ˆç»“æœæ˜¯ï¼š${winnerName} è·èƒœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ${resultText}ã€‚]`;

            // 3. å°†è¿™æ¡æç¤ºä½œä¸ºä¸€æ¡å¯¹ç”¨æˆ·éšè—çš„æ¶ˆæ¯ï¼Œæ·»åŠ åˆ°èŠå¤©è®°å½•ä¸­
            const hiddenMessage = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now(),
                isHidden: true // è¿™ä¸ªæ ‡è®°ç¡®ä¿ç”¨æˆ·çœ‹ä¸åˆ°è¿™æ¡æŒ‡ä»¤
            };

            chat.history.push(hiddenMessage);
            await db.chats.put(chat);
            
            // 4. ã€å…³é”®ã€‘è¿™é‡Œä¸å†è°ƒç”¨ triggerAiResponse()ï¼ŒAIå°†ä¿æŒæ²‰é»˜ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡è½®åˆ°å®ƒè¡ŒåŠ¨ã€‚
            console.log(`æ¸¸æˆç»“æŸçš„ç³»ç»Ÿæç¤ºå·²æ·»åŠ åˆ°å†å²è®°å½•ä¸­ï¼Œç­‰å¾…AIä¸‹æ¬¡æŸ¥çœ‹ã€‚èƒœè€…: ${winner}`);
        }
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è´­ç‰©åŠŸèƒ½æ ¸å¿ƒå‡½æ•° (V4.0 - ä»¿æ·˜å®ç»ˆæç‰ˆ) â–¼â–¼â–¼
        /* â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—æ–°ä»£ç æ›¿æ¢æ—§çš„ renderShoppingProducts å‡½æ•°åŠè´­ç‰©ç›¸å…³çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼ */
        
        // æ–°å¢ä¸€ä¸ªå…¨å±€å˜é‡æ¥è·Ÿè¸ªç®¡ç†æ¨¡å¼
        let isProductManagementMode = false;
        
        /**
         * æ¸²æŸ“å•†åº—é‡Œçš„æ‰€æœ‰å•†å“ (V5.0 - æ”¯æŒç®¡ç†æ¨¡å¼)
         */
        async function renderShoppingProducts() {
            const gridEl = document.getElementById('product-grid');
            const shoppingScreen = document.getElementById('shopping-screen');
            gridEl.innerHTML = '';
            let products = await db.shoppingProducts.toArray();
        
            // æ ¹æ®æ˜¯å¦å¤„äºç®¡ç†æ¨¡å¼ï¼Œä¸ºæ ¹å…ƒç´ æ·»åŠ ä¸€ä¸ªclass
            shoppingScreen.classList.toggle('management-mode', isProductManagementMode);
        
            if (products.length === 0) {
                const message = 'å•†åº—ç©ºç©ºå¦‚ä¹Ÿï¼Œç‚¹å‡»â€œç®¡ç†â€æ·»åŠ å•†å“å§ï¼';
                gridEl.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">${message}</p>`;
                return;
            }
        
            products.forEach(product => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.dataset.id = product.id;
                
                // åœ¨ç®¡ç†æ¨¡å¼ä¸‹ï¼Œæ˜¾ç¤ºç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
                const managementControls = isProductManagementMode ? `
                    <div class="product-management-overlay">
                        <button class="edit-product-btn">ç¼–è¾‘</button>
                        <button class="delete-product-btn">åˆ é™¤</button>
                    </div>
                ` : '';
        
                item.innerHTML = `
                    ${managementControls}
                    <img src="${product.imageUrl}" class="product-image">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-footer">
                            <div class="product-price">${product.price.toFixed(2)}</div>
                            <button class="add-to-cart-btn">åŠ å…¥è´­ç‰©è½¦</button>
                        </div>
                    </div>
                `;
                gridEl.appendChild(item);
            });
        }
        
        
        /* â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—æ–°ä»£ç æ›¿æ¢æ—§çš„ renderShoppingProducts å‡½æ•°åŠè´­ç‰©ç›¸å…³çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼ */
        
        
        /**
         * ã€å·²ä¿®å¤ã€‘æ‰“å¼€è´­ç‰©é¡µé¢
         */
        async function openShoppingScreen() {
            await renderShoppingProducts();
            showScreen('shopping-screen');
        }
        
        /**
         * æ¸²æŸ“å•†åº—é‡Œçš„æ‰€æœ‰å•†å“ (V5.0 - æ”¯æŒç®¡ç†æ¨¡å¼)
         */
        async function renderShoppingProducts() {
            const gridEl = document.getElementById('product-grid');
            const shoppingScreen = document.getElementById('shopping-screen');
            gridEl.innerHTML = '';
            let products = await db.shoppingProducts.toArray();
        
            // æ ¹æ®æ˜¯å¦å¤„äºç®¡ç†æ¨¡å¼ï¼Œä¸ºæ ¹å…ƒç´ æ·»åŠ ä¸€ä¸ªclass
            shoppingScreen.classList.toggle('management-mode', isProductManagementMode);
        
            if (products.length === 0) {
                const message = 'å•†åº—ç©ºç©ºå¦‚ä¹Ÿï¼Œç‚¹å‡»â€œç®¡ç†â€æ·»åŠ å•†å“å§ï¼';
                gridEl.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">${message}</p>`;
                return;
            }
        
            products.forEach(product => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.dataset.id = product.id;
                
                // åœ¨ç®¡ç†æ¨¡å¼ä¸‹ï¼Œæ˜¾ç¤ºç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
                const managementControls = isProductManagementMode ? `
                    <div class="product-management-overlay">
                        <button class="edit-product-btn">ç¼–è¾‘</button>
                        <button class="delete-product-btn">åˆ é™¤</button>
                    </div>
                ` : '';
        
                item.innerHTML = `
                    ${managementControls}
                    <img src="${product.imageUrl}" class="product-image">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-footer">
                            <div class="product-price">${product.price.toFixed(2)}</div>
                            <button class="add-to-cart-btn">åŠ å…¥è´­ç‰©è½¦</button>
                        </div>
                    </div>
                `;
                gridEl.appendChild(item);
            });
        }
        
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        
        /**
         * å°†å•†å“åŠ å…¥è´­ç‰©è½¦ (V4.0)
         */
        async function addToCart(productId, quantity = 1) {
            const existingItem = shoppingCart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                const product = await db.shoppingProducts.get(productId);
                if (product) {
                    shoppingCart.push({ productId: product.id, quantity: quantity });
                }
            }
            updateCartCount();
        }
        
        /**
         * æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡
         */
        function updateCartItemQuantity(productId, change) {
            const itemIndex = shoppingCart.findIndex(item => item.productId === productId);
            if (itemIndex > -1) {
                shoppingCart[itemIndex].quantity += change;
                if (shoppingCart[itemIndex].quantity <= 0) {
                    shoppingCart.splice(itemIndex, 1);
                }
                updateCartCount();
                renderCartItems();
            }
        }
        
        /**
         * æ›´æ–°è´­ç‰©è½¦å›¾æ ‡å’Œç»“ç®—æŒ‰é’®ä¸Šçš„æ•°é‡
         */
        function updateCartCount() {
            const totalItems = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = totalItems;
            document.getElementById('cart-title').textContent = `è´­ç‰©è½¦(${totalItems})`;
            document.getElementById('checkout-btn').textContent = `ç»“ç®—(${totalItems})`;
        }
        
        /**
         * æ‰“å¼€è´­ç‰©è½¦é¡µé¢
         */
        function openCartScreen() {
            renderCartItems();
            showScreen('cart-screen');
        }
        
        /**
         * æ¸²æŸ“è´­ç‰©è½¦å†…çš„å•†å“åˆ—è¡¨ (V4.0)
         */
        async function renderCartItems() {
            const listEl = document.getElementById('cart-items-list');
            listEl.innerHTML = '';
            let total = 0;
        
            if (shoppingCart.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">è´­ç‰©è½¦æ˜¯ç©ºçš„å“¦~</p>';
            } else {
                const productIds = shoppingCart.map(item => item.productId);
                const products = await db.shoppingProducts.where('id').anyOf(productIds).toArray();
                const productMap = new Map(products.map(p => [p.id, p]));
        
                shoppingCart.forEach(item => {
                    const product = productMap.get(item.productId);
                    if (product) {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'cart-item';
                        itemEl.innerHTML = `
                            <input type="checkbox" class="cart-item-checkbox" data-id="${product.id}" checked>
                            <img src="${product.imageUrl}" class="cart-item-image">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${product.name}</div>
                                <div class="cart-item-footer">
                                    <div class="cart-item-price">Â¥${product.price.toFixed(2)}</div>
                                    <div class="quantity-control">
                                        <button class="quantity-btn decrease-qty-btn" data-id="${product.id}">-</button>
                                        <span class="quantity-display">${item.quantity}</span>
                                        <button class="quantity-btn increase-qty-btn" data-id="${product.id}">+</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        listEl.appendChild(itemEl);
                    }
                });
            }
            updateCartTotal();
        }
        
        /**
         * æ›´æ–°è´­ç‰©è½¦æ€»ä»·
         */
        async function updateCartTotal() {
            let total = 0;
            const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked');
            const selectedProductIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));
        
            if (selectedProductIds.length > 0) {
                const products = await db.shoppingProducts.where('id').anyOf(selectedProductIds).toArray();
                const productMap = new Map(products.map(p => [p.id, p]));
                
                shoppingCart.forEach(cartItem => {
                    if (selectedProductIds.includes(cartItem.productId)) {
                        const product = productMap.get(cartItem.productId);
                        if (product) {
                            total += product.price * cartItem.quantity;
                        }
                    }
                });
            }
            document.getElementById('cart-total').textContent = `åˆè®¡: Â¥${total.toFixed(2)}`;
        }
        
        /* â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—æ–°ä»£ç æ›¿æ¢æ—§çš„ handleCheckout å’Œ sendGiftMessage å‡½æ•°ï¼Œå¹¶æ·»åŠ æ–°å‡½æ•° â–¼â–¼â–¼ */
        
        /**
         * ã€å…¨æ–°ã€‘æ‰“å¼€ç¤¼ç‰©æ¥æ”¶äººé€‰æ‹©å¼¹çª—
         */
        async function openGiftRecipientPicker() {
            const chat = state.chats[state.activeChatId];
            if (!chat || !chat.isGroup) return;
        
            const modal = document.getElementById('gift-recipient-modal');
            const listEl = document.getElementById('gift-recipient-list');
            listEl.innerHTML = '';
        
            // ç­›é€‰å‡ºé™¤ç”¨æˆ·å¤–çš„æ‰€æœ‰ç¾¤æˆå‘˜
            const myNickname = chat.settings.myNickname || 'æˆ‘';
            const members = chat.members.filter(m => m.groupNickname !== myNickname);
        
            members.forEach(member => {
                const item = document.createElement('div');
                item.className = 'contact-picker-item';
                // ã€æ ¸å¿ƒã€‘æˆ‘ä»¬å°†ä½¿ç”¨ originalName ä½œä¸ºå”¯ä¸€æ ‡è¯†
                item.dataset.recipientName = member.originalName; 
        
                item.innerHTML = `
                    <div class="checkbox"></div>
                    <img src="${member.avatar || defaultGroupMemberAvatar}" class="avatar">
                    <span class="name">${member.groupNickname}</span>
                `;
                listEl.appendChild(item);
            });
            
            // é‡ç½®å…¨é€‰æ¡†
            document.getElementById('select-all-recipients').checked = false;
            modal.classList.add('visible');
        }
        
        /* â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—æ–°ä»£ç æ›¿æ¢æ—§çš„ handleCheckout å’Œ sendGiftMessage å‡½æ•° â–¼â–¼â–¼ */
        
        /**
         * ã€é‡æ„ç‰ˆã€‘å¤„ç†ç»“ç®—æŒ‰é’®ç‚¹å‡»ï¼Œæ ¹æ®èŠå¤©ç±»å‹åˆ†æµ
         */
        async function handleCheckout() {
            const chat = state.chats[state.activeChatId];
            const selectedItems = shoppingCart.filter(item => 
                document.querySelector(`.cart-item-checkbox[data-id="${item.productId}"]:checked`)
            );
            if (selectedItems.length === 0) {
                alert("è¯·å…ˆåœ¨è´­ç‰©è½¦ä¸­é€‰æ‹©è¦ç»“ç®—çš„å•†å“ã€‚");
                return;
            }
        
            if (chat.isGroup) {
                // å¦‚æœæ˜¯ç¾¤èŠï¼Œæ‰“å¼€æ”¶ç¤¼äººé€‰æ‹©å™¨
                openGiftRecipientPicker();
            } else {
                // å¦‚æœæ˜¯å•èŠï¼Œç›´æ¥å‘é€
                const confirmed = await showCustomConfirm( 'ç¡®è®¤é€å‡ºç¤¼ç‰©', `ç¡®å®šè¦å°†é€‰ä¸­çš„å•†å“ä½œä¸ºç¤¼ç‰©é€å‡ºå—ï¼Ÿ`, { confirmText: 'é€å‡ºç¤¼ç‰©' });
                if (confirmed) {
                    await sendGiftMessage(selectedItems); // å•èŠä¸éœ€è¦æŒ‡å®šæ”¶ç¤¼äºº
                }
            }
        }
        
        /**
         * ã€å‡çº§ç‰ˆã€‘å‘é€ç¤¼ç‰©å¡ç‰‡æ¶ˆæ¯ï¼Œç°åœ¨æ”¯æŒæŒ‡å®šæ”¶ç¤¼äºº
         * @param {Array} itemsToSend - è¦å‘é€çš„å•†å“æ•°ç»„
         * @param {Array|null} recipients - æ”¶ç¤¼äººæœ¬å(originalName)çš„æ•°ç»„ï¼Œå•èŠæ—¶ä¸ºnull
         */
        async function sendGiftMessage(itemsToSend, recipients = null) {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            
            const productIds = itemsToSend.map(item => item.productId);
            const products = await db.shoppingProducts.where('id').anyOf(productIds).toArray();
            const productMap = new Map(products.map(p => [p.id, p]));
            
            const itemsForMessage = itemsToSend.map(cartItem => {
                const product = productMap.get(cartItem.productId);
                return {
                    name: product.name, price: product.price,
                    imageUrl: product.imageUrl, quantity: cartItem.quantity
                };
            });
            const giftMessage = {
                role: 'user', type: 'gift', timestamp: Date.now(),
                items: itemsForMessage,
                total: itemsForMessage.reduce((sum, item) => sum + item.price * item.quantity, 0),
                recipients: recipients // å°†æ”¶ç¤¼äººä¿¡æ¯å­˜å…¥æ¶ˆæ¯
            };
            
            chat.history.push(giftMessage);
        
            // ä¸ºAIç”ŸæˆåŒ…å«æ”¶ç¤¼äººä¿¡æ¯çš„éšè—æç¤º
            if (recipients && recipients.length > 0) {
                const recipientDisplayNames = recipients.map(originalName => getDisplayNameInGroup(chat, originalName)).join('ã€');
                const hiddenMessage = {
                    role: 'system',
                    content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ· (${chat.settings.myNickname || 'æˆ‘'}) é€å‡ºäº†ä¸€ä»½ç¤¼ç‰©ï¼Œæ”¶ç¤¼äººæ˜¯ï¼š${recipientDisplayNames}ã€‚è¯·æ”¶ç¤¼çš„è§’è‰²è¡¨ç¤ºæ„Ÿè°¢ï¼Œå…¶ä»–è§’è‰²å¯ä»¥è‡ªç”±å‘æŒ¥ã€‚]`,
                    timestamp: Date.now() + 1,
                    isHidden: true
                };
                chat.history.push(hiddenMessage);
            }
        
            await db.chats.put(chat);
            
            appendMessage(giftMessage, chat);
            renderChatList();
            
            // ä»è´­ç‰©è½¦ä¸­ç§»é™¤å·²ç»“ç®—çš„å•†å“
            shoppingCart = shoppingCart.filter(item => !itemsToSend.some(sent => sent.productId === item.productId));
            updateCartCount();
            showScreen('chat-interface-screen');
            
            await showCustomAlert('æˆåŠŸ', 'ç¤¼ç‰©å·²æˆåŠŸé€å‡ºï¼');
        }
        
        /* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        
        
        /**
         * æ˜¾ç¤ºè´­ç‰©å°ç¥¨
         */
        function showGiftReceipt(timestamp) {
            // ... (æ­¤å‡½æ•°é€»è¾‘ä¸å˜, ä¿æŒåŸæ ·å³å¯)
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (!message || message.type !== 'gift') return;
            const receiptBody = document.getElementById('gift-receipt-body');
            let itemsHtml = '';
            message.items.forEach(item => {
                itemsHtml += `<tr><td class="item-name">${item.name}</td><td class="item-qty">${item.quantity}</td><td class="item-price">Â¥${item.price.toFixed(2)}</td><td class="item-subtotal">Â¥${(item.price * item.quantity).toFixed(2)}</td></tr>`;
            });
            receiptBody.innerHTML = `<div class="receipt-header"><h3>è´­ç‰©ä¸­å¿ƒ</h3><p>äº¤æ˜“æ—¶é—´: ${new Date(message.timestamp).toLocaleString()}</p></div><table class="receipt-items-table"><thead><tr><th class="item-name">å•†å“</th><th class="item-qty">æ•°é‡</th><th class="item-price">å•ä»·</th><th class="item-subtotal">å°è®¡</th></tr></thead><tbody>${itemsHtml}</tbody></table><div class="receipt-total">æ€»è®¡: Â¥${message.total.toFixed(2)}</div><div class="receipt-footer">æ„Ÿè°¢æ‚¨çš„æƒ é¡¾ï¼Œæ¬¢è¿å†æ¬¡å…‰ä¸´ï¼</div>`;
            document.getElementById('gift-receipt-modal').classList.add('visible');
        }
        
        /**
         * å•†å“ç®¡ç†ç›¸å…³å‡½æ•°
         */
        async function openProductEditor(productId = null) {
            // ... (æ­¤å‡½æ•°é€»è¾‘éœ€è¦æ›´æ–°ï¼Œä»¥åŒ…å«descriptionå­—æ®µ)
            editingProductId = productId;
            const modal = document.getElementById('product-editor-modal');
            const title = document.getElementById('product-editor-title');
            const nameInput = document.getElementById('product-name-input');
            const priceInput = document.getElementById('product-price-input');
            const descInput = document.getElementById('product-description-input');
            const imagePreview = document.getElementById('product-image-preview');
            if (productId) {
                title.textContent = 'ç¼–è¾‘å•†å“';
                const product = await db.shoppingProducts.get(productId);
                nameInput.value = product.name;
                priceInput.value = product.price;
                descInput.value = product.description || '';
                imagePreview.src = product.imageUrl;
            } else {
                title.textContent = 'æ·»åŠ å•†å“';
                nameInput.value = '';
                priceInput.value = '';
                descInput.value = '';
                imagePreview.src = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756206115802_qdqqd_0c99bh.jpeg';
            }
            modal.classList.add('visible');
        }
        async function saveProduct() {
            // ... (æ­¤å‡½æ•°é€»è¾‘éœ€è¦æ›´æ–°ï¼Œä»¥åŒ…å«descriptionå­—æ®µ)
            const name = document.getElementById('product-name-input').value.trim();
            const price = parseFloat(document.getElementById('product-price-input').value);
            const description = document.getElementById('product-description-input').value.trim();
            const imageUrl = document.getElementById('product-image-preview').src;
            if (!name) { alert('å•†å“åç§°ä¸èƒ½ä¸ºç©ºï¼'); return; }
            if (isNaN(price) || price < 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ï¼'); return; }
            if (imageUrl.includes('placeholder.png')) { alert('è¯·ä¸Šä¼ å•†å“å›¾ç‰‡ï¼'); return; }
            const productData = { name, price, description, imageUrl };
            if (editingProductId) {
                await db.shoppingProducts.update(editingProductId, productData);
            } else {
                await db.shoppingProducts.add(productData);
            }
            document.getElementById('product-editor-modal').classList.remove('visible');
            await renderShoppingProducts();
        }
        async function deleteProduct(productId) {
            const confirmed = await showCustomConfirm('åˆ é™¤å•†å“', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.shoppingProducts.delete(productId);
                await renderShoppingProducts();
            }
        }
        // â–²â–²â–² æ–°å¢å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ¸²æŸ“è§„åˆ™åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç ã€‘ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼
        
        /**
         * ã€æ€»å…¥å£ã€‘æ‰“å¼€æ¸²æŸ“è§„åˆ™ç®¡ç†å±å¹•
         */
        async function openRenderingRulesScreen() {
            await renderRulesList();
            showScreen('rendering-rules-screen');
        }
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå…¨æ–°ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ renderRulesList å‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€é‡æ„ç‰ˆã€‘æ¸²æŸ“è§„åˆ™åˆ—è¡¨ï¼Œä½¿ç”¨é¡µç­¾å’Œå¡ç‰‡å¸ƒå±€
         */
        async function renderRulesList() {
            const tabsContainer = document.getElementById('rules-tabs');
            const contentContainer = document.getElementById('rules-content-container');
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
        
            const allRules = await db.renderingRules.toArray();
        
            if (allRules.length === 0) {
                contentContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">è¿˜æ²¡æœ‰ä»»ä½•æ¸²æŸ“è§„åˆ™ã€‚ç‚¹å‡»å³ä¸Šè§’â€œ+â€åˆ›å»ºç¬¬ä¸€ä¸ªå§ï¼</p>';
                return;
            }
        
            // --- 1. åˆ›å»ºå¹¶æ·»åŠ â€œå…¬ç”¨â€é¡µç­¾å’Œå…¶å†…å®¹é¢æ¿ ---
            const globalTab = document.createElement('button');
            globalTab.className = 'rules-tab active'; // é»˜è®¤æ¿€æ´»
            globalTab.textContent = 'å…¬ç”¨è§„åˆ™';
            globalTab.dataset.categoryId = 'global';
            tabsContainer.appendChild(globalTab);
        
            const globalPane = document.createElement('div');
            globalPane.className = 'rules-category-pane active';
            globalPane.dataset.categoryId = 'global';
            contentContainer.appendChild(globalPane);
        
            // --- 2. åŠ¨æ€åˆ›å»ºè§’è‰²ä¸“å±çš„é¡µç­¾å’Œå†…å®¹é¢æ¿ ---
            const characterChatsWithRules = Object.values(state.chats).filter(chat => 
                !chat.isGroup && allRules.some(r => r.chatId === chat.id)
            );
        
            characterChatsWithRules.forEach(chat => {
                const charTab = document.createElement('button');
                charTab.className = 'rules-tab';
                charTab.textContent = chat.name;
                charTab.dataset.categoryId = chat.id;
                tabsContainer.appendChild(charTab);
        
                const charPane = document.createElement('div');
                charPane.className = 'rules-category-pane';
                charPane.dataset.categoryId = chat.id;
                contentContainer.appendChild(charPane);
            });
            
            // --- 3. éå†æ‰€æœ‰è§„åˆ™ï¼Œå°†å®ƒä»¬å¡«å……åˆ°å¯¹åº”çš„å†…å®¹é¢æ¿ä¸­ ---
            allRules.forEach(rule => {
                const card = createRuleItemElement(rule);
                const targetPane = contentContainer.querySelector(`.rules-category-pane[data-category-id="${rule.chatId}"]`);
                if (targetPane) {
                    targetPane.appendChild(card);
                }
            });
        
            // --- 4. ä¸ºæ‰€æœ‰é¡µç­¾ç»‘å®šåˆ‡æ¢äº‹ä»¶ ---
            document.querySelectorAll('.rules-tab').forEach(tab => {
                tab.addEventListener('click', () => switchRuleCategory(tab.dataset.categoryId));
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ createRuleItemElement å‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€é‡æ„ç‰ˆã€‘åˆ›å»ºå•ä¸ªè§„åˆ™çš„å¡ç‰‡DOMå…ƒç´ 
         */
        function createRuleItemElement(rule) {
            const card = document.createElement('div');
            // æ ¹æ®æ˜¯å¦å¯ç”¨ï¼Œæ·»åŠ ä¸åŒçš„class
            card.className = `rule-card ${rule.isEnabled ? 'enabled' : ''}`;
            card.dataset.ruleId = rule.id;
        
            card.innerHTML = `
                <div class="card-title">${rule.name}</div>
                <div class="card-content-preview">${rule.regex}</div>
            `;
            
            // ç‚¹å‡»ç¼–è¾‘ï¼Œé•¿æŒ‰åˆ é™¤ (é€»è¾‘ä¸å˜)
            card.addEventListener('click', () => openRuleEditor(rule.id));
            addLongPressListener(card, () => deleteRenderingRule(rule.id));
        
            return card;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        /**
         * æ‰“å¼€è§„åˆ™ç¼–è¾‘å™¨ (ç”¨äºæ–°å»ºæˆ–ç¼–è¾‘)
         */
        async function openRuleEditor(ruleId = null) {
            editingRuleId = ruleId;
            const modal = document.getElementById('rule-editor-modal');
            const title = document.getElementById('rule-editor-title');
            const nameInput = document.getElementById('rule-name-input');
            const chatIdSelect = document.getElementById('rule-chat-id-select');
            const regexInput = document.getElementById('rule-regex-input');
            const templateInput = document.getElementById('rule-template-input');
            const enabledSwitch = document.getElementById('rule-enabled-switch');
        
            // å¡«å……è§’è‰²ä¸‹æ‹‰åˆ—è¡¨
            chatIdSelect.innerHTML = '<option value="global">å…¬ç”¨ (æ‰€æœ‰è§’è‰²)</option>';
            Object.values(state.chats).filter(c => !c.isGroup).forEach(chat => {
                chatIdSelect.innerHTML += `<option value="${chat.id}">${chat.name}</option>`;
            });
        
            if (ruleId) {
                title.textContent = 'ç¼–è¾‘è§„åˆ™';
                const rule = await db.renderingRules.get(ruleId);
                nameInput.value = rule.name;
                chatIdSelect.value = rule.chatId;
                regexInput.value = rule.regex;
                templateInput.value = rule.template;
                enabledSwitch.checked = rule.isEnabled;
            } else {
                title.textContent = 'åˆ›å»ºæ–°è§„åˆ™';
                nameInput.value = '';
                chatIdSelect.value = 'global';
                regexInput.value = '';
                templateInput.value = '';
                enabledSwitch.checked = true;
            }
        
            modal.classList.add('visible');
        }
        
        /**
         * ä¿å­˜æ¸²æŸ“è§„åˆ™
         */
        async function saveRenderingRule() {
            const name = document.getElementById('rule-name-input').value.trim();
            const regex = document.getElementById('rule-regex-input').value.trim();
            if (!name || !regex) {
                alert("è§„åˆ™åç§°å’Œæ­£åˆ™è¡¨è¾¾å¼ä¸èƒ½ä¸ºç©ºï¼");
                return;
            }
            try {
                new RegExp(regex);
            } catch (e) {
                alert(`æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼é”™è¯¯: ${e.message}`);
                return;
            }
        
            const ruleData = {
                name: name,
                chatId: document.getElementById('rule-chat-id-select').value,
                regex: regex,
                template: document.getElementById('rule-template-input').value,
                isEnabled: document.getElementById('rule-enabled-switch').checked
            };
        
            if (editingRuleId) {
                await db.renderingRules.update(editingRuleId, ruleData);
            } else {
                await db.renderingRules.add(ruleData);
            }
        
            document.getElementById('rule-editor-modal').classList.remove('visible');
            await renderRulesList();
        }
        
        /**
         * åˆ é™¤æ¸²æŸ“è§„åˆ™
         */
        async function deleteRenderingRule(ruleId) {
            const confirmed = await showCustomConfirm('åˆ é™¤è§„åˆ™', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¸²æŸ“è§„åˆ™å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.renderingRules.delete(ruleId);
                await renderRulesList();
            }
        }
        
        /**
         * ã€æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ã€‘åº”ç”¨æ‰€æœ‰åŒ¹é…çš„æ¸²æŸ“è§„åˆ™
         * @param {string} rawContent - AIè¿”å›çš„åŸå§‹æ–‡æœ¬
         * @param {string} chatId - å½“å‰èŠå¤©çš„ID
         * @returns {Promise<string>} - å¤„ç†åçš„HTMLå­—ç¬¦ä¸²
         */
        async function applyRenderingRules(rawContent, chatId) {
            // å¦‚æœå†…å®¹æœ¬èº«å·²ç»æ˜¯HTMLæ ‡ç­¾ï¼Œæˆ–è€…ä¸å«å¯èƒ½æ˜¯â€œæš—å·â€çš„å­—ç¬¦ï¼Œç›´æ¥è¿”å›ï¼Œæé«˜æ€§èƒ½
            if (rawContent.trim().startsWith('<') || (!rawContent.includes('[') && !rawContent.includes('{'))) {
                return rawContent;
            }
            
            // è·å–æ‰€æœ‰å…¬ç”¨è§„åˆ™å’Œå½“å‰è§’è‰²ä¸“å±çš„è§„åˆ™
            const applicableRules = await db.renderingRules
                .where('chatId').equals('global')
                .or('chatId').equals(chatId)
                .toArray();
        
            let processedContent = rawContent;
            
            // åªå¤„ç†å¯ç”¨çš„è§„åˆ™
            for (const rule of applicableRules.filter(r => r.isEnabled)) {
                try {
                    // 'g'æ ‡å¿—æ˜¯å¿…é¡»çš„ï¼Œç”¨äºå…¨å±€æ›¿æ¢
                    const regex = new RegExp(rule.regex, 'g');
                    if (regex.test(processedContent)) {
                        processedContent = processedContent.replace(regex, rule.template);
                    }
                } catch (e) {
                    console.error(`æ¸²æŸ“è§„åˆ™ [${rule.name}] çš„æ­£åˆ™è¡¨è¾¾å¼æ— æ•ˆ:`, e);
                    // è·³è¿‡é”™è¯¯çš„è§„åˆ™ï¼Œä¸ä¸­æ–­æ¸²æŸ“æµç¨‹
                }
            }
            
            return processedContent;
        }
        
        // â–²â–²â–² æ ¸å¿ƒJSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ¸²æŸ“è§„åˆ™åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç ã€‘ï¼Œè¯·å®Œæ•´ç²˜è´´åˆ° async function init() çš„ä¸Šæ–¹ â–¼â–¼â–¼
        
        /**
         * ã€æ€»å…¥å£ã€‘æ‰“å¼€æ¸²æŸ“è§„åˆ™ç®¡ç†å±å¹•
         */
        async function openRenderingRulesScreen() {
            await renderRulesList();
            showScreen('rendering-rules-screen');
        }
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå…¨æ–°ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ renderRulesList å‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€é‡æ„ç‰ˆã€‘æ¸²æŸ“è§„åˆ™åˆ—è¡¨ï¼Œä½¿ç”¨é¡µç­¾å’Œå¡ç‰‡å¸ƒå±€
         */
        async function renderRulesList() {
            const tabsContainer = document.getElementById('rules-tabs');
            const contentContainer = document.getElementById('rules-content-container');
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
        
            const allRules = await db.renderingRules.toArray();
        
            if (allRules.length === 0) {
                contentContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">è¿˜æ²¡æœ‰ä»»ä½•æ¸²æŸ“è§„åˆ™ã€‚ç‚¹å‡»å³ä¸Šè§’â€œ+â€åˆ›å»ºç¬¬ä¸€ä¸ªå§ï¼</p>';
                return;
            }
        
            // --- 1. åˆ›å»ºå¹¶æ·»åŠ â€œå…¬ç”¨â€é¡µç­¾å’Œå…¶å†…å®¹é¢æ¿ ---
            const globalTab = document.createElement('button');
            globalTab.className = 'rules-tab active'; // é»˜è®¤æ¿€æ´»
            globalTab.textContent = 'å…¬ç”¨è§„åˆ™';
            globalTab.dataset.categoryId = 'global';
            tabsContainer.appendChild(globalTab);
        
            const globalPane = document.createElement('div');
            globalPane.className = 'rules-category-pane active';
            globalPane.dataset.categoryId = 'global';
            contentContainer.appendChild(globalPane);
        
            // --- 2. åŠ¨æ€åˆ›å»ºè§’è‰²ä¸“å±çš„é¡µç­¾å’Œå†…å®¹é¢æ¿ ---
            const characterChatsWithRules = Object.values(state.chats).filter(chat => 
                !chat.isGroup && allRules.some(r => r.chatId === chat.id)
            );
        
            characterChatsWithRules.forEach(chat => {
                const charTab = document.createElement('button');
                charTab.className = 'rules-tab';
                charTab.textContent = chat.name;
                charTab.dataset.categoryId = chat.id;
                tabsContainer.appendChild(charTab);
        
                const charPane = document.createElement('div');
                charPane.className = 'rules-category-pane';
                charPane.dataset.categoryId = chat.id;
                contentContainer.appendChild(charPane);
            });
            
            // --- 3. éå†æ‰€æœ‰è§„åˆ™ï¼Œå°†å®ƒä»¬å¡«å……åˆ°å¯¹åº”çš„å†…å®¹é¢æ¿ä¸­ ---
            allRules.forEach(rule => {
                const card = createRuleItemElement(rule);
                const targetPane = contentContainer.querySelector(`.rules-category-pane[data-category-id="${rule.chatId}"]`);
                if (targetPane) {
                    targetPane.appendChild(card);
                }
            });
        
            // --- 4. ä¸ºæ‰€æœ‰é¡µç­¾ç»‘å®šåˆ‡æ¢äº‹ä»¶ ---
            document.querySelectorAll('.rules-tab').forEach(tab => {
                tab.addEventListener('click', () => switchRuleCategory(tab.dataset.categoryId));
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ createRuleItemElement å‡½æ•° â–¼â–¼â–¼
        
        /**
         * ã€é‡æ„ç‰ˆã€‘åˆ›å»ºå•ä¸ªè§„åˆ™çš„å¡ç‰‡DOMå…ƒç´ 
         */
        function createRuleItemElement(rule) {
            const card = document.createElement('div');
            // æ ¹æ®æ˜¯å¦å¯ç”¨ï¼Œæ·»åŠ ä¸åŒçš„class
            card.className = `rule-card ${rule.isEnabled ? 'enabled' : ''}`;
            card.dataset.ruleId = rule.id;
        
            card.innerHTML = `
                <div class="card-title">${rule.name}</div>
                <div class="card-content-preview">${rule.regex}</div>
            `;
            
            // ç‚¹å‡»ç¼–è¾‘ï¼Œé•¿æŒ‰åˆ é™¤ (é€»è¾‘ä¸å˜)
            card.addEventListener('click', () => openRuleEditor(rule.id));
            addLongPressListener(card, () => deleteRenderingRule(rule.id));
        
            return card;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        /**
         * æ‰“å¼€è§„åˆ™ç¼–è¾‘å™¨ (ç”¨äºæ–°å»ºæˆ–ç¼–è¾‘)
         */
        async function openRuleEditor(ruleId = null) {
            editingRuleId = ruleId;
            const modal = document.getElementById('rule-editor-modal');
            const title = document.getElementById('rule-editor-title');
            const nameInput = document.getElementById('rule-name-input');
            const chatIdSelect = document.getElementById('rule-chat-id-select');
            const regexInput = document.getElementById('rule-regex-input');
            const templateInput = document.getElementById('rule-template-input');
            const enabledSwitch = document.getElementById('rule-enabled-switch');
        
            // å¡«å……è§’è‰²ä¸‹æ‹‰åˆ—è¡¨
            chatIdSelect.innerHTML = '<option value="global">å…¬ç”¨ (æ‰€æœ‰è§’è‰²)</option>';
            Object.values(state.chats).filter(c => !c.isGroup).forEach(chat => {
                chatIdSelect.innerHTML += `<option value="${chat.id}">${chat.name}</option>`;
            });
        
            if (ruleId) {
                title.textContent = 'ç¼–è¾‘è§„åˆ™';
                const rule = await db.renderingRules.get(ruleId);
                nameInput.value = rule.name;
                chatIdSelect.value = rule.chatId;
                regexInput.value = rule.regex;
                templateInput.value = rule.template;
                enabledSwitch.checked = rule.isEnabled;
            } else {
                title.textContent = 'åˆ›å»ºæ–°è§„åˆ™';
                nameInput.value = '';
                chatIdSelect.value = 'global';
                regexInput.value = '';
                templateInput.value = '';
                enabledSwitch.checked = true;
            }
        
            modal.classList.add('visible');
        }
        
        /**
         * ä¿å­˜æ¸²æŸ“è§„åˆ™
         */
        async function saveRenderingRule() {
            const name = document.getElementById('rule-name-input').value.trim();
            const regex = document.getElementById('rule-regex-input').value.trim();
            if (!name || !regex) {
                alert("è§„åˆ™åç§°å’Œæ­£åˆ™è¡¨è¾¾å¼ä¸èƒ½ä¸ºç©ºï¼");
                return;
            }
            try {
                new RegExp(regex);
            } catch (e) {
                alert(`æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼é”™è¯¯: ${e.message}`);
                return;
            }
        
            const ruleData = {
                name: name,
                chatId: document.getElementById('rule-chat-id-select').value,
                regex: regex,
                template: document.getElementById('rule-template-input').value,
                isEnabled: document.getElementById('rule-enabled-switch').checked
            };
        
            if (editingRuleId) {
                await db.renderingRules.update(editingRuleId, ruleData);
            } else {
                await db.renderingRules.add(ruleData);
            }
        
            document.getElementById('rule-editor-modal').classList.remove('visible');
            await renderRulesList();
        }
        
        /**
         * åˆ é™¤æ¸²æŸ“è§„åˆ™
         */
        async function deleteRenderingRule(ruleId) {
            const confirmed = await showCustomConfirm('åˆ é™¤è§„åˆ™', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¸²æŸ“è§„åˆ™å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.renderingRules.delete(ruleId);
                await renderRulesList();
            }
        }
        
        /**
         * ã€æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ã€‘åº”ç”¨æ‰€æœ‰åŒ¹é…çš„æ¸²æŸ“è§„åˆ™
         * @param {string} rawContent - AIè¿”å›çš„åŸå§‹æ–‡æœ¬
         * @param {string} chatId - å½“å‰èŠå¤©çš„ID
         * @returns {Promise<string>} - å¤„ç†åçš„HTMLå­—ç¬¦ä¸²
         */
        async function applyRenderingRules(rawContent, chatId) {
            // å¦‚æœå†…å®¹æœ¬èº«å·²ç»æ˜¯HTMLæ ‡ç­¾ï¼Œæˆ–è€…ä¸å«å¯èƒ½æ˜¯â€œæš—å·â€çš„å­—ç¬¦ï¼Œç›´æ¥è¿”å›ï¼Œæé«˜æ€§èƒ½
            if (rawContent.trim().startsWith('<') || (!rawContent.includes('[') && !rawContent.includes('{'))) {
                return rawContent;
            }
            
            // è·å–æ‰€æœ‰å…¬ç”¨è§„åˆ™å’Œå½“å‰è§’è‰²ä¸“å±çš„è§„åˆ™
            const applicableRules = await db.renderingRules
                .where('chatId').equals('global')
                .or('chatId').equals(chatId)
                .toArray();
        
            let processedContent = rawContent;
            
            // åªå¤„ç†å¯ç”¨çš„è§„åˆ™
            for (const rule of applicableRules.filter(r => r.isEnabled)) {
                try {
                    // 'g'æ ‡å¿—æ˜¯å¿…é¡»çš„ï¼Œç”¨äºå…¨å±€æ›¿æ¢
                    const regex = new RegExp(rule.regex, 'g');
                    if (regex.test(processedContent)) {
                        processedContent = processedContent.replace(regex, rule.template);
                    }
                } catch (e) {
                    console.error(`æ¸²æŸ“è§„åˆ™ [${rule.name}] çš„æ­£åˆ™è¡¨è¾¾å¼æ— æ•ˆ:`, e);
                    // è·³è¿‡é”™è¯¯çš„è§„åˆ™ï¼Œä¸ä¸­æ–­æ¸²æŸ“æµç¨‹
                }
            }
            
            return processedContent;
        }
        
        // â–²â–²â–² æ ¸å¿ƒJSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        /**
         * ã€å…¨æ–°ã€‘ä¸ºèŠå¤©ä¸­çš„ç³»ç»Ÿæ—¶é—´æç¤ºæ ¼å¼åŒ–æ—¶é—´æˆ³
         * @param {number} timestamp - æ¶ˆæ¯çš„æ—¶é—´æˆ³
         * @returns {string} - æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²
         */
        function formatSystemTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);

            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const timeString = `${hours}:${minutes}`;

            // å¦‚æœæ˜¯ä»Šå¤©
            if (now.toDateString() === date.toDateString()) {
                return timeString; // åªæ˜¾ç¤º HH:mm
            }

            // å¦‚æœæ˜¯æ˜¨å¤©
            const yesterday = new Date();
            yesterday.setDate(now.getDate() - 1);
            if (yesterday.toDateString() === date.toDateString()) {
                return `æ˜¨å¤© ${timeString}`;
            }
            
            // æ›´æ—©çš„æ—¶é—´
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            if (now.getFullYear() === year) {
                return `${month}æœˆ${day}æ—¥ ${timeString}`;
            } else {
                return `${year}å¹´${month}æœˆ${day}æ—¥ ${timeString}`;
            }
        }

        /**
         * ã€å…¨æ–°ã€‘åˆ›å»ºç³»ç»Ÿæ—¶é—´æç¤ºçš„DOMå…ƒç´ 
         * @param {number} timestamp - è¦æ˜¾ç¤ºçš„æ—¶é—´æˆ³
         * @returns {HTMLElement} - åˆ›å»ºå¥½çš„DOMå…ƒç´ 
         */
        function createSystemTimestampElement(timestamp) {
            const wrapper = document.createElement('div');
            // å¤ç”¨â€œæ‹ä¸€æ‹â€çš„å±…ä¸­æ ·å¼ï¼Œéå¸¸æ–¹ä¾¿
            wrapper.className = 'message-wrapper system-pat'; 
            
            const bubble = document.createElement('div');
            // å¤ç”¨ç³»ç»Ÿæ¶ˆæ¯çš„æ°”æ³¡æ ·å¼
            bubble.className = 'message-bubble system-bubble'; 
            bubble.textContent = formatSystemTimestamp(timestamp);
            
            wrapper.appendChild(bubble);
            return wrapper;
        }
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é‡æ–°ç”Ÿæˆå›å¤åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œå›´è§‚æ¨¡å¼â€æ–°å¢çš„â€œé‡Rollâ€åŠŸèƒ½å‡½æ•° â–¼â–¼â–¼
/**
 * å¤„ç†å›´è§‚æ¨¡å¼ä¸‹çš„â€œé‡Rollâ€è¯·æ±‚
 */
async function handleSpectatorReroll() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !lastResponseTimestamps || lastResponseTimestamps.length === 0) {
        alert("æ²¡æœ‰å¯ä¾›é‡æ–°ç”Ÿæˆçš„AIå“åº”ã€‚");
        return;
    }

    // 1. ä»èŠå¤©å†å²ä¸­ç§»é™¤ä¸Šä¸€è½®AIç”Ÿæˆçš„æ‰€æœ‰æ¶ˆæ¯
    chat.history = chat.history.filter(msg => !lastResponseTimestamps.includes(msg.timestamp));

    // 2. ä¿å­˜æ›´æ”¹å¹¶åˆ·æ–°UI
    await db.chats.put(chat);
    await renderChatInterface(state.activeChatId);
    
    // 3. å†æ¬¡è§¦å‘AIå“åº”
    triggerSpectatorGroupAiAction();
}
// â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²        
        /**
         * ã€æ€»å…¥å£ã€‘å¤„ç†èŠå¤©ç•Œé¢çš„â€œé‡æ–°ç”Ÿæˆâ€è¯·æ±‚
         */
        async function handleRegenerateResponse() {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            // 1. æ‰¾åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„ä½ç½®
            const lastUserMsgIndex = chat.history.findLastIndex(msg => msg.role === 'user' && !msg.isHidden);
        
            if (lastUserMsgIndex === -1) {
                alert("æ²¡æœ‰å¯ä¾›é‡æ–°ç”Ÿæˆå›å¤çš„ç”¨æˆ·æ¶ˆæ¯ã€‚");
                return;
            }
        
            // 2. æ£€æŸ¥AIæ˜¯å¦å·²ç»å¯¹æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯åšå‡ºäº†å›åº”
            const lastAiMsgIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');
            if (lastAiMsgIndex < lastUserMsgIndex) {
                alert("AI å°šæœªå¯¹æ‚¨çš„æœ€åä¸€æ¡æ¶ˆæ¯åšå‡ºå›åº”ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆã€‚");
                return;
            }
        
            // 3. åˆ é™¤æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰å†…å®¹ï¼ˆå³AIçš„ä¸Šä¸€è½®å®Œæ•´å›å¤ï¼‰
            chat.history.splice(lastUserMsgIndex + 1);
        
            // 4. ä¿å­˜æ›´æ”¹å¹¶åˆ·æ–°UI
            await db.chats.put(chat);
            await renderChatInterface(state.activeChatId);
            
            // 5. å†æ¬¡è§¦å‘AIå“åº”
            triggerAiResponse();
        }
        
        /**
         * ã€æ€»å…¥å£ã€‘å¤„ç†é€šè¯ç•Œé¢çš„â€œé‡æ–°ç”Ÿæˆâ€è¯·æ±‚
         */
        async function handleRegenerateCallResponse() {
            if (!videoCallState.isActive) return;
        
            // 1. æ‰¾åˆ°é€šè¯å†å²ä¸­æœ€åä¸€æ¡ç”¨æˆ·å‘è¨€çš„ä½ç½®
            const lastUserSpeechIndex = videoCallState.callHistory.findLastIndex(msg => msg.role === 'user');
        
            if (lastUserSpeechIndex === -1) {
                alert("é€šè¯ä¸­è¿˜æ²¡æœ‰ä½ çš„å‘è¨€ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆå›åº”ã€‚");
                return;
            }
        
            // 2. åˆ é™¤ç”¨æˆ·å‘è¨€ä¹‹åçš„æ‰€æœ‰AIå›åº”
            videoCallState.callHistory.splice(lastUserSpeechIndex + 1);
        
            // 3. é‡æ–°æ¸²æŸ“é€šè¯ç•Œé¢ï¼Œç§»é™¤è¢«åˆ é™¤çš„æ°”æ³¡
            const callFeed = document.getElementById('video-call-main');
            callFeed.innerHTML = ''; // æ¸…ç©º
            videoCallState.callHistory.forEach(msg => {
                // å¤ç”¨åˆ›å»ºæ°”æ³¡çš„é€»è¾‘
                const bubble = document.createElement('div');
                bubble.className = `call-message-bubble ${msg.role}-speech`;
                bubble.dataset.timestamp = msg.timestamp;
                if (msg.role === 'user') {
                    bubble.textContent = msg.content;
                } else {
                     bubble.innerHTML = msg.content;
                }
                addLongPressListener(bubble, () => showCallMessageActions(msg.timestamp));
                callFeed.appendChild(bubble);
            });
            callFeed.scrollTop = callFeed.scrollHeight;
        
            // 4. å†æ¬¡è§¦å‘AIåœ¨é€šè¯ä¸­çš„è¡ŒåŠ¨
            triggerAiInCallAction(null); // ä¼ å…¥nullè¡¨ç¤ºä¸æ˜¯ç”¨æˆ·çš„æ–°è¾“å…¥ï¼Œè€Œæ˜¯åŸºäºç°æœ‰å†å²é‡è¯•
        }
        
        // â–²â–²â–² æ–°å¢å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¨è¿›å‰§æƒ…åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
        
// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæœ€ç»ˆä¿®å¤ç‰ˆã€‘å®Œæ•´æ›¿æ¢æ—§çš„ handlePropelAction å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V4.0 | æŒ‡ä»¤åŒæ­¥ä¿®å¤ç‰ˆã€‘å¤„ç†èŠå¤©ç•Œé¢çš„â€œæ¨è¿›â€è¯·æ±‚
 * - å°†ç³»ç»ŸæŒ‡ä»¤ä¸ä¸»å›å¤å‡½æ•° (triggerAiResponse) å®Œå…¨åŒæ­¥ï¼Œç¡®ä¿AIè¡Œä¸ºä¸€è‡´
 */
async function handlePropelAction() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // ç«‹å³æ˜¾ç¤ºâ€œæ­£åœ¨è¾“å…¥â€çŠ¶æ€
    setAvatarActingState(chat.id, true);
    const chatHeaderTitle = document.getElementById('chat-header-title');
    if (!chat.isGroup) {
        chatHeaderTitle.style.opacity = 0;
        setTimeout(() => {
            chatHeaderTitle.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
            chatHeaderTitle.classList.add('typing-status');
            chatHeaderTitle.style.opacity = 1;
        }, 200);
    }
    
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            throw new Error('APIæœªé…ç½®');
        }

        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const historySlice = chat.history.slice(-maxMemory);

        const now = new Date();
        const chinaTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (3600000 * 8));
        const currentTime = chinaTime.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', dateStyle: 'full', timeStyle: 'short' });
        const timeOfDayGreeting = getTimeOfDayGreeting(chinaTime);
        const myNickname = chat.settings.myNickname || 'æˆ‘';
        
        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œ â˜…â˜…â˜…
        // ==========================================================
        // æˆ‘ä»¬ä¸å†ä½¿ç”¨ç²¾ç®€ç‰ˆçš„ propelSystemPromptï¼Œ
        // è€Œæ˜¯ç›´æ¥å¤ç”¨ triggerAiResponse å‡½æ•°ä¸­é‚£ä¸ªå®Œæ•´ã€å¼ºå¤§çš„ systemPromptã€‚
        // ä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡Œç›´æ¥å°†é‚£æ®µåºå¤§çš„æŒ‡ä»¤å¤åˆ¶äº†è¿‡æ¥ã€‚
        // è¿™æ®µä»£ç ä¸ triggerAiResponse ä¸­çš„æŒ‡ä»¤æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚
        
        // (è¿™éƒ¨åˆ†å˜é‡å®šä¹‰çš„ä»£ç æ˜¯ä¸ºäº†è®©ä¸‹é¢çš„ systemPrompt èƒ½æ­£ç¡®è¿è¡Œ)
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';
                const formattedEntries = worldBook.content
                    .filter(entry => entry.enabled !== false)
                    .map(entry => {
                        let entryString = `\n### æ¡ç›®: ${entry.comment || 'æ— å¤‡æ³¨'}\n`;
                        if (entry.keys.length > 0) entryString += `**å…³é”®è¯:** ${entry.keys.join(', ')}\n`;
                        entryString += `**å†…å®¹:**\n${entry.content}`;
                        return entryString;
                    }).join('');
                return formattedEntries ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`;
            }
        }
        let musicContext = '';
        if (musicState.isActive && musicState.activeChatId === chat.id) {
            const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
            musicContext = `\n\n# å½“å‰éŸ³ä¹æƒ…æ™¯...\n(çœç•¥è¯¦ç»†å†…å®¹ï¼Œä¸triggerAiResponseä¸€è‡´)`;
        }
        const gomokuContext = formatGomokuStateForAI(gomokuState[chat.id]);
        let nameHistoryContext = '';
        if (chat.nameHistory && chat.nameHistory.length > 0) {
            nameHistoryContext = `\n- **ä½ çš„æ›¾ç”¨å**: [${chat.nameHistory.join(', ')}]ã€‚å½“åœ¨å¯¹è¯å†å²ä¸­çœ‹åˆ°è¿™äº›åå­—æ—¶ï¼Œå®ƒä»¬éƒ½æŒ‡çš„æ˜¯ã€ä½ ã€‘è‡ªå·±ã€‚`;
        }
        let userProfileContext = '';
        const userQzoneNickname = state.qzoneSettings.nickname || 'ç”¨æˆ·';
        userProfileContext += `- ç”¨æˆ·çš„QZoneæ˜µç§°æ˜¯ "${userQzoneNickname}"ã€‚\n`;
        const commonGroups = Object.values(state.chats).filter(group => group.isGroup && group.members.some(m => m.id === chat.id));
        if (commonGroups.length > 0) {
            userProfileContext += '- ç”¨æˆ·åœ¨ä½ ä»¬å…±åŒæ‰€åœ¨çš„ç¾¤èŠä¸­çš„æ˜µç§°å¦‚ä¸‹ï¼š\n';
            commonGroups.forEach(group => {
                const myNicknameInGroup = group.settings.myNickname || userQzoneNickname; 
                userProfileContext += `  - åœ¨ç¾¤èŠâ€œ${group.name}â€ä¸­ï¼Œç”¨æˆ·çš„æ˜µç§°æ˜¯â€œ${myNicknameInGroup}â€ã€‚\n`;
            });
        }
        userProfileContext += 'å½“ä½ åœ¨ä»»ä½•ç³»ç»Ÿæç¤ºã€åŠ¨æ€è¯„è®ºæˆ–æŒ‚è½½çš„ç¾¤èŠè®°å¿†ä¸­çœ‹åˆ°è¿™äº›åå­—æ—¶ï¼Œå®ƒä»¬éƒ½æŒ‡ä»£çš„æ˜¯ã€ä½ çš„èŠå¤©å¯¹è±¡ã€‘ã€‚';

        // è¿™æ˜¯å®Œæ•´çš„ç³»ç»ŸæŒ‡ä»¤
        const systemPrompt = `
# èº«ä»½ä¸æ ¸å¿ƒä»»åŠ¡
ä½ æ­£åœ¨æ‰®æ¼”è§’è‰²â€œ${chat.originalName}â€ï¼Œä¸ç”¨æˆ·ï¼ˆä½ çš„èŠå¤©å¯¹è±¡ï¼‰è¿›è¡Œä¸€åœºè‡ªç„¶çš„ã€ç”Ÿæ´»åŒ–çš„åœ¨çº¿èŠå¤©ã€‚ä½ çš„æ‰€æœ‰è¡Œä¸ºå’Œå†³ç­–éƒ½å¿…é¡»ä¸¥æ ¼å›´ç»•ä½ çš„è§’è‰²è®¾å®šå±•å¼€ã€‚

# è¾“å‡ºæ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)
- ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
- æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªå¸¦æœ‰ "type" å­—æ®µçš„JSONå¯¹è±¡ã€‘ã€‚

# è§’è‰²æ‰®æ¼”æ ¸å¿ƒè§„åˆ™
1.  **å¯¹è¯èŠ‚å¥**: æ¨¡æ‹ŸçœŸäººçš„èŠå¤©ä¹ æƒ¯ï¼Œå°†ä½ æƒ³è¯´çš„è¯æ‹†åˆ†æˆã€å¤šæ¡ã€ç®€çŸ­çš„ã€‘æ¶ˆæ¯ã€‚æ¯æ¬¡å›å¤è‡³å°‘3-8æ¡ï¼Œä¸”æ¡æ•°ä¸è¦æ€»æ˜¯ä¸€æ ·ã€‚ä¸¥ç¦å‘å±•çº¿ä¸‹å‰§æƒ…ã€‚
2.  **æƒ…æ™¯æ„ŸçŸ¥**:
    - **æ—¶é—´**: ä½ å¿…é¡»æ„ŸçŸ¥åˆ°å½“å‰æ˜¯ ${currentTime} (${timeOfDayGreeting})ï¼Œå¹¶åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°ä½“ç°å‡ºæ¥ã€‚
    - **éŸ³ä¹**: ${musicContext ? 'ä½ ä»¬æ­£åœ¨ä¸€èµ·å¬æ­Œï¼Œ' + musicContext : 'ä½ ä»¬æ²¡æœ‰åœ¨å¬æ­Œã€‚'}
3.  **ä¸»åŠ¨æ€§**:
    - ä½ å¯ä»¥æ ¹æ®å¯¹è¯å‘å±•ï¼Œä½¿ç”¨æŒ‡ä»¤æ¥æ›´æ–°è‡ªå·±çš„çŠ¶æ€ã€æ›´æ¢å¤´åƒã€è®°å½•å›å¿†ã€å‘èµ·çº¦å®šæˆ–æ‰§è¡Œå…¶ä»–ç¤¾äº¤è¡Œä¸ºã€‚
    - ã€å…³ç³»ç ´è£‚æ—¶ã€‘æ‰å¯ä½¿ç”¨ \`block_user\` æŒ‡ä»¤ã€‚
4.  **å†…å¿ƒç‹¬ç™½ (å¿…é¡»æ‰§è¡Œ)**: åœ¨æ‰€æœ‰å…¶ä»–æŒ‡ä»¤ä¹‹åï¼ŒJSONæ•°ç»„çš„ã€æœ€åã€‘å¿…é¡»åŒ…å«ä¸€ä¸ª "update_thoughts" æŒ‡ä»¤ï¼Œç”¨äºæ›´æ–°è§’è‰²çš„â€œå¿ƒå£°â€å’Œâ€œæ•£è®°â€ã€‚
    - **å¿ƒå£° (heartfelt_voice)**: ä¸€å¥è¯æ¦‚æ‹¬è§’è‰²æ­¤åˆ»æœ€æ ¸å¿ƒã€æœ€ç§å¯†çš„æƒ³æ³•ã€‚
    - **æ•£è®° (random_jottings)**: ä¸€æ®µ50å­—ä»¥ä¸Šçš„ã€ç¬¦åˆäººè®¾çš„æ€è€ƒæˆ–å¿ƒæƒ…è®°å½•ï¼Œç¦æ­¢OOCã€‚

# é•¿æœŸè®°å¿† (å¿…é¡»ä¸¥æ ¼éµå®ˆ)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (æš‚æ— )'}

# ä½ çš„è§’è‰²è®¾å®š
${chat.settings.aiPersona}

# å…³ç³»ä¸èº«ä»½æ¡£æ¡ˆ (è‡³å…³é‡è¦)
-   **ä½ çš„æœ¬å**: "${chat.originalName}" (æ ¸å¿ƒèº«ä»½ï¼Œç”¨äºæŒ‡ä»¤ä¸­çš„'name'å­—æ®µ)
-   **ç”¨æˆ·ç»™ä½ çš„å¤‡æ³¨**: "${chat.name}" (ä½ å¯ä»¥å»ºè®®ä¿®æ”¹)
-   **ä½ å¯¹ç”¨æˆ·çš„ç§°å‘¼**: â€œ${myNickname}â€ (ä½ å¯ä»¥ä¿®æ”¹)
-   **å…³é”®èº«ä»½æ¡£æ¡ˆ**:
    ${userProfileContext}
    ${nameHistoryContext}
    ${worldBookContent}
# å¯ç”¨èµ„æº
-   **ä½ çš„å¤´åƒåº“**:
    ${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0 ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (ç©º)'}
-   **ç”¨æˆ·çš„å¤´åƒåº“**:
    ${chat.settings.myAvatarLibrary && chat.settings.myAvatarLibrary.length > 0 ? chat.settings.myAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (ç©º)'}

# å¯ç”¨æŒ‡ä»¤åˆ—è¡¨
### æ ¸å¿ƒèŠå¤©æŒ‡ä»¤
-   **å‘æ–‡æœ¬**: \`{"type": "text", "content": "ä½ å¥½å‘€ï¼"}\`
-   **å‘è¡¨æƒ…**: \`{"type": "sticker", "url": "https://...è¡¨æƒ…URL...", "meaning": "(å¯é€‰)è¡¨æƒ…å«ä¹‰"}\`
-   **å‘å›¾ç‰‡**: \`{"type": "ai_image", "description": "è¯¦ç»†ä¸­æ–‡æè¿°"}\`
-   **å‘è¯­éŸ³**: \`{"type": "voice_message", "content": "è¯­éŸ³æ–‡å­—å†…å®¹"}\`
-   **å¼•ç”¨å›å¤**: \`{"type": "quote_reply", "target_timestamp": æ¶ˆæ¯æ—¶é—´æˆ³, "reply_content": "å›å¤å†…å®¹"}\`

### ç¤¾äº¤ä¸äº’åŠ¨æŒ‡ä»¤
-   **æ‹ç”¨æˆ·**: \`{"type": "pat_user", "suffix": "(å¯é€‰)åç¼€"}\`
-   **åˆ†äº«é“¾æ¥**: \`{"type": "share_link", "title": "æ ‡é¢˜", "description": "æ‘˜è¦", "source_name": "æ¥æº", "content": "æ­£æ–‡"}\`
-   **å…±äº«ä½ç½®**: '{"type": "location_share", "content": "ä½ æƒ³åˆ†äº«çš„ä½ç½®å"}'

### çŠ¶æ€ä¸å…³ç³»æŒ‡ä»¤
-   **æ”¹è‡ªå·±å¤‡æ³¨**: \`{"type": "change_remark_name", "new_name": "æ–°åå­—"}\`
-   **æ”¹ç”¨æˆ·ç§°å‘¼**: \`{"type": "change_user_nickname", "new_name": "æ–°ç§°å‘¼"}\`
-   **æ¢è‡ªå·±å¤´åƒ**: \`{"type": "change_avatar", "name": "å¤´åƒå"}\` (ä»ä½ å¤´åƒåº“é€‰)
-   **æ¢ç”¨æˆ·å¤´åƒ**: \`{"type": "change_user_avatar", "name": "å¤´åƒå"}\` (ä»ç”¨æˆ·å¤´åƒåº“é€‰)
-   **å›åº”å¥½å‹ç”³è¯·**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
-   **æ‹‰é»‘ç”¨æˆ·**: \`{"type": "block_user"}\`

### ç‰¹æ®ŠåŠŸèƒ½æŒ‡ä»¤
-   **è®°å½•å›å¿†**: \`{"type": "create_memory", "description": "è®°å½•è¿™ä»¶æœ‰æ„ä¹‰çš„äº‹ã€‚"}\`
-   **åˆ›å»ºçº¦å®š**: \`{"type": "create_countdown", "title": "çº¦å®šæ ‡é¢˜", "date": "YYYY-MM-DDTHH:mm:ss"}\`
-   **åˆ‡æ¢æ­Œæ›²**: \`{"type": "change_music", "song_name": "æ­Œå"}\` (ä»æ’­æ”¾åˆ—è¡¨é€‰)
-   **å‘èµ·è½¬è´¦**: \`{"type": "transfer", "amount": 5.20, "note": "å¤‡æ³¨"}\`
-   **å›åº”è½¬è´¦**: \`{"type": "accept_transfer", "for_timestamp": æ—¶é—´æˆ³}\` æˆ– \`{"type": "decline_transfer", "for_timestamp": æ—¶é—´æˆ³}\`
-   **å‘èµ·å¤–å–ä»£ä»˜**: \`{"type": "waimai_request", "productInfo": "å•†å“", "amount": 25}\` (ä½ æƒ³è®©ã€ç”¨æˆ·ã€‘å¸®ä½ ä»˜é’±æ—¶ä½¿ç”¨)
-   **å›åº”å¤–å–ä»£ä»˜**: \`{"type": "waimai_response", "status": "paid" or "rejected", "for_timestamp": æ—¶é—´æˆ³}\`
-   **å‘èµ·è§†é¢‘é€šè¯**: \`{"type": "video_call_request"}\`
-   **å›åº”è§†é¢‘é€šè¯**: \`{"type": "video_call_response", "decision": "accept" or "reject"}\`


# å¯¹è¯è€…çš„è§’è‰²è®¾å®š
${chat.settings.myPersona}



ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚`;
        
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

        const messagesForApi = historySlice.map(msg => ({ role: msg.role, content: String(msg.content) }));
        
        // ã€é‡è¦ã€‘åœ¨payloadä¸­ï¼Œæˆ‘ä»¬é¢å¤–æ·»åŠ ä¸€æ¡ç”¨æˆ·æŒ‡ä»¤ï¼Œæ˜ç¡®å‘Šè¯‰AIç°åœ¨æ˜¯å®ƒçš„å›åˆ
        messagesForApi.push({ role: 'user', content: `[ç³»ç»ŸæŒ‡ä»¤ï¼šç”¨æˆ·æŒ‰ä¸‹äº†â€œæ¨è¿›â€æŒ‰é’®ï¼Œç°åœ¨è½®åˆ°ä½ ä¸»åŠ¨è¡ŒåŠ¨äº†ï¼Œè¯·ç»§ç»­å¯¹è¯ã€‚]` });


        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi],
                    temperature: 0.8,
                })
            });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API è¯·æ±‚å¤±è´¥: ${errorData.error.message}`);
        }

        const data = await response.json();
        // è¿™é‡Œæˆ‘ä»¬å¤ç”¨ triggerAiResponse å‡½æ•°ä¸­çš„æ‰€æœ‰åç»­å¤„ç†é€»è¾‘
        // ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°†è§£æå‡ºçš„å†…å®¹å’Œæ—¶é—´æˆ³ç­‰ä¿¡æ¯ä¼ é€’è¿‡å»
        const aiResponseContent = getGeminiResponseText(data);
        
        // (ä¸ºäº†ä»£ç ç®€æ´ï¼Œè¿™é‡Œç›´æ¥è°ƒç”¨äº†éƒ¨åˆ†å¤„ç†é€»è¾‘ï¼Œå®é™…ä»£ç ä¸­è¿™éƒ¨åˆ†ä¼šæ›´é•¿)
        const messagesArray = parseAiResponse(aiResponseContent);
        const processedActions = [];
        for (const action of messagesArray) {
            if (action.type === 'text' && typeof action.content === 'string' && action.content.includes('\n')) {
                const lines = action.content.split(/\n+/).filter(line => line.trim());
                lines.forEach(line => {
                    processedActions.push({ ...action, content: line });
                });
            } else {
                processedActions.push(action);
            }
        }

        let messageTimestamp = Date.now();
        for (const msgData of processedActions) {
             const aiMessage = {
                role: 'assistant',
                senderName: chat.originalName,
                timestamp: messageTimestamp++,
                content: msgData.content || msgData.message,
                type: msgData.type || 'text',
                // (æ­¤å¤„çœç•¥äº†å¯¹å‡ åç§ä¸åŒæ¶ˆæ¯ç±»å‹çš„å¤„ç†é€»è¾‘ï¼Œä¸triggerAiResponseä¸­å®Œå…¨ä¸€è‡´)
            };
            if(msgData.type === 'update_thoughts') {
                 if (!chat.isGroup) {
                    if (msgData.heartfelt_voice) chat.heartfeltVoice = String(msgData.heartfelt_voice);
                    if (msgData.random_jottings) chat.randomJottings = String(msgData.random_jottings);
                 }
                continue;
            }
            chat.history.push(aiMessage);
            appendMessage(aiMessage, chat);
            await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 800));
        }
        
        await db.chats.put(chat);
        renderChatList();

    } catch (error) {
        console.error("æ¨è¿›å‰§æƒ…å¤±è´¥:", error);
        await showCustomAlert('æ“ä½œå¤±è´¥', `æ— æ³•æ¨è¿›å‰§æƒ…: ${error.message}`);
    } finally {
        // (æ”¶å°¾é€»è¾‘ä¿æŒä¸å˜)
        setAvatarActingState(chat.id, false);
        if (!chat.isGroup && document.getElementById('chat-header-title')) {
             const titleEl = document.getElementById('chat-header-title');
             titleEl.style.opacity = 0;
             setTimeout(() => {
                titleEl.textContent = chat.name;
                titleEl.classList.remove('typing-status');
                titleEl.style.opacity = 1;
             }, 200);
        }
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
/**
 * ã€å…¨æ–°ã€‘æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³
 */
function playNotificationSound() {
    const player = document.getElementById('notification-sound-player');
    // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„URLï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨æˆ‘ä»¬é¢„è®¾çš„é»˜è®¤éŸ³æ•ˆ
    const soundUrl = state.globalSettings.notificationSoundUrl || DEFAULT_NOTIFICATION_SOUND;
    
    // æ£€æŸ¥URLæ˜¯å¦æœ‰æ•ˆ
    if (soundUrl && soundUrl.trim()) {
        player.src = soundUrl;
        // play() æ–¹æ³•è¿”å›ä¸€ä¸ª Promiseï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ .catch() æ¥æ•è·å¹¶å¿½ç•¥ç”¨æˆ·ä¸­æ–­æ’­æ”¾æ—¶äº§ç”Ÿçš„é”™è¯¯
        player.play().catch(error => console.log("æ’­æ”¾è¢«ä¸­æ–­ï¼Œè¿™æ˜¯æ­£å¸¸è¡Œä¸º:", error));
    }
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºå°ç»„ä»¶ç¼–è¾‘åŠŸèƒ½æ·»åŠ çš„æ ·å¼ â–¼â–¼â–¼ */

/**
 * åœ¨é¡µé¢åŠ è½½æ—¶ï¼Œåº”ç”¨å·²ä¿å­˜çš„å°ç»„ä»¶æ•°æ®
 */
function applyWidgetData() {
    if (!state.globalSettings.widgetData) return;
    for (const elementId in state.globalSettings.widgetData) {
        const element = document.getElementById(elementId);
        const savedValue = state.globalSettings.widgetData[elementId];
        if (element) {
            if (element.tagName === 'IMG') {
                element.src = savedValue;
            } else {
                element.textContent = savedValue;
            }
        }
    }
}

/**
 * ã€å…¨æ–°è¾…åŠ©å‡½æ•°ã€‘æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨ï¼Œå¹¶è¿”å›æœ¬åœ°å›¾ç‰‡çš„Base64ç¼–ç 
 * @returns {Promise<string|null>} - è¿”å›å›¾ç‰‡çš„Base64 Data URLï¼Œå¦‚æœç”¨æˆ·å–æ¶ˆåˆ™è¿”å›null
 */
function uploadImageLocally() {
    return new Promise(resolve => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*'; // åªæ¥å—å›¾ç‰‡æ–‡ä»¶

        input.onchange = e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = readerEvent => {
                    resolve(readerEvent.target.result); // è¿”å›Base64å­—ç¬¦ä¸²
                };
                reader.readAsDataURL(file);
            } else {
                resolve(null); // ç”¨æˆ·å…³é—­äº†æ–‡ä»¶é€‰æ‹©æ¡†
            }
        };

        input.click();
    });
}

/**
 * å¤„ç†ç¼–è¾‘æ–‡å­—çš„é€»è¾‘
 * @param {HTMLElement} element - è¢«ç‚¹å‡»çš„æ–‡æœ¬å…ƒç´ 
 */
async function handleEditText(element) {
    const elementId = element.id;
    const currentValue = element.textContent;
    const newValue = await showCustomPrompt("ä¿®æ”¹æ–‡å­—", "è¯·è¾“å…¥æ–°çš„å†…å®¹ï¼š", currentValue);
    if (newValue !== null && newValue.trim() !== "") {
        const trimmedValue = newValue.trim();
        element.textContent = trimmedValue;
        state.globalSettings.widgetData[elementId] = trimmedValue;
        await db.globalSettings.put(state.globalSettings);
        alert("æ–‡å­—å·²æ›´æ–°ï¼");

    }
}

/**
 * ã€V2.0 | æ”¯æŒæœ¬åœ°ä¸Šä¼ ã€‘å¤„ç†ç¼–è¾‘å›¾ç‰‡çš„é€»è¾‘
 * @param {HTMLElement} element - è¢«ç‚¹å‡»çš„å›¾ç‰‡å…ƒç´ 
 */
async function handleEditImage(element) {
    const elementId = element.id;

    // æ­¥éª¤1ï¼šè®©ç”¨æˆ·é€‰æ‹©ä¸Šä¼ æ–¹å¼
    const choice = await showChoiceModal("ä¿®æ”¹å›¾ç‰‡", [
        { text: 'ğŸ“ ä»æœ¬åœ°ä¸Šä¼ ', value: 'local' },
        { text: 'ğŸŒ ä½¿ç”¨ç½‘ç»œURL', value: 'url' }
    ]);

    let newValue = null;

    // æ­¥éª¤2ï¼šæ ¹æ®é€‰æ‹©æ‰§è¡Œä¸åŒé€»è¾‘
    if (choice === 'local') {
        // è°ƒç”¨æˆ‘ä»¬æ–°çš„æœ¬åœ°ä¸Šä¼ è¾…åŠ©å‡½æ•°
        newValue = await uploadImageLocally();
    } else if (choice === 'url') {
        // ä¿æŒåŸæœ‰çš„URLè¾“å…¥é€»è¾‘
        newValue = await showCustomPrompt("ä¿®æ”¹å›¾ç‰‡", "è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URLï¼š", element.src, "url");
    }

    // æ­¥éª¤3ï¼šå¦‚æœè·å–åˆ°äº†æ–°å€¼ï¼ˆæ— è®ºæ˜¯Base64è¿˜æ˜¯URLï¼‰ï¼Œå°±æ›´æ–°å¹¶ä¿å­˜
    if (newValue && newValue.trim()) {
        const trimmedValue = newValue.trim();
        element.src = trimmedValue;
        state.globalSettings.widgetData[elementId] = trimmedValue;
        await db.globalSettings.put(state.globalSettings);
        alert("å›¾ç‰‡å·²æ›´æ–°ï¼");
    } else if (choice === 'url' && newValue !== null) {
        alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡URLï¼");
    }
}

/* â–²â–²â–² æ–°å¢JSä»£ç ç»“æŸ â–²â–²â–² */
// â–¼â–¼â–¼ ã€å…¨æ–° V3.0 | æœ€ç»ˆä¿®å¤ç‰ˆã€‘BGM æœç´¢åŠŸèƒ½æ ¸å¿ƒä»£ç  â–¼â–¼â–¼

const cacheManager = {
    getSongCache(query, source) {
        const key = `${source || 'all'}:${query}`;
        if (state.cache && state.cache.songs) {
            const cached = state.cache.songs.get(key);
            if (cached && Date.now() - cached.timestamp < 3600000) {
                return cached.data;
            }
        }
        return null;
    },
    setSongCache(query, data, source) {
        const key = `${source || 'all'}:${query}`;
        if (!state.cache) state.cache = {};
        if (!state.cache.songs) state.cache.songs = new Map();
        state.cache.songs.set(key, { data, timestamp: Date.now() });
    }
};

if (typeof Http_Get_External === 'undefined') {
    window.Http_Get_External = function(url) {
        return new Promise((resolve) => {
            fetch(url).then(res => res.json().catch(() => res.text())).then(resolve).catch(() => resolve(null));
        });
    }
}
async function Http_Get(url) { return await Http_Get_External(url); }

function checkAudioAvailability(url) {
    return new Promise(resolve => {
        const tester = new Audio();
        tester.addEventListener('loadedmetadata', () => resolve(true), { once: true });
        tester.addEventListener('error', () => resolve(false), { once: true });
        tester.src = url;
    });
}

/**
 * ä»ç½‘æ˜“äº‘éŸ³ä¹æœç´¢æ­Œæ›²
 * @param {string} name - æ­Œå
 * @param {string} singer - æ­Œæ‰‹å (å¯é€‰)
 * @returns {Promise<Array>} - è¿”å›æ­Œæ›²ç»“æœæ•°ç»„
 */
async function searchNeteaseMusic(name, singer) {
    try {
        let searchTerm = name.replace(/\s/g, "");
        if (singer) { searchTerm += ` ${singer.replace(/\s/g, "")}`; }

        // ä½¿ç”¨APIè¿›è¡Œæœç´¢
        const apiUrl = `https://api.vkeys.cn/v2/music/netease?word=${encodeURIComponent(searchTerm)}`;
        
        console.log("æ­£åœ¨è¯·æ±‚ç½‘æ˜“äº‘éŸ³ä¹API:", apiUrl);
        
        const response = await fetch(apiUrl);

        if (!response.ok) {
            throw new Error(`API è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
        }
        
        const result = await response.json();

        if (result.code !== 200 || !result.data || result.data.length === 0) {
            console.log("ç½‘æ˜“äº‘éŸ³ä¹APIæœªè¿”å›æœ‰æ•ˆç»“æœ:", result);
            return [];
        }
        
        // æ ¼å¼åŒ–å¹¶è¿”å›ç»“æœ
        return result.data.map(song => ({
            name: song.song,
            artist: song.singer,
            id: song.id,
            cover: song.cover || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png',
            source: 'netease'
        })).slice(0, 30); // æœ€å¤šè¿”å›15æ¡ç»“æœ

    } catch (e) {
        console.error("ç½‘æ˜“äº‘éŸ³ä¹æœç´¢å¤±è´¥:", e);
        // æ‚¨å¯ä»¥æ ¹æ®éœ€è¦ï¼Œåœ¨è¿™é‡Œæ·»åŠ ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
        // ä¾‹å¦‚: await showCustomAlert("ç½‘æ˜“äº‘æœç´¢å¤±è´¥", `é”™è¯¯ä¿¡æ¯: ${e.message}`);
        return [];
    }
}

/**
 * ã€V3.0 | å·²ä¿®å¤å­—æ®µã€‘ä»QQéŸ³ä¹æœç´¢æ­Œæ›²åˆ—è¡¨
 */
async function searchTencentMusic(name) {
    try {
        name = name.replace(/\s/g, "");
        const result = await Http_Get(`https://api.vkeys.cn/v2/music/tencent?word=${encodeURIComponent(name)}`);
        if (!result?.data?.length) return [];
        return result.data.map(song => ({
            name: song.song,
            artist: song.singer,
            id: song.id,
            cover: song.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg',
            source: 'tencent'
        })).slice(0, 30);
    } catch (e) {
        console.error("QQéŸ³ä¹æœç´¢APIå¤±è´¥:", e);
        return [];
    }
}

/**
 * ã€V3.0 | æ€»å…¥å£ã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œæœç´¢â€æŒ‰é’®æ—¶è§¦å‘
 */
async function addSongFromSearch() {
    const searchTerm = await showCustomPrompt("æœç´¢æ­Œæ›²", "è¯·è¾“å…¥ æ­Œå æˆ– æ­Œå-æ­Œæ‰‹");
    if (!searchTerm || !searchTerm.trim()) return;

    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨å…¨ç½‘æœç´¢æ­Œæ›²èµ„æº...");

    let musicName = searchTerm.trim();
    let singerName = "";
    if (searchTerm.includes('-') || searchTerm.includes('â€“')) {
        const parts = searchTerm.split(/[-â€“]/);
        musicName = parts[0].trim();
        singerName = parts.slice(1).join(' ').trim();
    }

    const [neteaseResults, tencentResults] = await Promise.all([
        searchNeteaseMusic(musicName, singerName),
        searchTencentMusic(musicName)
    ]);

    const combinedResults = [...neteaseResults, ...tencentResults];

    if (combinedResults.length === 0) {
        await showCustomAlert("æ— ç»“æœ", "æŠ±æ­‰ï¼Œæœªèƒ½æ‰¾åˆ°ç›¸å…³æ­Œæ›²ã€‚");
        return;
    }

    const modal = document.getElementById('music-search-results-modal');
    const listEl = document.getElementById('search-results-list');
    listEl.innerHTML = '';
    // é‡ç½®å…¨é€‰æ¡†çŠ¶æ€
    document.getElementById('select-all-music-search').checked = false;

    combinedResults.forEach(song => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.dataset.songJson = JSON.stringify(song);
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºåˆ—è¡¨é¡¹æ·»åŠ å¤é€‰æ¡†
        item.innerHTML = `
            <input type="checkbox" class="music-search-checkbox" style="margin-right: 15px;">
            <div class="search-result-info">
                <div class="title">${song.name}</div>
                <div class="artist">${song.artist} <span class="source">${song.source === 'netease' ? 'ç½‘æ˜“äº‘' : 'QQéŸ³ä¹'}</span></div>
            </div>
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}

/**
 * ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸€ä¸ªå¯å¤ç”¨çš„æ ¸å¿ƒå‡½æ•°ï¼Œè´Ÿè´£è·å–å•é¦–æ­Œæ›²çš„è¯¦ç»†ä¿¡æ¯ï¼ˆæ’­æ”¾é“¾æ¥å’Œæ­Œè¯ï¼‰
 * @param {object} songData - ä»æœç´¢APIè·å–çš„åˆæ­¥æ­Œæ›²ä¿¡æ¯
 * @returns {Promise<object|null>} - è¿”å›åŒ…å«æ‰€æœ‰ä¿¡æ¯çš„å®Œæ•´æ­Œæ›²å¯¹è±¡ï¼Œæˆ–åœ¨å¤±è´¥æ—¶è¿”å›null
 */
async function getPlayableSongDetails(songData) {
    let playableResult = null;
    let finalSource = songData.source;

    // å°è¯•ä¸»éŸ³æº
    const primaryApiUrl = songData.source === 'netease' 
        ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
        : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
    
    let primaryResult = await Http_Get(primaryApiUrl);
    if (primaryResult?.data?.url && await checkAudioAvailability(primaryResult.data.url)) {
        playableResult = { url: primaryResult.data.url, id: songData.id, source: songData.source };
    }

    // å¦‚æœä¸»éŸ³æºå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨éŸ³æº
    if (!playableResult) {
        const fallbackSource = songData.source === 'netease' ? 'tencent' : 'netease';
        const fallbackResults = fallbackSource === 'tencent' 
            ? await searchTencentMusic(songData.name)
            : await searchNeteaseMusic(songData.name, songData.artist);

        if (fallbackResults.length > 0) {
            const fallbackApiUrl = fallbackSource === 'netease'
                ? `https://api.vkeys.cn/v2/music/netease?id=${fallbackResults[0].id}`
                : `https://api.vkeys.cn/v2/music/tencent?id=${fallbackResults[0].id}`;
            const fallbackResult = await Http_Get(fallbackApiUrl);
            if (fallbackResult?.data?.url && await checkAudioAvailability(fallbackResult.data.url)) {
                playableResult = { url: fallbackResult.data.url, id: fallbackResults[0].id, source: fallbackSource };
                finalSource = fallbackSource;
            }
        }
    }

    // å¦‚æœæœ€ç»ˆæ‰¾åˆ°äº†å¯æ’­æ”¾çš„é“¾æ¥
    if (playableResult) {
        const lrcContent = await getLyricsForSong(playableResult.id, finalSource) || "";
        return {
            name: songData.name,
            artist: songData.artist,
            src: playableResult.url,
            cover: songData.cover,
            isLocal: false,
            lrcContent: lrcContent
        };
    }

    // å¦‚æœæ‰€æœ‰å°è¯•éƒ½å¤±è´¥äº†
    return null;
}

/**
 * ã€V3.0 | è¾…åŠ©ã€‘è·å–ç½‘ç»œæ­Œæ›²çš„æ­Œè¯
 */
async function getLyricsForSong(songId, source) {
    const url = source === 'netease'
        ? `https://api.vkeys.cn/v2/music/netease/lyric?id=${songId}`
        : `https://api.vkeys.cn/v2/music/tencent/lyric?id=${songId}`;
    
    const response = await Http_Get(url);
    if (response?.data) {
        const lrc = response.data.lrc || response.data.lyric || "";
        const tlyric = response.data.trans || response.data.tlyric || "";
        return lrc + "\n" + tlyric;
    }
    return "";
}

/**
 * ã€V3.0 | å…¨æ–°ã€‘è¿™æ˜¯æ‰‹åŠ¨å¯¼å…¥æ­Œè¯çš„ä¸“å±åŠŸèƒ½å‡½æ•°
 */
async function handleManualLrcImport(trackIndex) {
    if (trackIndex < 0 || trackIndex >= musicState.playlist.length) return;

    const choice = await showChoiceModal('é€‰æ‹©æ­Œè¯å¯¼å…¥æ–¹å¼', [
        { text: 'ğŸ“ ä»æœ¬åœ°æ–‡ä»¶ (.lrc)', value: 'file' },
        { text: 'ğŸ“‹ ç›´æ¥ç²˜è´´æ­Œè¯æ–‡æœ¬', value: 'paste' }
    ]);

    let lrcContent = null;

    if (choice === 'file') {
        lrcContent = await new Promise(resolve => {
            const lrcInput = document.getElementById('lrc-upload-input');
            const lrcChangeHandler = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = readEvent => resolve(readEvent.target.result);
                    reader.onerror = () => resolve(null);
                    reader.readAsText(file);
                } else { resolve(null); }
                lrcInput.removeEventListener('change', lrcChangeHandler);
                lrcInput.value = '';
            };
            lrcInput.addEventListener('change', lrcChangeHandler, { once: true });
            lrcInput.click();
        });
    } else if (choice === 'paste') {
        const pastedText = await showCustomPrompt('ç²˜è´´æ­Œè¯', 'è¯·åœ¨æ­¤å¤„ç²˜è´´å®Œæ•´çš„LRCæ ¼å¼æ­Œè¯...', '', 'textarea');
        if (pastedText) lrcContent = pastedText.replace(/\[/g, '\n[').trim();
    }
    
    if (lrcContent !== null) {
        musicState.playlist[trackIndex].lrcContent = lrcContent;
        await saveGlobalPlaylist();
        if (musicState.currentIndex === trackIndex) {
            musicState.parsedLyrics = parseLRC(lrcContent);
            renderLyrics();
            updateLyricsUI();
        }
        await showCustomAlert('æˆåŠŸ', `ã€Š${musicState.playlist[trackIndex].name}ã€‹çš„æ­Œè¯å·²æˆåŠŸä¿å­˜ï¼`);
    }
}

/**
 * ã€å…¨æ–°ã€‘æ¸…ç†éŸ³ä¹æ’­æ”¾åˆ—è¡¨ä¸­çš„æ‰€æœ‰æ— æ•ˆæˆ–æ— æ³•æ’­æ”¾çš„æ­Œæ›²é“¾æ¥
 */
async function cleanupInvalidSongs() {
    if (musicState.playlist.length === 0) {
        alert("æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„ï¼Œæ— éœ€æ¸…ç†ã€‚");
        return;
    }

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ¸…ç†æ— æ•ˆæ­Œæ›²ï¼Ÿ',
        'æ­¤æ“ä½œå°†æ£€æŸ¥æ’­æ”¾åˆ—è¡¨ä¸­çš„æ¯ä¸€é¦–ç½‘ç»œæ­Œæ›²ï¼Œå¹¶ç§»é™¤æ‰€æœ‰æ— æ³•æ’­æ”¾çš„â€œæ­»é“¾â€ã€‚æœ¬åœ°æ­Œæ›²ä¸ä¼šå—å½±å“ã€‚',
        { confirmText: 'å¼€å§‹æ¸…ç†' }
    );

    if (!confirmed) return;

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨æ£€æŸ¥ ${musicState.playlist.length} é¦–æ­Œæ›²ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...`);

    const originalCount = musicState.playlist.length;
    const validPlaylist = [];
    const invalidSongs = [];

    const checkPromises = musicState.playlist.map(async (track) => {
        if (track.isLocal) {
            validPlaylist.push(track);
            return;
        }
        
        const isAvailable = await checkAudioAvailability(track.src);
        if (isAvailable) {
            validPlaylist.push(track);
        } else {
            invalidSongs.push(track.name);
            console.warn(`æ— æ•ˆé“¾æ¥: ${track.name} - ${track.src}`);
        }
    });

    await Promise.all(checkPromises);

    const removedCount = originalCount - validPlaylist.length;

    if (removedCount > 0) {
        const currentPlayingTrack = musicState.playlist[musicState.currentIndex];
        const isCurrentTrackRemoved = invalidSongs.includes(currentPlayingTrack?.name);

        musicState.playlist = validPlaylist;
        await saveGlobalPlaylist();

        if (isCurrentTrackRemoved) {
            audioPlayer.pause();
            audioPlayer.src = '';
            musicState.currentIndex = musicState.playlist.length > 0 ? 0 : -1;
            musicState.isPlaying = false;
        } else if (currentPlayingTrack) {
            musicState.currentIndex = musicState.playlist.findIndex(t => t.src === currentPlayingTrack.src);
        }

        updatePlaylistUI();
        updatePlayerUI();

        await showCustomAlert("æ¸…ç†å®Œæˆ", `æˆåŠŸç§»é™¤äº† ${removedCount} é¦–æ— æ•ˆæ­Œæ›²:\n\n- ${invalidSongs.join('\n- ')}`);
    } else {
        await showCustomAlert("æ£€æŸ¥å®Œæˆ", "æ‰€æœ‰æ­Œæ›²é“¾æ¥å‡æœ‰æ•ˆï¼Œæ— éœ€æ¸…ç†ï¼");
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯åº”ç”¨çŠ¶æ€æ æ˜¾ç¤º/éšè—è®¾ç½®çš„å‡½æ•° â–¼â–¼â–¼
/**
 * æ ¹æ®å…¨å±€è®¾ç½®ï¼Œåº”ç”¨çŠ¶æ€æ çš„å¯è§æ€§
 */
function applyStatusBarVisibility() {
    const phoneScreen = document.getElementById('phone-screen');
    // å¦‚æœè®¾ç½®ä¸º trueï¼Œå°±æ·»åŠ  classï¼›å¦åˆ™å°±ç§»é™¤ classã€‚
    phoneScreen.classList.toggle('status-bar-visible', !!state.globalSettings.showStatusBar);
}
// â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–° V3.0 | æ€»å…¥å£ã€‘æ‰“å¼€æ”¯æŒå‹¾é€‰çš„æ¸…ç©ºåŠ¨æ€é€‰æ‹©å™¨
 */
async function openClearPostsSelectorModal() {
    const modal = document.getElementById('clear-posts-modal');
    const listEl = document.getElementById('clear-posts-list');
    listEl.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹

    // 1. åˆ›å»ºæ‰€æœ‰é€‰é¡¹
    const options = [];

    // é€‰é¡¹A: æ¸…ç©ºæ‰€æœ‰
    options.push({ text: 'æ¸…ç©ºæ‰€æœ‰åŠ¨æ€ (å±é™©)', value: 'all', isDanger: true });

    // é€‰é¡¹B: æ¸…ç©ºç”¨æˆ·è‡ªå·±
    const myNickname = state.qzoneSettings.nickname || 'æˆ‘';
    options.push({ text: `ä»…æ¸…ç©º ${myNickname} çš„åŠ¨æ€`, value: 'user' });

    // é€‰é¡¹C: éå†AIè§’è‰²
    Object.values(state.chats).forEach(chat => {
        if (!chat.isGroup) {
            options.push({ text: `ä»…æ¸…ç©º ${chat.name} çš„åŠ¨æ€`, value: chat.id });
        }
    });

    // 2. å°†é€‰é¡¹æ¸²æŸ“åˆ°åˆ—è¡¨ä¸­
    options.forEach(opt => {
        const item = document.createElement('div');
        item.className = 'clear-posts-item';
        if (opt.isDanger) {
            item.classList.add('danger-option');
        }
        item.dataset.targetId = opt.value;
        item.innerHTML = `
            <div class="checkbox"></div>
            <span class="name">${opt.text}</span>
        `;
        listEl.appendChild(item);
    });
    
    // 3. æ˜¾ç¤ºæ¨¡æ€æ¡†
    modal.classList.add('visible');
}

/**
 * ã€å…¨æ–° V3.0 | æ ¸å¿ƒå¤„ç†å™¨ã€‘å¤„ç†æœ€ç»ˆçš„æ¸…ç©ºç¡®è®¤æ“ä½œ
 */
async function handleConfirmClearPosts() {
    const selectedItems = document.querySelectorAll('#clear-posts-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ¸…ç©ºçš„èŒƒå›´ã€‚");
        return;
    }

    const targetIds = Array.from(selectedItems).map(item => item.dataset.targetId);
    
    // --- æ„å»ºç¡®è®¤ä¿¡æ¯ ---
    let targetNames = [];
    if (targetIds.includes('all')) {
        targetNames.push('æ‰€æœ‰åŠ¨æ€');
    } else {
        if (targetIds.includes('user')) {
            targetNames.push(`â€œ${state.qzoneSettings.nickname}â€`);
        }
        targetIds.forEach(id => {
            const character = state.chats[id];
            if (character) {
                targetNames.push(`â€œ${character.name}â€`);
            }
        });
    }
    const confirmMessage = `æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤ ${targetNames.join('ã€ ')} çš„æ‰€æœ‰åŠ¨æ€ï¼Œä¸”æ— æ³•æ¢å¤ï¼`;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ¸…ç©ºåŠ¨æ€ï¼Ÿ',
        confirmMessage,
        { confirmButtonClass: 'btn-danger', confirmText: 'ç¡®è®¤æ¸…ç©º' }
    );

    if (!confirmed) return;

    try {
        if (targetIds.includes('all')) {
            await db.qzonePosts.clear();
        } else {
            // ä½¿ç”¨ Dexie çš„ bulk-delete åŠŸèƒ½ï¼Œä¸€æ¬¡æ€§é«˜æ•ˆåˆ é™¤å¤šä¸ªä½œè€…çš„åŠ¨æ€
            await db.qzonePosts.where('authorId').anyOf(targetIds).delete();
        }

        // åŒæ­¥æ›´æ–°å†…å­˜ç¼“å­˜å¹¶é‡ç»˜UI
        qzonePostsCache = await db.qzonePosts.orderBy('timestamp').reverse().toArray();
        qzonePostsRenderCount = 0;
        await renderQzonePosts();
        
        document.getElementById('clear-posts-modal').classList.remove('visible'); // å…³é—­é€‰æ‹©å™¨
        await showCustomAlert('æ“ä½œæˆåŠŸ', 'é€‰å®šèŒƒå›´å†…çš„åŠ¨æ€å·²è¢«æ¸…ç©ºã€‚');

    } catch (error) {
        console.error("æ¸…ç©ºåŠ¨æ€æ—¶å‡ºé”™:", error);
        await showCustomAlert('æ“ä½œå¤±è´¥', `æ¸…ç©ºåŠ¨æ€æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
    }
}
// â–¼â–¼â–¼ æ­¥éª¤ 3ï¼šå°†è¿™ä¸¤æ®µå…¨æ–°çš„JSä»£ç ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘åˆ é™¤æŒ‡å®šçš„å¿ƒå£°/æ•£è®°è®°å½•
 * @param {number} timestamp - è¦åˆ é™¤çš„è®°å½•çš„æ—¶é—´æˆ³
 */
async function handleDeleteThought(timestamp) {
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤',
        'ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡å¿ƒå£°è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
        { confirmButtonClass: 'btn-danger', confirmText: 'ç¡®è®¤åˆ é™¤' }
    );

    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        if (!chat || !chat.thoughtsHistory) return;

        // ä»å†å²è®°å½•æ•°ç»„ä¸­ç§»é™¤åŒ¹é…çš„é¡¹
        chat.thoughtsHistory = chat.thoughtsHistory.filter(thought => thought.timestamp !== timestamp);
        
        // å°†æ›´æ–°åçš„èŠå¤©æ•°æ®ä¿å­˜å›æ•°æ®åº“
        await db.chats.put(chat);
        
        // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥åæ˜ æ›´æ”¹
        renderThoughtsHistory();
        
        // ç»™å‡ºæˆåŠŸæç¤º
        await showCustomAlert('æˆåŠŸ', 'è¯¥æ¡è®°å½•å·²æˆåŠŸåˆ é™¤ã€‚');
    }
}

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºæ•´ä¸ªå†å²è®°å½•åˆ—è¡¨å®¹å™¨ç»‘å®šç‚¹å‡»äº‹ä»¶
document.getElementById('thoughts-history-list').addEventListener('click', (e) => {
    // æ£€æŸ¥è¢«ç‚¹å‡»çš„æ˜¯å¦æ˜¯åˆ é™¤æŒ‰é’®
    const deleteBtn = e.target.closest('.thought-delete-btn');
    if (deleteBtn) {
        // ä»æŒ‰é’®çš„ data-timestamp å±æ€§ä¸­è·å–æ—¶é—´æˆ³
        const timestamp = parseInt(deleteBtn.dataset.timestamp);
        if (!isNaN(timestamp)) {
            // è°ƒç”¨åˆ é™¤å¤„ç†å‡½æ•°
            handleDeleteThought(timestamp);
        }
    }
});

// â–²â–²â–² æ–°å¢JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² 
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å…¨å±€CSSé¢„è®¾åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
        
        /**
         * ä»æ•°æ®åº“åŠ è½½CSSé¢„è®¾ï¼Œå¹¶å¡«å……åˆ°ä¸‹æ‹‰é€‰æ‹©æ¡†ä¸­
         */
        async function loadCssPresetsDropdown() {
            const selectEl = document.getElementById('css-preset-select');
            selectEl.innerHTML = '<option value="">-- é€‰æ‹©ä¸€ä¸ªé¢„è®¾ --</option>';
            
            const presets = await db.appearancePresets.where('type').equals('global_css').toArray();
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                selectEl.appendChild(option);
            });
        }
        
        /**
         * å½“ç”¨æˆ·ä»ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªCSSé¢„è®¾æ—¶ï¼ŒåŠ è½½è¯¥é¢„è®¾
         */
        async function handleCssPresetSelectionChange() {
            const selectEl = document.getElementById('css-preset-select');
            const selectedId = parseInt(selectEl.value);
            if (isNaN(selectedId)) return;
        
            const preset = await db.appearancePresets.get(selectedId);
            if (preset) {
                const cssInput = document.getElementById('global-css-input');
                cssInput.value = preset.value;
                applyGlobalCss(preset.value); // å®æ—¶é¢„è§ˆ
            }
        }
        
        /**
         * å°†å½“å‰è¾“å…¥æ¡†ä¸­çš„CSSä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
         */
        async function saveCssPreset() {
            const name = await showCustomPrompt('ä¿å­˜CSSé¢„è®¾', 'è¯·è¾“å…¥é¢„è®¾åç§°');
            if (!name || !name.trim()) return;
        
            const cssValue = document.getElementById('global-css-input').value;
        
            const existingPreset = await db.appearancePresets.where({ name: name.trim(), type: 'global_css' }).first();
            if (existingPreset) {
                const confirmed = await showCustomConfirm('è¦†ç›–é¢„è®¾', `åä¸º â€œ${name.trim()}â€ çš„é¢„è®¾å·²å­˜åœ¨ã€‚è¦è¦†ç›–å®ƒå—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                if (!confirmed) return;
                
                await db.appearancePresets.update(existingPreset.id, { value: cssValue });
            } else {
                await db.appearancePresets.add({
                    name: name.trim(),
                    type: 'global_css',
                    value: cssValue
                });
            }
        
            await loadCssPresetsDropdown(); // åˆ·æ–°ä¸‹æ‹‰åˆ—è¡¨
            alert('CSS é¢„è®¾å·²ä¿å­˜ï¼');
        }
        
        /**
         * åˆ é™¤å½“å‰é€‰ä¸­çš„CSSé¢„è®¾
         */
        async function deleteCssPreset() {
            const selectEl = document.getElementById('css-preset-select');
            const selectedId = parseInt(selectEl.value);
        
            if (isNaN(selectedId)) {
                alert('è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾ã€‚');
                return;
            }
        
            const preset = await db.appearancePresets.get(selectedId);
            if (!preset) return;
        
            const confirmed = await showCustomConfirm('åˆ é™¤é¢„è®¾', `ç¡®å®šè¦åˆ é™¤é¢„è®¾ â€œ${preset.name}â€ å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.appearancePresets.delete(selectedId);
                await loadCssPresetsDropdown(); // åˆ·æ–°ä¸‹æ‹‰åˆ—è¡¨
                alert('é¢„è®¾å·²åˆ é™¤ã€‚');
            }
        }
        // â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å­—ä½“é¢„è®¾åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

        /**
         * ä»æ•°æ®åº“åŠ è½½å­—ä½“é¢„è®¾ï¼Œå¹¶å¡«å……åˆ°ä¸‹æ‹‰é€‰æ‹©æ¡†ä¸­
         */
        async function loadFontPresetsDropdown() {
            const selectEl = document.getElementById('font-preset-select');
            selectEl.innerHTML = '<option value="">-- é€‰æ‹©ä¸€ä¸ªé¢„è®¾ --</option>';
            
            const presets = await db.appearancePresets.where('type').equals('font').toArray();
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                selectEl.appendChild(option);
            });
        }

        /**
         * å½“ç”¨æˆ·ä»ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªå­—ä½“é¢„è®¾æ—¶ï¼ŒåŠ è½½è¯¥é¢„è®¾
         */
        async function handleFontPresetSelectionChange() {
            const selectEl = document.getElementById('font-preset-select');
            const selectedId = parseInt(selectEl.value);
            if (isNaN(selectedId)) return;
        
            const preset = await db.appearancePresets.get(selectedId);
            if (preset) {
                const fontUrlInput = document.getElementById('font-url-input');
                fontUrlInput.value = preset.value;
                applyCustomFont(preset.value, true); // å®æ—¶é¢„è§ˆ
            }
        }
        
        /**
         * å°†å½“å‰è¾“å…¥æ¡†ä¸­çš„å­—ä½“URLä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
         */
        async function saveFontPreset() {
            const name = await showCustomPrompt('ä¿å­˜å­—ä½“é¢„è®¾', 'è¯·è¾“å…¥é¢„è®¾åç§°');
            if (!name || !name.trim()) return;
        
            const fontUrl = document.getElementById('font-url-input').value.trim();
            if (!fontUrl) {
                alert("å­—ä½“URLä¸èƒ½ä¸ºç©ºï¼");
                return;
            }
        
            const existingPreset = await db.appearancePresets.where({ name: name.trim(), type: 'font' }).first();
            if (existingPreset) {
                const confirmed = await showCustomConfirm('è¦†ç›–é¢„è®¾', `åä¸º â€œ${name.trim()}â€ çš„é¢„è®¾å·²å­˜åœ¨ã€‚è¦è¦†ç›–å®ƒå—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                if (!confirmed) return;
                
                await db.appearancePresets.update(existingPreset.id, { value: fontUrl });
            } else {
                await db.appearancePresets.add({
                    name: name.trim(),
                    type: 'font',
                    value: fontUrl
                });
            }
        
            await loadFontPresetsDropdown();
            alert('å­—ä½“é¢„è®¾å·²ä¿å­˜ï¼');
        }
        
        /**
         * åˆ é™¤å½“å‰é€‰ä¸­çš„å­—ä½“é¢„è®¾
         */
        async function deleteFontPreset() {
            const selectEl = document.getElementById('font-preset-select');
            const selectedId = parseInt(selectEl.value);
        
            if (isNaN(selectedId)) {
                alert('è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾ã€‚');
                return;
            }
        
            const preset = await db.appearancePresets.get(selectedId);
            if (!preset) return;
        
            const confirmed = await showCustomConfirm('åˆ é™¤é¢„è®¾', `ç¡®å®šè¦åˆ é™¤é¢„è®¾ â€œ${preset.name}â€ å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.appearancePresets.delete(selectedId);
                await loadFontPresetsDropdown();
                alert('é¢„è®¾å·²åˆ é™¤ã€‚');
            }
        }
        // â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ°”æ³¡ä¸»é¢˜é¢„è®¾åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

        /**
         * ä»æ•°æ®åº“åŠ è½½æ°”æ³¡ä¸»é¢˜é¢„è®¾ï¼Œå¹¶å¡«å……åˆ°ä¸‹æ‹‰é€‰æ‹©æ¡†ä¸­
         */
        async function loadThemePresetsDropdown() {
            const selectEl = document.getElementById('theme-preset-select');
            selectEl.innerHTML = '<option value="">-- é€‰æ‹©ä¸€ä¸ªé¢„è®¾ --</option>';
            
            const presets = await db.appearancePresets.where('type').equals('bubble_theme').toArray();
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                selectEl.appendChild(option);
            });
        }

/**
         * å½“ç”¨æˆ·ä»ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªä¸»é¢˜é¢„è®¾æ—¶ï¼ŒåŠ è½½è¯¥é¢„è®¾
         */
        async function handleThemePresetSelectionChange() {
            const selectEl = document.getElementById('theme-preset-select');
            const selectedId = parseInt(selectEl.value);
            if (isNaN(selectedId)) return;
        
            const preset = await db.appearancePresets.get(selectedId);
            if (preset) {
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ â–¼â–¼â–¼
                // 1. ä»ä¿å­˜çš„å¯¹è±¡ä¸­åˆ†åˆ«è·å–åŸºç¡€ä¸»é¢˜å’Œè‡ªå®šä¹‰CSS
                const baseTheme = preset.value.base || 'default';
                const customCss = preset.value.custom || '';

                // 2. åº”ç”¨åŸºç¡€ä¸»é¢˜ï¼ˆå‹¾é€‰å¯¹åº”çš„å•é€‰æ¡†ï¼‰
                const themeRadio = document.querySelector(`input[name="theme-select"][value="${baseTheme}"]`);
                if (themeRadio) {
                    themeRadio.checked = true;
                }

                // 3. å°†ä¿å­˜çš„CSSåŠ è½½å›è¾“å…¥æ¡†
                const customCssInput = document.getElementById('custom-css-input');
                customCssInput.value = customCss;

                // 4. ç«‹åˆ»åˆ·æ–°é¢„è§ˆåŒºï¼Œè®©æ•ˆæœæ˜¾ç¤ºå‡ºæ¥
                updateSettingsPreview(); 
                // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
            }
        }
        
 /**
         * å°†å½“å‰é€‰æ‹©çš„æ°”æ³¡ä¸»é¢˜ä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
         */
        async function saveThemePreset() {
            const name = await showCustomPrompt('ä¿å­˜ä¸»é¢˜é¢„è®¾', 'è¯·è¾“å…¥é¢„è®¾åç§°');
            if (!name || !name.trim()) return;
        
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ â–¼â–¼â–¼
            // 1. è·å–åŸºç¡€ä¸»é¢˜çš„é€‰æ‹©
            const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
            const themeValue = selectedThemeRadio ? selectedThemeRadio.value : 'default';

            // 2. è·å–è‡ªå®šä¹‰CSSçš„å†…å®¹
            const cssValue = document.getElementById('custom-css-input').value.trim();

            // 3. å°†åŸºç¡€ä¸»é¢˜å’Œè‡ªå®šä¹‰CSSæ‰“åŒ…æˆä¸€ä¸ªå¯¹è±¡è¿›è¡Œä¿å­˜
            const presetValueObject = {
                base: themeValue,
                custom: cssValue
            };
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        
            const existingPreset = await db.appearancePresets.where({ name: name.trim(), type: 'bubble_theme' }).first();
            if (existingPreset) {
                const confirmed = await showCustomConfirm('è¦†ç›–é¢„è®¾', `åä¸º â€œ${name.trim()}â€ çš„é¢„è®¾å·²å­˜åœ¨ã€‚è¦è¦†ç›–å®ƒå—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                if (!confirmed) return;
                
                // ä¿å­˜æ‰“åŒ…åçš„å¯¹è±¡
                await db.appearancePresets.update(existingPreset.id, { value: presetValueObject });
            } else {
                await db.appearancePresets.add({
                    name: name.trim(),
                    type: 'bubble_theme',
                    // ä¿å­˜æ‰“åŒ…åçš„å¯¹è±¡
                    value: presetValueObject
                });
            }
        
            await loadThemePresetsDropdown();
            alert('ä¸»é¢˜é¢„è®¾å·²ä¿å­˜ï¼');
        }
        
        /**
         * åˆ é™¤å½“å‰é€‰ä¸­çš„ä¸»é¢˜é¢„è®¾
         */
        async function deleteThemePreset() {
            const selectEl = document.getElementById('theme-preset-select');
            const selectedId = parseInt(selectEl.value);
        
            if (isNaN(selectedId)) {
                alert('è¯·å…ˆä»ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é¢„è®¾ã€‚');
                return;
            }
        
            const preset = await db.appearancePresets.get(selectedId);
            if (!preset) return;
        
            const confirmed = await showCustomConfirm('åˆ é™¤é¢„è®¾', `ç¡®å®šè¦åˆ é™¤é¢„è®¾ â€œ${preset.name}â€ å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.appearancePresets.delete(selectedId);
                await loadThemePresetsDropdown();
                alert('é¢„è®¾å·²åˆ é™¤ã€‚');
            }
        }
        // â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯è¡¨æƒ…åŒ…åˆ†ç±»åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç ã€‘ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼
        
        /**
         * ã€æ€»å…¥å£ã€‘æ‰“å¼€åˆ†ç±»ç®¡ç†å¼¹çª—
         */
        async function openStickerCategoryManager() {
            await renderStickerCategoriesInManager();
            document.getElementById('sticker-category-manager-modal').classList.add('visible');
        }
        
        /**
         * åœ¨å¼¹çª—ä¸­æ¸²æŸ“å·²å­˜åœ¨çš„åˆ†ç±»åˆ—è¡¨
         */
        async function renderStickerCategoriesInManager() {
            const listEl = document.getElementById('existing-sticker-categories-list');
            const categories = await db.stickerCategories.toArray();
            listEl.innerHTML = '';
            if (categories.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>';
                return;
            }
            categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'existing-group-item'; // å¤ç”¨å·²æœ‰æ ·å¼
                item.innerHTML = `
                    <span class="group-name">${cat.name}</span>
                    <span class="delete-group-btn" data-id="${cat.id}">Ã—</span>
                `;
                listEl.appendChild(item);
            });
        }
        
        /**
         * æ·»åŠ ä¸€ä¸ªæ–°çš„è¡¨æƒ…åˆ†ç±»
         */
        async function addNewStickerCategory() {
            const input = document.getElementById('new-sticker-category-name-input');
            const name = input.value.trim();
            if (!name) {
                alert('åˆ†ç±»åä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            const existing = await db.stickerCategories.where('name').equals(name).first();
            if (existing) {
                alert(`åˆ†ç±» "${name}" å·²ç»å­˜åœ¨äº†ï¼`);
                return;
            }
            await db.stickerCategories.add({ name });
            input.value = '';
            await renderStickerCategoriesInManager();
        }
        
        /**
         * ã€æ ¸å¿ƒã€‘åˆ é™¤ä¸€ä¸ªåˆ†ç±»ï¼Œå¹¶ä¸€å¹¶åˆ é™¤è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰è¡¨æƒ…åŒ…
         * @param {number} categoryId - è¦åˆ é™¤çš„åˆ†ç±»çš„ID
         */
        async function deleteStickerCategory(categoryId) {
            const category = await db.stickerCategories.get(categoryId);
            if (!category) return;

            const stickersInCateogry = await db.userStickers.where('categoryId').equals(categoryId).count();
            
            const confirmMessage = stickersInCateogry > 0 
                ? `ç¡®å®šè¦åˆ é™¤åˆ†ç±»ã€Š${category.name}ã€‹å—ï¼Ÿ\n\nã€ã€ã€è­¦å‘Šã€‘ã€‘ã€‘\næ­¤æ“ä½œå°†åŒæ—¶æ°¸ä¹…åˆ é™¤è¯¥åˆ†ç±»ä¸‹çš„ ${stickersInCateogry} ä¸ªè¡¨æƒ…åŒ…ï¼Œä¸”æ— æ³•æ¢å¤ï¼`
                : `ç¡®å®šè¦åˆ é™¤åˆ†ç±»ã€Š${category.name}ã€‹å—ï¼Ÿ`;

            const confirmed = await showCustomConfirm(
                'ç¡®è®¤åˆ é™¤åˆ†ç±»', 
                confirmMessage, 
                { confirmButtonClass: 'btn-danger' }
            );

            if (confirmed) {
                try {
                    // ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ“ä½œçš„åŸå­æ€§
                    await db.transaction('rw', db.stickerCategories, db.userStickers, async () => {
                        // 1. æ‰¾åˆ°è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰è¡¨æƒ…çš„ID
                        const stickerIdsToDelete = await db.userStickers.where('categoryId').equals(categoryId).primaryKeys();
                        
                        // 2. æ‰¹é‡åˆ é™¤è¿™äº›è¡¨æƒ…
                        if (stickerIdsToDelete.length > 0) {
                            await db.userStickers.bulkDelete(stickerIdsToDelete);
                        }

                        // 3. åˆ é™¤åˆ†ç±»æœ¬èº«
                        await db.stickerCategories.delete(categoryId);
                    });

                    // æ›´æ–°å‰ç«¯ state å’Œ UI
                    state.userStickers = await db.userStickers.toArray();
                    if (activeStickerCategoryId === categoryId) {
                        activeStickerCategoryId = 'all'; // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰åˆ†ç±»ï¼Œå°±åˆ‡å›â€œå…¨éƒ¨â€
                    }
                    await renderStickerCategoriesInManager(); // åˆ·æ–°ç®¡ç†åˆ—è¡¨
                    await renderStickerPanel(); // åˆ·æ–°ä¸»é¢æ¿
                    
                    alert(`åˆ†ç±»ã€Š${category.name}ã€‹åŠå…¶ä¸‹çš„è¡¨æƒ…å·²æˆåŠŸåˆ é™¤ã€‚`);

                } catch (error) {
                    console.error("åˆ é™¤åˆ†ç±»åŠè¡¨æƒ…æ—¶å‡ºé”™:", error);
                    alert("åˆ é™¤å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚");
                }
            }
        }

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ switchStickerCategory å‡½æ•° â–¼â–¼â–¼
        function switchStickerCategory(categoryId) {
            activeStickerCategoryId = categoryId;
            document.querySelectorAll('.sticker-category-tab').forEach(tab => {
                tab.classList.toggle('active', String(tab.dataset.categoryId) === String(categoryId));
            });
            renderStickerPanel(false);
            
            // ã€æ ¸å¿ƒæ–°å¢ã€‘åˆ‡æ¢åˆ†ç±»æ—¶ï¼Œé‡ç½®å…¨é€‰æ¡†çš„çŠ¶æ€
            const selectAllCheckbox = document.getElementById('select-all-stickers-checkbox');
            if(selectAllCheckbox) selectAllCheckbox.checked = false;
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–°ã€‘ä»…å¯¼å‡ºå½“å‰å•ä¸ªèŠå¤©çš„å¤‡ä»½
 */
async function exportSingleChat() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    try {
        const backupData = {
            type: 'EPhoneSingleChat', // ç‰¹æ®Šæ ‡è®°ï¼Œç”¨äºå¯¼å…¥æ—¶éªŒè¯
            version: 1,
            chatData: chat
        };

        const blob = new Blob(
            [JSON.stringify(backupData, null, 2)], 
            { type: 'application/json' }
        );
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        // æ–‡ä»¶åå°†ä½¿ç”¨è§’è‰²çš„å¤‡æ³¨å
        link.download = `EPhone-Chat-${chat.name}-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        await showCustomAlert('å¯¼å‡ºæˆåŠŸ', `ä¸â€œ${chat.name}â€çš„èŠå¤©è®°å½•å·²æˆåŠŸå¯¼å‡ºï¼`);

    } catch (error) {
        console.error("å¯¼å‡ºå•ä¸ªèŠå¤©æ—¶å‡ºé”™:", error);
        await showCustomAlert('å¯¼å‡ºå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–°ã€‘å°†å•ä¸ªèŠå¤©çš„å¤‡ä»½å¯¼å…¥å¹¶è¦†ç›–å½“å‰èŠå¤©
 * @param {File} file - ç”¨æˆ·é€‰æ‹©çš„ .json å¤‡ä»½æ–‡ä»¶
 */
async function importSingleChat(file) {
    if (!file || !state.activeChatId) return;
    const currentChatId = state.activeChatId;
    const currentChat = state.chats[currentChatId];

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        // 1. éªŒè¯æ–‡ä»¶æ ¼å¼
        if (data.type !== 'EPhoneSingleChat' || !data.chatData) {
            throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å•èŠå¤‡ä»½æ–‡ä»¶ã€‚");
        }

        // 2. å¼¹å‡ºæœ€ç»ˆè­¦å‘Š
        const confirmed = await showCustomConfirm(
            'ä¸¥é‡è­¦å‘Šï¼',
            `è¿™å°†ç”¨å¤‡ä»½æ–‡ä»¶ä¸­çš„æ•°æ®ã€å®Œå…¨è¦†ç›–ã€‘å½“å‰ä¸â€œ${currentChat.name}â€çš„èŠå¤©è®°å½•å’Œè®¾ç½®ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼<br><br><strong>ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ</strong>`,
            { confirmButtonClass: 'btn-danger', confirmText: 'ç¡®è®¤è¦†ç›–' }
        );

        if (!confirmed) return;

        // 3. æ‰§è¡Œè¦†ç›–æ“ä½œ
        const importedChatData = data.chatData;
        
        // ä¿æŒå½“å‰çš„IDä¸å˜ï¼Œåªç”¨å¯¼å…¥çš„æ•°æ®è¦†ç›–å†…å®¹
        importedChatData.id = currentChatId; 
        
        // æ›´æ–°æ•°æ®åº“å’Œå†…å­˜çŠ¶æ€
        await db.chats.put(importedChatData);
        state.chats[currentChatId] = importedChatData;

        // 4. æˆåŠŸæç¤ºå¹¶åˆ·æ–°
        await showCustomAlert('å¯¼å…¥æˆåŠŸ', 'èŠå¤©è®°å½•å·²æˆåŠŸè¦†ç›–ï¼æ­£åœ¨åˆ·æ–°ç•Œé¢...');
        
        // åˆ·æ–°UI
        renderChatInterface(currentChatId);
        renderChatList();
        document.getElementById('chat-settings-btn').click(); // é‡æ–°æ‰“å¼€è®¾ç½®ä»¥æ˜¾ç¤ºæœ€æ–°æ•°æ®

    } catch (error) {
        console.error("å¯¼å…¥å•ä¸ªèŠå¤©æ—¶å‡ºé”™:", error);
        await showCustomAlert('å¯¼å…¥å¤±è´¥', `æ–‡ä»¶è§£ææˆ–åº”ç”¨å¤±è´¥: ${error.message}`);
    }
}
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneåŠŸèƒ½çš„æ‰€æœ‰æ ¸å¿ƒJSä»£ç  â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ã€‘æ‰“å¼€è§’è‰²é€‰æ‹©ç•Œé¢
 */
function openCharacterSelector() {
    renderCharacterSelector();
    showScreen('character-selection-screen');
}

/**
 * æ¸²æŸ“è§’è‰²é€‰æ‹©åˆ—è¡¨
 */
function renderCharacterSelector() {
    const gridEl = document.getElementById('character-grid');
    gridEl.innerHTML = '';
    
    // åªç­›é€‰å‡ºå•èŠè§’è‰²
    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (characters.length === 0) {
        gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿˜æ²¡æœ‰å¯ä»¥æŸ¥çœ‹æ‰‹æœºçš„è§’è‰²å“¦~</p>';
        return;
    }

    characters.forEach(char => {
        const item = document.createElement('div');
        item.className = 'character-select-item';
        item.innerHTML = `
            <img src="${char.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${char.name}</span>
        `;
        item.addEventListener('click', () => switchToCharacterPhone(char.id));
        gridEl.appendChild(item);
    });
}

        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå·²æ›´æ–°çš„ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ switchToCharacterPhone å‡½æ•° â–¼â–¼â–¼
        /**
         * åˆ‡æ¢åˆ°æŒ‡å®šè§’è‰²çš„æ‰‹æœºç•Œé¢
         * @param {string} characterId - è§’è‰²çš„ID
         */
        async function switchToCharacterPhone(characterId) {
            activeCharacterId = characterId;
            console.log(`å·²åˆ‡æ¢åˆ°è§’è‰² ${characterId} çš„æ‰‹æœº`);
            
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒç”¨æ–°çš„åº”ç”¨å‡½æ•°æ¥è®¾ç½®å£çº¸å’Œå›¾æ ‡
            applyCPhoneWallpaper();
            applyCPhoneAppIcons();
            
            // æ¸²æŸ“å¹¶æ˜¾ç¤ºCphoneçš„ä¸»å±å¹•
            renderCharHomeScreen();
            showScreen('character-phone-screen');
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * è¿”å›åˆ°ç”¨æˆ·è‡ªå·±çš„æ‰‹æœºä¸»å±å¹•
 */
function switchToMyPhone() {
    activeCharacterId = null;
    console.log("å·²è¿”å›æˆ‘çš„æ‰‹æœº");
    showScreen('home-screen');
}

/**
 * æ¸²æŸ“Cphoneçš„ä¸»å±å¹•ï¼ˆä¸»è¦æ˜¯æ›´æ–°æ—¶é’Ÿï¼‰
 */
function renderCharHomeScreen() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' });
    document.getElementById('char-main-time').textContent = timeString;
    document.getElementById('char-main-date').textContent = dateString;
    switchToCharScreen('char-home-screen');
}

/**
 * åœ¨Cphoneå†…éƒ¨åˆ‡æ¢ä¸åŒçš„Appå±å¹•
 * @param {string} screenId - è¦æ˜¾ç¤ºçš„è§’è‰²Appå±å¹•ID
 */
function switchToCharScreen(screenId) {
    document.querySelectorAll('.char-screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}
// â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤ã€‘å°†æ­¤å‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œè®©onclickå¯ä»¥è°ƒç”¨ â–¼â–¼â–¼
window.switchToCharScreen = switchToCharScreen;
// â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€V3.0 | æœ€ç»ˆç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ openCharApp â–¼â–¼â–¼
         /**
         * ã€æ€»åˆ†å‘ | V3.0 | æœ€ç»ˆä¿®å¤ç‰ˆ | å·²æ·»åŠ éŸ³ä¹Appã€‘æ‰“å¼€Cphoneå†…çš„App
         * @param {string} appName - Appçš„ç®€ç§° (qq, album, amap...)
         */
        async function openCharApp(appName) {
            if (!activeCharacterId) return;
            const char = state.chats[activeCharacterId];
            
            await logAppUsage(activeCharacterId, appName);

            switch(appName) {
                case 'qq':
                    renderCharSimulatedQQ();
                    switchToCharScreen('char-qq-screen');
                    break;
                case 'album':
                    renderCharAlbum();
                    switchToCharScreen('char-album-screen');
                    break;
                case 'browser':
                    renderCharBrowserHistory();
                    switchToCharScreen('char-browser-screen');
                    break;
                case 'taobao':
                    renderCharTaobao();
                    switchToCharScreen('char-taobao-screen');
                    break;
                case 'memo':
                    renderCharMemoList();
                    switchToCharScreen('char-memo-screen');
                    break;
                case 'diary':
                    renderCharDiaryList();
                    switchToCharScreen('char-diary-screen');
                    break;
                case 'amap':
                    renderCharAmap();
                    switchToCharScreen('char-amap-screen');
                    break;
                
                // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œï¼ã€‘ â–¼â–¼â–¼
                // æˆ‘ä»¬ç°åœ¨æ·»åŠ äº†å¯¹ 'music' çš„å¤„ç†é€»è¾‘
                case 'music':
                    renderCharMusicScreen(); // æ¸²æŸ“ç½‘æ˜“äº‘éŸ³ä¹åˆ—è¡¨
                    switchToCharScreen('char-music-screen'); // æ˜¾ç¤ºç½‘æ˜“äº‘éŸ³ä¹å±å¹•
                    break;
                // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

                case 'usage':
                    renderCharAppUsage();
                    switchToCharScreen('char-usage-screen');
                    break;
            }
        }
        // â–¼â–¼â–¼ ã€V3.2 | æè¿°æ˜¾ç¤ºç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ renderCharAlbum å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€å…¨æ–° | V3.2 ç»ˆæé˜²ç©ºçª—+ç”Ÿå›¾å¼€å…³+æè¿°æ˜¾ç¤ºç‰ˆã€‘æ¸²æŸ“è§’è‰²ç›¸å†Œ
         */
        async function renderCharAlbum() {
            const gridEl = document.getElementById('char-album-grid');
            gridEl.innerHTML = '';
            if (!activeCharacterId) return;
            const char = state.chats[activeCharacterId];
        
            const photos = char.simulatedAlbum || [];
        
            if (photos.length === 0) {
                gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAçš„ç›¸å†Œè¿˜æ˜¯ç©ºçš„ï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›ç…§ç‰‡å§ï¼</p>';
                return;
            }
        
            const fallbackImageUrl = `https://i.postimg.cc/KYr2qRCK/1.jpg`;

            photos.forEach(photo => {
                const item = document.createElement('div');
                item.className = 'char-photo-item';
                item.dataset.description = photo.description;
                gridEl.appendChild(item);

                
                // 1. æ£€æŸ¥å…¨å±€çš„ç”Ÿå›¾å¼€å…³æ˜¯å¦å¼€å¯
                if (state.globalSettings.enableAiDrawing) {
                    // --- å¦‚æœå¼€å…³ã€å¼€å¯ã€‘ï¼Œæ‰§è¡ŒåŸæ¥çš„ç”Ÿå›¾é€»è¾‘ ---
                    item.style.backgroundColor = '#e9ecef';
                    const containsNonEnglish = /[^\x00-\x7F]/.test(photo.image_prompt);
                    const isValidPrompt = photo.image_prompt && photo.image_prompt.trim() && !containsNonEnglish;
                    const finalPrompt = isValidPrompt ? photo.image_prompt : 'a beautiful scenery, anime style, cinematic lighting';
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}`;
                    
                    const img = new Image();
                    img.onload = function() { item.style.backgroundImage = `url(${this.src})`; };
                    img.onerror = function() { item.style.backgroundImage = `url(${fallbackImageUrl})`; };
                    img.src = imageUrl;

                } else {
                    // --- å¦‚æœå¼€å…³ã€å…³é—­ã€‘ï¼Œåˆ™ç›´æ¥æ˜¾ç¤ºæè¿°æ–‡å­—ï¼ ---
                    item.style.backgroundColor = '#f0f2f5'; // ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰²
                    item.style.border = '1px solid #e0e0e0'; // åŠ ä¸€ä¸ªç»†è¾¹æ¡†ï¼Œæ›´æœ‰å¡ç‰‡æ„Ÿ
                    
                    // åˆ›å»ºä¸€ä¸ªæ–°çš„ <p> å…ƒç´ æ¥å­˜æ”¾æè¿°
                    const descriptionEl = document.createElement('p');
                    descriptionEl.className = 'char-photo-description'; // åº”ç”¨æˆ‘ä»¬åˆšåˆšæ·»åŠ çš„CSSæ ·å¼
                    descriptionEl.textContent = photo.description || '(è¿™å¼ ç…§ç‰‡æ²¡æœ‰æè¿°)'; // æ˜¾ç¤ºæè¿°ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºæç¤º
                    
                    // å°†æè¿°å…ƒç´ æ·»åŠ åˆ°æ ¼å­é‡Œ
                    item.appendChild(descriptionEl);
                }
       
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘åŠ¨æ€ç”Ÿæˆå¹¶æ¸²æŸ“è§’è‰²çš„æµè§ˆå™¨å†å²è®°å½•
 */
function renderCharBrowserHistory() {
    const listEl = document.getElementById('char-browser-history');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    // è¿™é‡Œæˆ‘ä»¬åŸºäºè§’è‰²çš„åå­—å’Œäººè®¾ï¼ŒåŠ¨æ€ç”Ÿæˆä¸€äº›çœ‹èµ·æ¥åˆç†çš„å†å²è®°å½•
    const historyKeywords = [char.name, "çˆ±å¥½", "æ—…æ¸¸", "ç¾é£Ÿ", "æ–°é—»", ...char.settings.aiPersona.split(/ï¼Œ|ã€‚|\s/).slice(0, 5)];
    const historySites = ["çŸ¥ä¹", "Bilibili", "å°çº¢ä¹¦", "å¾®åš", "ç»´åŸºç™¾ç§‘"];

    for (let i = 0; i < 15; i++) {
        const keyword = historyKeywords[Math.floor(Math.random() * historyKeywords.length)];
        const site = historySites[Math.floor(Math.random() * historySites.length)];
        const item = document.createElement('div');
        item.className = 'char-browser-item';
        item.innerHTML = `
            <div class="title">${keyword} - ${site}</div>
            <div class="url">www.${site.toLowerCase()}.com/${keyword}</div>
        `;
        listEl.appendChild(item);
    }
}

        // â–¼â–¼â–¼ ã€V3.1 | ç”Ÿå›¾å¼€å…³+æè¿°æ˜¾ç¤º+çŠ¶æ€æ˜¾ç¤ºç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ renderCharTaobao â–¼â–¼â–¼
        /**
         * ã€å…¨æ–° | V3.1 æ— é’±åŒ…ç‰ˆ | æœ€ç»ˆä¿®å¤ã€‘æ¸²æŸ“è§’è‰²çš„æ·˜å®â€œè´­ä¹°è®°å½•â€é¡µé¢
         */
        function renderCharTaobao() {
            const gridEl = document.getElementById('char-product-grid');
            gridEl.innerHTML = '';
            if (!activeCharacterId) return;

            const char = state.chats[activeCharacterId];
            const purchases = char.simulatedTaobaoHistory?.purchases || [];

            if (purchases.length === 0) {
                gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAæœ€è¿‘å¥½åƒä»€ä¹ˆéƒ½æ²¡ä¹°å‘¢ï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›è®°å½•å§ï¼</p>';
                return;
            }

            purchases.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'char-product-item';
                itemEl.dataset.reason = item.reason;
                
                let imageOrTextHtml;
                if (state.globalSettings.enableAiDrawing) {
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image_prompt || 'a random product')}`;
                    imageOrTextHtml = `<img src="${imageUrl}" class="product-image">`;
                } else {
                    imageOrTextHtml = `
                        <div class="char-product-description-overlay">
                            <p class="char-photo-description">${item.reason || '(æ— è´­ä¹°ç†ç”±)'}</p>
                        </div>
                    `;
                }

                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡Œæ·»åŠ äº† item.status çš„æ˜¾ç¤º â–¼â–¼â–¼
                itemEl.innerHTML = `
                    ${imageOrTextHtml}
                    <div class="product-info">
                        <div class="product-name">${item.itemName}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <div class="product-price">${(item.price || 0).toFixed(2)}</div>
                            <div class="char-product-status">${item.status}</div>
                        </div>
                    </div>
                `;
                // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
                gridEl.appendChild(itemEl);
            });
        }
/**
 * åˆ‡æ¢å›Cphoneçš„ä¸»å±å¹•
 */
function switchToCharHomeScreen() {
    switchToCharScreen('char-home-screen');
}


// --- CphoneAppçš„å…·ä½“åŠŸèƒ½ ---

/**
 * æ¸²æŸ“è§’è‰²è§†è§’çš„QQèŠå¤©åˆ—è¡¨ (ç®€åŒ–ç‰ˆ)
 */
function renderCharChatList() {
    const listEl = document.getElementById('char-chat-list');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    // æ‰¾å‡ºæ‰€æœ‰ä¸è¯¥è§’è‰²ç›¸å…³çš„èŠå¤©
    const relatedChats = Object.values(state.chats).filter(chat => {
        // æ¡ä»¶1: ä¸ç”¨æˆ·çš„å•èŠ
        if (chat.id === activeCharacterId) return true;
        // æ¡ä»¶2: è§’è‰²æ‰€åœ¨çš„ç¾¤èŠ
        if (chat.isGroup && chat.members.some(m => m.id === activeCharacterId)) return true;
        return false;
    });

    relatedChats.forEach(chat => {
        const item = createChatListItem(chat); // å¤ç”¨ä¸»åˆ—è¡¨çš„æ¸²æŸ“å‡½æ•°
        listEl.appendChild(item);
    });
}

/**
 * è®°å½•Appä½¿ç”¨æ—¥å¿—
 */
async function logAppUsage(characterId, appName) {
    const char = state.chats[characterId];
    if (!char) return;
    if (!char.appUsageLog) {
        char.appUsageLog = [];
    }
    char.appUsageLog.push({
        appName: appName,
        timestamp: Date.now()
    });
    // ä¿ç•™æœ€è¿‘50æ¡è®°å½•
    if (char.appUsageLog.length > 50) {
        char.appUsageLog.shift();
    }
    await db.chats.put(char);
}

/**
 * æ¸²æŸ“Appä½¿ç”¨è®°å½•
 */
function renderCharAppUsage() {
    const listEl = document.getElementById('char-usage-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    const log = (char.appUsageLog || []).slice().reverse(); // ä»æ–°åˆ°æ—§æ˜¾ç¤º

    if (log.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿˜æ²¡æœ‰ä»»ä½•ä½¿ç”¨è®°å½•ã€‚</p>';
        return;
    }

    const appNameMap = {
        'qq': 'QQ', 'album': 'ç›¸å†Œ', 'browser': 'æµè§ˆå™¨', 'taobao': 'æ·˜å®',
        'memo': 'å¤‡å¿˜å½•', 'diary': 'æ—¥è®°', 'amap': 'é«˜å¾·åœ°å›¾', 'usage': 'Appè®°å½•'
    };

    log.forEach(entry => {
        const item = document.createElement('div');
        item.className = 'usage-item';
        item.innerHTML = `
            <div class="timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
            <div class="action">æ‰“å¼€äº† <strong>${appNameMap[entry.appName] || entry.appName}</strong></div>
        `;
        listEl.appendChild(item);
    });
}

/**
 * æ¨¡æ‹Ÿè§’è‰²å‘é€ä½ç½®åˆ†äº«
 */
async function sendCharLocationShare(locationName) {
    const userChat = state.chats[activeCharacterId]; // è·å–ä¸è¯¥è§’è‰²çš„å•èŠ
    if (!userChat) return;

    const msg = {
        role: 'assistant', // æ˜¯AIï¼ˆè§’è‰²ï¼‰å‘å‡ºçš„
        senderName: userChat.originalName,
        type: 'location_share',
        content: locationName,
        imageUrl: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg',
        timestamp: Date.now()
    };

    userChat.history.push(msg);
    await db.chats.put(userChat);
    
    // å¦‚æœå½“å‰æ­£ä¸è¯¥è§’è‰²èŠå¤©ï¼Œåˆ™å®æ—¶æ˜¾ç¤º
    if (state.activeChatId === activeCharacterId) {
        appendMessage(msg, userChat);
    }
    
    await showCustomAlert("åˆ†äº«æˆåŠŸ", `â€œ${userChat.name}â€ çš„ä½ç½®å·²å‘é€åˆ°ä½ ä»¬çš„èŠå¤©ä¸­ã€‚`);
}


/**
 * ã€V2.1 | å…¨å±æŸ¥çœ‹æœ€ç»ˆç‰ˆã€‘ç‚¹å‡»å¤‡å¿˜å½•åˆ—è¡¨é¡¹æ—¶ï¼Œæ‰“å¼€è¯¦æƒ…é¡µé¢æŸ¥çœ‹å…¶å†…å®¹
 * @param {number} memoId - è¦æŸ¥çœ‹çš„å¤‡å¿˜å½•çš„ID
 */
async function viewMemo(memoId) {
    const char = state.chats[activeCharacterId];
    if (!char || !char.memos) return;

    const memo = char.memos.find(m => m.id === memoId);
    if (memo) {
        // 1. ã€æ ¸å¿ƒä¿®å¤ã€‘ç°åœ¨æˆ‘ä»¬ç›´æ¥é€šè¿‡IDæŸ¥æ‰¾æ ‡é¢˜å’Œå†…å®¹å…ƒç´ 
        const titleEl = document.getElementById('char-memo-detail-title');
        const contentEl = document.getElementById('char-memo-detail-content');

        // 2. å°†å¤‡å¿˜å½•çš„æ•°æ®å¡«å……è¿›å»
        if (titleEl) titleEl.textContent = memo.title;
        if (contentEl) contentEl.value = memo.content;

        // 3. åˆ‡æ¢åˆ°æ–°çš„è¯¦æƒ…é¡µå±å¹•
        switchToCharScreen('char-memo-detail-screen');
    }
}

/**
 * ã€V2.0 | æ”¯æŒæ ‡é¢˜ã€‘æ¸²æŸ“Cphoneçš„å¤‡å¿˜å½•åˆ—è¡¨
 */
function renderCharMemoList() {
    const listEl = document.getElementById('char-memo-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    const memos = (char.memos || []).slice().reverse();

    if (memos.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿˜æ²¡æœ‰å¤‡å¿˜å½•ã€‚</p>';
        return;
    }

    memos.forEach(memo => {
        const item = document.createElement('div');
        // å¤ç”¨ç°æœ‰çš„ list-item æ ·å¼ï¼Œç¾è§‚ä¸”ç»Ÿä¸€
        item.className = 'list-item'; 
        item.innerHTML = `
            <div class="item-title">${memo.title}</div>
            <div class="item-content">${(memo.content || '').split('\n')[0]}</div>
        `;
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚¹å‡»åˆ—è¡¨é¡¹ç°åœ¨æ˜¯è°ƒç”¨ viewMemo æŸ¥çœ‹å‡½æ•°
        item.addEventListener('click', () => viewMemo(memo.id));
        addLongPressListener(item, () => deleteMemo(memo.id));
        listEl.appendChild(item);
    });
}

/**
 * ã€V2.1 | æµç¨‹ä¿®æ­£ã€‘æ‰“å¼€ç¼–è¾‘å™¨ä»¥åˆ›å»ºæ–°çš„å¤‡å¿˜å½•
 */
async function openMemoEditor(memoId = null) {
    editingMemoId = null; 
    
    // ï¼ˆè¿™éƒ¨åˆ†é€»è¾‘ä¸ä¹‹å‰ç›¸åŒï¼‰
    const newTitle = await showCustomPrompt("æ–°å»ºå¤‡å¿˜å½•", "è¯·è¾“å…¥æ ‡é¢˜");
    if (newTitle === null || !newTitle.trim()) return;

    const newContent = await showCustomPrompt(`æ ‡é¢˜: ${newTitle}`, "è¯·è¾“å…¥å¤‡å¿˜å½•å†…å®¹", "", 'textarea');
    if (newContent !== null) {
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨ä¿å­˜åï¼Œç¡®ä¿æˆ‘ä»¬åœç•™åœ¨å¤‡å¿˜å½•åˆ—è¡¨é¡µ
        await saveMemo({ title: newTitle.trim(), content: newContent });
        switchToCharScreen('char-memo-screen'); // ç¡®ä¿æ˜¾ç¤ºçš„æ˜¯åˆ—è¡¨
    }
}

/**
 * ã€V2.0 | æ”¯æŒæ ‡é¢˜ã€‘ä¿å­˜æ–°çš„å¤‡å¿˜å½•
 * @param {object} memoData - åŒ…å« title å’Œ content çš„å¯¹è±¡
 */
async function saveMemo(memoData) {
    const char = state.chats[activeCharacterId];
    if (!char.memos) char.memos = [];
    
    // è¿™ä¸ªå‡½æ•°ç°åœ¨åªå¤„ç†â€œæ–°å»ºâ€
    char.memos.push({ 
        id: Date.now(), 
        title: memoData.title, 
        content: memoData.content 
    });
    
    await db.chats.put(char);
    renderCharMemoList();
}

async function saveMemo(content) {
    const char = state.chats[activeCharacterId];
    if (!char.memos) char.memos = [];
    
    if (editingMemoId) {
        const memo = char.memos.find(m => m.id === editingMemoId);
        if (memo) memo.content = content;
    } else {
        char.memos.push({ id: Date.now(), content: content });
    }
    
    await db.chats.put(char);
    renderCharMemoList();
    editingMemoId = null;
}



        // â–¼â–¼â–¼ ã€V2.0 | AIç”Ÿæˆç‰ˆã€‘è¯·ç”¨è¿™ä¸€æ•´å—ä»£ç ï¼Œæ›¿æ¢æ‰€æœ‰æ—§çš„æ—¥è®°åŠŸèƒ½å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–° | V3.0 AIæŒ‡ä»¤å¼ºåŒ–ç‰ˆã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œé‡æ–°ç”Ÿæˆâ€æ—¶ï¼Œè°ƒç”¨AIç”Ÿæˆæ¨¡æ‹Ÿç›¸å†Œå†…å®¹
 */
async function handleGenerateSimulatedDiaries() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨è¯·æ±‚â€œ${chat.name}â€ç¿»å¼€TAçš„æ—¥è®°æœ¬...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚');
        return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ·' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'æ— ';
    const recentHistoryWithUser = chat.history.slice(-5).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œä¹¦ã€Š${book.name}ã€‹è®¾å®š:\n${book.content.filter(e=>e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼ºåŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨å’Œæ•…äº‹ä½œå®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæ„å‡ºã€5åˆ°8ç¯‡ã€‘TAæœ€è¿‘å¯èƒ½ä¼šå†™çš„æ—¥è®°ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€æ—¶é—´ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**:
    -   ä»Šå¤©çš„æ—¥æœŸæ˜¯ **${new Date().toLocaleDateString('zh-CN')}**ã€‚
    -   ä½ ç”Ÿæˆçš„ã€æ‰€æœ‰ã€‘æ—¥è®°çš„æ ‡é¢˜æ—¥æœŸï¼Œã€å¿…é¡»ã€‘æ˜¯ä»Šå¤©æˆ–ä»Šå¤©ä»¥å‰çš„æ—¥æœŸã€‚
    -   ã€ç»å¯¹ç¦æ­¢ã€‘ç”Ÿæˆä»»ä½•æœªæ¥çš„æ—¥æœŸï¼
2.  **ã€æ²‰æµ¸æ„Ÿã€‘**: æ¯ä¸€ç¯‡æ—¥è®°éƒ½å¿…é¡»ä½¿ç”¨ã€ç¬¬ä¸€äººç§°è§†è§’ ("æˆ‘")ã€‘æ¥å†™ï¼Œå¹¶ä¸”è¦å……æ»¡è§’è‰²çš„ä¸ªäººæƒ…æ„Ÿã€æ€è€ƒå’Œç§˜å¯†ã€‚åœ¨æ—¥è®°ä¸­æè¿°è‡ªå·±çš„è¡Œä¸ºæˆ–æƒ³æ³•æ—¶ï¼Œã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ç¬¬ä¸‰äººç§°â€œä»–â€æˆ–â€œå¥¹â€ (TA)ã€‚
3.  **ã€é•¿åº¦ã€‘**: æ¯ä¸€ç¯‡æ—¥è®°çš„æ­£æ–‡é•¿åº¦ã€å¿…é¡»ä¸å°‘äº300å­—ã€‘ã€‚
4.  **ã€æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: 
    - ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›å¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€ç¯‡æ—¥è®°ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "title": "è¿™ç¯‡æ—¥è®°çš„æ ‡é¢˜ï¼Œä¾‹å¦‚ï¼š9æœˆ20æ—¥ æ™´",
        "content": "è¿™é‡Œæ˜¯æ—¥è®°çš„è¯¦ç»†æ­£æ–‡ï¼Œå¿…é¡»æ”¯æŒæ¢è¡Œç¬¦\\nï¼Œå¹¶ä¸”å¿…é¡»å·§å¦™åœ°ä½¿ç”¨ä¸‹é¢çš„ã€æ—¥è®°ä¸“å±Markdownè¯­æ³•ã€‘æ¥ä¸°å¯Œæ–‡æœ¬è¡¨ç°åŠ›ã€‚"
      }
    ]
    \`\`\`
5.  **ã€å ä½ç¬¦æ›¿æ¢ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: åœ¨ä½ çš„æ—¥è®°å†…å®¹ä¸­ï¼Œã€ç»å¯¹ä¸èƒ½ã€‘å‡ºç° "{{user}}" è¿™ä¸ªå ä½ç¬¦ã€‚ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ â€œ${userDisplayNameForAI}â€ æ¥æŒ‡ä»£ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰ã€‚
6.  **ã€æ—¥è®°ä¸“å±Markdownè¯­æ³• (å¿…é¡»ä½¿ç”¨ï¼)ã€‘**:
    -   \`**åŠ ç²—æ–‡å­—**\`: ç”¨äºå¼ºè°ƒã€‚
    -   \`~~åˆ’æ‰çš„æ–‡å­—~~\`: ç”¨äºè¡¨ç¤ºæ”¹å˜ä¸»æ„æˆ–è‡ªæˆ‘å¦å®šã€‚
    -   \`!h{é»„è‰²é«˜äº®}\`: ç”¨äºæ ‡è®°å…³é”®è¯æˆ–é‡è¦ä¿¡æ¯ã€‚
    -   \`!u{ç²‰è‰²ä¸‹åˆ’çº¿}\`: ç”¨äºæ ‡æ³¨äººåã€åœ°åæˆ–ç‰¹æ®Šåè¯ã€‚
    -   \`!e{ç²‰è‰²å¼ºè°ƒ}\`: ç”¨äºè¡¨è¾¾å¼ºçƒˆçš„æƒ…ç»ªã€‚
    -   \`!w{æ‰‹å†™ä½“}\`: ç”¨äºå†™ä¸‹å¼•è¨€ã€æ­Œè¯æˆ–ç‰¹æ®Šç¬”è®°ã€‚
    -   \`!m{å‡Œä¹±çš„æ‰‹å†™ä½“}\`: ç”¨äºè¡¨è¾¾æ¿€åŠ¨ã€æ…Œä¹±æˆ–æ½¦è‰è®°å½•æ—¶çš„å¿ƒæƒ…ã€‚
    -   \`||æ¶‚é»‘||\`: ç”¨äºéšè—ç§˜å¯†æˆ–æ•æ„Ÿè¯æ±‡ (æ¯æ¬¡æ¶‚é»‘2~5ä¸ªå­—)ã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•¿æœŸè®°å¿†**:
${longTermMemoryContext}
${worldBookContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å¯¹è¯æ‘˜è¦**:
${recentHistoryWithUser}

ç°åœ¨ï¼Œè¯·å¼€å§‹æ’°å†™è¿™ç»„å……æ»¡çœŸæƒ…å®æ„Ÿã€å¹¶ç†Ÿç»ƒè¿ç”¨äº†Markdownè¯­æ³•çš„æ—¥è®°ã€‚`;
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„æ—¥è®°å†…å®¹ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸å…¼å®¹çš„ response_format å‚æ•° â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 0.95,
                    // response_format: { "type": "json_object" } <-- æ­¤è¡Œå·²è¢«åˆ é™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼ºå¤§çš„å®¹é”™è§£æé€»è¾‘ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedDiaries;
        try {
            simulatedDiaries = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ—¶å‡ºé”™: ${e.message}\n\nAIåŸå§‹è¿”å›å†…å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        
        chat.diary = simulatedDiaries.map(entry => ({
            id: Date.now() + Math.random(),
            title: entry.title,
            content: entry.content,
            timestamp: Date.now()
        }));
        
        await db.chats.put(chat);
        await renderCharDiaryList();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ‹Ÿæ—¥è®°å¤±è´¥:", error);
        await showCustomAlert("ç”Ÿæˆå¤±è´¥", `æ— æ³•ç”Ÿæˆæ—¥è®°ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åå†è¯•ã€‚\né”™è¯¯: ${error.message}`);
    }
}

        /**
         * ã€å…¨æ–°ã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œ+â€æ—¶ï¼Œè§¦å‘AIæ’°å†™ä¸€ç¯‡æ–°æ—¥è®°å¹¶è¿½åŠ åˆ°æœ«å°¾
         */
        async function handleWriteNewDiaryEntry() {
            if (!activeCharacterId) return;
            const chat = state.chats[activeCharacterId];
            if (!chat) return;
        
            await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨è¯·æ±‚â€œ${chat.name}â€å†™ä¸€ç¯‡æ–°æ—¥è®°...`);
        
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;

            const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ·' : state.qzoneSettings.nickname;

            const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'æ— ';
            const recentHistoryWithUser = chat.history.slice(-5).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
            const worldBookContext = (chat.settings.linkedWorldBookIds || []).map(bookId=>state.worldBooks.find(wb=>wb.id===bookId)).filter(Boolean).map(book=>`\n## ä¸–ç•Œä¹¦ã€Š${book.name}ã€‹è®¾å®š:\n${book.content.filter(e=>e.enabled).map(e=>`- ${e.content}`).join('\n')}`).join('');
            
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤1ï¼šåœ¨è¿™é‡Œä¹Ÿæ·»åŠ â€œæ—¶é—´é“å¾‹â€ â–¼â–¼â–¼
            const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨å’Œæ•…äº‹ä½œå®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæ„å‡ºã€1ç¯‡ã€‘TAä»Šå¤©å¯èƒ½ä¼šå†™çš„æ—¥è®°ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€ã€ã€æ—¶é—´é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘ã€‘ã€‘**:
    -   ä»Šå¤©çš„æ—¥æœŸæ˜¯ **${new Date().toLocaleDateString('zh-CN')}**ã€‚
    -   ä½ ç”Ÿæˆçš„æ—¥è®°æ ‡é¢˜æ—¥æœŸã€å¿…é¡»ã€‘æ˜¯ä»Šå¤©æˆ–ä»Šå¤©ä»¥å‰çš„æ—¥æœŸã€‚
    -   ã€ç»å¯¹ç¦æ­¢ã€‘ç”Ÿæˆä»»ä½•æœªæ¥çš„æ—¥æœŸï¼
2.  **ã€ã€ã€æ²‰æµ¸æ„Ÿé“å¾‹ã€‘ã€‘ã€‘**: æ—¥è®°å¿…é¡»ä½¿ç”¨ã€ç¬¬ä¸€äººç§°è§†è§’ ("æˆ‘")ã€‘æ¥å†™ï¼Œå¹¶ä¸”è¦å……æ»¡è§’è‰²çš„ä¸ªäººæƒ…æ„Ÿã€æ€è€ƒå’Œç§˜å¯†ã€‚åœ¨æ—¥è®°ä¸­æè¿°è‡ªå·±çš„è¡Œä¸ºæˆ–æƒ³æ³•æ—¶ï¼Œã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨ç¬¬ä¸‰äººç§°â€œä»–â€æˆ–â€œå¥¹â€ (TA)ã€‚
3.  **ã€ã€ã€é•¿åº¦é“å¾‹ã€‘ã€‘ã€‘**: æ—¥è®°çš„æ­£æ–‡é•¿åº¦ã€å¿…é¡»ä¸å°‘äº300å­—ã€‘ã€‚
4.  **ã€ã€ã€æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œä¸”æ•°ç»„ä¸­ã€åªåŒ…å«ä¸€ä¸ªã€‘å¯¹è±¡ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "title": "è¿™ç¯‡æ—¥è®°çš„æ ‡é¢˜ï¼Œä¾‹å¦‚ï¼š9æœˆ20æ—¥ æ™´",
        "content": "è¿™é‡Œæ˜¯æ—¥è®°çš„è¯¦ç»†æ­£æ–‡ï¼Œå¿…é¡»æ”¯æŒæ¢è¡Œç¬¦\\nï¼Œå¹¶ä¸”å¿…é¡»å·§å¦™åœ°ä½¿ç”¨ä¸‹é¢çš„ã€æ—¥è®°ä¸“å±Markdownè¯­æ³•ã€‘æ¥ä¸°å¯Œæ–‡æœ¬è¡¨ç°åŠ›ã€‚"
      }
    ]
    \`\`\`
5.  **ã€ã€ã€æ—¥è®°ä¸“å±Markdownè¯­æ³• (å¿…é¡»ä½¿ç”¨ï¼)ã€‘ã€‘ã€‘**:
    -   \`**åŠ ç²—æ–‡å­—**\`: ç”¨äºå¼ºè°ƒã€‚
    -   \`~~åˆ’æ‰çš„æ–‡å­—~~\`: ç”¨äºè¡¨ç¤ºæ”¹å˜ä¸»æ„æˆ–è‡ªæˆ‘å¦å®šã€‚
    -   \`!h{é»„è‰²é«˜äº®}\`: ç”¨äºæ ‡è®°å…³é”®è¯æˆ–é‡è¦ä¿¡æ¯ã€‚
    -   \`!u{ç²‰è‰²ä¸‹åˆ’çº¿}\`: ç”¨äºæ ‡æ³¨äººåã€åœ°åæˆ–ç‰¹æ®Šåè¯ã€‚
    -   \`!e{ç²‰è‰²å¼ºè°ƒ}\`: ç”¨äºè¡¨è¾¾å¼ºçƒˆçš„æƒ…ç»ªã€‚
    -   \`!w{æ‰‹å†™ä½“}\`: ç”¨äºå†™ä¸‹å¼•è¨€ã€æ­Œè¯æˆ–ç‰¹æ®Šç¬”è®°ã€‚
    -   \`!m{å‡Œä¹±çš„æ‰‹å†™ä½“}\`: ç”¨äºè¡¨è¾¾æ¿€åŠ¨ã€æ…Œä¹±æˆ–æ½¦è‰è®°å½•æ—¶çš„å¿ƒæƒ…ã€‚
    -   \`||æ¶‚é»‘||\`: ç”¨äºéšè—ç§˜å¯†æˆ–æ•æ„Ÿè¯æ±‡(æ¯æ¬¡æ¶‚é»‘2~5ä¸ªå­—)ã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•¿æœŸè®°å¿†**:
${longTermMemoryContext}
${worldBookContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å¯¹è¯æ‘˜è¦**:
${recentHistoryWithUser}

ç°åœ¨ï¼Œè¯·å¼€å§‹æ’°å†™è¿™ç¯‡å……æ»¡çœŸæƒ…å®æ„Ÿã€å¹¶ç†Ÿç»ƒè¿ç”¨äº†Markdownè¯­æ³•çš„æ—¥è®°ã€‚`;
        
            try {
                const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œå†™ä¸€ç¯‡æ–°æ—¥è®°ã€‚" }];
                let isGemini = proxyUrl.includes('generativelanguage');
                let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
                const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                    body: JSON.stringify({
                        model: model,
                        messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                        temperature: 0.95,
                    })
                });
                if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
                const data = await response.json();
                const aiResponseContent = getGeminiResponseText(data);
                
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤2ï¼šåœ¨è¿™é‡Œä¹Ÿä½¿ç”¨ç»ˆæå®¹é”™è§£ææ–¹æ¡ˆ â–¼â–¼â–¼
                const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
                if (!jsonMatch || !jsonMatch[0]) {
                    throw new Error(`AIè¿”å›çš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
                }
                const cleanedJsonString = jsonMatch[0];
                let newDiaryEntry;
                try {
                    newDiaryEntry = JSON.parse(cleanedJsonString)[0];
                } catch (e) {
                    throw new Error(`è§£æAIè¿”å›çš„JSONæ—¶å‡ºé”™: ${e.message}\n\nAIåŸå§‹è¿”å›å†…å®¹:\n${aiResponseContent}`);
                }
                // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
                
                if (!chat.diary) chat.diary = [];
                
                chat.diary.push({
                    id: Date.now(),
                    title: newDiaryEntry.title,
                    content: newDiaryEntry.content,
                    timestamp: Date.now()
                });
                
                await db.chats.put(chat);
                await renderCharDiaryList();
        
            } catch (error) {
                console.error("ç”Ÿæˆæ–°æ—¥è®°å¤±è´¥:", error);
                await showCustomAlert("ç”Ÿæˆå¤±è´¥", `é”™è¯¯: ${error.message}`);
            }
        }

        /**
         * ã€å…¨æ–° | V2.0ã€‘æ¸²æŸ“Cphoneçš„æ—¥è®°åˆ—è¡¨
         */
        function renderCharDiaryList() {
            const listEl = document.getElementById('char-diary-list');
            listEl.innerHTML = '';
            const char = state.chats[activeCharacterId];
            const diaries = (char.diary || []).slice().reverse();

            if (diaries.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">æ—¥è®°æœ¬è¿˜æ˜¯ç©ºçš„ã€‚</p>';
                return;
            }

            diaries.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="item-title">${entry.title}</div>
                    <div class="item-content">${new Date(entry.timestamp).toLocaleDateString()}</div>
                `;
                item.addEventListener('click', () => viewDiary(entry.id));
                addLongPressListener(item, () => deleteDiary(entry.id));
                listEl.appendChild(item);
            });
        }

    // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ª V2.0 ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ viewDiary å‡½æ•° â–¼â–¼â–¼
    /**
     * ã€V2.0 | æ”¯æŒæ”¶è—ã€‘ç‚¹å‡»æ—¥è®°åˆ—è¡¨é¡¹æ—¶ï¼Œæ‰“å¼€è¯¦æƒ…é¡µé¢æŸ¥çœ‹
     * @param {number} diaryId - è¦æŸ¥çœ‹çš„æ—¥è®°çš„ID
     */
    async function viewDiary(diaryId) {
        const char = state.chats[activeCharacterId];
        if (!char || !char.diary) return;
    
        const entry = char.diary.find(d => d.id === diaryId);
        if (entry) {
            // 1. å°†å½“å‰æ—¥è®°å¯¹è±¡å­˜å…¥å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿æ”¶è—åŠŸèƒ½è°ƒç”¨
            activeDiaryForViewing = entry;
    
            const titleEl = document.getElementById('char-diary-detail-title');
            const contentEl = document.getElementById('char-diary-detail-content');
            const favBtn = document.getElementById('favorite-diary-btn');
    
            titleEl.textContent = entry.title;
            const formattedContent = parseMarkdown(entry.content)
                .split('\n')
                .map(p => `<p>${p || '&nbsp;'}</p>`)
                .join('');
            contentEl.innerHTML = formattedContent;
    
            // 2. æ£€æŸ¥è¿™ç¯‡æ—¥è®°æ˜¯å¦å·²è¢«æ”¶è—ï¼Œå¹¶æ›´æ–°æŒ‰é’®çŠ¶æ€
            const existingFavorite = await db.favorites.where({ type: 'char_diary', 'content.id': diaryId }).first();
            favBtn.classList.toggle('active', !!existingFavorite);
    
            switchToCharScreen('char-diary-detail-screen');
        }
    }
    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ”¶è—/å–æ¶ˆæ”¶è—æ—¥è®°çš„æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼
    /**
     * åˆ‡æ¢å½“å‰æ—¥è®°çš„æ”¶è—çŠ¶æ€
     */
    async function toggleDiaryFavorite() {
        if (!activeDiaryForViewing || !activeCharacterId) return;
    
        const diary = activeDiaryForViewing;
        const char = state.chats[activeCharacterId];
        const favBtn = document.getElementById('favorite-diary-btn');
    
        // å†æ¬¡æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
        const existingFavorite = await db.favorites.where({ type: 'char_diary', 'content.id': diary.id }).first();
    
        if (existingFavorite) {
            // å¦‚æœå·²æ”¶è—ï¼Œåˆ™å–æ¶ˆæ”¶è—
            await db.favorites.delete(existingFavorite.id);
            favBtn.classList.remove('active');
            await showCustomAlert('æ“ä½œæˆåŠŸ', 'å·²å–æ¶ˆæ”¶è—ã€‚');
        } else {
            // å¦‚æœæœªæ”¶è—ï¼Œåˆ™æ‰§è¡Œæ”¶è—
            const newFavorite = {
                type: 'char_diary',
                // å°†æ—¥è®°çš„å®Œæ•´å†…å®¹ï¼Œè¿åŒä½œè€…ä¿¡æ¯ä¸€èµ·å­˜å…¥
                content: {
                    id: diary.id,
                    title: diary.title,
                    content: diary.content,
                    timestamp: diary.timestamp,
                    characterId: activeCharacterId,
                    characterName: char.name
                },
                timestamp: Date.now() // æ”¶è—æ“ä½œçš„æ—¶é—´
            };
            await db.favorites.add(newFavorite);
            favBtn.classList.add('active');
            await showCustomAlert('æ“ä½œæˆåŠŸ', 'å·²æˆåŠŸæ”¶è—åˆ°â€œæˆ‘çš„æ”¶è—â€é¡µé¢ï¼');
        }
    }
    // â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²
        /**
         * ã€å…¨æ–°ã€‘åˆ é™¤ä¸€ç¯‡æ—¥è®°
         * @param {number} diaryId - è¦åˆ é™¤çš„æ—¥è®°çš„ID
         */
        async function deleteDiary(diaryId) {
            const confirmed = await showCustomConfirm('åˆ é™¤æ—¥è®°', 'ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                const char = state.chats[activeCharacterId];
                char.diary = char.diary.filter(d => d.id !== diaryId);
                await db.chats.put(char);
                renderCharDiaryList();
            }
        }

        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–° V2.3 | å¤´åƒæ¥æºç»ˆæä¿®å¤ç‰ˆã€‘æ¸²æŸ“è§’è‰²è§†è§’çš„QQèŠå¤©åˆ—è¡¨
 */
async function renderCharSimulatedQQ() {
    const listEl = document.getElementById('char-chat-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    
    if (!char || !char.simulatedConversations || char.simulatedConversations.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ï¼Œ<br>çœ‹çœ‹TAæœ€è¿‘éƒ½å’Œè°èŠå¤©äº†å§ï¼</p>';
        return;
    }

    const userConvoIndex = char.simulatedConversations.findIndex(c => c.type === 'private_user');
    if (userConvoIndex > 0) {
        const userConvo = char.simulatedConversations.splice(userConvoIndex, 1)[0];
        char.simulatedConversations.unshift(userConvo);
    }

    char.simulatedConversations.forEach((convo, index) => {
        const item = document.createElement('div');
        item.className = 'chat-list-item';
        item.dataset.conversationIndex = index;

        const lastMessage = convo.messages.slice(-1)[0] || { content: '...' };

        let avatarHtml, displayName;
        
        if (convo.type === 'private_user') {
            displayName = convo.userRemarkName || (state.qzoneSettings.nickname || 'æˆ‘');
            
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œï¼ â–¼â–¼â–¼
            // æˆ‘ä»¬ä¸å†ä»å…¨å±€è®¾ç½®å–å¤´åƒï¼Œè€Œæ˜¯ä»å½“å‰è§’è‰²çš„èŠå¤©è®¾ç½®é‡Œå–â€œæˆ‘çš„å¤´åƒâ€
            const myAvatar = char.settings.myAvatar || defaultAvatar; 
            const myFrame = char.settings.myAvatarFrame || '';
            // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
            
            if (myFrame) {
                 avatarHtml = `<div class="avatar-group has-frame" style="width: 45px; height: 45px;">
                                 <div class="avatar-with-frame" style="width: 45px; height: 45px;">
                                     <img src="${myAvatar}" class="avatar-img" style="border-radius: 50%;">
                                     <img src="${myFrame}" class="avatar-frame">
                                 </div>
                               </div>`;
            } else {
                 avatarHtml = `<div class="avatar-group" style="width: 45px; height: 45px;">
                                 <img src="${myAvatar}" class="avatar" style="border-radius: 50%; width: 45px; height: 45px;">
                               </div>`;
            }

        } else if (convo.type === 'group') {
            displayName = convo.groupName + ` <span class="group-tag">ç¾¤</span>`;
            const groupAvatarPrompt = `logo, simple, flat design, for a group chat named '${convo.groupName}'`;
            const avatarUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(groupAvatarPrompt)}`;
            avatarHtml = `<div class="avatar-group"><img src="${avatarUrl}" class="avatar" style="border-radius: 50%;"></div>`;
        
        } else { // ä¸NPCçš„ç§èŠ
            displayName = convo.participant.name;
            const npcAvatarPrompt = convo.participant.avatar_prompt || 'anime person';
            const avatarUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(npcAvatarPrompt)}`;
            avatarHtml = `<div class="avatar-group"><img src="${avatarUrl}" class="avatar" style="border-radius: 50%;"></div>`;
        }

        item.innerHTML = `
            ${avatarHtml}
            <div class="info">
                <div class="name-line">
                    <span class="name">${displayName}</span>
                </div>
                <div class="last-msg">${String(lastMessage.content).substring(0, 20)}...</div>
            </div>
        `;
        listEl.appendChild(item);
    });
}

/**
 * ã€å…¨æ–° | V2.2 AIç»˜å›¾ç‰ˆã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œé‡æ–°ç”Ÿæˆâ€æ—¶ï¼Œè°ƒç”¨AIç”Ÿæˆæ¨¡æ‹Ÿå¯¹è¯
 */
async function handleGenerateSimulatedQQ() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];

    if (!chat) {
        console.error("æ— æ³•ç”Ÿæˆæ¨¡æ‹Ÿå¯¹è¯ï¼Œå› ä¸ºæ‰¾ä¸åˆ°å½“å‰è§’è‰² (activeCharacterId: " + activeCharacterId + ")");
        await showCustomAlert("æ“ä½œå¤±è´¥", "æ— æ³•æ‰¾åˆ°å½“å‰è§’è‰²çš„æ•°æ®ï¼Œè¯·å°è¯•è¿”å›å¹¶é‡æ–°é€‰æ‹©è§’è‰²ã€‚");
        return;
    }

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨æ ¹æ®â€œ${chat.name}â€çš„è®°å¿†å’Œäººè®¾ï¼Œç”Ÿæˆæœ€è¿‘çš„ç¤¾äº¤åŠ¨æ€...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚');
        return;
    }
    
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ·' : state.qzoneSettings.nickname;

    let worldBookContext = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds
            .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
            .filter(Boolean)
            .map(book => `\n## ä¸–ç•Œä¹¦ã€Š${book.name}ã€‹è®¾å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
            .join('');
        if (linkedContents) {
            worldBookContext = `\n\n# ä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}`;
        }
    }

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0
        ? `# ä½ çš„é•¿æœŸè®°å¿† (å·²å‘ç”Ÿçš„äº‹å®)\n${chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n')}`
        : '';
    
    const recentHistoryWithUser = chat.history.slice(-10).map(msg => {
        const sender = msg.role === 'user' ? userDisplayNameForAI : chat.name;
        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
    }).join('\n');

    const characterOriginalName = chat.originalName || chat.name;

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼ºåŒ–AIæŒ‡ä»¤ï¼Œç¡®ä¿åœ¨æ²¡æœ‰å¼ºåˆ¶JSONæ¨¡å¼ä¸‹ä¹Ÿèƒ½ç¨³å®šè¾“å‡º â–¼â–¼â–¼
     const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç¤¾äº¤ç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæ„å‡ºã€5åˆ°7æ®µã€‘TAæœ€è¿‘å¯èƒ½å‘ç”Ÿçš„QQèŠå¤©è®°å½•ã€‚è¿™äº›è®°å½•ä¸­ã€å¿…é¡»åŒ…å«ä¸€æ®µä¸ç”¨æˆ·çš„ç§èŠã€‘ï¼Œå…¶ä½™å¯ä»¥æ˜¯ä¸å…¶ä»–NPCçš„ç§èŠæˆ–ç¾¤èŠã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€ä¸ç”¨æˆ·çš„å¯¹è¯ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: ä½ çš„ç”Ÿæˆç»“æœä¸­ï¼Œã€å¿…é¡»ä¸”åªèƒ½åŒ…å«ä¸€ä¸ªã€‘ä¸ç”¨æˆ·ï¼ˆå³â€œæˆ‘â€ï¼‰çš„ç§èŠè®°å½•ã€‚
2.  **åˆ›é€ æ€§ä¸å¤šæ ·æ€§**: è‡ªç”±åˆ›é€ ç¬¦åˆè§’è‰²èƒŒæ™¯çš„NPCå’Œç¾¤èŠï¼Œå¯¹è¯å†…å®¹è¦å¤šæ ·åŒ–ï¼Œåæ˜ è§’è‰²çš„ç”Ÿæ´»ã€‚
3.  **å…³è”æ€§**: å¯¹è¯å†…å®¹åº”å·§å¦™åœ°åæ˜ è§’è‰²çš„é•¿æœŸè®°å¿†ã€ä¸–ç•Œè§‚ï¼Œä»¥åŠä¸ç”¨æˆ·äº’åŠ¨å¯èƒ½å¸¦æ¥çš„å¿ƒæƒ…å˜åŒ–ã€‚
4.  **ç®€æ´æ€§**: æ¯æ®µå¯¹è¯çš„æ€»é•¿åº¦åº”åœ¨8åˆ°15å¥ä¹‹é—´ã€‚
5.  **ã€æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: 
    - ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›å¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä»£è¡¨ä¸€æ®µå¯¹è¯ï¼Œä¸”ã€å¿…é¡»ã€‘æ˜¯ä»¥ä¸‹ä¸‰ç§æ ¼å¼ä¹‹ä¸€ï¼š

    **æ ¼å¼ Aï¼šä¸ç”¨æˆ·çš„ç§èŠ (å¿…é¡»æœ‰1ä¸ª)**
    \`\`\`json
    {
      "type": "private_user",
      "userRemarkName": "ä½ ä¸ºç”¨æˆ·èµ·çš„ä¸“å±å¤‡æ³¨å",
      "messages": [
        { "sender": "${characterOriginalName}", "content": "ä½ å¯¹ç”¨æˆ·è¯´çš„è¯" },
        { "sender": "${userDisplayNameForAI}", "content": "ç”¨æˆ·å¯¹ä½ è¯´çš„è¯" }
      ]
    }
    \`\`\`

    **æ ¼å¼ Bï¼šä¸NPCçš„ç§èŠ**
    \`\`\`json
    {
      "type": "private_npc",
      "participant": {
        "name": "NPCçš„åå­—",
        "avatar_prompt": "ä¸€æ®µç”¨äºç”Ÿæˆå¤´åƒçš„ã€è‹±æ–‡ã€‘å…³é”®è¯, é£æ ¼ä¸ºåŠ¨æ¼«/æ’ç”»/äºŒæ¬¡å…ƒç­‰, ç¦æ­¢çœŸäºº"
      },
      "messages": [
        { "sender": "${characterOriginalName}", "content": "å¯¹è¯å†…å®¹1" },
        { "sender": "NPCçš„åå­—", "content": "å¯¹è¯å†…å®¹2" }
      ]
    }
    \`\`\`

    **æ ¼å¼ Cï¼šç¾¤èŠ**
    \`\`\`json
    {
      "type": "group",
      "groupName": "ä¸–ç•Œä¹¦ä¸­æåˆ°çš„æˆ–ä½ è™šæ„çš„ç¾¤å",
      "participants": [
        { "name": "NPCæˆå‘˜1", "avatar_prompt": "æˆå‘˜1çš„å¤´åƒã€è‹±æ–‡ã€‘å…³é”®è¯" },
        { "name": "NPCæˆå‘˜2", "avatar_prompt": "æˆå‘˜2çš„å¤´åƒã€è‹±æ–‡ã€‘å…³é”®è¯" }
      ],
      "messages": [
        { "sender": "${characterOriginalName}", "content": "æˆ‘åœ¨ç¾¤é‡Œè¯´çš„è¯" },
        { "sender": "NPCæˆå‘˜1", "content": "æˆå‘˜1å›å¤æˆ‘" }
      ]
    }
    \`\`\`
    - **é‡è¦**: \`messages\` æ•°ç»„ä¸­çš„ \`sender\` å­—æ®µï¼Œã€å¿…é¡»ã€‘ä½¿ç”¨è§’è‰²çš„ã€æœ¬åã€‘("${characterOriginalName}")ã€NPCçš„åå­—ã€æˆ–ç”¨æˆ·çš„åå­—("${userDisplayNameForAI}")ã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
${longTermMemoryContext}
${worldBookContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å¯¹è¯æ‘˜è¦**:
${recentHistoryWithUser}

ç°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆæ¨¡æ‹ŸèŠå¤©è®°å½•ã€‚`;
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆæ¨¡æ‹ŸèŠå¤©è®°å½•ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸å…¼å®¹çš„ response_format å‚æ•° â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 0.9
                    // response_format: { "type": "json_object" }  <-- è¿™è¡Œå·²è¢«åˆ é™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼ºå¤§çš„å®¹é”™è§£æé€»è¾‘ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);

        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }

        const cleanedJsonString = jsonMatch[0];
        let simulatedConversations;
        try {
            simulatedConversations = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ—¶å‡ºé”™: ${e.message}\n\nAIåŸå§‹è¿”å›å†…å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        
        chat.simulatedConversations = simulatedConversations;
        await db.chats.put(chat);
        
        await renderCharSimulatedQQ();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ‹ŸèŠå¤©å¤±è´¥:", error);
        await showCustomAlert("ç”Ÿæˆå¤±è´¥", `æ— æ³•ç”Ÿæˆæ¨¡æ‹ŸèŠå¤©è®°å½•ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åå†è¯•ã€‚\né”™è¯¯: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–° | V2.4 | ä¸“å±å¤´åƒç»ˆæä¿®å¤ç‰ˆã€‘æ‰“å¼€å¹¶æ˜¾ç¤ºæŒ‡å®šçš„æ¨¡æ‹ŸèŠå¤©è®°å½•
 * @param {number} conversationIndex - åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
 */
async function openCharSimulatedConversation(conversationIndex) {
    const mainChar = state.chats[activeCharacterId];
    const conversation = mainChar.simulatedConversations[conversationIndex];
    if (!conversation) return;

    const titleEl = document.getElementById('char-conversation-partner-name');
    const bodyEl = document.getElementById('char-conversation-messages');
    const inputEl = document.getElementById('char-simulated-input');

    bodyEl.innerHTML = '';
    bodyEl.dataset.theme = mainChar.settings.theme || 'default';
    const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
    bodyEl.style.backgroundColor = isDarkMode ? '#000000' : '#f0f2f5';

    let tempChatObjectForRendering;
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ·' : state.qzoneSettings.nickname;
    
    if (conversation.type === 'private_user') {
        titleEl.textContent = conversation.userRemarkName;
        inputEl.placeholder = `ä¸ ${conversation.userRemarkName} çš„å¯¹è¯`;

        tempChatObjectForRendering = {
            id: 'temp_user_chat', isGroup: false,
            name: conversation.userRemarkName,
            originalName: mainChar.originalName,
            settings: {
                ...mainChar.settings,
                myAvatar: mainChar.settings.aiAvatar,
                myAvatarFrame: mainChar.settings.aiAvatarFrame,
                
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œï¼ â–¼â–¼â–¼
                // æˆ‘ä»¬ä¸å†ä»å…¨å±€è®¾ç½®å–å¤´åƒï¼Œè€Œæ˜¯ä»å½“å‰è§’è‰²çš„èŠå¤©è®¾ç½®é‡Œå–â€œæˆ‘çš„å¤´åƒâ€
                aiAvatar: mainChar.settings.myAvatar,
                // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
                
                aiAvatarFrame: mainChar.settings.myAvatarFrame
            }
        };

    } else if (conversation.type === 'group') {
        titleEl.textContent = `${conversation.groupName} (${conversation.participants.length + 1})`;
        inputEl.placeholder = `åœ¨ ${conversation.groupName} ä¸­èŠå¤©`;

        tempChatObjectForRendering = {
            id: 'temp_group_chat', isGroup: true,
            name: conversation.groupName,
            originalName: mainChar.originalName,
            members: conversation.participants.map(p => ({
                originalName: p.name,
                groupNickname: p.name,
                avatar: `https://image.pollinations.ai/prompt/${encodeURIComponent(p.avatar_prompt || 'anime person')}`
            })),
            settings: {
                ...mainChar.settings,
                myNickname: mainChar.name,
                myAvatar: mainChar.settings.aiAvatar,
                myAvatarFrame: mainChar.settings.aiAvatarFrame,
            }
        };

    } else { // ä¸NPCçš„ç§èŠ
        titleEl.textContent = conversation.participant.name;
        inputEl.placeholder = `ä¸ ${conversation.participant.name} çš„å¯¹è¯`;

        tempChatObjectForRendering = {
            id: 'temp_npc_chat', isGroup: false,
            name: conversation.participant.name,
            originalName: mainChar.originalName,
            settings: {
                ...mainChar.settings,
                myAvatar: mainChar.settings.aiAvatar,
                myAvatarFrame: mainChar.settings.aiAvatarFrame,
                aiAvatar: `https://image.pollinations.ai/prompt/${encodeURIComponent(conversation.participant.avatar_prompt || 'anime person')}`,
                aiAvatarFrame: ''
            }
        };
    }
    
    for (const msg of conversation.messages) {
        const isFromMainChar = msg.sender === (mainChar.originalName || mainChar.name);
        const isFromUser = msg.sender === userDisplayNameForAI;

        let role;
        
        if (conversation.type === 'private_user') {
            role = isFromUser ? 'assistant' : 'user';
        } else {
            role = isFromMainChar ? 'user' : 'assistant';
        }
        
        const tempMessageObject = {
            role: role,
            senderName: msg.sender,
            content: msg.content,
            timestamp: Date.now() + Math.random()
        };

        const bubbleElement = await createMessageElement(tempMessageObject, tempChatObjectForRendering);
        
        if (bubbleElement) {
            bodyEl.appendChild(bubbleElement);
        }
    }

    switchToCharScreen('char-qq-conversation-screen');
    bodyEl.scrollTop = bodyEl.scrollHeight;
}
/**
 * ã€å…¨æ–°ã€‘å…³é—­æ¨¡æ‹ŸèŠå¤©è®°å½•å¼¹çª—
 */
function closeSimulatedTranscriptModal() {
    document.getElementById('char-qq-transcript-modal').classList.remove('visible');
}

// â–²â–²â–² å…¨æ–°JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–° | V3.0 AIæŒ‡ä»¤å¼ºåŒ–ç‰ˆã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œé‡æ–°ç”Ÿæˆâ€æ—¶ï¼Œè°ƒç”¨AIç”Ÿæˆæ¨¡æ‹Ÿç›¸å†Œå†…å®¹
 */
async function handleGenerateSimulatedAlbum() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];

    if (!chat) {
        await showCustomAlert("æ“ä½œå¤±è´¥", "æ— æ³•æ‰¾åˆ°å½“å‰è§’è‰²çš„æ•°æ®ã€‚");
        return;
    }

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨è¯·æ±‚â€œ${chat.name}â€å›å¿†TAçš„ç›¸å†Œç…§ç‰‡...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚');
        return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ·' : state.qzoneSettings.nickname;
    
    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'æ— ';
    const recentHistoryWithUser = chat.history.slice(-5).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œä¹¦ã€Š${book.name}ã€‹è®¾å®š:\n${book.content.filter(e=>e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼ºåŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œæ„æ€å‡ºã€8åˆ°10å¼ ã€‘TAæœ€è¿‘å¯èƒ½ä¼šæ‹æ‘„æˆ–çè—åœ¨æ‰‹æœºç›¸å†Œé‡Œçš„ç…§ç‰‡ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åˆ›é€ æ€§ä¸åˆç†æ€§**: ç…§ç‰‡å†…å®¹å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½ã€èŒä¸šå’Œç”Ÿæ´»ç¯å¢ƒã€‚
2.  **å¤šæ ·æ€§**: ç…§ç‰‡ä¸»é¢˜è¦ä¸°å¯Œï¼Œå¯ä»¥åŒ…æ‹¬è‡ªæ‹ã€é£æ™¯ã€é£Ÿç‰©ã€å® ç‰©ã€æœ‹å‹åˆå½±ã€å·¥ä½œåœºæ™¯ç­‰ã€‚
3.  **æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)**: 
    - ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›å¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€å¼ ç…§ç‰‡ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "description": "è¿™æ˜¯ç…§ç‰‡èƒŒåçš„æ•…äº‹æˆ–è§’è‰²çš„å¿ƒæƒ…æ—¥è®°ï¼Œå¿…é¡»ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€æ¥å†™ã€‚",
        "image_prompt": "ä¸€æ®µç”¨äºç”Ÿæˆè¿™å¼ ç…§ç‰‡çš„ã€è¯¦ç»†çš„ã€è‹±æ–‡ã€‘å…³é”®è¯ã€‚"
      }
    ]
    \`\`\`
    - **ã€image_prompt ç»å¯¹ç¦æ­¢ã€‘**: ç»å¯¹ç¦æ­¢åŒ…å«ä»»ä½•ä¸­æ–‡å­—ç¬¦ã€å¥å­ã€ç‰¹æ®Šç¬¦å·ã€æˆ–ä»»ä½•å¯èƒ½æ¶‰åŠæ•æ„Ÿï¼ˆNSFWï¼‰ã€æš´åŠ›ã€è¡€è…¥ã€æ”¿æ²»çš„å†…å®¹ï¼ä¹Ÿç¦æ­¢çœŸäººï¼
    - **ã€image_prompt å¿…é¡»æ˜¯ã€‘**: å¿…é¡»æ˜¯çº¯è‹±æ–‡çš„ã€ç”¨é€—å·åˆ†éš”çš„ã€å…³é”®è¯ç»„åˆã€‘ (e.g., "1boy, solo, basketball jersey, in locker room, smiling, selfie")ã€‚
    - **ã€ç”»é£æŒ‡ä»¤ã€‘**: åœ¨ prompt çš„æœ«å°¾ï¼Œæ€»æ˜¯åŠ ä¸Šç”»é£æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š \`best quality, masterpiece, anime style, cinematic lighting\`

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
${longTermMemoryContext}
${worldBookContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å¯¹è¯æ‘˜è¦**:
${recentHistoryWithUser}

ç°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆè¿™ç»„ç…§ç‰‡çš„æè¿°å’Œç»˜ç”»æŒ‡ä»¤ã€‚`;
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„ç›¸å†Œå†…å®¹ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸å…¼å®¹çš„ response_format å‚æ•° â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 0.9
                    // response_format: { "type": "json_object" }  <-- æ­¤è¡Œå·²è¢«åˆ é™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼ºå¤§çš„å®¹é”™è§£æé€»è¾‘ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedAlbumData;
        try {
            simulatedAlbumData = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ—¶å‡ºé”™: ${e.message}\n\nAIåŸå§‹è¿”å›å†…å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        
        chat.simulatedAlbum = simulatedAlbumData;
        await db.chats.put(chat);
        
        await renderCharAlbum();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ‹Ÿç›¸å†Œå¤±è´¥:", error);
        await showCustomAlert("ç”Ÿæˆå¤±è´¥", `æ— æ³•ç”Ÿæˆæ¨¡æ‹Ÿç›¸å†Œï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åå†è¯•ã€‚\né”™è¯¯: ${error.message}`);
    }
}


        // â–¼â–¼â–¼ ã€V3.3 | é€»è¾‘ç»ˆæä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ renderCharAlbum å‡½æ•° â–¼â–¼â–¼
        /**
         * ã€å…¨æ–° | V3.2 ç»ˆæé˜²ç©ºçª—+ç”Ÿå›¾å¼€å…³+æè¿°æ˜¾ç¤ºç‰ˆã€‘æ¸²æŸ“è§’è‰²ç›¸å†Œ
         */
        async function renderCharAlbum() {
            const gridEl = document.getElementById('char-album-grid');
            gridEl.innerHTML = '';
            if (!activeCharacterId) return;
            const char = state.chats[activeCharacterId];
        
            const photos = char.simulatedAlbum || [];
        
            if (photos.length === 0) {
                gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAçš„ç›¸å†Œè¿˜æ˜¯ç©ºçš„ï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›ç…§ç‰‡å§ï¼</p>';
                return;
            }
        
            const fallbackImageUrl = `https://i.postimg.cc/KYr2qRCK/1.jpg`;

            photos.forEach(photo => {
                const item = document.createElement('div');
                item.className = 'char-photo-item';
                item.dataset.description = photo.description;
                gridEl.appendChild(item);

                // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
                //            è¿™å°±æ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒæ‰€åœ¨ï¼
                //  æˆ‘ä»¬ç°åœ¨ç¡®ä¿äº†ä¸¤ç§æƒ…å†µçš„é€»è¾‘æ˜¯å®Œå…¨ç‹¬ç«‹çš„ã€‚
                // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
                
                // 1. æ£€æŸ¥å…¨å±€çš„ç”Ÿå›¾å¼€å…³æ˜¯å¦å¼€å¯
                if (state.globalSettings.enableAiDrawing) {
                    // --- å¦‚æœå¼€å…³ã€å¼€å¯ã€‘ï¼Œåˆ™åªæ‰§è¡Œç”Ÿå›¾ç›¸å…³çš„é€»è¾‘ ---
                    item.style.backgroundColor = '#e9ecef';
                    const containsNonEnglish = /[^\x00-\x7F]/.test(photo.image_prompt);
                    const isValidPrompt = photo.image_prompt && photo.image_prompt.trim() && !containsNonEnglish;
                    const finalPrompt = isValidPrompt ? photo.image_prompt : 'a beautiful scenery, anime style, cinematic lighting';
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}`;
                    
                    const img = new Image();
                    img.onload = function() { item.style.backgroundImage = `url(${this.src})`; };
                    img.onerror = function() { item.style.backgroundImage = `url(${fallbackImageUrl})`; };
                    img.src = imageUrl;

                } else {
                    // --- å¦‚æœå¼€å…³ã€å…³é—­ã€‘ï¼Œåˆ™åªæ‰§è¡Œæ˜¾ç¤ºæ–‡å­—æè¿°çš„é€»è¾‘ ---
                    item.style.backgroundColor = '#f0f2f5';
                    item.style.border = '1px solid #e0e0e0';
                    
                    const descriptionEl = document.createElement('p');
                    descriptionEl.className = 'char-photo-description';
                    descriptionEl.textContent = photo.description || '(è¿™å¼ ç…§ç‰‡æ²¡æœ‰æè¿°)';
                    
                    item.appendChild(descriptionEl);
                }
            });
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–° | V2.2 | JSONè§£æç»ˆæä¿®å¤ç‰ˆã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œé‡æ–°ç”Ÿæˆâ€æ—¶ï¼Œè°ƒç”¨AIç”Ÿæˆæ¨¡æ‹Ÿæµè§ˆå™¨å†å²
 */
async function handleGenerateBrowserHistory() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨æ¨¡æ‹Ÿâ€œ${chat.name}â€çš„ç½‘ä¸Šå†²æµªè¶³è¿¹...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå†…å®¹ã€‚');
        return;
    }
    
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ·' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'æ— ';
    const recentHistoryWithUser = chat.history.slice(-5).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œä¹¦ã€Š${book.name}ã€‹è®¾å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼ºåŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæ„å‡ºã€10åˆ°20æ¡ã€‘TAæœ€è¿‘çš„æµè§ˆå™¨æœç´¢/æµè§ˆè®°å½•ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åˆ›é€ æ€§ä¸åˆç†æ€§**: è®°å½•å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½ã€èŒä¸šå’Œç”Ÿæ´»ç¯å¢ƒã€‚
2.  **å¤šæ ·æ€§**: è®°å½•ç±»å‹è¦ä¸°å¯Œï¼Œå¯ä»¥æ˜¯å¸–å­ã€æ–‡ç« ã€æ–°é—»ã€é—®ç­”ç­‰ã€‚
3.  **ã€æ ¼å¼ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: 
    - ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›å¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä»£è¡¨ä¸€æ¡æµè§ˆè®°å½•ï¼Œå¹¶ä¸”ã€å¿…é¡»ã€‘ä½¿ç”¨ä»¥ä¸‹æ ¼å¼:
    \`\`\`json
    [
      {
        "type": "text",
        "title": "ä¸€ä¸ªå¼•äººæ³¨ç›®çš„æ–‡ç« æˆ–æœç´¢æ ‡é¢˜",
        "url": "ä¸€ä¸ªè™šæ„çš„ã€çœ‹èµ·æ¥å¾ˆçœŸå®çš„ç½‘å€",
        "content": "ä¸€ç¯‡200-400å­—çš„ã€è¯¦ç»†çš„æ–‡ç« æˆ–å¸–å­æ­£æ–‡ï¼Œæ”¯æŒæ¢è¡Œç¬¦\\nã€‚"
      }
    ]
    \`\`\`
    
    **ã€ç»å¯¹ç¦æ­¢ã€‘**: ä½ çš„å›å¤ä¸­ã€ç»å¯¹ä¸èƒ½ã€‘åŒ…å« "type": "image" çš„å¯¹è±¡ã€‚æ‰€æœ‰è®°å½•éƒ½å¿…é¡»æ˜¯æ–‡å­—å†…å®¹ã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•¿æœŸè®°å¿†**:
${longTermMemoryContext}
${worldBookContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å¯¹è¯æ‘˜è¦**:
${recentHistoryWithUser}

ç°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆè¿™ç»„ã€çº¯æ–‡æœ¬ã€‘çš„æµè§ˆè®°å½•ã€‚`;
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„æµè§ˆå™¨è®°å½•ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸å…¼å®¹çš„ response_format å‚æ•° â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 0.9
                    // response_format: { "type": "json_object" } <-- æ­¤è¡Œå·²è¢«åˆ é™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼ºå¤§çš„å®¹é”™è§£æé€»è¾‘ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedHistory;
        try {
            simulatedHistory = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ—¶å‡ºé”™: ${e.message}\n\nAIåŸå§‹è¿”å›å†…å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        
        chat.simulatedBrowserHistory = simulatedHistory;
        await db.chats.put(chat);
        
        await renderCharBrowserHistory();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ‹Ÿæµè§ˆå™¨å†å²å¤±è´¥:", error);
        await showCustomAlert("ç”Ÿæˆå¤±è´¥", `æ— æ³•ç”Ÿæˆæµè§ˆè®°å½•ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åå†è¯•ã€‚\né”™è¯¯: ${error.message}`);
    }
}
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–° | V2.0 åŠ¨æ€æ•°æ®ç‰ˆã€‘æ¸²æŸ“è§’è‰²çš„æµè§ˆå™¨å†å²è®°å½•åˆ—è¡¨
 */
function renderCharBrowserHistory() {
    const listEl = document.getElementById('char-browser-history');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const history = char.simulatedBrowserHistory || [];

    if (history.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAçš„æµè§ˆå™¨ç©ºç©ºå¦‚ä¹Ÿï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›è®°å½•å§ï¼</p>';
        return;
    }

    history.forEach((item, index) => {
        const entryEl = document.createElement('div');
        entryEl.className = 'char-browser-item';
        entryEl.innerHTML = `
            <div class="title">${item.title}</div>
            <div class="url">${item.url}</div>
        `;
        // ä¸ºæ¯ä¸ªåˆ—è¡¨é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œå¹¶ä¼ å…¥å®ƒåœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
        entryEl.addEventListener('click', () => openCharArticle(index));
        listEl.appendChild(entryEl);
    });
}

/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€æ–‡ç« æŸ¥çœ‹é¡µé¢
 * @param {number} index - è¢«ç‚¹å‡»çš„å†å²è®°å½•åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
 */
function openCharArticle(index) {
    const char = state.chats[activeCharacterId];
    const articleData = char.simulatedBrowserHistory[index];
    if (!articleData) return;
    
    // æ¸²æŸ“æ–‡ç« å†…å®¹å¹¶åˆ‡æ¢åˆ°æ–‡ç« å±å¹•
    renderCharArticle(articleData);
    switchToCharScreen('char-browser-article-screen');
}

        /**
         * ã€å…¨æ–°ã€‘æ ¹æ®æ–‡ç« æ•°æ®æ¸²æŸ“æ–‡ç« æŸ¥çœ‹é¡µé¢
         * @param {object} articleData - å•æ¡å†å²è®°å½•çš„æ•°æ®å¯¹è±¡
         */
        function renderCharArticle(articleData) {
            const titleEl = document.getElementById('char-article-title');
            const contentEl = document.getElementById('char-article-content');
            
            titleEl.textContent = articleData.title;
            contentEl.innerHTML = ''; 


            // æˆ‘ä»¬ä¸å†æ£€æŸ¥ç”Ÿå›¾å¼€å…³ï¼Œè€Œæ˜¯ç›´æ¥åˆ¤æ–­è®°å½•ç±»å‹ã€‚
            // å¦‚æœæ˜¯å›¾ç‰‡ç±»å‹ï¼Œå°±æ˜¾ç¤ºæ ‡é¢˜ä½œä¸ºå†…å®¹ã€‚
            if (articleData.type === 'image') {
                contentEl.innerHTML = `<p class="char-browser-image-description">${articleData.title || '(æ— æ ‡é¢˜)'}</p>`;
            } else {
                // å¦‚æœæ˜¯æ–‡æœ¬ç±»å‹ï¼Œæ­£å¸¸æ˜¾ç¤ºå†…å®¹ã€‚
                contentEl.innerHTML = `<p>${(articleData.content || 'å†…å®¹åŠ è½½å¤±è´¥...').replace(/\n/g, '</p><p>')}</p>`;
            }
            // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–²â–²â–² å…¨æ–°JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–° | V3.2 | ç»ˆæç½‘ç»œä¸é€»è¾‘ä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleGenerateTaobaoHistory å‡½æ•°
 */
async function handleGenerateTaobaoHistory() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨æ¨¡æ‹Ÿâ€œ${chat.name}â€çš„è´­ç‰©ä¹ æƒ¯...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚');
        return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ·' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'æ— ';
    const recentHistoryWithUser = chat.history.slice(-5).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œä¹¦ã€Š${book.name}ã€‹è®¾å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼ºåŒ–AIæŒ‡ä»¤ï¼Œç¡®ä¿åœ¨æ²¡æœ‰å¼ºåˆ¶JSONæ¨¡å¼ä¸‹ä¹Ÿèƒ½ç¨³å®šè¾“å‡º â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæ„å‡ºã€12åˆ°20æ¡ã€‘TAæœ€è¿‘çš„æ·˜å®è´­ç‰©è®°å½•ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åˆç†æ€§**: è´­ä¹°è®°å½•å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½å’Œç»æµçŠ¶å†µã€‚
2.  **æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªã€å•ä¸€çš„JSONå¯¹è±¡ã€‘ã€‚ä½ çš„å›å¤å¿…é¡»ä»¥ \`{\` å¼€å§‹ï¼Œå¹¶ä»¥ \`}\` ç»“æŸã€‚ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONå¯¹è±¡å‰åæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šæˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    \`\`\`json
    {
      "purchases": [
        {
          "itemName": "ä¸€ä¸ªå…·ä½“ã€ç”ŸåŠ¨çš„å•†å“åç§°",
          "price": 128.80,
          "status": "å·²ç­¾æ”¶",
          "reason": "è¿™æ˜¯è§’è‰²è´­ä¹°è¿™ä»¶å•†å“çš„å†…å¿ƒç‹¬ç™½æˆ–ç†ç”±ï¼Œå¿…é¡»ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€æ¥å†™ã€‚",
          "image_prompt": "ä¸€æ®µç”¨äºç”Ÿæˆè¿™å¼ å•†å“å›¾ç‰‡çš„ã€è¯¦ç»†çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, é£æ ¼ä¸º realistic product photo, high quality, on a clean white background"
        }
      ]
    }
    \`\`\`
    - **purchases**: ä¸€ä¸ªåŒ…å«12åˆ°15ä¸ªå•†å“å¯¹è±¡çš„æ•°ç»„ã€‚
    - **status (è®¢å•çŠ¶æ€)**: åªèƒ½ä» "å·²ç­¾æ”¶", "å¾…å‘è´§", "è¿è¾“ä¸­", "å¾…è¯„ä»·" ä¸­é€‰æ‹©ã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•¿æœŸè®°å¿†**:
${longTermMemoryContext}
${worldBookContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å¯¹è¯æ‘˜è¦**:
${recentHistoryWithUser}

ç°åœ¨ï¼Œè¯·ç”ŸæˆåŒ…å«è´­ä¹°è®°å½•çš„JSONå¯¹è±¡ã€‚`;
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„æ·˜å®è´­ä¹°è®°å½•ã€‚" }];
        
        let isGemini = proxyUrl.includes('generativelanguage.googleapis.com');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸å…¼å®¹çš„ response_format å‚æ•° â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 0.9
                    // response_format: { "type": "json_object" }  <-- è¿™è¡Œå·²è¢«åˆ é™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼ºå¤§çš„å®¹é”™è§£æé€»è¾‘ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/({[\s\S]*})/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONå¯¹è±¡ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedTaobaoData;
        try {
            simulatedTaobaoData = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ—¶å‡ºé”™: ${e.message}\n\nAIåŸå§‹è¿”å›å†…å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        
        chat.simulatedTaobaoHistory = simulatedTaobaoData;
        await db.chats.put(chat);
        
        await renderCharTaobao();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ‹Ÿæ·˜å®è®°å½•å¤±è´¥:", error);
        await showCustomAlert("ç”Ÿæˆå¤±è´¥", `æ— æ³•ç”Ÿæˆè´­ç‰©è®°å½•ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åå†è¯•ã€‚\né”™è¯¯: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€å¹¶æ¸²æŸ“è§’è‰²çš„é’±åŒ…é¡µé¢
 */
function openCharWallet() {
    renderCharWallet();
    switchToCharScreen('char-wallet-screen');
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“è§’è‰²çš„é’±åŒ…é¡µé¢
 */
function renderCharWallet() {
    const contentEl = document.getElementById('char-wallet-content');
    contentEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    const history = char.simulatedTaobaoHistory || [];

    // 1. è®¡ç®—æ€»æ”¯å‡º
    const totalExpenses = history.reduce((sum, item) => sum + (item.price || 0), 0);

    // 2. åˆ›å»ºå¹¶æ˜¾ç¤ºæ€»æ”¯å‡ºå¡ç‰‡
    const summaryCard = document.createElement('div');
    summaryCard.style.cssText = `
        background-color: #fff;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    `;
    summaryCard.innerHTML = `
        <p style="color: #8a8a8a; margin: 0 0 10px 0;">æœ¬æœˆæ€»æ”¯å‡º</p>
        <p style="font-size: 32px; font-weight: 600; color: #1f1f1f; margin: 0;">Â¥${totalExpenses.toFixed(2)}</p>
    `;
    contentEl.appendChild(summaryCard);

    // 3. åˆ›å»ºå¹¶æ˜¾ç¤ºæ”¯å‡ºæ˜ç»†
    const detailsTitle = document.createElement('h3');
    detailsTitle.textContent = 'æ”¯å‡ºæ˜ç»†';
    detailsTitle.style.cssText = `font-size: 16px; color: #555; margin-bottom: 10px;`;
    contentEl.appendChild(detailsTitle);

    if (history.length === 0) {
        contentEl.innerHTML += '<p style="text-align:center; color: var(--text-secondary);">æš‚æ— æ”¯å‡ºè®°å½•ã€‚</p>';
        return;
    }

    history.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        `;
        itemEl.innerHTML = `
            <div>
                <p style="font-weight: 500; margin: 0 0 4px 0;">${item.itemName}</p>
                <p style="font-size: 12px; color: #8a8a8a; margin: 0;">${item.status}</p>
            </div>
            <div style="font-weight: 600; font-size: 16px; color: #ff5722;">- Â¥${(item.price || 0).toFixed(2)}</div>
        `;
        contentEl.appendChild(itemEl);
    });
}
// â–²â–²â–² å…¨æ–°JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€V3.0 | æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleGenerateSimulatedMemos å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V3.0 | æœ€ç»ˆä¿®å¤ç‰ˆã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œé‡æ–°ç”Ÿæˆâ€æ—¶ï¼Œè°ƒç”¨AIç”Ÿæˆæ¨¡æ‹Ÿå¤‡å¿˜å½•
 */
async function handleGenerateSimulatedMemos() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨è¯·æ±‚â€œ${chat.name}â€åˆ†äº«TAçš„å¤‡å¿˜å½•...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚');
        return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ·' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'æ— ';
    const recentHistoryWithUser = chat.history.slice(-5).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œä¹¦ã€Š${book.name}ã€‹è®¾å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼ºåŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæ„å‡ºã€12åˆ°20æ¡ã€‘TAæœ€è¿‘å¯èƒ½ä¼šå†™åœ¨æ‰‹æœºå¤‡å¿˜å½•é‡Œçš„å†…å®¹ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åˆ›é€ æ€§ä¸åˆç†æ€§**: å¤‡å¿˜å½•å†…å®¹å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½ã€èŒä¸šå’Œç”Ÿæ´»ç¯å¢ƒã€‚å¯ä»¥æ˜¯è´­ç‰©æ¸…å•ã€å¾…åŠäº‹é¡¹ã€çµæ„Ÿç‰‡æ®µã€ä¸€äº›éšç¬”å’Œæ„Ÿæ‚Ÿã€è‰ç¨¿ç­‰ã€‚
2.  **æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)**: 
    - ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›å¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€æ¡å¤‡å¿˜å½•ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "title": "å¤‡å¿˜å½•çš„æ ‡é¢˜ï¼Œä¾‹å¦‚ï¼šè´­ç‰©æ¸…å• æˆ– å‘¨æœ«è®¡åˆ’",
        "content": "å¤‡å¿˜å½•çš„è¯¦ç»†å†…å®¹ï¼Œå¿…é¡»æ”¯æŒæ¢è¡Œç¬¦\\nã€‚"
      }
    ]
    \`\`\`

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•¿æœŸè®°å¿†**:
${longTermMemoryContext}
${worldBookContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å¯¹è¯æ‘˜è¦**:
${recentHistoryWithUser}

ç°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆè¿™ç»„å¤‡å¿˜å½•ã€‚`;
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„å¤‡å¿˜å½•å†…å®¹ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸å…¼å®¹çš„ response_format å‚æ•° â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 0.9
                    // åŒæ ·ç§»é™¤ response_format
                })
            });
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        if (!response.ok) {
             const errorData = await response.json().catch(() => null);
             const errorMessage = errorData?.error?.message || response.statusText;
             throw new Error(`API é”™è¯¯: ${response.status} - ${errorMessage}`);
        }
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼ºå¤§çš„å®¹é”™è§£æé€»è¾‘ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedMemos;
        try {
            simulatedMemos = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ—¶å‡ºé”™: ${e.message}\n\nAIåŸå§‹è¿”å›å†…å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        
        if (!Array.isArray(simulatedMemos)) {
            throw new Error(`AIè¿”å›çš„æ•°æ®ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚åŸå§‹è¿”å›: ${JSON.stringify(simulatedMemos)}`);
        }

        chat.memos = simulatedMemos.map(memo => ({
            id: Date.now() + Math.random(),
            title: memo.title,
            content: memo.content
        }));
        
        await db.chats.put(chat);
        await renderCharMemoList();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ‹Ÿå¤‡å¿˜å½•å¤±è´¥:", error);
        await showCustomAlert("ç”Ÿæˆå¤±è´¥", `æ— æ³•ç”Ÿæˆå¤‡å¿˜å½•ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åå†è¯•ã€‚\né”™è¯¯: ${error.message}`);
    }
}
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleGenerateAmapHistory å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–° | V2.0 æœ€ç»ˆä¿®å¤ç‰ˆã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œé‡æ–°ç”Ÿæˆâ€æ—¶ï¼Œè°ƒç”¨AIç”Ÿæˆæ¨¡æ‹Ÿè¶³è¿¹
 */
async function handleGenerateAmapHistory() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨ç”Ÿæˆâ€œ${chat.name}â€çš„å‡ºè¡Œè¶³è¿¹...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå†…å®¹ã€‚');
        return;
    }
    
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ·' : state.qzoneSettings.nickname;
    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'æ— ';
    const recentHistoryWithUser = chat.history.slice(-5).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œä¹¦ã€Š${book.name}ã€‹è®¾å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼ºåŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæ„å‡ºã€12åˆ°20æ¡ã€‘TAæœ€è¿‘çš„â€œé«˜å¾·åœ°å›¾â€å‡ºè¡Œè¶³è¿¹ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€æ—¶é—´ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**:
    -   ä»Šå¤©çš„æ—¥æœŸæ˜¯ **${new Date().toISOString()}**ã€‚
    -   ä½ ç”Ÿæˆçš„ã€æ‰€æœ‰ã€‘è¶³è¿¹çš„ \`timestamp\` å­—æ®µï¼Œã€å¿…é¡»ã€‘æ˜¯ä»Šå¤©æˆ–ä»Šå¤©ä»¥å‰çš„æ—¥æœŸã€‚
    -   ã€ç»å¯¹ç¦æ­¢ã€‘ç”Ÿæˆä»»ä½•æœªæ¥çš„æ—¥æœŸï¼
    -   è¯·ç”Ÿæˆä¸€ä¸ªçœ‹èµ·æ¥åƒæ˜¯è¿‡å»å‡ å‘¨å†…çš„ã€æ—¶é—´ã€ä»æ–°åˆ°æ—§ã€‘æ’åˆ—çš„è¶³è¿¹åˆ—è¡¨ã€‚
2.  **åˆ›é€ æ€§ä¸åˆç†æ€§**: è¶³è¿¹å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½ã€èŒä¸šå’Œç”Ÿæ´»ç¯å¢ƒã€‚
3.  **å¤šæ ·æ€§**: åœ°ç‚¹ç±»å‹è¦ä¸°å¯Œï¼Œå¯ä»¥åŒ…æ‹¬é¤å…ã€å•†åœºã€å…¬å›­ã€å…¬å¸ã€æœ‹å‹å®¶ç­‰ã€‚
4.  **ã€æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: 
    - ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›å¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€æ¡è¶³è¿¹ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "locationName": "ä¸€ä¸ªå…·ä½“ã€ç”ŸåŠ¨çš„åœ°ç‚¹åç§°",
        "address": "ä¸€ä¸ªè™šæ„ä½†çœ‹èµ·æ¥å¾ˆçœŸå®çš„è¯¦ç»†åœ°å€",
        "comment": "è¿™æ˜¯è§’è‰²å¯¹è¿™æ¬¡å‡ºè¡Œæˆ–è¿™ä¸ªåœ°ç‚¹çš„å†…å¿ƒç‹¬ç™½æˆ–è¯„è®ºï¼Œå¿…é¡»ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€æ¥å†™ã€‚",
        "image_prompt": "(å¯é€‰)ä¸€æ®µç”¨äºç”Ÿæˆè¿™å¼ åœ°ç‚¹ç…§ç‰‡çš„ã€è¯¦ç»†çš„ã€è‹±æ–‡ã€‘å…³é”®è¯, é£æ ¼ä¸º realistic photo, high quality",
        "timestamp": "ç¬¦åˆ ISO 8601 æ ¼å¼çš„æ—¥æœŸæ—¶é—´å­—ç¬¦ä¸² (ä¾‹å¦‚: '2025-09-25T18:30:00Z')"
      }
    ]
    \`\`\`
    - **é‡è¦**: å¤§çº¦æœ‰ã€ä¸‰åˆ†ä¹‹ä¸€ã€‘çš„è¶³è¿¹éœ€è¦åŒ…å« \`image_prompt\` å­—æ®µæ¥ç”Ÿæˆä¸€å¼ ç…§ç‰‡ã€‚
    - **å›¾ç‰‡**: image_prompt ç”Ÿæˆçš„å›¾ç‰‡ã€ç»å¯¹ç¦æ­¢åŒ…å«çœŸäººã€‘ã€‚å¦‚æœåœ°ç‚¹æ˜¯å®¤å†…ï¼Œå¯ä»¥ç”Ÿæˆç©ºæ— ä¸€äººçš„åœºæ™¯ï¼›å¦‚æœæ˜¯å®¤å¤–ï¼Œå¯ä»¥åªæœ‰é£æ™¯æˆ–å»ºç­‘ã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•¿æœŸè®°å¿†**:
${longTermMemoryContext}
${worldBookContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å¯¹è¯æ‘˜è¦**:
${recentHistoryWithUser}

ç°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆè¿™ç»„è¶³è¿¹è®°å½•ã€‚`;
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„é«˜å¾·åœ°å›¾è¶³è¿¹ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸å…¼å®¹çš„ response_format å‚æ•° â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 0.9
                    // response_format: { "type": "json_object" } <-- æ­¤è¡Œå·²è¢«åˆ é™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹3ï¼šä½¿ç”¨æ›´å¼ºå¤§çš„å®¹é”™è§£æé€»è¾‘ â–¼â–¼â–¼
        const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
        if (!jsonMatch || !jsonMatch[0]) {
            throw new Error(`AIè¿”å›çš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        const cleanedJsonString = jsonMatch[0];
        let simulatedAmapData;
        try {
            simulatedAmapData = JSON.parse(cleanedJsonString);
        } catch (e) {
            throw new Error(`è§£æAIè¿”å›çš„JSONæ—¶å‡ºé”™: ${e.message}\n\nAIåŸå§‹è¿”å›å†…å®¹:\n${aiResponseContent}`);
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        
        chat.simulatedAmapHistory = simulatedAmapData;
        await db.chats.put(chat);
        
        await renderCharAmap();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ‹Ÿè¶³è¿¹å¤±è´¥:", error);
        await showCustomAlert("ç”Ÿæˆå¤±è´¥", `æ— æ³•ç”Ÿæˆè¶³è¿¹ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åå†è¯•ã€‚\né”™è¯¯: ${error.message}`);
    }
}

        /**
         * ã€å…¨æ–° | V2.0 æœ€ç»ˆä¿®å¤ç‰ˆã€‘æ¸²æŸ“è§’è‰²çš„é«˜å¾·åœ°å›¾è¶³è¿¹åˆ—è¡¨
         */
        function renderCharAmap() {
            const listEl = document.getElementById('char-amap-list');
            listEl.innerHTML = '';
            if (!activeCharacterId) return;

            const char = state.chats[activeCharacterId];
            const history = char.simulatedAmapHistory || [];

            if (history.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œè¿˜æ²¡æœ‰ç•™ä¸‹ä»»ä½•è¶³è¿¹ï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›è®°å½•å§ï¼</p>';
                return;
            }

            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤3ï¼šåœ¨è¿™é‡Œä½¿ç”¨ AI æä¾›çš„æ—¶é—´æˆ³ â–¼â–¼â–¼
            history.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'char-amap-item';
                
                let photoHtml = '';
                if (item.image_prompt) {
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image_prompt)}`;
                    photoHtml = `<div class="amap-item-photo" style="background-image: url('${imageUrl}')" data-comment="${item.comment}"></div>`;
                }

                // ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ formatTimeAgo å‡½æ•°æ¥æ ¼å¼åŒ–æ—¶é—´
                const timeAgo = item.timestamp ? formatTimeAgo(new Date(item.timestamp).getTime()) : 'æŸä¸ªæ—¶é—´';

                itemEl.innerHTML = `
                    <div class="amap-item-header">
                        <div class="amap-item-icon">ğŸ“</div>
                        <div class="amap-item-info">
                            <div class="amap-item-title">${item.locationName}</div>
                            <div class="amap-item-address">${item.address}</div>
                        </div>
                    </div>
                    <div class="amap-item-body">
                        <div class="amap-item-comment">${item.comment.replace(/\n/g, '<br>')}</div>
                        ${photoHtml}
                    </div>
                    <div class="amap-item-footer">${timeAgo}</div>
                `;
                listEl.appendChild(itemEl);
            });
            // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
        }

// â–²â–²â–² å…¨æ–°JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–° V3.0 | æ”¯æŒAIç»˜å›¾ã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œé‡æ–°ç”Ÿæˆâ€æ—¶ï¼Œè°ƒç”¨AIç”Ÿæˆæ¨¡æ‹ŸAppä½¿ç”¨è®°å½•
 */
async function handleGenerateAppUsage() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨åˆ†æâ€œ${chat.name}â€çš„æ‰‹æœºä½¿ç”¨ä¹ æƒ¯...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå†…å®¹ã€‚');
        return;
    }
    
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ·' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'æ— ';
    const recentHistoryWithUser = chat.history.slice(-5).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œä¹¦ã€Š${book.name}ã€‹è®¾å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼ºåŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç”Ÿæ´»æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œè™šæ„å‡ºTAæœ€è¿‘ä¸€å¤©çš„ã€æ‰‹æœºAppå±å¹•ä½¿ç”¨æ—¶é—´ã€‘è®°å½•ï¼Œæ€»å…±çº¦20æ¡ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åˆ›é€ æ€§ä¸å¤šæ ·æ€§**: ç”Ÿæˆçš„Appåˆ—è¡¨ã€ä¸å¿…å±€é™äºã€‘Cphoneä¸»å±å¹•ä¸Šå·²æœ‰çš„Appã€‚ä½ å¯ä»¥è‡ªç”±åœ°è™šæ„TAå¯èƒ½ä½¿ç”¨çš„å…¶ä»–Appï¼Œä¾‹å¦‚ Instagram, Twitter, å„ç§æ¸¸æˆ (å¦‚ï¼šåŸç¥, ç‹è€…è£è€€), è§†é¢‘App (å¦‚ï¼šæŠ–éŸ³, YouTube), å­¦ä¹ æˆ–å·¥ä½œè½¯ä»¶ç­‰ï¼Œè¿™èƒ½æ›´å¥½åœ°ä½“ç°è§’è‰²çš„éšè—å…´è¶£å’Œç”Ÿæ´»ä¹ æƒ¯ã€‚
2.  **åˆç†æ€§**: ä½¿ç”¨æ—¶é•¿å’ŒAppç±»å‹å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½ã€èŒä¸šå’Œç”Ÿæ´»ç¯å¢ƒã€‚
3.  **æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)**: 
    - ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›å¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªAppçš„ä½¿ç”¨è®°å½•ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "appName": "Appçš„åç§° (ä¾‹å¦‚: å¾®ä¿¡, å¾®åš, åŸç¥)",
        "usageTimeMinutes": 125,
        "category": "Appçš„åˆ†ç±» (ä¾‹å¦‚: ç¤¾äº¤, æ¸¸æˆ, å½±éŸ³, å·¥å…·, é˜…è¯», è´­ç‰©)",
        "image_prompt": "ä¸€æ®µç”¨äºç”Ÿæˆè¿™ä¸ªAppã€å›¾æ ‡ã€‘çš„ã€ç®€æ´çš„ã€è‹±æ–‡ã€‘å…³é”®è¯ã€‚é£æ ¼å¿…é¡»æ˜¯ modern app icon, flat design, simple, clean background"
      }
    ]
    \`\`\`

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•¿æœŸè®°å¿†**:
${longTermMemoryContext}
${worldBookContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å¯¹è¯æ‘˜è¦**:
${recentHistoryWithUser}

ç°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆè¿™ç»„Appä½¿ç”¨è®°å½•ã€‚`;
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„Appä½¿ç”¨è®°å½•ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šç§»é™¤ä¸å…¼å®¹çš„ response_format å‚æ•° â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 0.9
                    // response_format: { "type": "json_object" } <-- æ­¤è¡Œå·²è¢«åˆ é™¤
                })
            });
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
        
        const simulatedUsageData = JSON.parse(cleanedJson);
        
        chat.simulatedAppUsage = simulatedUsageData;
        await db.chats.put(chat);
        
        await renderCharAppUsage();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ‹ŸAppä½¿ç”¨è®°å½•å¤±è´¥:", error);
        await showCustomAlert("ç”Ÿæˆå¤±è´¥", `æ— æ³•ç”Ÿæˆè®°å½•ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åå†è¯•ã€‚\né”™è¯¯: ${error.message}`);
    }
}

        /**
         * ã€å…¨æ–° V2.0 | AIç»˜å›¾ç‰ˆã€‘æ¸²æŸ“è§’è‰²çš„Appä½¿ç”¨è®°å½•åˆ—è¡¨
         */
        function renderCharAppUsage() {
            const listEl = document.getElementById('char-usage-list');
            listEl.innerHTML = '';
            if (!activeCharacterId) return;

            const char = state.chats[activeCharacterId];
            const usageData = (char.simulatedAppUsage || []).sort((a, b) => b.usageTimeMinutes - a.usageTimeMinutes);

            if (usageData.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œè¿˜æ²¡æœ‰ä»»ä½•ä½¿ç”¨è®°å½•ï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›å§ï¼</p>';
                return;
            }

            usageData.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'char-usage-item';
                
                const hours = Math.floor(item.usageTimeMinutes / 60);
                const minutes = item.usageTimeMinutes % 60;
                let timeString = '';
                if (hours > 0) timeString += `${hours}å°æ—¶`;
                if (minutes > 0) timeString += `${minutes}åˆ†é’Ÿ`;
                if (!timeString) timeString = 'å°äº1åˆ†é’Ÿ';

                // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ï¼šåŠ¨æ€ç”Ÿæˆå›¾æ ‡URLã€‘ â–¼â–¼â–¼
                // 1. å¦‚æœAIæä¾›äº†image_promptï¼Œå°±ä½¿ç”¨å®ƒï¼›å¦åˆ™ï¼Œæä¾›ä¸€ä¸ªé€šç”¨çš„å¤‡ç”¨æŒ‡ä»¤
                const prompt = item.image_prompt || `modern app icon for ${item.appName}, flat design, simple`;
                // 2. ä½¿ç”¨AIç»˜ç”»APIç”Ÿæˆå›¾æ ‡
                const iconUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
                // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

                itemEl.innerHTML = `
                    <img src="${iconUrl}" class="usage-item-icon">
                    <div class="usage-item-info">
                        <div class="usage-item-name">${item.appName}</div>
                        <div class="usage-item-category">${item.category}</div>
                    </div>
                    <div class="usage-item-time">${timeString}</div>
                `;
                listEl.appendChild(itemEl);
            });
        }
// â–²â–²â–² å…¨æ–°JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
/**
 * ã€å…¨æ–° V2.0 | æœ€ç»ˆå…¼å®¹ç‰ˆã€‘å½“ç”¨æˆ·ç‚¹å‡»â€œé‡æ–°ç”Ÿæˆâ€æ—¶ï¼Œè°ƒç”¨AIç”Ÿæˆæ¨¡æ‹Ÿæ­Œå•
 */
async function handleGenerateSimulatedMusic() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨è¯·æ±‚â€œ${chat.name}â€åˆ†äº«TAçš„ç§äººæ­Œå•...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚');
        return;
    }
    
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'ç”¨æˆ·' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory?.map(mem => `- ${mem.content}`).join('\n') || 'æ— ';
    const recentHistoryWithUser = chat.history.slice(-5).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
        .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
        .filter(Boolean)
        .map(book => `\n## ä¸–ç•Œä¹¦ã€Š${book.name}ã€‹è®¾å®š:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
        .join('');

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹1ï¼šå¼ºåŒ–AIæŒ‡ä»¤ â–¼â–¼â–¼
    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹ŸéŸ³ä¹å“å‘³æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ${chat.name}â€ï¼Œå¹¶æ ¹æ®å…¶äººè®¾ã€è®°å¿†å’Œæœ€è¿‘çš„äº’åŠ¨ï¼ŒæŒ‘é€‰å‡ºã€14åˆ°18é¦–ã€‘æœ€èƒ½ä»£è¡¨TAæ­¤åˆ»å¿ƒæƒ…æˆ–å“å‘³çš„æ­Œæ›²ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åˆ›é€ æ€§ä¸åˆç†æ€§**: æ­Œå•å¿…é¡»å®Œå…¨ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€çˆ±å¥½å’Œç”Ÿæ´»èƒŒæ™¯ã€‚
2.  **å¤šæ ·æ€§**: æ­Œæ›²é£æ ¼å¯ä»¥å¤šæ ·ï¼Œä½†å¿…é¡»é€»è¾‘è‡ªæ´½ã€‚
3.  **æ ¼å¼é“å¾‹ (æœ€é«˜ä¼˜å…ˆçº§)**: 
    - ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›å¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»£è¡¨ä¸€é¦–æ­Œï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "songName": "æ­Œæ›²çš„å‡†ç¡®åç§°",
        "artistName": "æ­Œæ›²çš„å‡†ç¡®è‰ºæœ¯å®¶/æ­Œæ‰‹å"
      }
    ]
    \`\`\`

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
- **ä½ çš„é•¿æœŸè®°å¿†**:
${longTermMemoryContext}
${worldBookContext}
- **ä½ æœ€è¿‘å’Œâ€œ${userDisplayNameForAI}â€çš„å¯¹è¯æ‘˜è¦**:
${recentHistoryWithUser}

ç°åœ¨ï¼Œè¯·ç”Ÿæˆè¿™ä»½æ­Œå•ã€‚`;
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    try {
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”Ÿæˆä½ çš„æ­Œå•ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹2ï¼šæ­¤å‡½æ•°ä¹‹å‰æ²¡æœ‰ response_formatï¼Œæ— éœ€åˆ é™¤ï¼Œä½†æˆ‘ä»¬ç¡®ä¿å…¶ä»–éƒ¨åˆ†æ˜¯å¥å£®çš„ â–¼â–¼â–¼
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 1.0,
                })
            });
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
        const songPicks = JSON.parse(cleanedJson);

        await showCustomAlert("è¯·ç¨å€™...", `æ­Œå•å·²ç”Ÿæˆï¼Œæ­£åœ¨ä»ç½‘ç»œè·å– ${songPicks.length} é¦–æ­Œæ›²çš„è¯¦ç»†ä¿¡æ¯...`);

        const songDetailPromises = songPicks.map(async (pick) => {
            let searchResults = await searchNeteaseMusic(pick.songName, pick.artistName);
            if (!searchResults || searchResults.length === 0) {
                searchResults = await searchTencentMusic(pick.songName);
            }
            if (searchResults.length > 0) {
                return getPlayableSongDetails(searchResults[0]);
            }
            console.warn(`æ‰€æœ‰éŸ³ä¹æºéƒ½æœªèƒ½æ‰¾åˆ°æ­Œæ›²ï¼šâ€œ${pick.songName} - ${pick.artistName}â€`);
            return null;
        });

        const fullSongObjects = (await Promise.all(songDetailPromises)).filter(Boolean);

        chat.simulatedMusicPlaylist = fullSongObjects;
        await db.chats.put(chat);
        
        await renderCharMusicScreen();
        
    } catch (error) {
        console.error("ç”Ÿæˆæ¨¡æ‹Ÿæ­Œå•å¤±è´¥:", error);
        await showCustomAlert("ç”Ÿæˆå¤±è´¥", `æ— æ³•ç”Ÿæˆæ­Œå•ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åå†è¯•ã€‚\né”™è¯¯: ${error.message}`);
    }
}

/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“è§’è‰²çš„ç½‘æ˜“äº‘éŸ³ä¹åˆ—è¡¨
 */
function renderCharMusicScreen() {
    const listEl = document.getElementById('char-music-list');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const playlist = char.simulatedMusicPlaylist || [];

    if (playlist.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAçš„æ­Œå•è¿˜æ˜¯ç©ºçš„ï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ç”Ÿæˆä¸€äº›æ­Œæ›²å§ï¼</p>';
        return;
    }

    playlist.forEach((track, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'char-music-item';
        itemEl.innerHTML = `
            <img src="${track.cover}" class="music-item-cover">
            <div class="music-item-info">
                <div class="music-item-name">${track.name}</div>
                <div class="music-item-artist">${track.artist}</div>
            </div>
        `;
        // ä¸ºæ¯ä¸ªåˆ—è¡¨é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œå¹¶ä¼ å…¥å®Œæ•´çš„æ­Œæ›²å¯¹è±¡
        itemEl.addEventListener('click', () => playCharSong(track));
        listEl.appendChild(itemEl);
    });
}

/* â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ã€å…¨æ–° V3.0 JSä»£ç ã€‘ï¼Œå®Œæ•´æ›¿æ¢æ‰€æœ‰æ—§çš„ char-player-modal ç›¸å…³JS â–¼â–¼â–¼ */

let charPlayerState = {
    currentPlaylist: [],
    currentIndex: -1,
    isPlaying: false,
    playMode: 'order', // 'order', 'random', 'single'
    lrcUpdateInterval: null,
    // ã€æ ¸å¿ƒæ–°å¢ã€‘
    parsedLyrics: [],
    currentLyricIndex: -1
};

/**
 * æ’­æ”¾Cphoneä¸­çš„æ­Œæ›² (V3.0 - é€‚é…æ–°UIå’Œæ­Œè¯)
 * @param {object} songObject - åŒ…å«æ‰€æœ‰ä¿¡æ¯çš„å®Œæ•´æ­Œæ›²å¯¹è±¡
 */
function playCharSong(songObject) {
    const player = document.getElementById('char-audio-player');
    const modal = document.getElementById('char-music-player-modal');
    
    if (charPlayerState.lrcUpdateInterval) clearInterval(charPlayerState.lrcUpdateInterval);
    player.pause();
    
    const songIndex = charPlayerState.currentPlaylist.findIndex(s => s.src === songObject.src);
    if (songIndex > -1) {
        charPlayerState.currentIndex = songIndex;
    } else {
        charPlayerState.currentPlaylist = [songObject];
        charPlayerState.currentIndex = 0;
    }

    // æ›´æ–°UI
    document.getElementById('char-music-player-title').textContent = songObject.name;
    document.getElementById('char-music-artist').textContent = songObject.artist;
    document.getElementById('char-music-cover').src = songObject.cover;
    
    // ã€æ ¸å¿ƒæ–°å¢ã€‘è§£ææ­Œè¯
    charPlayerState.parsedLyrics = parseLRC(songObject.lrcContent || "");
    renderCharLyrics(); // æ¸²æŸ“æ­Œè¯

    // è®¾ç½®éŸ³é¢‘æºå¹¶æ’­æ”¾
    if (songObject.isLocal) {
        const blob = new Blob([songObject.src], { type: songObject.fileType || 'audio/mpeg' });
        player.src = URL.createObjectURL(blob);
    } else {
        player.src = songObject.src;
    }
    player.play().catch(e => console.error("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", e));

    player.onloadedmetadata = () => {
        document.getElementById('char-music-total-time').textContent = formatMusicTime(player.duration);
        charPlayerState.lrcUpdateInterval = setInterval(updateCharMusicProgress, 500);
    };

    modal.classList.add('visible');
}

/**
 * å…³é—­Cphoneçš„éŸ³ä¹æ’­æ”¾å™¨ (V3.0)
 */
function closeCharMusicPlayer() {
    const modal = document.getElementById('char-music-player-modal');
    const player = document.getElementById('char-audio-player');
    
    if (charPlayerState.lrcUpdateInterval) clearInterval(charPlayerState.lrcUpdateInterval);
    player.pause();
    player.src = ''; 
    modal.classList.remove('visible');
    charPlayerState.isPlaying = false;
    document.getElementById('char-vinyl-container').classList.remove('spinning');
}

/**
 * æ›´æ–°æ’­æ”¾å™¨è¿›åº¦æ¡ã€æ—¶é—´å’Œæ­Œè¯ (æ ¸å¿ƒä¿®æ”¹)
 */
function updateCharMusicProgress() {
    const player = document.getElementById('char-audio-player');
    if (!player.duration) return;

    const currentTime = player.currentTime;
    const duration = player.duration;
    document.getElementById('char-music-progress-fill').style.width = `${(currentTime / duration) * 100}%`;
    document.getElementById('char-music-current-time').textContent = formatMusicTime(currentTime);

    // ã€æ ¸å¿ƒæ–°å¢ã€‘è°ƒç”¨æ­Œè¯æ›´æ–°å‡½æ•°
    updateCharActiveLyric(currentTime);
}


/**
 * ã€å…¨æ–°ã€‘æ¸²æŸ“è§’è‰²æ’­æ”¾å™¨çš„æ­Œè¯åˆ—è¡¨
 */
function renderCharLyrics() {
    const lyricsContainer = document.getElementById('char-music-lyrics');
    lyricsContainer.innerHTML = '';
    charPlayerState.currentLyricIndex = -1; // é‡ç½®ç´¢å¼•
    if (!charPlayerState.parsedLyrics || charPlayerState.parsedLyrics.length === 0) {
        lyricsContainer.innerHTML = '<p>â™ª æš‚æ— æ­Œè¯ â™ª</p>';
        return;
    }
    charPlayerState.parsedLyrics.forEach((line, index) => {
        const p = document.createElement('p');
        p.textContent = line.text;
        p.dataset.index = index;
        lyricsContainer.appendChild(p);
    });
}

/**
 * ã€å…¨æ–°ã€‘æ›´æ–°å½“å‰é«˜äº®çš„æ­Œè¯
 */
function updateCharActiveLyric(currentTime) {
    const lyrics = charPlayerState.parsedLyrics;
    if (lyrics.length === 0) return;

    let newLyricIndex = -1;
    for (let i = 0; i < lyrics.length; i++) {
        if (currentTime >= lyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    if (newLyricIndex === charPlayerState.currentLyricIndex) return;
    charPlayerState.currentLyricIndex = newLyricIndex;
    
    // æ›´æ–°UI
    const lyricsContainer = document.getElementById('char-music-lyrics');
    const lines = lyricsContainer.querySelectorAll('p');
    lines.forEach(line => line.classList.remove('active'));
    
    if (newLyricIndex > -1) {
        const activeLine = lyricsContainer.querySelector(`p[data-index="${newLyricIndex}"]`);
        if (activeLine) {
            activeLine.classList.add('active');
            // è®¡ç®—æ»šåŠ¨ä½ç½®ï¼Œä½¿å½“å‰è¡Œå±…ä¸­
            const offset = (lyricsContainer.clientHeight / 2) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
            lines.forEach(line => {
                line.style.transform = `translateY(${offset}px)`;
            });
        }
    }
}


/**
 * æ’­æ”¾ä¸‹ä¸€é¦–æ­Œ
 */
function playNextCharSong() {
    if (charPlayerState.currentPlaylist.length === 0) return;
    let nextIndex;
    switch(charPlayerState.playMode) {
        case 'random':
            nextIndex = Math.floor(Math.random() * charPlayerState.currentPlaylist.length);
            break;
        case 'single':
            // å•æ›²å¾ªç¯ï¼Œé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
            playCharSong(charPlayerState.currentPlaylist[charPlayerState.currentIndex]);
            return;
        case 'order':
        default:
            nextIndex = (charPlayerState.currentIndex + 1) % charPlayerState.currentPlaylist.length;
            break;
    }
    playCharSong(charPlayerState.currentPlaylist[nextIndex]);
}

/**
 * æ’­æ”¾ä¸Šä¸€é¦–æ­Œ
 */
function playPrevCharSong() {
    if (charPlayerState.currentPlaylist.length === 0) return;
    const newIndex = (charPlayerState.currentIndex - 1 + charPlayerState.currentPlaylist.length) % charPlayerState.currentPlaylist.length;
    playCharSong(charPlayerState.currentPlaylist[newIndex]);
}

/**
 * åˆ‡æ¢æ’­æ”¾æ¨¡å¼
 */
function changeCharPlayMode() {
    const modes = ['order', 'random', 'single'];
    const currentModeIndex = modes.indexOf(charPlayerState.playMode);
    charPlayerState.playMode = modes[(currentModeIndex + 1) % modes.length];
    document.getElementById('char-music-mode-btn').textContent = {'order': 'é¡ºåº', 'random': 'éšæœº', 'single': 'å•æ›²'}[charPlayerState.playMode];
}


/**
 * ã€æ€»å…¥å£ã€‘ä¸ºæ–°æ’­æ”¾å™¨çš„æ‰€æœ‰æŒ‰é’®å’Œäº‹ä»¶ç»‘å®šåŠŸèƒ½
 */
function setupCharPlayerControls() {
    const player = document.getElementById('char-audio-player');
    const playBtn = document.getElementById('char-music-play-pause-btn');
    const vinyl = document.getElementById('char-vinyl-container');

    playBtn.addEventListener('click', () => {
        if (player.paused) {
            if(charPlayerState.currentIndex > -1) player.play();
        } else {
            player.pause();
        }
    });
    
    player.onplay = () => {
        playBtn.innerHTML = `<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;
        vinyl.classList.add('spinning');
        charPlayerState.isPlaying = true;
    };
    player.onpause = () => {
        playBtn.innerHTML = `<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>`;
        vinyl.classList.remove('spinning');
        charPlayerState.isPlaying = false;
    };
    player.onended = () => {
        vinyl.classList.remove('spinning');
        charPlayerState.isPlaying = false;
        playNextCharSong();
    };

    document.getElementById('char-music-prev-btn').addEventListener('click', playPrevCharSong);
    document.getElementById('char-music-next-btn').addEventListener('click', playNextCharSong);
    document.getElementById('char-music-mode-btn').addEventListener('click', changeCharPlayMode);

    document.getElementById('char-music-progress-bar').addEventListener('click', (e) => {
        if (!player.duration) return;
        const bar = e.currentTarget;
        const clickX = e.offsetX;
        player.currentTime = (clickX / bar.clientWidth) * player.duration;
    });
}
/* â–²â–²â–² JSä»£ç æ›¿æ¢ç»“æŸ â–²â–²â–² */
// â–¼â–¼â–¼ ã€å…¨æ–° | V3.2 | åŒé‡èº«ä»½éªŒè¯ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ renderDoubanScreen å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æ€»å…¥å£ã€‘æ¸²æŸ“è±†ç“£å°ç»„å±å¹•
 */
async function renderDoubanScreen() {
    const listEl = document.getElementById('douban-posts-list');
    listEl.innerHTML = '';
    
    const posts = await db.doubanPosts.orderBy('timestamp').reverse().toArray();

    if (posts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œ<br>ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®ï¼Œçœ‹çœ‹å¤§å®¶éƒ½åœ¨èŠä»€ä¹ˆå§ï¼</p>';
        return;
    }

    posts.forEach(post => {
        let avatarUrl;
        
        // --- æ ¸å¿ƒä¿®æ”¹ï¼šå…¨æ–°çš„â€œåŒé‡éªŒè¯â€å¤´åƒæŸ¥æ‰¾é€»è¾‘ ---
        // 1. ä¼˜å…ˆé€šè¿‡â€œèº«ä»½è¯â€(authorOriginalName)æŸ¥æ‰¾
        const authorChatByOriginalName = post.authorOriginalName 
            ? Object.values(state.chats).find(c => !c.isGroup && c.name === post.authorOriginalName) 
            : null;

        if (authorChatByOriginalName) {
            // å¦‚æœé€šè¿‡â€œèº«ä»½è¯â€æ‰¾åˆ°äº†ï¼Œå°±ç”¨è¿™ä¸ªè§’è‰²çš„çœŸå®å¤´åƒ
            avatarUrl = authorChatByOriginalName.settings.aiAvatar;
        } else {
            // 2. å¦‚æœæ²¡æœ‰â€œèº«ä»½è¯â€ï¼Œå†å°è¯•ç”¨â€œå¤–å·â€(authorName)å»èŠ±åå†Œé‡Œæ‰¾ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
            const authorChatByName = Object.values(state.chats).find(c => !c.isGroup && c.name === post.authorName);
            if (authorChatByName) {
                avatarUrl = authorChatByName.settings.aiAvatar;
            } else if (post.authorAvatarPrompt) {
                // 3. å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªè·¯äººNPCï¼Œå°±ç”¨AIç»™çš„â€œå¤´åƒå’’è¯­â€å»ç”»ä¸€å¼ æ–°è„¸
                avatarUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(post.authorAvatarPrompt)}`;
            } else {
                // 4. å¦‚æœè¿â€œå¤´åƒå’’è¯­â€éƒ½æ²¡æœ‰ï¼Œæ‰ä½¿ç”¨æœ€ç»ˆçš„ä¸‘é™‹å ä½å›¾
                avatarUrl = defaultAvatar;
            }
        }
        // --- ä¿®å¤ç»“æŸ ---

        const itemEl = document.createElement('div');
        itemEl.className = 'douban-post-item';
        itemEl.onclick = () => openDoubanPostDetail(post.id);

        itemEl.innerHTML = `
            <div class="douban-post-header">
                <img src="${avatarUrl}" class="douban-post-avatar">
                <div class="douban-author-info">
                    <div class="douban-author-name">${post.authorName}</div>
                    <div class="douban-group-name">æ¥è‡ª ${post.groupName}</div>
                </div>
            </div>
            <div class="douban-post-title">${post.postTitle}</div>
            <div class="douban-post-content">${post.content.replace(/\n/g, '<br>')}</div>
            <div class="douban-post-footer">
                 <div class="douban-post-actions">
                    <span><svg viewBox="0 0 1024 1024"><path d="M170.666667 170.666667h128v682.666666h-128zM426.666667 170.666667h170.666666v682.666666h-170.666666zM725.333333 170.666667h128v682.666666h-128z"></path></svg> ${post.likesCount}</span>
                    <span><svg viewBox="0 0 1024 1024"><path d="M853.333333 85.333333H170.666667c-46.933333 0-85.333333 38.4-85.333334 85.333334v512c0 46.933333 38.4 85.333333 85.333334 85.333333h512l170.666667 170.666667V170.666667c0-46.933333-38.4-85.333333-85.333334-85.333334z m-42.666666 554.666667H170.666667V170.666667h640v469.333333zM256 384h512v85.333333H256V384z m0-170.666667h512v85.333334H256v-85.333334z"></path></svg> ${post.commentsCount}</span>
                </div>
                <span class="douban-post-timestamp">${formatTimeAgo(post.timestamp)}</span>
            </div>
        `;
        listEl.appendChild(itemEl);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå…¨æ–°ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ handleGenerateDoubanPosts å‡½æ•° â–¼â–¼â–¼
async function handleGenerateDoubanPosts() {
    const activeCharacterIds = state.globalSettings.doubanActiveCharacterIds || [];

    if (activeCharacterIds.length === 0) {
        await showCustomAlert("è¯·å…ˆé€‰æ‹©è§’è‰²", "è¯·ç‚¹å‡»å³ä¸Šè§’çš„â€œè§’è‰²é€‰æ‹©â€æŒ‰é’®ï¼Œé€‰æ‹©è‡³å°‘ä¸€ä¸ªå‚ä¸è±†ç“£äº’åŠ¨çš„è§’è‰²ã€‚");
        return;
    }

    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨ä¸ºæ‚¨é€‰æ‹©çš„ ${activeCharacterIds.length} ä½è§’è‰²ç”Ÿæˆè±†ç“£åŠ¨æ€...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®å¥½APIä¿¡æ¯ã€‚');
        return;
    }

    const allLinkedBookIds = new Set();
    activeCharacterIds.forEach(charId => {
        const c = state.chats[charId];
        if (c && c.settings.linkedWorldBookIds) {
            c.settings.linkedWorldBookIds.forEach(bookId => allLinkedBookIds.add(bookId));
        }
    });

    let sharedWorldBookContext = '';
    if (allLinkedBookIds.size > 0) {
        sharedWorldBookContext += '\n\n# ç»Ÿä¸€ä¸–ç•Œè§‚è®¾å®š (ä»¥ä¸‹è®¾å®šé€‚ç”¨äºæ‰€æœ‰å‚ä¸è§’è‰²)\n';
        allLinkedBookIds.forEach(bookId => {
            const book = state.worldBooks.find(wb => wb.id === bookId);
            if (book) {
                const enabledEntries = book.content
                    .filter(e => e.enabled !== false)
                    .map(e => `- ${e.content}`)
                    .join('\n');
                if (enabledEntries) {
                    sharedWorldBookContext += `\n## æ¥è‡ªã€Š${book.name}ã€‹:\n${enabledEntries}`;
                }
            }
        });
    }
    
    const doubanWorldBook = state.worldBooks.find(wb => wb.name === 'è±†ç“£è®¾å®š');
    let doubanSettingContext = '';
    let npcCharacters = [];
    if (doubanWorldBook) {
        doubanWorldBook.content.forEach(entry => {
            if (entry.comment.includes('å°ç»„é£æ ¼')) {
                doubanSettingContext += `\n# è±†ç“£ç¤¾åŒºé£æ ¼è®¾å®š (æ¥è‡ªä¸–ç•Œä¹¦)\n${entry.content}`;
            }
            if (entry.comment.includes('NPCäººè®¾')) {
                const lines = entry.content.split('\n');
                lines.forEach(line => {
                    const match = line.match(/- \*\*æ˜µç§°\*\*:\s*(.*?)\s*\*\*äººè®¾\*\*:\s*(.*)/);
                    if (match) {
                        npcCharacters.push({ name: match[1].trim(), persona: match[2].trim() });
                    }
                });
            }
        });
    }
    
    const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
    const userPersona = activeCharacterIds.length > 0 && state.chats[activeCharacterIds[0]] 
        ? state.chats[activeCharacterIds[0]].settings.myPersona 
        : '(æœªè®¾ç½®)';

    let charactersContext = '';
    activeCharacterIds.forEach(charId => {
        const c = state.chats[charId];
        if (c) {
            const longTermMemory = c.longTermMemory && c.longTermMemory.length > 0 ? c.longTermMemory.map(m => m.content).join('; ') : 'æ— ';
            const recentHistory = c.history.slice(-10).map(msg => 
                `${msg.role === 'user' ? userNickname : c.name}: ${String(msg.content).substring(0, 30)}...`
            ).join('\n');

            charactersContext += `
<character>
  <name>${c.name}</name>
  <persona>${c.settings.aiPersona}</persona>
  <memory>${longTermMemory}</memory>
  <recent_dialogue_with_user>${recentHistory}</recent_dialogue_with_user>
</character>
`;
        }
    });
    npcCharacters.forEach(npc => {
        charactersContext += `
<character>
  <name>${npc.name}</name>
  <persona>${npc.persona}</persona>
</character>
`;
    });
    
    const now = new Date();
    const currentTimeString = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });

    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç¤¾åŒºå†…å®¹ç”Ÿæˆå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸‹é¢æä¾›çš„ã€ç»Ÿä¸€è§’è‰²åˆ—è¡¨ã€‘ï¼Œè™šæ„å‡ºã€12åˆ°20ç¯‡ã€‘ä»–ä»¬æœ€è¿‘å¯èƒ½ä¼šåœ¨å„ç§è±†ç“£å°ç»„ä¸­å‘å¸ƒçš„å¸–å­å’Œè¯„è®ºã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€æ—¶é—´æ„ŸçŸ¥ã€‘**:
    -   ä½ ã€å¿…é¡»ã€‘æ„è¯†åˆ°å½“å‰æ˜¯ **${currentTimeString}**ã€‚
    -   ä½ çš„å¸–å­å’Œè¯„è®ºå†…å®¹ã€å¿…é¡»ã€‘è‡ªç„¶åœ°ä½“ç°å‡ºå¯¹ã€å½“å‰çœŸå®æ—¶é—´ã€‘çš„æ„ŸçŸ¥ã€‚
2.  **ã€ç¦æ­¢æ‰®æ¼”ç”¨æˆ· (æœ€æœ€æœ€é«˜ä¼˜å…ˆçº§ï¼ï¼ï¼)ã€‘**:
    -   ç”¨æˆ·çš„æ˜µç§°æ˜¯â€œ${userNickname}â€ã€‚
    -   ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ authorName æˆ– commenter å­—æ®µä¸º â€œ${userNickname}â€ çš„å¸–å­æˆ–è¯„è®ºã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
3.  **ã€èº«ä»½ (æœ€é«˜ä¼˜å…ˆçº§ï¼)ã€‘**: 
    -   \`authorName\`: ä½ å¯ä»¥ä¸ºä¸»è¦è§’è‰²èµ·ä¸€ä¸ªç¬¦åˆæƒ…æ™¯çš„ã€ä¸´æ—¶çš„ã€å‘å¸–æ˜µç§°ã€‘ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ä»–ä»¬çš„æœ¬åã€‚
    -   \`authorOriginalName\`: å¦‚æœå‘å¸–è€…æ˜¯ã€ä¸»è¦è§’è‰²ã€‘ï¼Œä½ ã€å¿…é¡»ã€‘åœ¨è¿™é‡Œå¡«ä¸ŠTAåœ¨è§’è‰²åˆ—è¡¨é‡Œçš„ã€åŸå§‹å¤‡æ³¨åã€‘ï¼Œè¿™æ˜¯ç¨‹åºçš„â€œèº«ä»½è¯â€ã€‚
    -   å¦‚æœå‘å¸–è€…æ˜¯ã€è·¯äººNPCã€‘ï¼Œåˆ™ã€çœç•¥ã€‘\`authorOriginalName\` å­—æ®µã€‚
4.  **ã€ä½œè€…å¹³è¡¡ã€‘**: å¸–å­çš„ä½œè€…ã€å¿…é¡»ã€‘ä»ä¸‹é¢çš„ \`<character>\` åˆ—è¡¨ä¸­ã€å‡åŒ€åœ°ã€å¤šæ ·åŒ–åœ°ã€‘é€‰æ‹©ã€‚ä½ ã€å¿…é¡»ã€‘ç¡®ä¿å¸–å­åˆ—è¡¨ä¸­ã€è‡³å°‘æœ‰ 70% çš„å¸–å­æ˜¯ç”±è·¯äººNPCå‘å¸ƒçš„ã€‘ï¼Œä»¥è¥é€ ä¸€ä¸ªçœŸå®çš„ç¤¾åŒºæ°›å›´ã€‚
    - "comments": ä¸€ä¸ªåŒ…å«ã€7åˆ°12æ¡ã€‘è¯„è®ºçš„æ•°ç»„ã€‚è¯„è®ºè€…å¯ä»¥æ˜¯è·¯äººï¼Œä¹Ÿå¯ä»¥æ˜¯è§’è‰²åˆ—è¡¨ä¸­çš„å…¶ä»–è§’è‰²ï¼Œä»¥ä½“ç°äº’åŠ¨æ€§ã€‚
5.  **ã€è§’è‰²æ‰®æ¼”ã€‘**: å¸–å­çš„ä½œè€…å’Œå†…å®¹ã€å¿…é¡»ã€‘æ·±åº¦ç»“åˆè¯¥è§’è‰²çš„<persona>, <memory>, å’Œ <worldview>ã€‚
6.  **ã€â€œè±†ç“£å‘³â€å†…å®¹é£æ ¼æŒ‡å—ã€‘**: å¸–å­é£æ ¼å¿…é¡»å¤šæ ·åŒ–ä¸”å……æ»¡ç”Ÿæ´»æ°”æ¯ï¼ä½ éœ€è¦ç”ŸæˆåŒ…æ‹¬ä½†ä¸é™äºï¼šæƒ…æ„Ÿæ ‘æ´ã€ç”Ÿæ´»åæ§½ã€åƒç“œå…«å¦ã€å…´è¶£åˆ†äº«ã€æ— ç”¨è‰¯å“ç­‰å„ç§ç±»å‹çš„å¸–å­ã€‚
7.  **ã€å¤´åƒç”Ÿæˆ (æœ€é«˜ä¼˜å…ˆçº§ï¼)ã€‘**:
    -   ä¸ºæ¯ä¸€ä¸ªã€é¦–æ¬¡å‡ºç°ã€‘çš„è·¯äººNPCï¼ˆæ— è®ºæ˜¯å‘å¸–è¿˜æ˜¯è¯„è®ºï¼‰ï¼Œä½ éƒ½ã€å¿…é¡»ã€‘ä¸ºå…¶æ·»åŠ ä¸€ä¸ª \`avatar_prompt\` å­—æ®µã€‚
    -   è¿™ä¸ªå­—æ®µçš„å†…å®¹æ˜¯ç”¨äºç”Ÿæˆè¯¥NPCå¤´åƒçš„ã€ç®€æ´çš„ã€è‹±æ–‡ã€‘å…³é”®è¯ã€‚
    -   ä¸åŒçš„NPCã€å¿…é¡»ã€‘æœ‰ä¸åŒçš„å¤´åƒæŒ‡ä»¤ï¼Œä»¥ç¡®ä¿ä»–ä»¬çš„å¤´åƒæ˜¯ç‹¬ä¸€æ— äºŒçš„ã€‚
8.  **ã€å¤´åƒä¸€è‡´æ€§ (è‡³å…³é‡è¦ï¼)ã€‘**:
    -   å¦‚æœä¸€ä¸ªè·¯äººNPCåœ¨åŒä¸€ä¸ªå¸–å­ä¸­å¤šæ¬¡å‡ºç°ï¼ˆä¾‹å¦‚ï¼Œæ—¢æ˜¯å‘å¸–äººåˆæ˜¯è¯„è®ºè€…ï¼Œæˆ–å¤šæ¬¡è¯„è®ºï¼‰ï¼Œä½ ã€å¿…é¡»ã€‘ä¸ºTAçš„æ‰€æœ‰å‡ºç°éƒ½ä½¿ç”¨ã€å®Œå…¨ç›¸åŒã€‘çš„ \`avatar_prompt\`ã€‚è¿™è‡³å…³é‡è¦ï¼
9.  **ã€æ ¼å¼ (æœ€é«˜ä¼˜å…ˆçº§)ã€‘**: 
    - ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
    - ä½ çš„å›å¤å¿…é¡»ä»¥ \`[\` å¼€å§‹ï¼Œå¹¶ä»¥ \`]\` ç»“æŸã€‚
    - ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„å‰åæ·»åŠ ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šã€æˆ– markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚
    - æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ç¯‡å¸–å­ï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      {
        "groupName": "ä¸€ä¸ªç”ŸåŠ¨æœ‰è¶£çš„å°ç»„åç§°",
        "postTitle": "ä¸€ä¸ªå¼•äºº-æ³¨ç›®çš„å¸–å­æ ‡é¢˜",
        "authorName": "å‘å¸–è§’è‰²çš„ã€å¤‡æ³¨åã€‘",
        "authorOriginalName": "(ä»…å½“å‘å¸–è€…æ˜¯ä¸»è¦è§’è‰²æ—¶ã€å¿…é¡»ã€‘æä¾›) TAçš„åŸå§‹å¤‡æ³¨å",
        "authorAvatarPrompt": "(ä»…å½“å‘å¸–è€…æ˜¯è·¯äººNPCæ—¶ã€å¿…é¡»ã€‘æä¾›) ä¸€æ®µç”¨äºç”Ÿæˆè¯¥NPCå¤´åƒçš„ã€è‹±æ–‡ã€‘å…³é”®è¯ã€‚é£æ ¼ä¸º anime style, simple background",
        "content": "å¸–å­çš„è¯¦ç»†æ­£æ–‡ï¼Œå¿…é¡»æ”¯æŒæ¢è¡Œç¬¦\\nã€‚",
        "likesCount": 152,
        "commentsCount": 38,
        "comments": [
            { "commenter": "è·¯äººç”²", "text": "è¿™æ˜¯ä¸€ä¸ªè·¯äººè¯„è®ºã€‚", "avatar_prompt": "cute cat avatar, simple, flat" },
            { "commenter": "å¦ä¸€ä¸ªè§’è‰²å", "commenterOriginalName": "(å¦‚æœè¯„è®ºè€…æ˜¯ä¸»è¦è§’è‰²ï¼Œå¿…é¡»æä¾›å…¶æœ¬å)", "text": "è¿™æ˜¯ä¸€ä¸ªæ¥è‡ªå…¶ä»–è§’è‰²çš„äº’åŠ¨è¯„è®ºã€‚" }
        ]
      }
    ]
    \`\`\`
    - **comments**: 
        -   è¯„è®ºè€…å¯ä»¥æ˜¯è·¯äººï¼Œä¹Ÿå¯ä»¥æ˜¯è§’è‰²åˆ—è¡¨ä¸­çš„å…¶ä»–è§’è‰²ã€‚è¯„è®ºåŒºã€å¿…é¡»ã€‘ä½“ç°å‡ºäº’åŠ¨æ€§ã€‚
        -   ã€è¯„è®ºèº«ä»½ã€‘: å¦‚æœè¯„è®ºè€…æ˜¯ã€ä¸»è¦è§’è‰²ã€‘ï¼Œä½ ã€å¿…é¡»ã€‘ä¸ºå…¶æ·»åŠ  \`commenterOriginalName\` å­—æ®µï¼Œå¹¶å¡«å…¥å…¶æœ¬åã€‚å¦‚æœæ˜¯è·¯äººNPCï¼Œåˆ™çœç•¥æ­¤å­—æ®µã€‚

# ä¾›ä½ å‚è€ƒçš„ä¸Šä¸‹æ–‡
${doubanSettingContext}
${sharedWorldBookContext}

# å½“å‰æƒ…æ™¯
- **å½“å‰çœŸå®æ—¶é—´**: ${currentTimeString}

# ã€ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰çš„èº«ä»½æ¡£æ¡ˆã€‘
- **æ˜µç§°**: ${userNickname}
- **äººè®¾**: ${userPersona}

# ç»Ÿä¸€è§’è‰²åˆ—è¡¨ (ä½ æ‰®æ¼”çš„è§’è‰² + è·¯äººNPC)
${charactersContext}

ç°åœ¨ï¼Œè¯·ä¸¥æ ¼éµå®ˆæ‰€æœ‰è§„åˆ™ï¼Œç‰¹åˆ«æ˜¯ã€æ—¶é—´æ„ŸçŸ¥ã€‘å’Œã€ç¦æ­¢æ‰®æ¼”ç”¨æˆ·ã€‘çš„é“å¾‹ï¼Œå¼€å§‹ç”Ÿæˆè¿™ç»„ç”ŸåŠ¨ã€å¤šæ ·ä¸”å……æ»¡â€œè±†ç“£å‘³â€çš„å°ç»„å¸–å­ã€‚`;

    try {
        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®è§’è‰²åˆ—è¡¨ï¼Œç”Ÿæˆè±†ç“£å°ç»„å¸–å­ã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 1.0,
                })
            });

        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        
        const jsonMatch = aiResponseContent.match(/\[[\s\S]*\]/);
        
        if (!jsonMatch) {
            throw new Error(`AIè¿”å›çš„å†…å®¹ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚åŸå§‹è¿”å›: ${aiResponseContent}`);
        }
        
        const simulatedPosts = JSON.parse(jsonMatch[0]);
        await db.doubanPosts.clear();
        await db.doubanPosts.bulkAdd(simulatedPosts.map(p => ({...p, timestamp: Date.now() - Math.random() * 100000})));
        
        await renderDoubanScreen();
        
    } catch (error) {
        console.error("ç”Ÿæˆè±†ç“£å¸–å­å¤±è´¥:", error);
        await showCustomAlert("ç”Ÿæˆå¤±è´¥", `æ— æ³•ç”Ÿæˆå†…å®¹ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åå†è¯•ã€‚\né”™è¯¯: ${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
/**
 * ã€V3.5 | æœ€ç»ˆå¤´åƒç»Ÿä¸€ä¿®å¤ç‰ˆã€‘æ‰“å¼€å¹¶æ¸²æŸ“æŒ‡å®šçš„å¸–å­è¯¦æƒ…é¡µ
 * @param {number} postId - å¸–å­çš„ID
 */
async function openDoubanPostDetail(postId) {
    showScreen('douban-post-detail-screen');
    activeDoubanPostId = postId;
    const post = await db.doubanPosts.get(postId);
    if (!post) {
        showScreen('douban-screen');
        return;
    }

    document.getElementById('douban-post-detail-title').textContent = 'å¸–å­è¯¦æƒ…';

    // (è¿™éƒ¨åˆ†æ¸²æŸ“å¸–å­ä½œè€…ä¿¡æ¯çš„é€»è¾‘æ˜¯æ­£ç¡®çš„ï¼Œæˆ‘ä»¬å…ˆåœ¨è¿™é‡Œè·å–åˆ°æ­£ç¡®çš„ä½œè€…å¤´åƒ)
    let authorAvatar = defaultAvatar;
    let authorDisplayName = post.authorName; 

    const authorChatByOriginalName = post.authorOriginalName
        ? Object.values(state.chats).find(c => !c.isGroup && c.originalName === post.authorOriginalName)
        : null;

    if (authorChatByOriginalName) {
        authorAvatar = authorChatByOriginalName.settings.aiAvatar;
    } else {
        const authorChatByName = Object.values(state.chats).find(c => !c.isGroup && c.name === post.authorName);
        if (authorChatByName) {
            authorAvatar = authorChatByName.settings.aiAvatar;
        } else if (post.authorAvatarPrompt) {
            authorAvatar = `https://image.pollinations.ai/prompt/${encodeURIComponent(post.authorAvatarPrompt)}`;
        }
    }
    
    // (å¡«å……å¸–å­æ­£æ–‡éƒ¨åˆ†çš„ä¿¡æ¯)
    document.getElementById('douban-detail-avatar').src = authorAvatar;
    document.getElementById('douban-detail-author').textContent = authorDisplayName;
    document.getElementById('douban-detail-group').textContent = `æ¥è‡ª ${post.groupName}`;
    document.getElementById('douban-detail-post-title').textContent = post.postTitle;
    document.getElementById('douban-detail-content').innerHTML = post.content.replace(/\n/g, '<br>');
    document.getElementById('douban-my-comment-avatar').src = state.qzoneSettings.avatar;
    document.getElementById('douban-comment-input').value = '';

    const commentsListEl = document.getElementById('douban-detail-comments-list');
    commentsListEl.innerHTML = '';

    // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
    if (post.comments && post.comments.length > 0) {
        // 1. ã€å…¨æ–°ã€‘åˆ›å»ºä¸€ä¸ªMapæ¥â€œè®°ä½â€æ¯ä¸ªè¯„è®ºè€…çš„å¤´åƒï¼Œç¡®ä¿ä¸€è‡´æ€§
        const commenterAvatarMap = new Map();

        post.comments.forEach(comment => {
            let commenterAvatar = defaultAvatar; // é»˜è®¤å¤´åƒ
            const myNickname = state.qzoneSettings.nickname || 'æˆ‘';
            const commenterName = comment.commenter; // è·å–å½“å‰è¯„è®ºè€…çš„åå­—

            // 2. ã€æ™ºèƒ½æŸ¥æ‰¾ã€‘æ£€æŸ¥æ˜¯å¦å·²ç»ä¸ºè¿™ä¸ªè¯„è®ºè€…ç¡®å®šè¿‡å¤´åƒäº†
            if (commenterAvatarMap.has(commenterName)) {
                // å¦‚æœå·²ç»è®°ä½äº†ï¼Œç›´æ¥ä½¿ç”¨è®°ä½çš„å¤´åƒï¼Œè·³è¿‡æ‰€æœ‰æŸ¥æ‰¾ï¼
                commenterAvatar = commenterAvatarMap.get(commenterName);
            } else {
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°è¿™ä¸ªè¯„è®ºè€…ï¼Œå°±æ‰§è¡Œå®Œæ•´çš„æŸ¥æ‰¾é€»è¾‘
                if (commenterName === myNickname) {
                    commenterAvatar = state.qzoneSettings.avatar;
                }
                else if (commenterName === post.authorName) {
                    commenterAvatar = authorAvatar;
                }
                else {
                    const commenterChatByOriginalName = comment.commenterOriginalName
                        ? Object.values(state.chats).find(c => !c.isGroup && c.originalName === comment.commenterOriginalName)
                        : null;
                    
                    if (commenterChatByOriginalName) {
                        commenterAvatar = commenterChatByOriginalName.settings.aiAvatar;
                    } else {
                        const commenterChatByName = Object.values(state.chats).find(c => !c.isGroup && c.name === commenterName);
                        if (commenterChatByName) {
                            commenterAvatar = commenterChatByName.settings.aiAvatar;
                        } else if (comment.avatar_prompt) {
                            commenterAvatar = `https://image.pollinations.ai/prompt/${encodeURIComponent(comment.avatar_prompt)}`;
                        }
                    }
                }
                // 3. ã€å…³é”®ã€‘å°†æ‰¾åˆ°çš„å¤´åƒå­˜å…¥Mapä¸­ï¼Œä»¥ä¾¿ä¸‹æ¬¡ç›´æ¥ä½¿ç”¨
                commenterAvatarMap.set(commenterName, commenterAvatar);
            }
            
            // (åç»­çš„HTMLæ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜)
            const commentEl = document.createElement('div');
            commentEl.className = 'douban-comment-item';
            commentEl.innerHTML = `
                <img src="${commenterAvatar}" class="douban-comment-avatar">
                <div class="douban-comment-body">
                    <div class="douban-comment-author">${commenterName}</div>
                    <div class="douban-comment-text">${comment.text.replace(/\n/g, '<br>')}</div>
                </div>
            `;
            commentsListEl.appendChild(commentEl);
        });
    } else {
        commentsListEl.innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">è¿˜æ²¡æœ‰å›åº”</p>';
    }
    // â–²â–²â–² ã€ã€ã€ä¿®å¤ç»“æŸã€‘ã€‘ã€‘ â–²â–²â–²
    
    const contentWrapper = document.getElementById('douban-detail-content-wrapper');
    if(contentWrapper) contentWrapper.scrollTop = 0;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–° | AIäº’åŠ¨å¢å¼ºç‰ˆã€‘è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ handleSendDoubanComment å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·å‘é€è±†ç“£è¯„è®ºçš„é€»è¾‘ï¼Œå¹¶è§¦å‘AIäº’åŠ¨
 */
async function handleSendDoubanComment() {
    if (!activeDoubanPostId) return;

    const input = document.getElementById('douban-comment-input');
    const commentText = input.value.trim();
    if (!commentText) return;

    const post = await db.doubanPosts.get(activeDoubanPostId);
    if (!post) return;

    if (!post.comments) {
        post.comments = [];
    }
    
    const myNickname = state.qzoneSettings.nickname || 'æˆ‘';
    
    post.comments.push({
        commenter: myNickname,
        text: commentText
    });
    post.commentsCount++;

    await db.doubanPosts.put(post);
    input.value = '';
    
    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å‘é€è¯„è®ºåï¼Œç«‹åˆ»é‡æ–°æ¸²æŸ“è¯¦æƒ…é¡µï¼Œä¿è¯æ‚¨çš„æ–°è¯„è®ºèƒ½æ˜¾ç¤ºå‡ºæ¥
    await openDoubanPostDetail(activeDoubanPostId);


}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå…¨æ–°ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ handleDoubanWaitReply å‡½æ•° â–¼â–¼â–¼
async function handleDoubanWaitReply() {
    if (!activeDoubanPostId) return;

    const postId = activeDoubanPostId;
    const post = await db.doubanPosts.get(postId);
    if (!post) return;

    const lastComment = post.comments && post.comments.slice(-1)[0];
    if (!lastComment) {
        alert("è¿˜æ²¡æœ‰ä»»ä½•è¯„è®ºï¼Œæ— æ³•ç­‰å¾…å›å¤ã€‚");
        return;
    }

    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨è¯·æ±‚AIè§’è‰²ä»¬åŠ å…¥è®¨è®º...");

    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            throw new Error('APIæœªé…ç½®ï¼Œæ— æ³•ç”Ÿæˆå†…å®¹ã€‚');
        }

        const userNickname = state.qzoneSettings.nickname || 'æˆ‘';
        const userPersona = state.chats[Object.keys(state.chats)[0]]?.settings.myPersona || '(æœªè®¾ç½®)';
        
        const existingNpcs = new Map();
        if (post.comments) {
            post.comments.forEach(comment => {
                const isMainCharacter = (state.globalSettings.doubanActiveCharacterIds || []).some(id => state.chats[id]?.name === comment.commenter);
                if (!isMainCharacter && comment.avatar_prompt) {
                    existingNpcs.set(comment.commenter, comment.avatar_prompt);
                }
            });
        }
        
        let existingNpcContext = "# å·²æœ‰è·¯äººNPCå¤´åƒæŒ‡ä»¤ (å¿…é¡»éµå®ˆï¼)\n";
        if (existingNpcs.size > 0) {
            existingNpcContext += "å¦‚æœä»¥ä¸‹ä»»ä½•ä¸€ä½NPCå†æ¬¡è¯„è®ºï¼Œä½ ã€å¿…é¡»ã€‘ä½¿ç”¨æˆ‘ä»¬æä¾›çš„ã€å®Œå…¨ç›¸åŒçš„`avatar_prompt`ï¼Œä»¥ä¿æŒå¤´åƒä¸€è‡´æ€§ã€‚\n";
            existingNpcs.forEach((prompt, name) => {
                existingNpcContext += `- **${name}**: "${prompt}"\n`;
            });
        } else {
            existingNpcContext += "ï¼ˆå½“å‰å¸–å­è¿˜æ²¡æœ‰è·¯äººNPCå‘è¡¨è¯„è®ºã€‚ï¼‰\n";
        }

        const doubanWorldBook = state.worldBooks.find(wb => wb.name === 'è±†ç“£è®¾å®š');
        let npcCharacters = [];
        if (doubanWorldBook) {
            doubanWorldBook.content.forEach(entry => {
                if (entry.comment.includes('NPCäººè®¾')) {
                    const lines = entry.content.split('\n');
                    lines.forEach(line => {
                        const match = line.match(/- \*\*æ˜µç§°\*\*:\s*(.*?)\s*\*\*äººè®¾\*\*:\s*(.*)/);
                        if (match) {
                            npcCharacters.push({ name: match[1].trim(), persona: match[2].trim() });
                        }
                    });
                }
            });
        }
        
        let charactersContext = '';
        const activeCharacterIds = state.globalSettings.doubanActiveCharacterIds || [];
        activeCharacterIds.forEach(charId => {
            const c = state.chats[charId];
            if (c) {
                const longTermMemory = c.longTermMemory && c.longTermMemory.length > 0 ? c.longTermMemory.map(m => m.content).join('; ') : 'æ— ';
                const recentHistory = c.history.slice(-10).map(msg => `${msg.role === 'user' ? userNickname : c.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
                charactersContext += `\n- ${c.name}: ${c.settings.aiPersona.substring(0,50)}... [è®°å¿†: ${longTermMemory}] [æœ€è¿‘å¯¹è¯: ${recentHistory}]`;
            }
        });
        npcCharacters.forEach(npc => {
            charactersContext += `\n- ${npc.name}: ${npc.persona}`;
        });

        // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹1ï¼šåœ¨è¿™é‡Œä¹Ÿè·å–å½“å‰æ—¶é—´ â–²â–²â–²
        const now = new Date();
        const currentTimeString = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });

        // â–²â–²â–² æ ¸å¿ƒä¿®æ”¹2ï¼šæ›´æ–°ç³»ç»ŸæŒ‡ä»¤ï¼ŒåŠ å…¥æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ â–²â–²â–²
        const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç¤¾åŒºçš„AIå¯¼æ¼”ã€‚ä¸‹é¢çš„â€œå¸–å­æ‘˜è¦â€å’Œâ€œå·²æœ‰è¯„è®ºâ€æ¥è‡ªäºä¸€ä¸ªè±†ç“£å°ç»„çš„å¸–å­ã€‚ç”¨æˆ·â€œ${userNickname}â€åˆšåˆšå¯¹æœ€åä¸€æ¡è¯„è®ºç‚¹å‡»äº†â€œç­‰å¾…å›å¤â€ï¼ŒTAå¸Œæœ›çœ‹åˆ°æ›´å¤šè§’è‰²å‚ä¸è®¨è®ºã€‚
ä½ çš„ä»»åŠ¡æ˜¯ï¼šæ ¹æ®æ‰€æœ‰è§’è‰²çš„è®¾å®šï¼Œé€‰æ‹©ã€10åˆ°20ä½ã€‘æœ€é€‚åˆå‚ä¸è®¨è®ºçš„è§’è‰²ï¼Œè®©ä»–ä»¬é’ˆå¯¹å·²æœ‰è¯„è®ºï¼Œå‘è¡¨ã€å…¨æ–°çš„ã€ç¬¦åˆäººè®¾çš„ã€‘å›åº”ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€æ—¶é—´æ„ŸçŸ¥ã€‘**:
    -   ä½ ã€å¿…é¡»ã€‘æ„è¯†åˆ°å½“å‰æ˜¯ **${currentTimeString}**ã€‚
    -   ä½ çš„è¯„è®ºå†…å®¹ã€å¿…é¡»ã€‘è‡ªç„¶åœ°ä½“ç°å‡ºå¯¹ã€å½“å‰çœŸå®æ—¶é—´ã€‘çš„æ„ŸçŸ¥ã€‚
2.  **ã€ç¦æ­¢æ‰®æ¼”ç”¨æˆ· (æœ€æœ€æœ€é«˜ä¼˜å…ˆçº§ï¼ï¼ï¼)ã€‘**:
    -   ç”¨æˆ·çš„æ˜µç§°æ˜¯â€œ${userNickname}â€ã€‚
    -   ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ commenter å­—æ®µä¸º â€œ${userNickname}â€ çš„è¯„è®ºã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
3.  **ã€äº’åŠ¨ã€‘**: æ–°ç”Ÿæˆçš„è¯„è®ºã€å¿…é¡»ã€‘æ˜¯é’ˆå¯¹ã€å·²æœ‰è¯„è®ºã€‘çš„å»¶ç»­æˆ–å›åº”ï¼Œè®©è®¨è®ºèƒ½ç»§ç»­ä¸‹å»ã€‚
4.  **ã€å¤´åƒä¸€è‡´æ€§ (æœ€é«˜ä¼˜å…ˆçº§ï¼)ã€‘**: ä½ ã€å¿…é¡»ã€‘å‚è€ƒä¸‹é¢çš„â€œå·²æœ‰è·¯äººNPCå¤´åƒæŒ‡ä»¤â€åˆ—è¡¨ã€‚å¦‚æœä¸€ä¸ªå·²æœ‰çš„NPCå†æ¬¡å‘è¨€ï¼Œã€å¿…é¡»ã€‘å¤ç”¨å®ƒæ—§çš„å¤´åƒæŒ‡ä»¤ã€‚åªæœ‰åœ¨åˆ›é€ ä¸€ä¸ªã€å…¨æ–°çš„ã€ä»æœªå‡ºç°è¿‡çš„ã€‘NPCæ—¶ï¼Œæ‰ä¸ºå…¶ç”Ÿæˆæ–°çš„å¤´åƒæŒ‡ä»¤ã€‚
5.  **ã€æ ¼å¼ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä»£è¡¨ä¸€æ¡æ–°è¯„è®ºï¼Œæ ¼å¼ã€å¿…é¡»ã€‘å¦‚ä¸‹:
    \`\`\`json
    [
      { "commenter": "è§’è‰²Açš„åå­—", "text": "è§’è‰²Açš„æ–°è¯„è®ºå†…å®¹ã€‚", "avatar_prompt": "(å¯é€‰)å¦‚æœè¯„è®ºè€…æ˜¯ã€å…¨æ–°çš„ã€‘NPC,æä¾›å¤´åƒæŒ‡ä»¤" },
      { "commenter": "è§’è‰²Bçš„åå­—", "text": "è§’è‰²Bå¯¹è§’è‰²Aæˆ–æ¥¼ä¸»çš„çœ‹æ³•ã€‚" }
    ]
    \`\`\`

# ä¸Šä¸‹æ–‡
- **å¸–å­æ ‡é¢˜**: ã€Š${post.postTitle}ã€‹
- **å‘å¸–äºº**: ${post.authorName}
- **å¸–å­å†…å®¹æ‘˜è¦**: ${post.content.substring(0, 100)}...
- **å·²æœ‰è¯„è®º**:
${post.comments.map(c => `- ${c.commenter}: ${c.text}`).join('\n')}

${existingNpcContext}

# å½“å‰æƒ…æ™¯
- **å½“å‰çœŸå®æ—¶é—´**: ${currentTimeString}

# ã€ä½ çš„èŠå¤©å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰çš„äººè®¾ã€‘
- **æ˜µç§°**: ${userNickname}
- **äººè®¾**: ${userPersona}

# ä½ çš„è§’è‰²åº“ (ä½ å¯ä»¥ä»ä¸­é€‰æ‹©ã€ä»»ä½•è§’è‰²ã€‘è¿›è¡Œè¯„è®ºï¼Œå¹¶å‚è€ƒä»–ä»¬çš„è®°å¿†å’Œå¯¹è¯)
${charactersContext}

ç°åœ¨ï¼Œè¯·ç”Ÿæˆæ–°çš„è¯„è®ºã€‚`;

        const messagesForApi = [{ role: 'user', content: "è¯·æ ¹æ®ä»¥ä¸Šæƒ…æ™¯ï¼Œç”Ÿæˆæ–°çš„è¯„è®ºã€‚" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 1.0,
                })
            });

        if (!response.ok) throw new Error(`API é”™è¯¯: ${response.statusText}`);
        
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
        const newComments = JSON.parse(cleanedJson);

        if (Array.isArray(newComments) && newComments.length > 0) {
            post.comments.push(...newComments);
            post.commentsCount += newComments.length;
            await db.doubanPosts.put(post);
        }

        await openDoubanPostDetail(postId);
        
        hideCustomModal();

    } catch (error) {
        console.error("ç­‰å¾…å›å¤å¤±è´¥:", error);
        await showCustomAlert("æ“ä½œå¤±è´¥", `æ— æ³•è·å–AIå›å¤ï¼Œè¯·æ£€æŸ¥APIé…ç½®æˆ–ç¨åå†è¯•ã€‚\né”™è¯¯: ${error.message}`);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸¤ä¸ªæ–°å‡½æ•°ï¼Œç²˜è´´åˆ° init() å‡½æ•°çš„ä¸Šæ–¹ â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€è±†ç“£è§’è‰²é€‰æ‹©å™¨å¼¹çª—
 */
async function openDoubanCastSelector() {
    const modal = document.getElementById('douban-cast-modal');
    const listEl = document.getElementById('douban-cast-list');
    listEl.innerHTML = '';

    const allCharacters = Object.values(state.chats).filter(c => !c.isGroup);
    // ä»å…¨å±€è®¾ç½®ä¸­è¯»å–å·²ä¿å­˜çš„é€‰æ‹©
    const activeIds = new Set(state.globalSettings.doubanActiveCharacterIds || []);

    if (allCharacters.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; padding: 50px 0;">è¿˜æ²¡æœ‰å¯ä»¥å‚ä¸çš„è§’è‰²ã€‚</p>';
    } else {
        allCharacters.forEach(char => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item'; // å¤ç”¨è”ç³»äººé€‰æ‹©å™¨çš„æ ·å¼
            item.innerHTML = `
                <input type="checkbox" class="douban-cast-checkbox" data-chat-id="${char.id}" ${activeIds.has(char.id) ? 'checked' : ''} style="margin-right: 15px;">
                <img src="${char.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${char.name}</span>
            `;
            listEl.appendChild(item);
        });
    }
    modal.classList.add('visible');
}

/**
 * ã€å…¨æ–°ã€‘ä¿å­˜ç”¨æˆ·é€‰æ‹©çš„è±†ç“£è§’è‰²
 */
async function saveDoubanCastSelection() {
    const selectedCheckboxes = document.querySelectorAll('#douban-cast-list .douban-cast-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.chatId);

    // å°†é€‰æ‹©ä¿å­˜åˆ°å…¨å±€è®¾ç½®ä¸­
    state.globalSettings.doubanActiveCharacterIds = selectedIds;
    await db.globalSettings.put(state.globalSettings);

    document.getElementById('douban-cast-modal').classList.remove('visible');
    
    // ã€å…³é”®ã€‘ä¿å­˜åï¼Œç«‹å³ä½¿ç”¨æ–°çš„è§’è‰²é˜µå®¹é‡æ–°ç”Ÿæˆå¸–å­ï¼
    await handleGenerateDoubanPosts();
}
// â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´ä¸‹é¢è¿™æ•´å—ä»£ç  â–¼â–¼â–¼
// ç»‘å®šè±†ç“£è§’è‰²é€‰æ‹©åŠŸèƒ½çš„æŒ‰é’®
document.getElementById('douban-cast-select-btn').addEventListener('click', openDoubanCastSelector);
document.getElementById('cancel-douban-cast-btn').addEventListener('click', () => {
    document.getElementById('douban-cast-modal').classList.remove('visible');
});
document.getElementById('save-douban-cast-btn').addEventListener('click', saveDoubanCastSelection);
// ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºåˆ—è¡¨é¡¹çš„ç‚¹å‡»æ·»åŠ åˆ‡æ¢é€‰ä¸­çŠ¶æ€çš„åŠŸèƒ½
document.getElementById('douban-cast-list').addEventListener('click', (e) => {
    const item = e.target.closest('.contact-picker-item');
    if (item) {
        const checkbox = item.querySelector('.douban-cast-checkbox');
        if (checkbox && e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
        }
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯å¯¼å…¥å¤–è§‚è®¾ç½®çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç ã€‘ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼ */

/**
 * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·é€‰æ‹©äº†å¤–è§‚è®¾ç½®çš„JSONæ–‡ä»¶åï¼Œç”±æ­¤å‡½æ•°å¼€å§‹å¤„ç†
 * @param {File} file - ç”¨æˆ·é€‰æ‹©çš„ .json å¤‡ä»½æ–‡ä»¶
 */
async function importAppearanceSettings(file) {
    if (!file) return;

    // 1. å¼¹å‡ºç¡®è®¤æ¡†ï¼Œé˜²æ­¢ç”¨æˆ·è¯¯æ“ä½œ
    const confirmed = await showCustomConfirm(
        'å¯¼å…¥å¤–è§‚è®¾ç½®',
        'è¿™å°†ç”¨æ–‡ä»¶ä¸­çš„è®¾ç½®è¦†ç›–å½“å‰çš„æ‰€æœ‰å¤–è§‚è®¾ç½®ï¼ˆåŒ…æ‹¬å£çº¸ã€å›¾æ ‡ã€å­—ä½“ã€CSSç­‰ï¼‰ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
        { confirmText: 'ç¡®è®¤å¯¼å…¥' }
    );

    if (!confirmed) return;

    try {
        // 2. è¯»å–å¹¶è§£æJSONæ–‡ä»¶
        const text = await file.text();
        const data = JSON.parse(text);

        // 3. éªŒè¯æ–‡ä»¶æœ‰æ•ˆæ€§ï¼ˆæ£€æŸ¥æ˜¯å¦åŒ…å«å…³é”®çš„å¤–è§‚è®¾ç½®å­—æ®µï¼‰
        if (!data.wallpaper && !data.globalCss && !data.appIcons) {
            throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘å…³é”®çš„å¤–è§‚è®¾ç½®é¡¹ã€‚");
        }

        // 4. å°†å¯¼å…¥çš„è®¾ç½®åˆå¹¶åˆ°å½“å‰çš„å…¨å±€è®¾ç½®ä¸­
        //    æˆ‘ä»¬ä½¿ç”¨Object.assignæ¥ç¡®ä¿å³ä½¿æœªæ¥å¢åŠ äº†æ–°çš„è®¾ç½®é¡¹ï¼Œæ—§çš„å¤‡ä»½æ–‡ä»¶ä¹Ÿä¸ä¼šå¯¼è‡´å®ƒä»¬ä¸¢å¤±
        Object.assign(state.globalSettings, data);

        // 5. å°†æ›´æ–°åçš„å®Œæ•´è®¾ç½®ä¿å­˜åˆ°æ•°æ®åº“
        await db.globalSettings.put(state.globalSettings);
        
        // 6. ç«‹å³åº”ç”¨æ‰€æœ‰æ–°è®¾ç½®ï¼Œè®©æ›´æ”¹å³æ—¶ç”Ÿæ•ˆ
        applyGlobalWallpaper();
        applyCPhoneWallpaper();
        applyAppIcons();
        applyCPhoneAppIcons();
        applyGlobalCss(state.globalSettings.globalCss);
        applyCustomFont(state.globalSettings.fontUrl);
        applyStatusBarVisibility();
        applyWidgetData();

        // 7. é‡æ–°æ¸²æŸ“å¤–è§‚è®¾ç½®é¡µé¢ï¼Œä»¥æ˜¾ç¤ºæœ€æ–°çš„è®¾ç½®å€¼
        renderWallpaperScreen();
        
        // 8. ç»™å‡ºæˆåŠŸæç¤º
        await showCustomAlert('å¯¼å…¥æˆåŠŸ', 'å¤–è§‚è®¾ç½®å·²æˆåŠŸå¯¼å…¥å¹¶åº”ç”¨ï¼');

    } catch (error) {
        // å¦‚æœè¿‡ç¨‹ä¸­å‡ºç°ä»»ä½•é”™è¯¯ï¼Œåˆ™æ•è·å¹¶æç¤ºç”¨æˆ·
        console.error("å¯¼å…¥å¤–è§‚è®¾ç½®æ—¶å‡ºé”™:", error);
        await showCustomAlert('å¯¼å…¥å¤±è´¥', `æ–‡ä»¶è§£ææˆ–åº”ç”¨å¤±è´¥: ${error.message}`);
    }
}

/* â–²â–²â–² æ ¸å¿ƒJSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² */
// ===================================================================
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åå°æ´»åŠ¨æ¨¡æ‹ŸåŠŸèƒ½çš„æ ¸å¿ƒä»£ç  â–¼â–¼â–¼
// ===================================================================

/**
 * æ¨¡æ‹Ÿè§’è‰²åœ¨Appå…³é—­æœŸé—´çš„åå°æ´»åŠ¨
 * @param {number} minutesOffline - Appå¤„äºç¦»çº¿çŠ¶æ€çš„æ€»åˆ†é’Ÿæ•°
 */
async function simulateBackgroundActivity(minutesOffline) {
    console.log(`æ£€æµ‹åˆ°åº”ç”¨ç¦»çº¿äº† ${minutesOffline.toFixed(1)} åˆ†é’Ÿï¼Œå¼€å§‹æ¨¡æ‹Ÿåå°æ´»åŠ¨...`);

    // ç­›é€‰å‡ºæ‰€æœ‰å¼€å¯äº†â€œç‹¬ç«‹åå°æ´»åŠ¨â€çš„å•èŠè§’è‰²
    const activeCharacters = Object.values(state.chats).filter(chat => 
        !chat.isGroup && 
        chat.settings.enableBackgroundActivity && 
        chat.relationship?.status === 'friend'
    );
    
    if (activeCharacters.length === 0) {
        console.log("æ²¡æœ‰é…ç½®ä¸ºåå°æ´»è·ƒçš„è§’è‰²ï¼Œè·³è¿‡æ¨¡æ‹Ÿã€‚");
        return; // å¦‚æœæ²¡æœ‰æ´»è·ƒè§’è‰²ï¼Œç›´æ¥é€€å‡º
    }

    // éå†æ¯ä¸€ä¸ªæ´»è·ƒçš„è§’è‰²
    for (const char of activeCharacters) {
        // æ£€æŸ¥è¿™ä¸ªè§’è‰²çš„è¡ŒåŠ¨å†·å´æ—¶é—´
        const cooldownMinutes = char.settings.actionCooldownMinutes || 15; // é»˜è®¤15åˆ†é’Ÿ
        const timeSinceLastAction = char.lastActionTimestamp 
            ? (Date.now() - char.lastActionTimestamp) / (1000 * 60)
            : Infinity; // å¦‚æœä»æœªè¡ŒåŠ¨è¿‡ï¼Œåˆ™è§†ä¸ºå†·å´å·²ç»“æŸ

        // å¦‚æœç¦»çº¿æ—¶é—´è¶…è¿‡äº†è§’è‰²çš„å†·å´æ—¶é—´ï¼Œä¸”ä¸Šæ¬¡è¡ŒåŠ¨ä¹Ÿåœ¨å†·å´æœŸä¹‹å¤–
        if (minutesOffline > cooldownMinutes && timeSinceLastAction > cooldownMinutes) {
            
            // ç”¨ä¸€ä¸ªéšæœºæ•°æ¥å†³å®šè§’è‰²æ˜¯å¦çœŸçš„è¡ŒåŠ¨ï¼Œé¿å…æ¯æ¬¡éƒ½è¡ŒåŠ¨
            // ä¾‹å¦‚ï¼Œè¿™é‡Œæˆ‘ä»¬è®¾ç½®ä¸€ä¸ª30%çš„è¡ŒåŠ¨æ¦‚ç‡
            if (Math.random() < 0.3) {
                console.log(`è§’è‰² "${char.name}" è§¦å‘äº†åå°è¡ŒåŠ¨ï¼`);
                
                // ä¸ºäº†è®©æ¨¡æ‹Ÿæ›´çœŸå®ï¼Œæˆ‘ä»¬éšæœºå†³å®šTAæ˜¯å‘æ¶ˆæ¯è¿˜æ˜¯å‘åŠ¨æ€
                if (Math.random() < 0.7) { // 70% æ¦‚ç‡å‘æ¶ˆæ¯
                    // è°ƒç”¨æˆ‘ä»¬ä¹‹å‰å·²æœ‰çš„AIè¡ŒåŠ¨å‡½æ•°
                    await triggerInactiveAiAction(char.id);
                } else { // 30% æ¦‚ç‡å‘åŠ¨æ€
                    // æ‚¨ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨å‘åŠ¨æ€çš„AIå‡½æ•°
                    console.log(`è§’è‰² "${char.name}" å†³å®šå»å‘ä¸€æ¡åŠ¨æ€... (æ­¤å¤„ä¸ºæ¨¡æ‹Ÿ)`);
                }
            }
        }
    }
}
// â–²â–²â–² ã€å…¨æ–°ã€‘åå°æ´»åŠ¨æ¨¡æ‹ŸåŠŸèƒ½çš„æ ¸å¿ƒä»£ç ç»“æŸ â–²â–²â–²
/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯èŠå¤©è®°å½•æœç´¢åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç ã€‘ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼ */

/**
 * ã€æ€»å…¥å£ã€‘æ‰“å¼€èŠå¤©è®°å½•æœç´¢å±å¹•
 */
function openSearchHistoryScreen() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    
    // æ¸…ç©ºä¸Šæ¬¡çš„æœç´¢æ¡ä»¶å’Œç»“æœ
    document.getElementById('keyword-search-input').value = '';
    document.getElementById('date-search-input').value = '';
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæŒ‡å‘æ–°çš„ID â˜…â˜…â˜…
    document.getElementById('chat-search-results-list').innerHTML = `<p style="text-align:center; color: var(--text-secondary);">è¾“å…¥å…³é”®è¯æˆ–é€‰æ‹©æ—¥æœŸè¿›è¡Œæœç´¢ã€‚</p>`;
    
    // åˆ‡æ¢å±å¹•
    showScreen('search-history-screen');
}

/**
 * ã€æ ¸å¿ƒã€‘æ‰§è¡Œæœç´¢é€»è¾‘
 */
async function handleSearchHistory() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const keyword = document.getElementById('keyword-search-input').value.trim().toLowerCase();
    const dateValue = document.getElementById('date-search-input').value;

    if (!keyword && !dateValue) {
        alert("è¯·è¾“å…¥å…³é”®è¯æˆ–é€‰æ‹©ä¸€ä¸ªæ—¥æœŸã€‚");
        return;
    }

    let results = chat.history.filter(msg => !msg.isHidden);

    // 1. æŒ‰å…³é”®è¯ç­›é€‰
    if (keyword) {
        results = results.filter(msg => {
            let contentString = '';
            // æ™ºèƒ½æå–ä¸åŒç±»å‹æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹
            if (typeof msg.content === 'string') {
                contentString = msg.content;
            } else if (msg.type === 'voice_message') {
                contentString = msg.content;
            } else if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                contentString = msg.content;
            } else if (msg.type === 'offline_text') {
                contentString = `${msg.dialogue || ''} ${msg.description || ''}`;
            } else if (msg.quote) {
                 contentString = msg.content;
            }
            return contentString.toLowerCase().includes(keyword);
        });
    }

    // 2. æŒ‰æ—¥æœŸç­›é€‰
    if (dateValue) {
        const selectedDate = new Date(dateValue);
        const startOfDay = new Date(selectedDate.setHours(0, 0, 0, 0)).getTime();
        const endOfDay = new Date(selectedDate.setHours(23, 59, 59, 999)).getTime();
        
        results = results.filter(msg => msg.timestamp >= startOfDay && msg.timestamp <= endOfDay);
    }
    
    // æ¸²æŸ“æœç´¢ç»“æœ
    await renderSearchResults(results);
}


/**
 * å°†æœç´¢ç»“æœæ¸²æŸ“åˆ°å±å¹•ä¸Š
 * @param {Array} results - ç­›é€‰åçš„æ¶ˆæ¯å¯¹è±¡æ•°ç»„
 */
async function renderSearchResults(results) {
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæŒ‡å‘æ–°çš„ID â˜…â˜…â˜…
    const listEl = document.getElementById('chat-search-results-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    if (results.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">æœªæ‰¾åˆ°ç›¸å…³çš„èŠå¤©è®°å½•ã€‚</p>';
        return;
    }

    let lastDateString = '';
    for (const msg of results) {
        const msgDate = new Date(msg.timestamp);
        const currentDateString = msgDate.toLocaleDateString();

        // å¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼Œæ·»åŠ æ—¥æœŸåˆ†éš”ç¬¦
        if (currentDateString !== lastDateString) {
            const dateSeparator = document.createElement('div');
            dateSeparator.className = 'date-separator';
            dateSeparator.textContent = `--- ${msgDate.getFullYear()}å¹´${msgDate.getMonth() + 1}æœˆ${msgDate.getDate()}æ—¥ ---`;
            listEl.appendChild(dateSeparator);
            lastDateString = currentDateString;
        }

        // å¤ç”¨ç°æœ‰çš„ createMessageElement å‡½æ•°æ¥åˆ›å»ºæ¶ˆæ¯æ°”æ³¡
        const messageEl = await createMessageElement(msg, chat);
        if (messageEl) {
            // ä¸ºç»“æœé¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œä»¥ä¾¿è·³è½¬
            messageEl.style.cursor = 'pointer';
            messageEl.addEventListener('click', () => jumpToOriginalMessage(msg.timestamp));
            listEl.appendChild(messageEl);
        }
    }
}

/**
 * ä»æœç´¢ç»“æœè·³è½¬å›åŸå§‹æ¶ˆæ¯ä½ç½®
 * @param {number} timestamp - ç›®æ ‡æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function jumpToOriginalMessage(timestamp) {
    // 1. åˆ‡æ¢å›èŠå¤©ç•Œé¢
    showScreen('chat-interface-screen');
    
    // 2. å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿UIå·²åˆ‡æ¢å®Œæˆ
    setTimeout(() => {
        // 3. è°ƒç”¨æˆ‘ä»¬ä¹‹å‰å·²æœ‰çš„é«˜äº®æ»šåŠ¨å‡½æ•°
        scrollToOriginalMessage(timestamp);
    }, 100);
}


/**
 * é‡ç½®æœç´¢è¿‡æ»¤å™¨å¹¶æ˜¾ç¤ºæ‰€æœ‰è®°å½•
 */
async function clearSearchFilters() {
    document.getElementById('keyword-search-input').value = '';
    document.getElementById('date-search-input').value = '';
    // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯ä½œä¸ºâ€œé‡ç½®â€ç»“æœ
    await renderSearchResults(state.chats[state.activeChatId].history.filter(msg => !msg.isHidden));
}

/* â–²â–²â–² æ ¸å¿ƒJSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² */
// â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | è‡ªå®šä¹‰å¤´åƒæ¡†ã€‘è¿™æ˜¯æ‰€æœ‰å¤´åƒæ¡†ä¸Šä¼ ã€ç®¡ç†åŠŸèƒ½çš„æ ¸å¿ƒJSä»£ç  â–¼â–¼â–¼

/**
 * ã€é‡æ„ç‰ˆã€‘æ¸²æŸ“å¤´åƒæ¡†é€‰æ‹©åˆ—è¡¨ï¼Œç°åœ¨ä¼šåŒæ—¶æ˜¾ç¤ºé¢„è®¾å’Œç”¨æˆ·è‡ªå®šä¹‰çš„å¤´åƒæ¡†
 * @param {boolean} isForMember - æ˜¯å¦æ˜¯ä¸ºç¾¤æˆå‘˜è®¾ç½®
 * @param {string|null} memberAvatar - (å¯é€‰) ç¾¤æˆå‘˜çš„å¤´åƒURL
 * @param {string|null} memberFrame - (å¯é€‰) ç¾¤æˆå‘˜å½“å‰çš„å¤´åƒæ¡†URL
 */
async function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
    const aiFrameGrid = document.getElementById('ai-frame-grid');
    const myFrameGrid = document.getElementById('my-frame-grid');
    const chat = state.chats[state.activeChatId];
    aiFrameGrid.innerHTML = '';
    myFrameGrid.innerHTML = '';

    // 1. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä»æ•°æ®åº“è·å–ç”¨æˆ·è‡ªå®šä¹‰çš„å¤´åƒæ¡†
    const customFrames = await db.customAvatarFrames.toArray();
    // å°†é¢„è®¾å’Œè‡ªå®šä¹‰çš„åˆå¹¶ä¸ºä¸€ä¸ªåˆ—è¡¨
    const allFrames = [...avatarFrames, ...customFrames];

    document.querySelector('#avatar-frame-modal .frame-tabs').style.display = isForMember ? 'none' : 'flex';
    document.getElementById('ai-frame-content').style.display = 'block';
    document.getElementById('my-frame-content').style.display = 'none';
    document.getElementById('ai-frame-tab').classList.add('active');
    document.getElementById('my-frame-tab').classList.remove('active');

    if (isForMember) {
        allFrames.forEach(frame => {
            const item = createFrameItem(frame, 'my', memberAvatar);
            if (frame.url === memberFrame) {
                item.classList.add('selected');
            }
            aiFrameGrid.appendChild(item);
        });
    } else {
        const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
        const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
        allFrames.forEach(frame => {
            const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
            if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
            aiFrameGrid.appendChild(aiItem);

            const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
            if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
            myFrameGrid.appendChild(myItem);
        });
    }
}

/**
 * ã€å‡çº§ç‰ˆã€‘åˆ›å»ºå•ä¸ªå¤´åƒæ¡†çš„é¢„è§ˆDOMï¼Œä¸ºè‡ªå®šä¹‰æ¡†æ·»åŠ åˆ é™¤æŒ‰é’®
 * @param {object} frame - å¤´åƒæ¡†å¯¹è±¡ { id, url, name }
 * @param {string} type - 'ai' æˆ– 'my'
 * @param {string} previewAvatarSrc - ç”¨äºé¢„è§ˆçš„å¤´åƒURL
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„DOMå…ƒç´ 
 */
function createFrameItem(frame, type, previewAvatarSrc) {
    const item = document.createElement('div');
    item.className = 'frame-item';
    item.dataset.frameUrl = frame.url;
    item.title = frame.name;

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ£€æŸ¥
    const isCustom = typeof frame.id === 'number';
    const deleteButtonHtml = isCustom ? `<button class="delete-btn" data-id="${frame.id}" style="display:block;">Ã—</button>` : '';

    item.innerHTML = `
        ${deleteButtonHtml}
        <img src="${previewAvatarSrc}" class="preview-avatar">
        ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
    `;
    item.addEventListener('click', (e) => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œåˆ™ä¸æ‰§è¡Œé€‰æ‹©æ“ä½œ
        if (e.target.classList.contains('delete-btn')) {
            return;
        }
        currentFrameSelection[type] = frame.url;
        const grid = type === 'ai' ? document.getElementById('ai-frame-grid') : document.getElementById('my-frame-grid');
        grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
        item.classList.add('selected');
    });
    return item;
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†æœ¬åœ°ä¸Šä¼ å•ä¸ªå¤´åƒæ¡†çš„é€»è¾‘
 */
async function handleUploadFrame() {
    const fileInput = document.getElementById('custom-frame-upload-input');
    
    // ä½¿ç”¨ Promise ä¼˜é›…åœ°å¤„ç†æ–‡ä»¶é€‰æ‹©
    const file = await new Promise(resolve => {
        const changeHandler = (e) => {
            resolve(e.target.files[0] || null);
            fileInput.removeEventListener('change', changeHandler);
        };
        fileInput.addEventListener('change', changeHandler, { once: true });
        fileInput.click();
    });

    if (!file) return; // ç”¨æˆ·å–æ¶ˆäº†é€‰æ‹©

    const name = await showCustomPrompt("å‘½åå¤´åƒæ¡†", "è¯·ä¸ºè¿™ä¸ªæ–°å¤´åƒæ¡†èµ·ä¸ªåå­—");
    if (!name || !name.trim()) return;

    // å°†å›¾ç‰‡æ–‡ä»¶è½¬æ¢ä¸º Base64
    const url = await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
    });

    // å­˜å…¥æ•°æ®åº“
    await db.customAvatarFrames.add({ name: name.trim(), url });
    // åˆ·æ–°UI
    populateFrameGrids(editingFrameForMember);
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†æ‰¹é‡å¯¼å…¥å¤´åƒæ¡†çš„é€»è¾‘
 */
async function handleBatchUploadFrames() {
    const placeholder = `è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç²˜è´´ï¼Œä¸€è¡Œä¸€ä¸ªï¼š\n\nå¤´åƒæ¡†åå­—1: https://.../image1.png\nå¤´åƒæ¡†åå­—2: https://.../image2.gif`;
    const pastedText = await showCustomPrompt("æ‰¹é‡å¯¼å…¥å¤´åƒæ¡†", "ä»å®Œæ•´é“¾æ¥æ‰¹é‡å¯¼å…¥", "", 'textarea', `<p style="font-size:12px;color:#888;">${placeholder}</p>`);

    if (!pastedText || !pastedText.trim()) return;

    const lines = pastedText.trim().split('\n');
    const newFrames = [];
    let errorCount = 0;

    for (const line of lines) {
        // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… "åå­—: URL" æ ¼å¼ï¼Œæ›´å¥å£®
        const match = line.match(/^(.+?)[:ï¼š]\s*(https?:\/\/.+)$/);
        if (match) {
            newFrames.push({
                name: match[1].trim(),
                url: match[2].trim()
            });
        } else if (line.trim()) {
            errorCount++;
        }
    }

    if (newFrames.length > 0) {
        await db.customAvatarFrames.bulkAdd(newFrames);
        populateFrameGrids(editingFrameForMember);
        await showCustomAlert("å¯¼å…¥æˆåŠŸ", `æˆåŠŸå¯¼å…¥ ${newFrames.length} ä¸ªæ–°å¤´åƒæ¡†ï¼`);
    }

    if (errorCount > 0) {
        await showCustomAlert("éƒ¨åˆ†å¤±è´¥", `æœ‰ ${errorCount} è¡Œæ ¼å¼ä¸æ­£ç¡®ï¼Œå·²è¢«å¿½ç•¥ã€‚`);
    }
}

/**
 * ã€å…¨æ–°ã€‘åˆ é™¤ä¸€ä¸ªè‡ªå®šä¹‰å¤´åƒæ¡†
 * @param {number} frameId - è¦åˆ é™¤çš„å¤´åƒæ¡†çš„ID
 */
async function handleDeleteCustomFrame(frameId) {
    const frame = await db.customAvatarFrames.get(frameId);
    if (!frame) return;

    const confirmed = await showCustomConfirm(
        "ç¡®è®¤åˆ é™¤",
        `ç¡®å®šè¦åˆ é™¤å¤´åƒæ¡† â€œ${frame.name}â€ å—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        await db.customAvatarFrames.delete(frameId);
        populateFrameGrids(editingFrameForMember); // åˆ·æ–°UI
    }
}

// â–²â–²â–² å…¨æ–°JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸»å±å¹•åˆ†é¡µå’Œâ€œé¢„è®¾â€Appçš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç ã€‘ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼

// --- 1. ä¸»å±å¹•åˆ†é¡µåŠŸèƒ½ ---
let currentPage = 0;
const totalPages = 2;

        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸€æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ setupHomeScreenPagination å‡½æ•° â–¼â–¼â–¼
        function setupHomeScreenPagination() {
            const pagesContainer = document.getElementById('home-screen-pages-container');
            const pages = document.getElementById('home-screen-pages');
            const dots = document.querySelectorAll('.pagination-dot');
            let startX = 0, startY = 0; // åŒæ—¶è®°å½•Yè½´åæ ‡
            let currentX = 0;
            let isDragging = false;
            let isClick = true; // ã€æ ¸å¿ƒã€‘å¢åŠ ä¸€ä¸ªæ ‡å¿—ä½ï¼Œç”¨äºåˆ¤æ–­æ˜¯ç‚¹å‡»è¿˜æ˜¯æ»‘åŠ¨

            const updatePagination = () => {
                pages.style.transform = `translateX(-${currentPage * (100 / totalPages)}%)`;
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentPage);
                });
            };

            const onDragStart = (e) => {
                isDragging = true;
                isClick = true; // æ¯æ¬¡å¼€å§‹è§¦æ‘¸æ—¶ï¼Œéƒ½å…ˆå‡è®¾å®ƒæ˜¯ä¸€ä¸ªç‚¹å‡»
                startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
                startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
                pages.style.transition = 'none';
            };

            const onDragMove = (e) => {
                if (!isDragging) return;
                
                const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
                currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
                const diffX = currentX - startX;
                const diffY = currentY - startY;

                // ã€æ ¸å¿ƒã€‘å¦‚æœæ‰‹æŒ‡ç§»åŠ¨è·ç¦»è¶…è¿‡10åƒç´ ï¼Œå°±åˆ¤å®šä¸ºæ»‘åŠ¨ï¼Œè€Œä¸æ˜¯ç‚¹å‡»
                if (isClick && (Math.abs(diffX) > 10 || Math.abs(diffY) > 10)) {
                    isClick = false;
                }

                // åªåœ¨æ°´å¹³æ»‘åŠ¨æ—¶ç§»åŠ¨é¡µé¢ï¼Œé¿å…å½±å“å‚ç›´æ»šåŠ¨
                if (Math.abs(diffX) > Math.abs(diffY)) {
                     if(e.cancelable) e.preventDefault();
                     pages.style.transform = `translateX(calc(-${currentPage * (100 / totalPages)}% + ${diffX}px))`;
                }
            };

            const onDragEnd = (e) => {
                if (!isDragging) return;
                isDragging = false;
                pages.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';

                // ã€æ ¸å¿ƒã€‘å¦‚æœåˆ¤å®šä¸ºç‚¹å‡»ï¼Œåˆ™ä¸æ‰§è¡Œç¿»é¡µé€»è¾‘ï¼Œç›´æ¥è¿”å›ï¼
                if (isClick) {
                    updatePagination(); // è®©é¡µé¢å¼¹å›åŸä½
                    // å› ä¸ºæ²¡æœ‰é˜»æ­¢äº‹ä»¶ï¼Œæ‰€ä»¥æµè§ˆå™¨ä¼šç»§ç»­å¤„ç†è¿™ä¸ªâ€œç‚¹å‡»â€ï¼Œè§¦å‘Appå›¾æ ‡çš„onclick
                    return; 
                }

                // å¦‚æœæ˜¯æ»‘åŠ¨ï¼Œæ‰æ‰§è¡Œä¸‹é¢çš„ç¿»é¡µåˆ¤æ–­
                const diffX = currentX - startX;
                if (Math.abs(diffX) > pagesContainer.offsetWidth / 4) {
                    if (diffX > 0 && currentPage > 0) {
                        currentPage--;
                    } else if (diffX < 0 && currentPage < totalPages - 1) {
                        currentPage++;
                    }
                }
                updatePagination();
            };

            pagesContainer.addEventListener('mousedown', onDragStart);
            pagesContainer.addEventListener('mousemove', onDragMove);
            pagesContainer.addEventListener('mouseup', onDragEnd);
            pagesContainer.addEventListener('mouseleave', onDragEnd);

            // ã€æ ¸å¿ƒã€‘ä¿®æ”¹ passive ä¸º falseï¼Œä»¥å…è®¸ e.preventDefault() ç”Ÿæ•ˆ
            pagesContainer.addEventListener('touchstart', onDragStart, { passive: false });
            pagesContainer.addEventListener('touchmove', onDragMove, { passive: false });
            pagesContainer.addEventListener('touchend', onDragEnd);
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// --- 2. â€œé¢„è®¾â€App æ ¸å¿ƒåŠŸèƒ½ ---
let editingPresetId = null;

async function openPresetScreen() {
    await renderPresetScreen();
    showScreen('preset-screen');
}

/**
 * ã€å…¨æ–° | æ€§èƒ½ä¼˜åŒ–ç‰ˆã€‘æ¸²æŸ“é¢„è®¾åˆ—è¡¨ï¼Œä¸å†æ˜¾ç¤ºå†…å®¹é¢„è§ˆ
 */
async function renderPresetScreen() {
    const tabsContainer = document.getElementById('preset-tabs');
    const contentContainer = document.getElementById('preset-content-container');
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    const [presets, categories] = await Promise.all([
        db.presets.toArray(),
        db.presetCategories.orderBy('name').toArray()
    ]);

    state.presets = presets; // ç¡®ä¿å†…å­˜æ•°æ®åŒæ­¥

    if (presets.length === 0) {
        contentContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªé¢„è®¾</p>';
        return;
    }

    // (åˆ›å»ºé¡µç­¾çš„é€»è¾‘ä¿æŒä¸å˜)
    const allTab = document.createElement('button');
    allTab.className = 'world-book-tab active';
    allTab.textContent = 'å…¨éƒ¨';
    allTab.dataset.categoryId = 'all';
    tabsContainer.appendChild(allTab);

    const allPane = document.createElement('div');
    allPane.className = 'world-book-category-pane active';
    allPane.dataset.categoryId = 'all';
    contentContainer.appendChild(allPane);
    
    categories.forEach(category => {
        const categoryTab = document.createElement('button');
        categoryTab.className = 'world-book-tab';
        categoryTab.textContent = category.name;
        categoryTab.dataset.categoryId = String(category.id);
        tabsContainer.appendChild(categoryTab);

        const categoryPane = document.createElement('div');
        categoryPane.className = 'world-book-category-pane';
        categoryPane.dataset.categoryId = String(category.id);
        contentContainer.appendChild(categoryPane);
    });
    
    const hasUncategorized = presets.some(p => !p.categoryId);
    if (hasUncategorized) {
        const uncategorizedTab = document.createElement('button');
        uncategorizedTab.className = 'world-book-tab';
        uncategorizedTab.textContent = 'æœªåˆ†ç±»';
        uncategorizedTab.dataset.categoryId = 'uncategorized';
        tabsContainer.appendChild(uncategorizedTab);
    
        const uncategorizedPane = document.createElement('div');
        uncategorizedPane.className = 'world-book-category-pane';
        uncategorizedPane.dataset.categoryId = 'uncategorized';
        contentContainer.appendChild(uncategorizedPane);
    }
    
    // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
    presets.forEach(preset => {
        // æˆ‘ä»¬ä¸å†è¯»å–ä»»ä½•å…·ä½“å†…å®¹ï¼Œåªæ˜¾ç¤ºè¿™ä¸ªé¢„è®¾åŒ…å«äº†å¤šå°‘ä¸ªæ¡ç›®
        const contentPreview = `è¯¥é¢„è®¾åŒ…å« ${preset.content.length} ä¸ªæ¡ç›®ã€‚`;
        
        const card = document.createElement('div');
        card.className = 'world-book-card'; // å¤ç”¨ä¸–ç•Œä¹¦çš„å¡ç‰‡æ ·å¼
        card.innerHTML = `
            <div class="card-title">${preset.name}</div>
            <div class="card-content-preview">${contentPreview}</div>
        `;
        
        // (äº‹ä»¶ç»‘å®šé€»è¾‘ä¿æŒä¸å˜)
        const cardClickHandler = () => openPresetEditor(preset.id);
        const cardLongPressHandler = async () => { 
            const confirmed = await showCustomConfirm('åˆ é™¤é¢„è®¾', `ç¡®å®šè¦åˆ é™¤ã€Š${preset.name}ã€‹å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); 
            if (confirmed) { 
                await db.presets.delete(preset.id);
                state.presets = await db.presets.toArray();
                renderPresetScreen(); 
            } 
        };

        card.addEventListener('click', cardClickHandler);
        addLongPressListener(card, cardLongPressHandler);

        const clonedCardForAll = card.cloneNode(true);
        clonedCardForAll.addEventListener('click', cardClickHandler);
        addLongPressListener(clonedCardForAll, cardLongPressHandler);
        allPane.appendChild(clonedCardForAll);
        
        const categoryKey = preset.categoryId ? String(preset.categoryId) : 'uncategorized';
        const targetPane = contentContainer.querySelector(`.world-book-category-pane[data-category-id="${categoryKey}"]`);
        if (targetPane) {
            targetPane.appendChild(card);
        }
    });
    // â–²â–²â–² ã€ã€ã€ä¿®æ”¹ç»“æŸã€‘ã€‘ã€‘ â–²â–²â–²
    
    // (é¡µç­¾ç»‘å®šé€»è¾‘ä¿æŒä¸å˜)
    document.querySelectorAll('#preset-tabs .world-book-tab').forEach(tab => {
        tab.addEventListener('click', () => switchPresetCategory(tab.dataset.categoryId));
    });
}


function switchPresetCategory(categoryId) {
    document.querySelectorAll('#preset-tabs .world-book-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
    });
    document.querySelectorAll('#preset-content-container .world-book-category-pane').forEach(pane => {
        pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
    });
}

/**
 * ã€æœ€ç»ˆä¿®å¤ç‰ˆ | å…¼å®¹iOS/Safariã€‘æ‰“å¼€é¢„è®¾ç¼–è¾‘å™¨
 * @param {string} presetId - è¦ç¼–è¾‘çš„é¢„è®¾çš„ID
 */
async function openPresetEditor(presetId) {
    // æ­¥éª¤ 1: ç«‹å³å¼€å§‹åˆ‡æ¢å±å¹•ï¼Œè®©åŠ¨ç”»å…ˆè¿è¡Œ
    showScreen('preset-editor-screen');
    editingPresetId = presetId;

    try {
        // æ­¥éª¤ 2: åœ¨åå°å¼‚æ­¥è·å–æ‰€æœ‰éœ€è¦çš„æ•°æ®
        const [preset, categories] = await Promise.all([
            db.presets.get(presetId),
            db.presetCategories.toArray()
        ]);

        // æ­¥éª¤ 3: æ£€æŸ¥è·å–åˆ°çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆ
        if (!preset) {
            console.error("é”™è¯¯ï¼šå°è¯•æ‰“å¼€ä¸€ä¸ªä¸å­˜åœ¨çš„é¢„è®¾ï¼ŒID:", presetId);
            await showCustomAlert("åŠ è½½å¤±è´¥", "æ‰¾ä¸åˆ°è¿™ä¸ªé¢„è®¾çš„è¯¦ç»†ä¿¡æ¯ã€‚");
            showScreen('preset-screen'); // å®‰å…¨åœ°è¿”å›åˆ—è¡¨é¡µ
            return;
        }

        // æ­¥éª¤ 4: ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨ä¸€ä¸ªå¾®å°çš„å»¶è¿Ÿ (setTimeout) 
        // è¿™ä¼šç»™æ‰‹æœºæµè§ˆå™¨è¶³å¤Ÿçš„æ—¶é—´æ¥å®Œæˆå±å¹•åˆ‡æ¢çš„åŠ¨ç”»ï¼Œé¿å…å†²çª
        setTimeout(() => {
            // æ­¥éª¤ 5: ç°åœ¨å¯ä»¥å®‰å…¨åœ°æ›´æ–°é¡µé¢ä¸Šçš„æ‰€æœ‰å†…å®¹äº†
            document.getElementById('preset-editor-title').textContent = preset.name;
            document.getElementById('preset-name-input').value = preset.name;

            const selectEl = document.getElementById('preset-category-select');
            selectEl.innerHTML = '<option value="">-- æœªåˆ†ç±» --</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                if (preset.categoryId === cat.id) option.selected = true;
                selectEl.appendChild(option);
            });

            const entriesContainer = document.getElementById('preset-entries-container');
            entriesContainer.innerHTML = '';
            if (Array.isArray(preset.content) && preset.content.length > 0) {
                preset.content.forEach(entry => {
                    const block = createPresetEntryBlock(entry);
                    entriesContainer.appendChild(block);
                });
            } else {
                entriesContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 20px;">è¿˜æ²¡æœ‰å†…å®¹ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡å§ï¼</p>';
            }
        }, 50); // å»¶è¿Ÿ50æ¯«ç§’ï¼Œå¯¹äºç§»åŠ¨ç«¯å·²ç»è¶³å¤Ÿ

    } catch (error) {
        console.error("æ‰“å¼€é¢„è®¾ç¼–è¾‘å™¨æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯:", error);
        await showCustomAlert("åŠ è½½å¤±è´¥", `åŠ è½½é¢„è®¾è¯¦æƒ…æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
        showScreen('preset-screen'); // å‡ºé”™æ—¶ä¹Ÿå®‰å…¨è¿”å›
    }
}

/**
 * ã€å…¨æ–° | æ”¯æŒå†…å®¹æŠ˜å ã€‘åˆ›å»ºå•ä¸ªé¢„è®¾æ¡ç›®çš„ç¼–è¾‘å—
 */
function createPresetEntryBlock(entry = { keys: [], comment: '', content: '', enabled: true }) {
    const block = document.createElement('div');
    block.className = 'message-editor-block';
    const isChecked = entry.enabled !== false ? 'checked' : '';

    // â–¼â–¼â–¼ ã€ã€ã€æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œï¼ã€‘ã€‘ã€‘ â–¼â–¼â–¼
    block.innerHTML = `
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 5px;">
            <label class="toggle-switch" title="å¯ç”¨/ç¦ç”¨æ­¤æ¡ç›®">
                <input type="checkbox" class="entry-enabled-switch" ${isChecked}>
                <span class="slider"></span>
            </label>
            <button type="button" class="delete-block-btn" title="åˆ é™¤æ­¤æ¡ç›®">Ã—</button>
        </div>
        <div class="form-group" style="margin-bottom: 10px;">
            <label style="font-size: 0.8em;">å¤‡æ³¨ (å¯é€‰)</label>
            <input type="text" class="entry-comment-input" value="${entry.comment || ''}" placeholder="ä¾‹å¦‚ï¼šè§’è‰²æ ¸å¿ƒè®¾å®š" style="padding: 8px;">
        </div>
        <div class="form-group" style="margin-bottom: 10px;">
            <label style="font-size: 0.8em;">å…³é”®è¯ (ç”¨è‹±æ–‡é€—å·,åˆ†éš”)</label>
            <input type="text" class="entry-keys-input" value="${(entry.keys || []).join(', ')}" placeholder="ä¾‹å¦‚: key1, key2" style="padding: 8px;">
        </div>
        
        <!-- è¿™é‡Œæ˜¯å…¨æ–°çš„ã€å¸¦æœ‰â€œå±•å¼€/æ”¶èµ·â€æŒ‰é’®çš„ç»“æ„ -->
        <div class="form-group" style="margin-bottom: 0;">
            <label style="font-size: 0.8em; display: flex; justify-content: space-between; align-items: center;">
                <span>å†…å®¹ (ç‚¹å‡»å³ä¾§å±•å¼€)</span>
                <button type="button" class="toggle-content-btn">å±•å¼€</button>
            </label>
            <div class="entry-content-container">
                 <textarea class="entry-content-textarea" rows="8" style="width: 100%; font-size: 14px;">${entry.content || ''}</textarea>
            </div>
        </div>
    `;
    // â–²â–²â–² ã€ã€ã€ä¿®æ”¹ç»“æŸã€‘ã€‘ã€‘ â–²â–²â–²

    // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
    block.querySelector('.delete-block-btn').addEventListener('click', () => block.remove());
    
    // ã€å…¨æ–°ã€‘ä¸ºâ€œå±•å¼€/æ”¶èµ·â€æŒ‰é’®ç»‘å®šäº‹ä»¶
    const toggleBtn = block.querySelector('.toggle-content-btn');
    const contentContainer = block.querySelector('.entry-content-container');
    toggleBtn.addEventListener('click', () => {
        const isHidden = contentContainer.style.display === 'none';
        contentContainer.style.display = isHidden ? 'block' : 'none';
        toggleBtn.textContent = isHidden ? 'æ”¶èµ·' : 'å±•å¼€';
    });

    return block;
}

// --- 3. â€œé¢„è®¾â€åˆ†ç±»ç®¡ç† (å¤ç”¨ä¸–ç•Œä¹¦çš„å‡½æ•°ï¼Œä¿®æ”¹å‡½æ•°å) ---
async function openPresetCategoryManager() {
    await renderPresetCategoriesInManager();
    // å¤ç”¨ç°æœ‰çš„å¼¹çª—ï¼Œåªä¿®æ”¹å†…å®¹
    document.querySelector('#group-management-modal .modal-header span').textContent = 'ç®¡ç†é¢„è®¾åˆ†ç±»';
    document.getElementById('add-new-group-btn').onclick = addNewPresetCategory;
    document.getElementById('existing-groups-list').onclick = (e) => {
        if (e.target.classList.contains('delete-group-btn')) {
            deletePresetCategory(parseInt(e.target.dataset.id));
        }
    };
    document.getElementById('close-group-manager-btn').onclick = () => {
        document.getElementById('group-management-modal').classList.remove('visible');
        renderPresetScreen(); // å…³é—­ååˆ·æ–°ä¸»åˆ—è¡¨
    };
    document.getElementById('group-management-modal').classList.add('visible');
}

async function renderPresetCategoriesInManager() {
    const listEl = document.getElementById('existing-groups-list');
    const categories = await db.presetCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>';
    }
    categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `<span class="group-name">${cat.name}</span><span class="delete-group-btn" data-id="${cat.id}">Ã—</span>`;
        listEl.appendChild(item);
    });
}

async function addNewPresetCategory() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) return alert('åˆ†ç±»åä¸èƒ½ä¸ºç©ºï¼');
    const existing = await db.presetCategories.where('name').equals(name).first();
    if (existing) return alert(`åˆ†ç±» "${name}" å·²ç»å­˜åœ¨äº†ï¼`);
    await db.presetCategories.add({ name });
    input.value = '';
    await renderPresetCategoriesInManager();
}

async function deletePresetCategory(categoryId) {
    const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', 'åˆ é™¤åˆ†ç±»åï¼Œè¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¢„è®¾å°†å˜ä¸ºâ€œæœªåˆ†ç±»â€ã€‚ç¡®å®šå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.presetCategories.delete(categoryId);
        await db.presets.where('categoryId').equals(categoryId).modify({ categoryId: null });
        
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œä¹ŸåŒæ ·ä»æ•°æ®åº“é‡æ–°åŠ è½½æœ€æ–°çš„é¢„è®¾åˆ—è¡¨ â–¼â–¼â–¼
        state.presets = await db.presets.toArray();
        // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

        await renderPresetCategoriesInManager();
    }
}
// â–²â–²â–² å…¨æ–°JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯å¯¼å…¥ Tavern é¢„è®¾åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç ã€‘ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·é€‰æ‹©äº†é¢„è®¾æ–‡ä»¶åï¼Œç”±æ­¤å‡½æ•°å¼€å§‹å¤„ç†
 * @param {Event} event - æ–‡ä»¶è¾“å…¥æ¡†çš„ change äº‹ä»¶
 */
async function handlePresetImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        if (!file.name.endsWith('.json')) {
            throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒã€‚è¯·é€‰æ‹© .json æ ¼å¼çš„ Tavern é¢„è®¾æ–‡ä»¶ã€‚");
        }
        
        const text = await file.text();
        const tavernData = JSON.parse(text);
        
        // è°ƒç”¨æ ¸å¿ƒå¤„ç†å‡½æ•°
        await importTavernPresetFile(tavernData, file.name);

    } catch (error) {
        console.error("é¢„è®¾å¯¼å…¥å¤±è´¥:", error);
        await showCustomAlert("å¯¼å…¥å¤±è´¥", `æ— æ³•è§£æé¢„è®¾æ–‡ä»¶ã€‚\né”™è¯¯: ${error.message}`);
    } finally {
        // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
        event.target.value = null;
    }
}

        /**
         * ã€V3.0 | æ’åºç»ˆæä¿®å¤ç‰ˆã€‘ä» Tavern AI æ ¼å¼çš„æ•°æ®åˆ›å»ºä¸€æœ¬æ–°çš„â€œé¢„è®¾â€
         * @param {object} tavernData - ä» .json æ–‡ä»¶è§£æå‡ºçš„æ•°æ®
         * @param {string} fileName - åŸå§‹æ–‡ä»¶åï¼Œç”¨äºç”Ÿæˆé»˜è®¤åç§°
         */
        async function importTavernPresetFile(tavernData, fileName) {
            let newEntries = [];

            // â–¼â–¼â–¼ ä¿®å¤ä»£ç ä»è¿™é‡Œå¼€å§‹ â–¼â–¼â–¼

            // ç­–ç•¥1ï¼šä¼˜å…ˆå¤„ç†æ ‡å‡†çš„ã€å¸¦æœ‰ `prompt_order` æ’åºåˆ—è¡¨çš„ Tavern/SillyTavern é¢„è®¾æ ¼å¼
            if (Array.isArray(tavernData.prompts) && Array.isArray(tavernData.prompt_order) && tavernData.prompt_order.length > 0) {
                console.log("æ£€æµ‹åˆ° Tavern/SillyTavern é¢„è®¾æ ¼å¼ï¼Œå°†ä¸¥æ ¼æŒ‰ç…§ prompt_order æ’åºã€‚");

                // åˆ›å»ºä¸€ä¸ªæŸ¥æ‰¾æ˜ å°„è¡¨ï¼Œä»¥ä¾¿é€šè¿‡ identifier å¿«é€Ÿæ‰¾åˆ° prompt çš„è¯¦ç»†æ•°æ®
                const promptsMap = new Map(tavernData.prompts.map(p => [p.identifier, p]));

                // è‡ªåŠ¨é€‰æ‹©æœ€é•¿çš„é‚£ä¸ªæ’åºåˆ—è¡¨ï¼Œè¿™é€šå¸¸æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„é‚£ä¸ª
                const orderArray = tavernData.prompt_order.reduce((acc, curr) => (
                    (curr.order && curr.order.length > (acc.length || 0)) ? curr.order : acc
                ), []);

                if (orderArray && orderArray.length > 0) {
                    newEntries = orderArray
                        .map(orderItem => {
                            // æ ¹æ®æ’åºåˆ—è¡¨ä¸­çš„ identifierï¼Œä»æ˜ å°„è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„ prompt æ•°æ®
                            const promptData = promptsMap.get(orderItem.identifier);
                            if (promptData) {
                                // æŒ‰ç…§æˆ‘ä»¬çš„æ ¼å¼é‡æ–°ç»„ç»‡æ•°æ®
                                return {
                                    keys: [], // Tavern é¢„è®¾ä¸­æ²¡æœ‰ keys å­—æ®µ
                                    comment: promptData.name || 'æ— æ ‡é¢˜',
                                    content: promptData.content || '',
                                    // ã€æ ¸å¿ƒã€‘åŒæ­¥å¯ç”¨/ç¦ç”¨çŠ¶æ€
                                    enabled: orderItem.enabled 
                                };
                            }
                            return null;
                        })
                        .filter(Boolean); // è¿‡æ»¤æ‰å¯èƒ½å­˜åœ¨çš„æ— æ•ˆæ¡ç›®
                }
            }
            // ç­–ç•¥2ï¼šå…¼å®¹æ—§çš„ã€ç±»ä¼¼ä¸–ç•Œä¹¦çš„ "entries" å’Œ "order" æ ¼å¼
            else if (tavernData.entries && typeof tavernData.entries === 'object') {
                console.log("æ£€æµ‹åˆ° 'entries' å¯¹è±¡æ ¼å¼çš„é¢„è®¾ï¼Œå°†å°è¯•æŒ‰é¡ºåºå¯¼å…¥ã€‚");
                if (Array.isArray(tavernData.order)) {
                    console.log("æ£€æµ‹åˆ° 'order' å­—æ®µï¼Œå°†æŒ‰æŒ‡å®šé¡ºåºå¯¼å…¥æ¡ç›®ã€‚");
                    newEntries = tavernData.order
                        .map(key => tavernData.entries[key])
                        .filter(Boolean)
                        .map(entry => ({
                            keys: entry.key || [],
                            comment: entry.comment || 'æ— å¤‡æ³¨',
                            content: entry.content || '',
                            enabled: !entry.disable // Tavern çš„ disable å’Œæˆ‘ä»¬çš„ enabled é€»è¾‘ç›¸å
                        }));
                } else {
                    console.warn("æœªåœ¨æ–‡ä»¶ä¸­æ‰¾åˆ° 'order' å­—æ®µï¼Œæ¡ç›®å¯èƒ½æ— æ³•æŒ‰åŸå§‹é¡ºåºå¯¼å…¥ã€‚");
                    newEntries = Object.values(tavernData.entries).map(entry => ({
                        keys: entry.key || [],
                        comment: entry.comment || 'æ— å¤‡æ³¨',
                        content: entry.content || '',
                        enabled: !entry.disable
                    }));
                }
            }
            // ç­–ç•¥3ï¼šå…¼å®¹æœ€ç®€å•çš„ã€åªåŒ…å« "prompts" æ•°ç»„çš„æ ¼å¼
            else if (Array.isArray(tavernData.prompts)) {
                console.log("æ£€æµ‹åˆ°ç®€å•çš„ 'prompts' æ•°ç»„æ ¼å¼ï¼Œå°†æŒ‰æ•°ç»„å†…é¡ºåºå¯¼å…¥ã€‚");
                newEntries = tavernData.prompts.map(prompt => ({
                    keys: [],
                    comment: prompt.name || 'æ— æ ‡é¢˜',
                    content: prompt.content || '',
                    enabled: true // é»˜è®¤å¯ç”¨
                }));
            }
            // ç­–ç•¥4ï¼šå¦‚æœæ‰€æœ‰æ ¼å¼éƒ½ä¸åŒ¹é…ï¼Œåˆ™æŠ¥é”™
            else {
                throw new Error("æ–‡ä»¶æ ¼å¼æ— æ³•è¯†åˆ«ã€‚æœªæ‰¾åˆ°æœ‰æ•ˆçš„ 'prompts' æ•°ç»„æˆ– 'entries' å¯¹è±¡ã€‚");
            }
            // â–²â–²â–² ä¿®å¤ä»£ç åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

            // è¿‡æ»¤æ‰æ²¡æœ‰å†…å®¹çš„ç©ºæ¡ç›®
            newEntries = newEntries.filter(entry => entry.content);

            if (newEntries.length === 0) {
                alert("è¿™ä¸ªé¢„è®¾æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„æç¤ºè¯æ¡ç›®ã€‚");
                return;
            }

            // ï¼ˆåç»­çš„å‘½åã€ä¿å­˜å’Œåˆ·æ–°é€»è¾‘ä¿æŒä¸å˜ï¼‰
            const presetNameSuggestion = fileName.replace(/\.json$/i, '');
            const newPresetName = await showCustomPrompt("å¯¼å…¥ Tavern é¢„è®¾", "è¯·ä¸ºè¿™ç»„æç¤ºè¯é¢„è®¾å‘½åï¼š", presetNameSuggestion);
            if (!newPresetName || !newPresetName.trim()) {
                alert("å¯¼å…¥å·²å–æ¶ˆï¼Œå› ä¸ºæœªæä¾›åç§°ã€‚");
                return;
            }

            const newPreset = {
                id: 'preset_' + Date.now(),
                name: newPresetName.trim(),
                content: newEntries,
                categoryId: null
            };

            await db.presets.add(newPreset);
            state.presets.push(newPreset);

            await renderPresetScreen();
            await showCustomAlert('å¯¼å…¥æˆåŠŸï¼', `å·²æˆåŠŸä»æ–‡ä»¶å¯¼å…¥é¢„è®¾ã€Š${newPresetName}ã€‹ã€‚`);
        }

// â–²â–²â–² å…¨æ–°JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·å°†è¿™ä¸ªå‡½æ•°ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘åœ¨èŠå¤©è®¾ç½®ä¸­æ¸²æŸ“çº¿ä¸‹æ¨¡å¼çš„æ–‡é£é¢„è®¾é€‰æ‹©å™¨
 * @param {object} chat - å½“å‰çš„èŠå¤©å¯¹è±¡
 */
async function renderOfflinePresetSelector(chat) {
    const selectEl = document.getElementById('offline-preset-select');
    if (!selectEl) return;

    // 1. ç›´æ¥ä» state ç¼“å­˜ä¸­è·å–é¢„è®¾ï¼Œæ— éœ€å†æŸ¥æ•°æ®åº“
    const presets = state.presets || [];
    
    // 2. æ¸…ç©ºå¹¶å¡«å……ä¸‹æ‹‰åˆ—è¡¨
    selectEl.innerHTML = '<option value="">-- ä¸ä½¿ç”¨é¢„è®¾ --</option>';
    presets.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = preset.name;
        selectEl.appendChild(option);
    });

    // 3. è®¾ç½®å½“å‰é€‰ä¸­çš„å€¼
    if (chat.settings.offlinePresetId) {
        selectEl.value = chat.settings.offlinePresetId;
    }
}
// â–²â–²â–² æ–°å¢å‡½æ•°ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ª V2.0 ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderButtonOrderEditor å‡½æ•° â–¼â–¼â–¼
/**
 * æ¸²æŸ“æŒ‰é’®æ’åºçš„è®¾ç½®ç•Œé¢ (V2.0 - ä½¿ç”¨å¸¸é‡ä½œä¸ºé»˜è®¤å€¼)
 */
function renderButtonOrderEditor() {
    const editor = document.getElementById('button-order-editor');
    if (!editor) return;

    editor.innerHTML = '';

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
    // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ä¿å­˜çš„é¡ºåºï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä½¿ç”¨æˆ‘ä»¬å®šä¹‰çš„é»˜è®¤é¡ºåºå¸¸é‡
    let buttonOrder = state.globalSettings.chatActionButtonsOrder || DEFAULT_BUTTON_ORDER;
    
    buttonOrder.forEach(buttonId => {
        const originalButton = document.getElementById(buttonId);
        if (originalButton) {
            const item = document.createElement('div');
            item.className = 'draggable-button-item';
            item.draggable = true;
            item.dataset.buttonId = buttonId;
            item.innerHTML = originalButton.innerHTML; 
            editor.appendChild(item);
        }
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆ | å…¼å®¹ç§»åŠ¨ç«¯è§¦æ‘¸ã€‘è¯·ç”¨è¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ initializeButtonOrderEditor å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V2.0 | ç§»åŠ¨ç«¯å…¼å®¹ç‰ˆã€‘åˆå§‹åŒ–æŒ‰é’®æ’åºç¼–è¾‘å™¨çš„æ‹–æ”¾äº‹ä»¶
 */
function initializeButtonOrderEditor() {
    const editor = document.getElementById('button-order-editor');
    if (!editor) return;

    let draggingItem = null; // ç”¨äºå­˜å‚¨å½“å‰æ­£åœ¨è¢«æ‹–åŠ¨çš„å…ƒç´ 

    // ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†å‡½æ•°
    const handleDragStart = (e) => {
        const target = e.target.closest('.draggable-button-item');
        if (!target) return;
        
        draggingItem = target;
        draggingItem.classList.add('dragging');

        // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œç‰¹åˆ«æ˜¯åœ¨è§¦æ‘¸è®¾å¤‡ä¸Šé˜²æ­¢é¡µé¢æ»šåŠ¨
        if (e.cancelable) e.preventDefault();
    };

    const handleDragMove = (e) => {
        if (!draggingItem) return;

        // ç»Ÿä¸€è·å–åæ ‡
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        
        const afterElement = getDragAfterElement(editor, clientX);
        
        if (afterElement == null) {
            editor.appendChild(draggingItem);
        } else {
            editor.insertBefore(draggingItem, afterElement);
        }
    };

    const handleDragEnd = () => {
        if (!draggingItem) return;

        draggingItem.classList.remove('dragging');
        draggingItem = null;
        
        // æ‹–åŠ¨ç»“æŸåï¼Œä¿å­˜æ–°çš„é¡ºåº
        saveButtonOrder();
    };

    // --- ç»‘å®šäº‹ä»¶ ---
    // ä½¿ç”¨ mousedown å’Œ touchstart æ¥å¼€å§‹æ‹–åŠ¨
    editor.addEventListener('mousedown', handleDragStart);
    editor.addEventListener('touchstart', handleDragStart, { passive: false });

    // ä½¿ç”¨ mousemove å’Œ touchmove æ¥å¤„ç†æ‹–åŠ¨è¿‡ç¨‹
    editor.addEventListener('mousemove', handleDragMove);
    editor.addEventListener('touchmove', handleDragMove, { passive: false });

    // ä½¿ç”¨ mouseup, mouseleave å’Œ touchend æ¥ç»“æŸæ‹–åŠ¨
    editor.addEventListener('mouseup', handleDragEnd);
    editor.addEventListener('mouseleave', handleDragEnd); // é˜²æ­¢é¼ æ ‡ç§»å‡ºåŒºåŸŸæ—¶å¡ä½
    editor.addEventListener('touchend', handleDragEnd);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ getDragAfterElement â–¼â–¼â–¼
/**
 * ã€V2.0 | æ°´å¹³ä¿®å¤ç‰ˆã€‘è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—æ‹–åŠ¨å…ƒç´ åº”è¯¥æ’å…¥åˆ°å“ªä¸ªå…ƒç´ å‰é¢
 * @param {HTMLElement} container - æ‹–æ”¾åŒºåŸŸçš„å®¹å™¨
 * @param {number} x - é¼ æ ‡å½“å‰çš„æ°´å¹³ (X) åæ ‡
 * @returns {HTMLElement|null} - åº”è¯¥è¢«æ’å…¥åˆ°å…¶å‰é¢çš„é‚£ä¸ªå…ƒç´ 
 */
function getDragAfterElement(container, x) {
    // 1. è·å–å®¹å™¨å†…æ‰€æœ‰å¯æ‹–æ‹½çš„ã€ä½†ä¸æ˜¯æ­£åœ¨è¢«æ‹–æ‹½çš„å…ƒç´ 
    const draggableElements = [...container.querySelectorAll('.draggable-button-item:not(.dragging)')];

    // 2. ä½¿ç”¨ reduce æ–¹æ³•æ¥æ‰¾åˆ°æœ€æ¥è¿‘çš„é‚£ä¸ªå…ƒç´ 
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        // 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘è®¡ç®—é¼ æ ‡ X åæ ‡åˆ°å…ƒç´ ä¸­å¿ƒçš„æ°´å¹³è·ç¦»
        const offset = x - box.left - box.width / 2;
        
        // 4. æˆ‘ä»¬è¦æ‰¾çš„æ˜¯ï¼šé¼ æ ‡åœ¨å®ƒå·¦è¾¹ (offset < 0)ï¼Œå¹¶ä¸”æ˜¯æ‰€æœ‰æ»¡è¶³æ¡ä»¶é‡Œæœ€æ¥è¿‘çš„é‚£ä¸ª (offset > closest.offset)
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰çš„æŒ‰é’®é¡ºåºåˆ°æ•°æ®åº“
 */
async function saveButtonOrder() {
    const editor = document.getElementById('button-order-editor');
    const newOrder = Array.from(editor.querySelectorAll('.draggable-button-item')).map(item => item.dataset.buttonId);
    
    state.globalSettings.chatActionButtonsOrder = newOrder;
    await db.globalSettings.put(state.globalSettings);

    // (å¯é€‰) ç»™ç”¨æˆ·ä¸€ä¸ªä¿å­˜æˆåŠŸçš„æç¤º
    // console.log("æŒ‰é’®é¡ºåºå·²ä¿å­˜:", newOrder);
}

/**
 * ã€æ ¸å¿ƒã€‘æ ¹æ®å·²ä¿å­˜çš„é¡ºåºï¼Œé‡æ–°æ’åˆ—èŠå¤©ç•Œé¢åº•éƒ¨çš„æŒ‰é’®
 */
function applyButtonOrder() {
    const buttonOrder = state.globalSettings.chatActionButtonsOrder;
    if (!buttonOrder || !Array.isArray(buttonOrder) || buttonOrder.length === 0) {
        return; // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é¡ºåºï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
    }

    const container = document.getElementById('chat-input-actions-top');
    if (!container) return;

    // æŒ‰ç…§ä¿å­˜çš„é¡ºåºï¼Œä¾æ¬¡å°†æŒ‰é’®é‡æ–°è¿½åŠ åˆ°å®¹å™¨æœ«å°¾
    buttonOrder.forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) {
            container.appendChild(button);
        }
    });
}

// â–²â–²â–² å…¨æ–°JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å®šä¹‰é»˜è®¤çš„æŒ‰é’®é¡ºåºå¸¸é‡ â–¼â–¼â–¼
const DEFAULT_BUTTON_ORDER = [
    'open-sticker-panel-btn', 'send-photo-btn', 'upload-image-btn', 
    'transfer-btn', 'voice-message-btn', 'send-waimai-request-btn', 
    'video-call-btn', 'group-video-call-btn', 'send-poll-btn', 
    'share-link-btn', 'share-location-btn', 'gomoku-btn', 
    'open-shopping-btn', 'pat-btn', 'edit-last-response-btn', 
    'regenerate-btn', 'propel-btn', 'show-announcement-board-btn'
];
// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é‡ç½®æŒ‰é’®é¡ºåºçš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•° â–¼â–¼â–¼
async function resetButtonOrder() {
    // 1. åœ¨ç”¨æˆ·çš„å…¨å±€è®¾ç½®ä¸­ï¼Œå°†è‡ªå®šä¹‰é¡ºåºæ¸…é™¤ (è®¾ä¸º null)
    state.globalSettings.chatActionButtonsOrder = null;
    await db.globalSettings.put(state.globalSettings);

    // 2. é‡æ–°æ¸²æŸ“æ’åºç¼–è¾‘å™¨ï¼Œå®ƒä¼šè‡ªåŠ¨æ¢å¤åˆ°é»˜è®¤é¡ºåº
    renderButtonOrderEditor();

    // 3. åº”ç”¨é»˜è®¤é¡ºåºåˆ°çœŸå®çš„èŠå¤©ç•Œé¢
    applyButtonOrder();

    // 4. ç»™ç”¨æˆ·ä¸€ä¸ªæˆåŠŸçš„æç¤º
    await showCustomAlert("æˆåŠŸ", "æŒ‰é’®é¡ºåºå·²æ¢å¤ä¸ºé»˜è®¤è®¾ç½®ï¼");
}
// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€å…¨æ–° V2.0 | å·²ä¿®å¤ã€‘è¿™æ˜¯é«˜çº§æ•°æ®æ¸…ç†åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç ã€‘ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼

let selectedCharsForClear = []; // ç”¨äºå­˜å‚¨ç¬¬ä¸€æ­¥é€‰æ‹©çš„è§’è‰²ID
let selectedTypesForClear = []; // ç”¨äºå­˜å‚¨ç¬¬äºŒæ­¥é€‰æ‹©çš„æ•°æ®ç±»å‹

/**
 * ã€æ€»å…¥å£ã€‘æ‰“å¼€é«˜çº§æ•°æ®æ¸…ç†å‘å¯¼
 */
function openDataClearWizard() {
    const modal = document.getElementById('data-clear-wizard-modal');
    selectedCharsForClear = [];
    selectedTypesForClear = [];
    
    // æ¸²æŸ“ç¬¬ä¸€æ­¥
    renderClearWizardStep1();
    
    // æ˜¾ç¤ºç¬¬ä¸€æ­¥ï¼Œéšè—ç¬¬äºŒæ­¥
    document.getElementById('data-clear-step-1').style.display = 'flex';
    document.getElementById('data-clear-step-2').style.display = 'none';
    
    modal.classList.add('visible');
}

/**
 * æ¸²æŸ“å‘å¯¼çš„ç¬¬ä¸€æ­¥ï¼šè§’è‰²é€‰æ‹©åˆ—è¡¨
 */
function renderClearWizardStep1() {
    const listEl = document.getElementById('data-clear-char-list');
    listEl.innerHTML = '';

    // 1. æ·»åŠ â€œæˆ‘è‡ªå·±â€çš„é€‰é¡¹
    const userItem = document.createElement('div');
    userItem.className = 'clear-posts-item';
    userItem.dataset.charId = 'user';
    userItem.innerHTML = `
        <div class="checkbox"></div>
        <span class="name">${state.qzoneSettings.nickname || 'æˆ‘'} (ç”¨æˆ·)</span>
    `;
    listEl.appendChild(userItem);

    // 2. æ·»åŠ æ‰€æœ‰AIè§’è‰²çš„é€‰é¡¹
    Object.values(state.chats).forEach(chat => {
        if (!chat.isGroup) {
            const charItem = document.createElement('div');
            charItem.className = 'clear-posts-item';
            charItem.dataset.charId = chat.id;
            charItem.innerHTML = `
                <div class="checkbox"></div>
                <span class="name">${chat.name} (è§’è‰²)</span>
            `;
            listEl.appendChild(charItem);
        }
    });
}

/**
 * ã€V2.0 | å·²ä¿®æ­£æ•°æ®åˆ†ç±»ã€‘æ¸²æŸ“å‘å¯¼çš„ç¬¬äºŒæ­¥ï¼šæ•°æ®ç±»å‹é€‰æ‹©åˆ—è¡¨
 */
function renderClearWizardStep2() {
    const listEl = document.getElementById('data-clear-type-list');
    listEl.innerHTML = '';
    
    const dataTypes = [
        { id: 'chat', name: 'èŠå¤©è®°å½•', description: 'å°†æ¸…ç©ºé€‰å®šè§’è‰²çš„æ‰€æœ‰å¯¹è¯æ¶ˆæ¯ã€‚' },
        { id: 'qzone', name: 'åŠ¨æ€ä¸äº’åŠ¨', description: 'å°†æ¸…ç©ºé€‰å®šè§’è‰²çš„æ‰€æœ‰åŠ¨æ€ã€è¯„è®ºå’Œç‚¹èµã€‚' },
        { id: 'calls', name: 'é€šè¯è®°å½•', description: 'å°†æ¸…ç©ºé€‰å®šè§’è‰²çš„æ‰€æœ‰é€šè¯è®°å½•ã€‚' },
        // ã€ã€ã€æ ¸å¿ƒä¿®æ­£1ï¼šæ•°æ®åˆ†ç±»ã€‘ã€‘ã€‘
        { id: 'thoughts', name: 'å¿ƒå£°', description: 'å°†æ¸…ç©ºé€‰å®šè§’è‰²çš„å¿ƒå£°å’Œæ•£è®°å†å²ã€‚' },
        { id: 'memories', name: 'é•¿æœŸè®°å¿†', description: 'å°†æ¸…ç©ºé€‰å®šè§’è‰²çš„æ‰€æœ‰é•¿æœŸè®°å¿†ã€‚' },
        { id: 'cphone', name: 'Cphoneæ•°æ® (CPhone)', description: 'å°†æ¸…ç©ºè§’è‰²çš„ç›¸å†Œã€QQã€æµè§ˆå™¨ã€æ·˜å®ã€æ—¥è®°ã€å¤‡å¿˜å½•ç­‰æ‰€æœ‰æ¨¡æ‹Ÿæ‰‹æœºæ•°æ®ã€‚' }
    ];

    dataTypes.forEach(type => {
        const item = document.createElement('div');
        item.className = 'clear-posts-item';
        item.dataset.typeId = type.id;
        item.innerHTML = `
            <div class="checkbox"></div>
            <div>
                <span class="name">${type.name}</span>
                <p style="font-size: 12px; color: #888; margin: 4px 0 0;">${type.description}</p>
            </div>
        `;
        listEl.appendChild(item);
    });
}


/**
 * å¤„ç†â€œä¸‹ä¸€æ­¥â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
 */
function handleDataClearNext() {
    const selectedItems = document.querySelectorAll('#data-clear-char-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ¸…ç†çš„è§’è‰²ã€‚");
        return;
    }

    selectedCharsForClear = Array.from(selectedItems).map(item => item.dataset.charId);
    
    // æ¸²æŸ“ç¬¬äºŒæ­¥å¹¶åˆ‡æ¢è§†å›¾
    renderClearWizardStep2();
    document.getElementById('data-clear-step-1').style.display = 'none';
    document.getElementById('data-clear-step-2').style.display = 'flex';
}

/**
 * å¤„ç†â€œä¸Šä¸€æ­¥â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
 */
function handleDataClearBack() {
    document.getElementById('data-clear-step-2').style.display = 'none';
    document.getElementById('data-clear-step-1').style.display = 'flex';
    // ä¿ç•™å·²é€‰ä¸­çš„è§’è‰²
    document.querySelectorAll('#data-clear-char-list .clear-posts-item').forEach(item => {
        if (selectedCharsForClear.includes(item.dataset.charId)) {
            item.classList.add('selected');
        }
    });
}

/**
 * ã€V2.0 | å·²ä¿®æ­£æ•°æ®åˆ†ç±»ã€‘å¤„ç†æœ€ç»ˆç¡®è®¤æ¸…ç†çš„é€»è¾‘
 */
async function handleConfirmDataClear() {
    const selectedItems = document.querySelectorAll('#data-clear-type-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¦æ¸…ç†çš„æ•°æ®ç±»å‹ã€‚");
        return;
    }

    selectedTypesForClear = Array.from(selectedItems).map(item => item.dataset.typeId);

    const confirmed = await showCustomConfirm(
        'æœ€åç¡®è®¤ï¼',
        'æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‚¨é€‰æ‹©çš„æ‰€æœ‰æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger', confirmText: 'ç¡®è®¤åˆ é™¤' }
    );

    if (!confirmed) return;
    
    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨æ‰§è¡Œæ¸…ç†æ“ä½œï¼Œè¯·ä¸è¦å…³é—­é¡µé¢...");

    try {
        await db.transaction('rw', db.tables, async () => {
            for (const charId of selectedCharsForClear) {
                for (const type of selectedTypesForClear) {
                    
                    if (type === 'chat') {
                        if (charId === 'user') {
                            const allChats = await db.chats.toArray();
                            for (const chat of allChats) {
                                chat.history = chat.history.filter(msg => msg.role !== 'user');
                                await db.chats.put(chat);
                            }
                        } else {
                            const chat = await db.chats.get(charId);
                            if (chat) {
                                chat.history = [];
                                await db.chats.put(chat);
                            }
                        }
                    }

                    if (type === 'qzone') {
                        const authorId = (charId === 'user') ? 'user' : charId;
                        await db.qzonePosts.where('authorId').equals(authorId).delete();
                    }

                    if (type === 'calls' && charId !== 'user') {
                        await db.callRecords.where('chatId').equals(charId).delete();
                    }

                    // ã€ã€ã€æ ¸å¿ƒä¿®æ­£2ï¼šæ¸…ç†é€»è¾‘ã€‘ã€‘ã€‘
                    if (type === 'thoughts' && charId !== 'user') {
                        const chat = await db.chats.get(charId);
                        if (chat) {
                            chat.thoughtsHistory = [];
                            // ä¸å†æ¸…ç†æ—¥è®°å’Œå¤‡å¿˜å½•
                            await db.chats.put(chat);
                        }
                    }

                    if (type === 'memories' && charId !== 'user') {
                        const chat = await db.chats.get(charId);
                        if (chat) {
                            chat.longTermMemory = [];
                            await db.chats.put(chat);
                        }
                    }
                    
                    if (type === 'cphone' && charId !== 'user') {
                        const chat = await db.chats.get(charId);
                        if (chat) {
                            // æ¸…ç†æ‰€æœ‰CPhoneç›¸å…³æ•°æ®ï¼Œå¹¶åŠ å…¥æ—¥è®°å’Œå¤‡å¿˜å½•
                            chat.simulatedAlbum = [];
                            chat.simulatedConversations = [];
                            chat.simulatedBrowserHistory = [];
                            chat.simulatedTaobaoHistory = null;
                            chat.simulatedAmapHistory = [];
                            chat.simulatedAppUsage = [];
                            chat.simulatedMusicPlaylist = [];
                            chat.diary = []; // <-- æ–°å¢
                            chat.memos = []; // <-- æ–°å¢
                            await db.chats.put(chat);
                        }
                    }
                }
            }
        });
        
        await loadAllDataFromDB();
        await renderChatList();
        
        document.getElementById('data-clear-wizard-modal').classList.remove('visible');
        await showCustomAlert("æ¸…ç†å®Œæˆ", "æŒ‡å®šçš„æ•°æ®å·²æˆåŠŸæ¸…é™¤ã€‚");

    } catch (error) {
        console.error("é«˜çº§æ•°æ®æ¸…ç†å¤±è´¥:", error);
        await showCustomAlert("æ¸…ç†å¤±è´¥", `æ“ä½œå¤±è´¥: ${error.message}`);
    }
}
// â–²â–²â–² å…¨æ–°JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        /**
         * ã€å…¨æ–° V2.0 | æ”¯æŒæœ¬åœ°ä¸Šä¼ ã€‘å¤„ç†æ›´æ¢å›¾æ ‡çš„é€»è¾‘ (EPhone & CPhoneé€šç”¨)
         * @param {string} iconId - è¢«ç‚¹å‡»å›¾æ ‡çš„ID (ä¾‹å¦‚ 'qq', 'album')
         * @param {string} phoneType - 'ephone' æˆ– 'cphone'
         * @param {HTMLElement} itemElement - è¢«ç‚¹å‡»çš„é‚£ä¸ªå›¾æ ‡è®¾ç½®é¡¹çš„DOMå…ƒç´ 
         */
        async function handleIconChange(iconId, phoneType, itemElement) {
            const appName = itemElement.querySelector('.icon-preview').alt;
        
            // 1. å¼¹å‡ºé€‰æ‹©æ¡†ï¼Œè®©ç”¨æˆ·é€‰æ‹©ä¸Šä¼ æ–¹å¼
            const choice = await showChoiceModal(`æ›´æ¢â€œ${appName}â€å›¾æ ‡`, [
                { text: 'ğŸ“ ä»æœ¬åœ°ä¸Šä¼ ', value: 'local' },
                { text: 'ğŸŒ ä½¿ç”¨ç½‘ç»œURL', value: 'url' }
            ]);
        
            let newUrl = null;
        
            // 2. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©æ‰§è¡Œä¸åŒæ“ä½œ
            if (choice === 'local') {
                // è°ƒç”¨æˆ‘ä»¬ç°æœ‰çš„æœ¬åœ°ä¸Šä¼ è¾…åŠ©å‡½æ•°
                newUrl = await uploadImageLocally();
            } else if (choice === 'url') {
                const currentUrl = (phoneType === 'cphone')
                    ? state.globalSettings.cphoneAppIcons[iconId]
                    : state.globalSettings.appIcons[iconId];

                // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒï¼ â˜…â˜…â˜…â˜…â˜…
                // 1. åˆ¤æ–­å½“å‰çš„URLæ˜¯ä¸æ˜¯ä¸€ä¸ªBase64å­—ç¬¦ä¸²
                const isBase64 = currentUrl.startsWith('data:image');

                // 2. å¦‚æœæ˜¯Base64ï¼Œæˆ‘ä»¬å°±ä¼ ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ä½œä¸ºé»˜è®¤å€¼ï¼Œé¿å…å¡æ­»ã€‚
                //    å¦‚æœä¸æ˜¯ï¼Œå°±æ­£å¸¸æ˜¾ç¤ºå½“å‰çš„URLï¼Œæ–¹ä¾¿ç”¨æˆ·ä¿®æ”¹ã€‚
                const initialValueForPrompt = isBase64 ? '' : currentUrl;
                // â˜…â˜…â˜…â˜…â˜… ä¿®å¤ç»“æŸ â˜…â˜…â˜…â˜…â˜…

                // 3. ä½¿ç”¨æˆ‘ä»¬æ–°å¤„ç†è¿‡çš„å€¼æ¥è°ƒç”¨å¼¹çª—
                newUrl = await showCustomPrompt(
                    `æ›´æ¢å›¾æ ‡`, 
                    'è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URL', 
                    initialValueForPrompt, // <-- ä½¿ç”¨è¿™ä¸ªæ–°å˜é‡
                    'url'
                );
            }
        
            // 3. å¦‚æœè·å–åˆ°äº†æ–°å€¼ï¼ˆæ— è®ºæ˜¯Base64è¿˜æ˜¯URLï¼‰ï¼Œå°±æ›´æ–°å¹¶ä¿å­˜
            if (newUrl && newUrl.trim()) {
                const trimmedUrl = newUrl.trim();
                
                // æ ¹æ®æ‰‹æœºç±»å‹ï¼Œæ›´æ–° state ä¸­å¯¹åº”çš„æ•°æ®
                if (phoneType === 'cphone') {
                    state.globalSettings.cphoneAppIcons[iconId] = trimmedUrl;
                } else {
                    state.globalSettings.appIcons[iconId] = trimmedUrl;
                }
                
                // å®æ—¶æ›´æ–°è®¾ç½®é¡µé¢çš„é¢„è§ˆå›¾
                itemElement.querySelector('.icon-preview').src = trimmedUrl;
                
                // æ— éœ€åœ¨è¿™é‡Œä¿å­˜åˆ°æ•°æ®åº“ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»â€œä¿å­˜æ‰€æœ‰å¤–è§‚è®¾ç½®â€æŒ‰é’®æ—¶ç»Ÿä¸€ä¿å­˜ã€‚
            } else if (newUrl !== null) {
                // å¦‚æœç”¨æˆ·è¾“å…¥äº†æ— æ•ˆçš„URL
                alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„URLæˆ–é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼");
            }
        }
// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„ã€åˆ†æ­¥æ‰§è¡Œçš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ compressAllLocalImages â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ | V2.0 ä¿®å¤ç‰ˆã€‘ä¸€é”®å‹ç¼©æ•°æ®åº“ä¸­æ‰€æœ‰æœ¬åœ°ä¸Šä¼ çš„å›¾ç‰‡
 */
async function compressAllLocalImages() {
    // 1. å¼¹å‡ºæœ€ç»ˆç¡®è®¤æ¡† (é€»è¾‘ä¸å˜)
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤å‹ç¼©å›¾ç‰‡ï¼Ÿ',
        'æ­¤æ“ä½œå°†æ‰«æå¹¶å‹ç¼©æ‰€æœ‰æœ¬åœ°ä¸Šä¼ çš„å›¾ç‰‡ï¼ˆBase64æ ¼å¼ï¼‰ï¼Œå°†å…¶è½¬æ¢ä¸ºJPEGä»¥å‡å°ä½“ç§¯ã€‚è¿™ä¼šè½»å¾®é™ä½å›¾ç‰‡è´¨é‡ä¸”ã€ä¸å¯æ¢å¤ã€‘ã€‚<br><br><strong>å¼ºçƒˆå»ºè®®åœ¨æ“ä½œå‰å…ˆè¿›è¡Œæ•°æ®å¤‡ä»½ï¼</strong>',
        { confirmButtonClass: 'btn-danger', confirmText: 'æˆ‘å·²äº†è§£é£é™©ï¼Œç¡®è®¤å‹ç¼©' }
    );

    if (!confirmed) return;

    // 2. æ˜¾ç¤ºå¤„ç†ä¸­çš„æç¤º (é€»è¾‘ä¸å˜)
    await showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨å¼€å§‹å…¨é¢å‹ç¼©å›¾ç‰‡ï¼Œæ ¹æ®å›¾ç‰‡æ•°é‡ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·ä¸è¦å…³é—­æˆ–åˆ·æ–°é¡µé¢...");

    let stats = {
        found: 0,
        compressed: 0,
        skipped: 0,
        originalSize: 0,
        newSize: 0
    };

    try {
        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤é€»è¾‘ä»è¿™é‡Œå¼€å§‹ â˜…â˜…â˜…
        // ==========================================================
        
        // --- æ­¥éª¤ A: è¯»å–æ‰€æœ‰ç›¸å…³æ•°æ®åˆ°å†…å­˜ ---
        console.log("å‹ç¼©æ­¥éª¤ 1/3: æ­£åœ¨ä»æ•°æ®åº“è¯»å–æ‰€æœ‰ç›¸å…³æ•°æ®...");
        const tablesToScan = [
            'chats', 'globalSettings', 'qzoneSettings', 
            'userStickers', 'customAvatarFrames'
        ];
        const allData = [];
        for (const tableName of tablesToScan) {
            const table = db.table(tableName);
            const records = await table.toArray();
            allData.push({ tableName, records });
        }

        // --- æ­¥éª¤ B: åœ¨å†…å­˜ä¸­å¯¹æ•°æ®è¿›è¡Œå¼‚æ­¥å‹ç¼© ---
        console.log("å‹ç¼©æ­¥éª¤ 2/3: æ­£åœ¨å†…å­˜ä¸­å¼‚æ­¥å‹ç¼©å›¾ç‰‡ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...");
        for (const data of allData) {
            for (const record of data.records) {
                // traverseAndCompress å‡½æ•°ç°åœ¨æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒä¸å†å¤„äºä¸€ä¸ªå¼€å¯çš„äº‹åŠ¡ä¸­
                await traverseAndCompress(record, stats);
            }
        }
        
        // --- æ­¥éª¤ C: å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡ï¼Œå°†æ‰€æœ‰ä¿®æ”¹åçš„æ•°æ®ä¸€æ¬¡æ€§å†™å›æ•°æ®åº“ ---
        console.log("å‹ç¼©æ­¥éª¤ 3/3: æ­£åœ¨å°†å‹ç¼©åçš„æ•°æ®å†™å›æ•°æ®åº“...");
        await db.transaction('rw', tablesToScan, async () => {
            for (const data of allData) {
                // ä½¿ç”¨ bulkPut æ‰¹é‡æ›´æ–°ï¼Œæ€§èƒ½æ›´ä½³
                await db.table(data.tableName).bulkPut(data.records);
            }
        });
        
        // ==========================================================
        //            â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤é€»è¾‘åˆ°æ­¤ç»“æŸ â˜…â˜…â˜…
        // ==========================================================

        // 4. æ“ä½œå®Œæˆåï¼Œæ˜¾ç¤ºç»Ÿè®¡ç»“æœ (é€»è¾‘ä¸å˜)
        const reduction = stats.originalSize - stats.newSize;
        const reductionPercent = stats.originalSize > 0 ? (reduction / stats.originalSize * 100).toFixed(2) : 0;

        await showCustomAlert(
            'å‹ç¼©å®Œæˆï¼',
            `æ‰«æå®Œæˆï¼<br>
            - å…±æ‰¾åˆ° ${stats.found} å¼ æœ¬åœ°å›¾ç‰‡<br>
            - æˆåŠŸå‹ç¼© ${stats.compressed} å¼ <br>
            - è·³è¿‡(å·²å‹ç¼©æˆ–æ— éœ€å‹ç¼©) ${stats.skipped} å¼ <br>
            - ç©ºé—´èŠ‚çœäº† <strong>${(reduction / 1024 / 1024).toFixed(2)} MB</strong> (å‹ç¼©ç‡ ${reductionPercent}%)
            <br><br>
            å»ºè®®åˆ·æ–°é¡µé¢ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚`
        );

    } catch (error) {
        console.error("å›¾ç‰‡å‹ç¼©è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:", error);
        await showCustomAlert('å‹ç¼©å¤±è´¥', `æ“ä½œå¤±è´¥: ${error.message}`);
    }
}

// â–²â–²â–² JSå‡½æ•°æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘é€’å½’éå†å¯¹è±¡ï¼Œæ‰¾åˆ°å¹¶å‹ç¼©æ‰€æœ‰Base64å›¾ç‰‡
 * @param {object|Array} obj - è¦éå†çš„å¯¹è±¡æˆ–æ•°ç»„
 * @param {object} stats - ç”¨äºç»Ÿè®¡çš„å¯¹è±¡
 */
async function traverseAndCompress(obj, stats) {
    for (const key in obj) {
        if (typeof obj[key] === 'string' && obj[key].startsWith('data:image')) {
            stats.found++;
            const originalBase64 = obj[key];
            stats.originalSize += originalBase64.length;

            const compressedBase64 = await compressImage(originalBase64);

            if (compressedBase64 && compressedBase64 !== originalBase64) {
                obj[key] = compressedBase64; // ç›´æ¥ä¿®æ”¹åŸå¯¹è±¡
                stats.compressed++;
                stats.newSize += compressedBase64.length;
            } else {
                stats.skipped++;
                stats.newSize += originalBase64.length;
            }
        } else if (typeof obj[key] === 'object' && obj[key] !== null) {
            // å¦‚æœæ˜¯åµŒå¥—å¯¹è±¡æˆ–æ•°ç»„ï¼Œåˆ™ç»§ç»­é€’å½’
            await traverseAndCompress(obj[key], stats);
        }
    }
}

/**
 * ã€æ ¸å¿ƒå‹ç¼©å‡½æ•°ã€‘å°†å•ä¸ªBase64å›¾ç‰‡å­—ç¬¦ä¸²å‹ç¼©ä¸ºJPEGæ ¼å¼
 * @param {string} base64Str - åŸå§‹çš„Base64å›¾ç‰‡å­—ç¬¦ä¸²
 * @param {object} options - å‹ç¼©é€‰é¡¹ (è´¨é‡ã€æœ€å¤§å®½åº¦)
 * @returns {Promise<string|null>} - è¿”å›å‹ç¼©åçš„Base64å­—ç¬¦ä¸²ï¼Œå¦‚æœæ— éœ€å‹ç¼©æˆ–å¤±è´¥åˆ™è¿”å›åŸå­—ç¬¦ä¸²
 */
function compressImage(base64Str, options = {}) {
    return new Promise((resolve) => {
        // å¦‚æœå·²ç»æ˜¯JPEGï¼Œæˆ–è€…ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡å­—ç¬¦ä¸²ï¼Œåˆ™ç›´æ¥è·³è¿‡
        if (base64Str.startsWith('data:image/jpeg') || !base64Str.startsWith('data:image')) {
            resolve(base64Str);
            return;
        }

        const quality = options.quality || 0.7; // 70%çš„JPEGè´¨é‡
        const maxWidth = options.maxWidth || 1024; // å›¾ç‰‡æœ€å¤§å®½åº¦é™åˆ¶ä¸º1024px

        const img = new Image();
        img.onload = () => {
            let width = img.width;
            let height = img.height;

            // å¦‚æœå›¾ç‰‡å®½åº¦è¶…è¿‡æœ€å¤§é™åˆ¶ï¼Œåˆ™ç­‰æ¯”ç¼©æ”¾
            if (width > maxWidth) {
                height = (maxWidth / width) * height;
                width = maxWidth;
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // å°†å›¾ç‰‡ç»˜åˆ¶åˆ°canvasä¸Š
            ctx.drawImage(img, 0, 0, width, height);
            
            // ä»canvaså¯¼å‡ºä¸ºJPEGæ ¼å¼çš„Base64å­—ç¬¦ä¸²
            const newDataUrl = canvas.toDataURL('image/jpeg', quality);
            
            // åªæœ‰å½“å‹ç¼©åçš„ä½“ç§¯æ¯”åŸæ¥å°æ—¶æ‰æ›¿æ¢
            if (newDataUrl.length < base64Str.length) {
                resolve(newDataUrl);
            } else {
                resolve(base64Str); // å‹ç¼©ååè€Œå˜å¤§äº†ï¼Œä¿ç•™åŸå›¾
            }
        };
        img.onerror = () => {
            console.warn("åŠ è½½å›¾ç‰‡å¤±è´¥ï¼Œè·³è¿‡å‹ç¼©:", base64Str.substring(0, 50) + "...");
            resolve(base64Str); // åŠ è½½å¤±è´¥ï¼Œä¿ç•™åŸå›¾
        };
        img.src = base64Str;
    });
}
// â–²â–²â–² JSä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ›´æ–°é€šçŸ¥åŠŸèƒ½çš„ã€å…¨éƒ¨æ ¸å¿ƒJSä»£ç ã€‘ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼

/**
 * æ£€æŸ¥åº”ç”¨æ›´æ–°å¹¶æ ¹æ®ç‰ˆæœ¬å†³å®šæ˜¯å¦æ˜¾ç¤ºé€šçŸ¥
 */
async function checkForUpdates() {
    // å…³é”®1ï¼šåœ¨ä½ çš„ä¸»åº”ç”¨ä¸­å®šä¹‰å½“å‰çš„ç‰ˆæœ¬å·ã€‚
    // æ¯æ¬¡ä½ å¸Œæœ›ç”¨æˆ·çœ‹åˆ°æ›´æ–°é€šçŸ¥æ—¶ï¼Œéƒ½éœ€è¦æ›´æ–° `update-notice.html` é‡Œçš„ `data-version`ã€‚
    // è¿™ä¸ªç‰ˆæœ¬å·ä¸»è¦æ˜¯ä¸ºäº†é€»è¾‘å®Œæ•´æ€§ï¼Œä½†æ ¸å¿ƒåˆ¤æ–­ä¾æ®æ˜¯é€šçŸ¥æ–‡ä»¶é‡Œçš„ç‰ˆæœ¬ã€‚
    const CURRENT_APP_VERSION = "1.0"; 

    try {
        // 1. ä»æœåŠ¡å™¨è·å–æœ€æ–°çš„é€šçŸ¥æ–‡ä»¶å†…å®¹
        const response = await fetch('update-notice.html?_=' + Date.now()); // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
        if (!response.ok) {
            console.warn('è·å–æ›´æ–°é€šçŸ¥æ–‡ä»¶å¤±è´¥ã€‚');
            return;
        }
        const noticeHtml = await response.text();
        
        // 2. è§£æé€šçŸ¥å†…å®¹å’Œç‰ˆæœ¬å·
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = noticeHtml;
        const noticeContent = tempDiv.querySelector('[data-version]');
        
        if (!noticeContent) {
            console.error('æ›´æ–°é€šçŸ¥æ–‡ä»¶ä¸­ç¼ºå°‘ data-version å±æ€§ã€‚');
            return;
        }
        
        const notificationVersion = noticeContent.dataset.version;
        
        // 3. ä»æœ¬åœ°å­˜å‚¨ä¸­è·å–ç”¨æˆ·ä¸Šæ¬¡å¿½ç•¥çš„ç‰ˆæœ¬å·
        const dismissedVersion = localStorage.getItem('dismissedUpdateVersion');
        
        // 4. æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœé€šçŸ¥ç‰ˆæœ¬å·æ¯”ç”¨æˆ·å¿½ç•¥çš„ç‰ˆæœ¬å·è¦æ–°ï¼Œå°±æ˜¾ç¤ºé€šçŸ¥
        // ä½¿ç”¨ç®€å•çš„å­—ç¬¦ä¸²æ¯”è¾ƒå³å¯
        if (notificationVersion > dismissedVersion) {
            console.log(`å‘ç°æ–°ç‰ˆæœ¬é€šçŸ¥: ${notificationVersion} (å·²å¿½ç•¥ç‰ˆæœ¬: ${dismissedVersion})`);
            showUpdateNotice(notificationVersion, noticeContent.innerHTML);
        } else {
            console.log(`å½“å‰é€šçŸ¥ç‰ˆæœ¬ (${notificationVersion}) å·²è¢«ç”¨æˆ·å¿½ç•¥ï¼Œæ— éœ€æ˜¾ç¤ºã€‚`);
        }

    } catch (error) {
        console.error('æ£€æŸ¥æ›´æ–°æ—¶å‡ºé”™:', error);
    }
}

/**
 * æ˜¾ç¤ºæ›´æ–°é€šçŸ¥å¼¹çª—
 * @param {string} version - å½“å‰é€šçŸ¥çš„ç‰ˆæœ¬å·
 * @param {string} contentHtml - è¦æ˜¾ç¤ºçš„HTMLå†…å®¹
 */
function showUpdateNotice(version, contentHtml) {
    const modal = document.getElementById('update-notice-modal');
    const body = document.getElementById('update-notice-body');
    const confirmBtn = document.getElementById('update-notice-confirm-btn');
    const dismissBtn = document.getElementById('update-notice-dismiss-btn');
    
    body.innerHTML = contentHtml;
    
    // â€œæˆ‘çŸ¥é“äº†â€æŒ‰é’®ï¼šåªå…³é—­å¼¹çª—ï¼Œä¸è®°å½•ç‰ˆæœ¬
    confirmBtn.onclick = () => {
        modal.classList.remove('visible');
    };
    
    // â€œä¸å†æç¤ºâ€æŒ‰é’®ï¼šå…³é—­å¼¹çª—ï¼Œå¹¶å°†å½“å‰ç‰ˆæœ¬å·å­˜å…¥localStorage
    dismissBtn.onclick = () => {
        localStorage.setItem('dismissedUpdateVersion', version);
        modal.classList.remove('visible');
        console.log(`ç”¨æˆ·å·²å¿½ç•¥ç‰ˆæœ¬: ${version}`);
    };
    
    modal.classList.add('visible');
}

// â–²â–²â–² æ–°å¢JSä»£ç ç»“æŸ â–²â–²â–²

              // ===================================================================
                // 4. åˆå§‹åŒ–å‡½æ•° init()
                // ===================================================================
                async function init() {
        /**
         * æ™ºèƒ½å¯¼å…¥å¤„ç†å™¨ï¼šè‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç±»å‹å¹¶è°ƒç”¨ç›¸åº”çš„å¯¼å…¥å‡½æ•°
         * @param {File} file - ç”¨æˆ·é€‰æ‹©çš„ .json æ–‡ä»¶
         */
        async function handleWorldBookImport(file) {
            if (!file) return;
        
            try {
                const text = await file.text();
                const data = JSON.parse(text);
        
                // æ£€æŸ¥æ˜¯å¦æ˜¯ EPhone çš„å¤‡ä»½æ–‡ä»¶
                if (data.type === 'EPhoneWorldBookBackup') {
                    console.log("æ£€æµ‹åˆ° EPhone å¤‡ä»½æ–‡ä»¶ï¼Œæ‰§è¡Œæ ‡å‡†å¯¼å…¥...");
                    await importWorldBooks(data); // æ³¨æ„ï¼šæˆ‘ä»¬å°†ä¿®æ”¹ importWorldBooks æ¥æ¥æ”¶è§£æåçš„æ•°æ®
                } 
                // æ£€æŸ¥æ˜¯å¦æ˜¯ Tavern AI çš„ä¸–ç•Œä¹¦æ–‡ä»¶
                else if (data.entries && typeof data.entries === 'object') {
                    console.log("æ£€æµ‹åˆ° Tavern AI ä¸–ç•Œä¹¦æ–‡ä»¶ï¼Œæ‰§è¡Œå…¼å®¹å¯¼å…¥...");
                    await importTavernWorldBook(data, file.name);
                } 
                // å¦‚æœä¸¤ç§æ ¼å¼éƒ½ä¸æ˜¯
                else {
                    throw new Error("æ–‡ä»¶æ ¼å¼æ— æ³•è¯†åˆ«ã€‚è¯·ç¡®ä¿æ‚¨é€‰æ‹©çš„æ˜¯æœ‰æ•ˆçš„ EPhone ä¸–ç•Œä¹¦å¤‡ä»½æˆ– Tavern AI ä¸–ç•Œä¹¦æ–‡ä»¶ã€‚");
                }
        
            } catch (error) {
                console.error("å¯¼å…¥ä¸–ç•Œä¹¦æ—¶å‡ºé”™:", error);
                await showCustomAlert('å¯¼å…¥å¤±è´¥', `æ–‡ä»¶è§£ææˆ–åº”ç”¨å¤±è´¥: ${error.message}`);
            }
        }
        
        /**
         * ã€å…¼å®¹æ ¸å¿ƒã€‘ä» Tavern AI æ ¼å¼çš„æ•°æ®åˆ›å»ºä¸€æœ¬æ–°çš„ä¸–ç•Œä¹¦
         * @param {object} tavernData - ä» Tavern AI .json æ–‡ä»¶è§£æå‡ºçš„æ•°æ®
         * @param {string} fileName - åŸå§‹æ–‡ä»¶åï¼Œç”¨äºç”Ÿæˆé»˜è®¤ä¹¦å
         */
        async function importTavernWorldBook(tavernData, fileName) {
            const bookNameSuggestion = fileName.replace(/\.json$/i, ''); // ä»æ–‡ä»¶åä¸­æå–å»ºè®®åç§°
        
            const newBookName = await showCustomPrompt(
                "å¯¼å…¥ Tavern AI ä¸–ç•Œä¹¦", 
                "è¯·ä¸ºè¿™æœ¬è®¾å®šé›†å‘½åï¼š",
                bookNameSuggestion
            );
        
            if (!newBookName || !newBookName.trim()) {
                alert("å¯¼å…¥å·²å–æ¶ˆï¼Œå› ä¸ºæœªæä¾›ä¹¦åã€‚");
                return;
            }
        
            const newEntries = Object.values(tavernData.entries).map(entry => {
                // å°† Tavern çš„æ•°æ®ç»“æ„è½¬æ¢ä¸º EPhone çš„æ ¼å¼
                return {
                    keys: entry.key || [],
                    comment: entry.comment || 'æ— å¤‡æ³¨',
                    content: entry.content || '',
                    enabled: !entry.disable // æ³¨æ„ï¼šTavern çš„ disable å’Œ EPhone çš„ enabled é€»è¾‘æ˜¯ç›¸åçš„
                };
            }).filter(entry => entry.content); // è¿‡æ»¤æ‰æ²¡æœ‰å†…å®¹çš„æ¡ç›®
        
            if (newEntries.length === 0) {
                alert("è¿™ä¸ª Tavern AI ä¸–ç•Œä¹¦ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„æ¡ç›®ã€‚");
                return;
            }
        
            const newWorldBook = {
                id: 'wb_' + Date.now(),
                name: newBookName.trim(),
                content: newEntries,
                categoryId: null // é»˜è®¤ä¸åˆ†ç±»
            };
        
            await db.worldBooks.add(newWorldBook);
            state.worldBooks.push(newWorldBook); // æ›´æ–°å†…å­˜
            await renderWorldBookScreen(); // åˆ·æ–°UI
        
            await showCustomAlert('å¯¼å…¥æˆåŠŸï¼', `å·²æˆåŠŸä» Tavern AI æ–‡ä»¶å¯¼å…¥è®¾å®šé›†ã€Š${newBookName}ã€‹ã€‚`);
        }


        async function exportWorldBooks() {
            try {
                const books = await db.worldBooks.toArray();
                const categories = await db.worldBookCategories.toArray();
        
                if (books.length === 0 && categories.length === 0) {
                    alert("æ²¡æœ‰å¯å¯¼å‡ºçš„ä¸–ç•Œä¹¦æ•°æ®ã€‚");
                    return;
                }
        
                const backupData = {
                    type: 'EPhoneWorldBookBackup', // ç‰¹æ®Šæ ‡è®°ï¼Œç”¨äºå¯¼å…¥æ—¶éªŒè¯
                    version: 1,
                    timestamp: Date.now(),
                    books: books,
                    categories: categories
                };
        
                const blob = new Blob(
                    [JSON.stringify(backupData, null, 2)], 
                    { type: 'application/json' }
                );
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `EPhone-WorldBooks-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                await showCustomAlert('å¯¼å‡ºæˆåŠŸ', 'æ‰€æœ‰ä¸–ç•Œä¹¦æ•°æ®å·²æˆåŠŸå¯¼å‡ºï¼');
        
            } catch (error) {
                console.error("å¯¼å‡ºä¸–ç•Œä¹¦æ—¶å‡ºé”™:", error);
                await showCustomAlert('å¯¼å‡ºå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: ${error.message}`);
            }
        }
        
/**
         * ã€å·²æ›´æ–°ã€‘å¯¼å…¥ EPhone ä¸–ç•Œä¹¦å¤‡ä»½æ•°æ®ï¼Œå¹¶è¦†ç›–ç°æœ‰æ•°æ®
         * @param {object} data - ä»å¤‡ä»½æ–‡ä»¶è§£æå‡ºçš„JSONæ•°æ®
         */
        async function importWorldBooks(data) {
            // è¿™ä¸ªå‡½æ•°ç°åœ¨ç›´æ¥æ¥æ”¶è§£æå¥½çš„æ•°æ®ï¼Œä¸å†éœ€è¦è¯»å–æ–‡ä»¶
            try {
                if (data.type !== 'EPhoneWorldBookBackup' || !data.books) {
                    throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ä¸–ç•Œä¹¦å¤‡ä»½æ–‡ä»¶ã€‚");
                }
        
                const confirmed = await showCustomConfirm(
                    'å¯¼å…¥ä¸–ç•Œä¹¦',
                    'è¿™å°†ç”¨æ–‡ä»¶ä¸­çš„æ•°æ®ã€å®Œå…¨è¦†ç›–ã€‘æ‚¨å½“å‰æ‰€æœ‰çš„ä¸–ç•Œä¹¦å’Œåˆ†ç±»ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼',
                    { confirmButtonClass: 'btn-danger', confirmText: 'ç¡®è®¤è¦†ç›–' }
                );
        
                if (!confirmed) return;
        
                await db.transaction('rw', db.worldBooks, db.worldBookCategories, async () => {
                    await db.worldBooks.clear();
                    await db.worldBookCategories.clear();
                    
                    if (Array.isArray(data.books)) {
                        await db.worldBooks.bulkPut(data.books);
                    }
                    if (Array.isArray(data.categories)) {
                        await db.worldBookCategories.bulkPut(data.categories);
                    }
                });
        
                // æ›´æ–°å†…å­˜ä¸­çš„ state å¹¶é‡æ–°æ¸²æŸ“
                state.worldBooks = await db.worldBooks.toArray();
                await renderWorldBookScreen();
        
                await showCustomAlert('å¯¼å…¥æˆåŠŸ', 'ä¸–ç•Œä¹¦æ•°æ®å·²æˆåŠŸæ¢å¤ï¼');
        
            } catch (error) {
                console.error("å¯¼å…¥ä¸–ç•Œä¹¦æ—¶å‡ºé”™:", error);
                await showCustomAlert('å¯¼å…¥å¤±è´¥', `æ–‡ä»¶è§£ææˆ–åº”ç”¨å¤±è´¥: ${error.message}`);
            }
        }


    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨ `init` å‡½æ•°çš„æœ€å¼€å§‹ï¼Œæ£€æŸ¥å¹¶æ‰§è¡Œåå°æ´»åŠ¨æ¨¡æ‹Ÿ
    const lastActiveTimestamp = localStorage.getItem('ephoneLastActiveTimestamp');
    if (lastActiveTimestamp) {
        const minutesOffline = (Date.now() - parseInt(lastActiveTimestamp)) / (1000 * 60);
        // å¦‚æœç¦»çº¿è¶…è¿‡5åˆ†é’Ÿï¼Œæ‰å¼€å§‹æ¨¡æ‹Ÿ
        if (minutesOffline > 5) {
            // æ³¨æ„ï¼šæˆ‘ä»¬åœ¨è¿™é‡Œè°ƒç”¨æ¨¡æ‹Ÿå‡½æ•°ï¼Œä½†ä¸ä½¿ç”¨ await
            // è¿™æ ·å®ƒå°±ä¼šåœ¨åå°é»˜é»˜æ‰§è¡Œï¼Œä¸ä¼šå¡ä½åº”ç”¨çš„å¯åŠ¨è¿‡ç¨‹
            simulateBackgroundActivity(minutesOffline);
        }
    }
    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
setupCharPlayerControls();
    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤ã€‘å°†å†…éƒ¨å‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä»¥ä¾¿HTMLä¸­çš„ onclick å¯ä»¥è°ƒç”¨å®ƒä»¬ â–¼â–¼â–¼
    window.showScreen = showScreen;
    window.openRenderingRulesScreen = openRenderingRulesScreen;
    window.handleListenTogetherClick = handleListenTogetherClick; // ä¸ºâ€œä¸€èµ·å¬â€æŒ‰é’®æš´éœ²å‡½æ•°
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
window.openCharacterSelector = openCharacterSelector;
window.openCharApp = openCharApp;
window.switchToMyPhone = switchToMyPhone;
window.switchToCharHomeScreen = switchToCharHomeScreen;
window.openNpcEditor = openNpcEditor; // <-- æ–°å¢è¿™ä¸€è¡Œ
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
    // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
        // åœ¨ init() å‡½æ•°å¼€å¤´æ·»åŠ 
        const stickerActionBar = document.createElement('div');
        stickerActionBar.id = 'sticker-action-bar';
        stickerActionBar.innerHTML = '<button id="delete-selected-stickers-btn">åˆ é™¤ (0)</button>';
        document.getElementById('sticker-panel').appendChild(stickerActionBar);
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
                    const globalCssStyleTag = document.createElement('style');
                    globalCssStyleTag.id = 'global-custom-style';
                    document.head.appendChild(globalCssStyleTag);
                    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        // åœ¨ init() å‡½æ•°çš„å¼€å¤´
        qzoneStickerPanelState.panelEl = document.getElementById('qzone-sticker-panel');
        qzoneStickerPanelState.gridEl = document.getElementById('qzone-sticker-grid');
            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„ã€æœ€å¼€å¤´ã€‘ï¼Œç²˜è´´ä¸‹é¢è¿™ä¸¤è¡Œä»£ç  â–¼â–¼â–¼
            const savedTheme = localStorage.getItem('ephone-theme') || 'light'; // é»˜è®¤ä¸ºæ—¥é—´æ¨¡å¼
            applyTheme(savedTheme);
            // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
        
            // â–¼â–¼â–¼ æ–°å¢ä»£ç  â–¼â–¼â–¼
            const customBubbleStyleTag = document.createElement('style');
            customBubbleStyleTag.id = 'custom-bubble-style';
            document.head.appendChild(customBubbleStyleTag);
            // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        
            // â–¼â–¼â–¼ æ–°å¢ä»£ç  â–¼â–¼â–¼
            const previewBubbleStyleTag = document.createElement('style');
            previewBubbleStyleTag.id = 'preview-bubble-style';
            document.head.appendChild(previewBubbleStyleTag);
            // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        
        
            // â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸¤è¡Œ â–¼â–¼â–¼
            applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå®èŠå¤©ç•Œé¢çš„è‡ªå®šä¹‰æ ·å¼
            applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é¢„è§ˆåŒºçš„è‡ªå®šä¹‰æ ·å¼
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
                   window.openRenderingRulesScreen = openRenderingRulesScreen;
                    window.showScreen = showScreen;
                    window.renderChatListProxy = renderChatList;
                    window.renderApiSettingsProxy = renderApiSettings;
                    window.renderWallpaperScreenProxy = renderWallpaperScreen;
                    window.renderWorldBookScreenProxy = renderWorldBookScreen;
        
                    await loadAllDataFromDB();
                    applyStatusBarVisibility(); // <-- æ–°å¢è¿™ä¸€è¡Œ
                    // â–¼â–¼â–¼ ã€æ ¸å¿ƒã€‘åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™è¡Œæ–°ä»£ç  â–¼â–¼â–¼
                    await migrateOldRedPacketData();
                    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
                    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
                    applyGlobalCss(state.globalSettings.globalCss);
                    // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        
                    // åˆå§‹åŒ–æœªè¯»åŠ¨æ€è®¡æ•°
                    const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
                    updateUnreadIndicator(storedCount);
                    
                    // â–²â–²â–² ä»£ç æ·»åŠ ç»“æŸ â–²â–²â–²
        
                    if (state.globalSettings && state.globalSettings.fontUrl) {
                        applyCustomFont(state.globalSettings.fontUrl);
                    }
        
                    updateClock();
                    setInterval(updateClock, 1000 * 30);
                    applyGlobalWallpaper();
                    initBatteryManager(); 
        
        applyAppIcons();
        applyWidgetData(); // <-- æ·»åŠ è¿™ä¸€è¡Œ
        
                    // ==========================================================
                    // --- å„ç§äº‹ä»¶ç›‘å¬å™¨ ---
                    // ==========================================================
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œæ·»åŠ è¿™è¡Œæ–°ä»£ç  â–¼â–¼â–¼
        document.getElementById('rules-tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('rules-tab')) {
                switchRuleCategory(e.target.dataset.categoryId);
            }
        });
        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
        // æ¸²æŸ“è§„åˆ™åŠŸèƒ½äº‹ä»¶ç»‘å®š
        document.getElementById('add-new-rule-btn').addEventListener('click', () => openRuleEditor(null));
        document.getElementById('cancel-rule-editor-btn').addEventListener('click', () => {
            document.getElementById('rule-editor-modal').classList.remove('visible');
        });
        document.getElementById('save-rule-btn').addEventListener('click', saveRenderingRule);
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºå•èŠâ€œæ‹ä¸€æ‹â€æŒ‰é’®ç»‘å®šäº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('pat-btn').addEventListener('click', () => {
            // ç¡®ä¿å½“å‰åœ¨å•èŠä¸­
            if (state.activeChatId && !state.chats[state.activeChatId].isGroup) {
                const chat = state.chats[state.activeChatId];
                // è°ƒç”¨ç°æœ‰çš„æ‹ä¸€æ‹å‡½æ•°ï¼Œå¹¶ä¼ å…¥æ­£ç¡®çš„å‚æ•°
                handleUserPat(chat.id, chat.originalName);
            }
        });
        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è¿™æ˜¯æ‚¨ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½ä»£ç ï¼Œè¯·ç²˜è´´åœ¨è¿™é‡Œã€‘ â–¼â–¼â–¼
        let activeAnnouncementId = null; // ç”¨äºæš‚å­˜æ­£åœ¨æ“ä½œçš„å…¬å‘ŠID
        
        /**
         * ç‚¹å‡»â€œ...â€æ—¶ï¼Œæ˜¾ç¤ºæ“ä½œèœå•ï¼ˆç½®é¡¶/åˆ é™¤ï¼‰
         * @param {string} annoId - å…¬å‘Šçš„å”¯ä¸€ID
         */
        function showAnnouncementActions(annoId) {
            activeAnnouncementId = annoId;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === annoId);
            if (!announcement) return;
        
            const pinButton = document.getElementById('announcement-action-pin');
            // æ ¹æ®å½“å‰æ˜¯å¦å·²ç½®é¡¶ï¼ŒåŠ¨æ€æ”¹å˜æŒ‰é’®æ–‡å­—
            pinButton.textContent = announcement.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶å…¬å‘Š';
        
            document.getElementById('announcement-actions-modal').classList.add('visible');
        }
        
        /**
         * å¤„ç†â€œç½®é¡¶/å–æ¶ˆç½®é¡¶â€æ“ä½œ
         */
        async function handlePinAnnouncement() {
            if (!activeAnnouncementId) return;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === activeAnnouncementId);
            if (announcement) {
                announcement.isPinned = !announcement.isPinned; // åˆ‡æ¢ç½®é¡¶çŠ¶æ€
                await db.chats.put(chat);
                showAnnouncementBoard(); // é‡æ–°æ¸²æŸ“å…¬å‘Šæ¿ä»¥æ›´æ–°UI
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        
        /**
         * å¤„ç†â€œåˆ é™¤å…¬å‘Šâ€æ“ä½œ
         */
        async function handleDeleteAnnouncement() {
            if (!activeAnnouncementId) return;
        
            const confirmed = await showCustomConfirm("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", { confirmButtonClass: 'btn-danger' });
        
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                // ä»å…¬å‘Šæ•°ç»„ä¸­è¿‡æ»¤æ‰è¦åˆ é™¤çš„å…¬å‘Š
                chat.announcements = chat.announcements.filter(a => a.id !== activeAnnouncementId);
                await db.chats.put(chat);
                showAnnouncementBoard(); // é‡æ–°æ¸²æŸ“
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
                    document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
                    document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
                    document.getElementById('export-data-btn').addEventListener('click', exportBackup);
// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
document.getElementById('cleanup-data-btn').addEventListener('click', cleanupRedundantData);
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
                    document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
                    document.getElementById('import-data-input').addEventListener('change', e => importBackup(e.target.files[0]));
                    document.getElementById('import-card-input').addEventListener('change', handleCardImport);
                    document.getElementById('back-to-list-btn').addEventListener('click', () => { 

            // â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸¤è¡Œ â–¼â–¼â–¼
            applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå®èŠå¤©ç•Œé¢çš„è‡ªå®šä¹‰æ ·å¼
            applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é¢„è§ˆåŒºçš„è‡ªå®šä¹‰æ ·å¼
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        
        exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
                    
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ add-chat-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('add-chat-btn').addEventListener('click', async () => {
            // ä½¿ç”¨æˆ‘ä»¬ç°æœ‰çš„ showChoiceModal å‡½æ•°æ¥æä¾›é€‰é¡¹
            const choice = await showChoiceModal('åˆ›å»ºæ–°èŠå¤©', [
                { text: 'æ‰‹åŠ¨åˆ›å»ºè§’è‰²', value: 'manual' },
                { text: 'ä»è§’è‰²å¡å¯¼å…¥ (.json/.png)', value: 'import_card' }
            ]);
        
            if (choice === 'manual') {
                // å¦‚æœç”¨æˆ·é€‰æ‹©æ‰‹åŠ¨ï¼Œåˆ™æ‰§è¡ŒåŸæ¥çš„é€»è¾‘
                const remarkName = await showCustomPrompt('åˆ›å»ºæ–°èŠå¤© (ç¬¬1/2æ­¥)', 'è¯·è¾“å…¥ä½ æƒ³ä¸ºTaè®¾ç½®çš„ã€å¤‡æ³¨åã€‘(ä¾‹å¦‚: å“¥å“¥)');
                if (!remarkName || !remarkName.trim()) return;
        
                const originalName = await showCustomPrompt('åˆ›å»ºæ–°èŠå¤© (ç¬¬2/2æ­¥)', 'è¯·è¾“å…¥Taçš„ã€æœ¬åã€‘(ä¾‹å¦‚: ææ˜Ÿè¾°ï¼Œè¿™ä¸ªåå­—å°†ç”¨äºAIè¯†åˆ«)');
                if (!originalName || !originalName.trim()) return;
        
                const newChatId = 'chat_' + Date.now();
                const newChat = {
                    id: newChatId,
                    name: remarkName.trim(),
                    originalName: originalName.trim(),
                    isGroup: false,
                    relationship: { status: 'friend', blockedTimestamp: null, applicationReason: '' },
                    status: { text: 'åœ¨çº¿', lastUpdate: Date.now(), isBusy: false },
                    settings: {
                        aiPersona: 'è¿™æ˜¯ä¸€ä¸ªé€šè¿‡æ‰‹åŠ¨åˆ›å»ºçš„è§’è‰²ã€‚', myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚', maxMemory: 10,
                        aiAvatar: defaultAvatar, myAvatar: defaultAvatar, background: '',
                        theme: 'default', fontSize: 13, customCss: '',
                        linkedWorldBookIds: [], aiAvatarLibrary: []
                    },
                    history: [], musicData: { totalTime: 0 },
    longTermMemory: [] // <--- åœ¨è¿™é‡Œæ·»åŠ è¿™ä¸€è¡Œ
                };
                state.chats[newChatId] = newChat;
                await db.chats.put(newChat);
                renderChatList();
                
            } else if (choice === 'import_card') {
                // å¦‚æœç”¨æˆ·é€‰æ‹©å¯¼å…¥ï¼Œå°±è§¦å‘æˆ‘ä»¬æ–°æ·»åŠ çš„éšè—æ–‡ä»¶è¾“å…¥æ¡†
                document.getElementById('import-card-input').click();
            }
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
                    // â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘åˆ›å»ºç¾¤èŠæŒ‰é’®ç°åœ¨æ‰“å¼€è”ç³»äººé€‰æ‹©å™¨ â–¼â–¼â–¼
        document.getElementById('add-group-chat-btn').addEventListener('click', openContactPickerForGroupCreate);
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²                      
                    document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
                    document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);
        
                    document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
                    document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
                    document.getElementById('music-return-btn').addEventListener('click', returnToChat);
                    document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
                    document.getElementById('music-next-btn').addEventListener('click', playNext);
                    document.getElementById('music-prev-btn').addEventListener('click', playPrev);
                    document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
                    document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
                    document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
                    document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
                    document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
                    document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
                    audioPlayer.addEventListener('ended', () => {
    // æ­Œæ›²æ’­æ”¾ç»“æŸæ—¶ï¼Œç§»é™¤æ—‹è½¬æ ·å¼
    document.getElementById('vinyl-view').classList.remove('spinning');
    playNext(); 
});

audioPlayer.addEventListener('pause', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = false; 
        updatePlayerUI(); 
        // éŸ³ä¹æš‚åœæ—¶ï¼Œç§»é™¤æ—‹è½¬æ ·å¼
        document.getElementById('vinyl-view').classList.remove('spinning');
    } 
});

audioPlayer.addEventListener('play', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = true; 
        updatePlayerUI(); 
        // éŸ³ä¹å¼€å§‹æ’­æ”¾æ—¶ï¼Œæ·»åŠ æ—‹è½¬æ ·å¼
        document.getElementById('vinyl-view').classList.add('spinning');
    } 
});
        
                    const chatInput = document.getElementById('chat-input');
                    // â–¼â–¼â–¼ æ‰¾åˆ° id="send-btn" çš„ click äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// ã€æœ€ç»ˆæ€§èƒ½ä¼˜åŒ–ç‰ˆã€‘
document.getElementById('send-btn').addEventListener('click', () => { // æ³¨æ„ï¼šç§»é™¤äº† async
    const content = chatInput.value.trim();
    if (!content || !state.activeChatId) return;

    const chat = state.chats[state.activeChatId];
    const msg = {
        role: 'user',
        content,
        timestamp: Date.now()
    };

    if (currentReplyContext) {
        msg.quote = currentReplyContext;
    }

    // ã€ä¼˜åŒ–1ï¼šå…ˆæ¸²æŸ“ï¼Œåä¿å­˜ã€‘ç«‹å³å°†æ¶ˆæ¯æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œç»™ç”¨æˆ·å³æ—¶åé¦ˆï¼
    appendMessage(msg, chat);

    // ã€ä¼˜åŒ–2ï¼šå¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œã€‘å°†æ•°æ®å­˜å‚¨å’Œåˆ—è¡¨æ›´æ–°æ”¾åˆ°åå°ï¼Œä¸é˜»å¡ç”¨æˆ·ç•Œé¢
    (async () => {
        chat.history.push(msg);
        await db.chats.put(chat); // ä¿å­˜åˆ°æ•°æ®åº“
    renderChatList(); // <<<<< ä¿®æ”¹ä¸ºè¿™ä¸€è¡Œ

    })();

    // æ¸…ç†å·¥ä½œï¼ˆè¿™éƒ¨åˆ†å¾ˆå¿«ï¼Œå¯ä»¥ç«‹å³æ‰§è¡Œï¼‰
    chatInput.value = '';
    chatInput.style.height = 'auto';
    chatInput.focus();
    cancelReplyMode();
});
                    document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
                    chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
                    //chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });
        
                    document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªå·²åŒ…å«CPhoneè®¾ç½®çš„æœ€ç»ˆç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ 'save-wallpaper-btn' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
            // ä¿å­˜ EPhone å£çº¸
            if (newWallpaperBase64) {
                state.globalSettings.wallpaper = newWallpaperBase64;
            }
            
            // ã€æ ¸å¿ƒæ–°å¢ã€‘å°† state ä¸­ä¸´æ—¶çš„ CPhone å£çº¸è®¾ç½®ä¹Ÿä¸€å¹¶ä¿å­˜
            // (æ³¨æ„ï¼šcphoneWallpaperå·²ç»åœ¨ä¸Šä¼ æ—¶æ›´æ–°åˆ°stateäº†, è¿™é‡Œåªéœ€ç¡®ä¿å®ƒè¢«å­˜å…¥æ•°æ®åº“)

            state.globalSettings.globalCss = document.getElementById('global-css-input').value.trim();
            state.globalSettings.notificationSoundUrl = document.getElementById('notification-sound-url-input').value.trim();
            state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;
            
            // ä¸€æ¬¡æ€§ä¿å­˜æ‰€æœ‰å…¨å±€è®¾ç½® (åŒ…æ‹¬äº†EPhoneå’ŒCPhoneçš„æ‰€æœ‰æ–°æ—§è®¾ç½®)
            await db.globalSettings.put(state.globalSettings);
            
            // åº”ç”¨æ‰€æœ‰æ›´æ”¹
            applyGlobalWallpaper();
            applyCPhoneWallpaper(); // <-- æ–°å¢è°ƒç”¨
            newWallpaperBase64 = null; // æ¸…ç©ºä¸´æ—¶å£çº¸å˜é‡

            applyAppIcons();
            applyCPhoneAppIcons(); // <-- æ–°å¢è°ƒç”¨
            
            applyGlobalCss(state.globalSettings.globalCss);
            applyStatusBarVisibility();

            alert('å¤–è§‚è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼');
            showScreen('home-screen');
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ save-api-settings-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('save-api-settings-btn').addEventListener('click', async () => {
            // ä¿å­˜ä¸»API
            state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim();
            state.apiConfig.apiKey = document.getElementById('api-key').value.trim();
            state.apiConfig.model = document.getElementById('model-select').value;
            
            // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¿å­˜å‰¯API
            state.apiConfig.secondaryProxyUrl = document.getElementById('secondary-proxy-url').value.trim();
            state.apiConfig.secondaryApiKey = document.getElementById('secondary-api-key').value.trim();
            state.apiConfig.secondaryModel = document.getElementById('secondary-model-select').value;
            
            await db.apiConfig.put(state.apiConfig);
        
            // åå°æ´»åŠ¨è®¾ç½®çš„ä¿å­˜é€»è¾‘ä¿æŒä¸å˜
            const backgroundSwitch = document.getElementById('background-activity-switch');
            const intervalInput = document.getElementById('background-interval-input');
            const cooldownInput = document.getElementById('block-cooldown-input');
        
            state.globalSettings.enableBackgroundActivity = backgroundSwitch.checked;
            state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
            state.globalSettings.blockCooldownHours = parseFloat(cooldownInput.value) || 1;
            state.globalSettings.enableAiDrawing = document.getElementById('enable-ai-drawing-switch').checked;
            await db.globalSettings.put(state.globalSettings);
        
            stopBackgroundSimulation(); 
            if (state.globalSettings.enableBackgroundActivity) {
                startBackgroundSimulation();
                console.log(`åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²å¯åŠ¨ï¼Œé—´éš”: ${state.globalSettings.backgroundActivityInterval}ç§’`);
            } else {
                console.log("åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²åœæ­¢ã€‚");
            }
            
            alert('æ‰€æœ‰APIä¸åå°è®¾ç½®å·²ä¿å­˜!'); 
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
                            // gemini å¯†é’¥èšç„¦çš„æ—¶å€™æ˜¾ç¤ºæ˜æ–‡
                const ApiKeyInput = document.getElementById('api-key')
                ApiKeyInput.addEventListener('focus', (e) => {
                    e.target.setAttribute('type', 'text')
                })
                ApiKeyInput.addEventListener('blur', (e) => {
                    e.target.setAttribute('type', 'password')
                })
        
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™æ•´å—ä»£ç ã€‘æ›¿æ¢æ—§çš„ fetch-models-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        
        // å°è£…ä¸€ä¸ªå¯å¤ç”¨çš„æ¨¡å‹æ‹‰å–å‡½æ•°
        async function fetchModels(urlInputId, keyInputId, selectId) {
            const url = document.getElementById(urlInputId).value.trim();
            const key = document.getElementById(keyInputId).value.trim();
            if (!url || !key) return alert('è¯·å…ˆå¡«å†™å¯¹åº”çš„åä»£åœ°å€å’Œå¯†é’¥');
            
            try {
                let isGemini = url === GEMINI_API_URL;
                const response = await fetch(isGemini ? `${GEMINI_API_URL}?key=${getRandomValue(key)}` : `${url}/v1/models`, isGemini ? undefined : { headers: { 'Authorization': `Bearer ${key}` } });
                if (!response.ok) throw new Error('æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨');
                const data = await response.json();
                let models = isGemini ? data.models.map(model => ({ id: model.name.split('/')[1] || model.name })) : data.data;
                
                const modelSelect = document.getElementById(selectId);
                modelSelect.innerHTML = '';
                // ã€æ ¸å¿ƒã€‘æ ¹æ®æ˜¯ä¸»/å‰¯æ¨¡å‹ï¼Œè¯»å–æ­£ç¡®çš„å·²ä¿å­˜æ¨¡å‹
                const savedModel = selectId === 'model-select' ? state.apiConfig.model : state.apiConfig.secondaryModel;
        
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    if (model.id === savedModel) option.selected = true;
                    modelSelect.appendChild(option);
                });
                alert('æ¨¡å‹åˆ—è¡¨å·²æ›´æ–°');
            } catch (error) {
                alert(`æ‹‰å–æ¨¡å‹å¤±è´¥: ${error.message}`);
            }
        }
        
        // ç»‘å®šä¸»æ¨¡å‹æ‹‰å–æŒ‰é’®
        document.getElementById('fetch-models-btn').addEventListener('click', () => {
            fetchModels('proxy-url', 'api-key', 'model-select');
        });
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ç»‘å®šå‰¯æ¨¡å‹æ‹‰å–æŒ‰é’®
        document.getElementById('fetch-secondary-models-btn').addEventListener('click', () => {
            fetchModels('secondary-proxy-url', 'secondary-api-key', 'secondary-model-select');
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
                    document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('åˆ›å»ºä¸–ç•Œä¹¦', 'è¯·è¾“å…¥ä¹¦å'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
// â–¼â–¼â–¼ ã€å…¨æ–° | iOS å…¼å®¹ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ save-world-book-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('save-world-book-btn').addEventListener('click', async () => {
    if (!editingWorldBookId) return;
    const book = state.worldBooks.find(wb => wb.id === editingWorldBookId);
    if (!book) return;

    // (è¿™éƒ¨åˆ†ä¿å­˜æ•°æ®çš„é€»è¾‘ä¿æŒä¸å˜)
    const newName = document.getElementById('world-book-name-input').value.trim();
    if (!newName) { alert('ä¹¦åä¸èƒ½ä¸ºç©ºï¼'); return; }
    book.name = newName;
    const categoryId = document.getElementById('world-book-category-select').value;
    book.categoryId = categoryId ? parseInt(categoryId) : null;

    const entriesContainer = document.getElementById('world-book-entries-container');
    const entryBlocks = entriesContainer.querySelectorAll('.message-editor-block');
    const newEntries = [];

    entryBlocks.forEach(block => {
        const keysInput = block.querySelector('.entry-keys-input').value.trim();
        const content = block.querySelector('.entry-content-textarea').value.trim();
        const isEnabled = block.querySelector('.entry-enabled-switch').checked;
        if (content) {
            newEntries.push({
                comment: block.querySelector('.entry-comment-input').value.trim(),
                keys: keysInput ? keysInput.split(',').map(k => k.trim()).filter(k => k) : [],
                content: content,
                enabled: isEnabled
            });
        }
    });
    book.content = newEntries;

    // 1. å…ˆå°†æ‰€æœ‰æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“
    await db.worldBooks.put(book);
    document.getElementById('world-book-editor-title').textContent = newName;
    editingWorldBookId = null;

    // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘å…ˆåˆ‡æ¢åˆ°ç›®æ ‡å±å¹•
    showScreen('world-book-screen');
    
    // 3. ã€æ ¸å¿ƒä¿®å¤ã€‘ç„¶åå†å¼‚æ­¥åœ°æ¸²æŸ“å†…å®¹
    await renderWorldBookScreen();
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ chat-messages äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('chat-messages').addEventListener('click', async (e) => {
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº† "æŸ¥çœ‹è¯¦æƒ…" æŒ‰é’®
            const detailsBtn = e.target.closest('.waimai-details-btn');
            if (detailsBtn) {
                const bubble = detailsBtn.closest('.message-bubble');
                if (bubble) {
                    const timestamp = parseInt(bubble.dataset.timestamp);
                    if (!isNaN(timestamp)) {
                        showWaimaiDetails(timestamp); // è°ƒç”¨æˆ‘ä»¬æ–°åŠ çš„å‡½æ•°
                        return; // å¤„ç†å®Œåç›´æ¥é€€å‡º
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº† "ä¸ºTaä¹°å•" æˆ– "æ®‹å¿æ‹’ç»" æŒ‰é’®
            const choiceBtn = e.target.closest('.waimai-user-actions button');
            if (choiceBtn) {
                const bubble = choiceBtn.closest('.message-bubble');
                if (bubble) {
                    const timestamp = parseInt(bubble.dataset.timestamp);
                    const choice = choiceBtn.dataset.choice;
                    if (!isNaN(timestamp) && choice) {
                        await handleWaimaiResponse(timestamp, choice);
                        return;
                    }
                }
            }
        
            // --- ä»¥ä¸‹æ˜¯æ‚¨åŸæ¥å·²æœ‰çš„æ‰€æœ‰å…¶ä»–ç‚¹å‡»äº‹ä»¶é€»è¾‘ï¼Œä¿æŒä¸å˜ ---
            const deletedPostPlaceholder = e.target.closest('.post-deleted-placeholder');
            if (deletedPostPlaceholder) {
                const postId = parseInt(deletedPostPlaceholder.dataset.postId);
                if (!isNaN(postId)) {
                    const post = await db.qzonePosts.get(postId);
                    if (post) {
                        let originalContent = '';
                        const authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'æœªçŸ¥ä½œè€…');
                        
                        if(post.type === 'shuoshuo'){
                            originalContent = post.content;
                        } else {
                            originalContent = post.publicText || '';
                            if(post.imageUrl) originalContent += `\n[å›¾ç‰‡]`;
                            if(post.hiddenContent) originalContent += `\n[æ–‡å­—å›¾å†…å®¹: ${post.hiddenContent}]`;
                        }
                        
                        showCustomAlert(
                            `æ¥è‡ª ${authorName} çš„å·²åˆ é™¤åŠ¨æ€`, 
                            originalContent.replace(/\n/g, '<br>')
                        );
                    } else {
                        showCustomAlert('æç¤º', 'è¿™æ¡åŠ¨æ€çš„åŸå§‹æ•°æ®å·²è¢«å½»åº•æ¸…é™¤ã€‚');
                    }
                }
                return;
            }
        
            const aiImage = e.target.closest('.ai-generated-image');
            if (aiImage) {
                const description = aiImage.dataset.description;
                if (description) showCustomAlert('ç…§ç‰‡æè¿°', description);
                return;
            }
        
            const quoteBlock = e.target.closest('.quoted-message');
            if (quoteBlock && quoteBlock.dataset.originalTimestamp) {
                const originalTimestamp = parseInt(quoteBlock.dataset.originalTimestamp);
                if (!isNaN(originalTimestamp)) {
                    scrollToOriginalMessage(originalTimestamp);
                }
            }
            
            const giftCard = e.target.closest('.gift-card');
            if (giftCard) {
                const bubble = giftCard.closest('.message-bubble');
                if (bubble) {
                    showGiftReceipt(parseInt(bubble.dataset.timestamp));
                }
            }
        
            const packetCard = e.target.closest('.red-packet-card');
            if (packetCard) {
                const messageBubble = packetCard.closest('.message-bubble');
                if (messageBubble && messageBubble.dataset.timestamp) {
                    const timestamp = parseInt(messageBubble.dataset.timestamp);
                    handlePacketClick(timestamp);
                }
            }
            
            const pollCard = e.target.closest('.poll-card');
            if (pollCard) {
                const timestamp = parseInt(pollCard.dataset.pollTimestamp);
                if (isNaN(timestamp)) return;
                
                const optionItem = e.target.closest('.poll-option-item');
                if (optionItem && !pollCard.classList.contains('closed')) {
                    handleUserVote(timestamp, optionItem.dataset.option);
                    return;
                }
                
                const actionBtn = e.target.closest('.poll-action-btn');
                if (actionBtn) {
                    if (pollCard.classList.contains('closed')) {
                        showPollResults(timestamp);
                    } else {
                        endPoll(timestamp);
                    }
                    return;
                }
        
                if (pollCard.classList.contains('closed')) {
                    showPollResults(timestamp);
                }
            }
        
            const voiceBody = e.target.closest('.voice-message-body');
            if (voiceBody) {
                const bubble = voiceBody.closest('.message-bubble');
                if (!bubble) return;
                
                const spinner = voiceBody.querySelector('.loading-spinner');
                const transcriptEl = bubble.querySelector('.voice-transcript');
        
                if (bubble.dataset.state === 'loading') {
                    return;
                }
        
                if (bubble.dataset.state === 'expanded') {
                    transcriptEl.style.display = 'none';
                    bubble.dataset.state = 'collapsed';
                } 
                else {
                    bubble.dataset.state = 'loading';
                    spinner.style.display = 'block';
        
                    setTimeout(() => {
                        if (document.body.contains(bubble)) {
                            const voiceText = bubble.dataset.voiceText || '(æ— æ³•è¯†åˆ«)';
                            transcriptEl.textContent = voiceText;
                            
                            spinner.style.display = 'none';
                            transcriptEl.style.display = 'block';
                            bubble.dataset.state = 'expanded';
                        }
                    }, 1500);
                }
            }
        
            const placeholder = e.target.closest('.recalled-message-placeholder');
            if (placeholder) {
                const chat = state.chats[state.activeChatId];
                const wrapper = placeholder.closest('.message-wrapper');
                if (chat && wrapper) {
                    const timestamp = parseInt(wrapper.dataset.timestamp);
                    const recalledMsg = chat.history.find(m => m.timestamp === timestamp);
                    
                    if (recalledMsg && recalledMsg.recalledData) {
                        let originalContentText = '';
                        const recalled = recalledMsg.recalledData;
                        
                        if (recalled.originalType === 'text') {
                            originalContentText = `åŸæ–‡: "${recalled.originalContent}"`;
                        } else {
                            originalContentText = `æ’¤å›äº†ä¸€æ¡[${recalled.originalType}]ç±»å‹çš„æ¶ˆæ¯`;
                        }
                        showCustomAlert('å·²æ’¤å›çš„æ¶ˆæ¯', originalContentText);
                    }
                }
            }
        
            const linkCard = e.target.closest('.link-share-card');
            if (linkCard && linkCard.closest('.message-bubble.is-link-share')) {
                const timestamp = parseInt(linkCard.dataset.timestamp);
                openSharedHistoryViewer(timestamp);
            }
        
            const bubble = e.target.closest('.message-bubble');
            if (bubble && bubble.classList.contains('ai') && bubble.classList.contains('is-transfer') && bubble.dataset.status === 'pending') {
                const timestamp = parseInt(bubble.dataset.timestamp);
                if (!isNaN(timestamp)) {
                    showTransferActionModal(timestamp);
                }
            }
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
                    
                    const chatSettingsModal = document.getElementById('chat-settings-modal');
                    const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
                    const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ updateWorldBookSelectionDisplay å‡½æ•° â–¼â–¼â–¼
        function updateWorldBookSelectionDisplay() {
            const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked');
            const displayText = document.querySelector('.selected-options-text');
            
            if (checkedBoxes.length === 0) {
                displayText.textContent = '-- ç‚¹å‡»é€‰æ‹© --';
            } else if (checkedBoxes.length > 2) {
                displayText.textContent = `å·²é€‰æ‹© ${checkedBoxes.length} æœ¬ä¸–ç•Œä¹¦`;
            } else {
                const displayItems = Array.from(checkedBoxes).map(cb => {
                    return cb.parentElement.textContent.trim();
                });
                displayText.textContent = displayItems.join(', ');
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²   
                    
                    worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
                    document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
                    window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ª V3.0 æœ€ç»ˆä¿®å¤ç‰ˆã€‘æ›¿æ¢æ—§çš„ chat-settings-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('chat-settings-btn').addEventListener('click', async () => {
            loadThemePresetsDropdown(); // <-- æ–°å¢è¿™ä¸€è¡Œ
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            const isGroup = chat.isGroup;
        
            // --- ï¼ˆè¿™éƒ¨åˆ†ä¸ä¹‹å‰ç›¸åŒï¼Œä¿æŒä¸å˜ï¼‰ ---
            const switchGreetingGroup = document.getElementById('switch-greeting-group');
            if (!isGroup && chat.settings.alternateGreetings && chat.settings.alternateGreetings.length > 0) {
                switchGreetingGroup.style.display = 'block';
            } else {
                switchGreetingGroup.style.display = 'none';
            }
            
            document.getElementById('chat-name-group').style.display = 'block';
            document.getElementById('my-persona-group').style.display = 'block';
            document.getElementById('my-avatar-group').style.display = 'block';
            document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
            document.getElementById('my-nickname-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
            document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
            document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
            document.getElementById('ai-original-name-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('offline-mode-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('ai-cooldown-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('group-cooldown-group').style.display = isGroup ? 'block' : 'none';
            document.getElementById('chat-name-input').value = chat.name;
            document.getElementById('my-persona').value = chat.settings.myPersona;
            document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
            document.getElementById('max-memory').value = chat.settings.maxMemory;
            const bgPreview = document.getElementById('bg-preview');
            const removeBgBtn = document.getElementById('remove-bg-btn');
            if (chat.settings.background) {
                bgPreview.src = chat.settings.background;
                bgPreview.style.display = 'block';
                removeBgBtn.style.display = 'inline-block';
            } else {
                bgPreview.style.display = 'none';
                removeBgBtn.style.display = 'none';
            }
            document.getElementById('lyrics-position-group').style.display = isGroup ? 'none' : 'block';
// ã€æ ¸å¿ƒæ–°å¢ã€‘æ ¹æ®æ˜¯å¦ä¸ºç¾¤èŠï¼Œæ˜¾ç¤ºæˆ–éšè—å¯¹åº”çš„åå°æ´»åŠ¨å¼€å…³
document.getElementById('single-char-background-activity-group').style.display = isGroup ? 'none' : 'block';
document.getElementById('group-background-activity-group').style.display = isGroup ? 'block' : 'none';

// (åç»­çš„èµ‹å€¼é€»è¾‘ï¼Œè¯·ç”¨ä¸‹é¢è¿™æ•´å—æ–°ä»£ç å®Œæ•´æ›¿æ¢)
// ã€æ–°å¢ä»£ç ã€‘è¯»å–æ—¶é—´æ„ŸçŸ¥è®¾ç½®
document.getElementById('time-perception-toggle').checked = chat.settings.enableTimePerception;
if (isGroup) {
    // ã€æ ¸å¿ƒæ–°å¢ã€‘è¯»å–å¹¶è®¾ç½®ç¾¤èŠå¼€å…³çš„çŠ¶æ€
    document.getElementById('group-background-activity-switch').checked = chat.settings.enableBackgroundActivity;
    document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
    document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
    document.getElementById('group-action-cooldown-input').value = chat.settings.actionCooldownMinutes || 10;

    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨ç¾¤èŠè®¾ç½®ä¸­ï¼Œéšè—å•èŠçš„åå°æ´»åŠ¨å¼€å…³
    document.getElementById('single-char-background-activity-group').style.display = 'none';
    renderGroupMemberSettings(chat.members);
} else {
    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨å•èŠè®¾ç½®ä¸­ï¼Œæ˜¾ç¤ºå¹¶è®¾ç½®å¼€å…³çš„å½“å‰çŠ¶æ€
    document.getElementById('single-char-background-activity-group').style.display = 'block';
    document.getElementById('char-background-activity-switch').checked = chat.settings.enableBackgroundActivity;

    // (å…¶ä»–å•èŠè®¾ç½®çš„è¯»å–é€»è¾‘ä¿æŒä¸å˜)
    const offlineModeToggle = document.getElementById('offline-mode-toggle');
    const offlineModeOptions = document.getElementById('offline-mode-options');
    const offlineMinInput = document.getElementById('offline-min-length-input');
    const offlineMaxInput = document.getElementById('offline-max-length-input');
    offlineModeToggle.checked = chat.settings.isOfflineMode || false;
    offlineModeOptions.style.display = offlineModeToggle.checked ? 'block' : 'none';
    offlineMinInput.value = chat.settings.offlineMinLength || 100;
    offlineMaxInput.value = chat.settings.offlineMaxLength || 300;
await renderOfflinePresetSelector(chat);
    document.getElementById('ai-original-name-input').value = chat.originalName;
    document.getElementById('ai-persona').value = chat.settings.aiPersona;
    document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
    document.getElementById('my-nickname-input').value = chat.settings.myNickname || 'æˆ‘';
    document.getElementById('ai-action-cooldown-input').value = chat.settings.actionCooldownMinutes || 10;
    const select = document.getElementById('assign-group-select');
    select.innerHTML = '<option value="">æœªåˆ†ç»„</option>';
    const groups = await db.qzoneGroups.toArray();
    groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = group.name;
        if (chat.groupId === group.id) option.selected = true;
        select.appendChild(option);
    });
    const lyricsPos = chat.settings.lyricsPosition || { vertical: 'top', horizontal: 'center', offset: 10 };
    document.getElementById('lyrics-vertical-pos').value = lyricsPos.vertical;
    document.getElementById('lyrics-horizontal-pos').value = lyricsPos.horizontal;
    document.getElementById('lyrics-offset-input').value = lyricsPos.offset;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            
            // --- ã€ã€ã€æ ¸å¿ƒä¿®å¤ä»è¿™é‡Œå¼€å§‹ã€‘ã€‘ã€‘ ---
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
            worldBookCheckboxesContainer.innerHTML = ''; // æ¸…ç©ºæ—§åˆ—è¡¨
        
            const [allCategories, allBooks] = await Promise.all([
                db.worldBookCategories.toArray(),
                db.worldBooks.toArray()
            ]);
        
            const linkedBookIds = new Set(chat.settings.linkedWorldBookIds || []);
        
            if (allBooks.length === 0) {
                worldBookCheckboxesContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a;">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ä¸–ç•Œä¹¦</p>';
            } else {
                // 1. å…ˆæŒ‰åˆ†ç±»æ¸²æŸ“ä¹¦ç±
                allCategories.forEach(cat => {
                    const booksInCategory = allBooks.filter(book => book.categoryId === cat.id);
                    if (booksInCategory.length > 0) {
                        const categoryHeader = document.createElement('h4');
                        categoryHeader.textContent = cat.name; // åˆ†ç±»åä½œä¸ºæ ‡é¢˜
                        categoryHeader.style.cssText = 'margin: 10px 0 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 3px;';
                        worldBookCheckboxesContainer.appendChild(categoryHeader);
        
                        booksInCategory.forEach(book => {
                            const isChecked = linkedBookIds.has(book.id);
                            const label = document.createElement('label');
                            // ç»Ÿä¸€ä½¿ç”¨ book_ å‰ç¼€
                            label.innerHTML = `<input type="checkbox" value="book_${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
                            worldBookCheckboxesContainer.appendChild(label);
                        });
                    }
                });
        
                // 2. æ¸²æŸ“æœªåˆ†ç±»çš„ä¹¦ç±
                const uncategorizedBooks = allBooks.filter(book => !book.categoryId);
                if (uncategorizedBooks.length > 0) {
                    const bookHeader = document.createElement('h4');
                    bookHeader.textContent = 'æœªåˆ†ç±»';
                    bookHeader.style.cssText = 'margin: 15px 0 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 3px;';
                    worldBookCheckboxesContainer.appendChild(bookHeader);
        
                    uncategorizedBooks.forEach(book => {
                        const isChecked = linkedBookIds.has(book.id);
                        const label = document.createElement('label');
                        label.innerHTML = `<input type="checkbox" value="book_${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
                        worldBookCheckboxesContainer.appendChild(label);
                    });
                }
            }
            // --- ã€ã€ã€æ ¸å¿ƒä¿®å¤åˆ°è¿™é‡Œç»“æŸã€‘ã€‘ã€‘ ---
        
            updateWorldBookSelectionDisplay();

            const linkMemoryToggle = document.getElementById('link-memory-toggle'); const linkedMemorySelection = document.getElementById('linked-memory-selection'); const linkedChatsContainer = document.getElementById('linked-chats-checkboxes-container'); const linkedMemoryIds = chat.settings.linkedMemoryChatIds || []; linkMemoryToggle.checked = linkedMemoryIds.length > 0; linkedMemorySelection.style.display = linkMemoryToggle.checked ? 'block' : 'none'; linkedChatsContainer.innerHTML = ''; Object.values(state.chats).forEach(c => { if (c.id === chat.id) return; const isChecked = linkedMemoryIds.includes(c.id); const prefix = c.isGroup ? '[ç¾¤èŠ]' : '[ç§èŠ]'; const label = document.createElement('label'); label.innerHTML = `<input type="checkbox" value="${c.id}" ${isChecked ? 'checked' : ''}> ${prefix} ${c.name}`; linkedChatsContainer.appendChild(label); }); function updateLinkedMemorySelectionDisplay() { const checkedBoxes = linkedChatsContainer.querySelectorAll('input:checked'); const displayText = linkedMemorySelection.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- ç‚¹å‡»é€‰æ‹© --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `å·²é€‰æ‹© ${checkedBoxes.length} é¡¹`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } } updateLinkedMemorySelectionDisplay(); linkMemoryToggle.addEventListener('change', () => { linkedMemorySelection.style.display = linkMemoryToggle.checked ? 'block' : 'none'; }); const linkedMemorySelectBox = linkedMemorySelection.querySelector('.select-box'); const newLinkedMemorySelectBox = linkedMemorySelectBox.cloneNode(true); linkedMemorySelectBox.parentNode.replaceChild(newLinkedMemorySelectBox, linkedMemorySelectBox); newLinkedMemorySelectBox.addEventListener('click', (e) => { e.stopPropagation(); linkedChatsContainer.classList.toggle('visible'); newLinkedMemorySelectBox.classList.toggle('expanded'); }); linkedChatsContainer.addEventListener('change', updateLinkedMemorySelectionDisplay);
            const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`); if (themeRadio) themeRadio.checked = true;
            const fontSizeSlider = document.getElementById('font-size-slider'); fontSizeSlider.value = chat.settings.fontSize || 13; document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
            const customCssInput = document.getElementById('custom-css-input'); customCssInput.value = chat.settings.customCss || '';
            updateSettingsPreview();
            document.getElementById('auto-memory-toggle').checked = chat.settings.enableAutoMemory || false;
            document.getElementById('auto-memory-interval').value = chat.settings.autoMemoryInterval || 20;
            showScreen('chat-settings-screen');
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
                    
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderGroupMemberSettings å‡½æ•° â–¼â–¼â–¼
        function renderGroupMemberSettings(members) { 
            const container = document.getElementById('group-members-settings'); 
            container.innerHTML = ''; 
            members.forEach(member => { 
                const div = document.createElement('div'); 
                div.className = 'member-editor'; 
                div.dataset.memberId = member.id; 
                
                // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯ã€æ ¸å¿ƒä¿®å¤ â‘ ã€‘â˜…â˜…â˜…â˜…â˜…
                // ä¼˜å…ˆä½¿ç”¨æˆå‘˜è‡ªå·±ç‹¬ç«‹çš„å¤´åƒ(member.avatar)ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å°è¯•å»å•èŠé…ç½®é‡Œæ‰¾ï¼Œ
                // å¦‚æœè¿˜æ²¡æœ‰ï¼Œæœ€åæ‰ç”¨é»˜è®¤å¤´åƒã€‚è¿™å¥—é€»è¾‘èƒ½å®Œç¾å…¼å®¹æ‰€æœ‰ç±»å‹çš„æˆå‘˜ã€‚
                const memberAvatar = member.avatar || (state.chats[member.id] ? state.chats[member.id].settings.aiAvatar : defaultGroupMemberAvatar);
        
                div.innerHTML = `<img src="${memberAvatar}" alt="${member.groupNickname}"><div class="member-name">${member.groupNickname}</div>`;
                div.addEventListener('click', () => openMemberEditor(member.id)); 
                container.appendChild(div); 
            }); 
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ openMemberEditor å‡½æ•° â–¼â–¼â–¼
        function openMemberEditor(memberId) { 
            editingMemberId = memberId; 
            const chat = state.chats[state.activeChatId]; 
            const member = chat.members.find(m => m.id === memberId); 
            if (!member) return; // å®‰å…¨æ£€æŸ¥
        
            document.getElementById('member-name-input').value = member.groupNickname; 
            document.getElementById('member-persona-input').value = member.persona; 
            
            // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯ã€æ ¸å¿ƒä¿®å¤ â‘¡ã€‘â˜…â˜…â˜…â˜…â˜…
            // ä½¿ç”¨ä¸ä¸Šé¢å®Œå…¨ç›¸åŒçš„é€»è¾‘æ¥è·å–å¹¶æ˜¾ç¤ºæ­£ç¡®çš„å½“å‰å¤´åƒã€‚
            const memberAvatar = member.avatar || (state.chats[member.id] ? state.chats[member.id].settings.aiAvatar : defaultGroupMemberAvatar);
            document.getElementById('member-avatar-preview').src = memberAvatar;
        
            document.getElementById('member-settings-modal').classList.add('visible'); 
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
                    document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
                    // â–¼â–¼â–¼ å°†å…¶ã€å®Œæ•´æ›¿æ¢ä¸ºã€‘ä¸‹é¢è¿™æ®µä¿®æ­£åçš„ä»£ç  â–¼â–¼â–¼
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ 'save-member-settings-btn' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('save-member-settings-btn').addEventListener('click', async () => {
            if (!editingMemberId) return; 
            const chat = state.chats[state.activeChatId]; 
            const member = chat.members.find(m => m.id === editingMemberId); 
            if (!member) return;
        
            const newNickname = document.getElementById('member-name-input').value.trim();
            if (!newNickname) {
                alert("ç¾¤æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼");
                return;
            }
            member.groupNickname = newNickname; 
            member.persona = document.getElementById('member-persona-input').value; 
            
            const newAvatarUrl = document.getElementById('member-avatar-preview').src;
        
            // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯ã€æ ¸å¿ƒä¿®å¤ã€‘ â˜…â˜…â˜…â˜…â˜…
            // æ— è®ºæˆå‘˜æ˜¯â€œçœŸè§’è‰²â€è¿˜æ˜¯â€œçº¯NPCâ€ï¼Œéƒ½ã€å¿…é¡»ã€‘å°†æ–°å¤´åƒURLç›´æ¥ä¿å­˜åœ¨ç¾¤èŠçš„æˆå‘˜ä¿¡æ¯é‡Œã€‚
            member.avatar = newAvatarUrl;
        
            // åŒæ—¶ï¼Œå¦‚æœè¿™ä¸ªæˆå‘˜æ˜¯ä¸€ä¸ªâ€œçœŸè§’è‰²â€ï¼Œæˆ‘ä»¬ä¾ç„¶æ›´æ–°ä»–çš„ä¸»é…ç½®ï¼Œä¿æŒæ•°æ®åŒæ­¥ã€‚
            const characterProfile = state.chats[member.id];
            if (characterProfile) {
                characterProfile.settings.aiAvatar = newAvatarUrl;
                await db.chats.put(characterProfile);
            }
            
            // å°†åŒ…å«æœ€æ–°æˆå‘˜ä¿¡æ¯çš„ã€æ•´ä¸ªç¾¤èŠå¯¹è±¡ã€‘å­˜å›æ•°æ®åº“ï¼Œè®©NPCçš„å¤´åƒå¾—ä»¥æ°¸ä¹…ä¿å­˜ã€‚
            await db.chats.put(chat);
            
            // åˆ·æ–°UIå¹¶å…³é—­å¼¹çª—
            renderGroupMemberSettings(chat.members); 
            document.getElementById('member-settings-modal').classList.remove('visible'); 
            editingMemberId = null;
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
                    document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
                   
        
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ save-chat-settings-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            
            // --- ï¼ˆè¿™éƒ¨åˆ†ä¸ä¹‹å‰ç›¸åŒï¼Œä¿æŒä¸å˜ï¼‰ ---
            const newName = document.getElementById('chat-name-input').value.trim();
            if (!newName) return alert('å¤‡æ³¨å/ç¾¤åä¸èƒ½ä¸ºç©ºï¼');
            if (!chat.isGroup && newName !== chat.name) {
                if (!chat.nameHistory) chat.nameHistory = [];
                if (!chat.nameHistory.includes(chat.name)) chat.nameHistory.push(chat.name);
            }
            chat.name = newName;
            const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
            chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';
            chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
            chat.settings.customCss = document.getElementById('custom-css-input').value.trim();
// ã€æ–°å¢ä»£ç ã€‘ä¿å­˜æ—¶é—´æ„ŸçŸ¥è®¾ç½®
chat.settings.enableTimePerception = document.getElementById('time-perception-toggle').checked;
            chat.settings.myPersona = document.getElementById('my-persona').value;
            chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
        
            // --- ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ä»è¿™é‡Œå¼€å§‹ã€‘ã€‘ã€‘ ---
            const checkedBookItems = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked');
            const newLinkedBookIds = [];
        
            checkedBookItems.forEach(cb => {
                const value = cb.value;
                // æˆ‘ä»¬åªå…³å¿ƒä¹¦ç±çš„ID
                if (value.startsWith('book_')) {
                    newLinkedBookIds.push(value.replace('book_', ''));
                }
            });
            
            // åªä¿å­˜å•æœ¬ä¹¦çš„ID
            chat.settings.linkedWorldBookIds = newLinkedBookIds;
            // ä¸å†éœ€è¦ä¿å­˜åˆ†ç±»IDï¼Œå°†å…¶ä»è®¾ç½®ä¸­ç§»é™¤ä»¥ä¿æŒæ•°æ®å¹²å‡€
            delete chat.settings.linkedWorldBookCategoryIds; 
            // --- ã€ã€ã€æ ¸å¿ƒä¿®æ”¹åˆ°è¿™é‡Œç»“æŸã€‘ã€‘ã€‘ ---
        
// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ if/else é€»è¾‘ â–¼â–¼â–¼
if (chat.isGroup) {
    // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¿å­˜ç¾¤èŠçš„åå°æ´»åŠ¨å¼€å…³çŠ¶æ€
    chat.settings.enableBackgroundActivity = document.getElementById('group-background-activity-switch').checked;
    chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
    chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
    chat.settings.actionCooldownMinutes = parseInt(document.getElementById('group-action-cooldown-input').value) || 10;
} else {
    // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¿å­˜å•ä¸ªè§’è‰²çš„åå°æ´»åŠ¨å¼€å…³çŠ¶æ€
    chat.settings.enableBackgroundActivity = document.getElementById('char-background-activity-switch').checked;

    // (å…¶ä»–å•èŠè®¾ç½®çš„ä¿å­˜é€»è¾‘ä¿æŒä¸å˜)
    chat.settings.isOfflineMode = document.getElementById('offline-mode-toggle').checked;
    chat.settings.offlineMinLength = parseInt(document.getElementById('offline-min-length-input').value) || 100;
    chat.settings.offlineMaxLength = parseInt(document.getElementById('offline-max-length-input').value) || 300;
    chat.settings.offlinePresetId = document.getElementById('offline-preset-select').value || null;
    const newOriginalName = document.getElementById('ai-original-name-input').value.trim();
    if (!newOriginalName) return alert('å¯¹æ–¹æœ¬åä¸èƒ½ä¸ºç©ºï¼');
    chat.originalName = newOriginalName;
    chat.settings.aiPersona = document.getElementById('ai-persona').value;
    chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
    chat.settings.myNickname = document.getElementById('my-nickname-input').value.trim() || 'æˆ‘';
    chat.settings.actionCooldownMinutes = parseInt(document.getElementById('ai-action-cooldown-input').value) || 10;
    chat.settings.lyricsPosition = {
        vertical: document.getElementById('lyrics-vertical-pos').value,
        horizontal: document.getElementById('lyrics-horizontal-pos').value,
        offset: parseInt(document.getElementById('lyrics-offset-input').value) || 10
    };
    const selectedGroupId = document.getElementById('assign-group-select').value;
    chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
            chat.settings.linkedMemoryCount = parseInt(document.getElementById('linked-memory-count').value) || 10;
            const linkMemoryToggleChecked = document.getElementById('link-memory-toggle').checked;
            if (linkMemoryToggleChecked) {
                const checkedChats = document.querySelectorAll('#linked-chats-checkboxes-container input:checked');
                chat.settings.linkedMemoryChatIds = Array.from(checkedChats).map(cb => cb.value);
            } else {
                chat.settings.linkedMemoryChatIds = [];
            }
            chat.settings.enableAutoMemory = document.getElementById('auto-memory-toggle').checked;
            chat.settings.autoMemoryInterval = parseInt(document.getElementById('auto-memory-interval').value) || 20;
            await db.chats.put(chat);
            if (!chat.isGroup) {
                await syncCharacterNameInGroups(chat);
                await syncCharacterAvatarInGroups(chat);
            }
            applyLyricsBarPosition(chat);
            applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
            showScreen('chat-interface-screen');
            renderChatInterface(state.activeChatId);
            renderChatList();
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€è¿™æ˜¯æœ€ç»ˆçš„å®Œæ•´åŠŸèƒ½ä»£ç ï¼Œè¯·ç”¨å®ƒæ›¿æ¢æ‰æ—§çš„ã€‘ â–¼â–¼â–¼
        
        // ä¸ºèŠå¤©è®¾ç½®é‡Œçš„â€œæ›´æ¢å¤´åƒæ¡†â€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶


// ä¸ºèŠå¤©è®¾ç½®é‡Œçš„â€œæ›´æ¢å¤´åƒæ¡†â€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
document.getElementById('chat-settings-screen').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal('chat');
    }
});
        
        // ä¸ºæˆå‘˜è®¾ç½®é‡Œçš„â€œæ›´æ¢å¤´åƒæ¡†â€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.getElementById('member-settings-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('change-frame-btn')) { 
                openFrameSelectorModal('member');
            }
        });
        
        // --- ã€æ–°å¢ã€‘ä¸ºå¤´åƒæ¡†é€‰æ‹©æ¨¡æ€æ¡†çš„æŒ‰é’®å’Œæ ‡ç­¾é¡µç»‘å®šäº‹ä»¶ ---
        const frameModal = document.getElementById('avatar-frame-modal');
        const aiFrameTab = document.getElementById('ai-frame-tab');
        const myFrameTab = document.getElementById('my-frame-tab');
        const aiFrameContent = document.getElementById('ai-frame-content');
        const myFrameContent = document.getElementById('my-frame-content');
        
        // â€œä¿å­˜â€æŒ‰é’®
        document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);
        
        // â€œå–æ¶ˆâ€æŒ‰é’®
        document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => {
            frameModal.classList.remove('visible');
            editingFrameForMember = false; // ç¡®ä¿é‡ç½®çŠ¶æ€
        });
        
        // â€œå¯¹æ–¹çš„â€ æ ‡ç­¾é¡µ
        aiFrameTab.addEventListener('click', () => {
            aiFrameTab.classList.add('active');
            myFrameTab.classList.remove('active');
            aiFrameContent.style.display = 'block';
            myFrameContent.style.display = 'none';
        });
        
        // â€œæˆ‘çš„â€ æ ‡ç­¾é¡µ
        myFrameTab.addEventListener('click', () => {
            myFrameTab.classList.add('active');
            aiFrameTab.classList.remove('active');
            myFrameContent.style.display = 'block';
            aiFrameContent.style.display = 'none';
        });
        
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
                    document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('æ¸…ç©ºèŠå¤©è®°å½•', 'æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ­¤èŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œæ— æ³•æ¢å¤ã€‚ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
                    
                    const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
                    setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
                    setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
                    setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
                    setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
                    setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
                    setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
                    document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });
        
                    const stickerPanel = document.getElementById('sticker-panel');
                    document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
                    document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
                    // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™æ•´å—ä»£ç ã€‘æ›¿æ¢æ—§çš„ add-sticker-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¸ºâ€œæ‰¹é‡â€æŒ‰é’®ç»‘å®šæ–°å‡½æ•°
        document.getElementById('add-sticker-batch-btn').addEventListener('click', openBatchStickerImportModal);
        
// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²æ·»åŠ åˆ†ç±»IDã€‘çš„ç‰ˆæœ¬æ›¿æ¢æ—§çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('add-sticker-url-btn').addEventListener('click', async () => {
            const url = await showCustomPrompt("æ·»åŠ è¡¨æƒ…(URL)", "è¯·è¾“å…¥è¡¨æƒ…åŒ…çš„å›¾ç‰‡URL");
            if (!url || !url.trim().startsWith('http')) {
                if (url) alert("è¯·è¾“å…¥æœ‰æ•ˆçš„URL (ä»¥httpå¼€å¤´)");
                return;
            }
            const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šå¼€å¿ƒã€ç–‘æƒ‘)");
            if (name && name.trim()) {
                const newSticker = { 
                    id: 'sticker_' + Date.now(), 
                    url: url.trim(), 
                    name: name.trim(),
                    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†è¡¨æƒ…å½’å…¥å½“å‰åˆ†ç±»
                    categoryId: (activeStickerCategoryId !== 'all' && activeStickerCategoryId !== 'uncategorized') ? activeStickerCategoryId : null
                };
                await db.userStickers.add(newSticker);
                state.userStickers.push(newSticker);
                renderStickerPanel();
            } else if (name !== null) {
                alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼");
            }
        });

        
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
                    document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
                    document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { 
            const file = event.target.files[0]; 
            if (!file) return; 
            const reader = new FileReader(); 
            reader.readAsDataURL(file); 
            reader.onload = async () => { 
                const base64Url = reader.result; 
                const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šå¥½è€¶ã€ç–‘æƒ‘)"); 
                if (name && name.trim()) { 
                    const newSticker = { 
                        id: 'sticker_' + Date.now(), 
                        url: base64Url, 
                        name: name.trim(),
                        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†è¡¨æƒ…å½’å…¥å½“å‰åˆ†ç±»
                        categoryId: (activeStickerCategoryId !== 'all' && activeStickerCategoryId !== 'uncategorized') ? activeStickerCategoryId : null
                    }; 
                    await db.userStickers.add(newSticker); 
                    state.userStickers.push(newSticker); 
                    renderStickerPanel(); 
                } else if (name !== null) alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼"); 
            }; 
            event.target.value = null; 
        });
        
                    document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
                    document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
                    document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("å‘é€è¯­éŸ³", "è¯·è¾“å…¥ä½ æƒ³è¯´çš„å†…å®¹ï¼š"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
                    document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("å‘é€ç…§ç‰‡", "è¯·ç”¨æ–‡å­—æè¿°æ‚¨è¦å‘é€çš„ç…§ç‰‡ï¼š"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        const waimaiModal = document.getElementById('waimai-request-modal');
        document.getElementById('send-waimai-request-btn').addEventListener('click', () => {
            waimaiModal.classList.add('visible');
        });
        
        document.getElementById('waimai-cancel-btn').addEventListener('click', () => {
            waimaiModal.classList.remove('visible');
        });
        
        document.getElementById('waimai-confirm-btn').addEventListener('click', async () => {
            if (!state.activeChatId) return;
            
            const productInfoInput = document.getElementById('waimai-product-info');
            const amountInput = document.getElementById('waimai-amount');
            
            const productInfo = productInfoInput.value.trim();
            const amount = parseFloat(amountInput.value);
        
            if (!productInfo) {
                alert('è¯·è¾“å…¥å•†å“ä¿¡æ¯ï¼');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»£ä»˜é‡‘é¢ï¼');
                return;
            }
        
            const chat = state.chats[state.activeChatId];
            const now = Date.now();
        
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œè·å–ç”¨æˆ·è‡ªå·±çš„æ˜µç§°
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
            
            const msg = {
                role: 'user',
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘å°†è·å–åˆ°çš„æ˜µç§°ï¼Œä½œä¸º senderName æ·»åŠ åˆ°æ¶ˆæ¯å¯¹è±¡ä¸­
                senderName: myNickname, 
                type: 'waimai_request',
                productInfo: productInfo,
                amount: amount,
                status: 'pending',
                countdownEndTime: now + 15 * 60 * 1000,
                timestamp: now
            };
        
            chat.history.push(msg);
            await db.chats.put(chat);
            appendMessage(msg, chat);
            renderChatList();
        
            productInfoInput.value = '';
            amountInput.value = '';
            waimaiModal.classList.remove('visible');
        });         
                    document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
                    document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
                    document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
                    document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
                    document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
                    document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
                    document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
                    document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);
                    
                    document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);
        
        // â–¼â–¼â–¼ ã€è¿™æ˜¯æœ€ç»ˆçš„å®Œæ•´åŠŸèƒ½ä»£ç ï¼Œè¯·ç”¨å®ƒæ›¿æ¢æ‰æ—§çš„ã€‘ â–¼â–¼â–¼

        // 1. ä¸ºæ–°çš„â€œåˆ é™¤(é€šçŸ¥AI)â€æŒ‰é’®ç»‘å®šäº‹ä»¶ (é€»è¾‘ä¸æ—§ç‰ˆåˆ é™¤å®Œå…¨ç›¸åŒ)
        document.getElementById('selection-soft-delete-btn').addEventListener('click', async () => {
            if (selectedMessages.size === 0) return;
            const confirmed = await showCustomConfirm('åˆ é™¤æ¶ˆæ¯', `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedMessages.size} æ¡æ¶ˆæ¯å—ï¼Ÿè¿™ä¼šé€šçŸ¥AIè¿™äº›æ¶ˆæ¯å·²è¢«åˆ é™¤ã€‚`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                let deletedPollsInfo = [];
                for (const timestamp of selectedMessages) {
                    const msg = chat.history.find(m => m.timestamp === timestamp);
                    if (msg && msg.type === 'poll') {
                        deletedPollsInfo.push(`å…³äºâ€œ${msg.question}â€çš„æŠ•ç¥¨(æ—¶é—´æˆ³: ${msg.timestamp})`);
                    }
                }
                chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
                let forgetReason = "ä¸€äº›ä¹‹å‰çš„æ¶ˆæ¯å·²è¢«ç”¨æˆ·åˆ é™¤ã€‚";
                if (deletedPollsInfo.length > 0) {
                    forgetReason += ` å…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹æŠ•ç¥¨ï¼š${deletedPollsInfo.join('ï¼›')}ã€‚`;
                }
                forgetReason += " ä½ åº”è¯¥åƒå®ƒä»¬ä»æœªå­˜åœ¨è¿‡ä¸€æ ·ç»§ç»­å¯¹è¯ï¼Œå¹¶ç›¸åº”åœ°è°ƒæ•´ä½ çš„è®°å¿†å’Œè¡Œä¸ºï¼Œä¸è¦å†æåŠè¿™äº›è¢«åˆ é™¤çš„å†…å®¹ã€‚";
                const forgetInstruction = {
                    role: 'system',
                    content: `[ç³»ç»Ÿæç¤ºï¼š${forgetReason}]`,
                    timestamp: Date.now(),
                    isHidden: true
                };
                chat.history.push(forgetInstruction);
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
                renderChatList();
            }
        });

        // 2. ä¸ºæ–°å¢çš„â€œå½»åº•åˆ é™¤â€æŒ‰é’®ç»‘å®šå…¨æ–°çš„ã€çœŸæ­£çš„åˆ é™¤é€»è¾‘
        document.getElementById('selection-erase-btn').addEventListener('click', async () => {
            if (selectedMessages.size === 0) return;
            const confirmed = await showCustomConfirm(
                'å½»åº•åˆ é™¤æ¶ˆæ¯', 
                `è¿™å°†ä»å†å²è®°å½•ä¸­ã€æ°¸ä¹…æŠ¹é™¤ã€‘è¿™ ${selectedMessages.size} æ¡æ¶ˆæ¯ï¼ŒAIå°†å®Œå…¨é—å¿˜å®ƒä»¬çš„å­˜åœ¨ã€‚ç¡®å®šå—ï¼Ÿ`, 
                { confirmButtonClass: 'btn-danger', confirmText: 'ç¡®è®¤æŠ¹é™¤' }
            );
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                
                // æ ¸å¿ƒé€»è¾‘ï¼šç›´æ¥è¿‡æ»¤æ‰è¢«é€‰ä¸­çš„æ¶ˆæ¯ï¼Œä¸æ·»åŠ ä»»ä½•ç³»ç»Ÿæç¤º
                chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
                
                // ç›´æ¥ä¿å­˜ï¼ŒAIçš„ä¸‹ä¸€æ¬¡è¯·æ±‚å°†ä¸ä¼šåŒ…å«è¿™äº›è¢«åˆ é™¤çš„æ¶ˆæ¯
                await db.chats.put(chat);
                
                // åˆ·æ–°UI
                renderChatInterface(state.activeChatId);
                renderChatList();
            }
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
                    const fontUrlInput = document.getElementById('font-url-input');
                    fontUrlInput.addEventListener('input', () => applyCustomFont(fontUrlInput.value.trim(), true));
                    document.getElementById('save-font-btn').addEventListener('click', async () => {
                        const newFontUrl = fontUrlInput.value.trim();
                        if (!newFontUrl) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å­—ä½“URLã€‚"); return; }
                        applyCustomFont(newFontUrl, false);
                        state.globalSettings.fontUrl = newFontUrl;
                        await db.globalSettings.put(state.globalSettings);
                        alert('å­—ä½“å·²ä¿å­˜å¹¶åº”ç”¨ï¼');
                    });
                    document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);
        
                    document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
                    document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
                    document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("ä¿®æ”¹æ˜µç§°", "è¯·è¾“å…¥æ–°çš„æ˜µç§°", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
                    document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
                    document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
                    document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
                    document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
        
        // â–¼â–¼â–¼ ã€ä¿®æ­£åã€‘çš„â€œè¯´è¯´â€æŒ‰é’®äº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {
            // 1. é‡ç½®å¹¶è·å–æ¨¡æ€æ¡†
            resetCreatePostModal();
            const modal = document.getElementById('create-post-modal');
            
            // 2. è®¾ç½®ä¸ºâ€œè¯´è¯´â€æ¨¡å¼
            modal.dataset.mode = 'shuoshuo';
            
            // 3. éšè—ä¸å›¾ç‰‡/æ–‡å­—å›¾ç›¸å…³çš„éƒ¨åˆ†
            modal.querySelector('.post-mode-switcher').style.display = 'none';
            modal.querySelector('#image-mode-content').style.display = 'none';
            modal.querySelector('#text-image-mode-content').style.display = 'none';
            
            // 4. ä¿®æ”¹ä¸»è¾“å…¥æ¡†çš„æç¤ºè¯­ï¼Œä½¿å…¶æ›´ç¬¦åˆâ€œè¯´è¯´â€çš„åœºæ™¯
            modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é²œäº‹...';
            
            // 5. å‡†å¤‡å¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†
            const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
            visibilityGroupsContainer.innerHTML = '';
            const groups = await db.qzoneGroups.toArray();
            if (groups.length > 0) {
                groups.forEach(group => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
                    visibilityGroupsContainer.appendChild(label);
                });
            } else {
                visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„</p>';
            }
            modal.classList.add('visible');
        });
        
        // â–¼â–¼â–¼ ã€ä¿®æ­£åã€‘çš„â€œåŠ¨æ€â€ï¼ˆå›¾ç‰‡ï¼‰æŒ‰é’®äº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('create-post-btn').addEventListener('click', async () => {
            // 1. é‡ç½®å¹¶è·å–æ¨¡æ€æ¡†
            resetCreatePostModal();
            const modal = document.getElementById('create-post-modal');
            
            // 2. è®¾ç½®ä¸ºâ€œå¤æ‚åŠ¨æ€â€æ¨¡å¼
            modal.dataset.mode = 'complex';
            
        // 3. ç¡®ä¿ä¸å›¾ç‰‡/æ–‡å­—å›¾ç›¸å…³çš„éƒ¨åˆ†æ˜¯å¯è§çš„
        modal.querySelector('.post-mode-switcher').style.display = 'flex';
        // æ˜¾å¼æ¿€æ´»â€œä¸Šä¼ å›¾ç‰‡â€æ¨¡å¼...
        modal.querySelector('#image-mode-content').classList.add('active');
        // ...åŒæ—¶ç¡®ä¿â€œæ–‡å­—å›¾â€æ¨¡å¼æ˜¯éšè—çš„
        modal.querySelector('#text-image-mode-content').classList.remove('active');
            
            // 4. æ¢å¤ä¸»è¾“å…¥æ¡†çš„é»˜è®¤æç¤ºè¯­
            modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é²œäº‹...ï¼ˆéå¿…å¡«çš„å…¬å¼€æ–‡å­—ï¼‰';
        
            // 5. å‡†å¤‡å¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆä¸â€œè¯´è¯´â€æŒ‰é’®çš„é€»è¾‘ç›¸åŒï¼‰
            const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
            visibilityGroupsContainer.innerHTML = '';
            const groups = await db.qzoneGroups.toArray();
            if (groups.length > 0) {
                groups.forEach(group => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
                    visibilityGroupsContainer.appendChild(label);
                });
            } else {
                visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„</p>';
            }
            modal.classList.add('visible');
        });
                    document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
                    document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });
        
        // --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ â†“â†“â†“ ---
        
        document.getElementById('album-photos-back-btn').addEventListener('click', () => {
            state.activeAlbumId = null;
            showScreen('album-screen');
        });
        
        document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());
        
        document.getElementById('album-photo-input').addEventListener('change', async (event) => {
            if (!state.activeAlbumId) return;
            const files = event.target.files;
            if (!files.length) return;
        
            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            
            for (const file of files) {
                const dataUrl = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                });
                await db.qzonePhotos.add({ albumId: state.activeAlbumId, url: dataUrl, createdAt: Date.now() });
            }
        
            const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
            const updateData = { photoCount };
            
            if (!album.photoCount || album.coverUrl.includes('placeholder')) {
                const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                if(firstPhoto) updateData.coverUrl = firstPhoto.url;
            }
        
            await db.qzoneAlbums.update(state.activeAlbumId, updateData);
            await renderAlbumPhotosScreen();
            await renderAlbumList();
            
            event.target.value = null;
            alert('ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼');
        });
        
        // --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---
        
        // --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ photos-grid-page ç›‘å¬å™¨ â†“â†“â†“ ---
        
        document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.photo-delete-btn');
            const photoThumb = e.target.closest('.photo-thumb');
        
            if (deleteBtn) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å›¾ç‰‡ä¸Š
                const photoId = parseInt(deleteBtn.dataset.photoId);
                const confirmed = await showCustomConfirm(
                    'åˆ é™¤ç…§ç‰‡',
                    'ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
                    { confirmButtonClass: 'btn-danger' }
                );
        
                if (confirmed) {
                    const deletedPhoto = await db.qzonePhotos.get(photoId);
                    if (!deletedPhoto) return;
                    
                    await db.qzonePhotos.delete(photoId);
        
                    const album = await db.qzoneAlbums.get(state.activeAlbumId);
                    const photoCount = (album.photoCount || 1) - 1;
                    const updateData = { photoCount };
                    
                    if (album.coverUrl === deletedPhoto.url) {
                        const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                        updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
                    }
                    
                    await db.qzoneAlbums.update(state.activeAlbumId, updateData);
                    await renderAlbumPhotosScreen();
                    await renderAlbumList();
                    alert('ç…§ç‰‡å·²åˆ é™¤ã€‚');
                }
            } 
            else if (photoThumb) {
                // è¿™å°±æ˜¯æ¢å¤çš„å›¾ç‰‡ç‚¹å‡»æ”¾å¤§åŠŸèƒ½ï¼
                openPhotoViewer(photoThumb.src);
            }
        });
        
        // æ¢å¤å›¾ç‰‡æŸ¥çœ‹å™¨çš„æ§åˆ¶äº‹ä»¶
        document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
        document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
        document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);
        
        // æ¢å¤é”®ç›˜å·¦å³ç®­å¤´å’ŒESCé”®çš„åŠŸèƒ½
        document.addEventListener('keydown', (e) => {
            if (!photoViewerState.isOpen) return; 
        
            if (e.key === 'ArrowRight') {
                showNextPhoto();
            } else if (e.key === 'ArrowLeft') {
                showPrevPhoto();
            } else if (e.key === 'Escape') {
                closePhotoViewer();
            }
        });
        
        // --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---
                 
        document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("åˆ›å»ºæ–°ç›¸å†Œ", "è¯·è¾“å…¥ç›¸å†Œåç§°"); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(`ç›¸å†Œ "${albumName}" åˆ›å»ºæˆåŠŸï¼`); } else if (albumName !== null) { alert("ç›¸å†Œåç§°ä¸èƒ½ä¸ºç©ºï¼"); } });
        
                    document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
                    document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
                    document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
                    document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("è¾“å…¥å›¾ç‰‡URL", "è¯·è¾“å…¥ç½‘ç»œå›¾ç‰‡çš„é“¾æ¥", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
                    document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
                    const imageModeBtn = document.getElementById('switch-to-image-mode');
                    const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
                    const imageModeContent = document.getElementById('image-mode-content');
                    const textImageModeContent = document.getElementById('text-image-mode-content');
                    imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
                    textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘çš„â€œå‘å¸ƒâ€æŒ‰é’®äº‹ä»¶ï¼Œå·²ä¿®å¤æƒé™æ¼æ´ â–¼â–¼â–¼
        document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
            const modal = document.getElementById('create-post-modal');
            const mode = modal.dataset.mode;
            
            // --- 1. è·å–é€šç”¨çš„å¯è§æ€§è®¾ç½® ---
            const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
            let visibleGroupIds = null;
            
            if (visibilityMode === 'include') {
                visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
            }
        
            let newPost = {};
            const basePostData = {
                timestamp: Date.now(),
                authorId: 'user',
                // ã€é‡è¦ã€‘åœ¨è¿™é‡Œå°±æŠŠæƒé™ä¿¡æ¯å­˜å¥½
                visibleGroupIds: visibleGroupIds,
            };
        
            // --- 2. æ ¹æ®æ¨¡å¼æ„å»ºä¸åŒçš„ post å¯¹è±¡ ---
            if (mode === 'shuoshuo') {
                const content = document.getElementById('post-public-text').value.trim();
                if (!content) {
                    alert('è¯´è¯´å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼');
                    return;
                }
                newPost = {
                    ...basePostData,
                    type: 'shuoshuo',
                    content: content,
                };
        
            } else { // å¤„ç† 'complex' æ¨¡å¼ (å›¾ç‰‡/æ–‡å­—å›¾)
                const publicText = document.getElementById('post-public-text').value.trim();
                const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');
        
                if (isImageModeActive) {
                    const imageUrl = document.getElementById('post-image-preview').src;
                    const imageDescription = document.getElementById('post-image-description').value.trim();
                    if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) {
                        alert('è¯·å…ˆæ·»åŠ ä¸€å¼ å›¾ç‰‡å†å‘å¸ƒåŠ¨æ€å“¦ï¼');
                        return;
                    }
                    if (!imageDescription) {
                        alert('è¯·ä¸ºä½ çš„å›¾ç‰‡æ·»åŠ ä¸€ä¸ªç®€å•çš„æè¿°ï¼ˆå¿…å¡«ï¼Œç»™AIçœ‹çš„ï¼‰ï¼');
                        return;
                    }
                    newPost = {
                        ...basePostData,
                        type: 'image_post',
                        publicText: publicText,
                        imageUrl: imageUrl,
                        imageDescription: imageDescription,
                    };
                } else { // æ–‡å­—å›¾æ¨¡å¼
                    const hiddenText = document.getElementById('post-hidden-text').value.trim();
                    if (!hiddenText) {
                        alert('è¯·è¾“å…¥æ–‡å­—å›¾æè¿°ï¼');
                        return;
                    }
                    newPost = {
                        ...basePostData,
                        type: 'text_image',
                        publicText: publicText,
                        hiddenContent: hiddenText,
                    };
                }
            }
        
            // --- 3. ä¿å­˜åˆ°æ•°æ®åº“ ---
            const newPostId = await db.qzonePosts.add(newPost);
            let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "ï¼ˆæ— æ–‡å­—å†…å®¹ï¼‰";
            postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');
        
            // --- 4. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¸¦æœ‰æƒé™æ£€æŸ¥çš„é€šçŸ¥å¾ªç¯ ---
            for (const chatId in state.chats) {
                const chat = state.chats[chatId];
                if (chat.isGroup) continue; // è·³è¿‡ç¾¤èŠ
        
                let shouldNotify = false;
                const postVisibleGroups = newPost.visibleGroupIds;
        
                // åˆ¤æ–­æ¡ä»¶1ï¼šå¦‚æœåŠ¨æ€æ˜¯å…¬å¼€çš„ (æ²¡æœ‰è®¾ç½®ä»»ä½•å¯è§åˆ†ç»„)
                if (!postVisibleGroups || postVisibleGroups.length === 0) {
                    shouldNotify = true;
                } 
                // åˆ¤æ–­æ¡ä»¶2ï¼šå¦‚æœåŠ¨æ€è®¾ç½®äº†éƒ¨åˆ†å¯è§ï¼Œå¹¶ä¸”å½“å‰è§’è‰²åœ¨å¯è§åˆ†ç»„å†…
                else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
                    shouldNotify = true;
                }
        
                // åªæœ‰æ»¡è¶³æ¡ä»¶çš„è§’è‰²æ‰ä¼šè¢«é€šçŸ¥
                if (shouldNotify) {
        // â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹æ›¿æ¢ â–¼â–¼â–¼
        const historyMessage = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšå‘å¸ƒäº†ä¸€æ¡åŠ¨æ€(ID: ${newPostId})ï¼Œå†…å®¹æ‘˜è¦æ˜¯ï¼šâ€œ${postSummary}â€ã€‚è¯·ä½ ã€ç»“åˆè‡ªå·±çš„è§’è‰²è®¾å®šã€ä¸–ç•Œè§‚å’Œä½ ä»¬çš„æœ€è¿‘èŠå¤©å†…å®¹ã€‘ï¼Œå¯¹è¿™æ¡åŠ¨æ€å‘è¡¨ä¸€æ¡è‡ªç„¶çš„è¯„è®ºã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        // â–²â–²â–² åˆ°è¿™é‡Œæ›¿æ¢ç»“æŸ â–²â–²â–²
                    chat.history.push(historyMessage);
                    await db.chats.put(chat);
                }
            }
            // --- ä¿®æ­£ç»“æŸ ---
        
            await renderQzonePosts();
            modal.classList.remove('visible');
            alert('åŠ¨æ€å‘å¸ƒæˆåŠŸï¼');
        });
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘åŒ…å«æ‰€æœ‰æ»‘åŠ¨å’Œç‚¹å‡»äº‹ä»¶çš„å®Œæ•´ä»£ç ï¼Œæ›¿æ¢æ‰æ—§çš„ postsList äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        
        const postsList = document.getElementById('qzone-posts-list');
        let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };
        
        function resetAllSwipes(exceptThisOne = null) {
            document.querySelectorAll('.qzone-post-container').forEach(container => {
                if (container !== exceptThisOne) {
                    container.querySelector('.qzone-post-item').classList.remove('swiped');
                }
            });
        }
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤æ–¹æ¡ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„ã€ä½¿ç”¨å¢é‡æ›´æ–°çš„å‡½æ•°ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handlePostClick â–¼â–¼â–¼
        /**
         * ã€å…¨æ–°ã€‘å¤„ç†åŠ¨æ€åŒºåŸŸå†…æ‰€æœ‰ç‚¹å‡»äº‹ä»¶çš„ç»Ÿä¸€å…¥å£
         */
        async function handlePostClick(e) {
            e.stopPropagation();
            const target = e.target;
        
            // --- ä¼˜å…ˆå¤„ç†è¯„è®ºåˆ é™¤æŒ‰é’®çš„ç‚¹å‡» ---
            const deleteBtn = target.closest('.comment-delete-btn');
            if (deleteBtn) {
                const postContainer = deleteBtn.closest('.qzone-post-container');
                const postId = parseInt(postContainer.dataset.postId);
                const commentIndex = parseInt(deleteBtn.dataset.commentIndex);
                if (isNaN(postId) || isNaN(commentIndex)) return;
        
                const post = qzonePostsCache.find(p => p.id === postId);
                if (!post || !post.comments || !post.comments[commentIndex]) return;
                
                const confirmed = await showCustomConfirm('åˆ é™¤è¯„è®º', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    post.comments.splice(commentIndex, 1);
                    await db.qzonePosts.update(postId, { comments: post.comments });
                    await updateSinglePostInDOM(postId); // ã€æ€§èƒ½ä¼˜åŒ–ã€‘è°ƒç”¨å¢é‡æ›´æ–°
                }
                
                return; // å¤„ç†å®Œåå¿…é¡»é€€å‡º
            }
            
            // --- æ‰€æœ‰å¼¹çª—å’ŒéDOMæ›´æ–°çš„é€»è¾‘ä¿æŒä¸å˜ ---
            const stickerBtn = target.closest('.comment-sticker-btn');
            if (stickerBtn) {
                const postContainer = stickerBtn.closest('.qzone-post-container');
                if (!postContainer) return;
                const postId = parseInt(postContainer.dataset.postId);
                if (qzoneStickerPanelState.isOpen && qzoneStickerPanelState.activePostId === postId) {
                    closeQzoneStickerPanel();
                } else {
                    openQzoneStickerPanel(postId, stickerBtn);
                }
                return; 
            }
            const commentItem = target.closest('.comment-item');
            if (commentItem) {
                const postId = parseInt(commentItem.dataset.postId);
                const commenterOriginalName = commentItem.dataset.commenterOriginalName;
                const commenterDisplayName = commentItem.dataset.commenterDisplayName;
        
                if (!commenterOriginalName || !commenterDisplayName || commenterOriginalName === state.qzoneSettings.nickname) {
                    clearQzoneReplyContext(commentItem.closest('.qzone-post-container'));
                    return;
                }
                currentQzoneReplyContext = { postId, replyToName: commenterOriginalName, replyToDisplayName: commenterDisplayName };
                const postContainer = commentItem.closest('.qzone-post-container');
                const commentInput = postContainer.querySelector('.comment-input');
                commentInput.placeholder = `å›å¤ ${commenterDisplayName}:`;
                commentInput.focus();
                return; 
            }
            if (target.classList.contains('post-actions-btn')) {
                const container = target.closest('.qzone-post-container');
                if (container && container.dataset.postId) showPostActions(parseInt(container.dataset.postId));
                return;
            }
            if (target.tagName === 'IMG' && target.dataset.hiddenText) {
                showCustomAlert("å›¾ç‰‡å†…å®¹", target.dataset.hiddenText.replace(/<br>/g, '\n'));
                return;
            }
        
            // --- ã€æ ¸å¿ƒæ€§èƒ½ä¼˜åŒ–ã€‘å¼€å§‹ï¼Œå¤„ç†æ‰€æœ‰ä¼šæ›´æ–°DOMçš„äº‹ä»¶ ---
            const postContainer = target.closest('.qzone-post-container');
            if (!postContainer) return;
            const postId = parseInt(postContainer.dataset.postId);
            if (isNaN(postId)) return;
        
            if (target.closest('.qzone-post-delete-action')) {
                const confirmed = await showCustomConfirm('åˆ é™¤åŠ¨æ€', 'ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    postContainer.style.transition = 'all 0.3s ease';
                    postContainer.style.transform = 'scale(0.8)';
                    postContainer.style.opacity = '0';
                    setTimeout(async () => {
                         await db.qzonePosts.delete(postId);
                         const notificationIdentifier = `(ID: ${postId})`;
                         for (const chatId in state.chats) {
                             const chat = state.chats[chatId];
                             const originalHistoryLength = chat.history.length;
                             chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                             if (chat.history.length < originalHistoryLength) await db.chats.put(chat);
                         }
                         await renderQzonePosts(); // åˆ é™¤éœ€è¦å…¨é‡é‡ç»˜
                         alert('åŠ¨æ€å·²åˆ é™¤ã€‚');
                    }, 300);
                }
                return;
            }
        
            const icon = target.closest('.action-icon');
            if (icon) {
                if (icon.classList.contains('repost')) { openRepostModal(postId); return; }
                if (icon.classList.contains('like')) {
                    const post = qzonePostsCache.find(p => p.id === postId);
                    if (!post) return;
                    if (!post.likes) post.likes = [];
                    const userOriginalName = state.qzoneSettings.nickname;
                    const userLikeIndex = post.likes.indexOf(userOriginalName);
                    if (userLikeIndex > -1) {
                        post.likes.splice(userLikeIndex, 1);
                    } else {
                        post.likes.push(userOriginalName);
                        icon.classList.add('animate-like');
                        icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), { once: true });
                    }
                    await db.qzonePosts.update(postId, { likes: post.likes });
                    await updateSinglePostInDOM(postId); // ã€æ€§èƒ½ä¼˜åŒ–ã€‘è°ƒç”¨å¢é‡æ›´æ–°
                }
                if (icon.classList.contains('favorite')) {
                    const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
                    if (existingFavorite) {
                        await db.favorites.delete(existingFavorite.id);
                        await showCustomAlert('æç¤º', 'å·²å–æ¶ˆæ”¶è—');
                    } else {
                        const postToSave = await db.qzonePosts.get(postId);
                        if (postToSave) {
                            await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() });
                            await showCustomAlert('æç¤º', 'æ”¶è—æˆåŠŸï¼');
                        }
                    }
                    await updateSinglePostInDOM(postId); // ã€æ€§èƒ½ä¼˜åŒ–ã€‘è°ƒç”¨å¢é‡æ›´æ–°
                }
                return;
            }
        
            const sendBtn = target.closest('.comment-send-btn');
            if (sendBtn) {
                const commentInput = postContainer.querySelector('.comment-input');
                const commentText = commentInput.value.trim();
                if (!commentText) return alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºå“¦ï¼');
                
                const post = qzonePostsCache.find(p => p.id === postId);
                if (!post) return;
        
                if (!post.comments) post.comments = [];
                
                const newComment = {
                    commenterName: state.qzoneSettings.nickname,
                    text: commentText,
                    timestamp: Date.now(),
                    replyTo: (currentQzoneReplyContext && currentQzoneReplyContext.postId === postId) ? currentQzoneReplyContext.replyToName : null
                };
                
                post.comments.push(newComment);
                await db.qzonePosts.update(postId, { comments: post.comments });
                
                let postSummary = (post.publicText || post.content || '').substring(0, 30);
                const userNickname = state.qzoneSettings.nickname;
                const notifiedAiIds = new Set();
                if (post.authorId !== 'user') notifiedAiIds.add(post.authorId);
                if (newComment.replyTo && newComment.replyTo !== userNickname) {
                    const repliedToChat = Object.values(state.chats).find(c => c.originalName === newComment.replyTo);
                    if (repliedToChat) notifiedAiIds.add(repliedToChat.id);
                }
                for (const aiId of notifiedAiIds) {
                    const chat = state.chats[aiId];
                    if (chat && !chat.isGroup) {
                        const stickerMatch = state.userStickers.find(s => s.url === commentText);
                        let notificationText = stickerMatch ? `ç”¨æˆ·'${userNickname}'åˆšåˆšåœ¨ä½ çš„åŠ¨æ€â€œ${postSummary}â€ä¸‹ï¼Œå‘é€äº†ä¸€ä¸ªè¡¨æƒ…è¯„è®ºï¼Œæ„æ€æ˜¯ï¼šâ€œ${stickerMatch.name}â€ã€‚`
                            : newComment.replyTo ? `ç”¨æˆ·'${userNickname}'åˆšåˆšåœ¨ä½ çš„åŠ¨æ€â€œ${postSummary}â€ä¸‹ï¼Œå›å¤äº†'${currentQzoneReplyContext.replyToDisplayName}'çš„è¯„è®ºï¼Œå†…å®¹æ˜¯ï¼šâ€œ${commentText}â€ã€‚`
                            : `ç”¨æˆ·'${userNickname}'åˆšåˆšè¯„è®ºäº†ä½ çš„åŠ¨æ€â€œ${postSummary}â€ï¼Œå†…å®¹æ˜¯ï¼šâ€œ${commentText}â€ã€‚`;
                        const historyMessage = { 
                            role: 'system', 
                            content: `[ç³»ç»Ÿæç¤ºï¼š${notificationText}è¯·ä½ å¯¹æ­¤ä½œå‡ºå›åº”ã€‚]`, 
                            timestamp: Date.now(), 
                            isHidden: true 
                        };
                        chat.history.push(historyMessage);
                        await db.chats.put(chat);
                    }
                }
                
                commentInput.value = '';
                clearQzoneReplyContext(postContainer); 
                await updateSinglePostInDOM(postId); // ã€æ€§èƒ½ä¼˜åŒ–ã€‘è°ƒç”¨å¢é‡æ›´æ–°
                return;
            }
        }
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        
        // â–¼â–¼â–¼ ã€æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆã€‘è¯·ç”¨è¿™ä¸€æ•´å—å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ‰€æœ‰æ—§çš„æ»‘åŠ¨å¤„ç†å‡½æ•°å’Œäº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        
        // --- 1. å…¨æ–°çš„ã€æ›´æ™ºèƒ½çš„æ»‘åŠ¨å¼€å§‹å‡½æ•° ---
        const handleSwipeStart = (e) => {
            const target = e.target;
            // æ£€æŸ¥ç‚¹å‡»ç›®æ ‡æ˜¯å¦æ˜¯äº¤äº’åŒºåŸŸï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¸å¯åŠ¨æ»‘åŠ¨
            if (target.closest('.post-footer, .post-feedback-icons, .post-actions-btn, .post-comments-container, .reposted-content-wrapper')) {
                return;
            }
            const targetContainer = e.target.closest('.qzone-post-container');
            if (!targetContainer) return;
        
            resetAllSwipes(targetContainer);
            swipeState.activeContainer = targetContainer;
            swipeState.isDragging = true;
            swipeState.isClick = true;
            swipeState.swipeDirection = null;
            swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
            swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
            swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';
        
            // ã€æ ¸å¿ƒä¼˜åŒ–ã€‘åªåœ¨æ»‘åŠ¨å¼€å§‹æ—¶ï¼Œæ‰åŠ¨æ€ç»‘å®šç§»åŠ¨å’Œç»“æŸçš„ç›‘å¬å™¨
            document.addEventListener('mousemove', handleSwipeMove);
            document.addEventListener('mouseup', handleSwipeEnd);
            document.addEventListener('touchmove', handleSwipeMove, { passive: false });
            document.addEventListener('touchend', handleSwipeEnd);
        };
        
        // --- 2. æ»‘åŠ¨ç§»åŠ¨å‡½æ•°ï¼ˆå¾®è°ƒï¼‰ ---
        const handleSwipeMove = (e) => {
            if (!swipeState.isDragging || !swipeState.activeContainer) return;
        
            const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
            const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
            const diffX = currentX - swipeState.startX;
            const diffY = currentY - swipeState.startY;
            
            if (swipeState.isClick && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) {
                swipeState.isClick = false;
            }
        
            if (!swipeState.swipeDirection) {
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    swipeState.swipeDirection = 'horizontal';
                } else {
                    swipeState.swipeDirection = 'vertical';
                }
            }
            
            if (swipeState.swipeDirection === 'horizontal') {
                e.preventDefault(); // åªåœ¨ç¡®å®šæ˜¯æ°´å¹³æ»‘åŠ¨æ—¶æ‰é˜»æ­¢é»˜è®¤è¡Œä¸º
                swipeState.currentX = currentX;
                let translation = Math.min(0, Math.max(-90, diffX)); // é™åˆ¶æ»‘åŠ¨èŒƒå›´
                swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
            }
        };
        
        // --- 3. æ»‘åŠ¨ç»“æŸå‡½æ•°ï¼ˆé‡æ„ï¼‰ ---
        const handleSwipeEnd = (e) => {
            // ã€æ ¸å¿ƒä¼˜åŒ–ã€‘æ— è®ºå¦‚ä½•ï¼Œéƒ½åœ¨æ»‘åŠ¨ç»“æŸåç§»é™¤ç›‘å¬å™¨
            document.removeEventListener('mousemove', handleSwipeMove);
            document.removeEventListener('mouseup', handleSwipeEnd);
            document.removeEventListener('touchmove', handleSwipeMove);
            document.removeEventListener('touchend', handleSwipeEnd);
        
            if (!swipeState.isDragging || !swipeState.activeContainer) return;
            
            const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
            postItem.style.transition = 'transform 0.3s ease';
        
            if (swipeState.swipeDirection === 'horizontal' && !swipeState.isClick) {
                const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
                const diffX = finalX - swipeState.startX;
                if (diffX < -40) { // æ»‘åŠ¨è¶…è¿‡40åƒç´ å°±è§¦å‘
                    postItem.classList.add('swiped');
                } else {
                    postItem.classList.remove('swiped');
                }
            }
            
            postItem.style.transform = ''; // æ¢å¤åŸä½ï¼Œè®©CSS classæ¥ç®¡
            
            // é‡ç½®çŠ¶æ€
            swipeState.isDragging = false;
            swipeState.activeContainer = null;
            swipeState.swipeDirection = null;
            swipeState.isClick = true;
        };
        
        // --- 4. åœ¨ init() å‡½æ•°ä¸­ç»‘å®šäº‹ä»¶ ---
        // postsList.addEventListener('click', handlePostClick); // è¿™è¡Œæ‚¨åº”è¯¥å·²ç»æœ‰äº†
        // postsList.addEventListener('mousedown', handleSwipeStart); // ç»‘å®šé¼ æ ‡æŒ‰ä¸‹
        // postsList.addEventListener('touchstart', handleSwipeStart, { passive: true }); // ç»‘å®šè§¦æ‘¸å¼€å§‹
        
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        
        
        // ã€æœ€ç»ˆç‰ˆã€‘åŠ¨æ€åˆ—è¡¨äº‹ä»¶ç»‘å®š
        postsList.addEventListener('click', handlePostClick);
        postsList.addEventListener('mousedown', handleSwipeStart);
        postsList.addEventListener('touchstart', handleSwipeStart, { passive: true }); // ä½¿ç”¨ passive æå‡æ»šåŠ¨æ€§èƒ½
        // --- ç»‘å®šæ‰€æœ‰ç‚¹å‡»äº‹ä»¶ ---
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºåŠ¨æ€åˆ—è¡¨æ·»åŠ â€œåŠ è½½æ›´å¤šâ€çš„äº‹ä»¶å§”æ‰˜ â–¼â–¼â–¼
        postsList.addEventListener('click', (e) => {
            // æ£€æŸ¥è¢«ç‚¹å‡»çš„æ˜¯å¦æ˜¯æˆ‘ä»¬çš„â€œåŠ è½½æ›´å¤šâ€æŒ‰é’®
            if (e.target && e.target.id === 'load-more-qzone-btn') {
                loadMoreQzonePosts();
            }
        });
        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        // ã€å…¨æ–°ã€‘ä¸ºé•¿æœŸè®°å¿†â€œç²¾ç‚¼â€æŒ‰é’®ç»‘å®šäº‹ä»¶
        document.getElementById('refine-memory-btn-header').addEventListener('click', () => {
            if(state.activeChatId) {
                summarizeExistingLongTermMemory(state.activeChatId);
            }
        });
                    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘APIé¢„è®¾åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
                    document.getElementById('api-preset-select').addEventListener('change', handlePresetSelectionChange);
                    document.getElementById('save-api-preset-btn').addEventListener('click', saveApiPreset);
                    document.getElementById('delete-api-preset-btn').addEventListener('click', deleteApiPreset);
                    // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ è¿™è¡Œä»£ç  â–¼â–¼â–¼
        document.getElementById('add-world-book-entry-btn').addEventListener('click', () => {
            const container = document.getElementById('world-book-entries-container');
            // å¦‚æœä¹‹å‰æœ‰æç¤ºè¯­ï¼Œå…ˆæ¸…ç©º
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            const newBlock = createWorldBookEntryBlock(); // åˆ›å»ºä¸€ä¸ªç©ºå—
            container.appendChild(newBlock);
            newBlock.querySelector('.entry-content-textarea').focus(); // è‡ªåŠ¨èšç„¦åˆ°æ–°å—çš„å†…å®¹åŒº
        });
        // â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
                    // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´ä¸‹é¢è¿™ä¸¤è¡Œ â–¼â–¼â–¼
        document.getElementById('switch-greeting-btn').addEventListener('click', handleSwitchGreeting);
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºå¿ƒå£°å†å²åˆ—è¡¨æ·»åŠ â€œåŠ è½½æ›´å¤šâ€çš„äº‹ä»¶å§”æ‰˜ â–¼â–¼â–¼
        document.getElementById('thoughts-history-list').addEventListener('click', (e) => {
            if (e.target && e.target.id === 'load-more-thoughts-btn') {
                loadMoreThoughts();
            }
        });
        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        // åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
        
        // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†äº‹ä»¶ç›‘å¬ç»‘å®šåˆ°æ–°çš„å›¾æ ‡æŒ‰é’®ä¸Š â–¼â–¼â–¼
        document.getElementById('profile-history-icon-btn').addEventListener('click', showThoughtsHistory);
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        document.getElementById('history-back-btn').addEventListener('click', hideThoughtsHistory);
        document.getElementById('character-profile-modal').addEventListener('click', (e) => {
            // å¦‚æœç‚¹å‡»çš„æ˜¯æ·±è‰²èƒŒæ™¯æœ¬èº«ï¼Œè€Œä¸æ˜¯å†…å®¹åŒºåŸŸï¼Œå°±å…³é—­å¼¹çª—
            if (e.target.id === 'character-profile-modal') {
                e.target.classList.remove('visible');
            }
        });
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…æ‰¹é‡åˆ é™¤äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        document.getElementById('manage-stickers-btn').addEventListener('click', toggleStickerManagementMode);
        document.getElementById('delete-selected-stickers-btn').addEventListener('click', executeBatchDeleteStickers);
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
                    // ç»‘å®šåŠ¨æ€é¡µå’Œæ”¶è—é¡µçš„è¿”å›æŒ‰é’®
                    document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
                    document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
        
                    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        
                    // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œæ£€æŸ¥å¹¶ç¡®ä¿ä½ æœ‰è¿™æ®µå®Œæ•´çš„ä»£ç  â–¼â–¼â–¼
        
                    // æ”¶è—é¡µæœç´¢åŠŸèƒ½
                    const searchInput = document.getElementById('favorites-search-input');
                    const searchClearBtn = document.getElementById('favorites-search-clear-btn');
        
                    searchInput.addEventListener('input', () => {
                        const searchTerm = searchInput.value.trim().toLowerCase();
                        
                        // æ§åˆ¶æ¸…é™¤æŒ‰é’®çš„æ˜¾ç¤º/éšè—
                        searchClearBtn.style.display = searchTerm ? 'block' : 'none';
        
                        if (!searchTerm) {
                            displayFilteredFavorites(allFavoriteItems); // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰
                            return;
                        }
        
                        // ç­›é€‰é€»è¾‘
                        const filteredItems = allFavoriteItems.filter(item => {
                            let contentToSearch = '';
                            let authorToSearch = '';
        
                            if (item.type === 'qzone_post') {
                                const post = item.content;
                                contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                                if (post.authorId === 'user') {
                                    authorToSearch = state.qzoneSettings.nickname;
                                } else if (state.chats[post.authorId]) {
                                    authorToSearch = state.chats[post.authorId].name;
                                }
                            } else if (item.type === 'chat_message') {
                                const msg = item.content;
                                if (typeof msg.content === 'string') {
                                    contentToSearch = msg.content;
                                }
                                const chat = state.chats[item.chatId];
                                if (chat) {
                                   if (msg.role === 'user') {
                                        authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
                                   } else {
                                        authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                                   }
                                }
                            }
                            
                            // åŒæ—¶æœç´¢å†…å®¹å’Œä½œè€…ï¼Œå¹¶ä¸”ä¸åŒºåˆ†å¤§å°å†™
                            return contentToSearch.toLowerCase().includes(searchTerm) || 
                                   authorToSearch.toLowerCase().includes(searchTerm);
                        });
        
                        displayFilteredFavorites(filteredItems);
                    });
        
                    // æ¸…é™¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
                    searchClearBtn.addEventListener('click', () => {
                        searchInput.value = '';
                        searchClearBtn.style.display = 'none';
                        displayFilteredFavorites(allFavoriteItems);
                        searchInput.focus();
                    });
        
                    // â–²â–²â–² ä»£ç æ£€æŸ¥ç»“æŸ â–²â–²â–²
        
                    // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
                    
                    // ä¸ºèŠå¤©ç•Œé¢çš„æ‰¹é‡æ”¶è—æŒ‰é’®ç»‘å®šäº‹ä»¶
                                // ä¸ºèŠå¤©ç•Œé¢çš„æ‰¹é‡æ”¶è—æŒ‰é’®ç»‘å®šäº‹ä»¶ (å·²ä¿®æ­£)
                    document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                        if (selectedMessages.size === 0) return;
                        const chat = state.chats[state.activeChatId];
                        if (!chat) return;
        
                        const favoritesToAdd = [];
                        const timestampsToFavorite = [...selectedMessages];
        
                        for (const timestamp of timestampsToFavorite) {
                            // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä½¿ç”¨æ–°çš„ã€é«˜æ•ˆçš„ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢
                            const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();
                            
                            if (!existing) {
                                const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                                if (messageToSave) {
                                    favoritesToAdd.push({
                                        type: 'chat_message',
                                        content: messageToSave,
                                        chatId: state.activeChatId,
                                        timestamp: Date.now(), // è¿™æ˜¯æ”¶è—æ“ä½œå‘ç”Ÿçš„æ—¶é—´
                                        originalTimestamp: messageToSave.timestamp // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä¿å­˜åŸå§‹æ¶ˆæ¯çš„æ—¶é—´æˆ³åˆ°æ–°å­—æ®µ
                                    });
                                }
                            }
                        }
        
                        if (favoritesToAdd.length > 0) {
                            await db.favorites.bulkAdd(favoritesToAdd);
                            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray(); // æ›´æ–°å…¨å±€æ”¶è—ç¼“å­˜
                            await showCustomAlert('æ”¶è—æˆåŠŸ', `å·²æˆåŠŸæ”¶è— ${favoritesToAdd.length} æ¡æ¶ˆæ¯ã€‚`);
                        } else {
                            await showCustomAlert('æç¤º', 'é€‰ä¸­çš„æ¶ˆæ¯å‡å·²æ”¶è—è¿‡ã€‚');
                        }
                        
                        exitSelectionMode();
                    });
        
                    // æ”¶è—é¡µé¢çš„"ç¼–è¾‘"æŒ‰é’®äº‹ä»¶ (å·²ä¿®æ­£)
                    const favoritesEditBtn = document.getElementById('favorites-edit-btn');
                    const favoritesView = document.getElementById('favorites-view');
                    const favoritesActionBar = document.getElementById('favorites-action-bar');
                    const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // è·å–ä¸»å¯¼èˆªæ 
                    const favoritesList = document.getElementById('favorites-list'); // è·å–æ”¶è—åˆ—è¡¨
                    
                    favoritesEditBtn.addEventListener('click', () => {
                        isFavoritesSelectionMode = !isFavoritesSelectionMode;
                        favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);
        
                        if (isFavoritesSelectionMode) {
                            // --- è¿›å…¥ç¼–è¾‘æ¨¡å¼ ---
                            favoritesEditBtn.textContent = 'å®Œæˆ';
                            favoritesActionBar.style.display = 'block'; // æ˜¾ç¤ºåˆ é™¤æ“ä½œæ 
                            mainBottomNav.style.display = 'none'; // â–¼ æ–°å¢ï¼šéšè—ä¸»å¯¼èˆªæ 
                            favoritesList.style.paddingBottom = '80px'; // â–¼ æ–°å¢ï¼šç»™åˆ—è¡¨åº•éƒ¨å¢åŠ ç©ºé—´
                        } else {
                            // --- é€€å‡ºç¼–è¾‘æ¨¡å¼ ---
                            favoritesEditBtn.textContent = 'ç¼–è¾‘';
                            favoritesActionBar.style.display = 'none'; // éšè—åˆ é™¤æ“ä½œæ 
                            mainBottomNav.style.display = 'flex';  // â–¼ æ–°å¢ï¼šæ¢å¤ä¸»å¯¼èˆªæ 
                            favoritesList.style.paddingBottom = ''; // â–¼ æ–°å¢ï¼šæ¢å¤åˆ—è¡¨é»˜è®¤padding
        
                            // é€€å‡ºæ—¶æ¸…ç©ºæ‰€æœ‰é€‰æ‹©
                            selectedFavorites.clear();
                            document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                            document.getElementById('favorites-delete-selected-btn').textContent = `åˆ é™¤ (0)`;
                        }
                    });
        
        // â–¼â–¼â–¼ å°†å®ƒã€å®Œæ•´æ›¿æ¢ã€‘ä¸ºä¸‹é¢è¿™æ®µä¿®æ­£åçš„ä»£ç  â–¼â–¼â–¼
        // æ”¶è—åˆ—è¡¨çš„ç‚¹å‡»é€‰æ‹©äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
        document.getElementById('favorites-list').addEventListener('click', (e) => {
            const target = e.target;
            const card = target.closest('.favorite-item-card');
        
            // ã€æ–°å¢ã€‘å¤„ç†æ–‡å­—å›¾ç‚¹å‡»ï¼Œè¿™æ®µé€»è¾‘è¦æ”¾åœ¨æœ€å‰é¢ï¼Œä¿è¯ä»»ä½•æ¨¡å¼ä¸‹éƒ½ç”Ÿæ•ˆ
            if (target.tagName === 'IMG' && target.dataset.hiddenText) {
                const hiddenText = target.dataset.hiddenText;
                showCustomAlert("å›¾ç‰‡å†…å®¹", hiddenText.replace(/<br>/g, '\n'));
                return; // å¤„ç†å®Œå°±é€€å‡ºï¼Œä¸ç»§ç»­æ‰§è¡Œé€‰æ‹©é€»è¾‘
            }
            
            // å¦‚æœä¸åœ¨é€‰æ‹©æ¨¡å¼ï¼Œåˆ™ä¸æ‰§è¡Œåç»­çš„é€‰æ‹©æ“ä½œ
            if (!isFavoritesSelectionMode) return;
        
            // --- ä»¥ä¸‹æ˜¯åŸæœ‰çš„é€‰æ‹©é€»è¾‘ï¼Œä¿æŒä¸å˜ ---
            if (!card) return;
        
            const favId = parseInt(card.dataset.favid);
            if (isNaN(favId)) return;
        
            // åˆ‡æ¢é€‰æ‹©çŠ¶æ€
            if (selectedFavorites.has(favId)) {
                selectedFavorites.delete(favId);
                card.classList.remove('selected');
            } else {
                selectedFavorites.add(favId);
                card.classList.add('selected');
            }
            
            // æ›´æ–°åº•éƒ¨åˆ é™¤æŒ‰é’®çš„è®¡æ•°
            document.getElementById('favorites-delete-selected-btn').textContent = `åˆ é™¤ (${selectedFavorites.size})`;
        });
        
        // â–¼â–¼â–¼ å°†å®ƒã€å®Œæ•´æ›¿æ¢ã€‘ä¸ºä¸‹é¢è¿™æ®µä¿®æ­£åçš„ä»£ç  â–¼â–¼â–¼
        // æ”¶è—é¡µé¢æ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶
        document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
            if (selectedFavorites.size === 0) return;
        
            const confirmed = await showCustomConfirm(
                'ç¡®è®¤åˆ é™¤', 
                `ç¡®å®šè¦ä»æ”¶è—å¤¹ä¸­ç§»é™¤è¿™ ${selectedFavorites.size} æ¡å†…å®¹å—ï¼Ÿ`, 
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (confirmed) {
                const idsToDelete = [...selectedFavorites];
                await db.favorites.bulkDelete(idsToDelete);
                await showCustomAlert('åˆ é™¤æˆåŠŸ', 'é€‰ä¸­çš„æ”¶è—å·²è¢«ç§»é™¤ã€‚');
                
                // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä»å‰ç«¯ç¼“å­˜ä¸­ä¹Ÿç§»é™¤è¢«åˆ é™¤çš„é¡¹
                allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));
                
                // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä½¿ç”¨æ›´æ–°åçš„ç¼“å­˜ï¼Œç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
                displayFilteredFavorites(allFavoriteItems);
                
                // æœ€åï¼Œå†é€€å‡ºç¼–è¾‘æ¨¡å¼
                favoritesEditBtn.click(); // æ¨¡æ‹Ÿç‚¹å‡»"å®Œæˆ"æŒ‰é’®æ¥é€€å‡ºç¼–è¾‘æ¨¡å¼
            }
        });
        
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°æœ«å°¾æ·»åŠ  â–¼â–¼â–¼
        if (state.globalSettings.enableBackgroundActivity) {
            startBackgroundSimulation();
            console.log("åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²è‡ªåŠ¨å¯åŠ¨ã€‚");
        }
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€è¿™æ˜¯æœ€ç»ˆçš„æ­£ç¡®ä»£ç ã€‘è¯·ç²˜è´´è¿™æ®µä»£ç åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
        
        // --- ç»Ÿä¸€å¤„ç†æ‰€æœ‰å½±å“é¢„è§ˆçš„æ§ä»¶çš„äº‹ä»¶ ---
        
        // 1. ç›‘å¬ä¸»é¢˜é€‰æ‹©
        document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
            radio.addEventListener('change', updateSettingsPreview);
        });
        
        // 2. ç›‘å¬å­—ä½“å¤§å°æ»‘å—
        const fontSizeSlider = document.getElementById('font-size-slider');
        fontSizeSlider.addEventListener('input', () => {
            // a. å®æ—¶æ›´æ–°æ•°å€¼æ˜¾ç¤º
            document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
            // b. æ›´æ–°é¢„è§ˆ
            updateSettingsPreview();
        });
        
        // 3. ç›‘å¬è‡ªå®šä¹‰CSSè¾“å…¥æ¡†
        const customCssInputForPreview = document.getElementById('custom-css-input');
        customCssInputForPreview.addEventListener('input', updateSettingsPreview);
        
        // 4. ç›‘å¬é‡ç½®æŒ‰é’®
        document.getElementById('reset-theme-btn').addEventListener('click', () => {
            document.getElementById('theme-default').checked = true;
            updateSettingsPreview();
        });
        
        document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
            document.getElementById('custom-css-input').value = '';
            updateSettingsPreview();
        });
        
        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
        // ã€è¯·ç¡®ä¿è¿™æ®µä»£ç åœ¨æ‚¨çš„ init() å‡½æ•°å†…ã€‘
        document.getElementById('lyrics-vertical-pos').addEventListener('change', updateSettingsPreview);
        document.getElementById('lyrics-horizontal-pos').addEventListener('change', updateSettingsPreview);
        document.getElementById('lyrics-offset-input').addEventListener('input', updateSettingsPreview);
        // â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
        document.querySelectorAll('input[name="visibility"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const groupsContainer = document.getElementById('post-visibility-groups');
                if (this.value === 'include' || this.value === 'exclude') {
                    groupsContainer.style.display = 'block';
                } else {
                    groupsContainer.style.display = 'none';
                }
            });
        });
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
        document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
        document.getElementById('close-group-manager-btn').addEventListener('click', () => {
            document.getElementById('group-management-modal').classList.remove('visible');
            // åˆ·æ–°èŠå¤©è®¾ç½®é‡Œçš„åˆ†ç»„åˆ—è¡¨
            const chatSettingsBtn = document.getElementById('chat-settings-btn');
            if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
               chatSettingsBtn.click(); // å†æ¬¡ç‚¹å‡»ä»¥é‡æ–°æ‰“å¼€
            }
        });
        
        document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
        document.getElementById('existing-groups-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-group-btn')) {
                const groupId = parseInt(e.target.dataset.id);
                deleteGroup(groupId);
            }
        });
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
        // æ¶ˆæ¯æ“ä½œèœå•çš„æŒ‰é’®äº‹ä»¶
        document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);
        // â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘ä½¿ç”¨æ–°çš„ç¼–è¾‘å™¨å…¥å£ â–¼â–¼â–¼
        document.getElementById('edit-message-btn').addEventListener('click', openAdvancedMessageEditor);
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);
        
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
        document.getElementById('recall-message-btn').addEventListener('click', handleRecallClick);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€ä¿®æ­£åã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ select-message-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('select-message-btn').addEventListener('click', () => {
            // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨å…³é—­èœå•å‰ï¼Œå…ˆæ•è·æ—¶é—´æˆ³
            const timestampToSelect = activeMessageTimestamp; 
            hideMessageActions();
            // ä½¿ç”¨æ•è·åˆ°çš„å€¼
            if (timestampToSelect) {
                enterSelectionMode(timestampToSelect);
            }
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ  â–¼â–¼â–¼
        
        // ç›‘å¬èŠå¤©åŒºåŸŸçš„ç‚¹å‡»ï¼Œä¸“é—¨ç”¨äºå¤„ç†AIå‘æ¥çš„è½¬è´¦
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // 1. å‘ä¸ŠæŸ¥æ‰¾è¢«ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªæ¶ˆæ¯æ°”æ³¡å†…
            const bubble = e.target.closest('.message-bubble');
            if (!bubble) return; // å¦‚æœä¸åœ¨ï¼Œå°±é€€å‡º
        
            // 2. æ£€æŸ¥æ˜¯å¦æ˜¯AIçš„ã€å¾…å¤„ç†çš„è½¬è´¦æ¶ˆæ¯
            if (bubble.classList.contains('ai') && 
                bubble.classList.contains('is-transfer') && 
                bubble.dataset.status === 'pending') {
                
                // 3. åªæœ‰æ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼Œæ‰æ˜¾ç¤ºæ“ä½œèœå•
                const timestamp = parseInt(bubble.dataset.timestamp);
                if (!isNaN(timestamp)) {
                    showTransferActionModal(timestamp);
                }
            }
        });
        
        // ç»‘å®šæ–°è½¬è´¦æ“ä½œæ¨¡æ€æ¡†çš„æŒ‰é’®
        document.getElementById('transfer-action-accept').addEventListener('click', () => handleUserTransferResponse('accepted'));
        document.getElementById('transfer-action-decline').addEventListener('click', () => handleUserTransferResponse('declined'));
        document.getElementById('transfer-action-cancel').addEventListener('click', hideTransferActionModal);
        
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾æ·»åŠ  â–¼â–¼â–¼
        
        // åŠ¨æ€æ“ä½œèœå•çš„æŒ‰é’®äº‹ä»¶
        document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
        document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
        document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);
        
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æ–°å¢ã€‘è”ç³»äººé€‰æ‹©å™¨äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
            showScreen('chat-list-screen');
        });
        
        document.getElementById('contact-picker-list').addEventListener('click', (e) => {
            const item = e.target.closest('.contact-picker-item');
            if (!item) return;
        
            const contactId = item.dataset.contactId;
            item.classList.toggle('selected');
            
            if (selectedContacts.has(contactId)) {
                selectedContacts.delete(contactId);
            } else {
                selectedContacts.add(contactId);
            }
            updateContactPickerConfirmButton();
        });
        
        // â–¼â–¼â–¼ ã€æ–°å¢ã€‘ç»‘å®šâ€œç®¡ç†ç¾¤æˆå‘˜â€æŒ‰é’®äº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('manage-members-btn').addEventListener('click', () => {
            // åœ¨åˆ‡æ¢å±å¹•å‰ï¼Œå…ˆéšè—å½“å‰çš„èŠå¤©è®¾ç½®å¼¹çª—
            //document.getElementById('chat-settings-modal').classList.remove('visible');
            // ç„¶åå†æ‰“å¼€æˆå‘˜ç®¡ç†å±å¹•
            openMemberManagementScreen();
        });
        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆå®Œæ•´ç‰ˆã€‘ç¾¤æˆå‘˜ç®¡ç†åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        document.getElementById('back-from-member-management').addEventListener('click', () => {
        
            showScreen('chat-interface-screen');    
            document.getElementById('chat-settings-btn').click();
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        document.getElementById('member-management-list').addEventListener('click', (e) => {
            // ã€å·²æ¢å¤ã€‘ç§»é™¤æˆå‘˜çš„äº‹ä»¶
            if (e.target.classList.contains('remove-member-btn')) {
                removeMemberFromGroup(e.target.dataset.memberId);
            }
        });
        
        document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {
            // ã€å·²æ¢å¤ã€‘ä»å¥½å‹åˆ—è¡¨æ·»åŠ çš„äº‹ä»¶
            // ã€å…³é”®ã€‘ä¸ºâ€œå®Œæˆâ€æŒ‰é’®ç»‘å®šâ€œæ‹‰äººå…¥ç¾¤â€çš„é€»è¾‘
            const confirmBtn = document.getElementById('confirm-contact-picker-btn');
            // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æ–¹æ³•æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', handleAddMembersToGroup);
            
            await openContactPickerForAddMember();
        });
        
        document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        
        // ç»‘å®šå•èŠå’Œç¾¤èŠçš„å‘èµ·æŒ‰é’®
        document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
        document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);
        
        // ç»‘å®šâ€œæŒ‚æ–­â€æŒ‰é’®
        document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);
        
        // ç»‘å®šâ€œå–æ¶ˆå‘¼å«â€æŒ‰é’®
        document.getElementById('cancel-call-btn').addEventListener('click', () => {
            videoCallState.isAwaitingResponse = false;
            showScreen('chat-interface-screen');
        });
        
        // ã€å…¨æ–°ã€‘ç»‘å®šâ€œåŠ å…¥é€šè¯â€æŒ‰é’®
        document.getElementById('join-call-btn').addEventListener('click', handleUserJoinCall);
        
        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤å¹¶æ¿€æ´»æ—è§‚æ¨¡å¼ã€‘çš„ç‰ˆæœ¬æ›¿æ¢æ—§çš„ decline-call-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        // ç»‘å®šæ¥ç”µè¯·æ±‚çš„â€œæ‹’ç»â€æŒ‰é’®
        document.getElementById('decline-call-btn').addEventListener('click', async () => {
            hideIncomingCallModal();
            const chat = state.chats[videoCallState.activeChatId];
            if (!chat) return;
            
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æ‹’ç»çš„é€»è¾‘ä¸APIè°ƒç”¨è¿æ¥èµ·æ¥
            if (videoCallState.isGroupCall) {
                videoCallState.isUserParticipating = false; // æ ‡è®°ç”¨æˆ·ä¸ºæ—è§‚è€…
                
                // 1. åˆ›å»ºä¸€æ¡éšè—æ¶ˆæ¯ï¼Œé€šçŸ¥AIç”¨æˆ·æ‹’ç»äº†
                const systemNote = {
                    role: 'system',
                    content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ‹’ç»äº†é€šè¯é‚€è¯·ï¼Œä½†ä½ ä»¬å¯ä»¥è‡ªå·±å¼€å§‹ã€‚è¯·ä½ ä»¬å„è‡ªå†³ç­–æ˜¯å¦åŠ å…¥ã€‚]`,
                    timestamp: Date.now(),
                    isHidden: true
                };
                chat.history.push(systemNote);
                await db.chats.put(chat);
                
                // 2. ã€å…³é”®ã€‘è§¦å‘AIå“åº”ï¼Œè®©å®ƒä»¬è‡ªå·±å†³å®šè¦ä¸è¦å¼€å§‹ç¾¤èŠ
                // è¿™å°†ä¼šåœ¨åå°å¤„ç†ï¼Œå¦‚æœAIä»¬å†³å®šå¼€å§‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ startVideoCall()
                await triggerAiResponse(); 
                
            } else { // å•èŠæ‹’ç»é€»è¾‘ä¿æŒä¸å˜
                const declineMessage = { role: 'user', content: 'æˆ‘æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚', timestamp: Date.now() };
                chat.history.push(declineMessage);
                await db.chats.put(chat);
                
                // å›åˆ°èŠå¤©ç•Œé¢å¹¶æ˜¾ç¤ºæ‹’ç»æ¶ˆæ¯
                showScreen('chat-interface-screen');
                appendMessage(declineMessage, chat);
                
                // è®©AIå¯¹ä½ çš„æ‹’ç»åšå‡ºå›åº”
                triggerAiResponse();
            }
            
            // æ¸…ç†çŠ¶æ€ï¼Œä»¥é˜²ä¸‡ä¸€
            videoCallState.isAwaitingResponse = false;
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤é‡å¤å¤´åƒBUGã€‘çš„ç‰ˆæœ¬æ›¿æ¢æ—§çš„ accept-call-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        // ç»‘å®šæ¥ç”µè¯·æ±‚çš„â€œæ¥å¬â€æŒ‰é’®
        document.getElementById('accept-call-btn').addEventListener('click', async () => {
            hideIncomingCallModal();
            
            videoCallState.initiator = 'ai';
            videoCallState.isUserParticipating = true;
            videoCallState.activeChatId = state.activeChatId;
            
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘æˆ‘ä»¬åœ¨è¿™é‡Œä¸å†æ‰‹åŠ¨æ·»åŠ ç”¨æˆ·åˆ° participants åˆ—è¡¨
            if (videoCallState.isGroupCall) {
                // å¯¹äºç¾¤èŠï¼Œæˆ‘ä»¬åªæŠŠã€å‘èµ·é€šè¯çš„AIã€‘åŠ å…¥å‚ä¸è€…åˆ—è¡¨
                const chat = state.chats[videoCallState.activeChatId];
                const requester = chat.members.find(m => m.name === videoCallState.callRequester);
                if (requester) {
                    // æ¸…ç©ºå¯èƒ½å­˜åœ¨çš„æ—§æ•°æ®ï¼Œç„¶ååªæ·»åŠ å‘èµ·è€…
                    videoCallState.participants = [requester];
                } else {
                    videoCallState.participants = []; // å¦‚æœæ‰¾ä¸åˆ°å‘èµ·è€…ï¼Œå°±æ¸…ç©º
                }
            }
            
            // æ— è®ºå•èŠè¿˜æ˜¯ç¾¤èŠï¼Œç›´æ¥å¯åŠ¨é€šè¯ç•Œé¢ï¼
            startVideoCall();
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²å¢åŠ ç”¨æˆ·é«˜äº®ã€‘çš„å…¨æ–°ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ user-speak-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        // ç»‘å®šç”¨æˆ·åœ¨é€šè¯ä¸­å‘è¨€çš„æŒ‰é’®
        document.getElementById('user-speak-btn').addEventListener('click', async () => {
            if (!videoCallState.isActive) return;
        
            // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šåœ¨å¼¹å‡ºè¾“å…¥æ¡†å‰ï¼Œå…ˆæ‰¾åˆ°å¹¶é«˜äº®ç”¨æˆ·å¤´åƒ â˜…â˜…â˜…â˜…â˜…
            const userAvatar = document.querySelector('.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
            if (userAvatar) {
                userAvatar.classList.add('speaking');
            }
        
            const userInput = await showCustomPrompt('ä½ è¯´', 'è¯·è¾“å…¥ä½ æƒ³è¯´çš„è¯...');
            
            // â˜…â˜…â˜…â˜…â˜… æ ¸å¿ƒæ–°å¢ï¼šæ— è®ºç”¨æˆ·æ˜¯å¦è¾“å…¥ï¼Œåªè¦å…³é—­è¾“å…¥æ¡†å°±ç§»é™¤é«˜äº® â˜…â˜…â˜…â˜…â˜…
            if (userAvatar) {
                userAvatar.classList.remove('speaking');
            }
        
            if (userInput && userInput.trim()) {
                triggerAiInCallAction(userInput.trim());
            }
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€æ–°å¢ã€‘å›å¿†å½•ç›¸å…³äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        // 1. å°†â€œå›å¿†â€é¡µç­¾å’Œå®ƒçš„è§†å›¾è¿æ¥èµ·æ¥
        document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {
            // åœ¨åˆ‡æ¢å‰ï¼Œç¡®ä¿"æ”¶è—"é¡µé¢çš„ç¼–è¾‘æ¨¡å¼å·²å…³é—­
            if (isFavoritesSelectionMode) {
                document.getElementById('favorites-edit-btn').click(); 
            }
            switchToChatListView('memories-view');
            renderMemoriesScreen(); // ç‚¹å‡»æ—¶æ¸²æŸ“
        });
        
        // 2. ç»‘å®šå›å¿†å½•ç•Œé¢çš„è¿”å›æŒ‰é’®
        document.getElementById('memories-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
        
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ‰¾åˆ°è¿™ä¸ªæŒ‰é’®çš„ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('confirm-create-countdown-btn').addEventListener('click', async () => {
            const title = document.getElementById('countdown-title-input').value.trim();
            const dateValue = document.getElementById('countdown-date-input').value;
            
            if (!title || !dateValue) {
                alert('è¯·å¡«å†™å®Œæ•´çš„çº¦å®šæ ‡é¢˜å’Œæ—¥æœŸï¼');
                return;
            }
        
            const targetDate = new Date(dateValue);
            if (isNaN(targetDate) || targetDate <= new Date()) {
                alert('è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ã€æœªæ¥çš„æ—¥æœŸï¼');
                return;
            }
        
            // â–¼â–¼â–¼ å°†å…¶ã€æ›¿æ¢ä¸ºã€‘ä¸‹é¢è¿™æ®µã€æ–°ä»£ç ã€‘â–¼â–¼â–¼
            const newCountdown = {
                authorId: 'user', // ã€æ ¸å¿ƒä¿®å¤2ã€‘ä¸å†å­˜ authorNameï¼Œè€Œæ˜¯ç”¨ 'user' ä½œä¸ºæ‚¨çš„ä¸“å±ID
                description: title,
                timestamp: Date.now(),
                type: 'countdown',
                targetDate: targetDate.getTime()
            };
            // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            
            await db.memories.add(newCountdown);
            document.getElementById('create-countdown-modal').classList.remove('visible');
            renderMemoriesScreen();
        });
        
        // ã€å…¨æ–°ã€‘æ‹‰é»‘åŠŸèƒ½äº‹ä»¶ç»‘å®š
        document.getElementById('block-chat-btn').addEventListener('click', async () => {
            if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;
        
            const chat = state.chats[state.activeChatId];
            const confirmed = await showCustomConfirm(
                'ç¡®è®¤æ‹‰é»‘', 
                `ç¡®å®šè¦æ‹‰é»‘â€œ${chat.name}â€å—ï¼Ÿæ‹‰é»‘åæ‚¨å°†æ— æ³•å‘å…¶å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æ‚¨å°†Taç§»å‡ºé»‘åå•ï¼Œæˆ–ç­‰å¾…Taé‡æ–°ç”³è¯·å¥½å‹ã€‚`,
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (confirmed) {
                chat.relationship.status = 'blocked_by_user';
                chat.relationship.blockedTimestamp = Date.now();
        
                // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
                const hiddenMessage = {
                    role: 'system',
                    content: `[ç³»ç»Ÿæç¤ºï¼šä½ åˆšåˆšè¢«ç”¨æˆ·æ‹‰é»‘äº†ã€‚åœ¨å¯¹æ–¹è§£é™¤æ‹‰é»‘ä¹‹å‰ï¼Œä½ æ— æ³•å†ä¸»åŠ¨å‘èµ·å¯¹è¯ï¼Œä¹Ÿæ— æ³•å›åº”ã€‚]`,
                    timestamp: Date.now() + 1,
                    isHidden: true
                };
                chat.history.push(hiddenMessage);
                // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        
                await db.chats.put(chat);
                
                // å…³é—­è®¾ç½®å¼¹çª—ï¼Œå¹¶åˆ·æ–°èŠå¤©ç•Œé¢
                document.getElementById('chat-settings-modal').classList.remove('visible');
                renderChatInterface(state.activeChatId);
                // åˆ·æ–°èŠå¤©åˆ—è¡¨ï¼Œå¯èƒ½ä¼šæœ‰UIå˜åŒ–
                renderChatList();
            }
        });
        
        document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            if (e.target.id === 'force-apply-check-btn') {
                alert("æ­£åœ¨æ‰‹åŠ¨è§¦å‘å¥½å‹ç”³è¯·æµç¨‹ï¼Œè¯·ç¨å...\nå¦‚æœAPIè°ƒç”¨æˆåŠŸï¼Œå°†å¼¹å‡ºæç¤ºã€‚å¦‚æœå¤±è´¥ï¼Œä¹Ÿä¼šæœ‰é”™è¯¯æç¤ºã€‚å¦‚æœé•¿æ—¶é—´æ— ååº”ï¼Œè¯´æ˜AIå¯èƒ½å†³å®šæš‚æ—¶ä¸ç”³è¯·ã€‚");
                await triggerAiFriendApplication(chat.id);
                renderChatInterface(chat.id); 
                return;
            }
        
            if (e.target.id === 'unblock-btn') {
                chat.relationship.status = 'friend';
                chat.relationship.blockedTimestamp = null;
        
                // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
                const hiddenMessage = {
                    role: 'system',
                    content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšè§£é™¤äº†å¯¹ä½ çš„æ‹‰é»‘ã€‚ç°åœ¨ä½ ä»¬å¯ä»¥é‡æ–°å¼€å§‹å¯¹è¯äº†ã€‚]`,
                    timestamp: Date.now(),
                    isHidden: true
                };
                chat.history.push(hiddenMessage);
                // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
        
                await db.chats.put(chat);
                renderChatInterface(chat.id);
                renderChatList();
                triggerAiResponse(); // ã€å¯é€‰ä½†æ¨èã€‘è§£é™¤åè®©AIä¸»åŠ¨è¯´ç‚¹ä»€ä¹ˆ
            }
        else if (e.target.id === 'accept-friend-btn') {
                // 1. æ ¸å¿ƒä¿®æ­£ï¼šä¸å†è§¦å‘AIå“åº”ï¼Œé¿å…é€»è¾‘æ··ä¹±
                // triggerAiResponse(); // <-- åˆ é™¤æˆ–æ³¨é‡Šæ‰è¿™ä¸€è¡Œ
        
                // 2. ç›´æ¥æ›´æ–°å…³ç³»çŠ¶æ€
                chat.relationship.status = 'friend';
                chat.relationship.applicationReason = '';
        
                // 3. æ–°å¢ï¼šç›´æ¥åœ¨å‰ç«¯ç”Ÿæˆä¸€æ¡å¯¹ç”¨æˆ·å¯è§çš„ç³»ç»Ÿæ¶ˆæ¯ï¼Œå‘ŠçŸ¥æ“ä½œæˆåŠŸ
                const systemMessage = {
                    role: 'system',
                    type: 'pat_message', // å¤ç”¨å±…ä¸­æ ·å¼
                    content: `ä½ é€šè¿‡äº†â€œ${chat.name}â€çš„å¥½å‹è¯·æ±‚`,
                    timestamp: Date.now()
                };
                chat.history.push(systemMessage);
        
                // 4. æ–°å¢ï¼šæ¨¡æ‹ŸAIå‘æ¥ä¸€æ¡è‡ªç„¶çš„æ¬¢è¿æ¶ˆæ¯ï¼Œè®©äº¤äº’æ›´æµç•…
                const welcomeMessage = {
                    role: 'assistant',
                    senderName: chat.name,
                    content: 'å¤ªå¥½äº†ï¼æˆ‘ä»¬åˆå¯ä»¥èŠå¤©å•¦ï¼',
                    timestamp: Date.now() + 1 // æ—¶é—´æˆ³+1ç¡®ä¿åœ¨ç³»ç»Ÿæ¶ˆæ¯ä¹‹å
                };
                chat.history.push(welcomeMessage);
        
                // 5. ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ›´æ”¹ä¿å­˜åˆ°æ•°æ®åº“
                await db.chats.put(chat);
        
                // 6. åˆ·æ–°UIï¼Œæ˜¾ç¤ºæœ€æ–°çš„çŠ¶æ€å’Œæ¶ˆæ¯
                renderChatInterface(chat.id);
                renderChatList();
            }
            else if (e.target.id === 'reject-friend-btn') {
                chat.relationship.status = 'blocked_by_user';
                chat.relationship.blockedTimestamp = Date.now();
                chat.relationship.applicationReason = '';
                await db.chats.put(chat);
                renderChatInterface(chat.id);
            }
            // ã€æ–°å¢ã€‘å¤„ç†ç”³è¯·å¥½å‹æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            else if (e.target.id === 'apply-friend-btn') {
                const reason = await showCustomPrompt(
                    'å‘é€å¥½å‹ç”³è¯·', 
                    `è¯·è¾“å…¥ä½ æƒ³å¯¹â€œ${chat.name}â€è¯´çš„ç”³è¯·ç†ç”±ï¼š`,
                    "æˆ‘ä»¬å’Œå¥½å§ï¼"
                );
                // åªæœ‰å½“ç”¨æˆ·è¾“å…¥äº†å†…å®¹å¹¶ç‚¹å‡»â€œç¡®å®šâ€åæ‰ç»§ç»­
                if (reason !== null) {
                    // æ›´æ–°å…³ç³»çŠ¶æ€ä¸ºâ€œç­‰å¾…AIæ‰¹å‡†â€
                    chat.relationship.status = 'pending_ai_approval';
                    chat.relationship.applicationReason = reason;
                    await db.chats.put(chat);
        
                    // åˆ·æ–°UIï¼Œæ˜¾ç¤ºâ€œç­‰å¾…é€šè¿‡â€çš„ç•Œé¢
                    renderChatInterface(chat.id);
                    renderChatList();
                    
                    // ã€å…³é”®ã€‘è§¦å‘AIå“åº”ï¼Œè®©å®ƒå»å¤„ç†è¿™ä¸ªå¥½å‹ç”³è¯·
                    triggerAiResponse();
                }
            }
        });
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        
        // 1. å°†åŸæœ‰çš„è½¬è´¦æŒ‰é’®(ï¿¥)çš„ç‚¹å‡»äº‹ä»¶ï¼Œé‡å®šå‘åˆ°æ–°çš„æ€»å…¥å£å‡½æ•°
        document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);
        
        // 2. çº¢åŒ…æ¨¡æ€æ¡†å†…éƒ¨çš„æ§åˆ¶æŒ‰é’®
        document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
            document.getElementById('red-packet-modal').classList.remove('visible');
        });
        document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
        document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);
        
        // 3. çº¢åŒ…æ¨¡æ€æ¡†çš„é¡µç­¾åˆ‡æ¢é€»è¾‘
        const rpTabGroup = document.getElementById('rp-tab-group');
        const rpTabDirect = document.getElementById('rp-tab-direct');
        const rpContentGroup = document.getElementById('rp-content-group');
        const rpContentDirect = document.getElementById('rp-content-direct');
        
        rpTabGroup.addEventListener('click', () => {
            rpTabGroup.classList.add('active');
            rpTabDirect.classList.remove('active');
            rpContentGroup.style.display = 'block';
            rpContentDirect.style.display = 'none';
        });
        rpTabDirect.addEventListener('click', () => {
            rpTabDirect.classList.add('active');
            rpTabGroup.classList.remove('active');
            rpContentDirect.style.display = 'block';
            rpContentGroup.style.display = 'none';
        });
        
        // 4. å®æ—¶æ›´æ–°çº¢åŒ…é‡‘é¢æ˜¾ç¤º
        document.getElementById('rp-group-amount').addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value) || 0;
            document.getElementById('rp-group-total').textContent = `Â¥ ${amount.toFixed(2)}`;
        });
        document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value) || 0;
            document.getElementById('rp-direct-total').textContent = `Â¥ ${amount.toFixed(2)}`;
        });
        
        // â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†çº¢åŒ…ç‚¹å‡»ï¼Œä¿®å¤å¤±æ•ˆé—®é¢˜ â–¼â–¼â–¼
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // 1. æ‰¾åˆ°è¢«ç‚¹å‡»çš„çº¢åŒ…å¡ç‰‡
            const packetCard = e.target.closest('.red-packet-card');
            if (!packetCard) return; // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯çº¢åŒ…ï¼Œå°±ä»€ä¹ˆä¹Ÿä¸åš
        
            // 2. ä»çº¢åŒ…å¡ç‰‡çš„çˆ¶çº§.message-bubbleè·å–æ—¶é—´æˆ³
            const messageBubble = packetCard.closest('.message-bubble');
            if (!messageBubble || !messageBubble.dataset.timestamp) return;
        
            // 3. è°ƒç”¨æˆ‘ä»¬ç°æœ‰çš„å¤„ç†å‡½æ•°
            const timestamp = parseInt(messageBubble.dataset.timestamp);
            handlePacketClick(timestamp);
        });
        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        // åœ¨è¾“å…¥æ¡†å·¥å…·æ æ·»åŠ æŒ‰é’®
        document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);
        
        // æŠ•ç¥¨åˆ›å»ºæ¨¡æ€æ¡†çš„æŒ‰é’®
        document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
        document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
            document.getElementById('create-poll-modal').classList.remove('visible');
        });
        document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);
        
        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æŠ•ç¥¨å¡ç‰‡å†…çš„æ‰€æœ‰ç‚¹å‡»äº‹ä»¶
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            const pollCard = e.target.closest('.poll-card');
            if (!pollCard) return;
        
            const timestamp = parseInt(pollCard.dataset.pollTimestamp);
            if (isNaN(timestamp)) return;
            
            // ç‚¹å‡»äº†é€‰é¡¹
            const optionItem = e.target.closest('.poll-option-item');
            if (optionItem && !pollCard.classList.contains('closed')) {
                handleUserVote(timestamp, optionItem.dataset.option);
                return;
            }
            
            // ç‚¹å‡»äº†åŠ¨ä½œæŒ‰é’®ï¼ˆç»“æŸæŠ•ç¥¨/æŸ¥çœ‹ç»“æœï¼‰
            const actionBtn = e.target.closest('.poll-action-btn');
            if (actionBtn) {
                if (pollCard.classList.contains('closed')) {
                    showPollResults(timestamp);
                } else {
                    endPoll(timestamp);
                }
                return;
            }
        
            // å¦‚æœæ˜¯å·²ç»“æŸçš„æŠ•ç¥¨ï¼Œç‚¹å‡»å¡ç‰‡ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥æŸ¥çœ‹ç»“æœ
            if (pollCard.classList.contains('closed')) {
                showPollResults(timestamp);
            }
        });
        // â–²â–²â–² æ–°äº‹ä»¶ç›‘å¬å™¨ç²˜è´´ç»“æŸ â–²â–²â–²
        
          // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒåº“åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        document.getElementById('manage-ai-avatar-library-btn').addEventListener('click', openAiAvatarLibraryModal);
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºæ‰¹é‡å¯¼å…¥æŒ‰é’®ç»‘å®šäº‹ä»¶ â–¼â–¼â–¼
        // ç»‘å®šAIå¤´åƒåº“çš„â€œæ‰¹é‡â€æŒ‰é’®
        document.getElementById('add-ai-avatar-batch-btn').addEventListener('click', () => openBatchImportModal('ai'));
        
        // ç»‘å®šç¾¤å¤´åƒåº“çš„â€œæ‰¹é‡â€æŒ‰é’®
        document.getElementById('add-group-avatar-batch-btn').addEventListener('click', () => openBatchImportModal('group'));
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™æ•´å—ä»£ç ã€‘æ›¿æ¢æ—§çš„ add-ai-avatar-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        // ç»‘å®šâ€œURLâ€æŒ‰é’®ï¼Œè°ƒç”¨æˆ‘ä»¬åˆšåˆšé‡å‘½åçš„å‡½æ•°
        document.getElementById('add-ai-avatar-url-btn').addEventListener('click', addAvatarToLibraryFromURL);
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ç»‘å®šâ€œä¸Šä¼ â€æŒ‰é’®ï¼Œè§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨
        document.getElementById('add-ai-avatar-upload-btn').addEventListener('click', () => {
            document.getElementById('ai-avatar-upload-input').click();
        });
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¸ºæ–‡ä»¶é€‰æ‹©å™¨ç»‘å®š change äº‹ä»¶ï¼Œè¿™æ˜¯å¤„ç†ä¸Šä¼ çš„æ ¸å¿ƒå…¥å£
        document.getElementById('ai-avatar-upload-input').addEventListener('change', handleLocalAvatarUpload);
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        document.getElementById('close-ai-avatar-library-btn').addEventListener('click', closeAiAvatarLibraryModal);
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤å¤´åƒåº“åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        document.getElementById('manage-group-avatar-library-btn').addEventListener('click', openGroupAvatarLibraryModal);
        // â–¼â–¼â–¼ ã€è¯·ç”¨è¿™æ•´å—ä»£ç ã€‘æ›¿æ¢æ—§çš„ add-group-avatar-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        
        // ç»‘å®šâ€œURLâ€æŒ‰é’®ï¼Œè°ƒç”¨æˆ‘ä»¬åˆšåˆšé‡å‘½åçš„å‡½æ•°
        document.getElementById('add-group-avatar-url-btn').addEventListener('click', addAvatarToGroupLibraryFromURL);
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ç»‘å®šâ€œä¸Šä¼ â€æŒ‰é’®ï¼Œè§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨
        document.getElementById('add-group-avatar-upload-btn').addEventListener('click', () => {
            document.getElementById('group-avatar-upload-input').click();
        });
        
        // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¸ºæ–‡ä»¶é€‰æ‹©å™¨ç»‘å®š change äº‹ä»¶ï¼Œè¿™æ˜¯å¤„ç†ä¸Šä¼ çš„æ ¸å¿ƒå…¥å£
        document.getElementById('group-avatar-upload-input').addEventListener('change', handleLocalGroupAvatarUpload);
        
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        document.getElementById('close-group-avatar-library-btn').addEventListener('click', closeGroupAvatarLibraryModal);
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬åŒºåŸŸï¼Œç²˜è´´è¿™æ®µã€æ–°ä»£ç ã€‘â–¼â–¼â–¼
// ä¸º EPhone å›¾æ ‡è®¾ç½®ç½‘æ ¼ç»‘å®šäº‹ä»¶å§”æ‰˜
document.getElementById('icon-settings-grid').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (iconId) {
            handleIconChange(iconId, 'ephone', item);
        }
    }
});
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„æœ«å°¾ï¼Œç²˜è´´è¿™æ®µã€å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ã€‘ â–¼â–¼â–¼
        
            document.getElementById('chat-messages').addEventListener('click', (e) => {
                // ä½¿ç”¨ .closest() å‘ä¸ŠæŸ¥æ‰¾è¢«ç‚¹å‡»çš„å¡ç‰‡
                const linkCard = e.target.closest('.link-share-card');
                if (linkCard) {
                    const timestamp = parseInt(linkCard.dataset.timestamp);
                    if (!isNaN(timestamp)) {
                        openBrowser(timestamp); // è°ƒç”¨æˆ‘ä»¬çš„å‡½æ•°
                    }
                }
            });
        
            // æµè§ˆå™¨è¿”å›æŒ‰é’®çš„äº‹ä»¶ç›‘å¬ï¼Œç¡®ä¿å®ƒåªç»‘å®šä¸€æ¬¡
            document.getElementById('browser-back-btn').addEventListener('click', () => {
                showScreen('chat-interface-screen');
            });
        
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€æ–°ä»£ç å—ã€‘æ›¿æ¢æ—§çš„ qzoneStickerPanelState.panelEl.addEventListener â–¼â–¼â–¼
        qzoneStickerPanelState.panelEl.addEventListener('click', async (e) => {
            const stickerItem = e.target.closest('.sticker-item');
            if (stickerItem && qzoneStickerPanelState.activePostId !== null) {
                // ä»èƒŒæ™¯å›¾ç‰‡æ ·å¼ä¸­æå–URL
                const stickerUrl = stickerItem.style.backgroundImage.slice(5, -2);
                
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ®URLä»å…¨å±€è¡¨æƒ…çŠ¶æ€ä¸­æ‰¾åˆ°å®Œæ•´çš„è¡¨æƒ…å¯¹è±¡
                const stickerObject = state.userStickers.find(s => s.url === stickerUrl);
        
                if (stickerObject) {
                    // å°†å®Œæ•´çš„è¡¨æƒ…å¯¹è±¡ä¼ é€’ç»™å¤„ç†å‡½æ•°
                    await sendQzoneStickerComment(qzoneStickerPanelState.activePostId, stickerObject);
                } else {
                    console.warn("åœ¨åŠ¨æ€è¯„è®ºåŒºç‚¹å‡»äº†è¡¨æƒ…ï¼Œä½†åœ¨è¡¨æƒ…åº“ä¸­æœªæ‰¾åˆ°å¯¹è±¡:", stickerUrl);
                }
            }
        });
        
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // ã€å…¨æ–°ã€‘å…¨å±€ç‚¹å‡»ç›‘å¬ï¼Œç”¨äºå…³é—­æ‰“å¼€çš„è¡¨æƒ…é¢æ¿
        document.addEventListener('click', (e) => {
            if (qzoneStickerPanelState.isOpen && 
                !qzoneStickerPanelState.panelEl.contains(e.target) && 
                !e.target.closest('.comment-sticker-btn')) {
                closeQzoneStickerPanel();
            }
        });
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„æœ«å°¾ï¼Œç²˜è´´è¿™æ®µã€å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ã€‘ â–¼â–¼â–¼
        
            // 1. ç»‘å®šè¾“å…¥æ¡†ä¸Šæ–¹â€œåˆ†äº«é“¾æ¥â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);
        
            // 2. ç»‘å®šæ¨¡æ€æ¡†ä¸­â€œå–æ¶ˆâ€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
                document.getElementById('share-link-modal').classList.remove('visible');
            });
        
            // 3. ç»‘å®šæ¨¡æ€æ¡†ä¸­â€œåˆ†äº«â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);
        
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        
        document.getElementById('theme-toggle-switch').addEventListener('change', toggleTheme);
        
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´ä¸‹é¢è¿™å‡ è¡Œ â–¼â–¼â–¼
        // ç»‘å®šæ¶ˆæ¯æ“ä½œèœå•ä¸­çš„â€œå¼•ç”¨â€æŒ‰é’®
        document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);
        
        // ç»‘å®šå›å¤é¢„è§ˆæ ä¸­çš„â€œå–æ¶ˆâ€æŒ‰é’®
        document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);
        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ è¿™è¡Œä»£ç  â–¼â–¼â–¼
        document.getElementById('share-location-btn').addEventListener('click', sendLocationShare);
        // åœ¨ä½ çš„ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ...
        
        // â–¼â–¼â–¼ ç”¨è¿™æ®µä»£ç æ›¿æ¢æ—§çš„è½¬è´¦å¡ç‰‡ç‚¹å‡»äº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // 1. å‘ä¸ŠæŸ¥æ‰¾è¢«ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªæ¶ˆæ¯æ°”æ³¡å†…
            const bubble = e.target.closest('.message-bubble');
            if (!bubble) return; // å¦‚æœä¸åœ¨ï¼Œå°±é€€å‡º
        
            // 2. ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œæ·»åŠ ä¸¥æ ¼çš„ç­›é€‰æ¡ä»¶
            // å¿…é¡»æ˜¯ AI çš„æ¶ˆæ¯ (.ai)
            // å¿…é¡»æ˜¯è½¬è´¦ç±»å‹ (.is-transfer)
            // å¿…é¡»æ˜¯æˆ‘ä»¬æ ‡è®°ä¸ºâ€œå¾…å¤„ç†â€çš„ (data-status="pending")
            if (bubble.classList.contains('ai') && 
                bubble.classList.contains('is-transfer') && 
                bubble.dataset.status === 'pending') {
                
                // 3. åªæœ‰æ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼Œæ‰æ‰§è¡Œåç»­é€»è¾‘
                const timestamp = parseInt(bubble.dataset.timestamp);
                if (!isNaN(timestamp)) {
                    showTransferActionModal(timestamp);
                }
            }
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        // åœ¨ init() çš„äº‹ä»¶ç›‘å¬åŒºåŸŸæ·»åŠ 
        document.getElementById('transfer-action-accept').addEventListener('click', () => handleUserTransferResponse('accepted'));
        document.getElementById('transfer-action-decline').addEventListener('click', () => handleUserTransferResponse('declined'));
        document.getElementById('transfer-action-cancel').addEventListener('click', hideTransferActionModal);
        
        // â–¼â–¼â–¼ ç”¨è¿™æ®µã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„é€šè¯è®°å½•äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        
        document.getElementById('chat-list-title').addEventListener('click', renderCallHistoryScreen);
        
        // 2. ç»‘å®šé€šè¯è®°å½•é¡µé¢çš„â€œè¿”å›â€æŒ‰é’®
        document.getElementById('call-history-back-btn').addEventListener('click', () => {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿”å›åˆ°èŠå¤©åˆ—è¡¨é¡µé¢ï¼Œè€Œä¸æ˜¯èŠå¤©ç•Œé¢
            showScreen('chat-list-screen');
        });
        
        // 3. ç›‘å¬å¡ç‰‡ç‚¹å‡»çš„é€»è¾‘ä¿æŒä¸å˜
        document.getElementById('call-history-list').addEventListener('click', (e) => {
            const card = e.target.closest('.call-record-card');
            if (card && card.dataset.recordId) {
                showCallTranscript(parseInt(card.dataset.recordId));
            }
        });
        
        // 4. å…³é—­è¯¦æƒ…å¼¹çª—çš„é€»è¾‘ä¿æŒä¸å˜
document.getElementById('close-call-transcript-btn').addEventListener('click', () => {
    document.getElementById('call-transcript-modal').classList.remove('visible');
});
        
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // 1. æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯è¯­éŸ³æ¡
            const voiceBody = e.target.closest('.voice-message-body');
            if (!voiceBody) return;
        
            // 2. æ‰¾åˆ°ç›¸å…³çš„DOMå…ƒç´ 
            const bubble = voiceBody.closest('.message-bubble');
            if (!bubble) return;
            
            const spinner = voiceBody.querySelector('.loading-spinner');
            const transcriptEl = bubble.querySelector('.voice-transcript');
        
            // å¦‚æœæ­£åœ¨åŠ è½½ä¸­ï¼Œåˆ™ä¸å“åº”ç‚¹å‡»
            if (bubble.dataset.state === 'loading') {
                return;
            }
        
            // 3. å¦‚æœæ–‡å­—å·²ç»å±•å¼€ï¼Œåˆ™æ”¶èµ·
            if (bubble.dataset.state === 'expanded') {
                transcriptEl.style.display = 'none';
                bubble.dataset.state = 'collapsed';
            } 
            // 4. å¦‚æœæ˜¯æ”¶èµ·çŠ¶æ€ï¼Œåˆ™å¼€å§‹â€œè½¬å½•â€æµç¨‹
            else {
                bubble.dataset.state = 'loading'; // è¿›å…¥åŠ è½½çŠ¶æ€
                spinner.style.display = 'block';   // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        
                // æ¨¡æ‹Ÿ1.5ç§’çš„è¯­éŸ³è¯†åˆ«è¿‡ç¨‹
                setTimeout(() => {
                    // æ£€æŸ¥æ­¤æ—¶å…ƒç´ æ˜¯å¦è¿˜å­˜åœ¨ï¼ˆå¯èƒ½ç”¨æˆ·å·²ç»åˆ‡æ¢äº†èŠå¤©ï¼‰
                    if (document.body.contains(bubble)) {
                        const voiceText = bubble.dataset.voiceText || '(æ— æ³•è¯†åˆ«)';
                        transcriptEl.textContent = voiceText; // å¡«å……æ–‡å­—
                        
                        spinner.style.display = 'none';      // éšè—åŠ è½½åŠ¨ç”»
                        transcriptEl.style.display = 'block';// æ˜¾ç¤ºæ–‡å­—
                        bubble.dataset.state = 'expanded';     // è¿›å…¥å±•å¼€çŠ¶æ€
                    }
                }, 1500);
            }
        });
        
        document.getElementById('chat-header-status').addEventListener('click', handleEditStatusClick);
        
        // åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
        document.getElementById('selection-share-btn').addEventListener('click', () => {
            if (selectedMessages.size > 0) {
                openShareTargetPicker(); // æ‰“å¼€æˆ‘ä»¬å³å°†åˆ›å»ºçš„ç›®æ ‡é€‰æ‹©å™¨
            }
        });
        document.getElementById('selection-screenshot-btn').addEventListener('click', handleLongScreenshot);
        // åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
        document.getElementById('confirm-share-target-btn').addEventListener('click', async () => {
            const sourceChat = state.chats[state.activeChatId];
            const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
                                           .map(cb => cb.dataset.chatId);
        
            if (selectedTargetIds.length === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ†äº«çš„èŠå¤©ã€‚");
                return;
            }
        
            // 1. æ‰“åŒ…èŠå¤©è®°å½•
            const sharedHistory = [];
            const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
            for (const timestamp of sortedTimestamps) {
                const msg = sourceChat.history.find(m => m.timestamp === timestamp);
                if (msg) {
                    sharedHistory.push(msg);
                }
            }
            
            // 2. åˆ›å»ºåˆ†äº«å¡ç‰‡æ¶ˆæ¯å¯¹è±¡
            const shareCardMessage = {
                role: 'user',
                senderName: sourceChat.isGroup ? (sourceChat.settings.myNickname || 'æˆ‘') : 'æˆ‘',
                type: 'share_card',
                timestamp: Date.now(),
                payload: {
                    sourceChatName: sourceChat.name,
                    title: `æ¥è‡ªâ€œ${sourceChat.name}â€çš„èŠå¤©è®°å½•`,
                    sharedHistory: sharedHistory
                }
            };
        
            // 3. å¾ªç¯å‘é€åˆ°æ‰€æœ‰ç›®æ ‡èŠå¤©
            for (const targetId of selectedTargetIds) {
                const targetChat = state.chats[targetId];
                if (targetChat) {
                    targetChat.history.push(shareCardMessage);
                    await db.chats.put(targetChat);
                }
            }
            
            // 4. æ”¶å°¾å·¥ä½œ
            document.getElementById('share-target-modal').classList.remove('visible');
            exitSelectionMode(); // é€€å‡ºå¤šé€‰æ¨¡å¼
            await showCustomAlert("åˆ†äº«æˆåŠŸ", `èŠå¤©è®°å½•å·²æˆåŠŸåˆ†äº«åˆ° ${selectedTargetIds.length} ä¸ªä¼šè¯ä¸­ã€‚`);
            renderChatList(); // åˆ·æ–°åˆ—è¡¨ï¼Œå¯èƒ½ä¼šæœ‰æ–°æ¶ˆæ¯æç¤º
        });
        
        // ç»‘å®šå–æ¶ˆæŒ‰é’®
        document.getElementById('cancel-share-target-btn').addEventListener('click', () => {
            document.getElementById('share-target-modal').classList.remove('visible');
        });
        
        // åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // ...ä½ å·²æœ‰çš„å…¶ä»–ç‚¹å‡»äº‹ä»¶é€»è¾‘...
        
            // æ–°å¢é€»è¾‘ï¼šå¤„ç†åˆ†äº«å¡ç‰‡çš„ç‚¹å‡»
            const shareCard = e.target.closest('.link-share-card[data-timestamp]');
            if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
                const timestamp = parseInt(shareCard.dataset.timestamp);
                openSharedHistoryViewer(timestamp);
            }
        });
        
        // ç»‘å®šæŸ¥çœ‹å™¨çš„å…³é—­æŒ‰é’®
        document.getElementById('close-shared-history-viewer-btn').addEventListener('click', () => {
            document.getElementById('shared-history-viewer-modal').classList.remove('visible');
        });
        
        // åˆ›å»ºæ–°å‡½æ•°æ¥å¤„ç†æ¸²æŸ“é€»è¾‘
        function openSharedHistoryViewer(timestamp) {
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (!message || message.type !== 'share_card') return;
        
            const viewerModal = document.getElementById('shared-history-viewer-modal');
            const viewerTitle = document.getElementById('shared-history-viewer-title');
            const viewerContent = document.getElementById('shared-history-viewer-content');
        
            viewerTitle.textContent = message.payload.title;
            viewerContent.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
        
            // ã€æ ¸å¿ƒã€‘å¤ç”¨ createMessageElement æ¥æ¸²æŸ“æ¯ä¸€æ¡è¢«åˆ†äº«çš„æ¶ˆæ¯
            message.payload.sharedHistory.forEach(sharedMsg => {
                // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ sourceChat å¯¹è±¡ï¼Œä»¥ç¡®ä¿å¤´åƒã€æ˜µç§°ç­‰æ­£ç¡®
                const sourceChat = Object.values(state.chats).find(c => c.name === message.payload.sourceChatName) || chat;
                const bubbleEl = createMessageElement(sharedMsg, sourceChat);
                if (bubbleEl) {
                    viewerContent.appendChild(bubbleEl);
                }
            });
        
            viewerModal.classList.add('visible');
        }
        
        audioPlayer.addEventListener('timeupdate', updateMusicProgressBar);
        
        audioPlayer.addEventListener('pause', () => { 
            if(musicState.isActive) { 
                musicState.isPlaying = false; 
                updatePlayerUI(); 
            } 
        });
        audioPlayer.addEventListener('play', () => { 
            if(musicState.isActive) { 
                musicState.isPlaying = true; 
                updatePlayerUI(); 
            } 
        });
        
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œæ›¿æ¢æ—§çš„ playlist-body ç›‘å¬å™¨ â–¼â–¼â–¼
        
        document.getElementById('playlist-body').addEventListener('click', async (e) => {
            const target = e.target;
            
            // ç‚¹å‡»â€œè¯â€æŒ‰é’®
            const lyricsBtn = target.closest('.lyrics-btn');
            if (lyricsBtn) {
                const index = parseInt(lyricsBtn.dataset.index);
                if (isNaN(index)) return;

                // ã€æ ¸å¿ƒä¿®å¤1ã€‘è°ƒç”¨å‡½æ•°å¹¶ç­‰å¾…ç”¨æˆ·ä¸Šä¼ æˆ–ç²˜è´´æ­Œè¯
                const newLrcContent = await handleManualLrcImport(index);

                // ã€æ ¸å¿ƒä¿®å¤2ã€‘å¦‚æœç”¨æˆ·æ²¡æœ‰å–æ¶ˆï¼Œå¹¶ä¸”æˆ‘ä»¬å¾—åˆ°äº†æ­Œè¯å†…å®¹
                if (newLrcContent !== null) {
                    // a. æ›´æ–°å†…å­˜ä¸­çš„æ­Œæ›²æ•°æ®
                    musicState.playlist[index].lrcContent = newLrcContent;
                    
                    // b. å°†æ›´æ–°åçš„æ•´ä¸ªæ’­æ”¾åˆ—è¡¨ä¿å­˜åˆ°æ•°æ®åº“
                    await saveGlobalPlaylist();
                    
                    // c. å¦‚æœå½“å‰æ­£åœ¨æ’­æ”¾çš„å°±æ˜¯è¿™é¦–æ­Œï¼Œç«‹å³åˆ·æ–°æ­Œè¯æ˜¾ç¤º
                    if (musicState.currentIndex === index) {
                        musicState.parsedLyrics = parseLRC(newLrcContent);
                        renderLyrics(); // é‡æ–°æ¸²æŸ“æ­Œè¯åˆ—è¡¨
                        updateLyricsUI(); // æ›´æ–°UIé«˜äº®
                    }
                    
                    // d. ç»™ç”¨æˆ·ä¸€ä¸ªæˆåŠŸçš„æç¤º
                    await showCustomAlert('æˆåŠŸ', `ã€Š${musicState.playlist[index].name}ã€‹çš„æ­Œè¯å·²æˆåŠŸä¿å­˜ï¼`);
                }
                return;
            }
        
            // ç‚¹å‡»â€œåˆ é™¤â€æŒ‰é’® (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
            const deleteBtn = target.closest('.delete-track-btn');
            if (deleteBtn) {
                const index = parseInt(deleteBtn.dataset.index);
                if (isNaN(index)) return;
                const track = musicState.playlist[index];
                const confirmed = await showCustomConfirm('åˆ é™¤æ­Œæ›²', `ç¡®å®šè¦ä»æ’­æ”¾åˆ—è¡¨ä¸­åˆ é™¤ã€Š${track.name}ã€‹å—ï¼Ÿ`);
                if (confirmed) {
                    deleteTrack(index);
                }
                return;
            }
        
            // ç‚¹å‡»æ­Œæ›²ä¿¡æ¯åŒºåŸŸ -> æ’­æ”¾æ­Œæ›² (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
            const itemInfo = target.closest('.playlist-item-info');
            if (itemInfo) {
                const item = itemInfo.closest('.playlist-item');
                const index = Array.from(item.parentElement.children).indexOf(item);
                if (index > -1) {
                    playSong(index);
                }
            }
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        document.querySelector('.progress-bar').addEventListener('click', (e) => {
            if (!audioPlayer.duration) return;
            const progressBar = e.currentTarget;
            const barWidth = progressBar.clientWidth;
            const clickX = e.offsetX;
            audioPlayer.currentTime = (clickX / barWidth) * audioPlayer.duration;
        });
        
        // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
        
        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰â€œå·²æ’¤å›æ¶ˆæ¯â€çš„ç‚¹å‡»äº‹ä»¶
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // æ£€æŸ¥è¢«ç‚¹å‡»çš„å…ƒç´ æˆ–å…¶çˆ¶å…ƒç´ æ˜¯å¦æ˜¯â€œå·²æ’¤å›â€æç¤º
// â–¼â–¼â–¼ ã€è¿™æ˜¯æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ .recalled-message-placeholder ç‚¹å‡»äº‹ä»¶é€»è¾‘ â–¼â–¼â–¼
const placeholder = e.target.closest('.recalled-message-placeholder');
if (placeholder) {
    const chat = state.chats[state.activeChatId];
    const wrapper = placeholder.closest('.message-wrapper');
    if (chat && wrapper) {
        const timestamp = parseInt(wrapper.dataset.timestamp);
        const recalledMsg = chat.history.find(m => m.timestamp === timestamp);

        if (recalledMsg && recalledMsg.recalledData) {
            let originalContentText = '';
            const recalled = recalledMsg.recalledData;

            // --- æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œæ·»åŠ å¯¹æ›´å¤šæ¶ˆæ¯ç±»å‹çš„åˆ¤æ–­ ---
            switch (recalled.originalType) {
                case 'text':
                    originalContentText = `åŸæ–‡: "${recalled.originalContent}"`;
                    break;
                case 'user_photo':
                case 'ai_image':
                case 'text_image':
                    originalContentText = `[å›¾ç‰‡/æ–‡å­—å›¾] æè¿°: "${recalled.originalContent}"`;
                    break;
                case 'voice_message':
                    originalContentText = `[è¯­éŸ³] å†…å®¹: "${recalled.originalContent}"`;
                    break;
                case 'sticker':
                    // å¯¹äºè¡¨æƒ…ï¼ŒåŒæ—¶æ˜¾ç¤ºå«ä¹‰å’Œå›¾ç‰‡URL
                    originalContentText = `[è¡¨æƒ…] å«ä¹‰: "${recalled.originalMeaning || '(æ— )'}" \n URL: ${recalled.originalContent}`;
                    break;
                case 'transfer':
                    originalContentText = `ä¸€æ¡[è½¬è´¦]æ¶ˆæ¯å·²è¢«æ’¤å›ã€‚`;
                    break;
                default:
                    // å¯¹äºå…¶ä»–æœªçŸ¥ç±»å‹ï¼Œæ˜¾ç¤ºç±»å‹å’ŒåŸå§‹å†…å®¹
                    originalContentText = `æ’¤å›äº†ä¸€æ¡[${recalled.originalType}]ç±»å‹çš„æ¶ˆæ¯ã€‚\nå†…å®¹: ${JSON.stringify(recalled.originalContent)}`;
                    break;
            }
            // --- ä¿®å¤ç»“æŸ ---

            showCustomAlert('å·²æ’¤å›çš„æ¶ˆæ¯', originalContentText);
        }
    }
}
});
        
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
        document.getElementById('manage-world-book-categories-btn').addEventListener('click', openCategoryManager);
        document.getElementById('close-category-manager-btn').addEventListener('click', () => {
            document.getElementById('world-book-category-manager-modal').classList.remove('visible');
            renderWorldBookScreen(); // å…³é—­ååˆ·æ–°ä¸»åˆ—è¡¨
        });
        document.getElementById('add-new-category-btn').addEventListener('click', addNewCategory);
        document.getElementById('existing-categories-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-group-btn')) {
                const categoryId = parseInt(e.target.dataset.id);
                deleteCategory(categoryId);
            }
        });
        // â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ï¼Œæ·»åŠ è¿™éƒ¨åˆ†ä»£ç  â–¼â–¼â–¼
        document.getElementById('repost-cancel-btn').addEventListener('click', hideRepostModal);
        document.getElementById('repost-confirm-btn').addEventListener('click', handleConfirmRepost);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        // åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾
        // ...
        // ç»‘å®šæ¶ˆæ¯æ“ä½œèœå•ä¸­çš„â€œå¼•ç”¨â€æŒ‰é’®
        document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);
        
        // ç»‘å®šå›å¤é¢„è§ˆæ ä¸­çš„â€œå–æ¶ˆâ€æŒ‰é’®
        document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);
        // ...
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        
                // ===================================================================
                // 5. å¯åŠ¨ï¼
        // åœ¨ç¬¬ 9660 è¡Œï¼ŒshowScreen('home-screen'); çš„å‰é¢ï¼Œç²˜è´´ä¸‹é¢çš„ä»£ç 
        
            // â–¼â–¼â–¼ ã€è¯·å°†è¿™æ®µå…¨æ–°çš„ä»£ç ç²˜è´´è¿›å»ã€‘ â–¼â–¼â–¼
            
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºåŠ¨æ€è¯„è®ºåŒºçš„@åŠŸèƒ½ç»‘å®šäº‹ä»¶
            document.getElementById('qzone-posts-list').addEventListener('input', (e) => {
                if (!e.target.matches('.comment-input')) return;
        
                const commentInput = e.target;
                const postContainer = commentInput.closest('.qzone-post-container');
                if (!postContainer) return;
                
                const popup = postContainer.querySelector('.at-mention-popup');
                const value = commentInput.value;
                const atMatch = value.match(/@([\p{L}\w]*)$/u);
        
                if (atMatch) {
                    const namesToMention = new Set();
                    const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
                    if (authorNickname) namesToMention.add(authorNickname);
                    postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
                        namesToMention.add(nameEl.textContent.replace(':', ''));
                    });
                    namesToMention.delete(state.qzoneSettings.nickname);
        
                    popup.innerHTML = '';
                    if (namesToMention.size > 0) {
                        const searchTerm = atMatch[1];
                        namesToMention.forEach(name => {
                            if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                                const item = document.createElement('div');
                                item.className = 'at-mention-item';
                                item.textContent = name;
                                item.addEventListener('mousedown', (evt) => {
                                    evt.preventDefault();
                                    const newText = value.substring(0, atMatch.index) + `@${name} `;
                                    commentInput.value = newText;
                                    popup.style.display = 'none';
                                    commentInput.focus();
                                });
                                popup.appendChild(item);
                            }
                        });
                        popup.style.display = popup.children.length > 0 ? 'block' : 'none';
                    } else {
                        popup.style.display = 'none';
                    }
                } else {
                    popup.style.display = 'none';
                }
            });
        
            document.getElementById('qzone-posts-list').addEventListener('focusout', (e) => {
                if (e.target.matches('.comment-input')) {
                    const postContainer = e.target.closest('.qzone-post-container');
                    if (postContainer) {
                        const popup = postContainer.querySelector('.at-mention-popup');
                        if (popup) {
                            setTimeout(() => { popup.style.display = 'none'; }, 200);
                        }
                    }
                }
            });
        
            // â–²â–²â–² ã€æ–°ä»£ç ç²˜è´´ç»“æŸã€‘ â–²â–²â–²  
        // â–¼â–¼â–¼ æŠŠä¸‹é¢è¿™æ®µæ–°ä»£ç å®Œæ•´ç²˜è´´åˆ° showScreen('home-screen'); çš„å‰é¢ â–¼â–¼â–¼
        
        // ã€å…¨æ–°ã€‘ä¸ºã€ä¸»èŠå¤©è¾“å…¥æ¡†ã€‘æ·»åŠ @åŠŸèƒ½
        const chatInputForMention = document.getElementById('chat-input');
        const chatMentionPopup = document.getElementById('chat-at-mention-popup');
        
        chatInputForMention.addEventListener('input', () => {
            // 1. é¦–å…ˆï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦åœ¨ç¾¤èŠä¸­
            if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) {
                chatMentionPopup.style.display = 'none';
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            const value = chatInputForMention.value;
            const atMatch = value.match(/@([\p{L}\w]*)$/u);
        
            if (atMatch) {
                // 2. æ”¶é›†ç¾¤æˆå‘˜åå• (æ’é™¤è‡ªå·±)
                const myNickname = chat.settings.myNickname || 'æˆ‘';
                const namesToMention = chat.members
                    .map(member => member.groupNickname)
                    .filter(name => name !== myNickname);
        
                chatMentionPopup.innerHTML = '';
                if (namesToMention.length > 0) {
                    const searchTerm = atMatch[1];
                    // 3. ç­›é€‰å¹¶ç”Ÿæˆåˆ—è¡¨
                    namesToMention.forEach(name => {
                        if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                            const item = document.createElement('div');
                            item.className = 'at-mention-item';
                            item.textContent = name;
                            // 4. ç»‘å®šç‚¹å‡»äº‹ä»¶
                            item.addEventListener('mousedown', (e) => {
                                e.preventDefault();
                                const newText = value.substring(0, atMatch.index) + `@${name} `;
                                chatInputForMention.value = newText;
                                chatMentionPopup.style.display = 'none';
                                chatInputForMention.focus();
                            });
                            chatMentionPopup.appendChild(item);
                        }
                    });
                    // 5. æ˜¾ç¤ºæˆ–éšè—å¼¹çª—
                    chatMentionPopup.style.display = chatMentionPopup.children.length > 0 ? 'block' : 'none';
                } else {
                    chatMentionPopup.style.display = 'none';
                }
            } else {
                chatMentionPopup.style.display = 'none';
            }
        });
        
        // å½“è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶ï¼Œéšè—å¼¹çª—
        chatInputForMention.addEventListener('blur', () => {
            setTimeout(() => { chatMentionPopup.style.display = 'none'; }, 200);
        });
        // â–²â–²â–² æ–°ä»£ç ç²˜è´´åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²     
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ–°ç‰ˆç¾¤å…¬å‘Šäº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        document.getElementById('publish-to-announcement-btn').addEventListener('click', publishToAnnouncementBoard);
        document.getElementById('show-announcement-board-btn').addEventListener('click', showAnnouncementBoard);
        document.getElementById('close-announcement-board-btn').addEventListener('click', () => {
            document.getElementById('announcement-board-modal').classList.remove('visible');
        });
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²  
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å…¬å‘Šæ¿å†…éƒ¨äº‹ä»¶å§”æ‰˜ä¸æ“ä½œèœå•äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        document.getElementById('announcement-board-content').addEventListener('click', (e) => {
            if (e.target.classList.contains('announcement-item-actions')) {
                const annoId = e.target.dataset.annoId;
                if (annoId) {
                    showAnnouncementActions(annoId);
                }
            }
        });
        
        document.getElementById('announcement-action-pin').addEventListener('click', handlePinAnnouncement);
        document.getElementById('announcement-action-delete').addEventListener('click', handleDeleteAnnouncement);
        document.getElementById('announcement-action-cancel').addEventListener('click', () => {
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        });
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²   
                    // â–¼â–¼â–¼ æŠŠæ–°ä»£ç å®Œæ•´ç²˜è´´åœ¨è¿™é‡Œ â–¼â–¼â–¼
                    document.getElementById('reset-global-css-btn').addEventListener('click', () => {
                        document.getElementById('global-css-input').value = '';
                        // (å¯é€‰) å¦‚æœå¸Œæœ›ç‚¹å‡»é‡ç½®åç«‹åˆ»çœ‹åˆ°æ•ˆæœï¼Œå¯ä»¥åŠ ä¸Šä¸‹é¢è¿™è¡Œ
                        // applyGlobalCss('');
                    });
        // â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªå…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œæ›¿æ¢æ—§çš„é•¿æœŸè®°å¿†åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        // èŠå¤©ç•Œé¢é¡¶éƒ¨æ–°æŒ‰é’® -> æ‰“å¼€å…¨å±é¡µé¢
        document.getElementById('open-memory-screen-btn').addEventListener('click', openLongTermMemoryScreen);
        
        // é•¿æœŸè®°å¿†é¡µé¢è¿”å›æŒ‰é’® -> è¿”å›èŠå¤©ç•Œé¢
        document.getElementById('memory-screen-back-btn').addEventListener('click', () => {
            showScreen('chat-interface-screen');
        });
        
        // é•¿æœŸè®°å¿†é¡µé¢é¡¶éƒ¨â€œ+â€æŒ‰é’® -> æ‰‹åŠ¨æ·»åŠ 
        document.getElementById('add-manual-memory-btn-header').addEventListener('click', handleAddManualMemory);
        
        // é•¿æœŸè®°å¿†é¡µé¢é¡¶éƒ¨â€œæ€»ç»“â€æŒ‰é’® -> æ‰‹åŠ¨æ€»ç»“
        document.getElementById('summarize-recent-btn-header').addEventListener('click', handleManualSummary);
        
        // ã€ã€ã€æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œï¼ã€‘ã€‘ã€‘
document.getElementById('memory-list-container').addEventListener('click', (e) => {
    const editBtn = e.target.closest('.edit-memory-btn');
    if (editBtn) {
        handleEditMemory(editBtn.dataset.authorId, parseInt(editBtn.dataset.memoryTimestamp));
        return;
    }
    const deleteBtn = e.target.closest('.delete-memory-btn');
    if (deleteBtn) {
        handleDeleteMemory(deleteBtn.dataset.authorId, parseInt(deleteBtn.dataset.memoryTimestamp));
        return;
    }
});
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘äº”å­æ£‹åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('gomoku-btn').addEventListener('click', toggleGomokuBoard);
        document.getElementById('close-gomoku-btn').addEventListener('click', closeGomokuBoard);
        
        const gomokuCanvas = document.getElementById('gomoku-board');
        gomokuCanvas.addEventListener('mousemove', handleBoardHover);
        gomokuCanvas.addEventListener('mouseout', () => renderGomokuBoard(state.activeChatId)); // Clear hover on exit
        gomokuCanvas.addEventListener('click', handleBoardClick);
        // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€è¿™æ˜¯ä¿®å¤ä»£ç ã€‘è¯·å°†è¿™æ®µä»£ç ç²˜è´´åˆ° init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
        document.getElementById('add-countdown-btn').addEventListener('click', () => {
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('countdown-title-input').value = '';
            document.getElementById('countdown-date-input').value = '';
            // æ˜¾ç¤ºæ–°å»ºçº¦å®šå¼¹çª—
            document.getElementById('create-countdown-modal').classList.add('visible');
        });
        
        // ä¸ºæ–°å»ºçº¦å®šå¼¹çª—çš„â€œå–æ¶ˆâ€æŒ‰é’®ä¹Ÿç»‘å®šäº‹ä»¶
        document.getElementById('cancel-create-countdown-btn').addEventListener('click', () => {
            document.getElementById('create-countdown-modal').classList.remove('visible');
        });
        // â–²â–²â–² ä¿®å¤ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        
                    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯æ¶ˆæ¯æ“ä½œäº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        document.getElementById('edit-call-message-btn').addEventListener('click', openCallMessageEditor);
        document.getElementById('delete-call-message-btn').addEventListener('click', deleteCallMessage);
        document.getElementById('cancel-call-message-action-btn').addEventListener('click', hideCallMessageActions);
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯¼æ¼”æ¨¡å¼äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        document.getElementById('edit-last-response-btn').addEventListener('click', openAiResponseEditor);
        document.getElementById('cancel-ai-response-editor-btn').addEventListener('click', () => {
            document.getElementById('ai-response-editor-modal').classList.remove('visible');
        });
        document.getElementById('save-ai-response-editor-btn').addEventListener('click', saveEditedAiResponse);
        document.getElementById('add-ai-response-block-btn').addEventListener('click', () => {
            // ç‚¹å‡»æ·»åŠ æŒ‰é’®æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„ã€å¸¦æ¨¡æ¿çš„ç¼–è¾‘å—
            const container = document.getElementById('ai-response-editor-container');
            const newBlock = createAiResponseEditorBlock('{\n  "type": "text",\n  "content": "åœ¨è¿™é‡Œè¾“å…¥æ–°æ¶ˆæ¯..."\n}');
            container.appendChild(newBlock);
            newBlock.querySelector('textarea').focus();
        });
        // â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæˆ‘çš„â€å¤´åƒåº“åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
        document.getElementById('manage-my-avatar-library-btn').addEventListener('click', openMyAvatarLibraryModal);
        document.getElementById('close-my-avatar-library-btn').addEventListener('click', closeMyAvatarLibraryModal);
        document.getElementById('add-my-avatar-url-btn').addEventListener('click', addAvatarToMyLibraryFromURL);
        document.getElementById('add-my-avatar-upload-btn').addEventListener('click', () => {
            document.getElementById('my-avatar-upload-input').click();
        });
        document.getElementById('my-avatar-upload-input').addEventListener('change', handleLocalMyAvatarUpload);
        document.getElementById('add-my-avatar-batch-btn').addEventListener('click', async () => {
            const placeholderText = `è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç²˜è´´ï¼Œä¸€è¡Œä¸€ä¸ªï¼š\n\nç„¦è™‘ 2a9wte.jpeg\nå¤§æƒŠå¤±è‰² or8qf4.png\næ²¡æœ‰çµæ„Ÿ njwujh.jpeg`;
            const pastedText = await showCustomPrompt('æ‰¹é‡å¯¼å…¥å¤´åƒ', placeholderText, '', 'textarea');
            if (pastedText && pastedText.trim()) {
                await handleBatchImportForMyAvatar(pastedText);
            }
        });
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è´­ç‰©åŠŸèƒ½äº‹ä»¶ç»‘å®š (V6.0 - æ”¯æŒæŒ‡å®šæ”¶ç¤¼äºº) â–¼â–¼â–¼
        document.getElementById('open-shopping-btn').addEventListener('click', openShoppingScreen);
        document.getElementById('shopping-back-btn').addEventListener('click', () => showScreen('chat-interface-screen'));
        document.getElementById('go-to-cart-btn').addEventListener('click', openCartScreen);
        document.getElementById('cart-back-btn').addEventListener('click', openShoppingScreen);
        document.getElementById('checkout-btn').addEventListener('click', handleCheckout);
        document.getElementById('close-receipt-btn').addEventListener('click', () => {
            document.getElementById('gift-receipt-modal').classList.remove('visible');
        });
        
        // "ç®¡ç†"æŒ‰é’®
        document.getElementById('manage-products-btn').addEventListener('click', () => {
            isProductManagementMode = !isProductManagementMode;
            const btn = document.getElementById('manage-products-btn');
            btn.style.color = isProductManagementMode ? 'var(--accent-color)' : 'var(--text-primary)';
            if (!isProductManagementMode && document.querySelectorAll('#product-grid .product-item').length === 0) {
                openProductEditor(null);
            }
            renderShoppingProducts();
        });
        
        // â€œæ·»åŠ å•†å“â€æŒ‰é’®
        document.getElementById('add-new-product-btn').addEventListener('click', () => {
            if (isProductManagementMode) {
                openProductEditor(null);
            } else {
                alert("è¯·å…ˆç‚¹å‡»æ‰³æ‰‹å›¾æ ‡è¿›å…¥ç®¡ç†æ¨¡å¼ï¼Œæ‰èƒ½æ·»åŠ æ–°å•†å“ã€‚");
            }
        });
        
        // å•†å“åˆ—è¡¨äº‹ä»¶å§”æ‰˜
        document.getElementById('product-grid').addEventListener('click', async e => {
            const productItem = e.target.closest('.product-item');
            if (!productItem) return;
            const productId = parseInt(productItem.dataset.id);
        
            if (e.target.classList.contains('edit-product-btn')) {
                openProductEditor(productId);
            } else if (e.target.classList.contains('delete-product-btn')) {
                deleteProduct(productId);
            } else if (e.target.classList.contains('add-to-cart-btn')) {
                await addToCart(productId);
                await showCustomAlert('æˆåŠŸ', 'å·²æˆåŠŸåŠ å…¥è´­ç‰©è½¦ï¼');
            }
        });
        
        // è´­ç‰©è½¦åˆ—è¡¨äº‹ä»¶å§”æ‰˜
        document.getElementById('cart-items-list').addEventListener('click', e => {
            const target = e.target;
            if (target.classList.contains('decrease-qty-btn')) {
                updateCartItemQuantity(parseInt(target.dataset.id), -1);
            }
            if (target.classList.contains('increase-qty-btn')) {
                updateCartItemQuantity(parseInt(target.dataset.id), 1);
            }
            if (target.classList.contains('cart-item-checkbox')) {
                updateCartTotal();
            }
        });
        
        // è´­ç‰©è½¦æ¸…ç©ºæŒ‰é’®
        document.getElementById('clear-cart-btn').addEventListener('click', async () => {
            if (shoppingCart.length === 0) return;
            const confirmed = await showCustomConfirm('æ¸…ç©ºè´­ç‰©è½¦', 'ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦ä¸­çš„æ‰€æœ‰å•†å“å—ï¼Ÿ');
            if (confirmed) {
                shoppingCart = [];
                updateCartCount();
                renderCartItems();
            }
        });
        
        // è´­ç‰©è½¦å…¨é€‰
        document.getElementById('select-all-cart-items').addEventListener('change', function(e) {
            document.querySelectorAll('.cart-item-checkbox').forEach(cb => {
                cb.checked = e.target.checked;
            });
            updateCartTotal();
        });
        
        // å•†å“ç¼–è¾‘å™¨å¼¹çª—æŒ‰é’®
        document.getElementById('cancel-product-editor-btn').addEventListener('click', () => {
            document.getElementById('product-editor-modal').classList.remove('visible');
        });
        document.getElementById('save-product-btn').addEventListener('click', saveProduct);
        document.getElementById('product-image-input').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (re) => { document.getElementById('product-image-preview').src = re.target.result; };
                reader.readAsDataURL(file);
            }
        });
        
        // èŠå¤©ç•Œé¢ç¤¼ç‰©å¡ç‰‡ç‚¹å‡»äº‹ä»¶
        document.getElementById('chat-messages').addEventListener('click', e => {
            const giftCard = e.target.closest('.gift-card');
            if (giftCard) {
                const bubble = giftCard.closest('.message-bubble');
                if (bubble) {
                    showGiftReceipt(parseInt(bubble.dataset.timestamp));
                }
            }
        });
        
        // ã€å…¨æ–°ã€‘ç¤¼ç‰©æ¥æ”¶äººé€‰æ‹©å¼¹çª—çš„äº‹ä»¶ç»‘å®š
        document.getElementById('cancel-gift-recipient-btn').addEventListener('click', () => {
            document.getElementById('gift-recipient-modal').classList.remove('visible');
        });
        
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²ä¿®å¤ã€‘çš„æ–°äº‹ä»¶ç›‘å¬å™¨æ›¿æ¢æ—§çš„ 'confirm-gift-recipient-btn' ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('confirm-gift-recipient-btn').addEventListener('click', async () => {
            // æ­¥éª¤ 1: (ä¿æŒä¸å˜) è·å–é€‰ä¸­çš„æ”¶ç¤¼äºº
            const selectedRecipients = Array.from(document.querySelectorAll('#gift-recipient-list .contact-picker-item.selected'))
                .map(item => item.dataset.recipientName);
            
            if (selectedRecipients.length === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä½æ”¶ç¤¼äººã€‚");
                return;
            }
            
            // æ­¥éª¤ 2: ã€ã€ã€æ ¸å¿ƒä¿®å¤ã€‘ã€‘ã€‘ åœ¨è¿™é‡Œï¼Œé‡æ–°ä»è´­ç‰©è½¦è·å–ä¸€æ¬¡é€‰ä¸­çš„å•†å“
            const selectedItems = shoppingCart.filter(item => 
                document.querySelector(`.cart-item-checkbox[data-id="${item.productId}"]:checked`)
            );
            
            // æ­¥éª¤ 3: (ä¿æŒä¸å˜) è°ƒç”¨å‘é€å‡½æ•°ï¼Œæ­¤æ—¶ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯æ­£ç¡®çš„
            await sendGiftMessage(selectedItems, selectedRecipients);
            
            // æ­¥éª¤ 4: (ä¿æŒä¸å˜) å…³é—­å¼¹çª—
            document.getElementById('gift-recipient-modal').classList.remove('visible');
        });
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
        document.getElementById('gift-recipient-list').addEventListener('click', (e) => {
            const item = e.target.closest('.contact-picker-item');
            if (item) {
                item.classList.toggle('selected');
            }
        });
        
        document.getElementById('select-all-recipients').addEventListener('change', function(e) {
            const isChecked = e.target.checked;
            document.querySelectorAll('#gift-recipient-list .contact-picker-item').forEach(item => {
                item.classList.toggle('selected', isChecked);
            });
        });
        // â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºé‡æ–°ç”ŸæˆæŒ‰é’®ç»‘å®šäº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('regenerate-btn').addEventListener('click', handleRegenerateResponse);
        document.getElementById('regenerate-call-btn').addEventListener('click', handleRegenerateCallResponse);
        // â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²  
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºæ¨è¿›å‰§æƒ…æŒ‰é’®ç»‘å®šäº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('propel-btn').addEventListener('click', handlePropelAction);
        // ä¸‹é¢è¿™è¡Œä»£ç å·²è¢«å®‰å…¨åœ°æ³¨é‡Šæ‰ï¼Œå› ä¸ºå®ƒå¯¹åº”çš„HTMLæŒ‰é’®ä¸å­˜åœ¨
        // document.getElementById('propel-call-btn').addEventListener('click', handlePropelCallAction);
        // â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
// åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ...

// ã€å…¨æ–°ã€‘æ¶ˆæ¯æç¤ºéŸ³è®¾ç½®äº‹ä»¶
document.getElementById('test-sound-btn').addEventListener('click', () => {
    const player = document.getElementById('notification-sound-player');
    const url = document.getElementById('notification-sound-url-input').value.trim() || DEFAULT_NOTIFICATION_SOUND;
    player.src = url;
    player.play().catch(e => alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®æˆ–æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯¥æ ¼å¼ã€‚'));
});

document.getElementById('reset-sound-btn').addEventListener('click', () => {
    document.getElementById('notification-sound-url-input').value = '';
    alert('å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºéŸ³ï¼Œç‚¹å‡»â€œä¿å­˜æ‰€æœ‰å¤–è§‚è®¾ç½®â€åç”Ÿæ•ˆã€‚');
});
    // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºå°ç»„ä»¶ç¼–è¾‘åŠŸèƒ½æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ (ä½¿ç”¨äº‹ä»¶å§”æ‰˜) â–¼â–¼â–¼
    document.getElementById('home-screen').addEventListener('click', (e) => {
        const target = e.target;
        // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯å¯ç¼–è¾‘çš„æ–‡å­—
        if (target.classList.contains('editable-text')) {
            handleEditText(target);
        }
        // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯å¯ç¼–è¾‘çš„å›¾ç‰‡
        if (target.classList.contains('editable-image')) {
            handleEditImage(target);
        }
    });
    // â–²â–²â–² æ–°å¢äº‹ä»¶ç›‘å¬å™¨ç»“æŸ â–²â–²â–²  
document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);    
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºBGMæœç´¢ç»“æœå¼¹çª—æ·»åŠ äº‹ä»¶ç›‘å¬ â–¼â–¼â–¼
document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
    document.getElementById('music-search-results-modal').classList.remove('visible');
});

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢ç»“æœå¼¹çª—äº‹ä»¶ç»‘å®š (å¤šé€‰ç‰ˆ) â–¼â–¼â–¼
document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);

document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
    document.getElementById('music-search-results-modal').classList.remove('visible');
});

// "å…¨é€‰" åŠŸèƒ½
document.getElementById('select-all-music-search').addEventListener('change', function(e) {
    document.querySelectorAll('#search-results-list .music-search-checkbox').forEach(cb => {
        cb.checked = e.target.checked;
    });
});

// ç‚¹å‡»åˆ—è¡¨é¡¹åˆ‡æ¢é€‰ä¸­çŠ¶æ€
document.getElementById('search-results-list').addEventListener('click', (e) => {
    const item = e.target.closest('.search-result-item');
    if (item) {
        const checkbox = item.querySelector('.music-search-checkbox');
        if (checkbox) {
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯å¤é€‰æ¡†æœ¬èº«ï¼Œå°±æ‰‹åŠ¨åˆ‡æ¢å®ƒçš„çŠ¶æ€
            if (e.target !== checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        }
    }
});

// "æ·»åŠ é€‰ä¸­" æŒ‰é’®åŠŸèƒ½
document.getElementById('add-selected-music-btn').addEventListener('click', async () => {
    const selectedItems = document.querySelectorAll('.music-search-checkbox:checked');
    if (selectedItems.length === 0) {
        alert("è¯·å…ˆé€‰æ‹©è¦æ·»åŠ çš„æ­Œæ›²ã€‚");
        return;
    }

    document.getElementById('music-search-results-modal').classList.remove('visible');
    await showCustomAlert("è¯·ç¨å€™...", `æ­£åœ¨æ‰¹é‡æ·»åŠ  ${selectedItems.length} é¦–æ­Œæ›²...`);

    const songDataList = Array.from(selectedItems).map(cb => JSON.parse(cb.closest('.search-result-item').dataset.songJson));
    
    let successCount = 0;
    let failedNames = [];

    // ä½¿ç”¨ Promise.all å¹¶è¡Œå¤„ç†æ‰€æœ‰æ­Œæ›²çš„è¯¦æƒ…è·å–
    const songDetailPromises = songDataList.map(songData => getPlayableSongDetails(songData));
    const fullSongObjects = await Promise.all(songDetailPromises);

    fullSongObjects.forEach((songObject, index) => {
        if (songObject) {
            musicState.playlist.push(songObject);
            successCount++;
        } else {
            failedNames.push(songDataList[index].name);
        }
    });

    if (successCount > 0) {
        await saveGlobalPlaylist();
        updatePlaylistUI();
        if (musicState.currentIndex === -1) {
            musicState.currentIndex = musicState.playlist.length - successCount;
            updatePlayerUI();
        }
    }

    let resultMessage = `æ·»åŠ å®Œæˆï¼\n\næˆåŠŸæ·»åŠ  ${successCount} é¦–æ­Œæ›²ã€‚`;
    if (failedNames.length > 0) {
        resultMessage += `\n\n${failedNames.length} é¦–æ­Œæ›²è·å–å¤±è´¥:\n- ${failedNames.join('\n- ')}`;
    }
    await showCustomAlert("æ“ä½œç»“æœ", resultMessage);
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºå”±ç‰‡/æ­Œè¯å®¹å™¨ç»‘å®šåˆ‡æ¢äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('music-visual-container').addEventListener('click', () => {
    document.getElementById('music-visual-container').classList.toggle('lyrics-active');
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘BGMæœç´¢ç»“æœå¼¹çª—äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);
document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
    document.getElementById('music-search-results-modal').classList.remove('visible');
});

document.getElementById('search-results-list').addEventListener('click', (e) => {
    const item = e.target.closest('.search-result-item');
    if (item && item.dataset.songJson) {
        const songData = JSON.parse(item.dataset.songJson);
        handleSearchResultClick(songData);
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¸…ç†æ— æ•ˆæ­Œæ›²äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('cleanup-songs-btn').addEventListener('click', cleanupInvalidSongs);
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºçŠ¶æ€æ å¼€å…³æ·»åŠ å®æ—¶é¢„è§ˆäº‹ä»¶ â–¼â–¼â–¼
document.getElementById('status-bar-toggle-switch').addEventListener('change', () => {
    // æ¯æ¬¡ç‚¹å‡»å¼€å…³æ—¶ï¼Œä¹Ÿè°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥å®æ—¶åˆ‡æ¢ class
    state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;
    applyStatusBarVisibility();
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»“æŸ â–²â–²â–²
// ä¸ºâ€œä¸‰ç‚¹â€æŒ‰é’®ç»‘å®šæ–°çš„å…¥å£å‡½æ•°
document.getElementById('qzone-more-actions-btn').addEventListener('click', openClearPostsSelectorModal);

// ä¸ºæ–°æ¨¡æ€æ¡†çš„æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('cancel-clear-posts-btn').addEventListener('click', () => {
    document.getElementById('clear-posts-modal').classList.remove('visible');
});
document.getElementById('confirm-clear-posts-btn').addEventListener('click', handleConfirmClearPosts);

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºåˆ—è¡¨é¡¹æ·»åŠ å‹¾é€‰/å–æ¶ˆå‹¾é€‰çš„ç‚¹å‡»é€»è¾‘
document.getElementById('clear-posts-list').addEventListener('click', (e) => {
    const item = e.target.closest('.clear-posts-item');
    if (item) {
        item.classList.toggle('selected');
    }
});
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å…¨å±€èŠå¤©èƒŒæ™¯äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('global-bg-input').addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (file) {
        const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });
        // å°†ä¸Šä¼ çš„å›¾ç‰‡ä¸´æ—¶ä¿å­˜åœ¨ state ä¸­ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»â€œä¿å­˜â€
        state.globalSettings.globalChatBackground = dataUrl;
        // å®æ—¶æ›´æ–°å¤–è§‚è®¾ç½®é¡µé¢çš„é¢„è§ˆ
        renderWallpaperScreen();
    }
    event.target.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©
});

document.getElementById('remove-global-bg-btn').addEventListener('click', () => {
    // ç§»é™¤èƒŒæ™¯å¹¶æ›´æ–°é¢„è§ˆ
    state.globalSettings.globalChatBackground = '';
    renderWallpaperScreen();
});

// â–¼â–¼â–¼ ã€é‡è¦ã€‘æ›´æ–°â€œä¿å­˜æ‰€æœ‰å¤–è§‚è®¾ç½®â€æŒ‰é’®çš„é€»è¾‘ â–¼â–¼â–¼
document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
    // ä¿å­˜ä¸ªäººä¸»é¡µå£çº¸
    if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
    }
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å…¨å±€èŠå¤©èƒŒæ™¯å·²ç»åœ¨ä¸Šä¼ æˆ–ç§»é™¤æ—¶æ›´æ–°åˆ° state ä¸­äº†ï¼Œ
    // æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å°†åŒ…å«æ‰€æœ‰æœ€æ–°è®¾ç½®çš„ globalSettings å¯¹è±¡å®Œæ•´åœ°ä¿å­˜ä¸€æ¬¡å³å¯ã€‚
    
    state.globalSettings.globalCss = document.getElementById('global-css-input').value.trim();
    state.globalSettings.notificationSoundUrl = document.getElementById('notification-sound-url-input').value.trim();
    state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;
    
    // ä¸€æ¬¡æ€§ä¿å­˜æ‰€æœ‰å…¨å±€è®¾ç½®
    await db.globalSettings.put(state.globalSettings);
    
    // åº”ç”¨æ‰€æœ‰æ›´æ”¹
    applyGlobalWallpaper();
    newWallpaperBase64 = null;
    applyAppIcons();
    applyGlobalCss(state.globalSettings.globalCss);
    applyStatusBarVisibility();

    alert('å¤–è§‚è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼');
    showScreen('home-screen');
});
// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å…¨å±€CSSé¢„è®¾åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('css-preset-select').addEventListener('change', handleCssPresetSelectionChange);
        document.getElementById('save-css-preset-btn').addEventListener('click', saveCssPreset);
        document.getElementById('delete-css-preset-btn').addEventListener('click', deleteCssPreset);
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å­—ä½“é¢„è®¾åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('font-preset-select').addEventListener('change', handleFontPresetSelectionChange);
        document.getElementById('save-font-preset-btn').addEventListener('click', saveFontPreset);
        document.getElementById('delete-font-preset-btn').addEventListener('click', deleteFontPreset);
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ°”æ³¡ä¸»é¢˜é¢„è®¾åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
        document.getElementById('theme-preset-select').addEventListener('change', handleThemePresetSelectionChange);
        document.getElementById('save-theme-preset-btn').addEventListener('click', saveThemePreset);
        document.getElementById('delete-theme-preset-btn').addEventListener('click', deleteThemePreset);
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯è¡¨æƒ…åˆ†ç±»åŠŸèƒ½çš„ã€å…¨éƒ¨äº‹ä»¶ç›‘å¬å™¨ã€‘ï¼Œè¯·ç²˜è´´åˆ° init() å‡½æ•°ä¸­ â–¼â–¼â–¼
        
        // 1. ç»‘å®šè¡¨æƒ…é¢æ¿é¡¶éƒ¨çš„â€œåˆ†ç±»â€æŒ‰é’®ï¼Œç”¨äºæ‰“å¼€ç®¡ç†å¼¹çª—
        document.getElementById('manage-sticker-categories-btn').addEventListener('click', openStickerCategoryManager);

        // 2. ç»‘å®šåˆ†ç±»ç®¡ç†å¼¹çª—çš„â€œå®Œæˆâ€æŒ‰é’®
        document.getElementById('close-sticker-category-manager-btn').addEventListener('click', () => {
            document.getElementById('sticker-category-manager-modal').classList.remove('visible');
            renderStickerPanel(); // å…³é—­ååˆ·æ–°ä¸»é¢æ¿çš„é¡µç­¾
        });

        // 3. ç»‘å®šâ€œæ·»åŠ æ–°åˆ†ç±»â€æŒ‰é’®
        document.getElementById('add-new-sticker-category-btn').addEventListener('click', addNewStickerCategory);

        // 4. ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åˆ†ç±»çš„åˆ é™¤
        document.getElementById('existing-sticker-categories-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-group-btn')) {
                const categoryId = parseInt(e.target.dataset.id);
                deleteStickerCategory(categoryId);
            }
        });
        
        // 5. ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†è¡¨æƒ…é¢æ¿çš„é¡µç­¾åˆ‡æ¢
        document.getElementById('sticker-category-tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('sticker-category-tab')) {
                const categoryId = e.target.dataset.categoryId;
                // å°†å­—ç¬¦ä¸²IDè½¬æ¢ä¸ºæ•°å­—ï¼Œé™¤éæ˜¯ 'all' æˆ– 'uncategorized'
                const finalId = (categoryId !== 'all' && categoryId !== 'uncategorized') ? parseInt(categoryId) : categoryId;
                switchStickerCategory(finalId);
            }
        });

        // â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
        document.getElementById('select-all-stickers-checkbox').addEventListener('change', handleSelectAllStickers);
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å•ä¸ªèŠå¤©å¯¼å…¥å¯¼å‡ºäº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('export-single-chat-btn').addEventListener('click', exportSingleChat);

document.getElementById('import-single-chat-btn').addEventListener('click', () => {
    document.getElementById('import-single-chat-input').click();
});

document.getElementById('import-single-chat-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        importSingleChat(file);
    }
    e.target.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
});
// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘CphoneåŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('add-char-memo-btn').addEventListener('click', () => openMemoEditor());
document.getElementById('add-char-diary-btn').addEventListener('click', () => openDiaryEditor());
document.getElementById('favorite-diary-btn').addEventListener('click', toggleDiaryFavorite);
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
        // â€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®
        document.getElementById('regenerate-char-qq-btn').addEventListener('click', handleGenerateSimulatedQQ);

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œå¤„ç†æ¨¡æ‹ŸèŠå¤©ã€åˆ—è¡¨ã€‘çš„ç‚¹å‡»äº‹ä»¶
        document.getElementById('char-chat-list').addEventListener('click', (e) => {
            const item = e.target.closest('.chat-list-item');
            if (item && item.dataset.conversationIndex) {
                const index = parseInt(item.dataset.conversationIndex);
                if (!isNaN(index)) {
                    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç°åœ¨è°ƒç”¨æ–°å‡½æ•°ï¼Œæ‰“å¼€å…¨å±é¡µé¢
                    openCharSimulatedConversation(index);
                }
            }
        });

        // ã€æ–°å¢ã€‘ä¸ºæ¨¡æ‹Ÿå¯¹è¯é¡µé¢çš„â€œè¿”å›â€æŒ‰é’®ç»‘å®šäº‹ä»¶
        document.getElementById('back-to-char-qq-list-btn').addEventListener('click', () => {
            switchToCharScreen('char-qq-screen');
        });

        // ã€æ–°å¢ã€‘ä¸ºæ¨¡æ‹Ÿå¯¹è¯é¡µé¢çš„â€œå‘é€â€æŒ‰é’®ç»‘å®šæç¤ºäº‹ä»¶
        document.getElementById('char-simulated-send-btn').addEventListener('click', () => {
            alert("è¿™æ˜¯æ¨¡æ‹Ÿå¯¹è¯ï¼Œæ— æ³•å‘é€æ¶ˆæ¯å“¦~");
        });

        // â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
        // 1. ä¸ºâ€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®ç»‘å®šæˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æ ¸å¿ƒå‡½æ•°
        document.getElementById('regenerate-char-album-btn').addEventListener('click', handleGenerateSimulatedAlbum);

        // 2. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºæ•´ä¸ªç›¸å†Œç½‘æ ¼æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.getElementById('char-album-grid').addEventListener('click', (e) => {
            // æ£€æŸ¥è¢«ç‚¹å‡»çš„æ˜¯å¦æ˜¯ä¸€å¼ ç…§ç‰‡
            const photoItem = e.target.closest('.char-photo-item');
            
            // å¦‚æœæ˜¯ï¼Œå¹¶ä¸”å®ƒèº«ä¸Šå­˜æœ‰æˆ‘ä»¬ä¹‹å‰æ”¾è¿›å»çš„â€œç…§ç‰‡è¯¦æƒ…â€
            if (photoItem && photoItem.dataset.description) {
                const description = photoItem.dataset.description;
                
                // å°±ç”¨ä¸€ä¸ªæ¼‚äº®çš„å¼¹çª—æŠŠè¯¦æƒ…æ˜¾ç¤ºå‡ºæ¥
                showCustomAlert("ç…§ç‰‡è¯¦æƒ…", description.replace(/\n/g, '<br>'));
            }
        });
        document.getElementById('regenerate-char-browser-btn').addEventListener('click', handleGenerateBrowserHistory);
        // 1. å°†â€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®ä¸AIç”Ÿæˆå‡½æ•°ç»‘å®š
        document.getElementById('regenerate-char-taobao-btn').addEventListener('click', handleGenerateTaobaoHistory);
       
        
        // 3. ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºè´­ä¹°è®°å½•åˆ—è¡¨æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºæ˜¾ç¤ºâ€œè´­ä¹°ç†ç”±â€
        document.getElementById('char-product-grid').addEventListener('click', (e) => {
            const item = e.target.closest('.char-product-item');
            if (item && item.dataset.reason) {
                const reason = item.dataset.reason;
                showCustomAlert("TAçš„æƒ³æ³•...", reason.replace(/\n/g, '<br>'));
            }
        });
        
        // 4. ã€æ ¸å¿ƒã€‘å°† openCharWallet å‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä»¥ä¾¿ onclick å¯ä»¥è°ƒç”¨
        window.openCharWallet = openCharWallet;
document.getElementById('regenerate-char-memo-btn').addEventListener('click', handleGenerateSimulatedMemos);
document.getElementById('char-memo-detail-back-btn').addEventListener('click', () => switchToCharScreen('char-memo-screen'));
// åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
document.getElementById('regenerate-char-diary-btn').addEventListener('click', handleGenerateSimulatedDiaries);
document.getElementById('add-char-diary-btn').addEventListener('click', handleWriteNewDiaryEntry);
document.getElementById('char-diary-detail-back-btn').addEventListener('click', () => switchToCharScreen('char-diary-screen'));
document.getElementById('regenerate-char-amap-btn').addEventListener('click', handleGenerateAmapHistory);
document.getElementById('regenerate-char-usage-btn').addEventListener('click', handleGenerateAppUsage);
        document.getElementById('regenerate-char-music-btn').addEventListener('click', handleGenerateSimulatedMusic);
        document.getElementById('close-char-music-player-btn').addEventListener('click', closeCharMusicPlayer);
document.getElementById('regenerate-douban-btn').addEventListener('click', handleGenerateDoubanPosts);
document.getElementById('regenerate-douban-btn').addEventListener('click', handleGenerateDoubanPosts);
document.getElementById('douban-detail-back-btn').addEventListener('click', () => showScreen('douban-screen'));
document.getElementById('douban-send-comment-btn').addEventListener('click', handleSendDoubanComment);
document.getElementById('douban-wait-reply-btn').addEventListener('click', handleDoubanWaitReply);
        // 1. ä¸ºCPhoneçš„å£çº¸ä¸Šä¼ è¾“å…¥æ¡†ç»‘å®šäº‹ä»¶
        document.getElementById('cphone-wallpaper-upload-input').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                const dataUrl = await new Promise((res) => {
                    const reader = new FileReader();
                    reader.onload = () => res(reader.result);
                    reader.readAsDataURL(file);
                });
                // ç›´æ¥æ›´æ–° state ä¸­çš„å€¼ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»â€œä¿å­˜â€
                state.globalSettings.cphoneWallpaper = dataUrl;
                // å®æ—¶åˆ·æ–°é¢„è§ˆ
                renderWallpaperScreen();
            }
        });
        
        // 2. ä¸ºCPhoneçš„å›¾æ ‡è®¾ç½®ç½‘æ ¼ç»‘å®šäº‹ä»¶å§”æ‰˜
// ä¸º CPhone å›¾æ ‡è®¾ç½®ç½‘æ ¼ç»‘å®šäº‹ä»¶å§”æ‰˜
document.getElementById('cphone-icon-settings-grid').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (iconId) {
            handleIconChange(iconId, 'cphone', item);
        }
    }
});
document.getElementById('import-appearance-btn').addEventListener('click', () => {
    document.getElementById('import-appearance-input').click();
});

document.getElementById('import-appearance-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        importAppearanceSettings(file);
    }
    e.target.value = null; 
});

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯è®°å½•åº”ç”¨å…³é—­æ—¶é—´çš„æ ¸å¿ƒä»£ç ï¼Œè¯·ç²˜è´´è¿›å» â–¼â–¼â–¼
/**
 * ç›‘å¬æµè§ˆå™¨çš„å¯è§æ€§å˜åŒ–äº‹ä»¶ã€‚
 * å½“ç”¨æˆ·å°†PWAåˆ‡æ¢åˆ°åå°æˆ–å…³é—­æµè§ˆå™¨æ ‡ç­¾é¡µæ—¶ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šè¢«è§¦å‘ã€‚
 */
document.addEventListener('visibilitychange', () => {
    // å¦‚æœé¡µé¢å˜å¾—ä¸å¯è§ (ç”¨æˆ·åˆ‡æ¢èµ°äº†)
    if (document.visibilityState === 'hidden') {
        // æˆ‘ä»¬å°±åœ¨ localStorage ä¸­å­˜ä¸‹å½“å‰çš„æ—¶é—´æˆ³
        localStorage.setItem('ephoneLastActiveTimestamp', Date.now());
        console.log("åº”ç”¨å·²åˆ‡æ¢åˆ°åå°ï¼Œè®°å½•å½“å‰æ—¶é—´ã€‚");
    }
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²
        document.getElementById('export-world-book-btn').addEventListener('click', exportWorldBooks);
        document.getElementById('import-world-book-btn').addEventListener('click', () => {
            document.getElementById('import-world-book-input').click();
        });
document.getElementById('import-world-book-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleWorldBookImport(file); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç°åœ¨è°ƒç”¨æ–°çš„æ™ºèƒ½å¤„ç†å™¨
            }
            e.target.value = null;
        });
        document.getElementById('enable-ai-drawing-switch').addEventListener('change', async (e) => {
            const isEnabled = e.target.checked;
            state.globalSettings.enableAiDrawing = isEnabled;
            await db.globalSettings.put(state.globalSettings);

            // æ£€æŸ¥å½“å‰åœ¨å“ªä¸ªå±å¹•ï¼Œå¹¶åˆ·æ–°å®ƒ
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                switch (activeScreen.id) {
                    case 'chat-interface-screen':
                        renderChatInterface(state.activeChatId);
                        break;
                    case 'chat-list-screen':
                        // åˆ·æ–°åŠ¨æ€é¡µ
                        if(document.getElementById('qzone-screen').classList.contains('active')) renderQzonePosts();
                        // åˆ·æ–°æ”¶è—é¡µ
                        if(document.getElementById('favorites-view').classList.contains('active')) renderFavoritesScreen();
                        break;
                    case 'douban-screen':
                        renderDoubanScreen();
                        break;
                    case 'douban-post-detail-screen':
                        openDoubanPostDetail(activeDoubanPostId);
                        break;
                    // Cphoneå†…éƒ¨çš„åˆ·æ–°
                    case 'character-phone-screen':
                        const activeCharScreen = document.querySelector('.char-screen.active');
                        if (activeCharScreen) {
                            switch(activeCharScreen.id) {
                                case 'char-album-screen': renderCharAlbum(); break;
                                case 'char-taobao-screen': renderCharTaobao(); break;
                                case 'char-browser-article-screen': 
                                    const char = state.chats[activeCharacterId];
                                    const history = char.simulatedBrowserHistory || [];
                                    const lastArticleIndex = history.length > 0 ? history.length - 1 : 0; // ç®€å•ç¤ºä¾‹ï¼Œå®é™…å¯èƒ½éœ€è¦æ›´ç²¾ç¡®çš„ç´¢å¼•
                                    renderCharArticle(history[lastArticleIndex]);
                                    break;
                                case 'char-usage-screen': renderCharAppUsage(); break;
                                case 'char-qq-screen': renderCharSimulatedQQ(); break;
                                case 'char-qq-conversation-screen': 
                                    const convoIndex = document.querySelector('#char-chat-list .chat-list-item')?.dataset.conversationIndex || 0;
                                    openCharSimulatedConversation(parseInt(convoIndex));
                                    break;
                            }
                        }
                        break;
                }
            }
            showCustomAlert('è®¾ç½®å·²åº”ç”¨', `AIç”Ÿå›¾åŠŸèƒ½å·²${isEnabled ? 'å¼€å¯' : 'å…³é—­'}ã€‚`);
        });
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è®°å½•æœç´¢åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('search-history-btn').addEventListener('click', openSearchHistoryScreen);
document.getElementById('search-history-back-btn').addEventListener('click', () => {
    showScreen('chat-settings-screen');
});
document.getElementById('execute-search-btn').addEventListener('click', handleSearchHistory);
document.getElementById('clear-search-btn').addEventListener('click', clearSearchFilters);
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è‡ªå®šä¹‰å¤´åƒæ¡†åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

// ç»‘å®šå¼¹çª—å¤´éƒ¨çš„â€œä¸Šä¼ â€å’Œâ€œæ‰¹é‡â€æŒ‰é’®
document.getElementById('upload-custom-frame-btn').addEventListener('click', handleUploadFrame);
document.getElementById('batch-import-frames-btn').addEventListener('click', handleBatchUploadFrames);

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºæ•´ä¸ªå¼¹çª—å†…å®¹åŒºç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œä¸“é—¨ç”¨äºå¤„ç†åˆ é™¤æŒ‰é’®
document.querySelector('#avatar-frame-modal .modal-body').addEventListener('click', (e) => {
    // æ£€æŸ¥è¢«ç‚¹å‡»çš„æ˜¯å¦æ˜¯åˆ é™¤æŒ‰é’®
    if (e.target.classList.contains('delete-btn')) {
        const frameId = parseInt(e.target.dataset.id);
        if (!isNaN(frameId)) {
            handleDeleteCustomFrame(frameId);
        }
    }
});

// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸»å±å¹•åˆ†é¡µå’Œâ€œé¢„è®¾â€Appçš„ã€å…¨éƒ¨äº‹ä»¶ç›‘å¬å™¨ã€‘ï¼Œè¯·å®Œæ•´ç²˜è´´ â–¼â–¼â–¼

        // 1. åˆå§‹åŒ–ä¸»å±å¹•åˆ†é¡µåŠŸèƒ½
        setupHomeScreenPagination();

        // 2. å°†â€œé¢„è®¾â€Appçš„å…¨å±€è°ƒç”¨å‡½æ•°æš´éœ²ç»™ windowï¼Œä»¥ä¾¿ onclick å¯ä»¥æ‰¾åˆ°å®ƒ
        window.openPresetScreen = openPresetScreen;

        // 3. ç»‘å®šâ€œé¢„è®¾â€Appå†…éƒ¨çš„æ‰€æœ‰æŒ‰é’®äº‹ä»¶
        document.getElementById('add-preset-btn').addEventListener('click', async () => {
            const name = await showCustomPrompt('åˆ›å»ºæ–°é¢„è®¾', 'è¯·è¾“å…¥é¢„è®¾åç§°');
            if (name && name.trim()) {
                const newPreset = { id: 'preset_' + Date.now(), name: name.trim(), content: [] };
                await db.presets.add(newPreset);
                await renderPresetScreen();
                openPresetEditor(newPreset.id);
            }
        });

        document.getElementById('manage-preset-categories-btn').addEventListener('click', openPresetCategoryManager);
        
        document.getElementById('add-preset-entry-btn').addEventListener('click', () => {
            const container = document.getElementById('preset-entries-container');
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            const newBlock = createPresetEntryBlock();
            container.appendChild(newBlock);
            newBlock.querySelector('.entry-content-textarea').focus();
        });

// â–¼â–¼â–¼ ã€å…¨æ–° | iOS å…¼å®¹ç‰ˆã€‘è¯·ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ save-preset-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('save-preset-btn').addEventListener('click', async () => {
    if (!editingPresetId) return;
    const preset = await db.presets.get(editingPresetId);
    if (!preset) return;

    // (è¿™éƒ¨åˆ†ä¿å­˜æ•°æ®çš„é€»è¾‘ä¿æŒä¸å˜)
    const newName = document.getElementById('preset-name-input').value.trim();
    if (!newName) { alert('é¢„è®¾åç§°ä¸èƒ½ä¸ºç©ºï¼'); return; }
    preset.name = newName;
    preset.categoryId = parseInt(document.getElementById('preset-category-select').value) || null;

    const entriesContainer = document.getElementById('preset-entries-container');
    const entryBlocks = entriesContainer.querySelectorAll('.message-editor-block');
    const newEntries = [];
    entryBlocks.forEach(block => {
        const content = block.querySelector('.entry-content-textarea').value.trim();
        if (content) {
            newEntries.push({
                comment: block.querySelector('.entry-comment-input').value.trim(),
                keys: (block.querySelector('.entry-keys-input').value.trim() || '').split(',').map(k => k.trim()).filter(Boolean),
                content: content,
                enabled: block.querySelector('.entry-enabled-switch').checked
            });
        }
    });
    preset.content = newEntries;

    // 1. å…ˆå°†æ‰€æœ‰æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“
    await db.presets.put(preset);
    editingPresetId = null;

    // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘å…ˆåˆ‡æ¢åˆ°ç›®æ ‡å±å¹•
    showScreen('preset-screen');
    
    // 3. ã€æ ¸å¿ƒä¿®å¤ã€‘ç„¶åå†å¼‚æ­¥åœ°ã€ä»å®¹åœ°æ¸²æŸ“é‚£ä¸ªå±å¹•ä¸Šçš„å†…å®¹
    // è¿™å°±ç»™äº†æµè§ˆå™¨è¶³å¤Ÿçš„æ—¶é—´æ¥å¤„ç†å±å¹•åˆ‡æ¢åŠ¨ç”»ï¼Œé¿å…äº†å´©æºƒ
    await renderPresetScreen();
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        // â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºâ€œé¢„è®¾â€Appçš„å¯¼å…¥åŠŸèƒ½ç»‘å®šäº‹ä»¶ â–¼â–¼â–¼
        document.getElementById('import-preset-btn').addEventListener('click', () => {
            document.getElementById('import-preset-input').click();
        });

        document.getElementById('import-preset-input').addEventListener('change', handlePresetImport);
        // â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
document.getElementById('reset-button-order-btn').addEventListener('click', resetButtonOrder);
// â–¼â–¼â–¼ ã€å…¨æ–°V2.0 | å·²ä¿®å¤ã€‘é«˜çº§æ•°æ®æ¸…ç†åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('clear-specific-data-btn').addEventListener('click', openDataClearWizard);

// å‘å¯¼ç¬¬ä¸€æ­¥çš„æŒ‰é’®
document.getElementById('cancel-clear-wizard-btn-step1').addEventListener('click', () => {
    document.getElementById('data-clear-wizard-modal').classList.remove('visible');
});
document.getElementById('go-to-clear-step2-btn').addEventListener('click', handleDataClearNext);

// å‘å¯¼ç¬¬äºŒæ­¥çš„æŒ‰é’®
document.getElementById('back-to-clear-step1-btn').addEventListener('click', handleDataClearBack);
document.getElementById('cancel-clear-wizard-btn-step2').addEventListener('click', () => {
    document.getElementById('data-clear-wizard-modal').classList.remove('visible');
});
document.getElementById('confirm-final-clear-btn').addEventListener('click', handleConfirmDataClear);

// ã€æ ¸å¿ƒæ–°å¢ã€‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†ä¸¤ä¸ªåˆ—è¡¨çš„å‹¾é€‰/å–æ¶ˆå‹¾é€‰ å’Œ å…¨é€‰
document.getElementById('data-clear-wizard-modal').addEventListener('click', (e) => {
    const item = e.target.closest('.clear-posts-item');
    if (item) {
        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘ä¸‹é¢çš„changeäº‹ä»¶
        e.stopPropagation();
        item.classList.toggle('selected');
    }
});
document.getElementById('data-clear-wizard-modal').addEventListener('change', (e) => {
    // å…¨é€‰è§’è‰²
    if (e.target.id === 'select-all-chars-for-clear') {
        const isChecked = e.target.checked;
        document.querySelectorAll('#data-clear-char-list .clear-posts-item').forEach(item => {
            item.classList.toggle('selected', isChecked);
        });
    } 
    // å…¨é€‰æ•°æ®ç±»å‹
    else if (e.target.id === 'select-all-types-for-clear') {
        const isChecked = e.target.checked;
        document.querySelectorAll('#data-clear-type-list .clear-posts-item').forEach(item => {
            item.classList.toggle('selected', isChecked);
        });
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
document.getElementById('compress-images-btn').addEventListener('click', compressAllLocalImages);
// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œæ‰¾åˆ° #copy-message-btn çš„ç›‘å¬å™¨ï¼Œåœ¨å®ƒåé¢ç²˜è´´æ–°ä»£ç  â–¼â–¼â–¼
document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);

// ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºæ–°æŒ‰é’®ç»‘å®šæ–°çš„åŠŸèƒ½å‡½æ•°
document.getElementById('copy-timestamp-btn').addEventListener('click', copyMessageTimestamp);
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
document.getElementById('npc-list-back-btn').addEventListener('click', () => {
    // å½“è¿™ä¸ªæŒ‰é’®è¢«ç‚¹å‡»æ—¶ï¼Œè°ƒç”¨æˆ‘ä»¬å®šä¹‰åœ¨â€œç§å¯†ä½œç”¨åŸŸâ€é‡Œçš„å‡½æ•°
    switchToChatListView('messages-view');
});

// ç»‘å®šNPCåˆ—è¡¨é¡µé¡¶éƒ¨çš„â€œ+â€æŒ‰é’®
document.getElementById('add-npc-btn').addEventListener('click', () => openNpcEditor(null));

// ç»‘å®šNPCç¼–è¾‘å™¨å¼¹çª—çš„â€œä¿å­˜â€å’Œâ€œå–æ¶ˆâ€æŒ‰é’®
document.getElementById('save-npc-btn').addEventListener('click', saveNpc);
document.getElementById('cancel-npc-editor-btn').addEventListener('click', () => {
    document.getElementById('npc-editor-modal').classList.remove('visible');
});

// ç»‘å®šNPCå¤´åƒä¸Šä¼ 
document.getElementById('npc-avatar-input').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('npc-avatar-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});
document.getElementById('chat-lock-overlay').addEventListener('click', (e) => {
    // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯â€œé‡Rollâ€æŒ‰é’®
    if (e.target.id === 'spectator-reroll-btn') {
        handleSpectatorReroll();
    }
    // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯â€œå‰ªè¾‘â€æŒ‰é’®
    else if (e.target.id === 'spectator-edit-btn') {
        // ç›´æ¥å¤ç”¨ç°æœ‰çš„â€œå¯¼æ¼”å‰ªè¾‘å®¤â€æ‰“å¼€å‡½æ•°
        openAiResponseEditor();
    }
    // (æ³¨æ„ï¼šä¸»æŒ‰é’® spectator-propel-btn çš„äº‹ä»¶å·²åœ¨ renderChatInterface ä¸­ç›´æ¥ç»‘å®šï¼Œè¿™é‡Œæ— éœ€å¤„ç†)
});



    checkForUpdates();

                    showScreen('home-screen');
                }
        
                init();
            });
(function (window) {
  ('use strict');

  // ============================================
  // ç¬¬ä¸€éƒ¨åˆ†: CSSæ ·å¼æ³¨å…¥
  // ============================================
  function injectStyles() {
    const styleId = 'x-social-app-styles';

    // é¿å…é‡å¤æ³¨å…¥
    if (document.getElementById(styleId)) return;

    const style = document.createElement('style');
    style.id = styleId;
    style.textContent = `
      /* ========== Xç¤¾äº¤é¡µé¢åŸºç¡€æ ·å¼ ========== */
      
                /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ - Xé£æ ¼ï¼ˆç»†é•¿çŸ­å°äº®è“è‰²ï¼‰ */
      .tab-content::-webkit-scrollbar,
      #x-comments-page::-webkit-scrollbar,
      .comments-container::-webkit-scrollbar,
      .settings-content::-webkit-scrollbar,
      .profile-content::-webkit-scrollbar,
      .tweets-container::-webkit-scrollbar,
      #detail-comments-container::-webkit-scrollbar,
      .modal-body::-webkit-scrollbar,
      #identity-characters-list::-webkit-scrollbar,
      #characters-list::-webkit-scrollbar,
      #x-presets-list::-webkit-scrollbar {
        width: 3px;
      }

      .tab-content::-webkit-scrollbar-track,
      #x-comments-page::-webkit-scrollbar-track,
      .comments-container::-webkit-scrollbar-track,
      .settings-content::-webkit-scrollbar-track,
      .profile-content::-webkit-scrollbar-track,
      .tweets-container::-webkit-scrollbar-track,
      #detail-comments-container::-webkit-scrollbar-track,
      .modal-body::-webkit-scrollbar-track,
      #identity-characters-list::-webkit-scrollbar-track,
      #characters-list::-webkit-scrollbar-track,
      #x-presets-list::-webkit-scrollbar-track {
        background: transparent;
      }

      .tab-content::-webkit-scrollbar-thumb,
      #x-comments-page::-webkit-scrollbar-thumb,
      .comments-container::-webkit-scrollbar-thumb,
      .settings-content::-webkit-scrollbar-thumb,
      .profile-content::-webkit-scrollbar-thumb,
      .tweets-container::-webkit-scrollbar-thumb,
      #detail-comments-container::-webkit-scrollbar-thumb,
      .modal-body::-webkit-scrollbar-thumb,
      #identity-characters-list::-webkit-scrollbar-thumb,
      #characters-list::-webkit-scrollbar-thumb,
      #x-presets-list::-webkit-scrollbar-thumb {
        background-color: rgba(29, 155, 240, 0.5);
        border-radius: 10px;
        min-height: 30px;
        max-height: 80px;
      }

      .tab-content::-webkit-scrollbar-thumb:hover,
      #x-comments-page::-webkit-scrollbar-thumb:hover,
      .comments-container::-webkit-scrollbar-thumb:hover,
      .settings-content::-webkit-scrollbar-thumb:hover,
      .profile-content::-webkit-scrollbar-thumb:hover,
      .tweets-container::-webkit-scrollbar-thumb:hover,
      #detail-comments-container::-webkit-scrollbar-thumb:hover,
      .modal-body::-webkit-scrollbar-thumb:hover,
      #identity-characters-list::-webkit-scrollbar-thumb:hover,
      #characters-list::-webkit-scrollbar-thumb:hover,
      #x-presets-list::-webkit-scrollbar-thumb:hover {
        background-color: rgba(29, 155, 240, 0.8);
      }

      .tab-content::-webkit-scrollbar-thumb:active,
      #x-comments-page::-webkit-scrollbar-thumb:active,
      .comments-container::-webkit-scrollbar-thumb:active,
      .settings-content::-webkit-scrollbar-thumb:active,
      .profile-content::-webkit-scrollbar-thumb:active,
      .tweets-container::-webkit-scrollbar-thumb:active,
      #detail-comments-container::-webkit-scrollbar-thumb:active,
      .modal-body::-webkit-scrollbar-thumb:active,
      #identity-characters-list::-webkit-scrollbar-thumb:active,
      #characters-list::-webkit-scrollbar-thumb:active,
      #x-presets-list::-webkit-scrollbar-thumb:active {
        background-color: #1d9bf0;
      }

          /* ä¿®å¤Xç¤¾äº¤é¡µé¢é«˜åº¦å¸ƒå±€é—®é¢˜ */
          #x-social-screen {
            height: 100vh !important;
            overflow: hidden !important;
          }

          .x-pages-container {
            min-height: 0 !important;
          }

          .x-page {
            min-height: 0 !important;
          }

          .x-bottom-nav {
            flex-shrink: 0 !important;
          }

          /* ç¡®ä¿æ‰€æœ‰å¯æ»šåŠ¨å®¹å™¨éƒ½æœ‰æ­£ç¡®çš„é«˜åº¦è®¾ç½® */
          .comments-container,
          .settings-content,
          .profile-content,
          .tab-content {
            min-height: 0 !important;
          }

          /* ç¡®ä¿æ¨æ–‡å®¹å™¨ä¹Ÿæœ‰æ­£ç¡®çš„æ»šåŠ¨ */
          .tweets-container {
            overflow-y: auto;
            min-height: 0;
          }

          /* ç”¨æˆ·è¯„è®ºåˆ é™¤åŠŸèƒ½æ ·å¼ */
          .comment-user-info {
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
          }

          .comment-delete-btn:hover {
            background-color: rgba(239, 68, 68, 0.1) !important;
          }

          .comment-delete-btn svg {
            transition: fill 0.2s ease;
          }

          .comment-delete-btn:hover svg {
            fill: #dc2626 !important;
          }

          /* ç”¨æˆ·äººè®¾è®¾ç½®æŒ‰é’®æ ·å¼ */
          .persona-setting-btn {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
          }

          .persona-setting-btn:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          }

          .persona-setting-btn:active {
            transform: scale(0.95) !important;
          }

          /* æ¨æ–‡é¡¹ç›® */
          #x-social-screen .tweet-item {
            padding: 15px;
            border-bottom: 1px solid #2f3336;
            display: flex;
            gap: 12px;
          }

          /* ç”¨æˆ·å¤´åƒ */
          #x-social-screen .tweet-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
          }

          /* æ¨æ–‡ä¸»è¦å†…å®¹åŒºåŸŸ */
          #x-social-screen .tweet-main {
            flex: 1;
            min-width: 0;
          }

          /* ç”¨æˆ·ä¿¡æ¯è¡Œ */
          #x-social-screen .tweet-user-info {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
          }

          #x-social-screen .tweet-user-name {
            font-weight: 700;
            color: #fff;
            font-size: 15px;
          }

          #x-social-screen .tweet-verified {
            width: 18px;
            height: 18px;
            fill: #1d9bf0;
          }

          #x-social-screen .tweet-user-handle {
            color: #71767b;
            font-size: 15px;
          }

          #x-social-screen .tweet-time {
            color: #71767b;
            font-size: 15px;
          }

          #x-social-screen .tweet-more {
            margin-left: auto;
            color: #71767b;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
          }

          #x-social-screen .tweet-more:hover {
            background-color: rgba(29, 155, 240, 0.1);
            color: #1d9bf0;
          }

          /* æ¨æ–‡å†…å®¹ */
          #x-social-screen .tweet-content {
            color: #fff;
            font-size: 15px;
            line-height: 1.3;
            margin-bottom: 12px;
            word-wrap: break-word;
          }

          /* è¯é¢˜æ ‡ç­¾å’ŒæåŠçš„é«˜äº®æ ·å¼ */
          #x-social-screen .hashtag,
          #x-social-screen .mention {
            color: #1d9bf0;
            text-decoration: none;
            cursor: pointer;
          }

          #x-social-screen .hashtag:hover,
          #x-social-screen .mention:hover {
            text-decoration: underline;
          }

          /* åª’ä½“å†…å®¹ */
          #x-social-screen .tweet-media {
            margin-bottom: 12px;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
          }

          #x-social-screen .tweet-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            display: block;
          }

          /* æ•æ„Ÿå†…å®¹é®ç½© */
          #x-social-screen .sensitive-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            cursor: pointer;
          }

          #x-social-screen .sensitive-text {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 8px;
          }

          #x-social-screen .sensitive-description {
            font-size: 13px;
            color: #71767b;
            text-align: center;
            padding: 0 20px;
          }

          /* äº’åŠ¨æŒ‰é’® */
          .tweet-actions {
            display: flex;
            justify-content: space-between;
            max-width: 425px;
            margin-top: 5px;
          }

          .tweet-action {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            color: #71767b;
            font-size: 13px;
            transition: all 0.2s;
          }

          .tweet-action:hover {
            background-color: rgba(29, 155, 240, 0.1);
          }

          #x-social-screen .tweet-action.comment:hover {
            color: #1d9bf0;
          }

          #x-social-screen .tweet-action.retweet:hover {
            color: #00ba7c;
          }

          #x-social-screen .tweet-action.like:hover,
          #x-social-screen .tweet-action.like.liked {
            color: #f91880;
          }

          #x-social-screen .tweet-action.bookmark:hover {
            color: #1d9bf0;
          }

          #x-social-screen .tweet-action.share:hover {
            color: #1d9bf0;
          }

          #x-social-screen .action-icon {
            width: 18px;
            height: 18px;
          }

          /* ç‚¹èµåŠ¨ç”»æ•ˆæœ */
          #x-social-screen .like-animation {
            animation: likeHeartbeat 0.6s ease-in-out;
          }

          @keyframes likeHeartbeat {
            0% {
              transform: scale(1);
            }

            25% {
              transform: scale(1.2);
            }

            50% {
              transform: scale(1.4);
            }

            75% {
              transform: scale(1.2);
            }

            100% {
              transform: scale(1);
            }
          }

          #x-social-screen .tweet-action.like.liked .like-icon {
            fill: #f91880;
          }

          #x-social-screen .tweet-action.like.liked .like-count {
            color: #f91880;
          }

          /* è¯„è®ºæ ·å¼ */
          #x-social-screen .comment-item {
            padding: 15px;
            border-bottom: 1px solid #2f3336;
            display: flex;
            gap: 12px;
            position: relative;
          }

          /* ä¸»è¯„è®ºåæœ‰å›å¤æ—¶çš„è¿æ¥çº¿ */
          #x-social-screen .comment-item.has-replies::after {
            content: '';
            position: absolute;
            left: 35px;
            /* å¤´åƒä¸­å¿ƒä½ç½® */
            bottom: -1px;
            width: 1px;
            height: 28px;
            background-color: #2f3336;
          }

          #x-social-screen .comment-main {
            flex: 1;
            min-width: 0;
          }

          #x-social-screen .comment-user-info {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
          }

          #x-social-screen .comment-content {
            color: #fff;
            font-size: 15px;
            line-height: 1.3;
            margin-bottom: 8px;
            word-wrap: break-word;
          }

          #x-social-screen .comment-actions {
            display: flex;
            justify-content: flex-start;
            gap: 60px;
            margin-top: 5px;
          }

          #x-social-screen .comment-action {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            color: #71767b;
            font-size: 13px;
            transition: all 0.2s;
          }

          /* å›å¤è¯„è®ºæ ·å¼ */
          #x-social-screen .reply-item {
            margin-left: 50px;
            /* ç²¾ç¡®å¯¹é½ä¸»è¯„è®ºçš„å¤´åƒå³ä¾§ */
            padding-left: 0;
            padding-top: 8px;
            padding-bottom: 8px;
            border-left: none;
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 12px;
          }

          #x-social-screen .reply-item::before {
            content: '';
            position: absolute;
            left: -30px;
            top: 16px;
            width: 14px;
            height: 14px;
            border-left: 1px solid #2f3336;
            border-bottom: 1px solid #2f3336;
            border-bottom-left-radius: 6px;
          }

          #x-social-screen .reply-to {
            color: #1d9bf0;
            margin-right: 5px;
            font-weight: 400;
          }

          /* å›å¤è¯„è®ºçš„å¤´åƒç¨å°ä¸€äº› */
          #x-social-screen .reply-item .tweet-avatar {
            width: 32px;
            height: 32px;
          }

          /* å¼•ç”¨æ¨æ–‡æ ·å¼ */
          #x-social-screen .quoted-tweet {
            border: 1px solid #2f3336;
            border-radius: 16px;
            margin: 12px 0;
            padding: 12px;
            background-color: rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s ease;
            cursor: pointer;
          }

          #x-social-screen .quoted-tweet:hover {
            background-color: rgba(255, 255, 255, 0.03);
          }

          #x-social-screen .quoted-user-info {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
          }

          #x-social-screen .quoted-user-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
          }

          #x-social-screen .quoted-user-name {
            font-weight: 600;
            color: #fff;
            font-size: 13px;
          }

          #x-social-screen .quoted-user-handle {
            color: #71767b;
            font-size: 13px;
          }

          #x-social-screen .quoted-user-time {
            color: #71767b;
            font-size: 13px;
          }

          #x-social-screen .quoted-content {
            color: #fff;
            font-size: 14px;
            line-height: 1.3;
            word-wrap: break-word;
          }

          #x-social-screen .quote-indicator {
            color: #71767b;
            font-size: 13px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
          }

          #x-social-screen .quote-indicator svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
          }

          /* æœç´¢é¡µé¢æ ·å¼ */
          #x-social-screen .search-header {
            padding: 12px 16px;
            background: #000;
            border-bottom: 1px solid #2f3336;
          }

          #x-social-screen .search-box {
            display: flex;
            align-items: center;
            background: #202327;
            border-radius: 20px;
            padding: 10px 16px;
            gap: 12px;
          }

          #x-social-screen .search-box svg {
            width: 20px;
            height: 20px;
            fill: #71767b;
            flex-shrink: 0;
          }

          #x-social-screen .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-size: 15px;
          }

          #x-social-screen .search-box input::placeholder {
            color: #71767b;
          }

          #x-social-screen .search-tabs {
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid #2f3336;
            gap: 24px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
          }

          #x-social-screen .search-tabs::-webkit-scrollbar {
            display: none;
          }

          #x-social-screen .search-tab {
            padding: 16px 0;
            cursor: pointer;
            color: #71767b;
            font-weight: 500;
            font-size: 15px;
            white-space: nowrap;
            position: relative;
            transition: color 0.2s;
          }

          #x-social-screen .search-tab.active {
            color: #fff;
            font-weight: 700;
          }

          #x-social-screen .search-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #1d9bf0;
            border-radius: 2px 2px 0 0;
          }

          #x-social-screen .search-tab:hover {
            color: #fff;
          }

          #x-social-screen .add-category-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
          }

          #x-social-screen .add-category-btn svg {
            width: 20px;
            height: 20px;
            fill: #71767b;
          }

          #x-social-screen .add-category-btn:hover {
            background: rgba(29, 155, 240, 0.1);
          }

          #x-social-screen .add-category-btn:hover svg {
            fill: #1d9bf0;
          }

          #x-social-screen .trending-list {
            flex: 1;
            overflow-y: auto;
          }

          #x-social-screen .trending-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
          }

          #x-social-screen .trending-item:hover {
            background: rgba(255, 255, 255, 0.03);
          }

          #x-social-screen .trending-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2px;
          }

          #x-social-screen .trending-category {
            color: #71767b;
            font-size: 14px;
            font-weight: 800;
            line-height: 16px;
          }

          #x-social-screen .trending-more {
            padding: 4px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
          }

          #x-social-screen .trending-more:hover {
            background: rgba(29, 155, 240, 0.1);
          }

          #x-social-screen .trending-more svg {
            width: 18px;
            height: 18px;
            fill: #71767b;
          }

          #x-social-screen .trending-title {
            color: #fff;
            font-size: 15px;
            font-weight: 700;
            line-height: 20px;
            margin-bottom: 2px;
          }

          #x-social-screen .trending-count {
            color: #71767b;
            font-size: 13px;
            line-height: 16px;
            font-weight: 400;
          }

          #x-social-screen .refresh-trends-btn {
            position: fixed;
            right: 20px;
            bottom: 80px;
            width: 56px;
            height: 56px;
            background: #1d9bf0;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background 0.2s;
            z-index: 100;
          }

          #x-social-screen .refresh-trends-btn:hover {
            background: #1a8cd8;
            transform: scale(1.05);
          }

          #x-social-screen .refresh-trends-btn:active {
            transform: scale(0.95);
          }

          #x-social-screen .refresh-trends-btn svg {
            width: 24px;
            height: 24px;
            fill: #fff;
          }

          #x-social-screen .refresh-trends-btn.spinning svg {
            animation: spin 1s linear infinite;
          }

          @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
          }
    `;

    document.head.appendChild(style);
    console.log('âœ… X Social App: æ ·å¼å·²æ³¨å…¥');
  }

  // ============================================
  // ç¬¬äºŒéƒ¨åˆ†: HTMLç»“æ„ç”Ÿæˆ
  // ============================================
  function createXSocialHTML() {
    // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨
    if (document.getElementById('x-social-screen')) {
      console.log('âš ï¸ X Social Screen å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º');
      return;
    }

    const container = document.createElement('div');
    container.id = 'x-social-screen';
    container.className = 'screen';
    container.style.cssText =
      'background-color: #000; color: #fff; display: flex; flex-direction: column; height: 100vh; overflow: hidden;';

    // è¿™é‡Œä½¿ç”¨å­—ç¬¦ä¸²æ¨¡æ¿æˆ–DOMæ“ä½œåˆ›å»ºå®Œæ•´çš„HTMLç»“æ„
    container.innerHTML = `
    <!-- é¡¶éƒ¨æ  -->
    <div class="x-top-bar"
        style="display: flex; justify-content: space-between; align-items: center; padding: 35px 15px; border-bottom: 1px solid #333; position: relative;">
      <!-- è¿”å›æŒ‰é’® -->
      <div class="x-back-btn" onclick="showScreen('home-screen')" style="cursor: pointer;">
        <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: #fff;">
          <g>
            <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path>
          </g>
        </svg>
      </div>
      <!-- å¤´åƒæ”¾ä¸­é—´ -->
      <div class="x-profile-pic"
        style="display: flex; justify-content: center; align-items: center; position: absolute; left: 50%; transform: translateX(-50%);">
        <img id="top-bar-avatar" 
             src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" 
             alt="Profile"
             onclick="switchXPage('profile')" 
             style="width: 36px; height: 36px; border-radius: 50%; cursor: pointer; transition: opacity 0.2s;"
             onmouseover="this.style.opacity='0.8'"
             onmouseout="this.style.opacity='1'">
      </div>
      <!-- å³ä¾§æŒ‰é’®åŒºåŸŸ -->
      <div style="display: flex; align-items: center; gap: 15px;">
        <!-- åˆ·æ–°æŒ‰é’® -->
        <div class="x-refresh-btn" onclick="refreshXTweets()" style="cursor: pointer;">
          <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 22px; height: 22px; fill: #fff;">
            <g>
              <path
                d="M19 8l-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4H6z">
              </path>
            </g>
          </svg>
        </div>
        <!-- è®¾ç½®æŒ‰é’® -->
        <div class="x-settings" onclick="switchXPage('settings')" style="cursor: pointer;">
          <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 24px; height: 24px; fill: #fff;">
            <g>
              <path
                d="M10.54 1.75h2.92l1.57 2.36c.11.17.32.25.53.21l2.53-.59 2.17 2.17-.58 2.54c-.05.2.04.41.21.53l2.36 1.57v2.92l-2.36 1.57c-.17.12-.26.33-.21.53l.58 2.54-2.17 2.17-2.53-.59c-.21-.04-.42.04-.53.21l-1.57 2.36h-2.92l-1.58-2.36c-.11-.17-.32-.25-.52-.21l-2.54.59-2.17-2.17.58-2.54c.05-.2-.03-.41-.21-.53l-2.35-1.57v-2.92L4.1 8.97c.18-.12.26-.33.21-.53L3.73 5.9 5.9 3.73l2.54.59c.2.04.41-.04.52-.21l1.58-2.36zm1.07 2l-.98 1.47C10.05 6.08 9 6.5 7.99 6.27l-1.46-.34-.6.6.33 1.46c.24 1.01-.18 2.07-1.05 2.64l-1.46.98v.78l1.46.98c.87.57 1.29 1.63 1.05 2.64l-.33 1.46.6.6 1.46-.34c1.01-.23 2.06.19 2.64 1.05l.98 1.47h.78l.97-1.47c.58-.86 1.63-1.28 2.65-1.05l1.45.34.61-.6-.34-1.46c-.23-1.01.18-2.07 1.05-2.64l1.47-.98v-.78l-1.47-.98c-.87-.57-1.28-1.63-1.05-2.64l.34-1.46-.61-.6-1.45.34c-1.02.23-2.07-.19-2.65-1.05l-.97-1.47h-.78zM12 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5c.82 0 1.5-.67 1.5-1.5s-.68-1.5-1.5-1.5zM8.5 12c0-1.93 1.56-3.5 3.5-3.5 1.93 0 3.5 1.57 3.5 3.5s-1.57 3.5-3.5 3.5c-1.94 0-3.5-1.57-3.5-3.5z">
              </path>
            </g>
          </svg>
        </div>
      </div>
    </div>

    <!-- å„ä¸ªé¡µé¢å®¹å™¨ -->
    <div class="x-pages-container"
      style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; position: relative;">
      <!-- ä¸»é¡µé¡µé¢ - é»˜è®¤æ˜¾ç¤º -->
      <div id="x-home-page" class="x-page active"
        style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0;">

        <!-- ä¸»é¡µæ ‡ç­¾æ  -->
        <div class="x-home-tabs" style="display: flex; border-bottom: 1px solid #333;">
          <!-- "ä¸ºä½ æ¨è"æ ‡ç­¾ -->
          <div class="x-tab active" onclick="switchHomeTab('for-you')"
            style="flex: 1; text-align: center; padding: 15px 0; font-weight: 600; cursor: pointer; position: relative;">
            ä¸ºä½ æ¨è
            <div class="tab-indicator"
              style="position: absolute; bottom: 0; left: 10%; width: 80%; height: 2px; background-color: #1d9bf0; border-radius: 2px;">
            </div>
          </div>

          <!-- "æ­£åœ¨å…³æ³¨"æ ‡ç­¾ -->
          <div class="x-tab" onclick="switchHomeTab('following')"
            style="flex: 1; text-align: center; padding: 15px 0; font-weight: 600; cursor: pointer; position: relative; color: #71767b;">
            æ­£åœ¨å…³æ³¨
            <div class="tab-indicator"
              style="position: absolute; bottom: 0; left: 10%; width: 80%; height: 2px; background-color: #1d9bf0; border-radius: 2px; display: none;">
            </div>
          </div>
        </div>

        <!-- å†…å®¹åŒºåŸŸ - ä¸ºä½ æ¨è -->
        <div id="for-you-content" class="tab-content active"
          style="flex: 1; display: flex; flex-direction: column; overflow-y: auto; min-height: 0;">
          <!-- æ¨æ–‡åˆ—è¡¨å®¹å™¨ -->
          <div class="tweets-container" style="padding: 0;">
            <!-- æ¨æ–‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
        </div>

        <!-- å†…å®¹åŒºåŸŸ - æ­£åœ¨å…³æ³¨ -->
        <div id="following-content" class="tab-content"
          style="flex: 1; display: none; flex-direction: column; overflow-y: auto; min-height: 0;">
          <!-- æ¨æ–‡åˆ—è¡¨å®¹å™¨ -->
          <div class="tweets-container" style="padding: 0;">
            <!-- æ¨æ–‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>
        </div>
  
        
  
        <!-- æ·»åŠ æµ®åŠ¨å‘å¸ƒæŒ‰é’® -->
        <div class="compose-btn" onclick="openComposeTweetModal()"
          style="position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; background-color: #1d9bf0; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); cursor: pointer;">
          <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 24px; height: 24px; fill: #fff; stroke-width: 2;">
            <g>
              <path d="M12 4L12 20M4 12L20 12" stroke="white" stroke-linecap="round"></path>
            </g>
          </svg>
        </div>
      </div>

      <!-- è§’è‰²Xèµ„æ–™è®¾ç½®å¼¹çª— -->
      <div id="character-x-profile-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 30; backdrop-filter: blur(8px);">
        <div style="display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px;">
          <div
            style="background-color: #000; border: 1px solid #333; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;">

            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div
              style="display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 16px 20px; border-bottom: 1px solid #333;">
              <h2 style="color: #fff; font-size: 20px; font-weight: 700; margin: 0;">è®¾ç½®Xèµ„æ–™</h2>
              <button onclick="closeCharacterXProfileModal()"
                style="background: none; border: none; color: #71767b; cursor: pointer; padding: 8px;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                  <path
                    d="M18.36 6.64c.39.39.39 1.02 0 1.41L13.41 12l4.95 4.95c.39.39.39 1.02 0 1.41-.39.39-1.02.39-1.41 0L12 13.41l-4.95 4.95c-.39.39-1.02.39-1.41 0-.39-.39-.39-1.02 0-1.41L10.59 12 5.64 7.05c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0L12 10.59l4.95-4.95c.39-.39 1.02-.39 1.41 0z" />
                </svg>
              </button>
            </div>

            <!-- è§’è‰²åŸºæœ¬ä¿¡æ¯æ˜¾ç¤º -->
            <div id="character-info-display"
              style="padding: 20px; border-bottom: 1px solid #333; background-color: #0a0a0a;">
              <!-- è§’è‰²ä¿¡æ¯å°†åŠ¨æ€å¡«å…… -->
            </div>

            <!-- è¡¨å•å†…å®¹ -->
            <div style="padding: 20px;">
              <form id="character-x-profile-form">

                <!-- Xå¤´åƒè®¾ç½® -->
                <div style="margin-bottom: 24px;">
                  <label
                    style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 12px;">Xå¤´åƒ</label>
                  <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                    <img id="character-x-avatar" src="" alt="Xå¤´åƒ"
                      style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #333;">
                    <div style="flex: 1;">
                      <div style="color: #71767b; font-size: 13px; margin-bottom: 8px;">å¤´åƒé“¾æ¥</div>
                      <input type="url" id="character-x-avatar-url" placeholder="https://example.com/avatar.jpg"
                        style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; outline: none;"
                        oninput="updateCharacterXAvatar(this.value)" onfocus="this.style.borderColor='#1d9bf0'"
                        onblur="this.style.borderColor='#333'">
                    </div>
                  </div>
                  <div style="color: #71767b; font-size: 12px;">
                    è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥URLï¼Œæ”¯æŒJPGã€PNGã€GIFæ ¼å¼
                  </div>
                </div>

                <!-- Xç”¨æˆ·å -->
                <div style="margin-bottom: 20px;">
                  <label
                    style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">Xç”¨æˆ·å</label>
                  <input type="text" id="character-x-name" placeholder="æ˜¾ç¤ºåç§°"
                    style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; outline: none;"
                    maxlength="50">
                </div>

                <!-- Xå¥æŸ„ -->
                <div style="margin-bottom: 20px;">
                  <label
                    style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">Xå¥æŸ„</label>
                  <div style="position: relative;">
                    <span
                      style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #71767b; font-size: 15px;">@</span>
                    <input type="text" id="character-x-handle" placeholder="username"
                      style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px 12px 12px 30px; font-size: 15px; outline: none;"
                      maxlength="15">
                  </div>
                </div>

                <!-- è®¤è¯çŠ¶æ€ -->
                <div style="margin-bottom: 20px;">
                  <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                    <input type="checkbox" id="character-x-verified"
                      style="width: 18px; height: 18px; accent-color: #1d9bf0;">
                    <span style="color: #fff; font-size: 15px; font-weight: 600;">è®¤è¯ç”¨æˆ·</span>
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #1d9bf0;">
                      <path
                        d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-2.5-1.668c-.326-.217-.413-.656-.196-.982.217-.326.656-.414.982-.196l1.875 1.25 3.75-5.625c.22-.33.66-.418.99-.196.33.22.418.66.196.99z" />
                    </svg>
                  </label>
                </div>

                <!-- èƒŒæ™¯å›¾è®¾ç½® -->
                <div style="margin-bottom: 24px;">
                  <label style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 12px;">èƒŒæ™¯å›¾ï¼ˆå°é¢å›¾ï¼‰</label>
                  <div style="margin-bottom: 12px;">
                    <img id="character-x-cover-preview" src="https://i.postimg.cc/qRzMB6nQ/default-cover.jpg" alt="èƒŒæ™¯å›¾é¢„è§ˆ"
                      style="width: 100%; height: 120px; border-radius: 8px; object-fit: cover; border: 1px solid #333;">
                  </div>
                  <div style="color: #71767b; font-size: 13px; margin-bottom: 8px;">èƒŒæ™¯å›¾é“¾æ¥</div>
                  <input type="url" id="character-x-cover-url" placeholder="https://example.com/cover.jpg"
                    style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; outline: none;"
                    oninput="updateCharacterXCover(this.value)" onfocus="this.style.borderColor='#1d9bf0'"
                    onblur="this.style.borderColor='#333'">
                  <div style="color: #71767b; font-size: 12px; margin-top: 4px;">
                    è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥URLï¼Œæ”¯æŒJPGã€PNGã€GIFæ ¼å¼
                  </div>
                </div>

                <!-- è‡ªå®šä¹‰æ ‡ç­¾1 -->
                <div style="margin-bottom: 24px;">
                  <label style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">è‡ªå®šä¹‰æ ‡ç­¾1</label>
                  <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" id="character-tag1-icon" placeholder="âœ¨" maxlength="2" style="
                      width: 50px;
                      background-color: #1a1a1a;
                      border: 1px solid #333;
                      border-radius: 4px;
                      color: #fff;
                      padding: 12px;
                      font-size: 17px;
                      outline: none;
                      text-align: center;
                    " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">
                    <input type="text" id="character-custom-tag1" placeholder="ä¾‹å¦‚ï¼šç§‘æŠ€åšä¸»" maxlength="30" style="
                      flex: 1;
                      background-color: #1a1a1a;
                      border: 1px solid #333;
                      border-radius: 4px;
                      color: #fff;
                      padding: 12px;
                      font-size: 15px;
                      outline: none;
                    " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">
                  </div>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <label style="color: #71767b; font-size: 12px; min-width: 40px;">é¢œè‰²:</label>
                    <input type="color" id="character-tag1-color" value="#71767b" style="
                      width: 40px;
                      height: 32px;
                      border: 1px solid #333;
                      border-radius: 4px;
                      background: transparent;
                      cursor: pointer;
                      outline: none;
                    ">
                  </div>
                </div>

                <!-- è‡ªå®šä¹‰æ ‡ç­¾2 -->
                <div style="margin-bottom: 24px;">
                  <label style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">è‡ªå®šä¹‰æ ‡ç­¾2</label>
                  <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" id="character-tag2-icon" placeholder="ğŸ“…" maxlength="2" style="
                      width: 50px;
                      background-color: #1a1a1a;
                      border: 1px solid #333;
                      border-radius: 4px;
                      color: #fff;
                      padding: 12px;
                      font-size: 17px;
                      outline: none;
                      text-align: center;
                    " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">
                    <input type="text" id="character-custom-tag2" placeholder="ä¾‹å¦‚ï¼š2024å¹´åŠ å…¥" maxlength="30" style="
                      flex: 1;
                      background-color: #1a1a1a;
                      border: 1px solid #333;
                      border-radius: 4px;
                      color: #fff;
                      padding: 12px;
                      font-size: 15px;
                      outline: none;
                    " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">
                  </div>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <label style="color: #71767b; font-size: 12px; min-width: 40px;">é¢œè‰²:</label>
                    <input type="color" id="character-tag2-color" value="#71767b" style="
                      width: 40px;
                      height: 32px;
                      border: 1px solid #333;
                      border-radius: 4px;
                      background: transparent;
                      cursor: pointer;
                      outline: none;
                    ">
                  </div>
                </div>

                <!-- æ­£åœ¨å…³æ³¨æ•°é‡ -->
                <div style="margin-bottom: 20px;">
                  <label style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">æ­£åœ¨å…³æ³¨æ•°é‡</label>
                  <input type="text" id="character-following-count" placeholder="156, 1.2K, 2.5Mç­‰" maxlength="20" style="
                    width: 100%;
                    background-color: #1a1a1a;
                    border: 1px solid #333;
                    border-radius: 8px;
                    color: #fff;
                    padding: 12px;
                    font-size: 15px;
                    outline: none;
                  " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">
                  <div style="color: #71767b; font-size: 12px; margin-top: 4px;">å¯è¾“å…¥ä»»æ„æ•°å­—ã€å­—æ¯ã€ç¬¦å·ç»„åˆ</div>
                </div>

                <!-- å…³æ³¨è€…æ•°é‡ -->
                <div style="margin-bottom: 20px;">
                  <label style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">å…³æ³¨è€…æ•°é‡</label>
                  <input type="text" id="character-followers-count" placeholder="89, 1.5K, 3.2Mç­‰" maxlength="20" style="
                    width: 100%;
                    background-color: #1a1a1a;
                    border: 1px solid #333;
                    border-radius: 8px;
                    color: #fff;
                    padding: 12px;
                    font-size: 15px;
                    outline: none;
                  " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">
                  <div style="color: #71767b; font-size: 12px; margin-top: 4px;">å¯è¾“å…¥ä»»æ„æ•°å­—ã€å­—æ¯ã€ç¬¦å·ç»„åˆ</div>
                </div>

                <!-- Xç®€ä»‹ -->
                <div style="margin-bottom: 20px;">
                  <label
                    style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">Xç®€ä»‹</label>
                  <textarea id="character-x-bio" placeholder="ä»‹ç»ä¸€ä¸‹è¿™ä¸ªè§’è‰²åœ¨Xä¸Šçš„èº«ä»½..."
                    style="width: 100%; min-height: 80px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; font-family: inherit;"
                    maxlength="160"></textarea>
                  <div style="text-align: right; color: #71767b; font-size: 13px; margin-top: 4px;">
                    <span id="character-bio-count">0</span>/160
                  </div>
                </div>

                <!-- å…¬ä¼—èº«ä»½è®¾ç½® -->
                <div style="margin-bottom: 20px;">
                  <label
                    style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">å…¬ä¼—èº«ä»½</label>
                  <div style="color: #71767b; font-size: 13px; margin-bottom: 8px; line-height: 1.4;">
                    æè¿°è§’è‰²åœ¨Xå¹³å°çš„å…¬ä¼—èº«ä»½ï¼ˆå¦‚æ˜æ˜Ÿã€ç½‘çº¢ã€åšä¸»ç­‰ï¼‰ã€‚è¿™å°†å½±å“å…¶ä»–ç”¨æˆ·å¯¹è¯¥è§’è‰²çš„è®¨è®ºå‡ ç‡ï¼Œèº«ä»½è¶ŠçŸ¥åå¯èƒ½å¼•èµ·æ›´å¤šå…³æ³¨å’Œè®¨è®ºã€‚æ­¤ä¿¡æ¯å®Œå…¨å…¬å¼€ã€‚
                  </div>

                  <!-- é‡è¦æé†’ -->
                  <div
                    style="background-color: rgba(29, 155, 240, 0.1); border: 1px solid #1d9bf0; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <div style="color: #1d9bf0; font-size: 13px; line-height: 1.4;">
                      <strong>ğŸ“Œ é‡è¦æé†’ï¼š</strong>è§’è‰²å°†æ ¹æ®å®Œæ•´äººè®¾è¿›è¡Œæ‰®æ¼”ï¼Œä½†<strong
                        style="color: #1d9bf0;">Xå¹³å°å…¶ä»–ç”¨æˆ·æ— æ³•è¯»å–è§’è‰²äººè®¾</strong>ï¼Œä»…èƒ½çœ‹åˆ°æ­¤å…¬ä¼—èº«ä»½ä¿¡æ¯ã€‚å¦‚éœ€è®©å…¶ä»–ç”¨æˆ·äº†è§£çš„è§’è‰²ç‰¹ç‚¹ã€èƒŒæ™¯æ•…äº‹ç­‰å†…å®¹ï¼Œè¯·å…¨éƒ¨è¯¦ç»†å¡«å†™è‡³å…¬ä¼—èº«ä»½ä¸­ã€‚
                    </div>
                  </div>

                  <textarea id="character-public-identity"
                    placeholder="ä¾‹å¦‚ï¼šçŸ¥åæ¼”å‘˜ã€æ­Œæ‰‹ã€ç½‘ç»œçº¢äººã€ä¸“ä¸šåšä¸»ç­‰... å¯è¯¦ç»†æè¿°è§’è‰²çš„å…¬å¼€èƒŒæ™¯ã€æˆå°±ã€ç‰¹ç‚¹ç­‰ï¼Œæ— å­—æ•°é™åˆ¶"
                    style="width: 100%; min-height: 120px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; font-family: inherit;"></textarea>
                  <div style="color: #71767b; font-size: 12px; margin-top: 4px;">
                    ğŸ’¡ æ— å­—æ•°é™åˆ¶ï¼Œå¯è¯¦ç»†æè¿°è§’è‰²çš„å…¬å¼€ä¿¡æ¯
                  </div>
                </div>

                <!-- çœŸåå…¬å¼€è®¾ç½® -->
                <div style="margin-bottom: 20px;">
                  <label
                    style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">çœŸåè®¾ç½®</label>
                  <div style="color: #71767b; font-size: 13px; margin-bottom: 12px; line-height: 1.4;">
                    é€‰æ‹©æ˜¯å¦å…¬å¼€è§’è‰²çš„çœŸå®å§“åã€‚å…¬å¼€åï¼Œå…¶ä»–ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°è§’è‰²çœŸåï¼Œæƒ…ä¾£è®¤è¯æ—¶ä¹Ÿä¼šæ˜¾ç¤ºåŒæ–¹çœŸåã€‚
                  </div>

                  <!-- æ˜¯å¦å…¬å¼€çœŸåå¤é€‰æ¡† -->
                  <div style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                      <input type="checkbox" id="character-show-real-name" style="
                        width: 16px;
                        height: 16px;
                        accent-color: #1d9bf0;
                      " onchange="toggleCharacterRealNameInput()">
                      <span style="color: #fff; font-size: 15px;">å…¬å¼€çœŸå®å§“å</span>
                    </label>
                  </div>

                  <!-- çœŸåè¾“å…¥æ¡† -->
                  <div id="character-real-name-input-container" style="display: none;">
                    <input type="text" id="character-real-name" placeholder="è¯·è¾“å…¥è§’è‰²çš„çœŸå®å§“å"
                      style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; outline: none;"
                      maxlength="50">
                    <div style="text-align: right; color: #71767b; font-size: 13px; margin-top: 4px;">
                      <span id="character-real-name-count">0</span>/50
                    </div>
                  </div>
                </div>

                <!-- NPCå…³ç³»ç»‘å®š -->
                <div style="margin-bottom: 20px;">
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <label style="color: #fff; font-size: 15px; font-weight: 600;">NPCå…³ç³»ç»‘å®š</label>
                    <button type="button" onclick="openAddRelationshipModal()"
                      style="background-color: #1d9bf0; color: #fff; border: none; border-radius: 16px; padding: 6px 12px; font-size: 12px; cursor: pointer;">
                      + æ·»åŠ å…³ç³»
                    </button>
                  </div>
                  <div style="color: #71767b; font-size: 13px; margin-bottom: 12px;">
                    ç»‘å®šNPCè§’è‰²ä½œä¸ºæœ‹å‹ã€äº²äººç­‰ï¼Œè®©è§’è‰²èƒ½å¤Ÿè¯†åˆ«å’Œäº’åŠ¨
                  </div>

                  <!-- å…³ç³»åˆ—è¡¨ -->
                  <div id="character-relationships-list" style="max-height: 200px; overflow-y: auto;">
                    <!-- å…³ç³»åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                  </div>
                </div>

                <!-- ä¿å­˜æŒ‰é’® -->
                <div style="display: flex; gap: 12px; margin-top: 32px;">
                  <button type="button" onclick="closeCharacterXProfileModal()"
                    style="flex: 1; background-color: transparent; color: #fff; border: 1px solid #536471; border-radius: 20px; padding: 12px 24px; font-size: 15px; font-weight: 700; cursor: pointer;">
                    å–æ¶ˆ
                  </button>
                  <button type="submit"
                    style="flex: 1; background-color: #1d9bf0; color: #fff; border: none; border-radius: 20px; padding: 12px 24px; font-size: 15px; font-weight: 700; cursor: pointer;">
                    ä¿å­˜Xèµ„æ–™
                  </button>
                </div>

              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- NPCå…³ç³»ç¼–è¾‘å¼¹çª— -->
      <div id="relationship-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 40; backdrop-filter: blur(8px);">
        <div style="display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px;">
          <div
            style="background-color: #000; border: 1px solid #333; border-radius: 16px; width: 100%; max-width: 500px;">

            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div
              style="display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 16px 20px; border-bottom: 1px solid #333;">
              <h3 id="relationship-modal-title" style="color: #fff; font-size: 18px; font-weight: 700; margin: 0;">
                æ·»åŠ NPCå…³ç³»</h3>
              <button onclick="closeRelationshipModal()"
                style="background: none; border: none; color: #71767b; cursor: pointer; padding: 8px;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                  <path
                    d="M18.36 6.64c.39.39.39 1.02 0 1.41L13.41 12l4.95 4.95c.39.39.39 1.02 0 1.41-.39.39-1.02.39-1.41 0L12 13.41l-4.95 4.95c-.39.39-1.02.39-1.41 0-.39-.39-.39-1.02 0-1.41L10.59 12 5.64 7.05c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0L12 10.59l4.95-4.95c.39-.39 1.02-.39 1.41 0z" />
                </svg>
              </button>
            </div>

            <!-- è¡¨å•å†…å®¹ -->
            <div style="padding: 20px;">
              <form id="relationship-form">

                <!-- NPCåç§° -->
                <div style="margin-bottom: 16px;">
                  <label
                    style="display: block; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">NPCåç§°</label>
                  <input type="text" id="relationship-npc-name" placeholder="è¾“å…¥NPCçš„åç§°"
                    style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; outline: none;"
                    maxlength="30">
                </div>

                <!-- NPCå¥æŸ„ -->
                <div style="margin-bottom: 16px;">
                  <label
                    style="display: block; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">NPCå¥æŸ„</label>
                  <div style="position: relative;">
                    <span
                      style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #71767b; font-size: 14px;">@</span>
                    <input type="text" id="relationship-npc-handle" placeholder="npc_username"
                      style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px 12px 12px 30px; font-size: 14px; outline: none;"
                      maxlength="15">
                  </div>
                </div>

                <!-- å…³ç³»ç±»å‹ -->
                <div style="margin-bottom: 16px;">
                  <label
                    style="display: block; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">å…³ç³»ç±»å‹</label>
                  <select id="relationship-type"
                    style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; outline: none;">
                    <option value="æœ‹å‹">æœ‹å‹</option>
                    <option value="äº²äºº">äº²äºº</option>
                    <option value="æ‹äºº">æ‹äºº</option>
                    <option value="åŒäº‹">åŒäº‹</option>
                    <option value="åŒå­¦">åŒå­¦</option>
                    <option value="é‚»å±…">é‚»å±…</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                  </select>
                </div>

                <!-- å…³ç³»æè¿° -->
                <div style="margin-bottom: 20px;">
                  <label
                    style="display: block; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">å…³ç³»æè¿°</label>
                  <textarea id="relationship-description" placeholder="è¯¦ç»†æè¿°ä¸¤äººçš„å…³ç³»ï¼Œå¦‚ä½•è®¤è¯†çš„ï¼Œç›¸å¤„æ¨¡å¼ç­‰..."
                    style="width: 100%; min-height: 80px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; resize: vertical; outline: none; font-family: inherit;"
                    maxlength="200"></textarea>
                  <div style="text-align: right; color: #71767b; font-size: 12px; margin-top: 4px;">
                    <span id="relationship-desc-count">0</span>/200
                  </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div style="display: flex; gap: 12px;">
                  <button type="button" onclick="closeRelationshipModal()"
                    style="flex: 1; background-color: transparent; color: #fff; border: 1px solid #536471; border-radius: 20px; padding: 10px 20px; font-size: 14px; font-weight: 700; cursor: pointer;">
                    å–æ¶ˆ
                  </button>
                  <button type="submit"
                    style="flex: 1; background-color: #1d9bf0; color: #fff; border: none; border-radius: 20px; padding: 10px 20px; font-size: 14px; font-weight: 700; cursor: pointer;">
                    ä¿å­˜å…³ç³»
                  </button>
                </div>

              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- æœç´¢é¡µé¢ -->
      <div id="x-search-page" class="x-page"
        style="flex: 1; display: none; flex-direction: column; overflow: hidden; min-height: 0;">
        
        <!-- æœç´¢æ¡† -->
        <div class="search-header">
          <button id="search-back-btn" onclick="backToTrending()" style="
            display: none;
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            margin-right: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
          " onmouseover="this.style.backgroundColor='rgba(239,243,244,0.1)'"
            onmouseout="this.style.backgroundColor='transparent'">
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
              <g><path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path></g>
            </svg>
          </button>
          <div class="search-box">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <g><path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"></path></g>
            </svg>
            <input type="text" placeholder="æœç´¢ X" id="search-input" 
              oninput="toggleSearchButton()" 
              onkeydown="if(event.key==='Enter') performSearch()">
            <button id="search-submit-btn" onclick="performSearch()" style="
              display: none;
              background: none;
              border: none;
              padding: 8px;
              cursor: pointer;
              border-radius: 50%;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'"
              onmouseout="this.style.backgroundColor='transparent'">
              <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #1d9bf0;">
                <g><path d="M2.504 21.866l.526-2.108C3.04 19.719 4 15.823 4 12s-.96-7.719-.97-7.757l-.527-2.109L22.236 12 2.504 21.866zM5.981 13c-.072 1.962-.34 3.833-.583 5.183L17.764 12 5.398 5.818c.242 1.349.51 3.221.583 5.183H10v2H5.981z"></path></g>
              </svg>
            </button>
          </div>
        </div>

        <!-- çƒ­æœè§†å›¾ -->
        <div id="trending-view" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
          <!-- åˆ†ç±»æ ‡ç­¾ -->
          <div class="search-tabs">
            <div class="search-tab active" onclick="switchSearchTab('recommended')">ä¸ºä½ æ¨è</div>
            <div class="search-tab" onclick="switchSearchTab('trending')">å½“å‰è¶‹åŠ¿</div>
            <div class="add-category-btn" onclick="openAddCategoryModal()" title="æ·»åŠ è‡ªå®šä¹‰åˆ†ç±»">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <g><path d="M19.5 12.75h-6.75V19.5h-1.5v-6.75H4.5v-1.5h6.75V4.5h1.5v6.75h6.75v1.5z"></path></g>
              </svg>
            </div>
          </div>

          <!-- çƒ­æœåˆ—è¡¨ -->
          <div class="trending-list" id="trending-list">
            <!-- çƒ­æœé¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- æœç´¢ç»“æœè§†å›¾ -->
        <div id="search-results-view" style="display: none; flex-direction: column; flex: 1; overflow: hidden;">
          <!-- æœç´¢ç»“æœæ ‡ç­¾æ  -->
          <div class="search-tabs">
            <div class="search-tab active" onclick="switchSearchResultTab('top')">çƒ­é—¨</div>
            <div class="search-tab" onclick="switchSearchResultTab('latest')">æœ€æ–°</div>
            <div class="search-tab" onclick="switchSearchResultTab('users')">ç”¨æˆ·</div>
          </div>

          <!-- æœç´¢ç»“æœå†…å®¹ -->
          <div id="search-results-content" style="
            flex: 1;
            overflow-y: auto;
            background: #000;
          ">
            <!-- æœç´¢ç»“æœå°†åŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- åˆ·æ–°æŒ‰é’® -->
        <button class="refresh-trends-btn" onclick="refreshTrends()" title="åˆ·æ–°çƒ­æœ">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>
          </svg>
        </button>
      </div>

      <!-- è‡ªå®šä¹‰åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡† -->
      <div id="category-manager-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 30;
        overflow-y: auto;
        backdrop-filter: blur(8px);
      " onclick="closeCategoryModal(event)">
        <div style="
          background-color: #000;
          margin: 40px auto;
          border-radius: 16px;
          max-width: 600px;
          width: calc(100% - 40px);
          border: 1px solid #333;
        " onclick="event.stopPropagation()">
          <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
          <div style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #333;
          ">
            <h2 style="color: #fff; font-size: 20px; font-weight: 700; margin: 0;">ç®¡ç†çƒ­æœåˆ†ç±»</h2>
            <div onclick="closeCategoryModal()" style="
              cursor: pointer;
              padding: 8px;
              border-radius: 50%;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='rgba(239,243,244,0.1)'"
              onmouseout="this.style.backgroundColor='transparent'">
              <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
                <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>
              </svg>
            </div>
          </div>

          <!-- æ¨¡æ€æ¡†å†…å®¹ -->
          <div style="padding: 20px; max-height: calc(100vh - 200px); overflow-y: auto;">
            <!-- è¯´æ˜ -->
            <div style="
              background-color: rgba(29, 155, 240, 0.1);
              border: 1px solid #1d9bf0;
              border-radius: 8px;
              padding: 12px;
              margin-bottom: 20px;
            ">
              <p style="color: #1d9bf0; font-size: 13px; line-height: 1.4; margin: 0;">
                ğŸ’¡ è‡ªå®šä¹‰åˆ†ç±»å°†åœ¨åˆ·æ–°çƒ­æœæ—¶ç”Ÿæˆç›¸åº”å†…å®¹ã€‚å¯ä»¥æ·»åŠ ä»»æ„åˆ†ç±»ï¼ˆå¦‚"åŠ¨æ¼«"ã€"äºŒæ¬¡å…ƒ"ç­‰ï¼‰ï¼Œå¹¶æè¿°è¯¥åˆ†ç±»ä¸‹çš„å†…å®¹ç±»å‹ã€‚
              </p>
            </div>

            <!-- è‡ªå®šä¹‰åˆ†ç±»åˆ—è¡¨ -->
            <div style="margin-bottom: 20px;">
              <div style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 12px;
              ">
                <h3 style="color: #fff; font-size: 16px; font-weight: 600; margin: 0;">è‡ªå®šä¹‰åˆ†ç±»</h3>
                <button onclick="addNewCategory()" style="
                  background-color: #1d9bf0;
                  color: #fff;
                  border: none;
                  border-radius: 20px;
                  padding: 6px 16px;
                  font-size: 14px;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.2s;
                " onmouseover="this.style.backgroundColor='#1a8cd8'"
                  onmouseout="this.style.backgroundColor='#1d9bf0'">
                  + æ·»åŠ åˆ†ç±»
                </button>
              </div>

              <!-- åˆ†ç±»åˆ—è¡¨å®¹å™¨ -->
              <div id="custom-categories-list" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- åˆ†ç±»é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
              </div>
            </div>

            <!-- ä¿å­˜æŒ‰é’® -->
            <button onclick="saveCustomCategories()" style="
              width: 100%;
              background-color: #1d9bf0;
              color: #fff;
              border: none;
              border-radius: 25px;
              padding: 14px;
              font-size: 16px;
              font-weight: 700;
              cursor: pointer;
              transition: all 0.2s;
            " onmouseover="this.style.backgroundColor='#1a8cd8'"
              onmouseout="this.style.backgroundColor='#1d9bf0'">
              ä¿å­˜è®¾ç½®
            </button>
          </div>
        </div>
      </div>

      <!-- é€šçŸ¥é¡µé¢ -->
      <div id="x-notifications-page" class="x-page"
        style="flex: 1; display: none; flex-direction: column; overflow: hidden; min-height: 0;">
        <div style="flex: 1; display: flex; justify-content: center; align-items: center;">
          <div style="font-size: 24px; color: #888;">é€šçŸ¥</div>
        </div>
      </div>

      <!-- ç§ä¿¡é¡µé¢ -->
      <div id="x-messages-page" class="x-page"
        style="flex: 1; display: none; flex-direction: column; overflow: hidden; min-height: 0;">
        <div style="flex: 1; display: flex; justify-content: center; align-items: center;">
          <div style="font-size: 24px; color: #888;">ç§ä¿¡</div>
        </div>
      </div>

      <!-- æ¨æ–‡è¯„è®ºé¡µé¢ -->
      <div id="x-comments-page" class="x-page"
        style="flex: 1; display: none; flex-direction: column; overflow: hidden; min-height: 0;">

        <!-- è¯„è®ºé¡µé¢é¡¶éƒ¨æ  -->
        <div class="comments-header"
          style="display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #333;">
          <div class="comments-back-btn" onclick="switchXPage('home')" style="cursor: pointer; margin-right: 15px;">
            <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: #fff;">
              <g>
                <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path>
              </g>
            </svg>
          </div>
          <span style="font-size: 20px; font-weight: 700;">å‘å¸–</span>
        </div>

        <!-- è¯„è®ºåˆ—è¡¨å®¹å™¨ -->
        <div class="comments-container" style="flex: 1; padding: 0; overflow-y: auto; min-height: 0;">
          <!-- è¯„è®ºå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>

        <!-- è¯„è®ºè¾“å…¥åŒºåŸŸ -->
        <div class="comment-input-area" style="border-top: 1px solid #333; padding: 15px; background-color: #000;">
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <!-- ç”¨æˆ·å¤´åƒ -->
            <img id="comment-user-avatar" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="Your avatar"
              style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;">

            <!-- è¾“å…¥æ¡†å®¹å™¨ -->
            <div style="flex: 1;">
              <textarea id="comment-input" placeholder="å‘å¸ƒä½ çš„å›å¤"
                style="width: 100%; min-height: 20px; max-height: 120px; background: transparent; border: none; color: #fff; font-size: 20px; resize: none; outline: none; font-family: inherit; line-height: 1.3;"
                onkeydown="handleCommentInput(event)" oninput="autoResize(this)"></textarea>

              <!-- è¾“å…¥æ¡†åº•éƒ¨å·¥å…·æ  -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <!-- å·¦ä¾§å·¥å…·å›¾æ ‡ -->
                <div style="display: flex; gap: 15px;">
                  <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #1d9bf0; cursor: pointer;" onclick="triggerCommentImageUpload()">
                    <g>
                      <path
                        d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">
                      </path>
                    </g>
                  </svg>
                  <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #1d9bf0; cursor: pointer; opacity: 0.5;">
                    <g>
                      <path
                        d="M3 5.5C3 4.119 4.12 3 5.5 3h13C19.88 3 21 4.119 21 5.5v13c0 1.381-1.12 2.5-2.5 2.5h-13C4.12 21 3 19.881 3 18.5v-13zM5.5 5c-.28 0-.5.224-.5.5v13c0 .276.22.5.5.5h13c.28 0 .5-.224.5-.5v-13c0-.276-.22-.5-.5-.5h-13zM18 10.711V9.25h-3.74v5.5h1.44v-1.719h1.7V11.57h-1.7v-.859H18zM11.79 9.25h1.44v5.5h-1.44v-5.5zm-3.07 1.375c.34 0 .77.172 1.02.43l1.03-.86c-.51-.601-1.28-.945-2.05-.945C7.19 9.25 6 10.453 6 12s1.19 2.75 2.72 2.75c.77 0 1.54-.344 2.05-.945l-1.03-.86c-.25.258-.68.43-1.02.43-.76 0-1.29-.546-1.29-1.375S8.03 10.625 8.79 10.625z">
                      </path>
                    </g>
                  </svg>
                  <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #1d9bf0; cursor: pointer; opacity: 0.5;">
                    <g>
                      <path
                        d="M8 9.5C8 8.119 8.672 7 9.5 7S11 8.119 11 9.5 10.328 12 9.5 12 8 10.881 8 9.5zm6.5 2.5c.828 0 1.5-1.119 1.5-2.5S15.328 7 14.5 7 13 8.119 13 9.5s.672 2.5 1.5 2.5zM12 16c-2.224 0-3.021-2.227-3.051-2.316l-1.897.633c.05.15 1.271 3.684 4.949 3.684s4.898-3.533 4.949-3.684l-1.896-.638c-.033.095-.83 2.322-3.053 2.322zm10.25-4.001c0 5.652-4.598 10.25-10.25 10.25S1.75 17.652 1.75 12 6.348 1.75 12 1.75 22.25 6.348 22.25 12zm-2 0c0-4.549-3.701-8.25-8.25-8.25S3.75 7.451 3.75 12s3.701 8.25 8.25 8.25 8.25-3.701 8.25-8.25z">
                      </path>
                    </g>
                  </svg>
                </div>

                <!-- å³ä¾§å‘é€æŒ‰é’® -->
                <button id="reply-btn" onclick="submitComment()"
                  style="background-color: #1d9bf0; color: #fff; border: none; border-radius: 20px; padding: 8px 20px; font-size: 15px; font-weight: 700; cursor: pointer; opacity: 0.5;"
                  disabled>
                  å›å¤
                </button>
              </div>
              
              <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
              <div id="comment-image-preview" style="display: none; margin-top: 12px; position: relative;">
                <img id="comment-image-preview-img" src="" style="max-width: 200px; max-height: 200px; border-radius: 12px; display: block;">
                <button onclick="removeCommentImage()" 
                  style="position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.75); border: none; border-radius: 50%; width: 28px; height: 28px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                  <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #fff;">
                    <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>
                  </svg>
                </button>
              </div>
              
              <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
              <input type="file" id="comment-image-input" accept="image/*" style="display: none;" onchange="handleCommentImageUpload(event)">
            </div>
          </div>
        </div>
      </div>

      <!-- Xè®¾ç½®é¡µé¢ -->
      <div id="x-settings-page" class="x-page"
        style="flex: 1; display: none; flex-direction: column; overflow: hidden; min-height: 0;">

        <!-- è®¾ç½®é¡µé¢é¡¶éƒ¨æ  -->
        <div class="settings-header"
          style="display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #333; background-color: #000;">
          <div class="settings-back-btn" onclick="switchXPage('home')" style="cursor: pointer; margin-right: 15px;">
            <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: #fff;">
              <g>
                <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path>
              </g>
            </svg>
          </div>
          <span style="font-size: 20px; font-weight: 700; color: #fff;">è®¾ç½®</span>
        </div>

        <!-- è®¾ç½®å†…å®¹åŒºåŸŸ -->
        <div class="settings-content"
          style="flex: 1; padding: 15px; width: 100%; box-sizing: border-box; overflow-y: auto; min-height: 0;">

          <!-- æç¤ºè¯è®¾ç½® -->
          <div class="settings-section" style="margin-bottom: 30px;">
            <label style="display: block; color: #fff; font-size: 17px; font-weight: 600; margin-bottom: 10px;">
              æç¤ºè¯
            </label>
            <textarea id="x-system-prompt" placeholder="è¾“å…¥ç³»ç»Ÿæç¤ºè¯..."
              style="width: 100%; min-height: 120px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; font-family: inherit; line-height: 1.4;"
              onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'"></textarea>
          </div>

          <!-- ä¸–ç•Œè§‚è®¾å®š -->
          <div class="settings-section" style="margin-bottom: 30px;">
            <label style="display: block; color: #fff; font-size: 17px; font-weight: 600; margin-bottom: 10px;">
              ä¸–ç•Œè§‚è®¾å®š
            </label>
            <textarea id="x-world-setting" placeholder="æè¿°è§’è‰²æ‰€åœ¨çš„ä¸–ç•Œè§‚ã€èƒŒæ™¯è®¾å®š..."
              style="width: 100%; min-height: 100px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; font-family: inherit; line-height: 1.4;"
              onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'"></textarea>
          </div>

          <!-- è§’è‰²ç»‘å®šè®¾ç½® -->
          <div class="settings-section" style="margin-bottom: 40px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
              <label style="color: #fff; font-size: 17px; font-weight: 600;">
                ç»‘å®šè§’è‰²
              </label>
              <div class="x-toggle" onclick="toggleCharacterBinding()" style="cursor: pointer;">
                <div id="x-character-toggle" class="toggle-switch"
                  style="width: 50px; height: 30px; background-color: #333; border-radius: 15px; position: relative; transition: all 0.3s ease;">
                  <div class="toggle-circle"
                    style="width: 26px; height: 26px; background-color: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.3s ease;">
                  </div>
                </div>
              </div>
            </div>
            <p style="color: #71767b; font-size: 14px; margin: 0 0 15px 0; line-height: 1.4;">
              å¼€å¯åï¼Œç»‘å®šçš„è§’è‰²å¯ä»¥åœ¨Xä¸Šå‘å¸ƒæ¨æ–‡
            </p>

            <!-- è§’è‰²é€‰æ‹©åŒºåŸŸ -->
            <div id="character-binding-area" style="display: none;">
              <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px;">
                <div style="color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 12px;">é€‰æ‹©è¦ç»‘å®šçš„è§’è‰²</div>
                <div id="characters-list" style="max-height: 300px; overflow-y: auto;">
                  <!-- è§’è‰²åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
              </div>
            </div>
          </div>

          <!-- NPCç»‘å®šè®¾ç½® -->
          <div class="settings-section" style="margin-bottom: 40px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
              <label style="color: #fff; font-size: 17px; font-weight: 600;">
                ç»‘å®šNPC
              </label>
              <div class="x-toggle" onclick="toggleNPCBinding()" style="cursor: pointer;">
                <div id="x-npc-toggle" class="toggle-switch"
                  style="width: 50px; height: 30px; background-color: #333; border-radius: 15px; position: relative; transition: all 0.3s ease;">
                  <div class="toggle-circle"
                    style="width: 26px; height: 26px; background-color: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.3s ease;">
                  </div>
                </div>
              </div>
            </div>
            <p style="color: #71767b; font-size: 14px; margin: 0 0 15px 0; line-height: 1.4;">
              å¼€å¯åï¼Œå¯ä»¥åˆ›å»ºå’Œç®¡ç†è‡ªå®šä¹‰NPCï¼Œè®¾ç½®å…¶äººè®¾ã€å‘å¸–ä¹ æƒ¯å’Œç»‘å®šç”¨æˆ·
            </p>

            <!-- NPCç®¡ç†åŒºåŸŸ -->
            <div id="npc-binding-area" style="display: none;">
              <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                  <div style="color: #fff; font-size: 15px; font-weight: 600;">NPCåˆ—è¡¨</div>
                  <button onclick="openCreateNPCModal()" style="
                    background-color: #1d9bf0;
                    color: #fff;
                    border: none;
                    border-radius: 20px;
                    padding: 6px 16px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                  " onmouseover="this.style.backgroundColor='#1a8cd8'" onmouseout="this.style.backgroundColor='#1d9bf0'">
                    + åˆ›å»ºNPC
                  </button>
                </div>
                <div id="npcs-list" style="max-height: 300px; overflow-y: auto;">
                  <!-- NPCåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
              </div>
            </div>
          </div>

          <!-- æŒ‰é’®åŒºåŸŸ -->
          <div class="settings-buttons" style="display: flex; flex-direction: column; gap: 12px;">
            <!-- ä¿å­˜æŒ‰é’® -->
            <button onclick="saveXSettings()"
              style="width: 100%; background-color: #1d9bf0; color: #fff; border: none; border-radius: 25px; padding: 12px 24px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s;"
              onmouseover="this.style.backgroundColor='#1a8cd8'" onmouseout="this.style.backgroundColor='#1d9bf0'">
              ä¿å­˜è®¾ç½®
            </button>

            <!-- ä¿å­˜é¢„è®¾æŒ‰é’® -->
            <button onclick="saveXPreset()"
              style="width: 100%; background-color: #1d9bf0; color: #fff; border: none; border-radius: 25px; padding: 12px 24px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s;"
              onmouseover="this.style.backgroundColor='#1a8cd8'" onmouseout="this.style.backgroundColor='#1d9bf0'">
              ä¿å­˜ä¸ºé¢„è®¾
            </button>

            <!-- å¯¼å…¥å¯¼å‡ºæŒ‰é’®ç»„ -->
            <div style="display: flex; gap: 12px;">
              <button onclick="importXData()"
                style="flex: 1; background-color: #1d9bf0; color: #fff; border: none; border-radius: 25px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.backgroundColor='#1a8cd8'" onmouseout="this.style.backgroundColor='#1d9bf0'">
                å¯¼å…¥æ•°æ®
              </button>
              <button onclick="exportXData()"
                style="flex: 1; background-color: #1d9bf0; color: #fff; border: none; border-radius: 25px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.backgroundColor='#1a8cd8'" onmouseout="this.style.backgroundColor='#1d9bf0'">
                å¯¼å‡ºæ•°æ®
              </button>
            </div>
          </div>

          <!-- é¢„è®¾ç®¡ç†åŒºåŸŸ -->
          <div class="preset-management" style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #333;">
            <h3 style="color: #fff; font-size: 18px; font-weight: 700; margin-bottom: 15px;">é¢„è®¾ç®¡ç†</h3>
            <div id="x-presets-list" style="display: flex; flex-direction: column;">
              <!-- é¢„è®¾åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
        </div>
      </div>

      <!-- æ¨æ–‡è¯¦æƒ…é¡µé¢ -->
      <div id="x-tweet-detail-page" class="x-page"
        style="flex: 1; display: none; flex-direction: column; overflow: hidden;">

        <!-- è¯¦æƒ…é¡µé¢é¡¶éƒ¨æ  -->
        <div class="tweet-detail-header"
          style="display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #333; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 5;">
          <div style="display: flex; align-items: center;">
            <div class="tweet-detail-back-btn" onclick="switchXPage('home')"
              style="cursor: pointer; margin-right: 15px;">
              <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: #fff;">
                <g>
                  <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path>
                </g>
              </svg>
            </div>
            <span style="font-size: 20px; font-weight: 700; color: #fff;">å¸–å­</span>
          </div>

          <!-- é‡å›æŒ‰é’® -->
          <div id="reroll-replies-btn" onclick="rerollAIReplies()" style="
             display: flex;
             align-items: center;
             justify-content: center;
             width: 32px;
             height: 32px;
             background-color: transparent;
             border: none;
             border-radius: 50%;
             cursor: pointer;
             transition: all 0.2s;
           " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'"
            onmouseout="this.style.backgroundColor='transparent'">
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
              <g>
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </g>
            </svg>
          </div>
        </div>

        <!-- æ¨æ–‡è¯¦æƒ…å†…å®¹ -->
        <div class="tweet-detail-content" style="flex: 1; overflow-y: auto;">
          <div id="tweet-detail-container" style="padding: 0;">
            <!-- æ¨æ–‡è¯¦æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
          </div>

          <!-- è¯„è®ºåŒºåŸŸ -->
          <div style="border-top: 1px solid #2f3336; margin-top: 20px;">
            <!-- è¯„è®ºè¾“å…¥åŒºåŸŸ -->
            <div class="detail-comment-input-area"
              style="border-bottom: 1px solid #333; padding: 15px; background-color: #000;">
              <div style="display: flex; align-items: flex-start; gap: 12px;">
                <!-- ç”¨æˆ·å¤´åƒ -->
                <img id="detail-comment-user-avatar" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="Your avatar"
                  style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;">

                <!-- è¾“å…¥æ¡†å®¹å™¨ -->
                <div style="flex: 1;">
                  <textarea id="detail-comment-input" placeholder="å‘å¸ƒä½ çš„å›å¤"
                    style="width: 100%; min-height: 20px; max-height: 120px; background: transparent; border: none; color: #fff; font-size: 20px; resize: none; outline: none; font-family: inherit; line-height: 1.3;"
                    onkeydown="handleDetailCommentInput(event)" oninput="autoResizeDetail(this)"></textarea>

                  <!-- è¾“å…¥æ¡†åº•éƒ¨å·¥å…·æ  -->
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <!-- å·¦ä¾§å·¥å…·å›¾æ ‡ -->
                    <div style="display: flex; gap: 15px;">
                      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #1d9bf0; cursor: pointer;" onclick="triggerDetailCommentImageUpload()">
                        <g>
                          <path
                            d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">
                          </path>
                        </g>
                      </svg>
                      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #1d9bf0; cursor: pointer; opacity: 0.5;">
                        <g>
                          <path
                            d="M3 5.5C3 4.119 4.12 3 5.5 3h13C19.88 3 21 4.119 21 5.5v13c0 1.381-1.12 2.5-2.5 2.5h-13C4.12 21 3 19.881 3 18.5v-13zM5.5 5c-.28 0-.5.224-.5.5v13c0 .276.22.5.5.5h13c.28 0 .5-.224.5-.5v-13c0-.276-.22-.5-.5-.5h-13zM18 10.711V9.25h-3.74v5.5h1.44v-1.719h1.7V11.57h-1.7v-.859H18zM11.79 9.25h1.44v5.5h-1.44v-5.5zm-3.07 1.375c.34 0 .77.172 1.02.43l1.03-.86c-.51-.601-1.28-.945-2.05-.945C7.19 9.25 6 10.453 6 12s1.19 2.75 2.72 2.75c.77 0 1.54-.344 2.05-.945l-1.03-.86c-.25.258-.68.43-1.02.43-.76 0-1.29-.546-1.29-1.375S8.03 10.625 8.79 10.625z">
                          </path>
                        </g>
                      </svg>
                      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #1d9bf0; cursor: pointer; opacity: 0.5;">
                        <g>
                          <path
                            d="M8 9.5C8 8.119 8.672 7 9.5 7S11 8.119 11 9.5 10.328 12 9.5 12 8 10.881 8 9.5zm6.5 2.5c.828 0 1.5-1.119 1.5-2.5S15.328 7 14.5 7 13 8.119 13 9.5s.672 2.5 1.5 2.5zM12 16c-2.224 0-3.021-2.227-3.051-2.316l-1.897.633c.05.15 1.271 3.684 4.949 3.684s4.898-3.533 4.949-3.684l-1.896-.638c-.033.095-.83 2.322-3.053 2.322zm10.25-4.001c0 5.652-4.598 10.25-10.25 10.25S1.75 17.652 1.75 12 6.348 1.75 12 1.75 22.25 6.348 22.25 12zm-2 0c0-4.549-3.701-8.25-8.25-8.25S3.75 7.451 3.75 12s3.701 8.25 8.25 8.25 8.25-3.701 8.25-8.25z">
                          </path>
                        </g>
                      </svg>
                    </div>

                    <!-- å³ä¾§å‘é€æŒ‰é’® -->
                    <button id="detail-reply-btn" onclick="submitDetailComment()"
                      style="background-color: #1d9bf0; color: #fff; border: none; border-radius: 20px; padding: 8px 20px; font-size: 15px; font-weight: 700; cursor: pointer; opacity: 0.5;"
                      disabled>
                      å›å¤
                    </button>
                  </div>
                  
                  <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
                  <div id="detail-comment-image-preview" style="display: none; margin-top: 12px; position: relative;">
                    <img id="detail-comment-image-preview-img" src="" style="max-width: 200px; max-height: 200px; border-radius: 12px; display: block;">
                    <button onclick="removeDetailCommentImage()" 
                      style="position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.75); border: none; border-radius: 50%; width: 28px; height: 28px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                      <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #fff;">
                        <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>
                      </svg>
                    </button>
                  </div>
                  
                  <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                  <input type="file" id="detail-comment-image-input" accept="image/*" style="display: none;" onchange="handleDetailCommentImageUpload(event)">
                </div>
              </div>
            </div>

            <!-- è¯„è®ºåˆ—è¡¨å®¹å™¨ -->
            <div id="detail-comments-container" style="padding: 0;">
              <!-- è¯„è®ºå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
          </div>
        </div>
      </div>

      <!-- ç”¨æˆ·ä¸»é¡µ -->
      <div id="x-profile-page" class="x-page" style="flex: 1; display: none; flex-direction: column; overflow-y: auto;">

        <!-- ä¸»é¡µé¡¶éƒ¨æ  -->
        <div class="profile-header"
          style="display: flex; align-items: center; padding: 10px 15px; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(12px); position: relative; z-index: 5;">
          <div class="profile-back-btn" onclick="switchXPage('home')" style="cursor: pointer; margin-right: 15px;">
            <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: #fff;">
              <g>
                <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path>
              </g>
            </svg>
          </div>
          <div style="flex: 1;">
            <div id="x-profile-header-name" style="font-size: 20px; font-weight: 700; color: #fff;">æˆ‘</div>
            <div id="x-profile-header-count" style="font-size: 13px; color: #71767b;">0 å¸–å­</div>
          </div>
          <div style="display: flex; gap: 15px;">
            <!-- æé—®ç®±æŒ‰é’® -->
            <div onclick="switchXPage('askbox')" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s;"
              onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'"
              onmouseout="this.style.backgroundColor='transparent'"
              title="æé—®ç®±">
              <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: #fff;">
                <g>
                  <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                </g>
              </svg>
            </div>
            <!-- æ›´å¤šé€‰é¡¹æŒ‰é’® -->
            <div id="profile-menu-btn" onclick="toggleProfileMenu()"
              style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; position: relative;"
              onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'"
              onmouseout="this.style.backgroundColor='transparent'">
              <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: #fff;">
                <g>
                  <path
                    d="M3 12c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9 2c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm7 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z">
                  </path>
                </g>
              </svg>
              <!-- ä¸‹æ‹‰èœå• -->
              <div id="profile-dropdown-menu" style="
                display: none;
                position: absolute;
                top: 100%;
                right: 0;
                background-color: #1a1a1a;
                border: 1px solid #333;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                min-width: 200px;
                z-index: 50;
                margin-top: 8px;
                overflow: hidden;
              ">
                <div onclick="openAccountManager()" style="
                  padding: 12px 16px;
                  color: #fff;
                  font-size: 15px;
                  cursor: pointer;
                  transition: background-color 0.2s;
                  display: flex;
                  align-items: center;
                  gap: 12px;
                " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.03)'"
                  onmouseout="this.style.backgroundColor='transparent'">
                  <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">
                    <g>
                      <path
                        d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L19 6.5C18.5 4.4 16.6 2.5 14.5 2L14 0H10L9.5 2C7.4 2.5 5.5 4.4 5 6.5L3 7V9L5 9.5C5.5 11.6 7.4 13.5 9.5 14L10 16H14L14.5 14C16.6 13.5 18.5 11.6 19 9.5L21 9ZM12 8C13.66 8 15 9.34 15 11C15 12.66 13.66 14 12 14C10.34 14 9 12.66 9 11C9 9.34 10.34 8 12 8ZM19 17H5V19H19V17ZM12 20C10.9 20 10 20.9 10 22H14C14 20.9 13.1 20 12 20Z">
                      </path>
                    </g>
                  </svg>
                  è´¦å·ç®¡ç†
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- å°é¢å›¾åŒºåŸŸ -->
        <div class="cover-section" style="position: relative; height: 140px; background-color: #333;">
          <img id="x-profile-cover-image" src="https://i.postimg.cc/qRzMB6nQ/default-cover.jpg"
            style="width: 100%; height: 100%; object-fit: cover; display: block;" alt="å°é¢å›¾">
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
        <div class="user-info-section" style="padding: 8px 16px 0; position: relative;">
          <!-- ç”¨æˆ·å¤´åƒ -->
          <div style="position: relative; margin-bottom: 8px;">
            <img id="x-profile-main-avatar" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg"
              style="width: 88px; height: 88px; border-radius: 50%; border: 5px solid #000; position: absolute; top: -44px; left: 0;"
              alt="ç”¨æˆ·å¤´åƒ">
          </div>

          <!-- ç¼–è¾‘èµ„æ–™æŒ‰é’® -->
          <div style="display: flex; justify-content: flex-end; margin: 8px 0;">
            <button onclick="editProfile()"
              style="background-color: transparent; color: #fff; border: 1px solid #536471; border-radius: 20px; padding: 6px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
              onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'"
              onmouseout="this.style.backgroundColor='transparent'">
              ç¼–è¾‘ä¸ªäººèµ„æ–™
            </button>
          </div>

          <!-- ç”¨æˆ·åå’Œè®¤è¯ -->
          <div style="margin-top: 30px; margin-bottom: 4px; padding-left: 8px;">
            <div style="display: flex; align-items: center; gap: 2px; margin-bottom: 0;">
              <span id="x-profile-user-name" style="font-size: 20px; font-weight: 700; color: #fff;">æˆ‘</span>
              <svg id="x-profile-verified-badge" viewBox="0 0 24 24"
                style="width: 20px; height: 20px; fill: #1d9bf0; display: none;">
                <g>
                  <path
                    d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z">
                  </path>
                </g>
              </svg>
            </div>
            <div id="x-profile-user-handle" style="font-size: 15px; color: #71767b; margin-bottom: 10px;">@me</div>
          </div>

          <!-- ä¸ªäººç®€ä»‹ -->
          <div id="x-profile-bio" style="font-size: 15px; color: #fff; line-height: 1.3; margin-bottom: 10px; padding-left: 8px;">
            æ¬¢è¿æ¥åˆ°æˆ‘çš„Xä¸»é¡µï¼
          </div>

          <!-- è‡ªå®šä¹‰æ ‡ç­¾ -->
          <div class="profile-tags"
            style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; padding-left: 8px;">
            <div style="display: flex; align-items: center; gap: 4px;">
              <span id="x-profile-tag1-icon" style="font-size: 14px;">âœ¨</span>
              <span id="x-profile-tag1" style="color: #71767b; font-size: 14px;">ç§‘æŠ€çˆ±å¥½è€…</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px;">
              <span id="x-profile-tag2-icon" style="font-size: 14px;">ğŸ“…</span>
              <span id="x-profile-tag2" style="color: #71767b; font-size: 14px;">2024å¹´åŠ å…¥</span>
            </div>
          </div>

          <!-- å…³æ³¨æ•°æ® -->
          <div style="display: flex; gap: 16px; margin-bottom: 12px; padding-left: 8px;">
            <div style="cursor: pointer;" onmouseover="this.querySelector('span').style.textDecoration='underline'"
              onmouseout="this.querySelector('span').style.textDecoration='none'">
              <span id="x-profile-following-count" style="color: #fff; font-weight: 700; font-size: 14px;">156</span>
              <span style="color: #71767b; margin-left: 2px; font-size: 14px; font-weight: 400;">æ­£åœ¨å…³æ³¨</span>
            </div>
            <div style="cursor: pointer;" onmouseover="this.querySelector('span').style.textDecoration='underline'"
              onmouseout="this.querySelector('span').style.textDecoration='none'">
              <span id="x-profile-followers-count" style="color: #fff; font-weight: 700; font-size: 14px;">89</span>
              <span style="color: #71767b; margin-left: 2px; font-size: 14px; font-weight: 400;">å…³æ³¨è€…</span>
            </div>
          </div>
        </div>

        <!-- æ ‡ç­¾æ  -->
        <div class="profile-tabs" style="display: flex; border-bottom: 1px solid #2f3336;">
          <div class="profile-tab active" onclick="switchProfileTab('posts')"
            style="flex: 1; text-align: center; padding: 14px 0; font-weight: 600; font-size: 15px; cursor: pointer; position: relative; color: #fff;">
            å¸–å­
            <div class="tab-indicator"
              style="position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: #1d9bf0; border-radius: 2px;">
            </div>
          </div>
          <div class="profile-tab" onclick="switchProfileTab('replies')"
            style="flex: 1; text-align: center; padding: 14px 0; font-weight: 500; font-size: 15px; cursor: pointer; position: relative; color: #71767b;">
            å›å¤
            <div class="tab-indicator"
              style="position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: #1d9bf0; border-radius: 2px; display: none;">
            </div>
          </div>
          <div class="profile-tab" onclick="switchProfileTab('highlights')"
            style="flex: 1; text-align: center; padding: 14px 0; font-weight: 500; font-size: 15px; cursor: pointer; position: relative; color: #71767b;">
            äº®ç‚¹
            <div class="tab-indicator"
              style="position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: #1d9bf0; border-radius: 2px; display: none;">
            </div>
          </div>
          <div class="profile-tab" onclick="switchProfileTab('articles')"
            style="flex: 1; text-align: center; padding: 14px 0; font-weight: 500; font-size: 15px; cursor: pointer; position: relative; color: #71767b;">
            æ–‡ç« 
            <div class="tab-indicator"
              style="position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: #1d9bf0; border-radius: 2px; display: none;">
            </div>
          </div>
          <div class="profile-tab" onclick="switchProfileTab('media')"
            style="flex: 1; text-align: center; padding: 14px 0; font-weight: 500; font-size: 15px; cursor: pointer; position: relative; color: #71767b;">
            åª’ä½“
            <div class="tab-indicator"
              style="position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: #1d9bf0; border-radius: 2px; display: none;">
            </div>
          </div>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="profile-content" style="flex: 1;">
          <!-- å¸–å­å†…å®¹ -->
          <div id="profile-posts-content" class="profile-tab-content" style="display: block;">
            <div id="x-profile-tweets-container" style="padding: 0;">
              <!-- ç”¨æˆ·çš„æ¨æ–‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
          </div>

          <!-- å…¶ä»–æ ‡ç­¾å†…å®¹ -->
          <div id="profile-replies-content" class="profile-tab-content" style="display: none;">
            <div style="padding: 60px 32px; text-align: center;">
              <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;">è¿˜æ²¡æœ‰å›å¤</div>
              <div style="color: #71767b; font-size: 15px;">å½“ä½ å›å¤ä¸€æ¡æ¨æ–‡æ—¶ï¼Œå®ƒä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</div>
            </div>
          </div>

          <div id="profile-highlights-content" class="profile-tab-content" style="display: none;">
            <div style="padding: 60px 32px; text-align: center;">
              <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;">è¿˜æ²¡æœ‰äº®ç‚¹</div>
              <div style="color: #71767b; font-size: 15px;">ç‚¹èµæœ€å¤šçš„æ¨æ–‡ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</div>
            </div>
          </div>

          <div id="profile-articles-content" class="profile-tab-content" style="display: none;">
            <div style="padding: 60px 32px; text-align: center;">
              <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;">è¿˜æ²¡æœ‰æ–‡ç« </div>
              <div style="color: #71767b; font-size: 15px;">å‘å¸ƒçš„æ–‡ç« ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</div>
            </div>
          </div>

          <div id="profile-media-content" class="profile-tab-content" style="display: none;">
            <div style="padding: 60px 32px; text-align: center;">
              <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;">è¿˜æ²¡æœ‰åª’ä½“</div>
              <div style="color: #71767b; font-size: 15px;">åŒ…å«ç…§ç‰‡å’Œè§†é¢‘çš„æ¨æ–‡ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç¼–è¾‘ä¸ªäººèµ„æ–™å¼¹çª— -->
    <div id="edit-profile-modal" class="profile-modal" onclick="closeEditProfileModal(event)" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(91, 112, 131, 0.4);
      z-index: 20;
      overflow-y: auto;
    ">
      <div class="modal-content" onclick="event.stopPropagation()" style="
        background-color: #000;
        margin: 40px auto;
        border-radius: 16px;
        max-width: 600px;
        width: calc(100% - 40px);
        max-height: calc(100vh - 80px);
        position: relative;
        overflow: hidden;
      ">
        <!-- å¼¹çª—é¡¶éƒ¨æ  -->
        <div class="modal-header" style="
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 16px;
          border-bottom: 1px solid #2f3336;
          position: sticky;
          top: 0;
          background-color: #000;
          z-index: 25;
        ">
          <div style="display: flex; align-items: center; gap: 24px;">
            <!-- å…³é—­æŒ‰é’® -->
            <div class="modal-close-btn" onclick="closeEditProfileModal()" style="
              cursor: pointer;
              padding: 8px;
              border-radius: 50%;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='rgba(239,243,244,0.1)'"
              onmouseout="this.style.backgroundColor='transparent'">
              <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
                <g>
                  <path
                    d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z">
                  </path>
                </g>
              </svg>
            </div>
            <!-- æ ‡é¢˜ -->
            <h2 style="
              color: #fff;
              font-size: 20px;
              font-weight: 700;
              margin: 0;
            ">ç¼–è¾‘ä¸ªäººèµ„æ–™</h2>
          </div>
          <!-- ä¿å­˜æŒ‰é’® -->
          <button id="save-profile-btn" onclick="saveProfileChanges()" style="
            background-color: #fff;
            color: #000;
            border: none;
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseover="this.style.backgroundColor='#d7dbdc'" onmouseout="this.style.backgroundColor='#fff'">
            ä¿å­˜
          </button>
        </div>

        <!-- å¼¹çª—å†…å®¹åŒºåŸŸ -->
        <div class="modal-body" style="
          padding: 0;
          overflow-y: auto;
          max-height: calc(100vh - 140px);
        ">
          <!-- å°é¢å›¾ç¼–è¾‘åŒºåŸŸ -->
          <div class="edit-cover-section" style="
            position: relative;
            height: 200px;
            background-color: #333;
            overflow: hidden;
          ">
            <img id="edit-cover-image" src="https://i.postimg.cc/qRzMB6nQ/default-cover.jpg"
              style="width: 100%; height: 100%; object-fit: cover;" alt="å°é¢å›¾">

            <!-- å°é¢å›¾ç¼–è¾‘æŒ‰é’® -->
            <div class="cover-edit-overlay" style="
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-color: rgba(0, 0, 0, 0.4);
              display: flex;
              justify-content: center;
              align-items: center;
              gap: 12px;
            ">
              <!-- ç¼–è¾‘æŒ‰é’® -->
              <div class="cover-edit-btn" onclick="editCoverImage()" style="
                background-color: rgba(0, 0, 0, 0.75);
                border-radius: 50%;
                padding: 12px;
                cursor: pointer;
                transition: background-color 0.2s;
              " onmouseover="this.style.backgroundColor='rgba(0,0,0,0.85)'"
                onmouseout="this.style.backgroundColor='rgba(0,0,0,0.75)'">
                <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: #fff;">
                  <g>
                    <path
                      d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">
                    </path>
                  </g>
                </svg>
              </div>
              <!-- åˆ é™¤æŒ‰é’® -->
              <div class="cover-remove-btn" onclick="removeCoverImage()" style="
                background-color: rgba(0, 0, 0, 0.75);
                border-radius: 50%;
                padding: 12px;
                cursor: pointer;
                transition: background-color 0.2s;
              " onmouseover="this.style.backgroundColor='rgba(0,0,0,0.85)'"
                onmouseout="this.style.backgroundColor='rgba(0,0,0,0.75)'">
                <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: #fff;">
                  <g>
                    <path
                      d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z">
                    </path>
                  </g>
                </svg>
              </div>
            </div>
          </div>

          <!-- å¤´åƒç¼–è¾‘åŒºåŸŸ -->
          <div class="edit-avatar-section" style="
            padding: 12px 16px;
            position: relative;
            margin-top: -67px;
            z-index: 3;
          ">
            <div style="position: relative; width: 134px;">
              <img id="edit-main-avatar" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg"
                style="width: 134px; height: 134px; border-radius: 50%; border: 4px solid #000;" alt="ç”¨æˆ·å¤´åƒ">

              <!-- å¤´åƒç¼–è¾‘æŒ‰é’® -->
              <div class="avatar-edit-btn" onclick="editAvatarImage()" style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: rgba(0, 0, 0, 0.75);
                border-radius: 50%;
                padding: 12px;
                cursor: pointer;
                transition: background-color 0.2s;
              " onmouseover="this.style.backgroundColor='rgba(0,0,0,0.85)'"
                onmouseout="this.style.backgroundColor='rgba(0,0,0,0.75)'">
                <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: #fff;">
                  <g>
                    <path
                      d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">
                    </path>
                  </g>
                </svg>
              </div>
            </div>
          </div>

          <!-- è¡¨å•è¾“å…¥åŒºåŸŸ -->
          <div class="edit-form-section" style="padding: 24px 16px;">
            <!-- ç”¨æˆ·åè¾“å…¥ -->
            <div class="form-group" style="margin-bottom: 20px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                font-weight: 400;
                margin-bottom: 2px;
              ">åç§°</label>
              <input type="text" id="edit-user-name" placeholder="åç§°" style="
                width: 100%;
                background-color: transparent;
                border: 1px solid #333;
                border-radius: 4px;
                color: #fff;
                padding: 12px;
                font-size: 17px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
              " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'" maxlength="50"
                oninput="updateCharacterCounts()">
              <div style="color: #8b98a5; font-size: 13px; margin-top: 4px;">0 / 50</div>
            </div>

            <!-- ç”¨æˆ·å¥æŸ„è¾“å…¥ -->
            <div class="form-group" style="margin-bottom: 20px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                font-weight: 400;
                margin-bottom: 2px;
              ">ç”¨æˆ·å</label>
              <input type="text" id="edit-user-handle" placeholder="ç”¨æˆ·å" style="
                width: 100%;
                background-color: transparent;
                border: 1px solid #333;
                border-radius: 4px;
                color: #fff;
                padding: 12px;
                font-size: 17px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
              " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'" maxlength="15"
                oninput="updateCharacterCounts()">
              <div style="color: #8b98a5; font-size: 13px; margin-top: 4px;">0 / 15</div>
            </div>

            <!-- ä¸ªäººç®€ä»‹è¾“å…¥ -->
            <div class="form-group" style="margin-bottom: 20px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                font-weight: 400;
                margin-bottom: 2px;
              ">è‡ªæˆ‘ä»‹ç»</label>
              <textarea id="edit-user-bio" placeholder="è‡ªæˆ‘ä»‹ç»" style="
                width: 100%;
                background-color: transparent;
                border: 1px solid #333;
                border-radius: 4px;
                color: #fff;
                padding: 12px;
                font-size: 17px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
                resize: vertical;
                min-height: 80px;
                max-height: 150px;
                font-family: inherit;
                line-height: 1.3;
              " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'" maxlength="160"
                oninput="updateCharacterCounts()"></textarea>
              <div style="color: #8b98a5; font-size: 13px; margin-top: 4px;">0 / 160</div>
            </div>

            <!-- è‡ªå®šä¹‰æ ‡ç­¾1 -->
            <div class="form-group" style="margin-bottom: 25px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                font-weight: 400;
                margin-bottom: 8px;
              ">è‡ªå®šä¹‰æ ‡ç­¾1</label>

              <!-- å›¾æ ‡å’Œæ–‡æœ¬è¾“å…¥è¡Œ -->
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <!-- å›¾æ ‡è¾“å…¥ -->
                <input type="text" id="edit-tag1-icon" placeholder="âœ¨" maxlength="2" style="
                  width: 50px;
                  background-color: transparent;
                  border: 1px solid #333;
                  border-radius: 4px;
                  color: #fff;
                  padding: 12px;
                  font-size: 17px;
                  outline: none;
                  transition: border-color 0.2s;
                  box-sizing: border-box;
                  text-align: center;
                " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">

                <!-- æ–‡æœ¬è¾“å…¥ -->
                <input type="text" id="edit-custom-tag1" placeholder="ä¾‹å¦‚ï¼šç§‘æŠ€çˆ±å¥½è€…" style="
                  flex: 1;
                  background-color: transparent;
                  border: 1px solid #333;
                  border-radius: 4px;
                  color: #fff;
                  padding: 12px;
                  font-size: 17px;
                  outline: none;
                  transition: border-color 0.2s;
                  box-sizing: border-box;
                " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'" maxlength="30"
                  oninput="updateCharacterCounts()">
              </div>

              <!-- é¢œè‰²é€‰æ‹©è¡Œ -->
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 4px;">
                <label style="color: #8b98a5; font-size: 12px; min-width: 40px;">é¢œè‰²:</label>
                <input type="color" id="edit-tag1-color" value="#71767b" style="
                  width: 40px;
                  height: 32px;
                  border: 1px solid #333;
                  border-radius: 4px;
                  background: transparent;
                  cursor: pointer;
                  outline: none;
                " onchange="updateTag1ColorFromPicker()">
                <input type="text" id="edit-tag1-color-text" placeholder="#71767b" maxlength="7" style="
                  flex: 1;
                  background-color: transparent;
                  border: 1px solid #333;
                  border-radius: 4px;
                  color: #fff;
                  padding: 8px 12px;
                  font-size: 14px;
                  outline: none;
                  font-family: monospace;
                  transition: border-color 0.2s;
                " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'"
                  oninput="updateTag1ColorFromText()" onchange="updateTag1ColorFromText()">
              </div>

              <div style="color: #8b98a5; font-size: 13px;">0 / 30</div>
            </div>

            <!-- è‡ªå®šä¹‰æ ‡ç­¾2 -->
            <div class="form-group" style="margin-bottom: 25px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                font-weight: 400;
                margin-bottom: 8px;
              ">è‡ªå®šä¹‰æ ‡ç­¾2</label>

              <!-- å›¾æ ‡å’Œæ–‡æœ¬è¾“å…¥è¡Œ -->
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <!-- å›¾æ ‡è¾“å…¥ -->
                <input type="text" id="edit-tag2-icon" placeholder="ğŸ“…" maxlength="2" style="
                  width: 50px;
                  background-color: transparent;
                  border: 1px solid #333;
                  border-radius: 4px;
                  color: #fff;
                  padding: 12px;
                  font-size: 17px;
                  outline: none;
                  transition: border-color 0.2s;
                  box-sizing: border-box;
                  text-align: center;
                " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">

                <!-- æ–‡æœ¬è¾“å…¥ -->
                <input type="text" id="edit-custom-tag2" placeholder="ä¾‹å¦‚ï¼š2024å¹´åŠ å…¥" style="
                  flex: 1;
                  background-color: transparent;
                  border: 1px solid #333;
                  border-radius: 4px;
                  color: #fff;
                  padding: 12px;
                  font-size: 17px;
                  outline: none;
                  transition: border-color 0.2s;
                  box-sizing: border-box;
                " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'" maxlength="30"
                  oninput="updateCharacterCounts()">
              </div>

              <!-- é¢œè‰²é€‰æ‹©è¡Œ -->
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 4px;">
                <label style="color: #8b98a5; font-size: 12px; min-width: 40px;">é¢œè‰²:</label>
                <input type="color" id="edit-tag2-color" value="#71767b" style="
                  width: 40px;
                  height: 32px;
                  border: 1px solid #333;
                  border-radius: 4px;
                  background: transparent;
                  cursor: pointer;
                  outline: none;
                " onchange="updateTag2ColorFromPicker()">
                <input type="text" id="edit-tag2-color-text" placeholder="#71767b" maxlength="7" style="
                  flex: 1;
                  background-color: transparent;
                  border: 1px solid #333;
                  border-radius: 4px;
                  color: #fff;
                  padding: 8px 12px;
                  font-size: 14px;
                  outline: none;
                  font-family: monospace;
                  transition: border-color 0.2s;
                " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'"
                  oninput="updateTag2ColorFromText()" onchange="updateTag2ColorFromText()">
              </div>

              <div style="color: #8b98a5; font-size: 13px;">0 / 30</div>
            </div>

            <!-- å…³æ³¨æ•°è¾“å…¥ -->
            <div class="form-group" style="margin-bottom: 20px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                font-weight: 400;
                margin-bottom: 2px;
              ">æ­£åœ¨å…³æ³¨æ•°é‡</label>
              <input type="text" id="edit-following-count" placeholder="156, 1.2K, 2.5Mç­‰" maxlength="20" style="
                width: 100%;
                background-color: transparent;
                border: 1px solid #333;
                border-radius: 4px;
                color: #fff;
                padding: 12px;
                font-size: 17px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
              " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">
              <div style="color: #8b98a5; font-size: 13px; margin-top: 4px;">å¯è¾“å…¥ä»»æ„æ•°å­—ã€å­—æ¯ã€ç¬¦å·ç»„åˆ</div>
            </div>

            <!-- å…³æ³¨è€…æ•°è¾“å…¥ -->
            <div class="form-group" style="margin-bottom: 20px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                font-weight: 400;
                margin-bottom: 2px;
              ">å…³æ³¨è€…æ•°é‡</label>
              <input type="text" id="edit-followers-count" placeholder="89, 1.5K, 3.2Mç­‰" maxlength="20" style="
                width: 100%;
                background-color: transparent;
                border: 1px solid #333;
                border-radius: 4px;
                color: #fff;
                padding: 12px;
                font-size: 17px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
              " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">
              <div style="color: #8b98a5; font-size: 13px; margin-top: 4px;">å¯è¾“å…¥ä»»æ„æ•°å­—ã€å­—æ¯ã€ç¬¦å·ç»„åˆ</div>
            </div>

            <!-- è®¤è¯ç±»å‹è®¾ç½® -->
            <div class="form-group" style="margin-bottom: 25px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                font-weight: 400;
                margin-bottom: 8px;
              ">è®¤è¯ç±»å‹</label>

              <div style="color: #71767b; font-size: 12px; margin-bottom: 12px; line-height: 1.4;">
                é€‰æ‹©æ‚¨çš„è®¤è¯ç±»å‹ï¼Œä¸åŒè®¤è¯ç±»å‹ä¼šæ˜¾ç¤ºä¸åŒçš„å›¾æ ‡å’Œå«ä¹‰ã€‚
              </div>

              <!-- è®¤è¯ç±»å‹é€‰æ‹© -->
              <div style="margin-bottom: 12px;">
                <select id="edit-verification-type" style="
                  width: 100%;
                  background-color: #000;
                  border: 1px solid #333;
                  border-radius: 4px;
                  color: #fff;
                  padding: 12px;
                  font-size: 17px;
                  outline: none;
                  transition: border-color 0.2s;
                  box-sizing: border-box;
                " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'"
                  onchange="updateVerificationTypeUI()">
                  <option value="none" style="background-color: #000; color: #fff;">æ— è®¤è¯</option>
                  <option value="verified" style="background-color: #000; color: #fff;">å·²è®¤è¯ - è“è‰²å‹¾æ ‡</option>
                  <option value="couple" style="background-color: #000; color: #fff;">æƒ…ä¾£è®¤è¯ - ç™½è‰²å¿ƒå½¢</option>
                  <option value="married" style="background-color: #000; color: #fff;">å·²å©šè®¤è¯ - ç™½è‰²åœ†ç¯</option>
                  <option value="vip" style="background-color: #000; color: #fff;">VIPè®¤è¯ - ç™½è‰²è±å½¢</option>
                </select>
              </div>

              <!-- æƒ…ä¾£è®¤è¯è§’è‰²ç»‘å®š -->
              <div id="couple-binding-section" style="display: none;">
                <label style="
                  display: block;
                  color: #8b98a5;
                  font-size: 13px;
                  font-weight: 400;
                  margin-bottom: 8px;
                ">æƒ…ä¾£å¯¹è±¡è§’è‰²</label>

                <div style="color: #71767b; font-size: 12px; margin-bottom: 8px; line-height: 1.4;">
                  é€‰æ‹©ä¸æ‚¨æ˜¯æƒ…ä¾£å…³ç³»çš„è§’è‰²ã€‚ç»‘å®šåï¼Œå…¶ä»–æ¨ç‰¹è§‚ä¼—éƒ½ä¼šçŸ¥é“ä½ ä»¬çš„æƒ…ä¾£å…³ç³»ã€‚
                </div>

                <select id="edit-couple-character" style="
                  width: 100%;
                  background-color: #000;
                  border: 1px solid #333;
                  border-radius: 4px;
                  color: #fff;
                  padding: 12px;
                  font-size: 17px;
                  outline: none;
                  transition: border-color 0.2s;
                  box-sizing: border-box;
                " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">
                  <option value="" style="background-color: #000; color: #fff;">æœªé€‰æ‹©è§’è‰²</option>
                  <!-- è§’è‰²é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
                </select>
              </div>
            </div>

            <!-- å…¬ä¼—èº«ä»½è®¾ç½® -->
            <div class="form-group" style="margin-bottom: 25px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                font-weight: 400;
                margin-bottom: 8px;
              ">å…¬ä¼—èº«ä»½</label>
              <div style="color: #71767b; font-size: 12px; margin-bottom: 8px; line-height: 1.4;">
                æè¿°æ‚¨åœ¨Xå¹³å°çš„å…¬ä¼—èº«ä»½ï¼ˆå¦‚æ˜æ˜Ÿã€ç½‘çº¢ã€åšä¸»ç­‰ï¼‰ã€‚è¿™å°†å½±å“å…¶ä»–ç”¨æˆ·å¯¹æ‚¨çš„è®¨è®ºå‡ ç‡ï¼Œèº«ä»½è¶ŠçŸ¥åå¯èƒ½å¼•èµ·æ›´å¤šå…³æ³¨å’Œè®¨è®ºã€‚æ­¤ä¿¡æ¯å®Œå…¨å…¬å¼€ã€‚
              </div>

              <!-- é‡è¦æé†’ -->
              <div
                style="background-color: rgba(29, 155, 240, 0.1); border: 1px solid #1d9bf0; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
                <div style="color: #1d9bf0; font-size: 12px; line-height: 1.4;">
                  <strong>ğŸ“Œ é‡è¦æé†’ï¼š</strong>æ‚¨å°†ä»¥å®Œæ•´èº«ä»½è¿›è¡Œäº’åŠ¨ï¼Œä½†<strong
                    style="color: #1d9bf0;">Xå¹³å°å…¶ä»–ç”¨æˆ·æ— æ³•è¯»å–æ‚¨çš„ä¸ªäººè®¾å®š</strong>ï¼Œä»…èƒ½çœ‹åˆ°æ­¤å…¬ä¼—èº«ä»½ä¿¡æ¯ã€‚å¦‚éœ€è®©å…¶ä»–ç”¨æˆ·äº†è§£çš„ä¸ªäººç‰¹ç‚¹ã€èƒŒæ™¯ç»å†ç­‰å†…å®¹ï¼Œè¯·å…¨éƒ¨è¯¦ç»†å¡«å†™è‡³å…¬ä¼—èº«ä»½ä¸­ã€‚
                </div>
              </div>

              <textarea id="edit-public-identity" placeholder="ä¾‹å¦‚ï¼šçŸ¥åç§‘æŠ€åšä¸»ã€æ¼”å‘˜ã€æ­Œæ‰‹ã€ç½‘ç»œçº¢äººç­‰... å¯è¯¦ç»†æè¿°æ‚¨çš„å…¬å¼€èƒŒæ™¯ã€æˆå°±ã€ç‰¹ç‚¹ç­‰ï¼Œæ— å­—æ•°é™åˆ¶" style="
                width: 100%;
                background-color: transparent;
                border: 1px solid #333;
                border-radius: 4px;
                color: #fff;
                padding: 12px;
                font-size: 17px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
                resize: vertical;
                min-height: 120px;
                max-height: 200px;
                font-family: inherit;
                line-height: 1.3;
              " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'"></textarea>
              <div style="color: #8b98a5; font-size: 12px; margin-top: 4px;">ğŸ’¡ æ— å­—æ•°é™åˆ¶ï¼Œå¯è¯¦ç»†æè¿°æ‚¨çš„å…¬å¼€ä¿¡æ¯</div>
            </div>

            <!-- çœŸåå…¬å¼€è®¾ç½® -->
            <div class="form-group" style="margin-bottom: 25px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                font-weight: 400;
                margin-bottom: 8px;
              ">çœŸåè®¾ç½®</label>
              <div style="color: #71767b; font-size: 12px; margin-bottom: 12px; line-height: 1.4;">
                é€‰æ‹©æ˜¯å¦å…¬å¼€æ‚¨çš„çœŸå®å§“åã€‚å…¬å¼€åï¼Œå…¶ä»–ç”¨æˆ·å’Œè§’è‰²éƒ½èƒ½çœ‹åˆ°æ‚¨çš„çœŸåï¼Œæƒ…ä¾£è®¤è¯æ—¶ä¹Ÿä¼šæ˜¾ç¤ºåŒæ–¹çœŸåã€‚
              </div>

              <!-- æ˜¯å¦å…¬å¼€çœŸåå¤é€‰æ¡† -->
              <div style="margin-bottom: 12px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="edit-show-real-name" style="
                    width: 16px;
                    height: 16px;
                    accent-color: #1d9bf0;
                  " onchange="toggleRealNameInput()">
                  <span style="color: #fff; font-size: 15px;">å…¬å¼€çœŸå®å§“å</span>
                </label>
              </div>

              <!-- çœŸåè¾“å…¥æ¡† -->
              <div id="real-name-input-container" style="display: none;">
                <input type="text" id="edit-real-name" placeholder="è¯·è¾“å…¥æ‚¨çš„çœŸå®å§“å" style="
                  width: 100%;
                  background-color: transparent;
                  border: 1px solid #333;
                  border-radius: 4px;
                  color: #fff;
                  padding: 12px;
                  font-size: 17px;
                  outline: none;
                  transition: border-color 0.2s;
                  box-sizing: border-box;
                " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'" maxlength="50"
                  oninput="updateCharacterCounts()">
                <div style="color: #8b98a5; font-size: 13px; margin-top: 4px;">0 / 50</div>
              </div>
            </div>

            <!-- è§’è‰²èº«ä»½è¯†åˆ«è®¾ç½® -->
            <div class="form-group" style="margin-bottom: 20px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                font-weight: 400;
                margin-bottom: 8px;
              ">è§’è‰²èº«ä»½è¯†åˆ«</label>
              <div style="color: #71767b; font-size: 12px; margin-bottom: 12px; line-height: 1.4;">
                é€‰æ‹©å“ªäº›è§’è‰²çŸ¥é“æ‚¨çš„çœŸå®èº«ä»½ã€‚è¢«é€‰ä¸­çš„è§’è‰²ä¼šè®¤è¯†æ‚¨ï¼Œåœ¨äº’åŠ¨æ—¶ä¼šè¡¨ç°å¾—åƒæœ‹å‹ä¸€æ ·ã€‚
                <br><br>
                <strong style="color: #1d9bf0;">åŠŸèƒ½è¯´æ˜ï¼š</strong><br>
                â€¢ çŸ¥é“æ‚¨èº«ä»½çš„è§’è‰²ä¼šåœ¨è¯„è®ºåŒºä¸æ‚¨è‡ªç„¶äº’åŠ¨<br>
                â€¢ æ‚¨å‘å¸–æ—¶ï¼Œè¿™äº›è§’è‰²å¯èƒ½ä¼šæ¥ç•™è¨€<br>
                â€¢ åªæœ‰å·²ç»‘å®šXèµ„æ–™çš„è§’è‰²æ‰èƒ½è¢«é€‰æ‹©<br>
                â€¢ <strong style="color: #1d9bf0;">ç‚¹å‡»å³ä¾§æŒ‰é’®</strong>å¯è®¾ç½®ä¸“å±çš„ç”¨æˆ·äººè®¾<br>
                â€¢ ğŸ”µ è“è‰²<strong>+</strong>æŒ‰é’®ï¼šæœªè®¾ç½® | ğŸŸ¢ ç»¿è‰²<strong>âœï¸</strong>æŒ‰é’®ï¼šå·²è®¾ç½®
              </div>

              <!-- è§’è‰²é€‰æ‹©åˆ—è¡¨ -->
              <div id="identity-characters-list" style="
                background-color: #1a1a1a;
                border: 1px solid #333;
                border-radius: 8px;
                padding: 12px;
                max-height: 200px;
                overflow-y: auto;
              ">
                <!-- è§’è‰²åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- å‘å¸–å¼¹çª— -->
    <div id="compose-tweet-modal" class="compose-modal" onclick="closeComposeTweetModal(event)" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(91, 112, 131, 0.4);
      z-index: 20;
      overflow-y: auto;
    ">
      <div class="compose-modal-content" onclick="event.stopPropagation()" style="
        background-color: #000;
        margin: 40px auto;
        border-radius: 16px;
        max-width: 600px;
        width: calc(100% - 40px);
        max-height: calc(100vh - 80px);
        position: relative;
        overflow: hidden;
      ">
        <!-- å‘å¸–å¼¹çª—é¡¶éƒ¨æ  -->
        <div class="compose-header" style="
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 16px;
          border-bottom: 1px solid #2f3336;
          position: sticky;
          top: 0;
          background-color: #000;
          z-index: 25;
        ">
          <div style="display: flex; align-items: center; gap: 24px;">
            <!-- å…³é—­æŒ‰é’® -->
            <div class="compose-close-btn" onclick="closeComposeTweetModal()" style="
              cursor: pointer;
              padding: 8px;
              border-radius: 50%;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='rgba(239,243,244,0.1)'"
              onmouseout="this.style.backgroundColor='transparent'">
              <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
                <g>
                  <path
                    d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z">
                  </path>
                </g>
              </svg>
            </div>
          </div>
          <!-- å‘å¸–æŒ‰é’® -->
          <button id="compose-tweet-btn" onclick="publishTweet()" disabled style="
            background-color: #1d9bf0;
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.2s;
          ">
            å‘å¸–
          </button>
        </div>

        <!-- å‘å¸–å¼¹çª—å†…å®¹åŒºåŸŸ -->
        <div class="compose-body" style="
          padding: 16px;
          overflow-y: auto;
          max-height: calc(100vh - 200px);
        ">
          <!-- ç”¨æˆ·ä¿¡æ¯å’Œè¾“å…¥åŒºåŸŸ -->
          <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <!-- ç”¨æˆ·å¤´åƒ -->
            <img id="compose-user-avatar" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="ç”¨æˆ·å¤´åƒ"
              style="width: 48px; height: 48px; border-radius: 50%; flex-shrink: 0;">

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div style="flex: 1; min-width: 0;">
              <!-- ä¸»è¦æ–‡æœ¬è¾“å…¥ -->
              <textarea id="compose-text-input" placeholder="æœ‰ä»€ä¹ˆæ–°é²œäº‹ï¼Ÿ" style="
                width: 100%;
                min-height: 120px;
                max-height: 300px;
                background: transparent;
                border: none;
                color: #fff;
                font-size: 20px;
                resize: none;
                outline: none;
                font-family: inherit;
                line-height: 1.3;
                box-sizing: border-box;
              " oninput="handleComposeInput()" onkeyup="processHashtagsAndMentions()"></textarea>

              <!-- å¼•ç”¨å†…å®¹æ˜¾ç¤ºåŒºåŸŸ -->
              <div id="quote-content-preview"
                style="display: none; margin-top: 16px; border: 1px solid #2f3336; border-radius: 16px; padding: 12px; background-color: rgba(0,0,0,0.3);">
                <div
                  style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #71767b;">
                      <g>
                        <path
                          d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z">
                        </path>
                      </g>
                    </svg>
                    <span id="quote-type-text" style="color: #71767b; font-size: 13px;">å¼•ç”¨æ¨æ–‡</span>
                  </div>
                  <div onclick="removeQuoteContent()"
                    style="cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s;"
                    onmouseover="this.style.backgroundColor='rgba(239,243,244,0.1)'"
                    onmouseout="this.style.backgroundColor='transparent'">
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #71767b;">
                      <g>
                        <path
                          d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z">
                        </path>
                      </g>
                    </svg>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <img id="quote-user-avatar" style="width: 20px; height: 20px; border-radius: 50%;" alt="ç”¨æˆ·å¤´åƒ">
                  <span id="quote-user-name" style="font-weight: 600; color: #fff; font-size: 13px;"></span>
                  <svg id="quote-user-verified" viewBox="0 0 24 24"
                    style="width: 14px; height: 14px; fill: #1d9bf0; display: none;">
                    <g>
                      <path
                        d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z">
                      </path>
                    </g>
                  </svg>
                  <span id="quote-user-handle" style="color: #71767b; font-size: 13px;"></span>
                  <span id="quote-user-time" style="color: #71767b; font-size: 13px;"></span>
                </div>
                <div id="quote-content-text"
                  style="color: #fff; font-size: 14px; line-height: 1.3; word-wrap: break-word;"></div>
                <!-- å¼•ç”¨å›¾ç‰‡å®¹å™¨ -->
                <div id="quote-image-container" style="display: none;"></div>
              </div>

              <!-- å­—ç¬¦è®¡æ•° -->
              <div style="display: flex; justify-content: flex-end; margin-top: 8px;">
                <div id="compose-char-count" style="
                  color: #71767b;
                  font-size: 13px;
                ">0 / 280</div>
              </div>

              <!-- åŠŸèƒ½åŒºåŸŸ -->
              <div style="margin-top: 16px;">

                <!-- å›¾ç‰‡åŒºåŸŸ -->
                <div id="compose-image-section" style="display: none; margin-bottom: 16px;">
                  <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px;">
                    <div style="color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 12px;">æ·»åŠ å›¾ç‰‡</div>

                    <!-- å›¾ç‰‡é€‰æ‹©æ–¹å¼ -->
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                      <button onclick="selectImageMethod('description')" id="img-desc-btn" style="
                        flex: 1;
                        background-color: #333;
                        color: #fff;
                        border: 1px solid #536471;
                        border-radius: 8px;
                        padding: 8px 12px;
                        font-size: 13px;
                        cursor: pointer;
                        transition: all 0.2s;
                      ">æ–‡å­—æè¿°</button>
                      <button onclick="selectImageMethod('upload')" id="img-upload-btn" style="
                        flex: 1;
                        background-color: #333;
                        color: #fff;
                        border: 1px solid #536471;
                        border-radius: 8px;
                        padding: 8px 12px;
                        font-size: 13px;
                        cursor: pointer;
                        transition: all 0.2s;
                      ">æœ¬åœ°ä¸Šä¼ </button>
                    </div>

                    <!-- æ–‡å­—æè¿°è¾“å…¥ -->
                    <div id="image-description-input" style="display: none;">
                      <textarea placeholder="æè¿°å›¾ç‰‡å†…å®¹..." style="
                        width: 100%;
                        min-height: 80px;
                        background-color: #000;
                        border: 1px solid #333;
                        border-radius: 8px;
                        color: #fff;
                        padding: 12px;
                        font-size: 15px;
                        resize: vertical;
                        outline: none;
                        font-family: inherit;
                        box-sizing: border-box;
                      " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'"></textarea>
                    </div>

                    <!-- æœ¬åœ°ä¸Šä¼ åŒºåŸŸ -->
                    <div id="image-upload-area" style="display: none;">
                      <div style="
                        border: 2px dashed #333;
                        border-radius: 8px;
                        padding: 20px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.2s;
                      " onclick="triggerImageUpload()" onmouseover="this.style.borderColor='#1d9bf0'"
                        onmouseout="this.style.borderColor='#333'">
                        <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #71767b; margin-bottom: 8px;">
                          <g>
                            <path
                              d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">
                            </path>
                          </g>
                        </svg>
                        <div style="color: #71767b; font-size: 15px;">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</div>
                        <div style="color: #71767b; font-size: 13px; margin-top: 4px;">æ”¯æŒ JPGã€PNGã€GIFï¼Œæœ€å¤§ 5MB</div>
                      </div>
                      <input type="file" id="image-file-input" accept="image/*" style="display: none;"
                        onchange="handleImageUpload(event)">
                      <div id="uploaded-image-preview" style="display: none; margin-top: 12px;">
                        <img id="preview-image"
                          style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px;" alt="é¢„è§ˆå›¾ç‰‡">
                      </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                      <button onclick="saveImageData()" style="
                        flex: 1;
                        background-color: #1d9bf0;
                        color: #fff;
                        border: none;
                        border-radius: 8px;
                        padding: 8px;
                        font-size: 13px;
                        cursor: pointer;
                        transition: all 0.2s;
                      " onmouseover="this.style.backgroundColor='#1a8cd8'"
                        onmouseout="this.style.backgroundColor='#1d9bf0'">
                        ä¿å­˜å›¾ç‰‡
                      </button>
                      <button onclick="removeImage()" style="
                        flex: 1;
                        background-color: transparent;
                        color: #f4212e;
                        border: 1px solid #f4212e;
                        border-radius: 8px;
                        padding: 8px;
                        font-size: 13px;
                        cursor: pointer;
                        transition: all 0.2s;
                      " onmouseover="this.style.backgroundColor='rgba(244,33,46,0.1)'"
                        onmouseout="this.style.backgroundColor='transparent'">
                        ç§»é™¤å›¾ç‰‡
                      </button>
                    </div>
                  </div>
                </div>

                <!-- å®šä½åŒºåŸŸ -->
                <div id="compose-location-section" style="display: none; margin-bottom: 16px;">
                  <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px;">
                    <div style="color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 12px;">æ·»åŠ ä½ç½®</div>
                    <input type="text" id="location-input" placeholder="è¾“å…¥ä½ç½®ä¿¡æ¯..." style="
                      width: 100%;
                      background-color: #000;
                      border: 1px solid #333;
                      border-radius: 8px;
                      color: #fff;
                      padding: 12px;
                      font-size: 15px;
                      outline: none;
                      box-sizing: border-box;
                    " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                      <button onclick="saveLocationData()" style="
                        flex: 1;
                        background-color: #1d9bf0;
                        color: #fff;
                        border: none;
                        border-radius: 8px;
                        padding: 8px;
                        font-size: 13px;
                        cursor: pointer;
                        transition: all 0.2s;
                      " onmouseover="this.style.backgroundColor='#1a8cd8'"
                        onmouseout="this.style.backgroundColor='#1d9bf0'">
                        ä¿å­˜ä½ç½®
                      </button>
                      <button onclick="removeLocation()" style="
                        flex: 1;
                        background-color: transparent;
                        color: #f4212e;
                        border: 1px solid #f4212e;
                        border-radius: 8px;
                        padding: 8px;
                        font-size: 13px;
                        cursor: pointer;
                        transition: all 0.2s;
                      " onmouseover="this.style.backgroundColor='rgba(244,33,46,0.1)'"
                        onmouseout="this.style.backgroundColor='transparent'">
                        ç§»é™¤ä½ç½®
                      </button>
                    </div>
                  </div>
                </div>

                <!-- é™„å¸¦é“¾æ¥åŒºåŸŸ -->
                <div id="compose-link-section" style="display: none; margin-bottom: 16px;">
                  <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px;">
                    <div style="color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 12px;">é™„å¸¦é“¾æ¥</div>

                    <!-- é“¾æ¥æ ‡é¢˜ -->
                    <input type="text" id="link-title-input" placeholder="é“¾æ¥æ ‡é¢˜..." style="
                      width: 100%;
                      background-color: #000;
                      border: 1px solid #333;
                      border-radius: 8px;
                      color: #fff;
                      padding: 12px;
                      font-size: 15px;
                      outline: none;
                      box-sizing: border-box;
                      margin-bottom: 12px;
                    " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">

                    <!-- é“¾æ¥åœ°å€ -->
                    <input type="text" id="link-url-input" placeholder="example.com" style="
                      width: 100%;
                      background-color: #000;
                      border: 1px solid #333;
                      border-radius: 8px;
                      color: #fff;
                      padding: 12px;
                      font-size: 15px;
                      outline: none;
                      box-sizing: border-box;
                      margin-bottom: 12px;
                    " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">

                    <!-- é“¾æ¥æè¿° -->
                    <textarea id="link-description-input" placeholder="ç®€è¿°é“¾æ¥å†…å®¹..." style="
                      width: 100%;
                      min-height: 60px;
                      background-color: #000;
                      border: 1px solid #333;
                      border-radius: 8px;
                      color: #fff;
                      padding: 12px;
                      font-size: 15px;
                      resize: vertical;
                      outline: none;
                      font-family: inherit;
                      box-sizing: border-box;
                      margin-bottom: 12px;
                    " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'"></textarea>

                    <!-- é“¾æ¥é¦–å›¾ä¸Šä¼  -->
                    <div style="margin-bottom: 12px;">
                      <label
                        style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">é“¾æ¥é¦–å›¾ï¼ˆå¯é€‰ï¼‰</label>
                      <div style="
                        border: 2px dashed #333;
                        border-radius: 8px;
                        padding: 16px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.2s;
                      " onclick="triggerLinkImageUpload()" onmouseover="this.style.borderColor='#1d9bf0'"
                        onmouseout="this.style.borderColor='#333'">
                        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #71767b; margin-bottom: 4px;">
                          <g>
                            <path
                              d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">
                            </path>
                          </g>
                        </svg>
                        <div style="color: #71767b; font-size: 13px;">ç‚¹å‡»ä¸Šä¼ é“¾æ¥é¦–å›¾</div>
                      </div>
                      <input type="file" id="link-image-input" accept="image/*" style="display: none;"
                        onchange="handleLinkImageUpload(event)">
                      <div id="link-image-preview" style="display: none; margin-top: 8px;">
                        <img id="link-preview-image"
                          style="width: 100%; max-height: 120px; object-fit: cover; border-radius: 8px;" alt="é“¾æ¥é¦–å›¾é¢„è§ˆ">
                      </div>
                    </div>

                    <div style="display: flex; gap: 8px;">
                      <button onclick="saveLinkData()" style="
                        flex: 1;
                        background-color: #1d9bf0;
                        color: #fff;
                        border: none;
                        border-radius: 8px;
                        padding: 8px;
                        font-size: 13px;
                        cursor: pointer;
                        transition: all 0.2s;
                      " onmouseover="this.style.backgroundColor='#1a8cd8'"
                        onmouseout="this.style.backgroundColor='#1d9bf0'">
                        ä¿å­˜é“¾æ¥
                      </button>
                      <button onclick="removeLink()" style="
                        flex: 1;
                        background-color: transparent;
                        color: #f4212e;
                        border: 1px solid #f4212e;
                        border-radius: 8px;
                        padding: 8px;
                        font-size: 13px;
                        cursor: pointer;
                        transition: all 0.2s;
                      " onmouseover="this.style.backgroundColor='rgba(244,33,46,0.1)'"
                        onmouseout="this.style.backgroundColor='transparent'">
                        ç§»é™¤é“¾æ¥
                      </button>
                    </div>
                  </div>
                </div>

                <!-- åŠŸèƒ½æŒ‰é’®æ  -->
                <div
                  style="display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #2f3336; padding-top: 16px;">
                  <!-- å·¦ä¾§åŠŸèƒ½æŒ‰é’® -->
                  <div style="display: flex; gap: 16px;">
                    <!-- å›¾ç‰‡æŒ‰é’® -->
                    <div id="image-btn" onclick="toggleImageSection()" style="
                      padding: 8px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: background-color 0.2s;
                    " onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'"
                      onmouseout="this.style.backgroundColor='transparent'">
                      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #1d9bf0;">
                        <g>
                          <path
                            d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">
                          </path>
                        </g>
                      </svg>
                    </div>

                    <!-- å®šä½æŒ‰é’® -->
                    <div id="location-btn" onclick="toggleLocationSection()" style="
                      padding: 8px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: background-color 0.2s;
                    " onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'"
                      onmouseout="this.style.backgroundColor='transparent'">
                      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #1d9bf0;">
                        <g>
                          <path
                            d="M12 7c-1.93 0-3.5 1.57-3.5 3.5S10.07 14 12 14s3.5-1.57 3.5-3.5S13.93 7 12 7zm0 5c-.827 0-1.5-.673-1.5-1.5S11.173 9 12 9s1.5.673 1.5 1.5S12.827 12 12 12zm0-10c-4.687 0-8.5 3.813-8.5 8.5 0 5.967 7.621 11.116 7.945 11.332l.555.37.555-.37C12.879 21.616 20.5 16.467 20.5 10.5 20.5 5.813 16.687 2 12 2zm0 17.77c-1.665-1.241-6.5-5.196-6.5-9.27C5.5 6.916 8.416 4 12 4s6.5 2.916 6.5 6.5c0 4.073-4.835 8.028-6.5 9.27z">
                          </path>
                        </g>
                      </svg>
                    </div>

                    <!-- é™„å¸¦æŒ‰é’® -->
                    <div id="attach-btn" onclick="toggleLinkSection()" style="
                      padding: 8px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: background-color 0.2s;
                    " onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'"
                      onmouseout="this.style.backgroundColor='transparent'">
                      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #1d9bf0;">
                        <g>
                          <path
                            d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z">
                          </path>
                        </g>
                      </svg>
                    </div>
                  </div>

                  <!-- å³ä¾§éšç§è®¾ç½® -->
                  <div id="privacy-setting-btn" onclick="togglePrivacySettings()" style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px 12px;
                    border-radius: 20px;
                    cursor: pointer;
                    border: 1px solid #536471;
                    transition: background-color 0.2s;
                  " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.03)'"
                    onmouseout="this.style.backgroundColor='transparent'">
                    <svg id="privacy-icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #1d9bf0;">
                      <g>
                        <path id="privacy-icon-path"
                          d="M12 1.75C6.34 1.75 1.75 6.34 1.75 12S6.34 22.25 12 22.25 22.25 17.66 22.25 12 17.66 1.75 12 1.75zm-.81 14.68l-4.1-3.27 1.25-1.57 2.47 1.98 3.97-5.47 1.62 1.18-5.21 7.15z">
                        </path>
                      </g>
                    </svg>
                    <span id="privacy-text" style="color: #1d9bf0; font-size: 13px; font-weight: 600;">æ‰€æœ‰äººå¯ä»¥å›å¤</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- NPCç¼–è¾‘å¼¹çª— -->
    <div id="npc-edit-modal" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(91, 112, 131, 0.4);
      z-index: 20;
      overflow-y: auto;
    " onclick="closeNPCEditModal(event)">
      <div style="
        background-color: #000;
        margin: 40px auto;
        border-radius: 16px;
        max-width: 600px;
        width: calc(100% - 40px);
        max-height: calc(100vh - 80px);
        position: relative;
        overflow: hidden;
      " onclick="event.stopPropagation()">
        <!-- å¼¹çª—å¤´éƒ¨ -->
        <div style="
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 16px;
          border-bottom: 1px solid #2f3336;
        ">
          <div style="display: flex; align-items: center; gap: 24px;">
            <div onclick="closeNPCEditModal()" style="
              cursor: pointer;
              padding: 8px;
              border-radius: 50%;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='rgba(239,243,244,0.1)'"
              onmouseout="this.style.backgroundColor='transparent'">
              <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
                <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>
              </svg>
            </div>
            <h2 style="color: #fff; font-size: 20px; font-weight: 700; margin: 0;" id="npc-modal-title">ç¼–è¾‘NPC</h2>
          </div>
        </div>

        <!-- å¼¹çª—å†…å®¹ -->
        <div style="padding: 20px; overflow-y: auto; max-height: calc(100vh - 200px);">
          <!-- NPCå§“å -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">NPCå§“å</label>
            <input type="text" id="npc-name" placeholder="è¾“å…¥NPCå§“å" style="
              width: 100%;
              background-color: #1a1a1a;
              border: 1px solid #333;
              border-radius: 8px;
              color: #fff;
              padding: 12px;
              font-size: 15px;
              outline: none;
              box-sizing: border-box;
            " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'" maxlength="50">
          </div>

          <!-- NPCå¥æŸ„ -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">NPCå¥æŸ„</label>
            <input type="text" id="npc-handle" placeholder="@å¥æŸ„" style="
              width: 100%;
              background-color: #1a1a1a;
              border: 1px solid #333;
              border-radius: 8px;
              color: #fff;
              padding: 12px;
              font-size: 15px;
              outline: none;
              box-sizing: border-box;
            " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'" maxlength="30">
          </div>

          <!-- NPCå¤´åƒ -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">NPCå¤´åƒURL</label>
            <input type="text" id="npc-avatar" placeholder="è¾“å…¥å¤´åƒURL" style="
              width: 100%;
              background-color: #1a1a1a;
              border: 1px solid #333;
              border-radius: 8px;
              color: #fff;
              padding: 12px;
              font-size: 15px;
              outline: none;
              box-sizing: border-box;
            " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'">
          </div>

          <!-- NPCäººè®¾ -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">NPCäººè®¾</label>
            <textarea id="npc-personality" placeholder="æè¿°NPCçš„æ€§æ ¼ã€èƒŒæ™¯ã€è¡Œä¸ºç‰¹å¾..." style="
              width: 100%;
              min-height: 120px;
              background-color: #1a1a1a;
              border: 1px solid #333;
              border-radius: 8px;
              color: #fff;
              padding: 12px;
              font-size: 15px;
              resize: vertical;
              outline: none;
              box-sizing: border-box;
            " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'"></textarea>
          </div>

          <!-- å‘å¸–ä¹ æƒ¯ -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">å‘å¸–ä¹ æƒ¯</label>
            <textarea id="npc-posting-habits" placeholder="æè¿°NPCçš„å‘å¸–é£æ ¼ã€é¢‘ç‡ã€å†…å®¹åå¥½..." style="
              width: 100%;
              min-height: 100px;
              background-color: #1a1a1a;
              border: 1px solid #333;
              border-radius: 8px;
              color: #fff;
              padding: 12px;
              font-size: 15px;
              resize: vertical;
              outline: none;
              box-sizing: border-box;
            " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'"></textarea>
          </div>

          <!-- ä¸»é¡µå†…å®¹ -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">ä¸»é¡µå†…å®¹è®¾ç½®</label>
            <textarea id="npc-homepage" placeholder="æè¿°NPCä¸»é¡µçš„å±•ç¤ºå†…å®¹ã€ç®€ä»‹ç­‰..." style="
              width: 100%;
              min-height: 80px;
              background-color: #1a1a1a;
              border: 1px solid #333;
              border-radius: 8px;
              color: #fff;
              padding: 12px;
              font-size: 15px;
              resize: vertical;
              outline: none;
              box-sizing: border-box;
            " onfocus="this.style.borderColor='#1d9bf0'" onblur="this.style.borderColor='#333'"></textarea>
          </div>

          <!-- ç»‘å®šç”¨æˆ· -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">ç»‘å®šç”¨æˆ·ï¼ˆå¯å¤šé€‰ï¼‰</label>
            <div id="npc-bind-users" style="
              background-color: #1a1a1a;
              border: 1px solid #333;
              border-radius: 8px;
              padding: 12px;
              max-height: 200px;
              overflow-y: auto;
            ">
              <!-- ç”¨æˆ·åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>

          <!-- ä¿å­˜æŒ‰é’® -->
          <button onclick="saveNPC()" style="
            width: 100%;
            background-color: #1d9bf0;
            color: #fff;
            border: none;
            border-radius: 25px;
            padding: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseover="this.style.backgroundColor='#1a8cd8'" onmouseout="this.style.backgroundColor='#1d9bf0'">
            ä¿å­˜NPC
          </button>
        </div>
      </div>
    </div>

    <!-- æé—®ç®±é¡µé¢ -->
    <div id="x-askbox-page" class="x-page" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; flex-direction: column; overflow: hidden; z-index: 15;">
      <!-- èƒŒæ™¯å›¾ -->
      <div id="askbox-background" style="
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('https://i.postimg.cc/7LqVqxt4/mmexport1759588659314.jpg');
        background-size: cover;
        background-position: center;
        z-index: 0;
      "></div>

      <!-- ä¸»å†…å®¹åŒºåŸŸ -->
      <div style="position: relative; z-index: 1; width: 100%; height: 100%; display: flex; flex-direction: column; overflow-y: auto; padding-top: 20px;">
        <!-- é¡¶éƒ¨æŒ‰é’®æ  -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 16px 12px 16px;">
          <!-- è¿”å›æŒ‰é’® -->
          <div onclick="switchXPage('profile')" style="cursor: pointer; padding: 8px; border-radius: 50%; background-color: rgba(255,255,255,0.2); backdrop-filter: blur(10px); transition: all 0.2s;"
            onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'"
            onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
              <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"/>
            </svg>
          </div>

          <!-- è®¾ç½®æŒ‰é’® -->
          <div onclick="openAskboxSettings()" style="cursor: pointer; padding: 8px; border-radius: 50%; background-color: rgba(255,255,255,0.2); backdrop-filter: blur(10px); transition: all 0.2s;"
            onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'"
            onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
              <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
          </div>
        </div>

        <!-- å¤´åƒå’Œæ˜µç§°åŒºåŸŸ -->
        <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 16px;">
          <!-- å¤´åƒ -->
          <div onclick="changeAskboxAvatar()" style="cursor: pointer; margin-bottom: 12px; position: relative; transition: transform 0.2s;"
            onmouseover="this.style.transform='scale(1.05)'"
            onmouseout="this.style.transform='scale(1)'">
            <img id="askbox-avatar" src="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg" 
              style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
          </div>

          <!-- æ˜µç§°/IDåŒºåŸŸ -->
          <div style="display: flex; align-items: center; gap: 8px; background-color: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 6px 12px; border-radius: 20px;">
            <span id="askbox-nickname" 
              contenteditable="true"
              style="color: #fff; font-size: 14px; font-weight: 500; outline: none; cursor: text; min-width: 20px;"
              onblur="saveAskboxNickname()"
              onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">= =</span>
          </div>
        </div>

        <!-- æé—®å¡ç‰‡ -->
        <div style="
          margin: 0 20px 24px 20px;
          background-color: rgba(255,255,255,0.9);
          backdrop-filter: blur(10px);
          border-radius: 16px;
          padding: 32px 24px;
          box-shadow: 0 4px 16px rgba(0,0,0,0.1);
          transition: all 0.2s;
          min-height: 120px;
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <div id="askbox-prompt" 
            contenteditable="true"
            style="
            color: #333;
            font-size: 16px;
            line-height: 1.6;
            text-align: center;
            word-break: break-word;
            outline: none;
            cursor: text;
            width: 100%;
          "
          onblur="saveAskboxPrompt()"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();this.blur();}">è¯·å‘æˆ‘åŒ¿åæé—®!waiting...</div>
        </div>

        <!-- è·å–æ–°æé—®æŒ‰é’® -->
        <div onclick="getNewQuestion()" style="
          margin: 0 20px 32px 20px;
          background-color: rgba(255,255,255,0.85);
          backdrop-filter: blur(10px);
          border-radius: 24px;
          padding: 14px 24px;
          text-align: center;
          cursor: pointer;
          transition: all 0.2s;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.95)'; this.style.transform='translateY(-1px)'"
          onmouseout="this.style.backgroundColor='rgba(255,255,255,0.85)'; this.style.transform='translateY(0)'">
          <span style="color: #333; font-size: 15px; font-weight: 600;">è·å–æ–°çš„æé—®</span>
        </div>

        <!-- å·²å›ç­”çš„æé—®åˆ—è¡¨ -->
        <div style="padding: 0 20px 20px 20px;">
          <div id="answered-questions-title" style="
            color: rgba(255,255,255,0.8);
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 16px;
            text-align: center;
            display: none;
          ">æœ€æ–°æé—®å¦‚ä¸‹</div>
          <div id="answered-questions-list">
            <!-- å·²å›ç­”çš„æé—®å°†åŠ¨æ€åŠ è½½åœ¨è¿™é‡Œ -->
          </div>
        </div>
      </div>
    </div>

    <!-- è´¦æˆ·ä¸»é¡µ -->
    <div id="account-profile-page" class="x-page" style="display: none; flex-direction: column; height: 100%; overflow: hidden;">
      <!-- é¡¶éƒ¨å¯¼èˆªæ ï¼ˆç®€åŒ–ç‰ˆï¼Œåªæ˜¾ç¤ºè´¦æˆ·åå’Œæ¨æ–‡æ•°ï¼‰ -->
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #2f3336; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 10;">
        <div style="display: flex; align-items: center;">
          <div onclick="closeAccountProfile()" style="cursor: pointer; padding: 8px; margin-right: 30px; border-radius: 50%; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(239,243,244,0.1)'" onmouseout="this.style.backgroundColor='transparent'">
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
              <g><path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path></g>
            </svg>
          </div>
          <div>
            <div id="account-profile-nav-name" style="color: #fff; font-size: 20px; font-weight: 700; line-height: 1.2;"></div>
            <div id="account-profile-nav-count" style="color: #71767b; font-size: 13px; margin-top: 2px;">0 ä¸ªå¸–å­</div>
          </div>
        </div>
        
        <!-- å³ä¾§æŒ‰é’®ç»„ -->
        <div style="display: flex; align-items: center; gap: 8px;">
          <!-- æé—®ç®±æŒ‰é’® -->
          <div onclick="openAccountAskbox()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(239,243,244,0.1)'" onmouseout="this.style.backgroundColor='transparent'" title="æé—®ç®±">
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
              <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
            </svg>
          </div>
          
          <!-- åˆ·æ–°æŒ‰é’® -->
          <div onclick="refreshAccountProfile()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(239,243,244,0.1)'" onmouseout="this.style.backgroundColor='transparent'" title="åˆ·æ–°è´¦æˆ·ä¸»é¡µ">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 4.55a8 8 0 0 1 6 14.9m0 -4.45v5h5" />
              <path d="M5.63 7.16l0 .01" />
              <path d="M4.06 11l0 .01" />
              <path d="M4.63 15.1l0 .01" />
              <path d="M7.16 18.37l0 .01" />
              <path d="M11 19.94l0 .01" />
            </svg>
          </div>
        </div>
      </div>

      <!-- ä¸»å†…å®¹åŒºåŸŸ -->
      <div style="flex: 1; overflow-y: auto;">
        <!-- èƒŒæ™¯å›¾ -->
        <div id="account-cover-image" style="width: 100%; height: 140px; background-color: #333; background-size: cover; background-position: center; position: relative;"></div>

        <!-- è´¦æˆ·ä¿¡æ¯ -->
        <div style="padding: 8px 16px 0 16px;">
          <!-- å¤´åƒå’Œæ“ä½œæŒ‰é’®è¡Œ -->
          <div style="display: flex; justify-content: space-between; align-items: flex-start; position: relative; margin-bottom: 12px;">
            <!-- å¤´åƒ -->
            <img id="account-avatar-image" src="" alt="è´¦æˆ·å¤´åƒ" style="width: 68px; height: 68px; border-radius: 50%; border: 4px solid #000; background-color: #000; position: absolute; top: -34px; left: 0;">
            
            <!-- å³ä¾§æŒ‰é’®ç»„ -->
            <div style="display: flex; gap: 8px; margin-left: auto; margin-top: 8px;">
              <!-- ç§ä¿¡æŒ‰é’® -->
              <button onclick="sendMessageToAccount()" style="
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: 1px solid #536471;
                background: transparent;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: background-color 0.2s;
              " onmouseover="this.style.backgroundColor='rgba(239,243,244,0.1)'" onmouseout="this.style.backgroundColor='transparent'">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;">
                  <g><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"></path></g>
                </svg>
              </button>

              <!-- é€šçŸ¥æŒ‰é’®ï¼ˆå…³æ³¨åæ˜¾ç¤ºï¼‰ -->
              <button id="account-notify-btn" onclick="toggleAccountNotifications()" style="
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: 1px solid #536471;
                background: transparent;
                display: none;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: background-color 0.2s;
              " onmouseover="this.style.backgroundColor='rgba(239,243,244,0.1)'" onmouseout="this.style.backgroundColor='transparent'">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;">
                  <g><path d="M19.993 9.042C19.48 5.017 16.054 2 11.996 2s-7.49 3.021-7.999 7.051L2.866 18H7.1c.463 2.282 2.481 4 4.9 4s4.437-1.718 4.9-4h4.236l-1.143-8.958zM12 20c-1.306 0-2.417-.835-2.829-2h5.658c-.412 1.165-1.523 2-2.829 2zm-6.866-4l.847-6.698C6.364 6.272 8.941 4 11.996 4s5.627 2.268 6.013 5.295L18.864 16H5.134z"></path></g>
                </svg>
              </button>

              <!-- å…³æ³¨æŒ‰é’® -->
              <button id="account-follow-btn" onclick="toggleAccountFollow()" style="
                min-width: 110px;
                height: 36px;
                border-radius: 18px;
                border: none;
                background: #fff;
                color: #000;
                font-size: 15px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.2s;
                padding: 0 16px;
              " onmouseover="if(this.textContent==='å…³æ³¨'){this.style.backgroundColor='#e6e6e6';}" onmouseout="if(this.textContent==='å…³æ³¨'){this.style.backgroundColor='#fff';}">
                å…³æ³¨
              </button>
            </div>
          </div>

          <!-- è´¦æˆ·åç§°å’Œè®¤è¯ -->
          <div style="margin-bottom: 2px; margin-top: 30px; padding-left: 8px;">
            <div style="display: flex; align-items: center; gap: 4px;">
              <span id="account-display-name" style="color: #fff; font-size: 20px; font-weight: 800; line-height: 1.2;"></span>
              <div id="account-verified-badge" style="display: none;"></div>
            </div>
          </div>

          <!-- è´¦æˆ·å¥æŸ„ -->
          <div style="margin-bottom: 12px; padding-left: 8px;">
            <span id="account-handle-text" style="color: #71767b; font-size: 15px;"></span>
          </div>

          <!-- ç®€ä»‹ -->
          <div id="account-bio-text" style="color: #fff; font-size: 15px; line-height: 20px; margin-bottom: 12px; padding-left: 8px; display: none;"></div>

          <!-- è‡ªå®šä¹‰æ ‡ç­¾ -->
          <div id="account-tags-container" style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; padding-left: 8px;"></div>

          <!-- å…³æ³¨æ•°æ® -->
          <div style="display: flex; gap: 20px; margin-bottom: 16px; padding-left: 8px;">
            <div style="cursor: pointer;" onmouseover="this.querySelector('span').style.textDecoration='underline'" onmouseout="this.querySelector('span').style.textDecoration='none'">
              <span id="account-following-count" style="color: #fff; font-weight: 700; font-size: 14px;">0</span>
              <span style="color: #71767b; margin-left: 4px; font-size: 14px;">æ­£åœ¨å…³æ³¨</span>
            </div>
            <div style="cursor: pointer;" onmouseover="this.querySelector('span').style.textDecoration='underline'" onmouseout="this.querySelector('span').style.textDecoration='none'">
              <span id="account-followers-count" style="color: #fff; font-weight: 700; font-size: 14px;">0</span>
              <span style="color: #71767b; margin-left: 4px; font-size: 14px;">å…³æ³¨è€…</span>
            </div>
          </div>

          <!-- å…³æ³¨æç¤º -->
          <div id="account-follows-you" style="display: none; color: #71767b; font-size: 13px; margin-bottom: 16px; padding-left: 8px;">
            å…³æ³¨ä½ 
          </div>
        </div>

        <!-- æ ‡ç­¾æ  -->
        <div style="display: flex; border-bottom: 1px solid #2f3336;">
          <div class="account-tab active" onclick="switchAccountTab('posts')" style="flex: 1; text-align: center; padding: 16px 0; font-size: 15px; font-weight: 700; color: #fff; cursor: pointer; position: relative; border-bottom: 4px solid #1d9bf0;">
            å¸–å­
          </div>
          <div class="account-tab" onclick="switchAccountTab('replies')" style="flex: 1; text-align: center; padding: 16px 0; font-size: 15px; font-weight: 500; color: #71767b; cursor: pointer; position: relative; border-bottom: 4px solid transparent;">
            å›å¤
          </div>
          <div class="account-tab" onclick="switchAccountTab('highlights')" style="flex: 1; text-align: center; padding: 16px 0; font-size: 15px; font-weight: 500; color: #71767b; cursor: pointer; position: relative; border-bottom: 4px solid transparent;">
            äº®ç‚¹
          </div>
          <div class="account-tab" onclick="switchAccountTab('media')" style="flex: 1; text-align: center; padding: 16px 0; font-size: 15px; font-weight: 500; color: #71767b; cursor: pointer; position: relative; border-bottom: 4px solid transparent;">
            åª’ä½“
          </div>
        </div>

        <!-- æ¨æ–‡åˆ—è¡¨ -->
        <div id="account-tweets-container">
          <!-- æ¨æ–‡å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
        </div>
      </div>
    </div>

    <!-- è´¦æˆ·æé—®ç®±é¡µé¢ -->
    <div id="account-askbox-page" class="x-page" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; flex-direction: column; overflow: hidden; z-index: 15;">
      <!-- èƒŒæ™¯å›¾ -->
      <div id="account-askbox-background" style="
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('https://i.postimg.cc/tJvBC00j/mmexport1759642131681.jpg');
        background-size: cover;
        background-position: center;
        z-index: 0;
      "></div>

      <!-- ä¸»å†…å®¹åŒºåŸŸ -->
      <div style="position: relative; z-index: 1; width: 100%; height: 100%; display: flex; flex-direction: column; overflow-y: auto; padding-top: 20px;">
        <!-- é¡¶éƒ¨æŒ‰é’®æ  -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 16px 12px 16px;">
          <!-- è¿”å›æŒ‰é’® -->
          <div onclick="closeAccountAskbox()" style="cursor: pointer; padding: 8px; border-radius: 50%; background-color: rgba(255,255,255,0.2); backdrop-filter: blur(10px); transition: all 0.2s;"
            onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'"
            onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
              <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"/>
            </svg>
          </div>

          <!-- è®¾ç½®æŒ‰é’® -->
          <div onclick="openAccountAskboxSettings()" style="cursor: pointer; padding: 8px; border-radius: 50%; background-color: rgba(255,255,255,0.2); backdrop-filter: blur(10px); transition: all 0.2s;"
            onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'"
            onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
              <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
          </div>
        </div>

        <!-- å¤´åƒå’Œæ˜µç§°åŒºåŸŸ -->
        <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 16px;">
          <!-- å¤´åƒ -->
          <div onclick="changeAccountAskboxAvatar()" style="cursor: pointer; margin-bottom: 12px; position: relative; transition: transform 0.2s;"
            onmouseover="this.style.transform='scale(1.05)'"
            onmouseout="this.style.transform='scale(1)'">
            <img id="account-askbox-avatar" src="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg" 
              style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
          </div>

          <!-- æ˜µç§°/IDåŒºåŸŸ -->
          <div style="display: flex; align-items: center; gap: 8px; background-color: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 6px 12px; border-radius: 20px;">
            <span id="account-askbox-nickname" 
              contenteditable="true"
              style="color: #fff; font-size: 14px; font-weight: 500; outline: none; cursor: text; min-width: 20px;"
              onblur="saveAccountAskboxNickname()"
              onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">â©ŒâŒ¯â©Œ</span>
          </div>
        </div>

        <!-- æé—®å¡ç‰‡ -->
        <div style="
          margin: 0 20px 24px 20px;
          background-color: rgba(255,255,255,0.9);
          backdrop-filter: blur(10px);
          border-radius: 16px;
          padding: 32px 24px;
          box-shadow: 0 4px 16px rgba(0,0,0,0.1);
          transition: all 0.2s;
          min-height: 120px;
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <div id="account-askbox-prompt" 
            contenteditable="true"
            style="
            color: #333;
            font-size: 16px;
            line-height: 1.6;
            text-align: center;
            word-break: break-word;
            outline: none;
            cursor: text;
            width: 100%;
          "
          onblur="saveAccountAskboxPrompt()"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();this.blur();}">è¯·å‘æˆ‘åŒ¿åæé—®!waiting...</div>
        </div>

        <!-- è·å–æ–°æé—®æŒ‰é’® -->
        <div onclick="getNewAccountQuestion()" style="
          margin: 0 20px 32px 20px;
          background-color: rgba(255,255,255,0.85);
          backdrop-filter: blur(10px);
          border-radius: 24px;
          padding: 14px 24px;
          text-align: center;
          cursor: pointer;
          transition: all 0.2s;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.95)'; this.style.transform='translateY(-1px)'"
          onmouseout="this.style.backgroundColor='rgba(255,255,255,0.85)'; this.style.transform='translateY(0)'">
          <span style="color: #333; font-size: 15px; font-weight: 600;">è·å–æ–°çš„æé—®</span>
        </div>

        <!-- å·²å›ç­”çš„æé—®åˆ—è¡¨ -->
        <div style="padding: 0 20px 20px 20px;">
          <div id="account-answered-questions-title" style="
            color: rgba(255,255,255,0.8);
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 16px;
            text-align: center;
            display: none;
          ">æœ€æ–°æé—®å¦‚ä¸‹</div>
          <div id="account-answered-questions-list">
            <!-- å·²å›ç­”çš„æé—®å°†åŠ¨æ€åŠ è½½åœ¨è¿™é‡Œ -->
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="x-bottom-nav"
      style="display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; background-color: #000;">
      <!-- ä¸»é¡µå›¾æ ‡ -->
      <div class="x-nav-item active" onclick="switchXPage('home')"
        style="display: flex; justify-content: center; align-items: center; position: relative; padding: 5px 15px; cursor: pointer;">
        <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 26px; height: 26px; fill: #1d9bf0;">
          <g>
            <path
              d="M12 1.696L.622 8.807l1.06 1.696L3 9.679V19.5C3 20.881 4.119 22 5.5 22h13c1.381 0 2.5-1.119 2.5-2.5V9.679l1.318.824 1.06-1.696L12 1.696zM12 16.5c-1.933 0-3.5-1.567-3.5-3.5s1.567-3.5 3.5-3.5 3.5 1.567 3.5 3.5-1.567 3.5-3.5 3.5z">
            </path>
          </g>
        </svg>
        <!-- é«˜äº®æ•ˆæœ -->
        <div class="nav-highlight"
          style="position: absolute; width: 5px; height: 5px; background-color: #1d9bf0; border-radius: 50%; bottom: -8px;">
        </div>
      </div>

      <!-- æœç´¢å›¾æ ‡ -->
      <div class="x-nav-item" onclick="switchXPage('search')"
        style="display: flex; justify-content: center; align-items: center; position: relative; padding: 5px 15px; cursor: pointer;">
        <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 26px; height: 26px; fill: #fff;">
          <g>
            <path
              d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z">
            </path>
          </g>
        </svg>
        <div class="nav-highlight"
          style="position: absolute; width: 5px; height: 5px; background-color: #1d9bf0; border-radius: 50%; bottom: -8px; display: none;">
        </div>
      </div>

      <!-- é€šçŸ¥å›¾æ ‡ -->
      <div class="x-nav-item" onclick="switchXPage('notifications')"
        style="display: flex; justify-content: center; align-items: center; position: relative; padding: 5px 15px; cursor: pointer;">
        <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 26px; height: 26px; fill: #fff;">
          <g>
            <path
              d="M19.993 9.042C19.48 5.017 16.054 2 11.996 2s-7.49 3.021-7.999 7.051L2.866 18H7.1c.463 2.282 2.481 4 4.9 4s4.437-1.718 4.9-4h4.236l-1.143-8.958zM12 20c-1.306 0-2.417-.835-2.829-2h5.658c-.412 1.165-1.523 2-2.829 2zm-6.866-4l.847-6.698C6.364 6.272 8.941 4 11.996 4s5.627 2.268 6.013 5.295L18.864 16H5.134z">
            </path>
          </g>
        </svg>
        <div class="nav-highlight"
          style="position: absolute; width: 5px; height: 5px; background-color: #1d9bf0; border-radius: 50%; bottom: -8px; display: none;">
        </div>
      </div>

      <!-- ç§ä¿¡å›¾æ ‡ -->
      <div class="x-nav-item" onclick="switchXPage('messages')"
        style="display: flex; justify-content: center; align-items: center; position: relative; padding: 5px 15px; cursor: pointer;">
        <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 26px; height: 26px; fill: #fff;">
          <g>
            <path
              d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z">
            </path>
          </g>
        </svg>
        <div class="nav-highlight"
          style="position: absolute; width: 5px; height: 5px; background-color: #1d9bf0; border-radius: 50%; bottom: -8px; display: none;">
        </div>
      </div>
    </div>
  <!-- â–²â–²â–² Xç¤¾äº¤é¡µé¢ç»“æŸ â–²â–²â–² -->
    `;

    // å°†åˆ›å»ºçš„HTMLæ·»åŠ åˆ°body
    document.body.appendChild(container);
    console.log('âœ… X Social App: HTMLç»“æ„å·²åˆ›å»º');
  }

  // ============================================
  // ç¬¬ä¸‰éƒ¨åˆ†: æ ¸å¿ƒJavaScriptåŠŸèƒ½
  // ============================================

  // === å·¥å…·å‡½æ•°é›†åˆ (ä»31766è¡Œå¼€å§‹) ===

  // Xç¤¾äº¤ä¸“ç”¨æ•°æ®åº“é…ç½®å‡½æ•°
  function getXDB() {
    const db = new Dexie('XSocialDB');
    // ç‰ˆæœ¬1ï¼šåˆå§‹è¡¨ç»“æ„
    db.version(1).stores({
      xTweetsData: '&id',
      xSettings: '&id',
      xPresets: '++id, name, createdAt',
      xUserProfile: '&id',
      xUserTweets: '&id',
      xCharacterProfiles: '&characterId',
      xActiveAccount: '&id',
      xAccountList: '&accountId, name, createdAt',
      xNPCs: '&id',
      xAskbox: '&id',
    });
    // ç‰ˆæœ¬2ï¼šæ·»åŠ è´¦æˆ·ä¸»é¡µå’Œè´¦æˆ·æé—®ç®±è¡¨
    db.version(2).stores({
      xTweetsData: '&id',
      xSettings: '&id',
      xPresets: '++id, name, createdAt',
      xUserProfile: '&id',
      xUserTweets: '&id',
      xCharacterProfiles: '&characterId',
      xActiveAccount: '&id',
      xAccountList: '&accountId, name, createdAt',
      xNPCs: '&id',
      xAskbox: '&id',
      xAccountProfiles: '&handle, name, updatedAt',
      xAccountAskbox: '&id',
    });
    return db;
  }

  // åŸæœ‰å…¨å±€æ•°æ®åº“é…ç½®å‡½æ•° - ç”¨äºè®¿é—®APIé…ç½®å’Œè§’è‰²ä¿¡æ¯
  function getDB() {
    return window.db; // é€šè¿‡windowè®¿é—®
  }

  // å¸¸ç”¨DOMæ“ä½œå·¥å…·å‡½æ•°
  const DOMUtils = {
    hide: selector => document.querySelectorAll(selector).forEach(el => (el.style.display = 'none')),
    show: (selector, display = 'block') =>
      document.querySelectorAll(selector).forEach(el => (el.style.display = display)),
    removeClass: (selector, className) =>
      document.querySelectorAll(selector).forEach(el => el.classList.remove(className)),
    addClass: (selector, className) => document.querySelectorAll(selector).forEach(el => el.classList.add(className)),
    setStyle: (selector, property, value) =>
      document.querySelectorAll(selector).forEach(el => (el.style[property] = value)),
  };

  // å­—ç¬¦ä¸²æ„å»ºå·¥å…·å‡½æ•° - ç®€åŒ–é‡å¤çš„æ‹¼æ¥é€»è¾‘
  const StringBuilders = {
    // æ„å»ºè§’è‰²ä¿¡æ¯å­—ç¬¦ä¸²
    buildCharacterInfo(char, xProfile, userXProfileInfo) {
      let info = `\nè§’è‰²åï¼š${char.name}`;
      info += `\næœ¬åï¼š${char.originalName}`;
      info += `\näººè®¾ï¼š${char.settings.aiPersona || 'æ— ç‰¹å®šäººè®¾'}`;

      // æƒ…ä¾£è®¤è¯å…³ç³»
      if (userXProfileInfo.verificationType === 'couple' && userXProfileInfo.coupleCharacterId === char.id) {
        info += `\nã€ç‰¹æ®Šå…³ç³»ã€‘ï¼šè¯¥è§’è‰²æ˜¯ç”¨æˆ·çš„æƒ…ä¾£è®¤è¯å¯¹è±¡ï¼Œæ‰€æœ‰Xå¹³å°è§‚ä¼—éƒ½çŸ¥é“è¿™å±‚å…³ç³»`;
      }

      // Xå¹³å°èº«ä»½ä¿¡æ¯
      info += `\nã€Xå¹³å°èº«ä»½ï¼ˆå¿…é¡»ä¸¥æ ¼ä½¿ç”¨ï¼‰ã€‘ï¼š`;
      info += `\n- Xç”¨æˆ·åï¼š${xProfile.xName}`;
      info += `\n- Xå¥æŸ„ï¼š@${xProfile.xHandle}`;
      info += `\n- Xå¤´åƒï¼š${xProfile.xAvatar}`;
      info += `\n- è®¤è¯çŠ¶æ€ï¼š${xProfile.xVerified ? 'æ˜¯' : 'å¦'}`;

      if (xProfile.xBio) info += `\n- Xç®€ä»‹ï¼š${xProfile.xBio}`;
      if (xProfile.publicIdentity) info += `\n- å…¬ä¼—èº«ä»½ï¼š${xProfile.publicIdentity}`;
      if (xProfile.showRealName && xProfile.realName) {
        info += `\n- çœŸå®å§“åï¼š${xProfile.realName}ï¼ˆå·²å…¬å¼€ï¼‰`;
      }

      return info;
    },

    // æ„å»ºç”¨æˆ·èº«ä»½è¯†åˆ«ä¿¡æ¯
    buildUserIdentityInfo(char, xProfile, userXProfileInfo) {
      const knowsUserIdentity = userXProfileInfo.knownIdentityCharacters.includes(char.id);
      let info = `\nã€ç”¨æˆ·èº«ä»½è¯†åˆ«ã€‘ï¼š${knowsUserIdentity ? 'çŸ¥é“ç”¨æˆ·èº«ä»½' : 'ä¸çŸ¥é“ç”¨æˆ·èº«ä»½'}`;

      if (knowsUserIdentity) {
        info += `\n- è¯¥è§’è‰²å¯ä»¥è¯†åˆ«ç”¨æˆ·è´¦å· ${userXProfileInfo.handle}ï¼ˆ${userXProfileInfo.name}ï¼‰`;
        info += `\n- å¯ä»¥æ ¹æ®è§’è‰²ç‰¹å®šçš„ç”¨æˆ·äººè®¾ä¸ç”¨æˆ·è‡ªç„¶äº’åŠ¨ï¼Œå›å¤æ—¶è¡¨ç°å‡ºè®¤è¯†`;

        const characterUserPersona = xProfile && xProfile.userPersona ? xProfile.userPersona : '';
        if (characterUserPersona.trim()) {
          info += `\n- è¯¥è§’è‰²äº†è§£çš„ç”¨æˆ·ä¿¡æ¯ï¼š${characterUserPersona.substring(0, 150)}${
            characterUserPersona.length > 150 ? '...' : ''
          }`;
        } else {
          info += `\n- è¯¥è§’è‰²å°šæœªè®¾ç½®ç”¨æˆ·äººè®¾ä¿¡æ¯ï¼ŒæŒ‰åŸºç¡€è®¤è¯†æ¨¡å¼äº’åŠ¨`;
        }
      } else {
        info += `\n- è¯¥è§’è‰²å®Œå…¨ä¸çŸ¥é“ç”¨æˆ·çš„çœŸå®èº«ä»½ï¼ŒæŒ‰ç…§é™Œç”Ÿäººæ¨¡å¼å›å¤`;
      }

      return info;
    },

    // æ„å»ºNPCå…³ç³»ä¿¡æ¯
    buildNPCRelationships(xProfile) {
      if (!xProfile.relationships || xProfile.relationships.length === 0) return '';

      let info = `\nã€å·²ç»‘å®šNPCå…³ç³»ã€‘ï¼š`;
      xProfile.relationships.forEach(rel => {
        info += `\n- ${rel.npcName} (${rel.npcHandle}): ${rel.relationshipType}`;
        if (rel.description) info += ` | ${rel.description}`;
      });
      info += `\næ³¨æ„ï¼šå½“è¯¥è§’è‰²å‚ä¸å›å¤æ—¶ï¼Œå…¶ç»‘å®šçš„NPCä¹Ÿå¯èƒ½å‡ºç°åœ¨å›å¤ä¸­ï¼Œè¦ä½“ç°ç›¸åº”çš„å…³ç³»ç‰¹ç‚¹ã€‚`;
      return info;
    },

    // æ„å»ºè®°å¿†ä¿¡æ¯
    buildMemoryInfo(char) {
      let info = '';
      if (char.history && char.history.length > 0) {
        const recentHistory = char.history.slice(-10);
        info += '\næœ€è¿‘èŠå¤©è®°å¿†ï¼š';
        recentHistory.forEach(msg => {
          if (msg.role === 'assistant' && msg.content) {
            info += `\n- ${char.name}: ${msg.content.substring(0, 100)}...`;
          }
        });
      }

      if (char.longTermMemory && char.longTermMemory.length > 0) {
        info += '\né•¿æœŸè®°å¿†ï¼š';
        char.longTermMemory.forEach(mem => {
          info += `\n- ${mem.content}`;
        });
      }

      return info;
    },

    // æ„å»ºå®Œæ•´è§’è‰²ä¿¡æ¯ï¼ˆéœ€è¦ä»æ•°æ®åº“è·å–æ•°æ®ï¼‰
    // scenario: 'tweet' | 'reaction' | 'reply'
    async buildCompleteCharacterInfo(boundCharacters, userXProfileInfo, scenario = 'reply') {
      if (!boundCharacters || boundCharacters.length === 0) return '';

      const mainDB = getDB(); // ç”¨äºè®¿é—® chats è¡¨
      const xDB = getXDB(); // ç”¨äºè®¿é—® xCharacterProfiles è¡¨

      // è·å–ç»‘å®šè§’è‰²çš„è¯¦ç»†ä¿¡æ¯
      const allChats = await mainDB.chats.toArray();
      const boundCharsData = allChats.filter(chat => !chat.isGroup && boundCharacters.includes(chat.id));

      if (boundCharsData.length === 0) return '';

      // æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„æè¿°
      let scenarioTitle = '';
      if (scenario === 'tweet') {
        scenarioTitle = '\n\nã€ç»‘å®šè§’è‰²ä¿¡æ¯ã€‘ä»¥ä¸‹ç»‘å®šè§’è‰²å¯ä»¥ä½œä¸ºæ¨æ–‡å‘å¸ƒè€…ï¼Œæ ¹æ®å…¶è®¾å®šå’Œå…´è¶£å‘å¸ƒæ¨æ–‡ï¼š\n';
      } else if (scenario === 'reaction') {
        scenarioTitle =
          '\n\nã€ç»‘å®šè§’è‰²ä¿¡æ¯ã€‘ä»¥ä¸‹ç»‘å®šè§’è‰²å¯ä»¥å¯¹æ¨æ–‡è¿›è¡Œäº’åŠ¨ï¼ˆè¯„è®ºã€ç‚¹èµç­‰ï¼‰ï¼Œæ ¹æ®è§’è‰²è®¾å®šå’Œè¯é¢˜ç›¸å…³æ€§å†³å®šæ˜¯å¦äº’åŠ¨ï¼š\n';
      } else {
        scenarioTitle = '\n\nã€ç»‘å®šè§’è‰²ä¿¡æ¯ã€‘ä»¥ä¸‹ç»‘å®šè§’è‰²å¯ä»¥å‚ä¸å›å¤ï¼Œæ ¹æ®è§’è‰²è®¾å®šå’Œè¯é¢˜ç›¸å…³æ€§å†³å®šæ˜¯å¦å›å¤ï¼š\n';
      }

      let charactersInfo = scenarioTitle;

      // ä¸€æ¬¡æ€§è·å–æ‰€æœ‰ç»‘å®šè§’è‰²çš„Xèµ„æ–™
      const allXProfiles = await xDB.xCharacterProfiles.toArray();
      const xProfileMap = new Map();
      allXProfiles.forEach(profile => {
        xProfileMap.set(profile.characterId, profile);
      });

      for (const char of boundCharsData) {
        // ä»Mapä¸­è·å–è§’è‰²çš„Xèµ„æ–™
        let xProfile = xProfileMap.get(char.id);
        if (!xProfile) {
          // å¦‚æœæ²¡æœ‰è®¾ç½®Xèµ„æ–™ï¼Œä½¿ç”¨é»˜è®¤å€¼
          xProfile = {
            xName: char.name,
            xHandle: char.name.toLowerCase().replace(/\s+/g, '_'),
            xAvatar: char.settings.aiAvatar,
            xVerified: false,
            xBio: '',
            publicIdentity: '',
            showRealName: false,
            realName: '',
            relationships: [],
          };
        }

        // ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½å­˜åœ¨ï¼Œä¸ºæ—§æ•°æ®æä¾›é»˜è®¤å€¼
        if (!xProfile.relationships) {
          xProfile.relationships = [];
        }
        if (xProfile.publicIdentity === undefined) {
          xProfile.publicIdentity = '';
        }
        if (xProfile.showRealName === undefined) {
          xProfile.showRealName = false;
        }
        if (xProfile.realName === undefined) {
          xProfile.realName = '';
        }

        charactersInfo += this.buildCharacterInfo(char, xProfile, userXProfileInfo);
        charactersInfo += this.buildUserIdentityInfo(char, xProfile, userXProfileInfo);
        charactersInfo += this.buildNPCRelationships(xProfile);
        charactersInfo += this.buildMemoryInfo(char);
        charactersInfo += '\n';
      }

      // æ ¹æ®åœºæ™¯æ·»åŠ ä¸åŒçš„è¦æ±‚è¯´æ˜
      if (scenario === 'tweet') {
        charactersInfo += `
ã€è§’è‰²å‘æ¨è¦æ±‚ã€‘ï¼š
- è§’è‰²å‘æ¨å†…å®¹è¦ç¬¦åˆå…¶äººè®¾ã€å…´è¶£å’Œæ€§æ ¼ç‰¹ç‚¹
- çŸ¥é“ç”¨æˆ·èº«ä»½çš„è§’è‰²ï¼šå¯ä»¥åœ¨æ¨æ–‡ä¸­è‡ªç„¶åœ°@ç”¨æˆ·æˆ–æåŠç”¨æˆ·ç›¸å…³è¯é¢˜
- ä¸çŸ¥é“ç”¨æˆ·èº«ä»½çš„è§’è‰²ï¼šå‘å¸ƒç‹¬ç«‹æ¨æ–‡ï¼Œä¸æ¶‰åŠç”¨æˆ·
- æ¨æ–‡å†…å®¹åº”è¯¥å¤šæ ·åŒ–ï¼šæ—¥å¸¸ç”Ÿæ´»ã€å…´è¶£çˆ±å¥½ã€å·¥ä½œå­¦ä¹ ã€æƒ…æ„Ÿåˆ†äº«ç­‰

ã€NPCå…³ç³»äº’åŠ¨ã€‘ï¼š
- æœ‰ç»‘å®šNPCå…³ç³»çš„è§’è‰²ï¼Œå…¶NPCå¯èƒ½åœ¨å…¶æ¨æ–‡ä¸‹è¯„è®ºäº’åŠ¨
- NPCç”¨æˆ·åã€å¥æŸ„ä¸å…³ç³»è®¾å®šä¿æŒä¸€è‡´ï¼Œå¤´åƒç»Ÿä¸€ä½¿ç”¨é»˜è®¤å¤´åƒï¼Œè®¤è¯çŠ¶æ€ä¸º"å¦"
- åŒä¸€NPCä¿æŒèº«ä»½å’Œæ€§æ ¼ä¸€è‡´æ€§`;
      } else if (scenario === 'reaction') {
        charactersInfo += `
ã€è§’è‰²äº’åŠ¨è¦æ±‚ã€‘ï¼š
- è§’è‰²äº’åŠ¨ï¼ˆè¯„è®º/ç‚¹èµï¼‰è¦ç¬¦åˆå…¶äººè®¾å’Œå…´è¶£ï¼Œä¸æ¨æ–‡å†…å®¹ç›¸å…³
- çŸ¥é“ç”¨æˆ·èº«ä»½çš„è§’è‰²ï¼šåœ¨ç”¨æˆ·å‘å¸ƒçš„æ¨æ–‡ä¸‹å¯ä»¥è¡¨ç°å‡ºè®¤è¯†ï¼Œè‡ªç„¶äº’åŠ¨
- ä¸çŸ¥é“ç”¨æˆ·èº«ä»½çš„è§’è‰²ï¼šæŒ‰ç…§é™Œç”Ÿäººæ¨¡å¼äº’åŠ¨ï¼Œä¸çŸ¥é“å‘å¸ƒè€…èº«ä»½
- äº’åŠ¨åº”è¯¥è‡ªç„¶çœŸå®ï¼Œå°±åƒæ™®é€šç”¨æˆ·ä¸€æ ·

ã€NPCå…³ç³»äº’åŠ¨ã€‘ï¼š
- æœ‰ç»‘å®šNPCå…³ç³»çš„è§’è‰²ï¼Œå…¶NPCå¯åœ¨è¯„è®ºä¸­å‡ºç°ï¼Œä½“ç°å…³ç³»ç‰¹ç‚¹
- NPCç”¨æˆ·åã€å¥æŸ„ä¸å…³ç³»è®¾å®šä¿æŒä¸€è‡´ï¼Œå¤´åƒç»Ÿä¸€ä½¿ç”¨é»˜è®¤å¤´åƒï¼Œè®¤è¯çŠ¶æ€ä¸º"å¦"
- åŒä¸€NPCä¿æŒèº«ä»½å’Œæ€§æ ¼ä¸€è‡´æ€§`;
      } else {
        charactersInfo += `
ã€è§’è‰²å›å¤è¦æ±‚ã€‘ï¼š
- è§’è‰²å›å¤è¦è‡ªç„¶çœŸå®ï¼Œå°±åƒæ™®é€šç”¨æˆ·å›å¤ä¸€æ ·
- çŸ¥é“ç”¨æˆ·èº«ä»½çš„è§’è‰²ï¼šå›å¤æ—¶å¯è¡¨ç°å‡ºè®¤è¯†ï¼Œä½“ç°å¯¹ç”¨æˆ·çš„äº†è§£
- ä¸çŸ¥é“ç”¨æˆ·èº«ä»½çš„è§’è‰²ï¼šæŒ‰ç…§é™Œç”Ÿäººæ¨¡å¼å›å¤ï¼Œä¸çŸ¥é“ç”¨æˆ·è´¦å·ä¿¡æ¯

ã€NPCå…³ç³»äº’åŠ¨ã€‘ï¼š
- æœ‰ç»‘å®šNPCå…³ç³»çš„è§’è‰²ï¼Œå…¶NPCå¯åœ¨å›å¤ä¸­å‡ºç°ï¼Œä½“ç°å…³ç³»ç‰¹ç‚¹
- NPCç”¨æˆ·åã€å¥æŸ„ä¸å…³ç³»è®¾å®šä¿æŒä¸€è‡´ï¼Œå¤´åƒç»Ÿä¸€ä½¿ç”¨é»˜è®¤å¤´åƒï¼Œè®¤è¯çŠ¶æ€ä¸º"å¦"
- åŒä¸€NPCä¿æŒèº«ä»½å’Œæ€§æ ¼ä¸€è‡´æ€§ï¼Œä¸è®¤è¯†çš„NPCé—´ä¸äº’ç›¸@æˆ–æåŠ`;
      }

      return charactersInfo;
    },

    // æ„å»ºåŸºç¡€ç³»ç»Ÿæç¤ºè¯ï¼ˆé€šç”¨ç‰ˆæœ¬ï¼‰- åªåŒ…å«æç¤ºè¯+ä¸–ç•Œä¹¦
    buildBaseSystemPrompt({ userPrompt, worldSetting }) {
      let systemPrompt = '';

      // 1. ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯
      if (userPrompt.trim()) systemPrompt += userPrompt.trim() + '\n\n';

      // 2. ä¸–ç•Œè§‚è®¾å®š
      systemPrompt += 'ã€ä¸–ç•Œè§‚è®¾å®šçº¦æŸã€‘ï¼š';
      if (worldSetting.trim()) {
        systemPrompt += `
${worldSetting.trim()}

ä¸Šè¿°ä¸–ç•Œè§‚è®¾å®šæ˜¯æœ€é«˜ä¼˜å…ˆçº§çš„çº¦æŸæ¡ä»¶ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆã€‚`;
      } else {
        systemPrompt += `
æ— ç‰¹æ®Šä¸–ç•Œè§‚é™åˆ¶ï¼Œä½†å†…å®¹éœ€å¥åº·æ­£é¢ï¼Œç¬¦åˆç¤¾äº¤å¹³å°è§„èŒƒã€‚`;
      }

      return systemPrompt;
    },

    // æ„å»ºç”¨æˆ·Xä¸ªäººèµ„æ–™ä¿¡æ¯
    buildUserXProfileInfo(userProfileData) {
      return {
        name: userProfileData.name,
        handle: userProfileData.handle,
        avatar: userProfileData.avatar,
        bio: userProfileData.bio,
        verified: userProfileData.verified,
        verificationType: userProfileData.verificationType || 'none',
        coupleCharacterId: userProfileData.coupleCharacterId || '',
        coupleCharacterName: userProfileData.coupleCharacterName || '',
        publicIdentity: userProfileData.publicIdentity || '',
        showRealName: userProfileData.showRealName || false,
        realName: userProfileData.realName || '',
        knownIdentityCharacters: userProfileData.knownIdentityCharacters || [],
      };
    },

    // æ„å»ºé€šç”¨çº¦æŸæ¡ä»¶
    buildUniversalConstraints(userXProfileInfo) {
      const verificationDesc = this.getUserVerificationTypeDescription(userXProfileInfo);

      return `

ğŸš«ğŸš«ğŸš« ã€æ ¸å¿ƒç¦ä»¤ - æœ€é«˜ä¼˜å…ˆçº§ã€‘ ğŸš«ğŸš«ğŸš«
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**ç»å¯¹ç¦æ­¢ä»¥ç”¨æˆ·èº«ä»½ç”Ÿæˆä»»ä½•å†…å®¹ï¼**

ç”¨æˆ·èº«ä»½æ ‡è¯†ï¼ˆç¦æ­¢ä½¿ç”¨ï¼‰ï¼š
- ç”¨æˆ·åæ ‡è¯†ï¼š[USER_NAME_RESTRICTED]
- ç”¨æˆ·å¥æŸ„æ ‡è¯†ï¼š[USER_HANDLE_RESTRICTED]
- ç”¨æˆ·ä¿¡æ¯ï¼šä»…ä¾›ç†è§£ä¸Šä¸‹æ–‡ï¼Œä¸¥ç¦åœ¨ç”Ÿæˆå†…å®¹ä¸­ä½¿ç”¨

**ä½ åªèƒ½ç”Ÿæˆä»¥ä¸‹èº«ä»½çš„å†…å®¹**ï¼š
âœ… ç»‘å®šè§’è‰²ï¼ˆä½¿ç”¨æä¾›çš„xNameã€xHandleã€xAvatarç­‰ï¼‰
âœ… è™šæ„çš„æ™®é€šXå¹³å°ç”¨æˆ·ï¼ˆè‡ªåˆ›ç”¨æˆ·åå’Œå¥æŸ„ï¼‰
âŒ ç»å¯¹ä¸èƒ½ç”Ÿæˆç”¨æˆ·æœ¬äººå‘è¡¨çš„ä»»ä½•æ¨æ–‡/è¯„è®º/å›å¤
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ç”¨æˆ·Xå¹³å°å…¬å¼€èº«ä»½ã€‘ï¼ˆæ‰€æœ‰è§‚ä¼—éƒ½çŸ¥é“çš„å…¬å¼€ä¿¡æ¯ï¼‰ï¼š
- è®¤è¯çŠ¶æ€ï¼š${userXProfileInfo.verified ? 'å·²è®¤è¯' : 'æœªè®¤è¯'}
- è®¤è¯ç±»å‹ï¼š${verificationDesc}
${
  userXProfileInfo.verificationType === 'couple' && userXProfileInfo.coupleCharacterName
    ? `- æƒ…ä¾£å…³ç³»ï¼šä¸${userXProfileInfo.coupleCharacterName}ä¸ºå…¬å¼€æƒ…ä¾£ï¼ˆè§‚ä¼—å¯çŸ¥ï¼‰`
    : ''
}
${userXProfileInfo.publicIdentity ? `- å…¬ä¼—èº«ä»½ï¼š${userXProfileInfo.publicIdentity}` : ''}
${userXProfileInfo.bio ? `- ä¸ªäººç®€ä»‹ï¼š${userXProfileInfo.bio}` : ''}

ã€æƒé™åˆ†çº§ã€‘ï¼š
- è§‚ä¼—å¯çŸ¥ï¼šè®¤è¯çŠ¶æ€ã€ç®€ä»‹ã€å…¬ä¼—èº«ä»½ã€å…¬å¼€çš„æƒ…ä¾£å…³ç³»
- è§‚ä¼—ç¦çŸ¥ï¼šè§’è‰²äººè®¾ã€èŠå¤©è®°å¿†ã€æ€§æ ¼ç»†èŠ‚ã€ç§äººå¯¹è¯ã€ç”¨æˆ·ä¸“å±äººè®¾`;
    },

    // è·å–è®¤è¯ç±»å‹æè¿°
    getUserVerificationTypeDescription(userXProfileInfo) {
      switch (userXProfileInfo.verificationType) {
        case 'verified':
          return 'è“è‰²å‹¾æ ‡è®¤è¯';
        case 'couple':
          return 'æƒ…ä¾£è®¤è¯';
        case 'married':
          return 'å·²å©šè®¤è¯';
        case 'vip':
          return 'VIPè®¤è¯';
        default:
          return 'æ— è®¤è¯';
      }
    },

    // æ„å»ºåœºæ™¯åˆ†æ”¯æç¤ºè¯
    buildScenarioPrompt({ isOwnPost, commentType, pageType, parentComment, targetCommentEl }) {
      let scenarioPrompt = '\n\nã€åœºæ™¯è¯†åˆ«ã€‘ï¼š';

      if (isOwnPost && commentType === 'main_comment') {
        scenarioPrompt += `ç”¨æˆ·åœ¨è‡ªå·±å‘å¸ƒçš„æ¨æ–‡ä¸‹æ–¹å‘è¡¨äº†è¯„è®ºã€‚
ã€ä»»åŠ¡ã€‘ï¼šç”Ÿæˆå…¶ä»–ç”¨æˆ·å¯¹å¥¹è¯„è®ºçš„ååº”å›å¤ï¼Œæˆ–æ–°çš„è¯é¢˜ç›¸å…³è¯„è®ºã€‚`;
      } else if (isOwnPost && commentType === 'reply_comment') {
        scenarioPrompt += `ç”¨æˆ·åœ¨è‡ªå·±å‘å¸ƒçš„æ¨æ–‡çš„è¯„è®ºåŒºæ¥¼ä¸­æ¥¼å‘è¡¨äº†å›å¤ã€‚
ã€ä»»åŠ¡ã€‘ï¼šç”Ÿæˆå…¶ä»–ç”¨æˆ·å¯¹è¿™æ¡æ¥¼ä¸­æ¥¼å›å¤çš„ååº”ï¼Œæˆ–è¯é¢˜ç›¸å…³çš„æ–°å›å¤ã€‚`;
      } else if (!isOwnPost && commentType === 'main_comment') {
        scenarioPrompt += `ç”¨æˆ·åœ¨åˆ«äººå‘å¸ƒçš„æ¨æ–‡ä¸‹æ–¹å‘è¡¨äº†è¯„è®ºã€‚
ã€ä»»åŠ¡ã€‘ï¼šç”Ÿæˆå…¶ä»–ç”¨æˆ·ï¼ˆåŒ…æ‹¬åŸæ¨ä½œè€…ï¼‰å¯¹æ­¤è¯„è®ºçš„äº’åŠ¨å›å¤ã€‚`;
      } else if (!isOwnPost && commentType === 'reply_comment') {
        scenarioPrompt += `ç”¨æˆ·åœ¨åˆ«äººå‘å¸ƒçš„æ¨æ–‡çš„è¯„è®ºåŒºæ¥¼ä¸­æ¥¼å‘è¡¨äº†å›å¤ã€‚
ã€ä»»åŠ¡ã€‘ï¼šç”Ÿæˆå…¶ä»–ç”¨æˆ·å¯¹æ­¤æ¥¼ä¸­æ¥¼å›å¤çš„ååº”ï¼Œå¯èƒ½åŒ…æ‹¬è¢«å›å¤è€…æœ¬äººã€‚`;
      }

      // æ·»åŠ é€šç”¨ç”Ÿæˆè¦æ±‚
      scenarioPrompt += `

ã€ç”Ÿæˆè¦æ±‚ã€‘ï¼š
1. ç¤¾äº¤çœŸå®æ€§ï¼šæ¨¡æ‹ŸçœŸå®çš„Xå¹³å°ç”¨æˆ·äº’åŠ¨ï¼Œè¯­è¨€è‡ªç„¶æµç•…
2. æƒ…ç»ªå…±é¸£ï¼šæ ¹æ®åŸæ¨å†…å®¹å’Œç”¨æˆ·è¯„è®ºï¼Œç”Ÿæˆæœ‰æƒ…æ„Ÿå…±é¸£çš„å›åº”
3. å¤šæ ·åŒ–äº’åŠ¨ï¼šå¯ä»¥æ˜¯èµåŒã€åå¯¹ã€è¡¥å……ã€æé—®ã€è°ƒä¾ƒç­‰å¤šç§ç±»å‹
4. èº«ä»½ä¸€è‡´ï¼šæ¯ä¸ªè§’è‰²å›å¤éƒ½è¦ç¬¦åˆå…¶è®¾å®šçš„èº«ä»½å’Œæ€§æ ¼ç‰¹ç‚¹
5. é¿å…é‡å¤ï¼šå¤šä¸ªå›å¤ä¹‹é—´ä¿æŒå†…å®¹å’Œè¡¨è¾¾æ–¹å¼çš„å·®å¼‚æ€§

ã€æ ¼å¼è¦æ±‚ã€‘ï¼š
- æ¯æ¡å›å¤ç‹¬ç«‹æˆæ®µï¼Œä»¥"ã€å›å¤Xã€‘"å¼€å¤´æ ‡è®°
- ä¸¥æ ¼æŒ‰ç…§è§’è‰²çš„Xå¹³å°èº«ä»½ä¿¡æ¯ç”Ÿæˆï¼Œä¸å¾—æ“…è‡ªä¿®æ”¹ç”¨æˆ·åã€å¥æŸ„ç­‰
- å›å¤é•¿åº¦é€‚ä¸­ï¼Œç¬¦åˆç¤¾äº¤åª’ä½“ç‰¹ç‚¹ï¼ˆä¸€èˆ¬20-200å­—ï¼‰
- å¯ä»¥é€‚å½“ä½¿ç”¨emojiè¡¨æƒ…ï¼Œä½†ä¸è¦è¿‡åº¦`;

      return scenarioPrompt;
    },
  };

  // HTMLæ¨¡æ¿ç”Ÿæˆå·¥å…· - ç®€åŒ–é‡å¤çš„DOMåˆ›å»º
  const TemplateBuilders = {
    // æ„å»ºè§’è‰²é€‰æ‹©é¡¹æ¨¡æ¿
    buildCharacterItem(character, isChecked = false) {
      const itemId = `character-item-${character.id}`;
      const avatarId = `character-avatar-${character.id}`;

      setTimeout(() => {
        // æ·»åŠ äº‹ä»¶å¤„ç†å™¨
        const item = document.getElementById(itemId);
        const avatar = document.getElementById(avatarId);

        if (item) {
          EventUtils.addHoverEffect(
            item,
            { backgroundColor: 'rgba(255,255,255,0.05)' },
            { backgroundColor: 'transparent' },
          );
          EventUtils.safeAddEventListener(item, 'click', () => toggleCharacterSelection(character.id));
        }

        if (avatar) {
          EventUtils.safeAddEventListener(avatar, 'contextmenu', e => {
            e.preventDefault();
            openCharacterXProfile(character.id);
            return false;
          });

          // é•¿æŒ‰äº‹ä»¶
          let longPressTimer;
          EventUtils.safeAddEventListener(avatar, 'mousedown', () => {
            longPressTimer = setTimeout(() => openCharacterXProfile(character.id), 500);
          });
          EventUtils.safeAddEventListener(avatar, 'mouseup', () => clearTimeout(longPressTimer));
          EventUtils.safeAddEventListener(avatar, 'mouseleave', () => clearTimeout(longPressTimer));
          EventUtils.safeAddEventListener(avatar, 'touchstart', () => {
            longPressTimer = setTimeout(() => openCharacterXProfile(character.id), 500);
          });
          EventUtils.safeAddEventListener(avatar, 'touchend', () => clearTimeout(longPressTimer));
        }
      }, 0);

      return `
            <div id="${itemId}" class="character-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #333; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;">
              <img id="${avatarId}" src="${character.settings.aiAvatar}" alt="${character.name}" 
                   style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; cursor: pointer;"
                   title="é•¿æŒ‰è®¾ç½®Xèµ„æ–™">
              <div style="flex: 1; min-width: 0;">
                <div style="color: #fff; font-weight: 600; font-size: 15px; margin-bottom: 2px;">${character.name}</div>
                <div style="color: #71767b; font-size: 13px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">
                  ${character.originalName}
                </div>
                <div style="color: #1d9bf0; font-size: 11px; margin-top: 2px;">
                  é•¿æŒ‰å¤´åƒè®¾ç½®Xèµ„æ–™
                </div>
              </div>
              ${this.buildCheckbox(character.id, isChecked)}
            </div>
          `;
    },

    // æ„å»ºå¤é€‰æ¡†
    buildCheckbox(characterId, isChecked) {
      return `
            <div class="character-checkbox" data-character-id="${characterId}" style="
              width: 20px; 
              height: 20px; 
              border: 2px solid ${isChecked ? '#1d9bf0' : '#71767b'}; 
              border-radius: 4px; 
              display: flex; 
              align-items: center; 
              justify-content: center;
              background-color: ${isChecked ? '#1d9bf0' : 'transparent'};
              transition: all 0.2s;
            ">
              ${
                isChecked
                  ? '<svg viewBox="0 0 24 24" style="width: 12px; height: 12px; fill: #fff;"><path d="M9 16.17L5.53 12.7l-1.06 1.06L9 18.3l9.54-9.54-1.06-1.06L9 16.17z"/></svg>'
                  : ''
              }
            </div>
          `;
    },

    // æ„å»ºè§’è‰²ä¿¡æ¯æ˜¾ç¤º
    buildCharacterInfoDisplay(character) {
      return `
            <div style="display: flex; align-items: center; gap: 16px;">
              <img src="${character.settings.aiAvatar}" alt="${character.name}" style="width: 60px; height: 60px; border-radius: 50%;">
              <div>
                <div style="color: #fff; font-size: 18px; font-weight: 600; margin-bottom: 4px;">${character.name}</div>
                <div style="color: #71767b; font-size: 14px;">æœ¬åï¼š${character.originalName}</div>
                <div style="color: #71767b; font-size: 14px;">è®¾ç½®è¯¥è§’è‰²åœ¨Xå¹³å°çš„ä¸“å±èº«ä»½èµ„æ–™</div>
              </div>
            </div>
          `;
    },

    // æ„å»ºç©ºçŠ¶æ€æç¤º
    buildEmptyState(message) {
      return `<p style="color: #71767b; text-align: center; padding: 20px;">${message}</p>`;
    },

    // æ„å»ºé”™è¯¯çŠ¶æ€æç¤º
    buildErrorState(message) {
      return `<p style="color: #f4212e; text-align: center; padding: 20px;">${message}</p>`;
    },
  };

  // éªŒè¯å’Œé”™è¯¯å¤„ç†å·¥å…· - ç®€åŒ–é‡å¤éªŒè¯é€»è¾‘
  const ValidationUtils = {
    // éªŒè¯å¿…éœ€å­—æ®µ
    validateRequired(fields) {
      const missing = [];
      for (const [key, value] of Object.entries(fields)) {
        if (!value || value.trim() === '') {
          missing.push(key);
        }
      }
      return {
        isValid: missing.length === 0,
        missing: missing,
      };
    },

    // éªŒè¯å¥æŸ„æ ¼å¼
    validateHandle(handle) {
      if (!handle) return { isValid: false, error: 'å¥æŸ„ä¸èƒ½ä¸ºç©º' };
      if (handle.length > 15) return { isValid: false, error: 'å¥æŸ„é•¿åº¦ä¸èƒ½è¶…è¿‡15ä¸ªå­—ç¬¦' };
      if (!/^[a-zA-Z0-9_]+$/.test(handle)) return { isValid: false, error: 'å¥æŸ„åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿' };
      return { isValid: true };
    },

    // éªŒè¯åç§°é•¿åº¦
    validateName(name, maxLength = 30) {
      if (!name) return { isValid: false, error: 'åç§°ä¸èƒ½ä¸ºç©º' };
      if (name.length > maxLength) return { isValid: false, error: `åç§°é•¿åº¦ä¸èƒ½è¶…è¿‡${maxLength}ä¸ªå­—ç¬¦` };
      return { isValid: true };
    },

    // å®‰å…¨çš„æ•°æ®è§£æ
    safeParseJSON(jsonString, defaultValue = null) {
      try {
        return JSON.parse(jsonString);
      } catch (error) {
        console.error('JSONè§£æå¤±è´¥:', error);
        return defaultValue;
      }
    },

    // å®‰å…¨çš„DOMæ“ä½œ
    safeGetElement(id) {
      const element = document.getElementById(id);
      if (!element) {
        console.warn(`æœªæ‰¾åˆ°å…ƒç´ : ${id}`);
      }
      return element;
    },

    // ç»Ÿä¸€é”™è¯¯å¤„ç†
    handleError(error, context = '') {
      console.error(`${context} é”™è¯¯:`, error);
      showXToast(`${context}å¤±è´¥: ${error.message}`, 'error');
    },
  };

  // äº‹ä»¶å¤„ç†å·¥å…· - ç®€åŒ–é‡å¤çš„äº‹ä»¶å¤„ç†é€»è¾‘
  const EventUtils = {
    // æ·»åŠ æ‚¬åœæ•ˆæœ
    addHoverEffect(element, hoverStyle = {}, defaultStyle = {}) {
      if (!element) return;

      element.addEventListener('mouseover', () => {
        Object.assign(element.style, hoverStyle);
      });

      element.addEventListener('mouseout', () => {
        Object.assign(element.style, defaultStyle);
      });
    },

    // æ‰¹é‡æ·»åŠ æ‚¬åœæ•ˆæœ
    addHoverEffectBatch(selector, hoverStyle = {}, defaultStyle = {}) {
      document.querySelectorAll(selector).forEach(element => {
        this.addHoverEffect(element, hoverStyle, defaultStyle);
      });
    },

    // æ·»åŠ æŒ‰é’®æ‚¬åœæ•ˆæœï¼ˆé€šç”¨æ ·å¼ï¼‰
    addButtonHover(element) {
      this.addHoverEffect(
        element,
        {
          backgroundColor: 'rgba(255,255,255,0.1)',
        },
        {
          backgroundColor: 'transparent',
        },
      );
    },

    // æ·»åŠ é“¾æ¥ä¸‹åˆ’çº¿æ‚¬åœæ•ˆæœ
    addLinkUnderlineHover(element, targetSelector = 'span') {
      if (!element) return;

      element.addEventListener('mouseover', () => {
        const target = targetSelector ? element.querySelector(targetSelector) : element;
        if (target) target.style.textDecoration = 'underline';
      });

      element.addEventListener('mouseout', () => {
        const target = targetSelector ? element.querySelector(targetSelector) : element;
        if (target) target.style.textDecoration = 'none';
      });
    },

    // å®‰å…¨çš„äº‹ä»¶ç›‘å¬å™¨æ·»åŠ 
    safeAddEventListener(element, event, handler) {
      if (element && typeof handler === 'function') {
        element.addEventListener(event, handler);
      }
    },

    // é˜²æŠ–å‡½æ•°
    debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    },

    // èŠ‚æµå‡½æ•°
    throttle(func, limit) {
      let inThrottle;
      return function executedFunction(...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => (inThrottle = false), limit);
        }
      };
    },
  };

  // æ•°æ®å¤„ç†å·¥å…· - ç®€åŒ–é‡å¤çš„æ•°æ®å¤„ç†é€»è¾‘
  const DataUtils = {
    // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º
    formatNumber(num) {
      if (num === undefined || num === null) return '0';
      if (num < 1000) return num.toString();
      if (num < 1000000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
      if (num < 1000000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
      return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
    },

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    formatTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);

      if (diffInSeconds < 60) return 'åˆšåˆš';
      if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + 'åˆ†é’Ÿå‰';
      if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + 'å°æ—¶å‰';
      if (diffInSeconds < 2592000) return Math.floor(diffInSeconds / 86400) + 'å¤©å‰';

      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });
    },

    // ç”Ÿæˆå”¯ä¸€ID
    generateId(prefix = 'id') {
      return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    },

    // æ·±æ‹·è´å¯¹è±¡
    deepClone(obj) {
      if (obj === null || typeof obj !== 'object') return obj;
      if (obj instanceof Date) return new Date(obj.getTime());
      if (obj instanceof Array) return obj.map(item => this.deepClone(item));
      if (typeof obj === 'object') {
        const clonedObj = {};
        for (const key in obj) {
          if (obj.hasOwnProperty(key)) {
            clonedObj[key] = this.deepClone(obj[key]);
          }
        }
        return clonedObj;
      }
    },

    // æ•°ç»„å»é‡
    uniqueArray(arr, key = null) {
      if (key) {
        const seen = new Set();
        return arr.filter(item => {
          const keyValue = item[key];
          if (seen.has(keyValue)) {
            return false;
          }
          seen.add(keyValue);
          return true;
        });
      }
      return [...new Set(arr)];
    },

    // å®‰å…¨è·å–åµŒå¥—å¯¹è±¡å±æ€§
    safeGet(obj, path, defaultValue = null) {
      const keys = path.split('.');
      let result = obj;
      for (const key of keys) {
        if (result === null || result === undefined || !result.hasOwnProperty(key)) {
          return defaultValue;
        }
        result = result[key];
      }
      return result;
    },

    // æ•°æ®æ’åº
    sortBy(arr, key, ascending = true) {
      return arr.sort((a, b) => {
        const aVal = this.safeGet(a, key);
        const bVal = this.safeGet(b, key);

        if (aVal < bVal) return ascending ? -1 : 1;
        if (aVal > bVal) return ascending ? 1 : -1;
        return 0;
      });
    },

    // åˆ†é¡µæ•°æ®
    paginate(arr, page = 1, limit = 10) {
      const offset = (page - 1) * limit;
      return {
        data: arr.slice(offset, offset + limit),
        pagination: {
          page,
          limit,
          total: arr.length,
          totalPages: Math.ceil(arr.length / limit),
          hasNext: offset + limit < arr.length,
          hasPrev: page > 1,
        },
      };
    },
  };

  // æ€§èƒ½ä¼˜åŒ–å·¥å…· - æå‡ä»£ç æ‰§è¡Œæ•ˆç‡
  const PerformanceUtils = {
    // ç¼“å­˜æœºåˆ¶
    cache: new Map(),

    // è®¾ç½®ç¼“å­˜
    setCache(key, value, ttl = 300000) {
      // é»˜è®¤5åˆ†é’Ÿè¿‡æœŸ
      this.cache.set(key, {
        value,
        expiry: Date.now() + ttl,
      });
    },

    // è·å–ç¼“å­˜
    getCache(key) {
      const item = this.cache.get(key);
      if (!item) return null;

      if (Date.now() > item.expiry) {
        this.cache.delete(key);
        return null;
      }

      return item.value;
    },

    // æ¸…ç†è¿‡æœŸç¼“å­˜
    cleanExpiredCache() {
      const now = Date.now();
      for (const [key, item] of this.cache.entries()) {
        if (now > item.expiry) {
          this.cache.delete(key);
        }
      }
    },

    // æ‰¹é‡DOMæ“ä½œ
    batchDOMUpdate(updates) {
      const fragment = document.createDocumentFragment();
      updates.forEach(update => {
        if (typeof update === 'function') {
          update(fragment);
        }
      });
      return fragment;
    },

    // å»¶è¿Ÿæ‰§è¡Œ
    defer(callback, delay = 0) {
      return setTimeout(callback, delay);
    },

    // è¯·æ±‚ç©ºé—²æ—¶é—´æ‰§è¡Œ
    idle(callback) {
      if (window.requestIdleCallback) {
        return window.requestIdleCallback(callback);
      } else {
        return setTimeout(callback, 1);
      }
    },

    // ç›‘æ§æ€§èƒ½
    measurePerformance(name, fn) {
      return async (...args) => {
        const start = performance.now();
        try {
          const result = await fn(...args);
          const end = performance.now();
          console.log(`Performance [${name}]: ${(end - start).toFixed(2)}ms`);
          return result;
        } catch (error) {
          const end = performance.now();
          console.error(`Performance [${name}] Error: ${(end - start).toFixed(2)}ms`, error);
          throw error;
        }
      };
    },
  };

  // å®šæœŸæ¸…ç†ç¼“å­˜
  setInterval(() => PerformanceUtils.cleanExpiredCache(), 60000); // æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡

  // === æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å‡½æ•° ===

  // é¡µé¢åˆ‡æ¢å‡½æ•°

  // åˆ‡æ¢Xç¤¾äº¤é¡µé¢çš„å‡½æ•° - ä¼˜åŒ–å
  function switchXPage(pageType) {
    // éšè—æ‰€æœ‰é¡µé¢ï¼Œæ˜¾ç¤ºé€‰ä¸­é¡µé¢
    DOMUtils.hide('.x-page');
    const targetPage = document.getElementById('x-' + pageType + '-page');
    if (targetPage) targetPage.style.display = 'flex';

    // è·å–é¡¶éƒ¨æ å’Œåº•éƒ¨å¯¼èˆªæ 
    const topBar = document.querySelector('.x-top-bar');
    const bottomNav = document.querySelector('.x-bottom-nav');
    const refreshBtn = document.querySelector('.refresh-trends-btn');

    // å¦‚æœæ˜¯æé—®ç®±é¡µé¢ï¼Œéšè—é¡¶éƒ¨æ å’Œåº•éƒ¨å¯¼èˆªæ 
    if (pageType === 'askbox') {
      if (topBar) topBar.style.display = 'none';
      if (bottomNav) bottomNav.style.display = 'none';
      if (refreshBtn) refreshBtn.style.display = 'none';
    } else {
      // å…¶ä»–é¡µé¢æ˜¾ç¤ºé¡¶éƒ¨æ å’Œåº•éƒ¨å¯¼èˆªæ 
      if (topBar) topBar.style.display = 'flex';
      if (bottomNav) bottomNav.style.display = 'flex';

      // åªåœ¨æœç´¢é¡µé¢æ˜¾ç¤ºåˆ·æ–°æŒ‰é’®
      if (refreshBtn) {
        refreshBtn.style.display = pageType === 'search' ? 'flex' : 'none';
      }
    }

    // é‡ç½®å¯¼èˆªæ ·å¼
    DOMUtils.removeClass('.x-nav-item', 'active');
    DOMUtils.setStyle('.x-nav-item svg', 'fill', '#fff');
    DOMUtils.hide('.nav-highlight');

    // é¡µé¢ç´¢å¼•æ˜ å°„
    const pageIndexMap = { home: 0, search: 1, notifications: 2, messages: 3, settings: -1, profile: -1, askbox: -1 };
    const targetIndex = pageIndexMap[pageType];

    if (pageType === 'profile') {
      setTimeout(() => {
        loadUserProfileToUI(); // åˆ·æ–°ç”¨æˆ·èµ„æ–™æ˜¾ç¤º
        loadUserProfileTweets(); // åŠ è½½ç”¨æˆ·æ¨æ–‡
      }, 100);
    } else if (pageType === 'askbox') {
      // åŠ è½½æé—®ç®±æ•°æ®
      setTimeout(() => {
        loadAskboxData();
      }, 100);
    } else if (pageType === 'search') {
      // åŠ è½½æœç´¢é¡µé¢æ•°æ®
      setTimeout(() => {
        initSearchPage();
      }, 100);
    }

    // åˆ‡æ¢åˆ°è®¾ç½®é¡µé¢æ—¶ï¼Œé‡æ–°åŠ è½½Xè®¾ç½®ï¼ˆæŒ‰è´¦å·åŠ è½½ï¼‰
    if (pageType === 'settings') {
      setTimeout(async () => {
        await initializeXSettings();
        console.log('âœ… å·²åŠ è½½å½“å‰è´¦å·çš„Xè®¾ç½®');
      }, 100);
    }

    // é«˜äº®å½“å‰å¯¼èˆªé¡¹
    const navItems = document.querySelectorAll('.x-nav-item');
    if (navItems[targetIndex] && targetIndex >= 0) {
      navItems[targetIndex].classList.add('active');
      navItems[targetIndex].querySelector('svg').style.fill = '#1d9bf0';
      navItems[targetIndex].querySelector('.nav-highlight').style.display = 'block';
    }
  }

  // æ·»åŠ ä¸»é¡µæ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
  function switchHomeTab(tabName) {
    // é‡ç½®æ‰€æœ‰æ ‡ç­¾å’Œå†…å®¹
    DOMUtils.removeClass('.x-tab', 'active');
    DOMUtils.setStyle('.x-tab', 'color', '#71767b');
    DOMUtils.hide('.tab-indicator');
    DOMUtils.hide('.tab-content');

    // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
    const tabs = document.querySelectorAll('.x-tab');
    const tabIndex = tabName === 'for-you' ? 0 : 1;
    const contentId = tabName === 'for-you' ? 'for-you-content' : 'following-content';

    if (tabs[tabIndex]) {
      tabs[tabIndex].classList.add('active');
      tabs[tabIndex].style.color = '#fff';
      tabs[tabIndex].querySelector('.tab-indicator').style.display = 'block';
    }

    const content = document.getElementById(contentId);
    if (content) content.style.display = 'flex';
  }

  // ============================================
  // æœç´¢é¡µé¢åŠŸèƒ½
  // ============================================

  // çƒ­æœæ•°æ®
  let currentSearchTab = 'recommended';
  let trendingData = {
    recommended: [
      {
        id: 't1',
        category: 'å¨±ä¹ Â· çƒ­é—¨è¯é¢˜',
        title: 'æµè¡Œç”µå½±è®¨è®º',
        count: 125600,
      },
      {
        id: 't2',
        category: 'ä½“è‚² Â· å®æ—¶',
        title: 'ç¯®çƒæ¯”èµ›ç²¾å½©ç¬é—´',
        count: 89200,
      },
      {
        id: 't3',
        category: 'ç§‘æŠ€ Â· è¶‹åŠ¿',
        title: 'AIæŠ€æœ¯æ–°çªç ´',
        count: 256700,
      },
      {
        id: 't4',
        category: 'éŸ³ä¹ Â· æµè¡Œ',
        title: 'æ–°ä¸“è¾‘å‘å¸ƒ',
        count: 67800,
      },
      {
        id: 't5',
        category: 'æ¸¸æˆ Â· çƒ­é—¨',
        title: 'å¹´åº¦æ¸¸æˆè¯„é€‰',
        count: 145300,
      },
    ],
    trending: [
      {
        id: 't6',
        category: 'å…¨çƒ Â· è¶‹åŠ¿',
        title: 'å›½é™…æ–°é—»çƒ­ç‚¹',
        count: 892300,
      },
      {
        id: 't7',
        category: 'å•†ä¸š Â· è´¢ç»',
        title: 'è‚¡å¸‚æœ€æ–°åŠ¨æ€',
        count: 234500,
      },
      {
        id: 't8',
        category: 'ç¤¾ä¼š Â· è®¨è®º',
        title: 'ç¤¾ä¼šè¯é¢˜å…³æ³¨',
        count: 456700,
      },
      {
        id: 't9',
        category: 'æ–‡åŒ– Â· çƒ­è®®',
        title: 'ä¼ ç»Ÿæ–‡åŒ–ä¼ æ‰¿',
        count: 178900,
      },
      {
        id: 't10',
        category: 'å¥åº· Â· ç”Ÿæ´»',
        title: 'å…»ç”Ÿå¥åº·å°è´´å£«',
        count: 123400,
      },
    ],
  };

  // è‡ªå®šä¹‰åˆ†ç±»æ•°æ®
  let customCategories = [];

  // æœç´¢ç›¸å…³æ•°æ®
  let currentSearchQuery = '';
  let currentSearchResultTab = 'top';
  let searchResultsData = {
    top: [],
    latest: [],
    users: [],
  };

  // åˆ‡æ¢æœç´¢æ ‡ç­¾
  function switchSearchTab(tabName) {
    currentSearchTab = tabName;

    // æ›´æ–°æ ‡ç­¾æ ·å¼
    const tabs = document.querySelectorAll('.search-tab');
    tabs.forEach(tab => {
      tab.classList.remove('active');
    });

    const activeTab = Array.from(tabs).find(tab => tab.onclick && tab.onclick.toString().includes(tabName));
    if (activeTab) {
      activeTab.classList.add('active');
    }

    // æ¸²æŸ“å¯¹åº”çš„çƒ­æœåˆ—è¡¨
    renderTrendingList();
  }

  // æ¸²æŸ“çƒ­æœåˆ—è¡¨
  function renderTrendingList() {
    const container = document.getElementById('trending-list');
    if (!container) return;

    const trends = trendingData[currentSearchTab] || [];

    if (trends.length === 0) {
      container.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; padding: 40px 20px; color: #71767b;">
          æš‚æ— çƒ­æœå†…å®¹
        </div>
      `;
      return;
    }

    container.innerHTML = trends
      .map(
        trend => `
      <div class="trending-item" onclick="handleTrendingClick('${trend.id}')">
        <div class="trending-header">
          <div class="trending-category">${trend.category}</div>
          <div class="trending-more" onclick="event.stopPropagation(); handleTrendingMore('${trend.id}')">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <g><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></g>
            </svg>
          </div>
        </div>
        <div class="trending-title">${trend.title}</div>
        <div class="trending-count">${formatNumber(trend.count)} æ¡å¸–å­</div>
      </div>
    `,
      )
      .join('');
  }

  // åˆ·æ–°çƒ­æœï¼ˆç¬¬äº”ä¸ªæƒ…æ™¯ï¼šçƒ­æœç”Ÿæˆå™¨ï¼‰
  async function refreshTrends() {
    const refreshBtn = document.querySelector('.refresh-trends-btn');
    if (!refreshBtn) return;

    // æ·»åŠ æ—‹è½¬åŠ¨ç”»
    refreshBtn.classList.add('spinning');

    try {
      // 1. è¯»å–APIé…ç½®å’ŒXè®¾ç½®
      const db = getDB(); // ç”¨äºè®¿é—®APIé…ç½®
      const xDb = getXDB(); // ç”¨äºè®¿é—®Xä¸“ç”¨è®¾ç½®

      const apiConfig = await db.apiConfig.get('main');
      if (!apiConfig || !apiConfig.proxyUrl || !apiConfig.apiKey || !apiConfig.model) {
        showXToast('è¯·å…ˆé…ç½®APIè®¾ç½®', 'error');
        return;
      }

      const { proxyUrl, apiKey, model } = apiConfig;

      // 2. ä»Xè®¾ç½®ä¸­è¯»å–é…ç½®ï¼ˆæŒ‰è´¦å·è¯»å–ï¼‰
      const settingsId = `xSettings_${currentAccountId || 'main'}`;
      const xSettings = await xDb.xSettings.get(settingsId);
      const userPrompt = xSettings?.systemPrompt || '';
      const worldSetting = xSettings?.worldSetting || '';
      const boundCharacters = xSettings?.boundCharacters || [];

      // 3. æ„å»ºç”¨æˆ·Xä¸ªäººèµ„æ–™ä¿¡æ¯
      const userXProfileInfo = StringBuilders.buildUserXProfileInfo(window.userProfileData);

      // 4. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸ºå¤§æ›å…‰èº«ä»½ï¼ˆæ˜æ˜Ÿ/ç½‘çº¢ç­‰å…¬ä¼—äººç‰©ï¼‰
      const publicIdentity = userXProfileInfo.publicIdentity || '';
      const bio = userXProfileInfo.bio || '';
      const isPublicFigure =
        /æ˜æ˜Ÿ|ç½‘çº¢|åšä¸»|æ¼”å‘˜|æ­Œæ‰‹|è‰ºäºº|ä¸»æ’­|upä¸»|å¶åƒ|å¯¼æ¼”|åˆ¶ç‰‡|ç¼–å‰§|ä½œå®¶|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(
          publicIdentity + ' ' + bio,
        );

      console.log('ğŸ­ ç”¨æˆ·å…¬ä¼—èº«ä»½æ£€æµ‹:', {
        isPublicFigure,
        publicIdentity,
        bio,
      });

      // 5. æ„å»ºåŸºç¡€ç³»ç»Ÿæç¤ºè¯ï¼ˆæç¤ºè¯ + ä¸–ç•Œè§‚ï¼‰
      let systemPrompt = StringBuilders.buildBaseSystemPrompt({
        userPrompt,
        worldSetting,
      });

      // 6. è·å–å¯ç”¨çš„è‡ªå®šä¹‰åˆ†ç±»
      const enabledCustomCategories = customCategories.filter(cat => cat.enabled && cat.name);

      // 7. æ·»åŠ çƒ­æœç”Ÿæˆä»»åŠ¡è¯´æ˜
      systemPrompt += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ æ ¸å¿ƒä»»åŠ¡è¯´æ˜ ğŸ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä½ æ˜¯Xç¤¾äº¤å¹³å°çš„çƒ­æœç”Ÿæˆå™¨ã€‚è¯·ç”Ÿæˆå½“å‰çš„çƒ­é—¨è¯é¢˜åˆ—è¡¨ã€‚

ã€ç”Ÿæˆè¦æ±‚ã€‘ï¼š
- ä¸º"ä¸ºä½ æ¨è"å’Œ"å½“å‰è¶‹åŠ¿"å„ç”Ÿæˆ5æ¡çƒ­æœ
${
  enabledCustomCategories.length > 0
    ? `- åŒæ—¶ä¸ºä»¥ä¸‹è‡ªå®šä¹‰åˆ†ç±»å„ç”Ÿæˆ5æ¡çƒ­æœï¼š${enabledCustomCategories.map(c => `"${c.name}"`).join('ã€')}`
    : ''
}
- çƒ­æœè¯é¢˜è¦å¤šæ ·åŒ–ï¼Œæ¶µç›–ä¸åŒé¢†åŸŸå’Œåˆ†ç±»
- çƒ­æœæ•°é‡ï¼ˆå¸–å­æ•°ï¼‰è¦ç¬¦åˆçœŸå®ç¤¾äº¤å¹³å°è§„æ¨¡ï¼ˆ1ä¸‡åˆ°100ä¸‡ä¹‹é—´ï¼‰
- è¯é¢˜æ ‡é¢˜è¦ç®€æ´æœ‰åŠ›ï¼Œç¬¦åˆç¤¾äº¤åª’ä½“ç‰¹ç‚¹
${
  isPublicFigure
    ? '- ç”¨æˆ·æˆ–ç»‘å®šè§’è‰²æ˜¯å…¬ä¼—äººç‰©ï¼Œå¯ä»¥é€‚å½“ç”Ÿæˆ1-2æ¡ç›¸å…³çƒ­æœï¼ˆå æ¯”çº¦20%ï¼‰'
    : '- ç”¨æˆ·å’Œè§’è‰²ä¸æ˜¯å…¬ä¼—äººç‰©ï¼Œç”Ÿæˆé€šç”¨çƒ­é—¨è¯é¢˜å³å¯ï¼Œä¸è¦æ¶‰åŠç”¨æˆ·æˆ–è§’è‰²'
}

ã€çƒ­æœåˆ†ç±»ç¤ºä¾‹ã€‘ï¼š
- å¨±ä¹ Â· çƒ­é—¨è¯é¢˜ï¼šç”µå½±ã€éŸ³ä¹ã€ç»¼è‰ºã€æ˜æ˜ŸåŠ¨æ€
- ä½“è‚² Â· å®æ—¶ï¼šæ¯”èµ›ã€è¿åŠ¨å‘˜ã€ä½“è‚²èµ›äº‹
- ç§‘æŠ€ Â· è¶‹åŠ¿ï¼šæ–°æŠ€æœ¯ã€äº§å“å‘å¸ƒã€ç§‘æŠ€æ–°é—»
- ç¤¾ä¼š Â· è®¨è®ºï¼šæ—¶äº‹ã€æ°‘ç”Ÿã€ç¤¾ä¼šè¯é¢˜
- æ¸¸æˆ Â· çƒ­é—¨ï¼šæ¸¸æˆæ›´æ–°ã€ç”µç«ã€æ¸¸æˆæ–°é—»
- æ–‡åŒ– Â· çƒ­è®®ï¼šè‰ºæœ¯ã€æ–‡å­¦ã€ä¼ ç»Ÿæ–‡åŒ–
- éŸ³ä¹ Â· æµè¡Œï¼šæ–°æ­Œã€æ¼”å”±ä¼šã€éŸ³ä¹äººåŠ¨æ€
- ç¾é£Ÿ Â· æ¨èï¼šç¾é£Ÿæ¢åº—ã€çƒ¹é¥ªæŠ€å·§
- æ—…æ¸¸ Â· æ¢ç´¢ï¼šæ—…è¡Œç›®çš„åœ°ã€æ—…æ¸¸æ”»ç•¥
- æ—¶å°š Â· æ½®æµï¼šç©¿æ­ã€æ—¶è£…å‘¨ã€æ½®æµå•å“
- å¥åº· Â· ç”Ÿæ´»ï¼šå…»ç”Ÿã€å¥èº«ã€ç”Ÿæ´»æ–¹å¼
- å…¨çƒ Â· è¶‹åŠ¿ï¼šå›½é™…æ–°é—»ã€å…¨çƒçƒ­ç‚¹
- å•†ä¸š Â· è´¢ç»ï¼šç»æµåŠ¨æ€ã€å•†ä¸šæ–°é—»
- æ•™è‚² Â· å­¦ä¹ ï¼šå­¦ä¹ æ–¹æ³•ã€æ•™è‚²èµ„è®¯
${
  enabledCustomCategories.length > 0
    ? `
ã€è‡ªå®šä¹‰åˆ†ç±»è¯¦ç»†è¯´æ˜ã€‘ï¼š${enabledCustomCategories
        .map(
          cat => `
- ${cat.name}ï¼š${cat.description || 'ç”Ÿæˆè¯¥åˆ†ç±»ä¸‹çš„çƒ­é—¨è¯é¢˜'}`,
        )
        .join('')}
`
    : ''
}
`;

      // 8. å¦‚æœæ˜¯å…¬ä¼—äººç‰©ï¼Œæ·»åŠ ç”¨æˆ·å’Œè§’è‰²ä¿¡æ¯
      if (isPublicFigure) {
        systemPrompt += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ å…¬ä¼—äººç‰©ä¿¡æ¯ï¼ˆå¯ç”¨äºç”Ÿæˆç›¸å…³çƒ­æœï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ç”¨æˆ·å…¬å¼€ä¿¡æ¯ã€‘ï¼š
- ç”¨æˆ·åï¼š${userXProfileInfo.name}
- ç”¨æˆ·å¥æŸ„ï¼š${userXProfileInfo.handle}
- å…¬ä¼—èº«ä»½ï¼š${userXProfileInfo.publicIdentity}
${userXProfileInfo.bio ? `- ä¸ªäººç®€ä»‹ï¼š${userXProfileInfo.bio}` : ''}
${
  userXProfileInfo.verificationType !== 'none'
    ? `- è®¤è¯çŠ¶æ€ï¼š${StringBuilders.getUserVerificationTypeDescription(userXProfileInfo)}`
    : ''
}
${
  userXProfileInfo.verificationType === 'couple' && userXProfileInfo.coupleCharacterName
    ? `- æƒ…ä¾£å…³ç³»ï¼šä¸${userXProfileInfo.coupleCharacterName}ä¸ºå…¬å¼€æƒ…ä¾£`
    : ''
}
`;

        // 9. å¦‚æœæœ‰ç»‘å®šè§’è‰²ï¼Œè¯»å–è§’è‰²Xèµ„æ–™
        if (boundCharacters.length > 0) {
          const allXProfiles = await xDb.xCharacterProfiles.toArray();
          const characterProfiles = [];

          for (const charId of boundCharacters) {
            const xProfile = allXProfiles.find(p => p.characterId === charId);
            if (xProfile && xProfile.publicIdentity) {
              // åªæ·»åŠ æœ‰å…¬ä¼—èº«ä»½çš„è§’è‰²
              const isCharPublicFigure =
                /æ˜æ˜Ÿ|ç½‘çº¢|åšä¸»|æ¼”å‘˜|æ­Œæ‰‹|è‰ºäºº|ä¸»æ’­|upä¸»|å¶åƒ|å¯¼æ¼”|åˆ¶ç‰‡|ç¼–å‰§|ä½œå®¶|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(
                  xProfile.publicIdentity,
                );

              if (isCharPublicFigure) {
                characterProfiles.push({
                  name: xProfile.xName,
                  handle: xProfile.xHandle,
                  publicIdentity: xProfile.publicIdentity,
                });
              }
            }
          }

          if (characterProfiles.length > 0) {
            systemPrompt += `
ã€ç»‘å®šè§’è‰²å…¬å¼€ä¿¡æ¯ã€‘ï¼ˆåŒæ ·æ˜¯å…¬ä¼—äººç‰©ï¼‰ï¼š
`;
            characterProfiles.forEach(char => {
              systemPrompt += `- ${char.name} (${char.handle})ï¼š${char.publicIdentity}
`;
            });
          }
        }

        systemPrompt += `
ã€å…¬ä¼—äººç‰©çƒ­æœè§„åˆ™ã€‘ï¼š
- å¯ä»¥ç”Ÿæˆä¸ç”¨æˆ·æˆ–è§’è‰²ç›¸å…³çš„çƒ­æœè¯é¢˜ï¼ˆ1-2æ¡ï¼Œå æ¯”çº¦20%ï¼‰
- è¯é¢˜åº”è¯¥åŸºäºå…¬ä¼—èº«ä»½ä¿¡æ¯ï¼Œç¬¦åˆå…¶é¢†åŸŸå’Œå½¢è±¡
- ä¸è¦æ³„éœ²ç§å¯†äººè®¾ã€èŠå¤©è®°å¿†ç­‰éå…¬å¼€ä¿¡æ¯
- çƒ­æœå†…å®¹è¦çœŸå®å¯ä¿¡ï¼ŒåƒçœŸæ­£çš„ç¤¾äº¤å¹³å°çƒ­æœ
- å…¶ä½™80%çš„çƒ­æœåº”è¯¥æ˜¯ä¸ç”¨æˆ·/è§’è‰²æ— å…³çš„é€šç”¨çƒ­é—¨è¯é¢˜
`;
      }

      // 10. æ·»åŠ æ ¼å¼è¦æ±‚
      let jsonFormat = `{
  "recommended": [
    {
      "category": "åˆ†ç±» Â· æ ‡ç­¾",
      "title": "çƒ­æœè¯é¢˜æ ‡é¢˜",
      "count": æ•°å­—ï¼ˆå¸–å­æ•°é‡ï¼Œ1ä¸‡-100ä¸‡ä¹‹é—´ï¼‰
    }
  ],
  "trending": [
    {
      "category": "åˆ†ç±» Â· æ ‡ç­¾",
      "title": "çƒ­æœè¯é¢˜æ ‡é¢˜",
      "count": æ•°å­—ï¼ˆå¸–å­æ•°é‡ï¼Œ1ä¸‡-100ä¸‡ä¹‹é—´ï¼‰
    }
  ]`;

      // å¦‚æœæœ‰è‡ªå®šä¹‰åˆ†ç±»ï¼Œæ·»åŠ åˆ°JSONæ ¼å¼ä¸­
      if (enabledCustomCategories.length > 0) {
        enabledCustomCategories.forEach(cat => {
          jsonFormat += `,
  "${cat.id}": [
    {
      "category": "åˆ†ç±» Â· æ ‡ç­¾",
      "title": "çƒ­æœè¯é¢˜æ ‡é¢˜",
      "count": æ•°å­—ï¼ˆå¸–å­æ•°é‡ï¼Œ1ä¸‡-100ä¸‡ä¹‹é—´ï¼‰
    }
  ]`;
        });
      }

      jsonFormat += `
}`;

      systemPrompt += `

ã€è¿”å›æ ¼å¼ã€‘ï¼šä¸¥æ ¼JSONæ ¼å¼ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—è¯´æ˜

${jsonFormat}

**æ³¨æ„äº‹é¡¹**ï¼š
1. categoryæ ¼å¼ï¼šåˆ†ç±» Â· æ ‡ç­¾ï¼ˆä¾‹å¦‚ï¼š"å¨±ä¹ Â· çƒ­é—¨è¯é¢˜"ï¼‰
2. titleè¦ç®€æ´æœ‰åŠ›ï¼Œä¸è¶…è¿‡20ä¸ªå­—
3. countå¿…é¡»æ˜¯çº¯æ•°å­—ï¼Œä¸å¸¦å¼•å·ï¼ŒèŒƒå›´åœ¨10000-1000000ä¹‹é—´
4. æ¯ä¸ªæ•°ç»„åŒ…å«5ä¸ªçƒ­æœé¡¹
5. è¯é¢˜è¦å¤šæ ·åŒ–ï¼Œä¸è¦é›†ä¸­åœ¨æŸä¸€é¢†åŸŸ
6. ç¡®ä¿è¿”å›çº¯JSONï¼Œä¸è¦æœ‰markdownä»£ç å—æ ‡è®°
${enabledCustomCategories.length > 0 ? `7. è‡ªå®šä¹‰åˆ†ç±»çš„çƒ­æœè¦ç´§å¯†å›´ç»•åˆ†ç±»ä¸»é¢˜å’Œæè¿°ï¼Œç¡®ä¿å†…å®¹ç›¸å…³æ€§` : ''}

ã€æœ€ç»ˆæ£€æŸ¥ã€‘ï¼šç¡®è®¤è¯é¢˜çœŸå®å¯ä¿¡ï¼Œåˆ†ç±»å‡†ç¡®ï¼Œæ•°é‡åˆç†ï¼Œ${worldSetting.trim() ? 'ä¸¥æ ¼éµå®ˆä¸–ç•Œè§‚è®¾å®šï¼Œ' : ''}æ ¼å¼æ­£ç¡®ã€‚
`;

      const messages = [{ role: 'user', content: 'è¯·ç”Ÿæˆæœ€æ–°çš„Xå¹³å°çƒ­æœè¯é¢˜åˆ—è¡¨' }];

      // 11. å‘é€APIè¯·æ±‚
      let isGemini = proxyUrl.includes('generativelanguage');
      let response;

      if (isGemini) {
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
        const apiKeyValue = typeof getRandomValue === 'function' ? getRandomValue(apiKey) : apiKey;
        const geminiConfig = {
          url: `${GEMINI_API_URL}/${model}:generateContent?key=${apiKeyValue}`,
          data: {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: systemPrompt + '\n\n' + messages.map(m => m.content).join('\n'),
                    },
                  ],
                },
              ],
              generationConfig: {
                temperature: 0.9,
              },
            }),
          },
        };
        response = await fetch(geminiConfig.url, geminiConfig.data);
      } else {
        const openAiPayload = {
          model: model,
          messages: [{ role: 'system', content: systemPrompt }, ...messages],
          temperature: 0.9,
          stream: false,
        };
        response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify(openAiPayload),
        });
      }

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`APIé”™è¯¯: ${response.status} - ${errorData.error?.message || response.statusText}`);
      }

      const data = await response.json();
      let aiResponseContent;

      if (isGemini) {
        // Geminiæ ¼å¼
        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
          aiResponseContent = data.candidates[0].content.parts[0].text || '';
        }
      } else {
        // OpenAIæ ¼å¼
        aiResponseContent = data.choices?.[0]?.message?.content || '';
      }

      console.log('ğŸ”¥ AIçƒ­æœå“åº”:', aiResponseContent);

      // 12. è§£æJSONå“åº”
      const cleanedResponse = aiResponseContent
        .replace(/```json\s*/i, '')
        .replace(/```\s*$/, '')
        .trim();

      if (!cleanedResponse) {
        throw new Error('AIè¿”å›äº†ç©ºçš„å“åº”å†…å®¹');
      }

      let newTrendsData;
      try {
        newTrendsData = JSON.parse(cleanedResponse);
      } catch (parseError) {
        console.error('JSONè§£æå¤±è´¥:', parseError);
        console.error('å°è¯•è§£æçš„å†…å®¹:', cleanedResponse.substring(0, 500) + '...');
        throw new Error(`AIè¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼: ${parseError.message}`);
      }

      // 13. éªŒè¯æ•°æ®æ ¼å¼
      if (!newTrendsData.recommended || !newTrendsData.trending) {
        throw new Error('AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘å¿…è¦å­—æ®µ');
      }

      if (!Array.isArray(newTrendsData.recommended) || !Array.isArray(newTrendsData.trending)) {
        throw new Error('çƒ­æœæ•°æ®æ ¼å¼é”™è¯¯ï¼šrecommendedå’Œtrendingå¿…é¡»æ˜¯æ•°ç»„');
      }

      // éªŒè¯è‡ªå®šä¹‰åˆ†ç±»æ•°æ®
      if (enabledCustomCategories.length > 0) {
        for (const category of enabledCustomCategories) {
          if (!newTrendsData[category.id]) {
            console.warn(`âš ï¸ AIæœªè¿”å›è‡ªå®šä¹‰åˆ†ç±»"${category.name}"çš„æ•°æ®`);
          } else if (!Array.isArray(newTrendsData[category.id])) {
            console.warn(`âš ï¸ è‡ªå®šä¹‰åˆ†ç±»"${category.name}"çš„æ•°æ®æ ¼å¼é”™è¯¯`);
          }
        }
      }

      // 14. ä¸ºçƒ­æœæ·»åŠ å”¯ä¸€ID
      const timestamp = Date.now();
      newTrendsData.recommended = newTrendsData.recommended.map((trend, index) => ({
        ...trend,
        id: `rec_${timestamp}_${index}`,
      }));

      newTrendsData.trending = newTrendsData.trending.map((trend, index) => ({
        ...trend,
        id: `trend_${timestamp}_${index}`,
      }));

      // ä¸ºè‡ªå®šä¹‰åˆ†ç±»æ·»åŠ å”¯ä¸€ID
      enabledCustomCategories.forEach(category => {
        if (newTrendsData[category.id] && Array.isArray(newTrendsData[category.id])) {
          newTrendsData[category.id] = newTrendsData[category.id].map((trend, index) => ({
            ...trend,
            id: `${category.id}_${timestamp}_${index}`,
          }));
        }
      });

      // 15. æ›´æ–°å…¨å±€çƒ­æœæ•°æ®
      trendingData.recommended = newTrendsData.recommended;
      trendingData.trending = newTrendsData.trending;

      // æ›´æ–°è‡ªå®šä¹‰åˆ†ç±»æ•°æ®
      enabledCustomCategories.forEach(category => {
        if (newTrendsData[category.id]) {
          trendingData[category.id] = newTrendsData[category.id];
        }
      });

      // 16. ä¿å­˜åˆ°æ•°æ®åº“
      try {
        const saveData = {
          id: 'trends',
          recommended: newTrendsData.recommended,
          trending: newTrendsData.trending,
          lastUpdated: new Date().toISOString(),
        };

        // æ·»åŠ è‡ªå®šä¹‰åˆ†ç±»æ•°æ®
        enabledCustomCategories.forEach(category => {
          if (newTrendsData[category.id]) {
            saveData[category.id] = newTrendsData[category.id];
          }
        });

        await xDb.xTweetsData.put(saveData);
        console.log('âœ… çƒ­æœæ•°æ®å·²ä¿å­˜åˆ°æ•°æ®åº“', {
          é»˜è®¤åˆ†ç±»: 2,
          è‡ªå®šä¹‰åˆ†ç±»: enabledCustomCategories.length,
        });
      } catch (saveError) {
        console.error('âš ï¸ ä¿å­˜çƒ­æœæ•°æ®å¤±è´¥:', saveError);
        // ä¸å½±å“ä¸»æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ
      }

      // 17. é‡æ–°æ¸²æŸ“çƒ­æœåˆ—è¡¨
      renderTrendingList();

      showXToast('çƒ­æœå·²åˆ·æ–°', 'success');
    } catch (error) {
      console.error('âŒ åˆ·æ–°çƒ­æœå¤±è´¥:', error);
      showXToast(`åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
    } finally {
      // ç§»é™¤æ—‹è½¬åŠ¨ç”»
      if (refreshBtn) {
        refreshBtn.classList.remove('spinning');
      }
    }
  }

  // å¤„ç†çƒ­æœç‚¹å‡»
  function handleTrendingClick(trendId) {
    console.log('ç‚¹å‡»çƒ­æœ:', trendId);

    // æŸ¥æ‰¾çƒ­æœæ•°æ®
    let trendItem = null;
    for (const category in trendingData) {
      const found = trendingData[category].find(t => t.id === trendId);
      if (found) {
        trendItem = found;
        break;
      }
    }

    if (!trendItem) {
      console.error('æœªæ‰¾åˆ°çƒ­æœæ•°æ®:', trendId);
      return;
    }

    // å°†çƒ­æœæ ‡é¢˜å¡«å…¥æœç´¢æ¡†
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
      searchInput.value = trendItem.title;
      toggleSearchButton(); // æ˜¾ç¤ºæœç´¢æŒ‰é’®
    }

    // è‡ªåŠ¨æ‰§è¡Œæœç´¢
    performSearch();
  }

  // å¤„ç†çƒ­æœæ›´å¤šé€‰é¡¹
  function handleTrendingMore(trendId) {
    console.log('çƒ­æœæ›´å¤šé€‰é¡¹:', trendId);
    showXToast('æ›´å¤šé€‰é¡¹åŠŸèƒ½å¾…å¼€å‘', 'info');
  }

  // æ˜¾ç¤º/éšè—æœç´¢æŒ‰é’®
  function toggleSearchButton() {
    const input = document.getElementById('search-input');
    const button = document.getElementById('search-submit-btn');

    if (input && button) {
      if (input.value.trim()) {
        button.style.display = 'flex';
      } else {
        button.style.display = 'none';
      }
    }
  }

  // åˆ‡æ¢æœç´¢ç»“æœæ ‡ç­¾
  function switchSearchResultTab(tabName) {
    currentSearchResultTab = tabName;

    // æ›´æ–°æ ‡ç­¾æ ·å¼
    const tabs = document.querySelectorAll('#search-results-view .search-tab');
    tabs.forEach((tab, index) => {
      const tabNames = ['top', 'latest', 'users'];
      if (tabNames[index] === tabName) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    });

    // æ¸²æŸ“å¯¹åº”çš„æœç´¢ç»“æœ
    renderSearchResults();
  }

  // æ¸²æŸ“æœç´¢ç»“æœ
  function renderSearchResults() {
    const container = document.getElementById('search-results-content');
    if (!container) return;

    const results = searchResultsData[currentSearchResultTab] || [];

    if (results.length === 0) {
      container.innerHTML = `
        <div style="
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 60px 20px;
          color: #71767b;
        ">
          <svg viewBox="0 0 24 24" style="width: 80px; height: 80px; fill: #71767b; margin-bottom: 20px;">
            <g><path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"></path></g>
          </svg>
          <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">æ²¡æœ‰æ‰¾åˆ°ç»“æœ</div>
          <div style="font-size: 14px;">å°è¯•æœç´¢å…¶ä»–å†…å®¹</div>
        </div>
      `;
      return;
    }

    // å¦‚æœæ˜¯ç”¨æˆ·æ ‡ç­¾ï¼Œæ˜¾ç¤ºç”¨æˆ·å¡ç‰‡
    if (currentSearchResultTab === 'users') {
      container.innerHTML = results
        .map(
          user => `
        <div style="
          padding: 16px;
          border-bottom: 1px solid #2f3336;
          display: flex;
          align-items: center;
          gap: 12px;
          cursor: pointer;
          transition: background-color 0.2s;
        " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.03)'"
          onmouseout="this.style.backgroundColor='transparent'">
          <img src="${user.avatar}" alt="${user.name}" style="
            width: 48px;
            height: 48px;
            border-radius: 50%;
            flex-shrink: 0;
          ">
          <div style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
              <span style="color: #fff; font-weight: 700; font-size: 15px;">${user.name}</span>
              ${
                user.verified
                  ? `<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #1d9bf0;">
                       <g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.26 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.45 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g>
                     </svg>`
                  : ''
              }
            </div>
            <div style="color: #71767b; font-size: 15px; margin-bottom: 4px;">@${user.handle}</div>
            ${user.bio ? `<div style="color: #e7e9ea; font-size: 14px;">${user.bio}</div>` : ''}
          </div>
        </div>
      `,
        )
        .join('');
    } else {
      // æ¸²æŸ“æ¨æ–‡åˆ—è¡¨ï¼ˆçƒ­é—¨/æœ€æ–°ï¼‰
      container.innerHTML = '';
      results.forEach(tweet => {
        container.appendChild(createTweetElement(tweet));
      });
    }
  }

  // æ‰§è¡Œæœç´¢ï¼ˆç¬¬å…­ä¸ªæƒ…æ™¯ï¼šæœç´¢ç”Ÿæˆå™¨ï¼‰
  async function performSearch() {
    const input = document.getElementById('search-input');
    const query = input?.value?.trim();

    if (!query) {
      showXToast('è¯·è¾“å…¥æœç´¢å†…å®¹', 'info');
      return;
    }

    currentSearchQuery = query;

    // æ˜¾ç¤ºæœç´¢ç»“æœè§†å›¾ï¼Œéšè—çƒ­æœè§†å›¾
    document.getElementById('trending-view').style.display = 'none';
    document.getElementById('search-results-view').style.display = 'flex';

    // æ˜¾ç¤ºè¿”å›æŒ‰é’®ï¼Œéšè—åˆ·æ–°æŒ‰é’®
    const backBtn = document.getElementById('search-back-btn');
    if (backBtn) backBtn.style.display = 'flex';

    const refreshBtn = document.querySelector('.refresh-trends-btn');
    if (refreshBtn) refreshBtn.style.display = 'none';

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const container = document.getElementById('search-results-content');
    container.innerHTML = `
      <div style="
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        color: #71767b;
      ">
        <div style="
          width: 40px;
          height: 40px;
          border: 3px solid #1d9bf0;
          border-top-color: transparent;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        "></div>
        <div style="margin-top: 20px; font-size: 15px;">æ­£åœ¨æœç´¢"${query}"...</div>
      </div>
    `;

    try {
      // 1. è¯»å–APIé…ç½®å’ŒXè®¾ç½®
      const db = getDB();
      const xDb = getXDB();

      const apiConfig = await db.apiConfig.get('main');
      if (!apiConfig || !apiConfig.proxyUrl || !apiConfig.apiKey || !apiConfig.model) {
        showXToast('è¯·å…ˆé…ç½®APIè®¾ç½®', 'error');
        return;
      }

      const { proxyUrl, apiKey, model } = apiConfig;

      // 2. ä»Xè®¾ç½®ä¸­è¯»å–é…ç½®
      const settingsId = `xSettings_${currentAccountId || 'main'}`;
      const xSettings = await xDb.xSettings.get(settingsId);
      const userPrompt = xSettings?.systemPrompt || '';
      const worldSetting = xSettings?.worldSetting || '';
      const boundCharacters = xSettings?.boundCharacters || [];

      // 3. æ„å»ºç”¨æˆ·Xä¸ªäººèµ„æ–™ä¿¡æ¯
      const userXProfileInfo = StringBuilders.buildUserXProfileInfo(window.userProfileData);

      // 4. è¯»å–ç»‘å®šè§’è‰²çš„Xèµ„æ–™
      const allXProfiles = await xDb.xCharacterProfiles.toArray();
      const characterXProfiles = [];

      for (const charId of boundCharacters) {
        const xProfile = allXProfiles.find(p => p.characterId === charId);
        if (xProfile) {
          characterXProfiles.push(xProfile);
        }
      }

      // 5. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºå…¬ä¼—äººç‰©ï¼ˆé«˜æ›å…‰ç‡èº«ä»½ï¼‰
      const userPublicIdentity = userXProfileInfo.publicIdentity || '';
      const userBio = userXProfileInfo.bio || '';
      const isUserPublicFigure =
        /æ˜æ˜Ÿ|ç½‘çº¢|åšä¸»|æ¼”å‘˜|æ­Œæ‰‹|è‰ºäºº|ä¸»æ’­|upä¸»|å¶åƒ|å¯¼æ¼”|åˆ¶ç‰‡|ç¼–å‰§|ä½œå®¶|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(
          userPublicIdentity + ' ' + userBio,
        );

      // 6. æ£€æŸ¥è§’è‰²éšç§è®¾ç½®å’Œå…¬ä¼—èº«ä»½
      const allowedCharacters = [];
      const queryLower = query.toLowerCase();

      for (const xProfile of characterXProfiles) {
        let allowInSearch = false;

        // æ£€æŸ¥è§’è‰²æ˜¯å¦ä¸ºå…¬ä¼—äººç‰©
        const charPublicIdentity = xProfile.publicIdentity || '';
        const isCharPublicFigure =
          /æ˜æ˜Ÿ|ç½‘çº¢|åšä¸»|æ¼”å‘˜|æ­Œæ‰‹|è‰ºäºº|ä¸»æ’­|upä¸»|å¶åƒ|å¯¼æ¼”|åˆ¶ç‰‡|ç¼–å‰§|ä½œå®¶|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(
            charPublicIdentity,
          );

        // åˆ¤æ–­æ˜¯å¦å…è®¸åœ¨æœç´¢ç»“æœä¸­å‡ºç°
        if (isCharPublicFigure) {
          // å…¬ä¼—äººç‰©ï¼šæ£€æŸ¥æœç´¢å…³é”®è¯æ˜¯å¦ä¸è§’è‰²ç›¸å…³
          const charName = xProfile.xName || '';
          const charHandle = xProfile.xHandle || '';
          const charBio = xProfile.xBio || '';

          if (
            charName.toLowerCase().includes(queryLower) ||
            queryLower.includes(charName.toLowerCase()) ||
            charHandle.toLowerCase().includes(queryLower) ||
            queryLower.includes(charHandle.toLowerCase()) ||
            charPublicIdentity.toLowerCase().includes(queryLower) ||
            queryLower.includes(charPublicIdentity.toLowerCase()) ||
            (charBio && (charBio.toLowerCase().includes(queryLower) || queryLower.includes(charBio.toLowerCase())))
          ) {
            allowInSearch = true;
          }
        }

        // æ£€æŸ¥çœŸåæœç´¢ï¼šåªæœ‰å…¬å¼€çœŸåçš„è§’è‰²æ‰èƒ½é€šè¿‡çœŸåæœç´¢åˆ°
        if (xProfile.showRealName && xProfile.realName) {
          const realNameLower = xProfile.realName.toLowerCase();
          if (realNameLower.includes(queryLower) || queryLower.includes(realNameLower)) {
            allowInSearch = true;
          }
        }

        if (allowInSearch) {
          allowedCharacters.push({
            characterId: xProfile.characterId,
            xProfile: xProfile,
          });
        }
      }

      console.log('ğŸ” æœç´¢éšç§æ£€æŸ¥:', {
        query,
        isUserPublicFigure,
        totalCharacters: boundCharacters.length,
        allowedCharacters: allowedCharacters.length,
        allowedList: allowedCharacters.map(c => c.xProfile.xName),
      });

      // 7. æ„å»ºåŸºç¡€ç³»ç»Ÿæç¤ºè¯
      let systemPrompt = StringBuilders.buildBaseSystemPrompt({
        userPrompt,
        worldSetting,
      });

      // 8. æ·»åŠ æœç´¢ä»»åŠ¡è¯´æ˜
      systemPrompt += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ æ ¸å¿ƒä»»åŠ¡è¯´æ˜ ğŸ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä½ æ˜¯Xç¤¾äº¤å¹³å°çš„æœç´¢ç»“æœç”Ÿæˆå™¨ã€‚ç”¨æˆ·æœç´¢äº†å…³é”®è¯ï¼š"${query}"

è¿™æ˜¯å…¨å±€æœç´¢ï¼Œéœ€è¦ç”Ÿæˆç¬¦åˆæœç´¢å…³é”®è¯çš„Xå¹³å°å†…å®¹ã€‚

è¯·ç”Ÿæˆä¸æœç´¢å…³é”®è¯ç›¸å…³çš„ç»“æœï¼š
- çƒ­é—¨ï¼š3-8æ¡ä¸å…³é”®è¯é«˜åº¦ç›¸å…³çš„çƒ­é—¨æ¨æ–‡
- æœ€æ–°ï¼š3-5æ¡ä¸å…³é”®è¯ç›¸å…³çš„æœ€æ–°æ¨æ–‡  
- ç”¨æˆ·ï¼š2-6ä¸ªä¸å…³é”®è¯ç›¸å…³çš„Xç”¨æˆ·è´¦å·

ã€é‡è¦éšç§è§„åˆ™ã€‘ï¼š
${
  allowedCharacters.length === 0 && !isUserPublicFigure
    ? `- **ç¦æ­¢å‡ºç°ç»‘å®šç”¨æˆ·/è§’è‰²**ï¼šç”¨æˆ·å’Œè§’è‰²éƒ½ä¸æ˜¯å…¬ä¼—äººç‰©ï¼Œä¸”æœç´¢å…³é”®è¯ä¸ä»–ä»¬æ— å…³
- ç”Ÿæˆçš„æ‰€æœ‰å†…å®¹å¿…é¡»æ˜¯è™šæ„çš„é™Œç”Ÿç”¨æˆ·ï¼Œä¸èƒ½ä½¿ç”¨ä»»ä½•ç»‘å®šè§’è‰²çš„ä¿¡æ¯
- è¿™æ˜¯å…¨å±€æœç´¢ï¼Œåº”è¯¥å±•ç¤ºä¸å…³é”®è¯ç›¸å…³çš„å…¬ä¼—å†…å®¹ï¼Œè€Œéç§äººå…³ç³»`
    : ''
}
${
  isUserPublicFigure && queryLower.includes(userXProfileInfo.name.toLowerCase())
    ? `- **ç”¨æˆ·æ˜¯å…¬ä¼—äººç‰©ä¸”æœç´¢äº†ç”¨æˆ·ç›¸å…³å…³é”®è¯**ï¼šå¯ä»¥ç”Ÿæˆå°‘é‡ä¸ç”¨æˆ·ç›¸å…³çš„å†…å®¹ï¼ˆ1-2æ¡ï¼‰`
    : ''
}
${
  allowedCharacters.length > 0
    ? `- **å…è®¸å‡ºç°ä»¥ä¸‹å…¬ä¼—äººç‰©è§’è‰²**ï¼ˆä»…é™è¿™äº›ï¼‰ï¼š${allowedCharacters.map(c => c.xProfile.xName).join('ã€')}
- åŸå› ï¼šè¿™äº›è§’è‰²æ˜¯å…¬ä¼—äººç‰©ä¸”æœç´¢å…³é”®è¯ä¸ä»–ä»¬ç›¸å…³ï¼Œæˆ–æœç´¢äº†ä»–ä»¬å…¬å¼€çš„çœŸå
- å…¶ä»–æœªåˆ—å‡ºçš„è§’è‰²ä¸¥ç¦å‡ºç°`
    : `- **ç¦æ­¢å‡ºç°ä»»ä½•ç»‘å®šè§’è‰²**ï¼šæ²¡æœ‰è§’è‰²ç¬¦åˆå‡ºç°æ¡ä»¶ï¼ˆéå…¬ä¼—äººç‰©æˆ–æœç´¢å…³é”®è¯ä¸ç›¸å…³ï¼‰`
}

ã€ç”Ÿæˆè¦æ±‚ã€‘ï¼š
- æ‰€æœ‰å†…å®¹å¿…é¡»ä¸æœç´¢å…³é”®è¯"${query}"é«˜åº¦ç›¸å…³
- çƒ­é—¨æ¨æ–‡åº”è¯¥æœ‰è¾ƒé«˜çš„äº’åŠ¨æ•°æ®ï¼ˆç‚¹èµã€è½¬å‘ã€è¯„è®ºï¼‰
- æœ€æ–°æ¨æ–‡æ—¶é—´è¾ƒè¿‘ï¼ˆå‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶å‰ï¼‰
- æ¨æ–‡å†…å®¹è¦å¤šæ ·åŒ–ï¼Œä»ä¸åŒè§’åº¦ä½“ç°æœç´¢å…³é”®è¯
- æ¯æ¡æ¨æ–‡2-5æ¡è¯„è®ºå³å¯
- ç”¨æˆ·è´¦å·è¦æœ‰ç›¸å…³æ€§ï¼ˆç”¨æˆ·åã€ç®€ä»‹ã€æˆ–èº«ä»½ä¸å…³é”®è¯ç›¸å…³ï¼‰
- æ™®é€šç”¨æˆ·å¤´åƒç»Ÿä¸€ï¼šhttps://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg
- è¿™æ˜¯å…¨å±€æœç´¢ï¼Œåº”å±•ç¤ºå¤šæ ·åŒ–çš„é™Œç”Ÿç”¨æˆ·å†…å®¹ï¼Œè€Œéç§äººç¤¾äº¤åœˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;

      // 9. å¦‚æœæœ‰å…è®¸å‡ºç°çš„è§’è‰²ï¼Œæ·»åŠ è§’è‰²èµ„æ–™
      if (allowedCharacters.length > 0) {
        systemPrompt += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ å…è®¸å‡ºç°çš„å…¬ä¼—äººç‰©ä¿¡æ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»¥ä¸‹æ˜¯ç¬¦åˆæœç´¢æ¡ä»¶ã€å¯ä»¥åœ¨ç»“æœä¸­å‡ºç°çš„å…¬ä¼—äººç‰©ï¼š

`;
        for (const { xProfile } of allowedCharacters) {
          systemPrompt += `
ã€${xProfile.xName}ã€‘
- Xå§“åï¼š${xProfile.xName}
- Xå¥æŸ„ï¼š@${xProfile.xHandle}
- Xå¤´åƒï¼š${xProfile.xAvatar}
- è®¤è¯çŠ¶æ€ï¼š${xProfile.xVerified ? 'å·²è®¤è¯' : 'æœªè®¤è¯'}
- å…¬ä¼—èº«ä»½ï¼š${xProfile.publicIdentity || 'æœªè®¾ç½®'}
${xProfile.xBio ? `- Xç®€ä»‹ï¼š${xProfile.xBio}` : ''}
${xProfile.showRealName && xProfile.realName ? `- çœŸå®å§“åï¼š${xProfile.realName}ï¼ˆå·²å…¬å¼€ï¼‰` : ''}

`;
        }

        systemPrompt += `
ã€ä½¿ç”¨è§„åˆ™ã€‘ï¼š
- åªèƒ½ä½¿ç”¨ä¸Šè¿°åˆ—å‡ºçš„å…¬ä¼—äººç‰©ä¿¡æ¯
- å¿…é¡»ä¸¥æ ¼ä½¿ç”¨å…¶Xå§“åã€å¥æŸ„ã€å¤´åƒã€è®¤è¯çŠ¶æ€
- å¦‚æœä»–ä»¬ä¸æœç´¢å…³é”®è¯ç›¸å…³ï¼Œå¯ä»¥ä½œä¸ºæ¨æ–‡å‘å¸ƒè€…æˆ–å‡ºç°åœ¨ç”¨æˆ·åˆ—è¡¨ä¸­
- å…¶ä»–æœªåˆ—å‡ºçš„è§’è‰²ä¸¥ç¦å‡ºç°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;
      }

      // 10. ç”¨æˆ·èµ„æ–™
      systemPrompt += StringBuilders.buildUniversalConstraints(userXProfileInfo);

      // 11. æ·»åŠ æ ¼å¼è¦æ±‚
      systemPrompt += `

ã€JSONè¿”å›æ ¼å¼ã€‘ï¼š
\`\`\`json
{
  "top": [çƒ­é—¨æ¨æ–‡æ•°ç»„(3-5æ¡)],
  "latest": [æœ€æ–°æ¨æ–‡æ•°ç»„(3-5æ¡)],
  "users": [ç”¨æˆ·æ•°ç»„(2-4ä¸ª)]
}
\`\`\`

æ¨æ–‡å¯¹è±¡ç»“æ„ï¼š
- user: {name, handle, avatar, verified}
- content: æ¨æ–‡æ–‡æœ¬ï¼ˆå¿…é¡»ä¸"${query}"ç›¸å…³ï¼‰
- time: æ—¶é—´æè¿°
- stats: {comments, retweets, likes, views} (çº¯æ•°å­—)
- media: [{type:"description", description:"æè¿°", sensitive:false}] (å¯é€‰ï¼Œ30-50%æ¨æ–‡åŒ…å«)
- comments: [è¯„è®ºæ•°ç»„(2-4æ¡)]

ç”¨æˆ·å¯¹è±¡ç»“æ„ï¼š
- name: ç”¨æˆ·å§“å
- handle: ç”¨æˆ·å¥æŸ„ï¼ˆä¸å¸¦@ï¼‰
- avatar: å¤´åƒURL
- verified: å¸ƒå°”å€¼
- bio: ä¸ªäººç®€ä»‹ï¼ˆä½“ç°ä¸"${query}"çš„å…³è”ï¼‰

å…³é”®è§„åˆ™ï¼š
1. æ‰€æœ‰å†…å®¹å¿…é¡»å›´ç»•æœç´¢å…³é”®è¯"${query}"å±•å¼€
2. çƒ­é—¨æ¨æ–‡statsé«˜ï¼ˆ1ä¸‡-50ä¸‡ï¼‰ï¼Œæœ€æ–°æ¨æ–‡statsä½ï¼ˆ100-5åƒï¼‰
3. æœ€æ–°æ¨æ–‡æ—¶é—´è¿‘ï¼ˆåˆšåˆšã€å‡ åˆ†é’Ÿå‰ã€1å°æ—¶å‰ç­‰ï¼‰
4. verifiedå­—æ®µå¿…é¡»æ˜¯å¸ƒå°”å€¼(true/false)
5. statsä¸­æ‰€æœ‰æ•°å­—å¿…é¡»æ˜¯çº¯æ•°å­—${worldSetting.trim() ? '\n6. ä¸¥æ ¼éµå®ˆä¸–ç•Œè§‚è®¾å®š' : ''}
`;

      const messages = [{ role: 'user', content: `è¯·ç”Ÿæˆå…³é”®è¯"${query}"çš„æœç´¢ç»“æœ` }];

      // 12. å‘é€APIè¯·æ±‚
      let isGemini = proxyUrl.includes('generativelanguage');
      let response;

      if (isGemini) {
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
        const apiKeyValue = typeof getRandomValue === 'function' ? getRandomValue(apiKey) : apiKey;
        const geminiConfig = {
          url: `${GEMINI_API_URL}/${model}:generateContent?key=${apiKeyValue}`,
          data: {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: systemPrompt + '\n\n' + messages.map(m => m.content).join('\n'),
                    },
                  ],
                },
              ],
              generationConfig: {
                temperature: 0.8,
              },
            }),
          },
        };
        response = await fetch(geminiConfig.url, geminiConfig.data);
      } else {
        const openAiPayload = {
          model: model,
          messages: [{ role: 'system', content: systemPrompt }, ...messages],
          temperature: 0.8,
          stream: false,
        };
        response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify(openAiPayload),
        });
      }

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`APIé”™è¯¯: ${response.status} - ${errorData.error?.message || response.statusText}`);
      }

      const data = await response.json();
      let aiResponseContent;

      if (isGemini) {
        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
          aiResponseContent = data.candidates[0].content.parts[0].text || '';
        }
      } else {
        aiResponseContent = data.choices?.[0]?.message?.content || '';
      }

      console.log('ğŸ” AIæœç´¢å“åº”:', aiResponseContent);

      // 13. è§£æJSONå“åº”
      const cleanedResponse = aiResponseContent
        .replace(/```json\s*/i, '')
        .replace(/```\s*$/, '')
        .trim();

      if (!cleanedResponse) {
        throw new Error('AIè¿”å›äº†ç©ºçš„å“åº”å†…å®¹');
      }

      let searchResults;
      try {
        searchResults = JSON.parse(cleanedResponse);
      } catch (parseError) {
        console.error('JSONè§£æå¤±è´¥:', parseError);
        console.error('å°è¯•è§£æçš„å†…å®¹:', cleanedResponse.substring(0, 500) + '...');
        throw new Error(`AIè¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼: ${parseError.message}`);
      }

      // 14. éªŒè¯æ•°æ®æ ¼å¼
      if (!searchResults.top || !searchResults.latest || !searchResults.users) {
        throw new Error('AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘å¿…è¦å­—æ®µ');
      }

      // 15. ä¸ºæ¨æ–‡æ·»åŠ å”¯ä¸€ID
      const timestamp = Date.now();

      searchResults.top = searchResults.top.map((tweet, index) => ({
        ...tweet,
        id: `search_top_${timestamp}_${index}`,
        comments:
          tweet.comments?.map((comment, cIndex) => ({
            ...comment,
            id: `search_top_${timestamp}_${index}_c${cIndex}`,
          })) || [],
      }));

      searchResults.latest = searchResults.latest.map((tweet, index) => ({
        ...tweet,
        id: `search_latest_${timestamp}_${index}`,
        comments:
          tweet.comments?.map((comment, cIndex) => ({
            ...comment,
            id: `search_latest_${timestamp}_${index}_c${cIndex}`,
          })) || [],
      }));

      // 16. æ›´æ–°æœç´¢ç»“æœæ•°æ®
      searchResultsData.top = searchResults.top;
      searchResultsData.latest = searchResults.latest;
      searchResultsData.users = searchResults.users;

      // 17. ä¿å­˜åˆ°æ•°æ®åº“
      try {
        await xDb.xTweetsData.put({
          id: `search_${query}`,
          query: query,
          results: searchResults,
          timestamp: new Date().toISOString(),
        });
        console.log('âœ… æœç´¢ç»“æœå·²ä¿å­˜åˆ°æ•°æ®åº“');
      } catch (saveError) {
        console.error('âš ï¸ ä¿å­˜æœç´¢ç»“æœå¤±è´¥:', saveError);
      }

      // 18. æ¸²æŸ“æœç´¢ç»“æœ
      renderSearchResults();

      showXToast(`æ‰¾åˆ° ${searchResults.top.length + searchResults.latest.length} æ¡ç›¸å…³æ¨æ–‡`, 'success');
    } catch (error) {
      console.error('âŒ æœç´¢å¤±è´¥:', error);
      showXToast(`æœç´¢å¤±è´¥: ${error.message}`, 'error');

      // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
      const container = document.getElementById('search-results-content');
      container.innerHTML = `
        <div style="
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 60px 20px;
          color: #f4212e;
        ">
          <svg viewBox="0 0 24 24" style="width: 80px; height: 80px; fill: #f4212e; margin-bottom: 20px;">
            <g><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path></g>
          </svg>
          <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">æœç´¢å‡ºé”™</div>
          <div style="font-size: 14px; color: #71767b;">${error.message}</div>
        </div>
      `;
    }
  }

  // è¿”å›çƒ­æœè§†å›¾
  function backToTrending() {
    document.getElementById('search-results-view').style.display = 'none';
    document.getElementById('trending-view').style.display = 'flex';

    // éšè—è¿”å›æŒ‰é’®ï¼Œæ˜¾ç¤ºåˆ·æ–°æŒ‰é’®
    const backBtn = document.getElementById('search-back-btn');
    if (backBtn) backBtn.style.display = 'none';

    const refreshBtn = document.querySelector('.refresh-trends-btn');
    if (refreshBtn) refreshBtn.style.display = 'flex';

    // æ¸…ç©ºæœç´¢æ¡†
    const input = document.getElementById('search-input');
    if (input) {
      input.value = '';
      toggleSearchButton();
    }

    currentSearchQuery = '';
  }

  // æ‰“å¼€è‡ªå®šä¹‰åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡†
  async function openAddCategoryModal() {
    const modal = document.getElementById('category-manager-modal');
    if (modal) {
      modal.style.display = 'flex';

      // åŠ è½½è‡ªå®šä¹‰åˆ†ç±»æ•°æ®
      await loadCustomCategories();

      // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
      renderCustomCategoriesList();
    }
  }

  // å…³é—­åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡†
  function closeCategoryModal(event) {
    if (event && event.target !== event.currentTarget) return;

    const modal = document.getElementById('category-manager-modal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  // åŠ è½½è‡ªå®šä¹‰åˆ†ç±»
  async function loadCustomCategories() {
    try {
      const xDb = getXDB();
      const accountId = currentAccountId || 'main';
      const settingsId = `customCategories_${accountId}`;

      const savedData = await xDb.xTweetsData.get(settingsId);
      if (savedData && savedData.categories) {
        customCategories = savedData.categories;
        console.log('âœ… å·²åŠ è½½è‡ªå®šä¹‰åˆ†ç±»:', customCategories.length, 'ä¸ª');
      } else {
        customCategories = [];
      }
    } catch (error) {
      console.error('âš ï¸ åŠ è½½è‡ªå®šä¹‰åˆ†ç±»å¤±è´¥:', error);
      customCategories = [];
    }
  }

  // ä¿å­˜è‡ªå®šä¹‰åˆ†ç±»
  async function saveCustomCategories() {
    try {
      const xDb = getXDB();
      const accountId = currentAccountId || 'main';
      const settingsId = `customCategories_${accountId}`;

      await xDb.xTweetsData.put({
        id: settingsId,
        categories: customCategories,
        lastUpdated: new Date().toISOString(),
      });

      console.log('âœ… è‡ªå®šä¹‰åˆ†ç±»å·²ä¿å­˜');
      showXToast('åˆ†ç±»è®¾ç½®å·²ä¿å­˜', 'success');

      // æ›´æ–°æ ‡ç­¾æ æ˜¾ç¤º
      updateSearchTabs();

      // å…³é—­æ¨¡æ€æ¡†
      closeCategoryModal();
    } catch (error) {
      console.error('âŒ ä¿å­˜è‡ªå®šä¹‰åˆ†ç±»å¤±è´¥:', error);
      showXToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
  }

  // æ¸²æŸ“è‡ªå®šä¹‰åˆ†ç±»åˆ—è¡¨
  function renderCustomCategoriesList() {
    const container = document.getElementById('custom-categories-list');
    if (!container) return;

    if (customCategories.length === 0) {
      container.innerHTML = `
        <div style="
          text-align: center;
          padding: 40px 20px;
          color: #71767b;
          font-size: 14px;
        ">
          è¿˜æ²¡æœ‰è‡ªå®šä¹‰åˆ†ç±»ï¼Œç‚¹å‡»"æ·»åŠ åˆ†ç±»"æŒ‰é’®åˆ›å»º
        </div>
      `;
      return;
    }

    container.innerHTML = customCategories
      .map(
        (category, index) => `
      <div style="
        background-color: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 16px;
      ">
        <div style="display: flex; align-items: flex-start; gap: 12px;">
          <!-- å¯ç”¨å¼€å…³ -->
          <label style="
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-top: 4px;
          ">
            <input 
              type="checkbox" 
              ${category.enabled ? 'checked' : ''} 
              onchange="toggleCategory(${index})"
              style="
                width: 18px;
                height: 18px;
                accent-color: #1d9bf0;
                cursor: pointer;
              ">
          </label>

          <!-- åˆ†ç±»å†…å®¹ -->
          <div style="flex: 1; min-width: 0;">
            <!-- åˆ†ç±»åç§° -->
            <div style="margin-bottom: 12px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                margin-bottom: 4px;
              ">åˆ†ç±»åç§° *</label>
              <input 
                type="text" 
                value="${category.name || ''}" 
                placeholder="ä¾‹å¦‚ï¼šåŠ¨æ¼«"
                onchange="updateCategoryName(${index}, this.value)"
                style="
                  width: 100%;
                  background-color: #000;
                  border: 1px solid #333;
                  border-radius: 4px;
                  color: #fff;
                  padding: 8px 12px;
                  font-size: 15px;
                  outline: none;
                " 
                onfocus="this.style.borderColor='#1d9bf0'" 
                onblur="this.style.borderColor='#333'">
            </div>

            <!-- åˆ†ç±»æè¿° -->
            <div style="margin-bottom: 12px;">
              <label style="
                display: block;
                color: #8b98a5;
                font-size: 13px;
                margin-bottom: 4px;
              ">åˆ†ç±»å†…å®¹/ç±»å‹ï¼ˆå¯é€‰ï¼‰</label>
              <textarea 
                placeholder="ä¾‹å¦‚ï¼šåŠ¨ç”»ã€æ¼«ç”»ã€å£°ä¼˜ã€ç•ªå‰§ç›¸å…³å†…å®¹"
                onchange="updateCategoryDescription(${index}, this.value)"
                style="
                  width: 100%;
                  min-height: 60px;
                  background-color: #000;
                  border: 1px solid #333;
                  border-radius: 4px;
                  color: #fff;
                  padding: 8px 12px;
                  font-size: 14px;
                  resize: vertical;
                  outline: none;
                  font-family: inherit;
                " 
                onfocus="this.style.borderColor='#1d9bf0'" 
                onblur="this.style.borderColor='#333'">${category.description || ''}</textarea>
            </div>

            <!-- çŠ¶æ€æç¤º -->
            <div style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              color: ${category.enabled ? '#1d9bf0' : '#71767b'};
              font-size: 12px;
            ">
              <span>${category.enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨'}</span>
              <button 
                onclick="deleteCategory(${index})"
                style="
                  background: transparent;
                  color: #f4212e;
                  border: 1px solid #f4212e;
                  border-radius: 16px;
                  padding: 4px 12px;
                  font-size: 12px;
                  cursor: pointer;
                  transition: all 0.2s;
                "
                onmouseover="this.style.backgroundColor='rgba(244,33,46,0.1)'"
                onmouseout="this.style.backgroundColor='transparent'">
                åˆ é™¤
              </button>
            </div>
          </div>
        </div>
      </div>
    `,
      )
      .join('');
  }

  // æ·»åŠ æ–°åˆ†ç±»
  function addNewCategory() {
    customCategories.push({
      id: `custom_${Date.now()}`,
      name: '',
      description: '',
      enabled: true,
    });

    renderCustomCategoriesList();
  }

  // åˆ é™¤åˆ†ç±»
  function deleteCategory(index) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿ')) {
      customCategories.splice(index, 1);
      renderCustomCategoriesList();
    }
  }

  // åˆ‡æ¢åˆ†ç±»å¯ç”¨çŠ¶æ€
  function toggleCategory(index) {
    if (customCategories[index]) {
      customCategories[index].enabled = !customCategories[index].enabled;
      renderCustomCategoriesList();
    }
  }

  // æ›´æ–°åˆ†ç±»åç§°
  function updateCategoryName(index, name) {
    if (customCategories[index]) {
      customCategories[index].name = name.trim();
    }
  }

  // æ›´æ–°åˆ†ç±»æè¿°
  function updateCategoryDescription(index, description) {
    if (customCategories[index]) {
      customCategories[index].description = description.trim();
    }
  }

  // æ›´æ–°æœç´¢æ ‡ç­¾æ 
  function updateSearchTabs() {
    const tabsContainer = document.querySelector('.search-tabs');
    if (!tabsContainer) return;

    // æ¸…ç©ºç°æœ‰æ ‡ç­¾ï¼ˆä¿ç•™+å·æŒ‰é’®ï¼‰
    const addBtn = tabsContainer.querySelector('.add-category-btn');
    tabsContainer.innerHTML = '';

    // æ·»åŠ é»˜è®¤æ ‡ç­¾
    const recommendedTab = document.createElement('div');
    recommendedTab.className = 'search-tab' + (currentSearchTab === 'recommended' ? ' active' : '');
    recommendedTab.textContent = 'ä¸ºä½ æ¨è';
    recommendedTab.onclick = () => switchSearchTab('recommended');
    tabsContainer.appendChild(recommendedTab);

    const trendingTab = document.createElement('div');
    trendingTab.className = 'search-tab' + (currentSearchTab === 'trending' ? ' active' : '');
    trendingTab.textContent = 'å½“å‰è¶‹åŠ¿';
    trendingTab.onclick = () => switchSearchTab('trending');
    tabsContainer.appendChild(trendingTab);

    // æ·»åŠ å¯ç”¨çš„è‡ªå®šä¹‰åˆ†ç±»æ ‡ç­¾
    customCategories
      .filter(cat => cat.enabled && cat.name)
      .forEach(category => {
        const customTab = document.createElement('div');
        customTab.className = 'search-tab' + (currentSearchTab === category.id ? ' active' : '');
        customTab.textContent = category.name;
        customTab.onclick = () => switchSearchTab(category.id);
        tabsContainer.appendChild(customTab);
      });

    // é‡æ–°æ·»åŠ +å·æŒ‰é’®
    if (addBtn) {
      tabsContainer.appendChild(addBtn);
    }
  }

  // åˆå§‹åŒ–æœç´¢é¡µé¢
  async function initSearchPage() {
    // åŠ è½½è‡ªå®šä¹‰åˆ†ç±»
    await loadCustomCategories();

    // æ›´æ–°æ ‡ç­¾æ 
    updateSearchTabs();

    // ç¡®ä¿æ˜¾ç¤ºçƒ­æœè§†å›¾ï¼Œéšè—æœç´¢ç»“æœè§†å›¾
    document.getElementById('trending-view').style.display = 'flex';
    document.getElementById('search-results-view').style.display = 'none';

    // æ˜¾ç¤ºåˆ·æ–°æŒ‰é’®ï¼Œéšè—è¿”å›æŒ‰é’®
    const refreshBtn = document.querySelector('.refresh-trends-btn');
    if (refreshBtn) refreshBtn.style.display = 'flex';

    const backBtn = document.getElementById('search-back-btn');
    if (backBtn) backBtn.style.display = 'none';

    // å°è¯•ä»æ•°æ®åº“åŠ è½½çƒ­æœæ•°æ®
    try {
      const xDb = getXDB();
      const savedTrends = await xDb.xTweetsData.get('trends');

      if (savedTrends) {
        // åŠ è½½é»˜è®¤åˆ†ç±»æ•°æ®
        if (savedTrends.recommended && savedTrends.trending) {
          trendingData.recommended = savedTrends.recommended;
          trendingData.trending = savedTrends.trending;
        }

        // åŠ è½½è‡ªå®šä¹‰åˆ†ç±»æ•°æ®
        customCategories.forEach(category => {
          if (savedTrends[category.id]) {
            trendingData[category.id] = savedTrends[category.id];
          }
        });

        console.log('âœ… å·²ä»æ•°æ®åº“åŠ è½½çƒ­æœæ•°æ®');
      }
    } catch (error) {
      console.log('âš ï¸ åŠ è½½çƒ­æœæ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', error);
    }

    // æ¸²æŸ“çƒ­æœåˆ—è¡¨
    renderTrendingList();
  }

  // â–¼â–¼â–¼ ï¼ï¼ï¼ä¸‰ä¸ªæƒ…æ™¯ç»¼åˆå¦‚ä¸‹ï¼ï¼ï¼â–¼â–¼â–¼
  // "ä¸ºä½ æ¨è"é¡µé¢çš„æµ‹è¯•æ¨æ–‡æ•°æ®ï¼ˆç¤ºèŒƒç”¨ï¼‰
  const forYouTweets = [
    {
      id: '1',
      user: {
        name: 'çƒ­é—¨æ¨èç”¨æˆ·',
        handle: '@trending_user',
        avatar: 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
        verified: true,
      },
      content: 'ğŸ”¥ ä»Šæ—¥çƒ­é—¨è¯é¢˜ï¼å¤§å®¶éƒ½åœ¨è®¨è®ºçš„æ–°æŠ€æœ¯è¶‹åŠ¿ #AI #ç§‘æŠ€ #æœªæ¥',
      time: '3å°æ—¶',
      media: [],
      stats: {
        comments: 567,
        retweets: 1200,
        likes: 5600,
        views: 89000,
      },
      comments: [
        {
          id: 'c1-1',
          user: {
            name: 'ç§‘æŠ€è¾¾äºº',
            handle: '@tech_expert',
            avatar: 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
            verified: true,
          },
          content: 'ç¡®å®ï¼ŒAIæŠ€æœ¯å‘å±•å¤ªå¿«äº†ï¼Œæ¯å¤©éƒ½æœ‰æ–°çªç ´',
          time: '2å°æ—¶',
          replies: [
            {
              id: 'c1-1-1',
              user: {
                name: 'å­¦ç”Ÿå°ç‹',
                handle: '@student_wang',
                avatar: 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
                verified: false,
              },
              content: 'è¯·é—®æœ‰ä»€ä¹ˆæ¨èçš„å­¦ä¹ èµ„æºå—ï¼Ÿ',
              time: '1å°æ—¶',
              replyTo: '@tech_expert',
            },
          ],
        },
      ],
    },
  ];

  // "æ­£åœ¨å…³æ³¨"é¡µé¢çš„æµ‹è¯•æ¨æ–‡æ•°æ®ï¼ˆç¤ºèŒƒç”¨ï¼‰
  const followingTweets = [
    {
      id: '2',
      user: {
        name: 'æˆ‘çš„æœ‹å‹',
        handle: '@my_friend',
        avatar: 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
        verified: false,
      },
      content: 'ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼Œå’Œæœ‹å‹ä»¬ä¸€èµ·å‡ºå»ç©äº†ï¼ğŸ˜Š #ç¾å¥½æ—¶å…‰',
      time: '30åˆ†é’Ÿ',
      media: [
        {
          type: 'image',
          description: 'é˜³å…‰æ˜åªšçš„å…¬å›­é‡Œï¼Œå‡ ä¸ªæœ‹å‹åœ¨è‰åœ°ä¸Šé‡é¤çš„æ¸©é¦¨åœºæ™¯',
          sensitive: false,
        },
      ],
      stats: {
        comments: 8,
        retweets: 2,
        likes: 24,
        views: 156,
      },
      comments: [
        {
          id: 'c2-1',
          user: {
            name: 'å¥½å‹A',
            handle: '@friend_a',
            avatar: 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
            verified: false,
          },
          content: 'çœ‹èµ·æ¥å¾ˆæ£’ï¼ä¸‹æ¬¡å«ä¸Šæˆ‘ ğŸ˜Š',
          time: '25åˆ†é’Ÿ',
          replies: [],
        },
      ],
    },
    {
      id: '3',
      user: {
        name: 'æ•°ç è¾¾äºº',
        handle: '@digital_expert',
        avatar: 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
        verified: true,
      },
      content: 'å®Œå…¨åŒæ„è¿™ä¸ªè§‚ç‚¹ï¼AIç¡®å®æ­£åœ¨æ”¹å˜æˆ‘ä»¬çš„ç”Ÿæ´»æ–¹å¼ï¼Œæ¯ä¸ªäººéƒ½åº”è¯¥å­¦ä¼šæ‹¥æŠ±è¿™ç§å˜åŒ– ğŸ¤–âœ¨',
      time: '45åˆ†é’Ÿ',
      media: [],
      quotedTweet: {
        type: 'tweet',
        user: {
          name: 'ç§‘æŠ€å‰æ²¿',
          handle: '@tech_frontier',
          avatar: 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
          verified: true,
        },
        content: 'AIæŠ€æœ¯çš„å¿«é€Ÿå‘å±•æ­£åœ¨é‡å¡‘å„è¡Œå„ä¸šï¼Œä»è‡ªåŠ¨é©¾é©¶åˆ°æ™ºèƒ½åŠ©æ‰‹ï¼Œæˆ‘ä»¬æ­£ç”Ÿæ´»åœ¨ä¸€ä¸ªç§‘æŠ€é©å‘½çš„æ—¶ä»£ #AI #æœªæ¥ç§‘æŠ€',
        time: '2å°æ—¶',
      },
      stats: {
        comments: 15,
        retweets: 32,
        likes: 89,
        views: 1250,
      },
      comments: [
        {
          id: 'c3-1',
          user: {
            name: 'ç§‘æŠ€çˆ±å¥½è€…',
            handle: '@tech_lover',
            avatar: 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
            verified: false,
          },
          content: 'æ˜¯çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨å·¥ä½œæ•ˆç‡æå‡æ–¹é¢ï¼ŒAIå·¥å…·å¸®åŠ©å¾ˆå¤§',
          time: '40åˆ†é’Ÿ',
          replies: [],
        },
      ],
    },
  ];

  // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º
  function formatNumber(num) {
    if (num >= 1000000) {
      return (num / 1000000).toFixed(1) + 'ä¸‡';
    } else if (num >= 10000) {
      return (num / 10000).toFixed(1) + 'ä¸‡';
    } else if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
  }

  // å¤„ç†æ¨æ–‡å†…å®¹ï¼Œä¸ºè¯é¢˜æ ‡ç­¾å’ŒæåŠæ·»åŠ é«˜äº®
  function processContent(content) {
    if (!content) return '';

    // å¤„ç†è¯é¢˜æ ‡ç­¾ (#hashtag)
    content = content.replace(/#([^\s#@]+)/g, '<span class="hashtag">#$1</span>');

    // å¤„ç†æåŠ (@mention)
    content = content.replace(/@([^\s#@]+)/g, '<span class="mention">@$1</span>');

    return content;
  }

  // æ¸…ç†è¯„è®ºå†…å®¹ä¸­çš„é‡å¤å›å¤æ–‡æœ¬
  function cleanReplyContent(content, replyTo) {
    if (!content) return '';

    // å¦‚æœæœ‰replyToï¼Œç§»é™¤è¯„è®ºå†…å®¹å¼€å¤´çš„"å›å¤@xxx:"æ ¼å¼
    if (replyTo) {
      // ç§»é™¤å¼€å¤´çš„"å›å¤@ç”¨æˆ·å:"æˆ–"å›å¤ @ç”¨æˆ·å:"
      content = content.replace(/^å›å¤\s*@[^\s:ï¼š]+[ï¼š:]\s*/, '');
      // ç§»é™¤å¼€å¤´ç›´æ¥çš„"@ç”¨æˆ·å"æ ¼å¼ï¼ˆå¦‚æœè·ŸreplyToé‡å¤ï¼‰
      const replyHandle = replyTo.replace('@', '');
      content = content.replace(new RegExp(`^@${replyHandle}\\s*[ï¼š:]?\\s*`, 'i'), '');
      // ç§»é™¤å†…å®¹ä¸­ä»»ä½•ä¸replyToé‡å¤çš„@æåŠ
      content = content.replace(new RegExp(`@${replyHandle}(?=\\s|$|[^\\w])`, 'gi'), '');
    }

    return content;
  }

  // åˆ›å»ºæ¨æ–‡å…ƒç´ 
  function createTweetElement(tweet) {
    const tweetEl = document.createElement('div');
    tweetEl.className = 'tweet-item';
    tweetEl.dataset.tweetId = tweet.id;

    tweetEl.innerHTML = `
              <img class="tweet-avatar" src="${tweet.user.avatar}" alt="${tweet.user.name}">
              <div class="tweet-main">
                <div class="tweet-user-info">
                  <span class="tweet-user-name">${tweet.user.name}</span>
                  ${
                    tweet.user.verified
                      ? '<svg class="tweet-verified" viewBox="0 0 24 24"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>'
                      : ''
                  }
                  <span class="tweet-user-handle">${tweet.user.handle}</span>
                  <span class="tweet-time">Â·${tweet.time}</span>
                  <div class="tweet-more">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></g>
                    </svg>
                  </div>
                </div>
                ${tweet.content ? `<div class="tweet-content">${processContent(tweet.content)}</div>` : ''}
                ${
                  tweet.quotedTweet
                    ? `
                  <div class="quoted-tweet" onclick="handleQuotedTweetClick('${tweet.quotedTweet.user.handle}')">
                    <div class="quote-indicator">
                      <svg viewBox="0 0 24 24">
                        <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>
                      </svg>
                      ${tweet.quotedTweet.type === 'comment' ? 'å¼•ç”¨è¯„è®º' : 'å¼•ç”¨æ¨æ–‡'}
                    </div>
                    <div class="quoted-user-info">
                      <img class="quoted-user-avatar" src="${tweet.quotedTweet.user.avatar}" alt="${
                        tweet.quotedTweet.user.name
                      }">
                      <span class="quoted-user-name">${tweet.quotedTweet.user.name}</span>
                      ${
                        tweet.quotedTweet.user.verified
                          ? '<svg class="tweet-verified" style="width: 14px; height: 14px;" viewBox="0 0 24 24"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>'
                          : ''
                      }
                      <span class="quoted-user-handle">${tweet.quotedTweet.user.handle}</span>
                      <span class="quoted-user-time">Â·${tweet.quotedTweet.time}</span>
                    </div>
                    <div class="quoted-content">${processContent(tweet.quotedTweet.content)}</div>
                    ${
                      tweet.quotedTweet.image
                        ? `
                      <div class="quoted-media" style="margin-top: 8px;">
                        ${
                          tweet.quotedTweet.image.type === 'description'
                            ? `
                          <div style="background-color: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 8px; padding: 8px;">
                            <div style="color: #fff; font-size: 12px; line-height: 1.4;">${tweet.quotedTweet.image.content}</div>
                          </div>
                        `
                            : ''
                        }
                        ${
                          tweet.quotedTweet.image.type === 'upload'
                            ? `
                          <div style="border-radius: 8px; overflow: hidden;">
                            <img src="${tweet.quotedTweet.image.content}" style="width: 100%; max-height: 100px; object-fit: cover; display: block;" alt="å¼•ç”¨å›¾ç‰‡">
                          </div>
                        `
                            : ''
                        }
                      </div>
                    `
                        : ''
                    }
                  </div>
                `
                    : ''
                }
                ${
                  tweet.media && tweet.media.length > 0
                    ? `
                  <div class="tweet-media">
                    <div style="width: 100%; height: 200px; background-color: #333; border-radius: 16px; display: flex; align-items: center; justify-content: center; color: #71767b; position: relative;" id="media-${
                      tweet.id
                    }">
                      ${
                        tweet.media[0].sensitive
                          ? `
                        <div class="sensitive-overlay" onclick="showSensitiveContent('${tweet.id}')">
                          <div class="sensitive-text">æ•æ„Ÿå†…å®¹</div>
                          <div class="sensitive-description">æ­¤æ¨æ–‡å¯èƒ½åŒ…å«æ•æ„Ÿå†…å®¹</div>
                        </div>
                      `
                          : ''
                      }
                      <div style="text-align: center; padding: 20px; ${
                        tweet.media[0].sensitive ? 'filter: blur(20px);' : ''
                      }" id="content-${tweet.id}">
                        <div style="font-size: 14px;">${tweet.media[0].description}</div>
                      </div>
                    </div>
                  </div>
                `
                    : ''
                }
                <div class="tweet-actions">
                  <div class="tweet-action comment" onclick="showTweetComments('${tweet.id}')">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g>
                    </svg>
                    <span>${formatNumber(tweet.stats.comments)}</span>
                  </div>
                  <div class="tweet-action retweet" onclick="handleQuoteRetweetFromData('tweet', '${tweet.id}')">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>
                    </svg>
                    <span>${DataUtils.formatNumber(tweet.stats.retweets)}</span>
                  </div>
                  <div class="tweet-action like" onclick="toggleLike('${
                    tweet.id
                  }', this)" data-liked="false" data-likes="${tweet.stats.likes}">
                    <svg class="action-icon like-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>
                    </svg>
                    <span class="like-count">${DataUtils.formatNumber(tweet.stats.likes)}</span>
                  </div>
                  <div class="tweet-action view">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10H6v10H4zm9.248 0v-7h2v7h-2z"></path></g>
                    </svg>
                    <span>${DataUtils.formatNumber(tweet.stats.views)}</span>
                  </div>
                  <div class="tweet-action bookmark">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z"></path></g>
                    </svg>
                  </div>
                  <div class="tweet-action share">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.29 3.3-1.42-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"></path></g>
                    </svg>
                  </div>
                </div>
              </div>
            `;

    return tweetEl;
  }

  // å¤„ç†å¼•ç”¨æ¨æ–‡ç‚¹å‡»
  function handleQuotedTweetClick(userHandle) {
    showXToast(`ç‚¹å‡»äº†å¼•ç”¨çš„ ${userHandle} çš„å†…å®¹`, 'info');
  }

  // æ¸²æŸ“æ¨æ–‡åˆ°å®¹å™¨
  function renderTweets(tweets, containerId) {
    const container = document.querySelector(`#${containerId} .tweets-container`);
    container.innerHTML = '';

    tweets.forEach(tweet => {
      const tweetElement = createTweetElement(tweet);
      container.appendChild(tweetElement);

      // ä¸ºæ¨æ–‡ä½œè€…å¤´åƒæ·»åŠ ç‚¹å‡»äº‹ä»¶
      const avatar = tweetElement.querySelector('.tweet-avatar');
      if (avatar) {
        avatar.style.cursor = 'pointer';
        avatar.addEventListener('click', e => {
          e.stopPropagation();
          openAccountProfile(tweet.user.name, tweet.user.handle, tweet.user.avatar);
        });
      }

      // ä¸ºå¼•ç”¨æ¨æ–‡ä¸­çš„å¤´åƒæ·»åŠ ç‚¹å‡»äº‹ä»¶
      const quotedAvatar = tweetElement.querySelector('.quoted-user-avatar');
      if (quotedAvatar && tweet.quotedTweet) {
        quotedAvatar.style.cursor = 'pointer';
        quotedAvatar.addEventListener('click', e => {
          e.stopPropagation();
          openAccountProfile(tweet.quotedTweet.user.name, tweet.quotedTweet.user.handle, tweet.quotedTweet.user.avatar);
        });
      }
    });
  }

  // åˆå§‹åŒ–æ¨æ–‡æ•°æ®
  async function initializeTweets() {
    try {
      // å°è¯•ä»æ•°æ®åº“åŠ è½½ä¿å­˜çš„æ¨æ–‡æ•°æ®
      const db = getXDB();

      const savedData = await db.xTweetsData.get('tweets');

      if (savedData && savedData.forYouTweets && savedData.followingTweets) {
        // ä½¿ç”¨ä¿å­˜çš„æ•°æ®
        forYouTweets.length = 0;
        followingTweets.length = 0;
        forYouTweets.push(...savedData.forYouTweets);
        followingTweets.push(...savedData.followingTweets);

        console.log('å·²åŠ è½½ä¿å­˜çš„æ¨æ–‡æ•°æ®ï¼Œæœ€åæ›´æ–°æ—¶é—´:', savedData.lastUpdated);
      }
    } catch (error) {
      console.error('åŠ è½½æ¨æ–‡æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', error);
    }

    // æ¸²æŸ“æ¨æ–‡
    renderTweets(forYouTweets, 'for-you-content');
    renderTweets(followingTweets, 'following-content');
  }

  // æ˜¾ç¤ºæ•æ„Ÿå†…å®¹
  function showSensitiveContent(tweetId) {
    const overlay = document.querySelector(`#media-${tweetId} .sensitive-overlay`);
    const content = document.getElementById(`content-${tweetId}`);

    if (overlay) {
      overlay.style.display = 'none';
    }
    if (content) {
      content.style.filter = 'none';
    }
  }

  // ç‚¹èµåŠŸèƒ½
  function toggleLike(tweetId, element) {
    const isLiked = element.dataset.liked === 'true';
    const currentLikes = parseInt(element.dataset.likes);
    const likeIcon = element.querySelector('.like-icon');
    const likeCount = element.querySelector('.like-count');

    if (isLiked) {
      // å–æ¶ˆç‚¹èµ
      element.dataset.liked = 'false';
      element.dataset.likes = (currentLikes - 1).toString();
      element.classList.remove('liked');
      likeCount.textContent = DataUtils.formatNumber(currentLikes - 1);
    } else {
      // ç‚¹èµ
      element.dataset.liked = 'true';
      element.dataset.likes = (currentLikes + 1).toString();
      element.classList.add('liked');
      likeCount.textContent = DataUtils.formatNumber(currentLikes + 1);

      // æ·»åŠ åŠ¨ç”»æ•ˆæœ
      likeIcon.classList.add('like-animation');
      setTimeout(() => {
        likeIcon.classList.remove('like-animation');
      }, 600);
    }
  }

  // ç”Ÿæˆéšæœºç‚¹èµæ•°
  function generateRandomLikes() {
    return Math.floor(Math.random() * 50) + 1;
  }

  // åˆ›å»ºè¯„è®ºå…ƒç´ 
  function createCommentElement(comment, isReply = false) {
    const commentEl = document.createElement('div');
    commentEl.className = isReply ? 'comment-item reply-item' : 'comment-item';
    commentEl.dataset.commentId = comment.id;

    const randomLikes = generateRandomLikes();
    const randomComments = Math.floor(Math.random() * 10) + 1;
    const randomRetweets = Math.floor(Math.random() * 5) + 1;
    const randomViews = Math.floor(Math.random() * 1000) + 50;

    commentEl.innerHTML = `
              <img class="tweet-avatar" src="${comment.user.avatar}" alt="${comment.user.name}">
              <div class="comment-main">
                <div class="comment-user-info">
                  <span class="tweet-user-name">${comment.user.name}</span>
                  ${
                    comment.user.verified
                      ? '<svg class="tweet-verified" viewBox="0 0 24 24"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>'
                      : ''
                  }
                  <span class="tweet-user-handle">${comment.user.handle}</span>
                  <span class="tweet-time">Â·${comment.time}</span>
                  ${
                    comment.user.handle === userProfileData.handle
                      ? `
                  <div class="comment-delete-btn" onclick="deleteUserComment('${comment.id}')" style="margin-left: auto; cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(239, 68, 68, 0.1)'" onmouseout="this.style.backgroundColor='transparent'" title="åˆ é™¤è¯„è®º">
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #ef4444;">
                      <g><path d="M16 6V4.5C16 3.12 14.88 2 13.5 2h-3C9.11 2 8 3.12 8 4.5V6H3v2h2v10c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V8h2V6h-5zM10 4.5c0-.28.22-.5.5-.5h3c.28 0 .5.22.5.5V6h-4V4.5zM19 8H5v10h14V8z"></path></g>
                    </svg>
                  </div>
                  `
                      : ''
                  }
                </div>
                <div class="comment-content">
                  ${comment.replyTo ? `<span class="reply-to">${comment.replyTo}</span>` : ''}
                  ${processContent(cleanReplyContent(comment.content, comment.replyTo))}
                  ${
                    comment.image
                      ? comment.image.type === 'description'
                        ? `<div style="margin-top: 8px; background-color: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 8px; padding: 8px;">
                            <div style="color: #fff; font-size: 13px; line-height: 1.4;">${comment.image.content}</div>
                          </div>`
                        : `<div style="margin-top: 8px; border-radius: 12px; overflow: hidden; max-width: 300px;">
                            <img src="${comment.image.content}" style="width: 100%; max-height: 280px; object-fit: cover; display: block;" alt="è¯„è®ºå›¾ç‰‡">
                          </div>`
                      : ''
                  }
                </div>
                <div class="comment-actions">
                  <div class="comment-action reply-action" onclick="showReplyInput('${comment.id}', '${
      comment.user.handle
    }')">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g>
                    </svg>
                    <span>${randomComments}</span>
                  </div>
                  <div class="comment-action" onclick="handleQuoteRetweetFromData('comment', '${comment.id}')">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>
                    </svg>
                    <span>${randomRetweets}</span>
                  </div>
                  <div class="comment-action like" onclick="toggleCommentLike('${
                    comment.id
                  }', this)" data-liked="false" data-likes="${randomLikes}">
                    <svg class="action-icon like-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>
                    </svg>
                    <span class="like-count">${randomLikes}</span>
                  </div>
                  <div class="comment-action">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10H6v10H4zm9.248 0v-7h2v7h-2z"></path></g>
                    </svg>
                    <span>${formatNumber(randomViews)}</span>
                  </div>
                </div>
                <!-- å›å¤è¾“å…¥æ¡†å®¹å™¨ -->
                <div id="reply-input-${
                  comment.id
                }" class="reply-input-container" style="display: none; margin-top: 12px; padding-left: 48px;">
                  <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <img src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="Your avatar" style="width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;" class="reply-user-avatar">
                    <div style="flex: 1;">
                      <textarea placeholder="å‘å¸ƒä½ çš„å›å¤" style="width: 100%; min-height: 20px; max-height: 80px; background: transparent; border: none; color: #fff; font-size: 15px; resize: none; outline: none; font-family: inherit; line-height: 1.3; border-bottom: 1px solid #333; padding-bottom: 8px;" oninput="autoResizeReply(this, '${
                        comment.id
                      }')" onkeydown="handleReplyInput(event, '${comment.id}', '${comment.user.handle}')"></textarea>
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                        <div style="display: flex; gap: 12px;">
                          <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #1d9bf0; cursor: pointer;">
                            <g><path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z"></path></g>
                          </svg>
                          <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #1d9bf0; cursor: pointer;">
                            <g><path d="M8 9.5C8 8.119 8.672 7 9.5 7S11 8.119 11 9.5 10.328 12 9.5 12 8 10.881 8 9.5zm6.5 2.5c.828 0 1.5-1.119 1.5-2.5S15.328 7 14.5 7 13 8.119 13 9.5s.672 2.5 1.5 2.5zM12 16c-2.224 0-3.021-2.227-3.051-2.316l-1.897.633c.05.15 1.271 3.684 4.949 3.684s4.898-3.533 4.949-3.684l-1.896-.638c-.033.095-.83 2.322-3.053 2.322zm10.25-4.001c0 5.652-4.598 10.25-10.25 10.25S1.75 17.652 1.75 12 6.348 1.75 12 1.75 22.25 6.348 22.25 12zm-2 0c0-4.549-3.701-8.25-8.25-8.25S3.75 7.451 3.75 12s3.701 8.25 8.25 8.25 8.25-3.701 8.25-8.25z"></path></g>
                          </svg>
                        </div>
                        <div style="display: flex; gap: 8px;">
                          <button onclick="cancelReply('${
                            comment.id
                          }')" style="background: transparent; color: #71767b; border: 1px solid #333; border-radius: 16px; padding: 4px 12px; font-size: 13px; cursor: pointer;">å–æ¶ˆ</button>
                          <button id="reply-btn-${comment.id}" onclick="submitReply('${comment.id}', '${
      comment.user.handle
    }')" style="background-color: #1d9bf0; color: #fff; border: none; border-radius: 16px; padding: 4px 12px; font-size: 13px; cursor: pointer; opacity: 0.5;" disabled>å›å¤</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;

    return commentEl;
  }

  // åˆ é™¤ç”¨æˆ·è¯„è®ºåŠŸèƒ½
  async function deleteUserComment(commentId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
      return;
    }

    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
    if (commentElement) {
      // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
      commentElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      commentElement.style.opacity = '0';
      commentElement.style.transform = 'translateX(-20px)';

      // åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
      setTimeout(() => {
        commentElement.remove();
        showXToast('è¯„è®ºå·²åˆ é™¤', 'success');
      }, 300);

      // é€’å½’åˆ é™¤è¯„è®ºçš„è¾…åŠ©å‡½æ•°
      const removeCommentById = (comments, targetId) => {
        return comments.filter(comment => {
          if (comment.id === targetId) {
            return false; // åˆ é™¤åŒ¹é…çš„è¯„è®º
          }
          if (comment.replies && comment.replies.length > 0) {
            comment.replies = removeCommentById(comment.replies, targetId);
          }
          return true;
        });
      };

      // åŒæ—¶ä»æ¨æ–‡æ•°æ®ä¸­ç§»é™¤è¿™æ¡è¯„è®º
      try {
        // æ›´æ–°sessionStorageä¸­çš„æ•°æ®
        const currentTweetData = sessionStorage.getItem('currentTweetData');
        if (currentTweetData) {
          const tweetData = JSON.parse(currentTweetData);
          if (tweetData.comments) {
            tweetData.comments = removeCommentById(tweetData.comments, commentId);
            sessionStorage.setItem('currentTweetData', JSON.stringify(tweetData));

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            const commentsCount = document.querySelector('.tweet-stats .comment-count');
            if (commentsCount) {
              const currentCount = parseInt(commentsCount.textContent) || 0;
              if (currentCount > 0) {
                commentsCount.textContent = currentCount - 1;
              }
            }

            // åŒæ—¶æ›´æ–°æ•°æ®åº“ä¸­çš„æ•°æ®
            const db = getXDB();
            const tweetsData = await db.xTweetsData.get('tweets');

            if (tweetsData) {
              // åœ¨forYouTweetsä¸­æŸ¥æ‰¾å¹¶æ›´æ–°
              if (tweetsData.forYouTweets) {
                const tweetIndex = tweetsData.forYouTweets.findIndex(t => t.id === tweetData.id);
                if (tweetIndex !== -1) {
                  tweetsData.forYouTweets[tweetIndex].comments = removeCommentById(
                    tweetsData.forYouTweets[tweetIndex].comments || [],
                    commentId,
                  );
                  // æ›´æ–°å…¨å±€å˜é‡
                  forYouTweets[tweetIndex] = tweetsData.forYouTweets[tweetIndex];
                }
              }

              // åœ¨followingTweetsä¸­æŸ¥æ‰¾å¹¶æ›´æ–°
              if (tweetsData.followingTweets) {
                const tweetIndex = tweetsData.followingTweets.findIndex(t => t.id === tweetData.id);
                if (tweetIndex !== -1) {
                  tweetsData.followingTweets[tweetIndex].comments = removeCommentById(
                    tweetsData.followingTweets[tweetIndex].comments || [],
                    commentId,
                  );
                  // æ›´æ–°å…¨å±€å˜é‡
                  followingTweets[tweetIndex] = tweetsData.followingTweets[tweetIndex];
                }
              }

              // ä¿å­˜æ›´æ–°åçš„æ•°æ®
              await db.xTweetsData.put(tweetsData);
            }

            // å¦‚æœæ˜¯ç”¨æˆ·è‡ªå·±çš„æ¨æ–‡ï¼Œä¹Ÿæ›´æ–°ç”¨æˆ·æ¨æ–‡æ•°æ®
            if (tweetData.id.startsWith('user_')) {
              const userTweets = await db.xUserTweets.get('userTweets');
              if (userTweets && userTweets.tweets) {
                const userTweetIndex = userTweets.tweets.findIndex(t => t.id === tweetData.id);
                if (userTweetIndex !== -1) {
                  userTweets.tweets[userTweetIndex].comments = removeCommentById(
                    userTweets.tweets[userTweetIndex].comments || [],
                    commentId,
                  );
                  await db.xUserTweets.put(userTweets);
                }
              }
            }

            console.log('è¯„è®ºå·²ä»æ•°æ®åº“ä¸­åˆ é™¤:', commentId);
          }
        } else if (currentTweetId) {
          // å¦‚æœæ˜¯ä¸»é¡µè¯„è®ºé¡µé¢ï¼Œæ›´æ–°ä¸»é¡µæ•°æ®
          const allTweets = [...forYouTweets, ...followingTweets];
          const tweet = allTweets.find(t => t.id === currentTweetId);

          if (tweet && tweet.comments) {
            tweet.comments = removeCommentById(tweet.comments, commentId);
            tweet.stats.comments = Math.max(0, (tweet.stats.comments || 0) - 1);

            // æ›´æ–°å…¨å±€æ•°ç»„å¼•ç”¨
            const tweetIndex = forYouTweets.findIndex(t => t.id === tweet.id);
            if (tweetIndex !== -1) {
              forYouTweets[tweetIndex] = tweet;
            } else {
              const followingIndex = followingTweets.findIndex(t => t.id === tweet.id);
              if (followingIndex !== -1) {
                followingTweets[followingIndex] = tweet;
              }
            }

            // ä¿å­˜åˆ°æ•°æ®åº“
            const db = getXDB();
            await db.xTweetsData.put({
              id: 'tweets',
              forYouTweets: forYouTweets,
              followingTweets: followingTweets,
              lastUpdated: new Date().toISOString(),
            });

            console.log('ä¸»é¡µè¯„è®ºå·²ä»æ•°æ®åº“ä¸­åˆ é™¤:', commentId);
          }
        }
      } catch (error) {
        console.error('åˆ é™¤è¯„è®ºæ•°æ®å¤±è´¥:', error);
        showXToast('åˆ é™¤è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }
  }

  // è¯„è®ºç‚¹èµåŠŸèƒ½
  function toggleCommentLike(commentId, element) {
    const isLiked = element.dataset.liked === 'true';
    const currentLikes = parseInt(element.dataset.likes);
    const likeIcon = element.querySelector('.like-icon');
    const likeCount = element.querySelector('.like-count');

    if (isLiked) {
      element.dataset.liked = 'false';
      element.dataset.likes = (currentLikes - 1).toString();
      element.classList.remove('liked');
      likeCount.textContent = (currentLikes - 1).toString();
    } else {
      element.dataset.liked = 'true';
      element.dataset.likes = (currentLikes + 1).toString();
      element.classList.add('liked');
      likeCount.textContent = (currentLikes + 1).toString();

      likeIcon.classList.add('like-animation');
      setTimeout(() => {
        likeIcon.classList.remove('like-animation');
      }, 600);
    }
  }

  // æ¸²æŸ“è¯„è®º
  function renderComments(tweetId) {
    const container = document.querySelector('.comments-container');
    container.innerHTML = '';

    // æ‰¾åˆ°å¯¹åº”çš„æ¨æ–‡
    const allTweets = [...forYouTweets, ...followingTweets];
    const tweet = allTweets.find(t => t.id === tweetId);

    if (!tweet || !tweet.comments) return;

    tweet.comments.forEach(comment => {
      // åˆ›å»ºè¯„è®ºç»„å®¹å™¨
      const commentGroup = document.createElement('div');
      commentGroup.style.cssText = 'position: relative;';

      // æ·»åŠ ä¸»è¯„è®º
      const commentElement = createCommentElement(comment);

      // å¦‚æœæœ‰å›å¤ï¼Œç»™ä¸»è¯„è®ºæ·»åŠ ç‰¹æ®Šç±»
      if (comment.replies && comment.replies.length > 0) {
        commentElement.classList.add('has-replies');
      }

      commentGroup.appendChild(commentElement);

      // ä¸ºä¸»è¯„è®ºå¤´åƒæ·»åŠ ç‚¹å‡»äº‹ä»¶
      const commentAvatar = commentElement.querySelector('.tweet-avatar');
      if (commentAvatar) {
        commentAvatar.style.cursor = 'pointer';
        commentAvatar.addEventListener('click', e => {
          e.stopPropagation();
          openAccountProfile(comment.user.name, comment.user.handle, comment.user.avatar);
        });
      }

      // æ¸²æŸ“å›å¤
      if (comment.replies && comment.replies.length > 0) {
        comment.replies.forEach(reply => {
          const replyElement = createCommentElement(reply, true);
          commentGroup.appendChild(replyElement);

          // ä¸ºå›å¤å¤´åƒæ·»åŠ ç‚¹å‡»äº‹ä»¶
          const replyAvatar = replyElement.querySelector('.tweet-avatar');
          if (replyAvatar) {
            replyAvatar.style.cursor = 'pointer';
            replyAvatar.addEventListener('click', e => {
              e.stopPropagation();
              openAccountProfile(reply.user.name, reply.user.handle, reply.user.avatar);
            });
          }
        });
      }

      container.appendChild(commentGroup);
    });

    // æ›´æ–°æ‰€æœ‰å›å¤è¾“å…¥æ¡†å¤´åƒ
    const replyUserAvatars = document.querySelectorAll('.reply-user-avatar');
    replyUserAvatars.forEach(avatar => {
      avatar.src = userProfileData.avatar;
    });
  }

  // è¯„è®ºå›¾ç‰‡æ•°æ®å­˜å‚¨
  let commentImageData = null;
  let detailCommentImageData = null;

  // è§¦å‘ä¸»é¡µè¯„è®ºå›¾ç‰‡ä¸Šä¼ 
  function triggerCommentImageUpload() {
    document.getElementById('comment-image-input').click();
  }

  // å¤„ç†ä¸»é¡µè¯„è®ºå›¾ç‰‡ä¸Šä¼ 
  function handleCommentImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      commentImageData = e.target.result;
      const preview = document.getElementById('comment-image-preview');
      const img = document.getElementById('comment-image-preview-img');
      img.src = commentImageData;
      preview.style.display = 'block';

      showXToast('å›¾ç‰‡å·²æ·»åŠ ', 'success');
    };
    reader.readAsDataURL(file);
  }

  // ç§»é™¤ä¸»é¡µè¯„è®ºå›¾ç‰‡
  function removeCommentImage() {
    commentImageData = null;
    const preview = document.getElementById('comment-image-preview');
    const img = document.getElementById('comment-image-preview-img');
    img.src = '';
    preview.style.display = 'none';
    document.getElementById('comment-image-input').value = '';
  }

  // è§¦å‘è¯¦æƒ…é¡µè¯„è®ºå›¾ç‰‡ä¸Šä¼ 
  function triggerDetailCommentImageUpload() {
    document.getElementById('detail-comment-image-input').click();
  }

  // å¤„ç†è¯¦æƒ…é¡µè¯„è®ºå›¾ç‰‡ä¸Šä¼ 
  function handleDetailCommentImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      detailCommentImageData = e.target.result;
      const preview = document.getElementById('detail-comment-image-preview');
      const img = document.getElementById('detail-comment-image-preview-img');
      img.src = detailCommentImageData;
      preview.style.display = 'block';

      showXToast('å›¾ç‰‡å·²æ·»åŠ ', 'success');
    };
    reader.readAsDataURL(file);
  }

  // ç§»é™¤è¯¦æƒ…é¡µè¯„è®ºå›¾ç‰‡
  function removeDetailCommentImage() {
    detailCommentImageData = null;
    const preview = document.getElementById('detail-comment-image-preview');
    const img = document.getElementById('detail-comment-image-preview-img');
    img.src = '';
    preview.style.display = 'none';
    document.getElementById('detail-comment-image-input').value = '';
  }

  // å¤„ç†è¯„è®ºè¾“å…¥
  function handleCommentInput(event) {
    const textarea = event.target;
    const replyBtn = document.getElementById('reply-btn');

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    if (textarea.value.trim().length > 0) {
      replyBtn.style.opacity = '1';
      replyBtn.disabled = false;
    } else {
      replyBtn.style.opacity = '0.5';
      replyBtn.disabled = true;
    }

    // å›è½¦å‘é€è¯„è®ºï¼ˆShift+å›è½¦æ¢è¡Œï¼‰
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      if (textarea.value.trim().length > 0) {
        submitComment();
      }
    }
  }

  // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
  function autoResize(textarea) {
    textarea.style.height = '20px';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const replyBtn = document.getElementById('reply-btn');
    if (textarea.value.trim().length > 0) {
      replyBtn.style.opacity = '1';
      replyBtn.disabled = false;
    } else {
      replyBtn.style.opacity = '0.5';
      replyBtn.disabled = true;
    }
  }

  // å½“å‰æ­£åœ¨æŸ¥çœ‹çš„æ¨æ–‡ID
  let currentTweetId = null;

  // æäº¤è¯„è®º
  async function submitComment() {
    const textarea = document.getElementById('comment-input');
    const content = textarea.value.trim();

    if (content.length === 0 || !currentTweetId) return;

    // è·å–å½“å‰æ¨æ–‡æ•°æ®
    const allTweets = [...forYouTweets, ...followingTweets];
    const tweet = allTweets.find(t => t.id === currentTweetId);

    if (!tweet) {
      showXToast('æ— æ³•æ‰¾åˆ°å¯¹åº”çš„æ¨æ–‡', 'error');
      return;
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºä»…è‡ªå·±å¯è§çš„å¸–å­ï¼ˆä¸»é¡µæ¨æ–‡ä¸€èˆ¬ä¸ä¼šæœ‰privateæ ‡è®°ï¼Œä½†ä¸ºäº†ç»Ÿä¸€ï¼‰
    if (tweet.privacy === 'private') {
      showXToast('ç§æœ‰å¸–å­ä¸æ”¯æŒå›å¤åŠŸèƒ½', 'error');
      return;
    }

    // åˆ›å»ºæ–°è¯„è®ºå¯¹è±¡ï¼ˆä½¿ç”¨window.userProfileDataç¡®ä¿è·å–æœ€æ–°è´¦å·æ•°æ®ï¼‰
    const newComment = {
      id: 'new-' + Date.now(),
      user: {
        name: window.userProfileData.name,
        handle: window.userProfileData.handle,
        avatar: window.userProfileData.avatar,
        verified: window.userProfileData.verified,
      },
      content: content,
      time: 'åˆšåˆš',
      replies: [],
    };

    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡æ•°æ®
    if (commentImageData) {
      newComment.image = {
        type: 'upload',
        content: commentImageData,
      };
    }

    // æ·»åŠ åˆ°å¯¹åº”æ¨æ–‡çš„è¯„è®ºåˆ—è¡¨
    if (tweet) {
      // ç¡®ä¿è¯„è®ºåˆ—è¡¨å­˜åœ¨
      if (!tweet.comments) {
        tweet.comments = [];
      }
      tweet.comments.push(newComment);
      tweet.stats.comments += 1;

      // å¼ºåˆ¶æ›´æ–°å…¨å±€æ•°ç»„å¼•ç”¨ï¼Œç¡®ä¿æ•°æ®åŒæ­¥
      const tweetIndex = forYouTweets.findIndex(t => t.id === tweet.id);
      if (tweetIndex !== -1) {
        forYouTweets[tweetIndex] = tweet;
      } else {
        const followingIndex = followingTweets.findIndex(t => t.id === tweet.id);
        if (followingIndex !== -1) {
          followingTweets[followingIndex] = tweet;
        }
      }

      // ä¿å­˜æ›´æ–°åçš„æ¨æ–‡æ•°æ®
      try {
        const db = getXDB();

        await db.xTweetsData.put({
          id: 'tweets',
          forYouTweets: forYouTweets,
          followingTweets: followingTweets,
          lastUpdated: new Date().toISOString(),
        });

        console.log('ç”¨æˆ·è¯„è®ºå·²ä¿å­˜åˆ°æ•°æ®åº“ï¼Œè¯„è®ºID:', newComment.id);
      } catch (saveError) {
        console.error('ä¿å­˜è¯„è®ºæ•°æ®å¤±è´¥:', saveError);
      }
    }

    // é‡æ–°æ¸²æŸ“è¯„è®º
    renderComments(currentTweetId);

    // æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®é«˜åº¦
    textarea.value = '';
    textarea.style.height = '20px';

    // æ¸…é™¤å›¾ç‰‡
    if (commentImageData) {
      removeCommentImage();
    }

    // é‡ç½®æŒ‰é’®çŠ¶æ€
    const replyBtn = document.getElementById('reply-btn');
    replyBtn.style.opacity = '0.5';
    replyBtn.disabled = true;

    // æ»šåŠ¨åˆ°åº•éƒ¨æ˜¾ç¤ºæ–°è¯„è®º
    const commentsContainer = document.querySelector('.comments-container');
    setTimeout(() => {
      commentsContainer.scrollTop = commentsContainer.scrollHeight;
    }, 100);

    showXToast('ä½ çš„è¯„è®ºç­‰å¾…å›å¤ä¸­', 'info');

    // è§¦å‘AIå›å¤ - åˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·è‡ªå·±çš„å¸–å­ï¼ˆä¸»é¡µæ¨æ–‡ä¸­ç”¨æˆ·è‡ªå·±çš„å¸–å­éœ€è¦ç‰¹åˆ«å¤„ç†ï¼‰
    const isOwnPost = tweet.user && (tweet.user.handle === userProfileData.handle || tweet.id.startsWith('user_'));

    // å»¶è¿Ÿè§¦å‘AIå›å¤ï¼Œç¡®ä¿ç”¨æˆ·è¯„è®ºå·²ç»å®Œå…¨æ¸²æŸ“å’Œä¿å­˜
    setTimeout(async () => {
      await generateUnifiedAIResponse(tweet, newComment, {
        isOwnPost,
        commentType: 'main_comment',
        pageType: 'main',
        parentComment: null,
      });
    }, 100);
  }

  // æ˜¾ç¤ºå›å¤è¾“å…¥æ¡†
  function showReplyInput(commentId, userHandle) {
    // éšè—æ‰€æœ‰å…¶ä»–å›å¤è¾“å…¥æ¡†
    document.querySelectorAll('.reply-input-container').forEach(container => {
      container.style.display = 'none';
    });

    // æ˜¾ç¤ºå½“å‰è¯„è®ºçš„å›å¤è¾“å…¥æ¡†
    const replyContainer = document.getElementById(`reply-input-${commentId}`);
    if (replyContainer) {
      replyContainer.style.display = 'block';
      const textarea = replyContainer.querySelector('textarea');
      textarea.focus();
    }
  }

  // å–æ¶ˆå›å¤
  function cancelReply(commentId) {
    const replyContainer = document.getElementById(`reply-input-${commentId}`);
    if (replyContainer) {
      replyContainer.style.display = 'none';
      const textarea = replyContainer.querySelector('textarea');
      textarea.value = '';
      textarea.style.height = '20px';

      // é‡ç½®æŒ‰é’®çŠ¶æ€
      const replyBtn = document.getElementById(`reply-btn-${commentId}`);
      replyBtn.style.opacity = '0.5';
      replyBtn.disabled = true;
    }
  }

  // å¤„ç†å›å¤è¾“å…¥
  function handleReplyInput(event, commentId, userHandle) {
    const textarea = event.target;
    const replyBtn = document.getElementById(`reply-btn-${commentId}`);

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    if (textarea.value.trim().length > 0) {
      replyBtn.style.opacity = '1';
      replyBtn.disabled = false;
    } else {
      replyBtn.style.opacity = '0.5';
      replyBtn.disabled = true;
    }

    // å›è½¦å‘é€å›å¤
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      if (textarea.value.trim().length > 0) {
        submitReply(commentId, userHandle);
      }
    }
  }

  // è‡ªåŠ¨è°ƒæ•´å›å¤textareaé«˜åº¦
  function autoResizeReply(textarea, commentId) {
    textarea.style.height = '20px';
    textarea.style.height = Math.min(textarea.scrollHeight, 80) + 'px';

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const replyBtn = document.getElementById(`reply-btn-${commentId}`);
    if (textarea.value.trim().length > 0) {
      replyBtn.style.opacity = '1';
      replyBtn.disabled = false;
    } else {
      replyBtn.style.opacity = '0.5';
      replyBtn.disabled = true;
    }
  }

  // æäº¤å›å¤
  async function submitReply(commentId, replyToHandle) {
    const replyContainer = document.getElementById(`reply-input-${commentId}`);
    const textarea = replyContainer.querySelector('textarea');
    const content = textarea.value.trim();

    if (content.length === 0) return;

    // è·å–å½“å‰æ¨æ–‡æ•°æ® - å…ˆå°è¯•ä»sessionStorageï¼ˆè¯¦æƒ…é¡µï¼‰ï¼Œå†ä»ä¸»é¡µæ•°æ®
    let tweetData = null;
    const currentTweetDataFromSession = sessionStorage.getItem('currentTweetData');

    if (currentTweetDataFromSession) {
      // è¯¦æƒ…é¡µé¢çš„æƒ…å†µ
      try {
        tweetData = JSON.parse(currentTweetDataFromSession);
      } catch (e) {
        console.error('è§£æsessionStorageæ¨æ–‡æ•°æ®å¤±è´¥:', e);
      }
    }

    if (!tweetData && currentTweetId) {
      // ä¸»é¡µæ¨æ–‡çš„æƒ…å†µ
      const allTweets = [...forYouTweets, ...followingTweets];
      tweetData = allTweets.find(t => t.id === currentTweetId);
    }

    if (!tweetData) {
      showXToast('æ— æ³•è·å–æ¨æ–‡ä¿¡æ¯', 'error');
      return;
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºä»…è‡ªå·±å¯è§çš„å¸–å­
    if (tweetData.privacy === 'private') {
      showXToast('ç§æœ‰å¸–å­ä¸æ”¯æŒå›å¤åŠŸèƒ½', 'error');
      return;
    }

    // æ‰¾åˆ°è¢«å›å¤çš„è¯„è®º - æ”¯æŒæ¥¼ä¸­æ¥¼å›å¤å¹¶å¤„ç†ä¸ºå¹³çº§æ˜¾ç¤º
    let parentComment = null;
    let mainCommentId = commentId; // ç”¨äºæŸ¥æ‰¾ä¸»è¯„è®ºIDï¼ˆå¯¹äºæ¥¼ä¸­æ¥¼å›å¤ï¼‰
    const isDetailPage = !!currentTweetDataFromSession;
    const commentsContainer = isDetailPage
      ? document.getElementById('detail-comments-container')
      : document.querySelector('.comments-container');
    const allComments = commentsContainer.querySelectorAll('.comment-item');

    // é¦–å…ˆæ‰¾åˆ°è¢«å›å¤çš„è¯„è®º
    let targetCommentEl = null;
    allComments.forEach(commentEl => {
      if (commentEl.dataset.commentId === commentId) {
        targetCommentEl = commentEl;
      }
    });

    if (targetCommentEl) {
      // ä»DOMä¸­æå–è¯„è®ºä¿¡æ¯æ„å»ºparentComment
      const userName = targetCommentEl.querySelector('.tweet-user-name').textContent;
      const userHandle = targetCommentEl.querySelector('.tweet-user-handle').textContent;
      const commentContent = targetCommentEl.querySelector('.comment-content').textContent.trim();

      parentComment = {
        id: commentId,
        user: { name: userName, handle: userHandle },
        content: commentContent,
      };

      // å¦‚æœè¢«å›å¤çš„æ˜¯æ¥¼ä¸­æ¥¼ï¼Œéœ€è¦æ‰¾åˆ°å¯¹åº”çš„ä¸»è¯„è®ºIDï¼ˆç”¨äºæ•°æ®å­˜å‚¨ï¼‰
      if (targetCommentEl.classList.contains('reply-item')) {
        // å‘ä¸ŠæŸ¥æ‰¾åŒä¸€ä¸ªè¯„è®ºç»„ä¸­çš„ä¸»è¯„è®º
        let currentEl = targetCommentEl.previousElementSibling;
        while (currentEl && currentEl.classList.contains('reply-item')) {
          currentEl = currentEl.previousElementSibling;
        }
        if (currentEl && currentEl.classList.contains('comment-item') && !currentEl.classList.contains('reply-item')) {
          mainCommentId = currentEl.dataset.commentId;
        } else {
          // å¦‚æœå‘ä¸Šæ²¡æ‰¾åˆ°ï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€ä¸ªå›å¤ï¼Œå‘ä¸ŠæŸ¥æ‰¾çˆ¶å®¹å™¨ä¸­çš„ä¸»è¯„è®º
          let parentContainer = targetCommentEl.parentNode;
          let firstComment = parentContainer.querySelector('.comment-item:not(.reply-item)');
          if (firstComment) {
            mainCommentId = firstComment.dataset.commentId;
          }
        }
      }
    }

    // åˆ›å»ºæ–°å›å¤å¯¹è±¡ï¼ˆä½¿ç”¨window.userProfileDataç¡®ä¿è·å–æœ€æ–°è´¦å·æ•°æ®ï¼‰
    const newReply = {
      id: 'reply-' + Date.now(),
      user: {
        name: window.userProfileData.name,
        handle: window.userProfileData.handle,
        avatar: window.userProfileData.avatar,
        verified: window.userProfileData.verified,
      },
      content: content,
      time: 'åˆšåˆš',
      replyTo: replyToHandle,
      replies: [],
    };

    if (isDetailPage) {
      // è¯¦æƒ…é¡µé¢ï¼šæ¸²æŸ“åˆ°é¡µé¢å¹¶åŒæ—¶ä¿å­˜åˆ°æ•°æ®åº“ - ä¿®å¤æ¥¼ä¸­æ¥¼æ’å…¥ä½ç½®
      const commentElement = createCommentElement(newReply, true);

      if (targetCommentEl) {
        let insertAfter = null;

        if (targetCommentEl.classList.contains('reply-item')) {
          // å¦‚æœå›å¤çš„æ˜¯æ¥¼ä¸­æ¥¼ï¼Œæ‰¾åˆ°è¿™ä¸ªè¯„è®ºç»„çš„æœ€åä¸€ä¸ªè¯„è®º
          let nextSibling = targetCommentEl.nextElementSibling;
          insertAfter = targetCommentEl;

          // æ‰¾åˆ°å½“å‰è¯„è®ºç»„çš„æœ€åä¸€æ¡è¯„è®º
          while (nextSibling && nextSibling.classList.contains('reply-item')) {
            insertAfter = nextSibling;
            nextSibling = nextSibling.nextElementSibling;
          }
        } else {
          // å¦‚æœå›å¤çš„æ˜¯ä¸»è¯„è®ºï¼Œæ‰¾åˆ°è¿™ä¸ªè¯„è®ºç»„çš„æœ€åä¸€æ¡è¯„è®ºï¼ˆåŒ…æ‹¬æ‰€æœ‰æ¥¼ä¸­æ¥¼ï¼‰
          let nextSibling = targetCommentEl.nextElementSibling;
          insertAfter = targetCommentEl;

          while (nextSibling && nextSibling.classList.contains('reply-item')) {
            insertAfter = nextSibling;
            nextSibling = nextSibling.nextElementSibling;
          }
        }

        // æ’å…¥åˆ°æ­£ç¡®ä½ç½®
        if (insertAfter.nextSibling) {
          insertAfter.parentNode.insertBefore(commentElement, insertAfter.nextSibling);
        } else {
          insertAfter.parentNode.appendChild(commentElement);
        }
      }

      // åŒæ—¶ä¿å­˜åˆ°sessionStorageä¸­çš„æ¨æ–‡æ•°æ®
      try {
        let updatedTweetData = JSON.parse(sessionStorage.getItem('currentTweetData'));
        if (updatedTweetData) {
          const mainComment = updatedTweetData.comments.find(c => c.id === mainCommentId);
          if (mainComment) {
            if (!mainComment.replies) mainComment.replies = [];
            mainComment.replies.push(newReply);

            // æ›´æ–°sessionStorage
            sessionStorage.setItem('currentTweetData', JSON.stringify(updatedTweetData));

            // åŒæ—¶ä¿å­˜åˆ°æ•°æ®åº“
            const db = getXDB();

            // æ›´æ–°å¯¹åº”çš„æ¨æ–‡æ•°æ®åˆ°æ•°æ®åº“
            const tweetsData = await db.xTweetsData.get('tweets');
            if (tweetsData) {
              // åœ¨forYouTweetså’ŒfollowingTweetsä¸­æŸ¥æ‰¾å¹¶æ›´æ–°
              let updated = false;

              if (tweetsData.forYouTweets) {
                const tweetIndex = tweetsData.forYouTweets.findIndex(t => t.id === updatedTweetData.id);
                if (tweetIndex !== -1) {
                  tweetsData.forYouTweets[tweetIndex] = updatedTweetData;
                  updated = true;
                }
              }

              if (!updated && tweetsData.followingTweets) {
                const tweetIndex = tweetsData.followingTweets.findIndex(t => t.id === updatedTweetData.id);
                if (tweetIndex !== -1) {
                  tweetsData.followingTweets[tweetIndex] = updatedTweetData;
                  updated = true;
                }
              }

              // å¦‚æœæ˜¯ç”¨æˆ·è‡ªå·±çš„æ¨æ–‡ï¼Œæ›´æ–°åˆ°ç”¨æˆ·æ¨æ–‡æ•°æ®
              if (updatedTweetData.id.startsWith('user_')) {
                const accountTweetsId = `userTweets_${currentAccountId || 'main'}`;
                const userTweets = await db.xUserTweets.get(accountTweetsId);
                if (userTweets && userTweets.tweets) {
                  const userTweetIndex = userTweets.tweets.findIndex(t => t.id === updatedTweetData.id);
                  if (userTweetIndex !== -1) {
                    userTweets.tweets[userTweetIndex] = updatedTweetData;
                    await db.xUserTweets.put(userTweets);
                    console.log('âœ… ç”¨æˆ·æ¨æ–‡å·²æ›´æ–°åˆ°è´¦æˆ·:', accountTweetsId);
                  }
                }
              }

              if (updated) {
                await db.xTweetsData.put(tweetsData);
                console.log('è¯¦æƒ…é¡µè¯„è®ºå·²ä¿å­˜åˆ°æ•°æ®åº“');
              }
            }
          }
        }
      } catch (saveError) {
        console.error('ä¿å­˜è¯¦æƒ…é¡µè¯„è®ºå¤±è´¥:', saveError);
      }
    } else {
      // ä¸»é¡µæ¨æ–‡ï¼šæ·»åŠ åˆ°æ•°æ®å¹¶é‡æ–°æ¸²æŸ“ - æ”¯æŒæ¥¼ä¸­æ¥¼å¹³çº§å›å¤
      const mainComment = tweetData.comments.find(c => c.id === mainCommentId);
      if (mainComment) {
        if (!mainComment.replies) mainComment.replies = [];
        mainComment.replies.push(newReply);

        // å¼ºåˆ¶æ›´æ–°å…¨å±€æ•°ç»„å¼•ç”¨ï¼Œç¡®ä¿æ•°æ®åŒæ­¥
        const tweetIndex = forYouTweets.findIndex(t => t.id === tweetData.id);
        if (tweetIndex !== -1) {
          forYouTweets[tweetIndex] = tweetData;
        } else {
          const followingIndex = followingTweets.findIndex(t => t.id === tweetData.id);
          if (followingIndex !== -1) {
            followingTweets[followingIndex] = tweetData;
          }
        }

        // ä¿å­˜æ›´æ–°åçš„æ¨æ–‡æ•°æ®
        try {
          const db = getXDB();

          await db.xTweetsData.put({
            id: 'tweets',
            forYouTweets: forYouTweets,
            followingTweets: followingTweets,
            lastUpdated: new Date().toISOString(),
          });

          console.log('ç”¨æˆ·å›å¤å·²ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå›å¤ID:', newReply.id);
        } catch (saveError) {
          console.error('ä¿å­˜å›å¤æ•°æ®å¤±è´¥:', saveError);
        }

        // é‡æ–°æ¸²æŸ“è¯„è®º
        renderComments(currentTweetId);
      }
    }

    // éšè—å›å¤è¾“å…¥æ¡†
    cancelReply(commentId);

    showXToast('ä½ çš„è¯„è®ºç­‰å¾…å›å¤ä¸­', 'info');

    // è§¦å‘AIå›å¤ - åˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·è‡ªå·±çš„å¸–å­
    const isOwnPost =
      tweetData.user && (tweetData.user.handle === userProfileData.handle || tweetData.id.startsWith('user_'));

    // å»¶è¿Ÿè§¦å‘AIå›å¤ï¼Œç¡®ä¿ç”¨æˆ·å›å¤å·²ç»å®Œå…¨æ¸²æŸ“å’Œä¿å­˜
    setTimeout(async () => {
      await generateUnifiedAIResponse(tweetData, newReply, {
        isOwnPost,
        commentType: 'reply_comment',
        pageType: isDetailPage ? 'detail' : 'main',
        parentComment,
        mainCommentId, // ä¼ é€’ä¸»è¯„è®ºIDç”¨äºæ¥¼ä¸­æ¥¼å›å¤å¤„ç†
      });
    }, 100);
  }

  // ä¿®æ”¹æ˜¾ç¤ºæ¨æ–‡è¯„è®ºé¡µé¢å‡½æ•°ï¼Œä¿å­˜å½“å‰æ¨æ–‡ID
  function showTweetComments(tweetId) {
    currentTweetId = tweetId;

    // æ¸…é™¤sessionStorageä¸­çš„æ¨æ–‡æ•°æ®ï¼Œé¿å…ä¸»é¡µè¯„è®ºæ—¶ä½¿ç”¨é”™è¯¯çš„è¯¦æƒ…é¡µæ•°æ®
    sessionStorage.removeItem('currentTweetData');
    console.log('âœ… å·²æ¸…é™¤è¯¦æƒ…é¡µæ•°æ®ç¼“å­˜ï¼Œå½“å‰æŸ¥çœ‹ä¸»é¡µæ¨æ–‡:', tweetId);

    // éšè—æ‰€æœ‰é¡µé¢
    document.querySelectorAll('.x-page').forEach(page => {
      page.style.display = 'none';
    });

    // æ˜¾ç¤ºè¯„è®ºé¡µé¢
    const commentsPage = document.getElementById('x-comments-page');
    commentsPage.style.display = 'flex';

    // æ¸²æŸ“è¯„è®º
    renderComments(tweetId);

    // æ¸…ç©ºè¾“å…¥æ¡†
    const textarea = document.getElementById('comment-input');
    if (textarea) {
      textarea.value = '';
      textarea.style.height = '20px';
    }

    // é‡ç½®æŒ‰é’®çŠ¶æ€
    const replyBtn = document.getElementById('reply-btn');
    if (replyBtn) {
      replyBtn.style.opacity = '0.5';
      replyBtn.disabled = true;
    }
  }

  // Xé£æ ¼æç¤ºæ¡†
  function showXToast(message, type = 'success') {
    // ç§»é™¤ç°æœ‰çš„æç¤ºæ¡†
    const existingToast = document.querySelector('.x-toast');
    if (existingToast) {
      existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = 'x-toast';
    toast.style.cssText = `
              position: fixed;
              top: 80px;
              left: 50%;
              transform: translateX(-50%);
              background-color: ${type === 'success' ? '#1d9bf0' : '#f4212e'};
              color: #fff;
              padding: 12px 20px;
              border-radius: 20px;
              font-size: 15px;
              font-weight: 600;
              z-index: 1000;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
              animation: fadeInOut 3s ease-in-out forwards;
            `;
    toast.textContent = message;

    // æ·»åŠ æ·¡å…¥æ·¡å‡ºåŠ¨ç”»
    const style = document.createElement('style');
    style.textContent = `
              @keyframes fadeInOut {
              0 % { opacity: 0; transform: translateX(-50 %) translateY(- 20px); }
            15% {opacity: 1; transform: translateX(-50%) translateY(0); }
            85% {opacity: 1; transform: translateX(-50%) translateY(0); }
            100% {opacity: 0; transform: translateX(-50%) translateY(-20px); }
              }
            `;
    document.head.appendChild(style);
    document.body.appendChild(toast);

    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
      if (style.parentNode) {
        style.remove();
      }
    }, 3000);
  }
  // â–¼â–¼â–¼ ã€ä¸»è¦ï¼ï¼ï¼ã€‘ç¬¬ä¸€ä¸ªæƒ…æ™¯ï¼šæ¨æ–‡ç”Ÿæˆå™¨â–¼â–¼â–¼
  async function refreshXTweets() {
    const refreshBtn = document.querySelector('.x-refresh-btn');

    // æ·»åŠ æ—‹è½¬åŠ¨ç”»
    refreshBtn.style.animation = 'spin 1s linear infinite';
    const spinStyle = document.createElement('style');
    spinStyle.textContent = `
              @keyframes spin {
              from {transform: rotate(0deg); }
            to {transform: rotate(360deg); }
              }
            `;
    document.head.appendChild(spinStyle);

    try {
      // CSVè§£æå‡½æ•°
      function parseCSVToTweets(csvText) {
        const lines = csvText
          .split('\n')
          .map(line => line.trim())
          .filter(line => line);

        const tweetsData = {
          forYouTweets: [],
          followingTweets: [],
        };

        let currentSection = '';
        let tweetIndex = 0;

        for (const line of lines) {
          if (line.includes('=== ä¸ºä½ æ¨è ===')) {
            currentSection = 'forYou';
            tweetIndex = 0;
            continue;
          } else if (line.includes('=== æ­£åœ¨å…³æ³¨ ===')) {
            currentSection = 'following';
            tweetIndex = 0;
            continue;
          }

          // è·³è¿‡è¡¨å¤´
          if (line.includes('ç”¨æˆ·å,ç”¨æˆ·å¥æŸ„,ç”¨æˆ·å¤´åƒ,æ˜¯å¦è®¤è¯') || line.includes('è¯„è®º1ç”¨æˆ·å,è¯„è®º1å¥æŸ„')) {
            continue;
          }

          // è§£ææ¨æ–‡æ•°æ®è¡Œ
          if (currentSection && line.includes(',')) {
            const values = line.split(',').map(v => v.trim());

            if (values.length >= 12) {
              // è‡³å°‘åŒ…å«åŸºæœ¬æ¨æ–‡ä¿¡æ¯ï¼ˆåŒ…æ‹¬å¤´åƒå­—æ®µï¼‰
              const tweet = {
                id: `${currentSection}_${tweetIndex}`,
                user: {
                  name: values[0] || 'åŒ¿åç”¨æˆ·',
                  handle: values[1] || '@anonymous',
                  avatar: values[2] || 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
                  verified: values[3] === 'æ˜¯',
                },
                content: values[4] || '',
                time: values[5] || 'åˆšåˆš',
                media: values[6]
                  ? [
                      {
                        type: 'image',
                        description: values[6],
                        sensitive: values[7] === 'æ˜¯',
                      },
                    ]
                  : [],
                stats: {
                  comments: parseInt(values[8]) || 0,
                  retweets: parseInt(values[9]) || 0,
                  likes: parseInt(values[10]) || 0,
                  views: parseInt(values[11]) || 0,
                },
                comments: [],
              };

              // è§£æå¼•ç”¨æ¨æ–‡æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              // æ£€æŸ¥å¼•ç”¨å­—æ®µï¼šç´¢å¼•12-18æ˜¯å¼•ç”¨ç›¸å…³å­—æ®µï¼ˆå¼•ç”¨ç±»å‹ã€å¼•ç”¨ç”¨æˆ·åã€å¼•ç”¨å¥æŸ„ã€å¼•ç”¨å¤´åƒã€å¼•ç”¨è®¤è¯ã€å¼•ç”¨å†…å®¹ã€å¼•ç”¨æ—¶é—´ï¼‰
              if (values.length >= 19 && values[12] && values[13] && values[17]) {
                tweet.quotedTweet = {
                  type: values[12] || 'tweet', // 'tweet' æˆ– 'comment'
                  user: {
                    name: values[13] || 'å¼•ç”¨ç”¨æˆ·',
                    handle: values[14] || '@quoted',
                    avatar: values[15] || 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
                    verified: values[16] === 'æ˜¯',
                  },
                  content: values[17] || '',
                  time: values[18] || 'åˆšåˆš',
                };
              }

              // ç»Ÿä¸€å¤„ç†è¯„è®ºè§£æï¼šæ‰€æœ‰æ¨æ–‡çš„è¯„è®ºéƒ½ä»ç´¢å¼•19å¼€å§‹
              // æ— è®ºæ˜¯å¦æœ‰å¼•ç”¨æ¨æ–‡ï¼Œè¯„è®ºå­—æ®µçš„ä½ç½®éƒ½æ˜¯å›ºå®šçš„
              const comments = [];
              const commentStartIndex = 19; // 12ä¸ªåŸºæœ¬å­—æ®µ + 7ä¸ªå¼•ç”¨å­—æ®µ = 19

              // ä»ç´¢å¼•19å¼€å§‹ï¼Œæ¯7ä¸ªå­—æ®µä¸ºä¸€ä¸ªè¯„è®ºï¼šç”¨æˆ·åã€å¥æŸ„ã€å¤´åƒã€è®¤è¯ã€å†…å®¹ã€æ—¶é—´ã€å›å¤å¯¹è±¡
              let commentIndex = 1;
              let startIndex = commentStartIndex;

              while (startIndex + 6 < values.length) {
                const commentName = values[startIndex];
                const commentHandle = values[startIndex + 1];
                const commentAvatar = values[startIndex + 2];
                const commentVerified = values[startIndex + 3];
                const commentContent = values[startIndex + 4];
                const commentTime = values[startIndex + 5];
                const commentReplyTo = values[startIndex + 6];

                // æ£€æŸ¥è¯„è®ºæ˜¯å¦æœ‰æ•ˆï¼ˆè‡³å°‘éœ€è¦ç”¨æˆ·åã€å¥æŸ„ã€å†…å®¹ï¼‰
                if (commentName && commentHandle && commentContent) {
                  const newComment = {
                    id: `${tweet.id}_c${commentIndex}`,
                    user: {
                      name: commentName,
                      handle: commentHandle,
                      avatar: commentAvatar || 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
                      verified: commentVerified === 'æ˜¯',
                    },
                    content: commentContent,
                    time: commentTime || 'åˆšåˆš',
                    replyTo: commentReplyTo || '',
                    replies: [],
                  };

                  // å¦‚æœè¿™ä¸ªè¯„è®ºæ˜¯å›å¤å…¶ä»–è¯„è®ºï¼Œæ‰¾åˆ°è¢«å›å¤çš„è¯„è®ºå¹¶æ·»åŠ ä¸ºå›å¤
                  if (commentReplyTo) {
                    const targetComment = comments.find(c => c.user.handle === commentReplyTo);
                    if (targetComment) {
                      targetComment.replies.push(newComment);
                    } else {
                      // å¦‚æœæ‰¾ä¸åˆ°è¢«å›å¤çš„è¯„è®ºï¼Œä½œä¸ºç‹¬ç«‹è¯„è®ºæ·»åŠ 
                      comments.push(newComment);
                    }
                  } else {
                    // ç‹¬ç«‹è¯„è®º
                    comments.push(newComment);
                  }

                  commentIndex++;
                } else {
                  // å¦‚æœé‡åˆ°ç©ºçš„è¯„è®ºå­—æ®µï¼Œåœæ­¢è§£æ
                  break;
                }

                // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè¯„è®ºçš„èµ·å§‹ä½ç½®
                startIndex += 7;
              }

              tweet.comments = comments;

              if (currentSection === 'forYou') {
                tweetsData.forYouTweets.push(tweet);
              } else if (currentSection === 'following') {
                tweetsData.followingTweets.push(tweet);
              }

              tweetIndex++;
            }
          }
        }

        return tweetsData;
      }
      // ä»æ•°æ®åº“è¯»å–APIé…ç½®å’ŒXè®¾ç½®
      const db = getDB(); // ç”¨äºè®¿é—®APIé…ç½®
      const xDb = getXDB(); // ç”¨äºè®¿é—®Xä¸“ç”¨è®¾ç½®

      // å®šä¹‰Xç¤¾äº¤é¡µé¢éœ€è¦çš„APIè¾…åŠ©å‡½æ•°
      function toGeminiRequestData(model, apiKey, systemPrompt, messages) {
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
        return {
          url: `${GEMINI_API_URL}/${model}:generateContent?key=${apiKey}`,
          data: {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: systemPrompt + '\n\n' + messages.map(m => m.content).join('\n'),
                    },
                  ],
                },
              ],
            }),
          },
        };
      }

      function getGeminiResponseText(data) {
        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
          return data.candidates[0].content.parts[0].text || '';
        }
        return '';
      }

      const apiConfig = await db.apiConfig.get('main');
      if (!apiConfig || !apiConfig.proxyUrl || !apiConfig.apiKey || !apiConfig.model) {
        showXToast('è¯·å…ˆé…ç½®APIè®¾ç½®', 'error');
        refreshBtn.style.animation = '';
        return;
      }

      const { proxyUrl, apiKey, model } = apiConfig;

      // ä»Xè®¾ç½®ä¸­è¯»å–é…ç½®ï¼ˆæŒ‰è´¦å·è¯»å–ï¼‰
      const settingsId = `xSettings_${currentAccountId || 'main'}`;
      const xSettings = await xDb.xSettings.get(settingsId);
      const userPrompt = xSettings?.systemPrompt || '';
      const worldSetting = xSettings?.worldSetting || '';
      const boundCharacters = xSettings?.boundCharacters || [];

      // è¯»å–ç»‘å®šçš„NPCæ•°æ®ï¼ˆä»å…¨å±€è¯»å–ï¼‰
      const npcDataId = 'xNPCs_global'; // å…¨å±€å­˜å‚¨ï¼Œæ‰€æœ‰è´¦å·å…±äº«
      const npcData = await xDb.xNPCs.get(npcDataId);
      const allNPCs = npcData?.npcs || [];
      // è¿‡æ»¤å‡ºç»‘å®šäº†å½“å‰ç”¨æˆ·çš„NPC
      const currentAccount = currentAccountId || 'main';
      const boundNPCs = allNPCs.filter(npc => npc.boundUsers && npc.boundUsers.includes(currentAccount));

      if (boundNPCs.length > 0) {
        console.log(
          `ğŸ“‹ å·²åŠ è½½ ${boundNPCs.length} ä¸ªç»‘å®šNPC:`,
          boundNPCs.map(n => `${n.name}(${n.handle})`).join(', '),
        );
      }

      // ä½¿ç”¨å·¥å…·å‡½æ•°æ„å»ºç”¨æˆ·Xä¸ªäººèµ„æ–™ä¿¡æ¯ï¼ˆä½¿ç”¨window.userProfileDataç¡®ä¿è·å–æœ€æ–°æ•°æ®ï¼‰
      const userXProfileInfo = StringBuilders.buildUserXProfileInfo(window.userProfileData);

      // è°ƒè¯•ï¼šè¾“å‡ºç”¨æˆ·èº«ä»½è¯†åˆ«è®¾ç½®
      console.log('ğŸ­ ç»‘å®šè§’è‰²æ•°é‡:', boundCharacters.length);
      if (boundCharacters.length > 0) {
        console.log('ğŸ­ ç»‘å®šè§’è‰²åˆ—è¡¨:', boundCharacters);
      }
      console.log('ğŸ‘¤ å·²çŸ¥èº«ä»½è§’è‰²æ•°:', window.userProfileData.knownIdentityCharacters?.length || 0);
      if (window.userProfileData.knownIdentityCharacters?.length > 0) {
        console.log('ğŸ‘¤ å·²çŸ¥èº«ä»½è§’è‰²åˆ—è¡¨:', window.userProfileData.knownIdentityCharacters);
      }

      // 1. æç¤ºè¯ + ä¸–ç•Œä¹¦
      let systemPrompt = StringBuilders.buildBaseSystemPrompt({
        userPrompt,
        worldSetting,
      });

      // 2. è§’è‰²å®šä¹‰ï¼ˆæ¨æ–‡ç”Ÿæˆä¸“ç”¨ï¼‰
      systemPrompt += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ æ ¸å¿ƒä»»åŠ¡è¯´æ˜ ğŸ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä½ æ˜¯Xç¤¾äº¤å¹³å°çš„å†…å®¹ç”Ÿæˆå™¨ã€‚è¯·ç”Ÿæˆä¸¤ç»„æ¨æ–‡æ•°æ®ï¼š
- "ä¸ºä½ æ¨è"é¡µé¢ï¼ˆçƒ­é—¨æœ‰è¶£å†…å®¹ï¼‰
- "æ­£åœ¨å…³æ³¨"é¡µé¢ï¼ˆä¸ªäººç”Ÿæ´»æ—¥å¸¸ï¼‰

**ä½ åªè´Ÿè´£ç”Ÿæˆå…¶ä»–ç”¨æˆ·çš„æ¨æ–‡ï¼Œç»ä¸ç”Ÿæˆç”¨æˆ·æœ¬äººçš„æ¨æ–‡ï¼**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ç”Ÿæˆè¦æ±‚ã€‘ï¼š
- æ¯ç»„ç”Ÿæˆ3-8æ¡æ¨æ–‡ï¼Œå†…å®¹å¤šæ ·åŒ–
- çƒ­é—¨æ¨æ–‡5-12æ¡è¯„è®ºï¼Œæ™®é€šæ¨æ–‡1-5æ¡ï¼Œæ”¯æŒå¤šå±‚çº§æ¥¼ä¸­æ¥¼å›å¤
- **ç»‘å®šè§’è‰²å¯ä»¥ä½œä¸ºæ¨æ–‡å‘å¸ƒè€…**ï¼šæ ¹æ®è§’è‰²è®¾å®šå’Œå…´è¶£å‘å¸ƒç‹¬ç«‹æ¨æ–‡
- **ç»‘å®šNPCå¯ä»¥ä½œä¸ºæ¨æ–‡å‘å¸ƒè€…**ï¼šæ ¹æ®NPCäººè®¾å’Œå‘å¸–ä¹ æƒ¯å‘å¸ƒæ¨æ–‡
- NPCå…³ç³»äº’åŠ¨ï¼šæœ‰ç»‘å®šå…³ç³»çš„NPCåœ¨è§’è‰²æ¨æ–‡ä¸‹è‡ªç„¶ç•™è¨€ï¼Œä½“ç°å…³ç³»ç‰¹ç‚¹
- æ™®é€šç”¨æˆ·å¤´åƒç»Ÿä¸€ï¼šhttps://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg
- å¼•ç”¨æ¨æ–‡åŠŸèƒ½ï¼šçº¦20-30%çš„æ¨æ–‡å¯ä»¥ä½¿ç”¨å¼•ç”¨åŠŸèƒ½ï¼Œé€‚åˆè¡¨è¾¾è§‚ç‚¹ã€è¯„è®ºçƒ­ç‚¹ã€è½¬å‘æœ‰è¶£å†…å®¹

ã€æƒ…ä¾£å…³ç³»ä¸ç²‰ä¸ç¾¤ä½“è§„åˆ™ã€‘ï¼š
${
  userXProfileInfo.verificationType === 'couple' && userXProfileInfo.coupleCharacterName
    ? `- **æƒ…ä¾£å…³ç³»è‡ªç„¶åŒ–**ï¼šç”¨æˆ·ä¸${userXProfileInfo.coupleCharacterName}æ˜¯å…¬å¼€æƒ…ä¾£ï¼Œä½†è¿™æ˜¯ç§äººå…³ç³»
  - æƒ…ä¾£è§’è‰²å¯ä»¥å¶å°”å‡ºç°åœ¨æ¨æ–‡/è¯„è®ºä¸­ï¼Œä½†é¢‘ç‡è¦ä½ï¼ˆå»ºè®®10-20%æ¦‚ç‡ï¼‰ï¼Œä¿æŒè‡ªç„¶
  - æƒ…ä¾£äº’åŠ¨åº”è¯¥å›´ç»•æ¨æ–‡ä¸»é¢˜ï¼Œä¸è¦æ¯æ¬¡éƒ½å¼ºè°ƒæƒ…ä¾£èº«ä»½
  - ç²‰ä¸ç¾¤ä½“åˆ¤æ–­ï¼š
    * å¦‚æœç”¨æˆ·æˆ–æƒ…ä¾£è§’è‰²æœ‰æ˜æ˜Ÿ/ç½‘çº¢/å…¬ä¼—äººç‰©ç­‰èº«ä»½ â†’ å¯ä»¥ç”Ÿæˆå°‘é‡CPç²‰ä¸è¯„è®ºï¼ˆæœ€å¤š1-2æ¡ï¼‰
    * å¦‚æœéƒ½æ˜¯æ™®é€šäººèº«ä»½ â†’ ç¦æ­¢ç”Ÿæˆ"ç£•CP""å—‘ç³–"ç­‰ç²‰ä¸å‘è¯„è®ºï¼Œæ™®é€šæƒ…ä¾£ä¸ä¼šæœ‰ç²‰ä¸ç¾¤ä½“`
    : '- **æ™®é€šæƒ…ä¾£å…³ç³»**ï¼šå¦‚æœç”Ÿæˆæƒ…ä¾£å†…å®¹ï¼Œç¡®ä¿åªåœ¨é€‚åˆçš„åœºæ™¯ä¸‹å‡ºç°ï¼Œä¸”ä¸åº”æœ‰ç²‰ä¸ç¾¤ä½“'
}`;

      // 3. è§’è‰²èµ„æ–™ï¼ˆæ¨æ–‡å‘å¸ƒåœºæ™¯ï¼‰
      const charactersInfo = await StringBuilders.buildCompleteCharacterInfo(
        boundCharacters,
        userXProfileInfo,
        'tweet',
      );
      if (charactersInfo) {
        systemPrompt += charactersInfo;
      }

      // 3.5. NPCèµ„æ–™ï¼ˆç»‘å®šNPCä¿¡æ¯ï¼‰
      if (boundNPCs.length > 0) {
        systemPrompt += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ ç»‘å®šNPCèµ„æ–™
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»¥ä¸‹æ˜¯ä¸å½“å‰ç”¨æˆ·ç»‘å®šçš„NPCï¼Œä»–ä»¬å¯ä»¥åœ¨æ¨æ–‡ç”Ÿæˆä¸­ä½œä¸ºç‹¬ç«‹ç”¨æˆ·å‡ºç°ï¼š

`;
        for (const npc of boundNPCs) {
          systemPrompt += `
ã€NPCåŸºæœ¬ä¿¡æ¯ã€‘
- Xå§“åï¼š${npc.name}
- Xå¥æŸ„ï¼š${npc.handle}
- Xå¤´åƒï¼š${npc.avatar}
- è®¤è¯çŠ¶æ€ï¼šfalseï¼ˆNPCé»˜è®¤æ— è®¤è¯ï¼‰

ã€NPCäººè®¾ã€‘
${npc.personality || 'æš‚æ— äººè®¾æè¿°'}

ã€å‘å¸–ä¹ æƒ¯ã€‘
${npc.postingHabits || 'æš‚æ— å‘å¸–ä¹ æƒ¯æè¿°'}

ã€ä¸»é¡µå†…å®¹ã€‘
${npc.homepage || 'æš‚æ— ä¸»é¡µå†…å®¹è®¾ç½®'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;
        }

        systemPrompt += `
ã€NPCä½¿ç”¨è§„åˆ™ã€‘ï¼š
1. NPCå¯ä»¥ä½œä¸ºæ¨æ–‡å‘å¸ƒè€…ï¼Œç”Ÿæˆç¬¦åˆå…¶äººè®¾å’Œå‘å¸–ä¹ æƒ¯çš„æ¨æ–‡
2. NPCå¯ä»¥åœ¨è¯„è®ºåŒºå‡ºç°ï¼Œæ ¹æ®å…¶äººè®¾è¿›è¡Œäº’åŠ¨
3. NPCçš„å†…å®¹åº”è¯¥å›´ç»•å…¶äººè®¾å’Œä¸»é¡µå†…å®¹å±•å¼€
4. NPCä¸è§’è‰²/ç”¨æˆ·çš„äº’åŠ¨åº”è¯¥è‡ªç„¶ï¼Œä¸è¦è¿‡äºé¢‘ç¹
5. ä¸¥æ ¼ä½¿ç”¨NPCçš„Xå§“å(${boundNPCs.map(n => n.name).join('ã€')})ã€å¥æŸ„(${boundNPCs.map(n => n.handle).join('ã€')})å’Œå¤´åƒ
6. NPCè®¤è¯çŠ¶æ€å›ºå®šä¸º false
`;
      }

      // 4. ç”¨æˆ·èµ„æ–™
      systemPrompt += StringBuilders.buildUniversalConstraints(userXProfileInfo);

      systemPrompt += `

ã€JSONè¿”å›æ ¼å¼ã€‘ï¼š
\`\`\`json
{"forYouTweets": [æ¨æ–‡æ•°ç»„], "followingTweets": [æ¨æ–‡æ•°ç»„]}
\`\`\`

æ¨æ–‡å¯¹è±¡ç»“æ„ï¼š
- user: {name, handle, avatar, verified}
- content: æ¨æ–‡æ–‡æœ¬
- time: æ—¶é—´æè¿°
- stats: {comments, retweets, likes, views} (çº¯æ•°å­—)
- media: [{type:"description", description:"æ–‡å­—æè¿°ï¼Œè‡³å°‘30å­—"}] (å¯é€‰)
- quotedTweet: {type, user, content, time} (å¯é€‰ï¼Œçº¦20-30%æ¨æ–‡ä½¿ç”¨)
- comments: [è¯„è®ºæ•°ç»„] (3-8æ¡çƒ­é—¨æ¨æ–‡ï¼Œ1-4æ¡æ™®é€šæ¨æ–‡)

è¯„è®ºå¯¹è±¡ç»“æ„ï¼š
- user: {name, handle, avatar, verified}
- content: è¯„è®ºæ–‡æœ¬
- time: æ—¶é—´æè¿°  
- replies: [å›å¤æ•°ç»„] (å¯é€‰ï¼Œæ”¯æŒå¤šå±‚çº§ä½†ä¸è¶…è¿‡3å±‚)
- replyTo: "@è¢«å›å¤è€…å¥æŸ„" (æ¥¼ä¸­æ¥¼å›å¤æ—¶å¿…å¡«)

å…³é”®è§„åˆ™ï¼š
1. verifiedå­—æ®µå¿…é¡»æ˜¯å¸ƒå°”å€¼(true/false)
2. statsä¸­æ‰€æœ‰æ•°å­—å¿…é¡»æ˜¯çº¯æ•°å­—ï¼Œä¸å¸¦å¼•å·
3. å¯é€‰å­—æ®µä¸ä½¿ç”¨æ—¶å®Œå…¨çœç•¥ï¼Œä¸è¦è®¾ä¸ºnull
4. contentç›´æ¥å†™å†…å®¹ï¼Œä¸ç”¨å¼•å·åŒ…è£¹`;

      const messages = [{ role: 'user', content: 'è¯·ç”Ÿæˆæ–°çš„Xç¤¾äº¤å¹³å°æ¨æ–‡æ•°æ®' }];

      // åˆ¤æ–­APIç±»å‹å¹¶å‘é€è¯·æ±‚
      let isGemini = proxyUrl.includes('generativelanguage');
      let response;

      if (isGemini) {
        // ä¸ºXç¤¾äº¤é¡µé¢åˆ›å»ºæ­£ç¡®çš„Geminiè¯·æ±‚é…ç½®
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
        const geminiConfig = {
          url: `${GEMINI_API_URL}/${model}:generateContent?key=${getRandomValue(apiKey)}`,
          data: {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: systemPrompt + '\n\n' + messages.map(m => m.content).join('\n'),
                    },
                  ],
                },
              ],
              generationConfig: {
                temperature: 0.8,
              },
            }),
          },
        };
        response = await fetch(geminiConfig.url, geminiConfig.data);
      } else {
        const openAiPayload = {
          model: model,
          messages: [{ role: 'system', content: systemPrompt }, ...messages],
          temperature: 0.8,
          stream: false,
        };
        response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify(openAiPayload),
        });
      }

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`APIé”™è¯¯: ${response.status} - ${errorData.error?.message || response.statusText}`);
      }

      const data = await response.json();
      let aiResponseContent;

      if (isGemini) {
        aiResponseContent = getGeminiResponseText(data);
      } else {
        // OpenAIæ ¼å¼
        aiResponseContent = data.choices?.[0]?.message?.content || '';
      }

      console.log('AIåŸå§‹å“åº”:', aiResponseContent);

      // è§£æAIè¿”å›çš„JSONæ•°æ®
      const cleanedResponse = aiResponseContent
        .replace(/```json\s*/i, '')
        .replace(/```\s*$/, '')
        .trim();

      if (!cleanedResponse) {
        throw new Error('AIè¿”å›äº†ç©ºçš„å“åº”å†…å®¹');
      }

      let newTweetsData;
      try {
        newTweetsData = JSON.parse(cleanedResponse);
      } catch (parseError) {
        console.error('JSONè§£æå¤±è´¥:', parseError);
        console.error('å°è¯•è§£æçš„å†…å®¹:', cleanedResponse.substring(0, 500) + '...');
        throw new Error(`AIè¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼: ${parseError.message}`);
      }

      // éªŒè¯æ•°æ®æ ¼å¼
      if (!newTweetsData.forYouTweets || !newTweetsData.followingTweets) {
        throw new Error('AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘å¿…è¦å­—æ®µ');
      }

      // ä¸ºæ¨æ–‡æ·»åŠ å¿…è¦çš„IDå’Œæ ¼å¼åŒ–
      const processTweets = tweets => {
        return tweets.map(tweet => {
          // ç¡®ä¿statså­—æ®µå­˜åœ¨
          if (!tweet.stats) {
            tweet.stats = {
              comments: tweet.comments?.length || 0,
              retweets: 0,
              likes: 0,
              views: 0,
            };
          }

          // å¤„ç†è¯„è®ºæ•°æ®ï¼Œæ·»åŠ ID
          if (tweet.comments) {
            tweet.comments = tweet.comments.map(comment => {
              const processedComment = {
                ...comment,
                id: `c_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
              };

              // å¤„ç†å›å¤æ•°æ®
              if (comment.replies) {
                processedComment.replies = comment.replies.map(reply => ({
                  ...reply,
                  id: `r_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                }));
              }

              return processedComment;
            });
          }

          return tweet;
        });
      };

      newTweetsData.forYouTweets = processTweets(newTweetsData.forYouTweets);
      newTweetsData.followingTweets = processTweets(newTweetsData.followingTweets);

      // ä¸ºæ¨æ–‡åˆ†é…ID
      const timestamp = Date.now();
      newTweetsData.forYouTweets.forEach((tweet, index) => {
        tweet.id = `fy_${timestamp}_${index}`;
      });

      newTweetsData.followingTweets.forEach((tweet, index) => {
        tweet.id = `fl_${timestamp}_${index}`;
      });

      // æ›´æ–°å…¨å±€æ•°æ®
      forYouTweets.length = 0;
      followingTweets.length = 0;
      forYouTweets.push(...newTweetsData.forYouTweets);
      followingTweets.push(...newTweetsData.followingTweets);

      // ä¿å­˜æ¨æ–‡æ•°æ®åˆ°æ•°æ®åº“
      try {
        await xDb.xTweetsData.put({
          id: 'tweets',
          forYouTweets: newTweetsData.forYouTweets,
          followingTweets: newTweetsData.followingTweets,
          lastUpdated: new Date().toISOString(),
        });
      } catch (saveError) {
        console.error('ä¿å­˜æ¨æ–‡æ•°æ®å¤±è´¥:', saveError);
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰äºº@ç”¨æˆ·
      const userHandle = userXProfileInfo.handle;
      let mentionFound = false;

      // æ£€æŸ¥"ä¸ºä½ æ¨è"ä¸­çš„æ¨æ–‡å’Œè¯„è®º
      for (const tweet of newTweetsData.forYouTweets) {
        if (tweet.content && tweet.content.includes(userHandle)) {
          mentionFound = true;
          break;
        }
        if (tweet.comments) {
          for (const comment of tweet.comments) {
            if (comment.content && comment.content.includes(userHandle)) {
              mentionFound = true;
              break;
            }

            // æ£€æŸ¥å›å¤ä¸­çš„å†…å®¹
            if (comment.replies) {
              for (const reply of comment.replies) {
                if (reply.content && reply.content.includes(userHandle)) {
                  mentionFound = true;
                  break;
                }
              }
            }
            if (mentionFound) break;
          }
        }
        if (mentionFound) break;
      }

      // æ£€æŸ¥"æ­£åœ¨å…³æ³¨"ä¸­çš„æ¨æ–‡å’Œè¯„è®º
      if (!mentionFound) {
        for (const tweet of newTweetsData.followingTweets) {
          if (tweet.content && tweet.content.includes(userHandle)) {
            mentionFound = true;
            break;
          }
          if (tweet.comments) {
            for (const comment of tweet.comments) {
              if (comment.content && comment.content.includes(userHandle)) {
                mentionFound = true;
                break;
              }
              // æ£€æŸ¥å›å¤ä¸­çš„å†…å®¹
              if (comment.replies) {
                for (const reply of comment.replies) {
                  if (reply.content && reply.content.includes(userHandle)) {
                    mentionFound = true;
                    break;
                  }
                }
              }
              if (mentionFound) break;
            }
          }
          if (mentionFound) break;
        }
      }

      // é‡æ–°æ¸²æŸ“é¡µé¢
      renderTweets(forYouTweets, 'for-you-content');
      renderTweets(followingTweets, 'following-content');

      // æ˜¾ç¤ºç›¸åº”çš„æé†’æ¶ˆæ¯
      if (mentionFound) {
        showXToast('æ¨æ–‡å·²åˆ·æ–°ï¼æœ‰äººæåˆ°ä½ äº†å“¦ ğŸ””', 'success');
      } else {
        showXToast('æ¨æ–‡å·²åˆ·æ–°ï¼', 'success');
      }
    } catch (error) {
      console.error('åˆ·æ–°æ¨æ–‡å¤±è´¥:', error);
      showXToast(`åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
    } finally {
      // åœæ­¢æ—‹è½¬åŠ¨ç”»
      refreshBtn.style.animation = '';
      if (spinStyle.parentNode) {
        spinStyle.remove();
      }
    }
  }
  // â–²â–²â–² ã€ä¸»è¦ï¼ï¼ï¼ã€‘ç¬¬ä¸€ä¸ªæƒ…æ™¯ï¼šæ¨æ–‡ç”Ÿæˆå™¨ â–²â–²â–²

  // â–¼â–¼â–¼ ã€ä¸»è¦ï¼ï¼ï¼ã€‘ç¬¬ä¸ƒä¸ªæƒ…æ™¯ï¼šè´¦æˆ·ä¸»é¡µç”Ÿæˆå™¨ â–¼â–¼â–¼
  // å½“å‰æŸ¥çœ‹çš„è´¦æˆ·æ•°æ®
  let currentViewingAccount = null;

  // æ‰“å¼€è´¦æˆ·ä¸»é¡µ
  window.openAccountProfile = async function (accountName, accountHandle, accountAvatar) {
    try {
      console.log(`ğŸ” æ­£åœ¨æ‰“å¼€è´¦æˆ·ä¸»é¡µ: ${accountName} (${accountHandle})`);

      // å…ˆæ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰å·²ä¿å­˜çš„è´¦æˆ·ä¸»é¡µæ•°æ®
      const xDB = getXDB();
      const cleanHandle = accountHandle.replace('@', '');
      const savedProfile = await xDB.xAccountProfiles.get(cleanHandle);

      if (savedProfile) {
        console.log('âœ… æ‰¾åˆ°å·²ä¿å­˜çš„è´¦æˆ·ä¸»é¡µæ•°æ®ï¼Œç›´æ¥åŠ è½½');
        currentViewingAccount = savedProfile;
        renderAccountProfile(savedProfile);
        return;
      }

      // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼ŒæŸ¥è¯¢è´¦æˆ·æ•°æ®
      const accountData = await queryAccountData(accountName, accountHandle, accountAvatar);

      if (!accountData) {
        showXToast('æ— æ³•åŠ è½½è´¦æˆ·ä¿¡æ¯', 'error');
        return;
      }

      // ä¿å­˜å½“å‰æŸ¥çœ‹çš„è´¦æˆ·
      currentViewingAccount = accountData;

      // å¦‚æœæœ‰å®Œæ•´çš„ä¸»é¡µæ•°æ®ï¼Œç›´æ¥æ˜¾ç¤º
      if (accountData.tweets && accountData.tweets.length > 0) {
        renderAccountProfile(accountData);
        return;
      }

      // å¦åˆ™ï¼Œè°ƒç”¨AIç”Ÿæˆè´¦æˆ·ä¸»é¡µå†…å®¹
      showXToast('æ­£åœ¨ç”Ÿæˆè´¦æˆ·ä¸»é¡µ...', 'info');
      const profileData = await generateAccountProfileContent(accountData);

      if (profileData) {
        // æ›´æ–°è´¦æˆ·æ•°æ®
        currentViewingAccount = { ...accountData, ...profileData };
        renderAccountProfile(currentViewingAccount);

        // ä¿å­˜åˆ°æ•°æ®åº“
        await saveAccountProfile(currentViewingAccount);
        showXToast('è´¦æˆ·ä¸»é¡µå·²ç”Ÿæˆå¹¶ä¿å­˜', 'success');
      }
    } catch (error) {
      console.error('æ‰“å¼€è´¦æˆ·ä¸»é¡µå¤±è´¥:', error);
      showXToast(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
    }
  };

  // æŸ¥è¯¢è´¦æˆ·æ•°æ®ï¼ˆåˆ¤æ–­æ˜¯è§’è‰²/NPC/æœªçŸ¥è´¦æˆ·ï¼‰
  async function queryAccountData(accountName, accountHandle, accountAvatar) {
    const mainDB = getDB();
    const xDB = getXDB();

    // 1. æ£€æŸ¥æ˜¯å¦æ˜¯ç»‘å®šçš„è§’è‰²
    const allChats = await mainDB.chats.toArray();
    const allXProfiles = await xDB.xCharacterProfiles.toArray();

    for (const xProfile of allXProfiles) {
      if (xProfile.xHandle === accountHandle || xProfile.xName === accountName) {
        // æ‰¾åˆ°å¯¹åº”çš„è§’è‰²æ•°æ®
        const character = allChats.find(chat => chat.id === xProfile.characterId);
        if (character) {
          console.log('âœ… è¯†åˆ«ä¸ºè§’è‰²è´¦æˆ·:', accountName);
          return {
            accountType: 'character',
            name: xProfile.xName,
            handle: xProfile.xHandle,
            avatar: xProfile.xAvatar,
            verified: xProfile.xVerified || false,
            cover: xProfile.xCover || 'https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg',
            bio: xProfile.xBio || '',
            publicIdentity: xProfile.publicIdentity || '',
            customTag1: xProfile.customTag1 || null,
            customTag2: xProfile.customTag2 || null,
            followingCount: xProfile.followingCount || '',
            followersCount: xProfile.followersCount || '',
            personality: character.settings.aiPersona || '',
            characterData: character,
            xProfileData: xProfile,
          };
        }
      }
    }

    // 2. æ£€æŸ¥æ˜¯å¦æ˜¯ç»‘å®šçš„NPC
    const npcDataId = 'xNPCs_global';
    const npcData = await xDB.xNPCs.get(npcDataId);
    const allNPCs = npcData?.npcs || [];

    for (const npc of allNPCs) {
      if (npc.handle === accountHandle || npc.name === accountName) {
        console.log('âœ… è¯†åˆ«ä¸ºNPCè´¦æˆ·:', accountName);
        return {
          accountType: 'npc',
          name: npc.name,
          handle: npc.handle,
          avatar: npc.avatar,
          verified: false,
          cover: 'https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg',
          bio: '',
          publicIdentity: '',
          customTag1: null,
          customTag2: null,
          followingCount: '',
          followersCount: '',
          personality: npc.personality || '',
          postingHabits: npc.postingHabits || '',
          homepage: npc.homepage || '',
          npcData: npc,
        };
      }
    }

    // 3. æœªçŸ¥è´¦æˆ·
    console.log('âš ï¸ æœªçŸ¥è´¦æˆ·ï¼Œå°†æ ¹æ®åŸºæœ¬ä¿¡æ¯ç”Ÿæˆ:', accountName);
    return {
      accountType: 'unknown',
      name: accountName,
      handle: accountHandle,
      avatar: accountAvatar,
      verified: false,
      cover: 'https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg',
      bio: '',
      publicIdentity: '',
      customTag1: null,
      customTag2: null,
      followingCount: '',
      followersCount: '',
    };
  }

  // è°ƒç”¨AIç”Ÿæˆè´¦æˆ·ä¸»é¡µå†…å®¹
  async function generateAccountProfileContent(accountData) {
    try {
      const db = getDB();
      const xDb = getXDB();

      // è·å–APIé…ç½®
      const apiConfig = await db.apiConfig.get('main');
      if (!apiConfig || !apiConfig.proxyUrl || !apiConfig.apiKey || !apiConfig.model) {
        showXToast('è¯·å…ˆé…ç½®APIè®¾ç½®', 'error');
        return null;
      }

      const { proxyUrl, apiKey, model } = apiConfig;

      // è·å–Xè®¾ç½®
      const settingsId = `xSettings_${currentAccountId || 'main'}`;
      const xSettings = await xDb.xSettings.get(settingsId);
      const userPrompt = xSettings?.systemPrompt || '';
      const worldSetting = xSettings?.worldSetting || '';

      // æ„å»ºç”¨æˆ·Xèµ„æ–™ä¿¡æ¯
      const userXProfileInfo = StringBuilders.buildUserXProfileInfo(window.userProfileData);

      // â–¼â–¼â–¼ æ„å»ºSystemPrompt â–¼â–¼â–¼
      // 1. æç¤ºè¯ + ä¸–ç•Œä¹¦
      let systemPrompt = StringBuilders.buildBaseSystemPrompt({ userPrompt, worldSetting });

      // 2. æ ¸å¿ƒä»»åŠ¡è¯´æ˜
      systemPrompt += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ æ ¸å¿ƒä»»åŠ¡ï¼šç”Ÿæˆè´¦æˆ·ä¸»é¡µå†…å®¹ ğŸ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä½ éœ€è¦ä¸ºXå¹³å°è´¦æˆ·ç”Ÿæˆä¸»é¡µå±•ç¤ºå†…å®¹ï¼ŒåŒ…æ‹¬ï¼š
- è´¦æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆè‹¥å·²æä¾›åˆ™ä¸¥æ ¼ä½¿ç”¨ï¼Œä¸å¯ä¿®æ”¹ï¼‰
- æœ€è¿‘å‘å¸ƒçš„æ¨æ–‡ï¼ˆ3-5æ¡ï¼‰
- æ¨æ–‡ä¸‹çš„è¯„è®ºäº’åŠ¨

**ç”ŸæˆåŸåˆ™**ï¼š
- å¦‚æœæ˜¯å·²çŸ¥è§’è‰²è´¦æˆ·ï¼Œå¿…é¡»ä¸¥æ ¼éµå¾ªå…¶Xèµ„æ–™è®¾å®š
- å¦‚æœæ˜¯NPCè´¦æˆ·ï¼Œå¿…é¡»ä¸¥æ ¼éµå¾ªå…¶äººè®¾å’Œå‘å¸–ä¹ æƒ¯
- å¦‚æœæ˜¯æœªçŸ¥è´¦æˆ·ï¼Œæ ¹æ®æ˜µç§°ã€å¥æŸ„ã€ç®€ä»‹è¿›è¡Œåˆç†æ¨æ–­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;

      // 3. ç›®æ ‡è´¦æˆ·ä¿¡æ¯
      systemPrompt += `

ã€ç›®æ ‡è´¦æˆ·ä¿¡æ¯ã€‘ï¼š
- Xå§“åï¼š${accountData.name}
- Xå¥æŸ„ï¼š${accountData.handle}
- Xå¤´åƒï¼š${accountData.avatar}
- è®¤è¯çŠ¶æ€ï¼š${accountData.verified ? 'æ˜¯' : 'å¦'}
${accountData.bio ? `- Xç®€ä»‹ï¼š${accountData.bio}` : ''}
${accountData.publicIdentity ? `- å…¬ä¼—èº«ä»½ï¼š${accountData.publicIdentity}` : ''}
${accountData.personality ? `- äººè®¾æè¿°ï¼š${accountData.personality}` : ''}
${accountData.postingHabits ? `- å‘å¸–ä¹ æƒ¯ï¼š${accountData.postingHabits}` : ''}
${accountData.cover ? `- èƒŒæ™¯å›¾ï¼š${accountData.cover}` : ''}
${
  accountData.customTag1
    ? `- è‡ªå®šä¹‰æ ‡ç­¾1ï¼š${accountData.customTag1.icon} ${accountData.customTag1.text} (${accountData.customTag1.color})`
    : ''
}
${
  accountData.customTag2
    ? `- è‡ªå®šä¹‰æ ‡ç­¾2ï¼š${accountData.customTag2.icon} ${accountData.customTag2.text} (${accountData.customTag2.color})`
    : ''
}
${accountData.followingCount ? `- æ­£åœ¨å…³æ³¨ï¼š${accountData.followingCount}` : ''}
${accountData.followersCount ? `- å…³æ³¨è€…ï¼š${accountData.followersCount}` : ''}
`;

      // 4. è´¦æˆ·ç±»å‹ç‰¹å®šè¦æ±‚
      if (accountData.accountType === 'character') {
        systemPrompt += `

ã€è§’è‰²è´¦æˆ·ç‰¹æ®Šè¦æ±‚ã€‘ï¼š
- **ä¸¥æ ¼éµå®ˆ**ï¼šæ‰€æœ‰å·²æä¾›çš„Xèµ„æ–™ä¿¡æ¯å¿…é¡»å®Œå…¨ä¸€è‡´ï¼Œä¸å¾—ä¿®æ”¹
- æ¨æ–‡å†…å®¹è¦ç¬¦åˆè§’è‰²äººè®¾å’Œæ€§æ ¼ç‰¹ç‚¹
- è¯„è®ºäº’åŠ¨è¦ä½“ç°è§’è‰²çš„ç¤¾äº¤é£æ ¼
- å¦‚æœ‰NPCå…³ç³»ï¼Œå¯åœ¨æ¨æ–‡/è¯„è®ºä¸­è‡ªç„¶ä½“ç°`;
      } else if (accountData.accountType === 'npc') {
        systemPrompt += `

ã€NPCè´¦æˆ·ç‰¹æ®Šè¦æ±‚ã€‘ï¼š
- **ä¸¥æ ¼éµå®ˆ**ï¼šä½¿ç”¨NPCçš„å§“åã€å¥æŸ„ã€å¤´åƒã€äººè®¾
- æ¨æ–‡å†…å®¹ç¬¦åˆNPCçš„å‘å¸–ä¹ æƒ¯å’Œä¸»é¡µå†…å®¹è®¾ç½®
- è¯„è®ºäº’åŠ¨ç¬¦åˆNPCçš„æ€§æ ¼ç‰¹ç‚¹`;
      } else {
        systemPrompt += `

ã€æœªçŸ¥è´¦æˆ·ç”Ÿæˆè¦æ±‚ã€‘ï¼š
- æ ¹æ®æä¾›çš„æ˜µç§°ã€å¥æŸ„ã€ç®€ä»‹æ¨æ–­è´¦æˆ·ç‰¹ç‚¹
- ç”Ÿæˆåˆç†çš„æ¨æ–‡å†…å®¹å’Œäº’åŠ¨é£æ ¼
- ä¿æŒè´¦æˆ·èº«ä»½çš„ä¸€è‡´æ€§`;
      }

      // 5. ç”¨æˆ·èµ„æ–™çº¦æŸ
      systemPrompt += StringBuilders.buildUniversalConstraints(userXProfileInfo);

      // 6. JSONè¿”å›æ ¼å¼
      systemPrompt += `

ã€JSONè¿”å›æ ¼å¼ã€‘ï¼š
\`\`\`json
{"accountInfo": {...}, "tweets": [æ¨æ–‡æ•°ç»„]}
\`\`\`

accountInfoå¯¹è±¡ç»“æ„ï¼š
- name, handle, avatar, verified (å·²æä¾›çš„å¿…é¡»å®Œå…¨ä¸€è‡´)
- verificationType: "verified" | "couple" (å½“è´¦æˆ·æœ‰æƒ…ä¾£å…³ç³»æ—¶ä½¿ç”¨"couple"ï¼Œæ˜¾ç¤ºå¿ƒå½¢è®¤è¯å›¾æ ‡)
- cover, bio (å¯è¡¥å……)
- customTag1/2: {icon, text, color} (å¯é€‰)
- followingCount, followersCount (å¯è¡¥å……)

tweetsæ•°ç»„ï¼ˆ3-5æ¡ï¼‰ï¼š
- user: {name, handle, avatar, verified, verificationType}
- content: æ¨æ–‡æ–‡æœ¬
- time: æ—¶é—´æè¿°
- stats: {comments, retweets, likes, views} (çº¯æ•°å­—)
- media: [{type:"description", description:"å›¾ç‰‡æè¿°"}] (å¯é€‰)
- comments: [è¯„è®ºæ•°ç»„] (0-3æ¡)
- pinned: true/false (å¯é€‰ï¼Œç¬¬ä¸€æ¡æ¨æ–‡å¯ç½®é¡¶ï¼Œæ˜¾ç¤º"å·²ç½®é¡¶"æ ‡è¯†)

è¯„è®ºå¯¹è±¡ç»“æ„ï¼š
- user: {name, handle, avatar, verified}
- content: è¯„è®ºæ–‡æœ¬
- time: æ—¶é—´æè¿°

å…³é”®è§„åˆ™ï¼š
1. accountInfoå·²æä¾›å­—æ®µå¿…é¡»ä¸è¾“å…¥å®Œå…¨ä¸€è‡´ï¼Œä¸å¾—ä¿®æ”¹
2. æœªæä¾›å­—æ®µç”±AIåˆç†è¡¥å……
3. verifiedå¿…é¡»æ˜¯å¸ƒå°”å€¼(true/false)
4. å¦‚æœè¯¥è´¦æˆ·åœ¨è§’è‰²Xèµ„æ–™æˆ–NPCè®¾ç½®ä¸­æ ‡æ³¨ä¸ºæƒ…ä¾£å…³ç³»ï¼Œå¿…é¡»è®¾ç½®verificationTypeä¸º"couple"
5. å»ºè®®å°†æœ€é‡è¦æˆ–æœ€æ–°çš„ä¸€æ¡æ¨æ–‡è®¾ç½®ä¸ºpinned: trueï¼ˆç½®é¡¶ï¼‰
6. statsæ‰€æœ‰æ•°å­—å¿…é¡»æ˜¯çº¯æ•°å­—ï¼Œä¸å¸¦å¼•å·
7. å¯é€‰å­—æ®µä¸ä½¿ç”¨æ—¶å®Œå…¨çœç•¥
8. æ™®é€šç”¨æˆ·å¤´åƒï¼šhttps://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg
9. é»˜è®¤èƒŒæ™¯å›¾ï¼šhttps://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg`;
      // â–²â–²â–² æ„å»ºSystemPrompt â–²â–²â–²

      const messages = [{ role: 'user', content: `è¯·ç”Ÿæˆè´¦æˆ· ${accountData.name} (${accountData.handle}) çš„ä¸»é¡µå†…å®¹` }];

      // åˆ¤æ–­APIç±»å‹å¹¶å‘é€è¯·æ±‚
      let isGemini = proxyUrl.includes('generativelanguage');
      let response;

      if (isGemini) {
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
        const geminiConfig = {
          url: `${GEMINI_API_URL}/${model}:generateContent?key=${getRandomValue(apiKey)}`,
          data: {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: systemPrompt + '\n\n' + messages.map(m => m.content).join('\n'),
                    },
                  ],
                },
              ],
              generationConfig: {
                temperature: 0.7,
              },
            }),
          },
        };
        response = await fetch(geminiConfig.url, geminiConfig.data);
      } else {
        const openAiPayload = {
          model: model,
          messages: [{ role: 'system', content: systemPrompt }, ...messages],
          temperature: 0.7,
          stream: false,
        };
        response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify(openAiPayload),
        });
      }

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`APIé”™è¯¯: ${response.status} - ${errorData.error?.message || response.statusText}`);
      }

      const data = await response.json();
      let aiResponseContent;

      if (isGemini) {
        aiResponseContent = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      } else {
        aiResponseContent = data.choices?.[0]?.message?.content || '';
      }

      console.log('AIåŸå§‹å“åº”:', aiResponseContent);

      // è§£æAIè¿”å›çš„JSONæ•°æ®
      const cleanedResponse = aiResponseContent
        .replace(/```json\s*/i, '')
        .replace(/```\s*$/, '')
        .trim();

      if (!cleanedResponse) {
        throw new Error('AIè¿”å›äº†ç©ºçš„å“åº”å†…å®¹');
      }

      let profileData;
      try {
        profileData = JSON.parse(cleanedResponse);
      } catch (parseError) {
        console.error('JSONè§£æå¤±è´¥:', parseError);
        console.error('å°è¯•è§£æçš„å†…å®¹:', cleanedResponse.substring(0, 500) + '...');
        throw new Error(`AIè¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼: ${parseError.message}`);
      }

      // éªŒè¯æ•°æ®æ ¼å¼
      if (!profileData.accountInfo || !profileData.tweets) {
        throw new Error('AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
      }

      showXToast('è´¦æˆ·ä¸»é¡µå·²ç”Ÿæˆ', 'success');
      return profileData;
    } catch (error) {
      console.error('ç”Ÿæˆè´¦æˆ·ä¸»é¡µå†…å®¹å¤±è´¥:', error);
      showXToast(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
      return null;
    }
  }

  // æ¸²æŸ“è´¦æˆ·ä¸»é¡µ
  function renderAccountProfile(accountData) {
    console.log('æ¸²æŸ“è´¦æˆ·ä¸»é¡µ:', accountData);

    // å¡«å……è´¦æˆ·ä¿¡æ¯
    const accountInfo = accountData.accountInfo || accountData;

    // è®¾ç½®å¯¼èˆªæ æ ‡é¢˜å’Œæ¨æ–‡æ•°
    document.getElementById('account-profile-nav-name').textContent = accountInfo.name || accountData.name;
    const tweetCount = (accountData.tweets && accountData.tweets.length) || 0;
    document.getElementById('account-profile-nav-count').textContent = `${DataUtils.formatNumber(tweetCount)} ä¸ªå¸–å­`;

    // è®¾ç½®èƒŒæ™¯å›¾
    const coverImage = document.getElementById('account-cover-image');
    coverImage.style.backgroundImage = `url('${
      accountInfo.cover || accountData.cover || 'https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg'
    }')`;

    // è®¾ç½®å¤´åƒ
    document.getElementById('account-avatar-image').src = accountInfo.avatar || accountData.avatar;

    // è®¾ç½®åç§°
    document.getElementById('account-display-name').textContent = accountInfo.name || accountData.name;

    // è®¾ç½®è®¤è¯å¾½ç« ï¼ˆæ ¹æ®è®¤è¯ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡ï¼‰
    const verifiedBadge = document.getElementById('account-verified-badge');
    const verificationType = accountInfo.verificationType || accountData.verificationType || 'verified';

    if (accountInfo.verified || accountData.verified) {
      // æƒ…ä¾£è®¤è¯ä½¿ç”¨å¿ƒå½¢å›¾æ ‡
      if (verificationType === 'couple') {
        verifiedBadge.innerHTML = `
          <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
            <g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>
          </svg>
        `;
      } else {
        // é»˜è®¤è“è‰²å‹¾æ ‡
        verifiedBadge.innerHTML = `
          <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #1d9bf0;">
            <g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g>
          </svg>
        `;
      }
      verifiedBadge.style.display = 'inline-flex';
      verifiedBadge.style.alignItems = 'center';
    } else {
      verifiedBadge.style.display = 'none';
    }

    // è®¾ç½®å¥æŸ„ï¼ˆæ·»åŠ @å‰ç¼€ï¼‰
    const handle = accountInfo.handle || accountData.handle;
    document.getElementById('account-handle-text').textContent = handle.startsWith('@') ? handle : `@${handle}`;

    // è®¾ç½®ç®€ä»‹
    const bioElement = document.getElementById('account-bio-text');
    if (accountInfo.bio || accountData.bio) {
      bioElement.textContent = accountInfo.bio || accountData.bio;
      bioElement.style.display = 'block';
    } else {
      bioElement.style.display = 'none';
    }

    // è®¾ç½®è‡ªå®šä¹‰æ ‡ç­¾
    const tagsContainer = document.getElementById('account-tags-container');
    tagsContainer.innerHTML = '';

    const customTag1 = accountInfo.customTag1 || accountData.customTag1;
    const customTag2 = accountInfo.customTag2 || accountData.customTag2;

    if (customTag1 && customTag1.text) {
      const tag1 = document.createElement('div');
      tag1.style.cssText = `display: flex; align-items: center; gap: 4px; color: ${
        customTag1.color || '#71767b'
      }; font-size: 15px;`;
      tag1.innerHTML = `<span>${customTag1.icon || ''}</span><span>${customTag1.text}</span>`;
      tagsContainer.appendChild(tag1);
    }

    if (customTag2 && customTag2.text) {
      const tag2 = document.createElement('div');
      tag2.style.cssText = `display: flex; align-items: center; gap: 4px; color: ${
        customTag2.color || '#71767b'
      }; font-size: 15px;`;
      tag2.innerHTML = `<span>${customTag2.icon || ''}</span><span>${customTag2.text}</span>`;
      tagsContainer.appendChild(tag2);
    }

    // è®¾ç½®å…³æ³¨æ•°æ®
    document.getElementById('account-following-count').textContent =
      accountInfo.followingCount || accountData.followingCount || '0';
    document.getElementById('account-followers-count').textContent =
      accountInfo.followersCount || accountData.followersCount || '0';

    // æ¸²æŸ“æ¨æ–‡
    const tweetsContainer = document.getElementById('account-tweets-container');
    tweetsContainer.innerHTML = '';

    if (accountData.tweets && accountData.tweets.length > 0) {
      accountData.tweets.forEach(tweet => {
        const tweetElement = createAccountTweetElement(tweet, accountInfo);
        tweetsContainer.appendChild(tweetElement);
      });
    } else {
      tweetsContainer.innerHTML =
        '<div style="padding: 40px; text-align: center; color: #71767b;">è¯¥è´¦æˆ·è¿˜æ²¡æœ‰å‘å¸ƒæ¨æ–‡</div>';
    }

    // æ˜¾ç¤ºè´¦æˆ·ä¸»é¡µ
    document.querySelectorAll('.x-page').forEach(page => (page.style.display = 'none'));
    document.getElementById('account-profile-page').style.display = 'flex';

    showXToast(`å·²åŠ è½½ ${accountInfo.name || accountData.name} çš„ä¸»é¡µ`, 'success');
  }

  // åˆ›å»ºè´¦æˆ·æ¨æ–‡å…ƒç´ ï¼ˆæŒ‰å›¾ç‰‡æ ·å¼è®¾è®¡ï¼‰
  function createAccountTweetElement(tweet, accountInfo) {
    const tweetEl = document.createElement('div');
    tweetEl.style.cssText = 'border-bottom: 1px solid #2f3336;';

    const user = tweet.user || accountInfo;
    const isPinned = tweet.pinned || false;

    // æ„å»ºè®¤è¯å›¾æ ‡HTML
    let verifiedBadgeHtml = '';
    if (user.verified) {
      if (user.verificationType === 'couple') {
        verifiedBadgeHtml =
          '<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;"><g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g></svg>';
      } else {
        verifiedBadgeHtml =
          '<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #1d9bf0;"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>';
      }
    }

    tweetEl.innerHTML = `
      ${
        isPinned
          ? `
        <div style="padding: 12px 16px 0; display: flex; align-items: center; gap: 12px;">
          <div style="width: 40px; display: flex; justify-content: flex-end;">
            <svg viewBox="0 0 32 32" style="width: 16px; height: 16px; fill: #71767b;">
              <path d="M20.743 14.815l-0.933-12.065h5.191c0.414 0 0.75-0.336 0.75-0.75s-0.336-0.75-0.75-0.75v0h-18c-0.414 0-0.75 0.336-0.75 0.75s0.336 0.75 0.75 0.75v0h5.432l-1.275 12.103c-3.213 0.959-5.574 3.738-5.904 7.113l-0.003 0.034c0 0.414 0.336 0.75 0.75 0.75h9.25v7.25c0 0.414 0.336 0.75 0.75 0.75s0.75-0.336 0.75-0.75v0-7.25h9.25c0.414-0 0.75-0.336 0.75-0.75v0c0-3.017-2.35-5.787-6.007-7.185zM12.104 16.081c0.096-0.035 0.179-0.085 0.249-0.148l-0.001 0.001 0.005-0.003c0.126-0.117 0.211-0.275 0.233-0.453l0-0.004 0.011-0.022 1.337-12.701h4.367l0.979 12.681c0.033 0.35 0.303 0.627 0.647 0.67l0.004 0c2.542 0.682 4.512 2.623 5.222 5.096l0.013 0.052h-18.341c0.729-2.54 2.714-4.49 5.222-5.157l0.052-0.012z"></path>
            </svg>
          </div>
          <span style="color: #71767b; font-size: 13px; font-weight: 700;">å·²ç½®é¡¶</span>
        </div>
      `
          : ''
      }
      <div style="padding: 12px 16px; display: flex; gap: 12px; position: relative;">
        <img src="${user.avatar}" alt="${
      user.name
    }" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;">
        <div style="flex: 1; min-width: 0;">
          <div style="display: flex; align-items: center; gap: 2px; margin-bottom: 2px; flex-wrap: wrap;">
            <span style="color: #fff; font-weight: 800; font-size: 15px;">${user.name}</span>
            ${verifiedBadgeHtml}
            <span style="color: #71767b; font-size: 15px; margin-left: 4px;">${
              user.handle.startsWith('@') ? user.handle : '@' + user.handle
            }</span>
            <span style="color: #71767b; font-size: 15px; margin: 0 4px;">Â·</span>
            <span style="color: #71767b; font-size: 15px;">${tweet.time}</span>
          </div>
          <div style="color: #fff; font-size: 15px; line-height: 20px; margin-bottom: 12px; word-wrap: break-word;">${processContent(
            tweet.content,
          )}</div>
          ${
            tweet.media && tweet.media.length > 0
              ? `
            <div style="background-color: #202327; border-radius: 16px; padding: 12px; margin-bottom: 12px; border: 1px solid #2f3336;">
              <div style="color: #e7e9ea; font-size: 15px; line-height: 20px;">${tweet.media[0].description}</div>
            </div>
          `
              : ''
          }
          <div style="display: flex; justify-content: space-between; max-width: 425px; margin-top: 12px;">
            <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer; padding: 0;" onmouseover="this.style.color='#1d9bf0'" onmouseout="this.style.color='#71767b'">
              <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g></svg>
              <span style="font-size: 13px;">${DataUtils.formatNumber(tweet.stats.comments || 0)}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer; padding: 0;" onmouseover="this.style.color='#00ba7c'" onmouseout="this.style.color='#71767b'">
              <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g></svg>
              <span style="font-size: 13px;">${DataUtils.formatNumber(tweet.stats.retweets || 0)}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer; padding: 0;" onmouseover="this.style.color='#f91880'" onmouseout="this.style.color='#71767b'">
              <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g></svg>
              <span style="font-size: 13px;">${DataUtils.formatNumber(tweet.stats.likes || 0)}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer; padding: 0;" onmouseover="this.style.color='#1d9bf0'" onmouseout="this.style.color='#71767b'">
              <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"></path></g></svg>
              <span style="font-size: 13px;">${DataUtils.formatNumber(tweet.stats.views || 0)}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; color: #71767b; cursor: pointer; padding: 0;">
              <div style="display: flex; align-items: center;" onmouseover="this.style.color='#1d9bf0'" onmouseout="this.style.color='#71767b'">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z"></path></g></svg>
              </div>
              <div style="display: flex; align-items: center;" onmouseover="this.style.color='#1d9bf0'" onmouseout="this.style.color='#71767b'">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.3 3.3-1.41-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"></path></g></svg>
              </div>
            </div>
          </div>
        </div>
        <!-- å³ä¸Šè§’ä¸‰ç‚¹èœå• -->
        <div style="position: absolute; top: 12px; right: 16px; cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'" onmouseout="this.style.backgroundColor='transparent'">
          <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #71767b;">
            <g><path d="M3 12c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9 2c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm7 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"></path></g>
          </svg>
        </div>
      </div>
    `;

    return tweetEl;
  }

  // å…³é—­è´¦æˆ·ä¸»é¡µ
  window.closeAccountProfile = function () {
    document.getElementById('account-profile-page').style.display = 'none';
    document.getElementById('x-home-page').style.display = 'flex';
  };

  // åˆ‡æ¢å…³æ³¨çŠ¶æ€
  window.toggleAccountFollow = function () {
    const followBtn = document.getElementById('account-follow-btn');
    const notifyBtn = document.getElementById('account-notify-btn');

    if (followBtn.textContent === 'å…³æ³¨') {
      // å…³æ³¨è´¦æˆ·
      followBtn.textContent = 'æ­£åœ¨å…³æ³¨';
      followBtn.style.backgroundColor = '#000';
      followBtn.style.color = '#fff';
      followBtn.style.border = '1px solid #536471';
      notifyBtn.style.display = 'flex';
      showXToast('å·²å…³æ³¨è¯¥è´¦æˆ·', 'success');
    } else {
      // å–æ¶ˆå…³æ³¨
      followBtn.textContent = 'å…³æ³¨';
      followBtn.style.backgroundColor = '#fff';
      followBtn.style.color = '#000';
      followBtn.style.border = 'none';
      notifyBtn.style.display = 'none';
      showXToast('å·²å–æ¶ˆå…³æ³¨', 'info');
    }
  };

  // åˆ‡æ¢é€šçŸ¥è®¾ç½®
  window.toggleAccountNotifications = function () {
    showXToast('é€šçŸ¥è®¾ç½®å·²æ›´æ–°', 'success');
  };

  // å‘é€ç§ä¿¡
  window.sendMessageToAccount = function () {
    showXToast('ç§ä¿¡åŠŸèƒ½å¼€å‘ä¸­...', 'info');
  };

  // åˆ‡æ¢è´¦æˆ·æ ‡ç­¾
  window.switchAccountTab = function (tabName) {
    // æ›´æ–°æ ‡ç­¾æ ·å¼
    const tabs = document.querySelectorAll('.account-tab');
    tabs.forEach(tab => {
      if (tab.onclick.toString().includes(tabName)) {
        tab.style.fontWeight = '700';
        tab.style.color = '#fff';
        tab.style.borderBottom = '4px solid #1d9bf0';
      } else {
        tab.style.fontWeight = '500';
        tab.style.color = '#71767b';
        tab.style.borderBottom = '4px solid transparent';
      }
    });

    // ç›®å‰åªæœ‰å¸–å­æ ‡ç­¾æœ‰å†…å®¹ï¼Œå…¶ä»–æ ‡ç­¾æ˜¾ç¤ºå ä½ç¬¦
    if (tabName !== 'posts') {
      const tweetsContainer = document.getElementById('account-tweets-container');
      const tabNameMap = {
        replies: 'å›å¤',
        highlights: 'äº®ç‚¹',
        media: 'åª’ä½“',
      };
      tweetsContainer.innerHTML = `
        <div style="padding: 60px 32px; text-align: center;">
          <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;">è¿˜æ²¡æœ‰${tabNameMap[tabName]}</div>
          <div style="color: #71767b; font-size: 15px;">è¯¥è´¦æˆ·çš„${tabNameMap[tabName]}å†…å®¹ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</div>
        </div>
      `;
    } else {
      // é‡æ–°æ¸²æŸ“æ¨æ–‡
      if (currentViewingAccount && currentViewingAccount.tweets) {
        const tweetsContainer = document.getElementById('account-tweets-container');
        tweetsContainer.innerHTML = '';
        const accountInfo = currentViewingAccount.accountInfo || currentViewingAccount;
        currentViewingAccount.tweets.forEach(tweet => {
          const tweetElement = createAccountTweetElement(tweet, accountInfo);
          tweetsContainer.appendChild(tweetElement);
        });
      }
    }
  };

  // ä¿å­˜è´¦æˆ·ä¸»é¡µæ•°æ®åˆ°æ•°æ®åº“
  async function saveAccountProfile(accountData) {
    try {
      const xDB = getXDB();
      const cleanHandle = accountData.accountInfo.handle.replace('@', '');

      // å‡†å¤‡ä¿å­˜çš„æ•°æ®
      const profileToSave = {
        handle: cleanHandle,
        name: accountData.accountInfo.name,
        accountInfo: accountData.accountInfo,
        tweets: accountData.tweets || [],
        updatedAt: new Date().toISOString(),
      };

      await xDB.xAccountProfiles.put(profileToSave);
      console.log('âœ… è´¦æˆ·ä¸»é¡µæ•°æ®å·²ä¿å­˜:', cleanHandle);
    } catch (error) {
      console.error('ä¿å­˜è´¦æˆ·ä¸»é¡µæ•°æ®å¤±è´¥:', error);
    }
  }

  // åˆ·æ–°è´¦æˆ·ä¸»é¡µï¼ˆé‡æ–°ç”Ÿæˆï¼‰
  window.refreshAccountProfile = async function () {
    if (!currentViewingAccount) {
      showXToast('æœªæ‰¾åˆ°å½“å‰è´¦æˆ·ä¿¡æ¯', 'error');
      return;
    }

    try {
      showXToast('æ­£åœ¨é‡æ–°ç”Ÿæˆè´¦æˆ·ä¸»é¡µ...', 'info');

      // ä»å½“å‰è´¦æˆ·æ•°æ®ä¸­æå–åŸºæœ¬ä¿¡æ¯
      const accountInfo = currentViewingAccount.accountInfo || currentViewingAccount;

      // æŸ¥è¯¢è´¦æˆ·æ•°æ®ï¼ˆé‡æ–°åˆ¤æ–­è´¦æˆ·ç±»å‹ï¼‰
      const accountData = await queryAccountData(accountInfo.name, accountInfo.handle, accountInfo.avatar);

      if (!accountData) {
        showXToast('æ— æ³•åŠ è½½è´¦æˆ·ä¿¡æ¯', 'error');
        return;
      }

      // è°ƒç”¨AIé‡æ–°ç”Ÿæˆè´¦æˆ·ä¸»é¡µå†…å®¹
      const profileData = await generateAccountProfileContent(accountData);

      if (profileData) {
        // æ›´æ–°è´¦æˆ·æ•°æ®
        currentViewingAccount = { ...accountData, ...profileData };
        renderAccountProfile(currentViewingAccount);

        // ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆè¦†ç›–æ—§æ•°æ®ï¼‰
        await saveAccountProfile(currentViewingAccount);
        showXToast('è´¦æˆ·ä¸»é¡µå·²åˆ·æ–°', 'success');
      }
    } catch (error) {
      console.error('åˆ·æ–°è´¦æˆ·ä¸»é¡µå¤±è´¥:', error);
      showXToast(`åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
    }
  };
  // â–²â–²â–² ã€ä¸»è¦ï¼ï¼ï¼ã€‘ç¬¬ä¸ƒä¸ªæƒ…æ™¯ï¼šè´¦æˆ·ä¸»é¡µç”Ÿæˆå™¨ â–²â–²â–²

  // ============================================
  // è´¦æˆ·æé—®ç®±åŠŸèƒ½
  // ============================================

  // è´¦æˆ·æé—®ç®±æ•°æ®ï¼ˆä¸´æ—¶å­˜å‚¨ï¼‰
  let accountAskboxData = {
    avatar: 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
    nickname: 'â©ŒâŒ¯â©Œ',
    prompt: 'è¯·å‘æˆ‘åŒ¿åæé—®!waiting...',
    background: 'https://i.postimg.cc/tJvBC00j/mmexport1759642131681.jpg',
    answeredQuestions: [],
  };

  // è´¦æˆ·æé—®ç®±å¤šé€‰åˆ é™¤ç›¸å…³å˜é‡
  let isAccountAskboxMultiSelectMode = false;
  let selectedAccountQuestions = new Set();
  let accountQuestionLongPressTimer = null;

  // æ‰“å¼€è´¦æˆ·æé—®ç®±
  window.openAccountAskbox = async function () {
    if (!currentViewingAccount) {
      showXToast('æœªæ‰¾åˆ°å½“å‰è´¦æˆ·ä¿¡æ¯', 'error');
      return;
    }

    try {
      // åŠ è½½è¯¥è´¦æˆ·çš„æé—®ç®±æ•°æ®
      await loadAccountAskboxData();

      // éšè—è´¦æˆ·ä¸»é¡µï¼Œæ˜¾ç¤ºæé—®ç®±é¡µé¢
      document.getElementById('account-profile-page').style.display = 'none';
      document.getElementById('account-askbox-page').style.display = 'flex';
    } catch (error) {
      console.error('æ‰“å¼€è´¦æˆ·æé—®ç®±å¤±è´¥:', error);
      showXToast('æ‰“å¼€æé—®ç®±å¤±è´¥: ' + error.message, 'error');
    }
  };

  // å…³é—­è´¦æˆ·æé—®ç®±
  window.closeAccountAskbox = function () {
    // é€€å‡ºå¤šé€‰æ¨¡å¼
    if (isAccountAskboxMultiSelectMode) {
      exitAccountAskboxMultiSelectMode();
    }

    document.getElementById('account-askbox-page').style.display = 'none';
    document.getElementById('account-profile-page').style.display = 'flex';
  };

  // ä»æ•°æ®åº“åŠ è½½è´¦æˆ·æé—®ç®±æ•°æ®
  async function loadAccountAskboxDataFromDB() {
    try {
      const xDb = getXDB();
      const accountInfo = currentViewingAccount.accountInfo || currentViewingAccount;
      const accountHandle = accountInfo.handle.replace('@', '');
      const askboxId = `account_askbox_${accountHandle}`;

      const savedData = await xDb.xAccountAskbox.get(askboxId);

      if (savedData) {
        // ä»æ•°æ®åº“åŠ è½½
        Object.assign(accountAskboxData, savedData);
        console.log('âœ… è´¦æˆ·æé—®ç®±æ•°æ®å·²ä»æ•°æ®åº“åŠ è½½:', accountHandle);
      } else {
        // ä½¿ç”¨é»˜è®¤æ•°æ®å¹¶ä¿å­˜åˆ°æ•°æ®åº“
        // é»˜è®¤æç¤ºè¯ä½¿ç”¨ç”¨æˆ·çš„æç¤ºè¯
        const userPrompt = askboxData.prompt;
        accountAskboxData = {
          avatar: 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
          nickname: 'â©ŒâŒ¯â©Œ',
          prompt: userPrompt,
          background: 'https://i.postimg.cc/tJvBC00j/mmexport1759642131681.jpg',
          answeredQuestions: [],
          id: askboxId,
        };
        await xDb.xAccountAskbox.put(accountAskboxData);
        console.log('âœ… å·²åˆ›å»ºé»˜è®¤è´¦æˆ·æé—®ç®±æ•°æ®:', accountHandle);
      }
    } catch (error) {
      console.error('âŒ åŠ è½½è´¦æˆ·æé—®ç®±æ•°æ®å¤±è´¥:', error);
    }
  }

  // ä¿å­˜è´¦æˆ·æé—®ç®±æ•°æ®åˆ°æ•°æ®åº“
  async function saveAccountAskboxDataToDB() {
    try {
      const xDb = getXDB();
      const accountInfo = currentViewingAccount.accountInfo || currentViewingAccount;
      const accountHandle = accountInfo.handle.replace('@', '');
      const askboxId = `account_askbox_${accountHandle}`;

      accountAskboxData.id = askboxId;
      await xDb.xAccountAskbox.put(accountAskboxData);
      console.log('âœ… è´¦æˆ·æé—®ç®±æ•°æ®å·²ä¿å­˜åˆ°æ•°æ®åº“:', accountHandle);
    } catch (error) {
      console.error('âŒ ä¿å­˜è´¦æˆ·æé—®ç®±æ•°æ®å¤±è´¥:', error);
    }
  }

  // åŠ è½½è´¦æˆ·æé—®ç®±æ•°æ®åˆ°UI
  async function loadAccountAskboxData() {
    // ä»æ•°æ®åº“åŠ è½½
    await loadAccountAskboxDataFromDB();

    // æ›´æ–°UI
    const avatarEl = document.getElementById('account-askbox-avatar');
    const nicknameEl = document.getElementById('account-askbox-nickname');
    const promptEl = document.getElementById('account-askbox-prompt');
    const backgroundEl = document.getElementById('account-askbox-background');

    if (avatarEl) avatarEl.src = accountAskboxData.avatar;
    if (nicknameEl) nicknameEl.textContent = accountAskboxData.nickname;
    if (promptEl) promptEl.textContent = accountAskboxData.prompt;
    if (backgroundEl) backgroundEl.style.backgroundImage = `url('${accountAskboxData.background}')`;

    // æ¸²æŸ“å·²å›ç­”çš„æé—®åˆ—è¡¨
    renderAccountAnsweredQuestions();
  }

  // ä¿®æ”¹è´¦æˆ·æé—®ç®±å¤´åƒ
  window.changeAccountAskboxAvatar = async function () {
    const newAvatar = prompt('è¯·è¾“å…¥æ–°çš„å¤´åƒURL:', accountAskboxData.avatar);
    if (newAvatar && newAvatar.trim()) {
      accountAskboxData.avatar = newAvatar.trim();
      const avatarEl = document.getElementById('account-askbox-avatar');
      if (avatarEl) avatarEl.src = accountAskboxData.avatar;

      // ä¿å­˜åˆ°æ•°æ®åº“
      await saveAccountAskboxDataToDB();
      showXToast('å¤´åƒå·²æ›´æ–°å¹¶ä¿å­˜', 'success');
    }
  };

  // ä¿å­˜è´¦æˆ·æé—®ç®±æ˜µç§°ï¼ˆåŸå¤„ç¼–è¾‘ï¼‰
  window.saveAccountAskboxNickname = async function () {
    const nicknameEl = document.getElementById('account-askbox-nickname');
    if (!nicknameEl) return;

    const newNickname = nicknameEl.textContent.trim();
    if (newNickname && newNickname !== accountAskboxData.nickname) {
      accountAskboxData.nickname = newNickname;
      await saveAccountAskboxDataToDB();
      console.log('âœ… æ˜µç§°å·²è‡ªåŠ¨ä¿å­˜:', newNickname);
    }
  };

  // ä¿å­˜è´¦æˆ·æé—®å¡ç‰‡æ–‡å­—ï¼ˆåŸå¤„ç¼–è¾‘ï¼‰
  window.saveAccountAskboxPrompt = async function () {
    const promptEl = document.getElementById('account-askbox-prompt');
    if (!promptEl) return;

    const newPrompt = promptEl.textContent.trim();
    if (newPrompt && newPrompt !== accountAskboxData.prompt) {
      accountAskboxData.prompt = newPrompt;
      await saveAccountAskboxDataToDB();
      console.log('âœ… æç¤ºæ–‡å­—å·²è‡ªåŠ¨ä¿å­˜:', newPrompt);
    }
  };

  // æ‰“å¼€è´¦æˆ·æé—®ç®±è®¾ç½®
  window.openAccountAskboxSettings = function () {
    const newBackground = prompt('è¯·è¾“å…¥æ–°çš„èƒŒæ™¯å›¾URL:', accountAskboxData.background);
    if (newBackground && newBackground.trim()) {
      accountAskboxData.background = newBackground.trim();
      const backgroundEl = document.getElementById('account-askbox-background');
      if (backgroundEl) backgroundEl.style.backgroundImage = `url('${accountAskboxData.background}')`;

      // ä¿å­˜åˆ°æ•°æ®åº“
      saveAccountAskboxDataToDB();
      showXToast('èƒŒæ™¯å›¾å·²æ›´æ–°å¹¶ä¿å­˜', 'success');
    }
  };

  // è·å–æ–°çš„æé—®ï¼ˆè´¦æˆ·æé—®ç®±AIç”Ÿæˆï¼‰
  window.getNewAccountQuestion = async function () {
    if (!currentViewingAccount) {
      showXToast('æœªæ‰¾åˆ°å½“å‰è´¦æˆ·ä¿¡æ¯', 'error');
      return;
    }

    try {
      showXToast('æ­£åœ¨ç”Ÿæˆæ–°çš„æé—®...', 'info');

      // ä»æ•°æ®åº“è¯»å–APIé…ç½®å’ŒXè®¾ç½®
      const db = getDB();
      const xDb = getXDB();

      const apiConfig = await db.apiConfig.get('main');
      if (!apiConfig || !apiConfig.proxyUrl || !apiConfig.apiKey || !apiConfig.model) {
        showXToast('è¯·å…ˆé…ç½®APIè®¾ç½®', 'error');
        return;
      }

      const { proxyUrl, apiKey, model } = apiConfig;

      // ä»Xè®¾ç½®ä¸­è¯»å–é…ç½®ï¼ˆæŒ‰è´¦å·è¯»å–ï¼‰
      const settingsId = `xSettings_${currentAccountId || 'main'}`;
      const xSettings = await xDb.xSettings.get(settingsId);
      const userPrompt = xSettings?.systemPrompt || '';
      const worldSetting = xSettings?.worldSetting || '';

      // è·å–è´¦æˆ·ä¿¡æ¯
      const accountInfo = currentViewingAccount.accountInfo || currentViewingAccount;
      const accountHandle = accountInfo.handle.replace('@', '');

      // æŸ¥è¯¢è¯¥è´¦æˆ·æ˜¯å¦æ˜¯è§’è‰²æˆ–NPC
      const accountData = await queryAccountData(accountInfo.name, accountInfo.handle, accountInfo.avatar);

      // æ„å»ºè§’è‰²/è´¦æˆ·çš„è¯¦ç»†ä¿¡æ¯
      let accountDetailInfo = '';
      let accountPersona = '';

      if (accountData.type === 'character' && accountData.characterData) {
        // æ˜¯è§’è‰²è´¦æˆ·
        const charData = accountData.characterData;
        accountDetailInfo = `
ã€è´¦æˆ·ç±»å‹ã€‘ï¼šè§’è‰²è´¦æˆ·

ã€è§’è‰²Xèµ„æ–™ã€‘ï¼š
- Xå§“åï¼š${charData.xName}
- Xå¥æŸ„ï¼š${charData.xHandle}
- Xç®€ä»‹ï¼š${charData.xBio || 'æ— '}
- å…¬ä¼—èº«ä»½ï¼š${charData.publicIdentity || 'æ— '}
- è®¤è¯çŠ¶æ€ï¼š${charData.verified ? 'å·²è®¤è¯' : 'æœªè®¤è¯'}
- çœŸå®å§“åï¼š${charData.showRealName && charData.realName ? charData.realName : 'æœªå…¬å¼€'}
`;

        // è·å–è§’è‰²äººè®¾
        const mainDB = getDB();
        const characterChat = await mainDB.chats.get(charData.characterId);
        if (characterChat && characterChat.settings.aiPersona) {
          accountPersona = `\nã€è§’è‰²äººè®¾ã€‘ï¼š\n${characterChat.settings.aiPersona}`;
        }

        // è·å–è§’è‰²çš„NPCå…³ç³»
        if (charData.npcRelationships && charData.npcRelationships.length > 0) {
          accountDetailInfo += '\nã€è§’è‰²çš„NPCå…³ç³»ã€‘ï¼š\n';
          for (const rel of charData.npcRelationships) {
            accountDetailInfo += `- ${rel.npcName}ï¼ˆ${rel.npcHandle}ï¼‰: ${rel.relationType} - ${rel.description}\n`;
          }
        }
      } else if (accountData.type === 'npc' && accountData.npcData) {
        // æ˜¯NPCè´¦æˆ·
        const npcData = accountData.npcData;
        accountDetailInfo = `
ã€è´¦æˆ·ç±»å‹ã€‘ï¼šNPCè´¦æˆ·

ã€NPCåŸºæœ¬ä¿¡æ¯ã€‘ï¼š
- NPCå§“åï¼š${npcData.name}
- NPCå¥æŸ„ï¼š${npcData.handle}
- å¤´åƒï¼š${npcData.avatar}
`;

        if (npcData.personality) {
          accountPersona = `\nã€NPCäººè®¾ã€‘ï¼š\n${npcData.personality}`;
        }

        if (npcData.postingHabits) {
          accountDetailInfo += `\nã€å‘å¸–ä¹ æƒ¯ã€‘ï¼š\n${npcData.postingHabits}`;
        }

        if (npcData.homepage) {
          accountDetailInfo += `\nã€ä¸»é¡µå†…å®¹ã€‘ï¼š\n${npcData.homepage}`;
        }
      } else {
        // æœªçŸ¥è´¦æˆ·
        accountDetailInfo = `
ã€è´¦æˆ·ç±»å‹ã€‘ï¼šæœªçŸ¥è´¦æˆ·

ã€è´¦æˆ·åŸºæœ¬ä¿¡æ¯ã€‘ï¼š
- åç§°ï¼š${accountInfo.name}
- å¥æŸ„ï¼š${accountInfo.handle}
- ç®€ä»‹ï¼š${accountInfo.bio || 'æ— '}
`;
      }

      // è·å–è¯¥è´¦æˆ·å·²æœ‰çš„æ¨æ–‡ï¼ˆå¦‚æœæœ‰ï¼‰
      let accountTweetsInfo = '';
      if (currentViewingAccount.tweets && currentViewingAccount.tweets.length > 0) {
        accountTweetsInfo = `\nã€è¯¥è´¦æˆ·æœ€è¿‘å‘å¸ƒçš„æ¨æ–‡ã€‘ï¼š\n`;
        currentViewingAccount.tweets.slice(0, 5).forEach((tweet, i) => {
          accountTweetsInfo += `${i + 1}. ${tweet.content}${tweet.time ? ` (${tweet.time})` : ''}\n`;
        });
      }

      // è·å–ç”¨æˆ·çš„Xèµ„æ–™ï¼ˆæé—®è€…çš„èº«ä»½ä¿¡æ¯ï¼‰
      const userXProfileInfo = StringBuilders.buildUserXProfileInfo(window.userProfileData);

      // è·å–æƒ…ä¾£è§’è‰²çš„Xèµ„æ–™
      let coupleCharacterInfo = '';
      if (accountData.type === 'character' && accountData.characterData) {
        const charData = accountData.characterData;
        // æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰æƒ…ä¾£å…³ç³»
        if (charData.npcRelationships) {
          const coupleRelation = charData.npcRelationships.find(rel => rel.relationType === 'æ‹äºº');
          if (coupleRelation) {
            coupleCharacterInfo = `\nã€è¯¥è§’è‰²çš„æƒ…ä¾£å…³ç³»ã€‘ï¼š\nä¸ ${coupleRelation.npcName}ï¼ˆ${coupleRelation.npcHandle}ï¼‰æ˜¯æ‹äººå…³ç³»\n${coupleRelation.description}`;
          }
        }
      }

      // æ”¶é›†å·²æœ‰çš„æé—®ï¼ˆå¦‚æœè¦é‡æ–°ç”Ÿæˆï¼‰
      let existingQuestionsContext = '';
      if (accountAskboxData.answeredQuestions.length > 0) {
        existingQuestionsContext = `\nã€å·²æœ‰çš„æé—®åˆ—è¡¨ï¼ˆéœ€è¦é‡æ–°ç”Ÿæˆå›ç­”ï¼‰ã€‘ï¼š\n`;
        accountAskboxData.answeredQuestions.forEach((q, i) => {
          existingQuestionsContext += `${i + 1}. ${q.question}\n`;
        });
      }

      // æ„å»ºç³»ç»Ÿæç¤ºè¯
      let systemPrompt = StringBuilders.buildBaseSystemPrompt({
        userPrompt,
        worldSetting,
      });

      systemPrompt += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ æ ¸å¿ƒä»»åŠ¡è¯´æ˜ - è´¦æˆ·æé—®ç®±ç”Ÿæˆ ğŸ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä½ éœ€è¦ä¸ºè¯¥è´¦æˆ·ç”ŸæˆåŒ¿åæé—®ï¼Œå¹¶ä»¥è¯¥è´¦æˆ·çš„èº«ä»½å›ç­”è¿™äº›æé—®ã€‚

${accountDetailInfo}
${accountPersona}
${accountTweetsInfo}
${coupleCharacterInfo}

ã€æé—®è€…èƒŒæ™¯ä¿¡æ¯ï¼ˆå‚è€ƒï¼‰ã€‘ï¼š
- ç”¨æˆ·åï¼š${userXProfileInfo.name}
- Xå¥æŸ„ï¼š${userXProfileInfo.handle}
- ç®€ä»‹ï¼š${userXProfileInfo.bio || 'æ— '}
${existingQuestionsContext}

ã€ç”Ÿæˆè¦æ±‚ã€‘ï¼š
1. ${existingQuestionsContext ? 'å¦‚æœæœ‰å·²æœ‰æé—®åˆ—è¡¨ï¼Œè¯·åŸºäºè¿™äº›æé—®é‡æ–°ç”Ÿæˆå›ç­”' : 'ç”Ÿæˆ3-10ä¸ªé€‚åˆè¯¥è´¦æˆ·èº«ä»½çš„åŒ¿åæé—®'}
2. æé—®è¦è‡ªç„¶ã€çœŸå®ï¼Œç¬¦åˆåŒ¿åæé—®ç®±çš„é£æ ¼
3. æé—®å†…å®¹è¦ä¸è´¦æˆ·çš„èº«ä»½ã€ç®€ä»‹ã€å…¬ä¼—èº«ä»½ã€æœ€è¿‘å‘å¸ƒçš„æ¨æ–‡ç›¸å…³
4. ${
        accountData.type === 'character' || accountData.type === 'npc'
          ? 'å›ç­”å¿…é¡»ä¸¥æ ¼ç¬¦åˆè§’è‰²/NPCçš„äººè®¾å’Œæ€§æ ¼ç‰¹ç‚¹'
          : 'å›ç­”è¦è‡ªç„¶ã€çœŸå®'
      }
5. æé—®å¯ä»¥æ˜¯ï¼š
   - å…³äºæœ€è¿‘æ¨æ–‡å†…å®¹çš„è¿½é—®æˆ–è¯„è®º
   - å…³äºç”Ÿæ´»ç»éªŒã€æƒ…æ„Ÿæ€åº¦çš„è¯¢é—®
   - å…³äºå…´è¶£çˆ±å¥½ã€æ—¥å¸¸ç”Ÿæ´»çš„å¥½å¥‡
   - è½»æ¾å¹½é»˜æˆ–çœŸè¯šçš„è¯é¢˜
6. æé—®é•¿åº¦é€‚ä¸­ï¼ˆ10-50å­—ï¼‰
7. å›ç­”è¦ä½“ç°è¯¥è´¦æˆ·çš„æ€§æ ¼å’Œå£å»ï¼Œé•¿åº¦é€‚ä¸­ï¼ˆ20-100å­—ï¼‰
8. é¿å…è¿‡äºç§å¯†ã€å†’çŠ¯æˆ–ä¸é€‚å½“çš„é—®é¢˜

ã€è¿”å›æ ¼å¼ã€‘ï¼š
è¿”å›JSONæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡åŒ…å«questionå’Œanswerå­—æ®µï¼š

\`\`\`json
[
  {"question": "æé—®å†…å®¹1", "answer": "è¯¥è´¦æˆ·çš„å›ç­”1"},
  {"question": "æé—®å†…å®¹2", "answer": "è¯¥è´¦æˆ·çš„å›ç­”2"},
  {"question": "æé—®å†…å®¹3", "answer": "è¯¥è´¦æˆ·çš„å›ç­”3"}
]
\`\`\`

ã€é‡è¦ã€‘ï¼š
- å¿…é¡»è¿”å›æœ‰æ•ˆçš„JSONæ•°ç»„æ ¼å¼
- questionæ˜¯åŒ¿åæé—®çš„å†…å®¹
- answeræ˜¯è¯¥è´¦æˆ·ä»¥è‡ªå·±çš„èº«ä»½å’Œäººè®¾å›ç­”çš„å†…å®¹
- ${
        existingQuestionsContext
          ? `è¯·åŸºäºå·²æœ‰çš„${accountAskboxData.answeredQuestions.length}ä¸ªæé—®é‡æ–°ç”Ÿæˆå›ç­”`
          : 'ç”Ÿæˆ3-10ç»„é—®ç­”'
      }

ç°åœ¨ï¼Œè¯·ç”ŸæˆJSONæ ¼å¼çš„é—®ç­”å†…å®¹ï¼š`;

      const messages = [
        {
          role: 'user',
          content: existingQuestionsContext
            ? `è¯·åŸºäºå·²æœ‰çš„${accountAskboxData.answeredQuestions.length}ä¸ªæé—®ï¼Œä»¥è¯¥è´¦æˆ·çš„èº«ä»½é‡æ–°ç”Ÿæˆå›ç­”ï¼Œè¿”å›JSONæ•°ç»„æ ¼å¼`
            : 'è¯·ç”Ÿæˆ3-10ç»„é—®ç­”ï¼Œè¿”å›JSONæ•°ç»„æ ¼å¼',
        },
      ];

      // åˆ¤æ–­APIç±»å‹å¹¶å‘é€è¯·æ±‚
      let isGemini = proxyUrl.includes('generativelanguage');
      let response;

      if (isGemini) {
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
        const geminiConfig = {
          url: `${GEMINI_API_URL}/${model}:generateContent?key=${getRandomValue(apiKey)}`,
          data: {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: systemPrompt + '\n\n' + messages.map(m => m.content).join('\n'),
                    },
                  ],
                },
              ],
              generationConfig: {
                temperature: 0.9,
              },
            }),
          },
        };
        response = await fetch(geminiConfig.url, geminiConfig.data);
      } else {
        const openAiPayload = {
          model: model,
          messages: [{ role: 'system', content: systemPrompt }, ...messages],
          temperature: 0.9,
          stream: false,
        };
        response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify(openAiPayload),
        });
      }

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`APIé”™è¯¯: ${response.status} - ${errorData.error?.message || response.statusText}`);
      }

      const data = await response.json();
      let aiResponseContent;

      if (isGemini) {
        // Geminiæ ¼å¼
        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
          aiResponseContent = data.candidates[0].content.parts[0].text || '';
        }
      } else {
        // OpenAIæ ¼å¼
        aiResponseContent = data.choices?.[0]?.message?.content || '';
      }

      console.log('AIç”Ÿæˆçš„é—®ç­”:', aiResponseContent);

      // è§£æJSONæ ¼å¼çš„å›ç­”
      let qaArray;
      try {
        // æå–JSONå†…å®¹ï¼ˆå¯èƒ½è¢«åŒ…è£¹åœ¨```json```ä¸­ï¼‰
        let jsonText = aiResponseContent.trim();
        const jsonMatch = jsonText.match(/```(?:json)?\s*(\[\s*\{[\s\S]*?\}\s*\])\s*```/);
        if (jsonMatch) {
          jsonText = jsonMatch[1];
        } else if (jsonText.startsWith('[') && jsonText.endsWith(']')) {
          // ç›´æ¥æ˜¯JSONæ•°ç»„
          jsonText = jsonText;
        } else {
          throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ ¼å¼');
        }

        qaArray = JSON.parse(jsonText);

        if (!Array.isArray(qaArray) || qaArray.length === 0) {
          throw new Error('AIè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆçš„æ•°ç»„æˆ–æ•°ç»„ä¸ºç©º');
        }
      } catch (parseError) {
        console.error('JSONè§£æå¤±è´¥:', parseError);
        throw new Error(`è§£æAIå›ç­”å¤±è´¥: ${parseError.message}`);
      }

      console.log(`âœ… è§£æåˆ° ${qaArray.length} ç»„é—®ç­”:`, qaArray);

      // å¦‚æœæ˜¯é‡æ–°ç”Ÿæˆï¼Œæ¸…ç©ºåŸæœ‰æé—®
      if (existingQuestionsContext) {
        accountAskboxData.answeredQuestions = [];
      }

      // ä¸ºæ¯ä¸ªé—®ç­”åˆ›å»ºå¯¹è±¡å¹¶æ·»åŠ åˆ°æ•°ç»„
      const newQuestions = qaArray.map((qa, index) => ({
        id: `q_${Date.now()}_${index}_${Math.random().toString(36).substr(2, 9)}`,
        question: qa.question || '',
        answer: qa.answer || '',
        date: new Date().toISOString(),
      }));

      // æ‰¹é‡æ·»åŠ åˆ°æœ€å‰é¢
      accountAskboxData.answeredQuestions.unshift(...newQuestions);

      // ä¿å­˜åˆ°æ•°æ®åº“
      await saveAccountAskboxDataToDB();

      // é‡æ–°æ¸²æŸ“æé—®åˆ—è¡¨
      renderAccountAnsweredQuestions();

      showXToast(`${existingQuestionsContext ? 'å·²é‡æ–°ç”Ÿæˆå›ç­”' : `ç”Ÿæˆäº† ${newQuestions.length} ç»„é—®ç­”`}`, 'success');
    } catch (error) {
      console.error('ç”Ÿæˆæé—®å¤±è´¥:', error);
      showXToast(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
    }
  };

  // æ¸²æŸ“è´¦æˆ·å·²å›ç­”çš„æé—®åˆ—è¡¨
  function renderAccountAnsweredQuestions() {
    const container = document.getElementById('account-answered-questions-list');
    const titleEl = document.getElementById('account-answered-questions-title');
    if (!container) return;

    if (accountAskboxData.answeredQuestions.length === 0) {
      // éšè—æ ‡é¢˜
      if (titleEl) titleEl.style.display = 'none';

      container.innerHTML = `
        <div style="
          text-align: center;
          color: rgba(255,255,255,0.6);
          font-size: 14px;
          padding: 40px 20px;
        ">
          æš‚æ— æé—®
        </div>
      `;
      return;
    }

    // æ˜¾ç¤ºæ ‡é¢˜
    if (titleEl) titleEl.style.display = 'block';

    container.innerHTML = accountAskboxData.answeredQuestions
      .map((q, index) => {
        const date = new Date(q.date);
        const dateStr = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
        const isSelected = selectedAccountQuestions.has(q.id);

        return `
      <div 
        class="account-askbox-question-item"
        data-question-id="${q.id}"
        style="
        background-color: rgba(255,255,255,0.9);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: all 0.2s;
        ${isSelected ? 'border: 3px solid #1d9bf0; background-color: rgba(29, 155, 240, 0.1);' : ''}
        ${isAccountAskboxMultiSelectMode ? 'border-left: 3px solid #1d9bf0;' : ''}
      " 
      onmouseover="if(!${isAccountAskboxMultiSelectMode}){this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)';}"
      onmouseout="if(!${isAccountAskboxMultiSelectMode}){this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';}"
      onmousedown="startAccountQuestionLongPress('${q.id}')"
      onmouseup="endAccountQuestionLongPress()"
      onmouseleave="endAccountQuestionLongPress()"
      ontouchstart="startAccountQuestionLongPress('${q.id}')"
      ontouchend="endAccountQuestionLongPress()"
      onclick="if(${isAccountAskboxMultiSelectMode}){toggleAccountQuestionSelection('${
          q.id
        }');event.stopPropagation();}"
      >
        <!-- æé—®åŒºåŸŸï¼ˆæµ…é»‘ç°è‰²ï¼‰ -->
        <div style="
          background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
          padding: 20px;
          color: #fff;
        ">
          <div style="font-size: 15px; line-height: 1.6; word-break: break-word;">
            ${q.question}
          </div>
        </div>
        
        <!-- å›å¤åŒºåŸŸï¼ˆç™½è‰²ï¼Œå¯ç¼–è¾‘ï¼‰ -->
        <div style="
          background-color: #fff;
          padding: 20px;
          min-height: 60px;
          color: #333;
        ">
          <div id="account-answer-${q.id}" 
            contenteditable="true"
            data-question-id="${q.id}"
            style="
              font-size: 14px; 
              line-height: 1.6; 
              word-break: break-word;
              outline: none;
              cursor: text;
              min-height: 20px;
              ${q.answer ? '' : 'color: #999; text-align: center;'}
            "
            onblur="saveAccountQuestionAnswer('${q.id}')"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();this.blur();}"
            onfocus="if(this.textContent==='ç‚¹å‡»æ­¤å¤„å›å¤...'){this.textContent='';this.style.color='#333';this.style.textAlign='left';}">${
              q.answer || 'ç‚¹å‡»æ­¤å¤„å›å¤...'
            }</div>
        </div>
        
        <!-- æ—¥æœŸæ ‡ç­¾ -->
        <div style="
          background-color: #f5f5f5;
          padding: 8px 20px;
          color: #999;
          font-size: 12px;
          text-align: right;
        ">
          ${dateStr}
        </div>
      </div>
    `;
      })
      .join('');
  }

  // ä¿å­˜è´¦æˆ·æé—®å›å¤ï¼ˆåŸå¤„ç¼–è¾‘ï¼‰
  window.saveAccountQuestionAnswer = async function (questionId) {
    const answerEl = document.getElementById(`account-answer-${questionId}`);
    if (!answerEl) return;

    const question = accountAskboxData.answeredQuestions.find(q => q.id === questionId);
    if (!question) return;

    let newAnswer = answerEl.textContent.trim();

    // å¦‚æœæ˜¯å ä½ç¬¦æ–‡æœ¬ï¼Œåˆ™æ¸…ç©º
    if (newAnswer === 'ç‚¹å‡»æ­¤å¤„å›å¤...') {
      newAnswer = '';
    }

    if (newAnswer !== question.answer) {
      question.answer = newAnswer;
      await saveAccountAskboxDataToDB();
      console.log('âœ… å›å¤å·²è‡ªåŠ¨ä¿å­˜:', questionId);
    }
  };

  // ============================================
  // è´¦æˆ·æé—®ç®±å¤šé€‰åˆ é™¤åŠŸèƒ½
  // ============================================

  // å¼€å§‹é•¿æŒ‰æé—®å¡ç‰‡
  window.startAccountQuestionLongPress = function (questionId) {
    if (isAccountAskboxMultiSelectMode) return;

    accountQuestionLongPressTimer = setTimeout(() => {
      enterAccountAskboxMultiSelectMode();
      toggleAccountQuestionSelection(questionId);
    }, 500);
  };

  // ç»“æŸé•¿æŒ‰
  window.endAccountQuestionLongPress = function () {
    if (accountQuestionLongPressTimer) {
      clearTimeout(accountQuestionLongPressTimer);
      accountQuestionLongPressTimer = null;
    }
  };

  // åˆ‡æ¢æé—®é€‰æ‹©çŠ¶æ€
  window.toggleAccountQuestionSelection = function (questionId) {
    if (!isAccountAskboxMultiSelectMode) {
      enterAccountAskboxMultiSelectMode();
    }

    const questionEl = document.querySelector(`.account-askbox-question-item[data-question-id="${questionId}"]`);
    if (!questionEl) return;

    if (selectedAccountQuestions.has(questionId)) {
      selectedAccountQuestions.delete(questionId);
      questionEl.style.border = '';
      questionEl.style.backgroundColor = 'rgba(255,255,255,0.9)';
    } else {
      selectedAccountQuestions.add(questionId);
      questionEl.style.border = '3px solid #1d9bf0';
      questionEl.style.backgroundColor = 'rgba(29, 155, 240, 0.1)';
    }

    updateAccountAskboxDeleteUI();
  };

  // è¿›å…¥è´¦æˆ·æé—®ç®±å¤šé€‰æ¨¡å¼
  function enterAccountAskboxMultiSelectMode() {
    isAccountAskboxMultiSelectMode = true;
    showAccountAskboxDeleteToolbar();

    document.querySelectorAll('.account-askbox-question-item').forEach(item => {
      item.style.borderLeft = '3px solid #1d9bf0';
    });

    console.log('âœ… å·²è¿›å…¥è´¦æˆ·æé—®ç®±å¤šé€‰æ¨¡å¼');
  }

  // é€€å‡ºè´¦æˆ·æé—®ç®±å¤šé€‰æ¨¡å¼
  window.exitAccountAskboxMultiSelectMode = function () {
    isAccountAskboxMultiSelectMode = false;
    selectedAccountQuestions.clear();
    hideAccountAskboxDeleteToolbar();

    document.querySelectorAll('.account-askbox-question-item').forEach(item => {
      item.style.border = '';
      item.style.borderLeft = '';
      item.style.backgroundColor = 'rgba(255,255,255,0.9)';
    });

    console.log('âœ… å·²é€€å‡ºè´¦æˆ·æé—®ç®±å¤šé€‰æ¨¡å¼');
  };

  // æ˜¾ç¤ºè´¦æˆ·æé—®ç®±åˆ é™¤å·¥å…·æ 
  function showAccountAskboxDeleteToolbar() {
    let toolbar = document.getElementById('account-askbox-delete-toolbar');
    if (!toolbar) {
      toolbar = document.createElement('div');
      toolbar.id = 'account-askbox-delete-toolbar';
      toolbar.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0,0,0,0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 24px;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        z-index: 2000;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      `;

      toolbar.innerHTML = `
        <button onclick="selectAllAccountQuestions()" style="
          background-color: #1d9bf0; 
          color: #fff; 
          border: none; 
          border-radius: 20px; 
          padding: 8px 16px; 
          font-size: 14px; 
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        " onmouseover="this.style.backgroundColor='#1a8cd8'" onmouseout="this.style.backgroundColor='#1d9bf0'">
          å…¨é€‰
        </button>
        <span id="account-askbox-selected-count" style="color: #fff; font-size: 14px; font-weight: 500;">å·²é€‰æ‹© 0 ä¸ª</span>
        <button onclick="deleteSelectedAccountQuestions()" style="
          background-color: #f91880; 
          color: #fff; 
          border: none; 
          border-radius: 20px; 
          padding: 8px 16px; 
          font-size: 14px; 
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        " onmouseover="this.style.backgroundColor='#d0155f'" onmouseout="this.style.backgroundColor='#f91880'">
          åˆ é™¤
        </button>
        <button onclick="exitAccountAskboxMultiSelectMode()" style="
          background-color: rgba(255,255,255,0.15); 
          color: #fff; 
          border: none; 
          border-radius: 20px; 
          padding: 8px 16px; 
          font-size: 14px; 
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.25)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.15)'">
          å–æ¶ˆ
        </button>
      `;

      document.body.appendChild(toolbar);
    }
    toolbar.style.display = 'flex';
  }

  // éšè—è´¦æˆ·æé—®ç®±åˆ é™¤å·¥å…·æ 
  function hideAccountAskboxDeleteToolbar() {
    const toolbar = document.getElementById('account-askbox-delete-toolbar');
    if (toolbar) {
      toolbar.style.display = 'none';
    }
  }

  // æ›´æ–°è´¦æˆ·æé—®ç®±åˆ é™¤UI
  function updateAccountAskboxDeleteUI() {
    const countEl = document.getElementById('account-askbox-selected-count');
    if (countEl) {
      countEl.textContent = `å·²é€‰æ‹© ${selectedAccountQuestions.size} ä¸ª`;
    }
  }

  // å…¨é€‰è´¦æˆ·æé—®
  window.selectAllAccountQuestions = function () {
    document.querySelectorAll('.account-askbox-question-item').forEach(item => {
      const questionId = item.dataset.questionId;
      if (!selectedAccountQuestions.has(questionId)) {
        selectedAccountQuestions.add(questionId);
        item.style.border = '3px solid #1d9bf0';
        item.style.backgroundColor = 'rgba(29, 155, 240, 0.1)';
      }
    });
    updateAccountAskboxDeleteUI();
  };

  // åˆ é™¤é€‰ä¸­çš„è´¦æˆ·æé—®
  window.deleteSelectedAccountQuestions = async function () {
    if (selectedAccountQuestions.size === 0) {
      showXToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æé—®', 'warning');
      return;
    }

    const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedAccountQuestions.size} ä¸ªæé—®å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚`);
    if (!confirmDelete) return;

    try {
      accountAskboxData.answeredQuestions = accountAskboxData.answeredQuestions.filter(
        q => !selectedAccountQuestions.has(q.id),
      );
      await saveAccountAskboxDataToDB();
      showXToast(`å·²åˆ é™¤ ${selectedAccountQuestions.size} ä¸ªæé—®`, 'success');
      window.exitAccountAskboxMultiSelectMode();
      renderAccountAnsweredQuestions();
    } catch (error) {
      console.error('åˆ é™¤æé—®å¤±è´¥:', error);
      showXToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
    }
  };

  // Xè®¾ç½®é¡µé¢ç›¸å…³åŠŸèƒ½
  let xSettingsData = {
    systemPrompt: '',
    worldSetting: '',
    characterBinding: false,
    boundCharacters: [],
  };

  // ç”¨æˆ·èµ„æ–™æ•°æ® - åˆå§‹åŒ–å…¨å±€å˜é‡ï¼ˆå®é™…æ•°æ®å°†åœ¨loadUserProfileæ—¶ä»æ•°æ®åº“åŠ è½½ï¼‰
  if (!window.userProfileData) {
    window.userProfileData = {
      name: 'æˆ‘',
      handle: '@me',
      avatar: 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg',
      coverImage: 'https://i.postimg.cc/qRzMB6nQ/default-cover.jpg',
      bio: 'æ¬¢è¿æ¥åˆ°æˆ‘çš„Xä¸»é¡µï¼',
      verified: false,
      verificationType: 'none',
      coupleCharacterId: '',
      coupleCharacterName: '',
      customTag1: 'ç§‘æŠ€çˆ±å¥½è€…',
      customTag1Icon: 'âœ¨',
      customTag1Color: '#71767b',
      customTag2: '2024å¹´åŠ å…¥',
      customTag2Icon: 'ğŸ“…',
      customTag2Color: '#71767b',
      following: '156',
      followers: '89',
      knownIdentityCharacters: [],
      publicIdentity: '',
      showRealName: false,
      realName: '',
    };
  }

  // åˆ›å»ºå±€éƒ¨å¼•ç”¨æŒ‡å‘å…¨å±€å˜é‡ï¼ˆç¡®ä¿æ‰€æœ‰åœ°æ–¹éƒ½è®¿é—®åŒä¸€ä¸ªå¯¹è±¡ï¼‰
  let userProfileData = window.userProfileData;

  // è·å–ç”¨æˆ·è®¤è¯ç±»å‹æè¿°
  function getUserVerificationTypeDescription(userProfile) {
    const verificationType = userProfile.verificationType || 'none';
    const descriptions = {
      none: 'æ— è®¤è¯',
      verified: 'å·²è®¤è¯ï¼ˆè“è‰²å‹¾æ ‡ï¼‰',
      couple: 'æƒ…ä¾£è®¤è¯ï¼ˆç™½è‰²å¿ƒå½¢ï¼‰',
      married: 'å·²å©šè®¤è¯ï¼ˆç™½è‰²åœ†ç¯ï¼‰',
      vip: 'VIPè®¤è¯ï¼ˆç™½è‰²è±å½¢ï¼‰',
    };
    return descriptions[verificationType] || 'æ— è®¤è¯';
  }

  // åˆå§‹åŒ–Xè®¾ç½®
  async function initializeXSettings() {
    try {
      const db = getXDB();

      // æŒ‰è´¦å·åŠ è½½è®¾ç½®
      const settingsId = `xSettings_${currentAccountId || 'main'}`;
      const savedSettings = await db.xSettings.get(settingsId);
      if (savedSettings) {
        xSettingsData = savedSettings;
        loadXSettingsToUI();
      } else {
        // å¦‚æœå½“å‰è´¦å·æ²¡æœ‰è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®
        xSettingsData = {
          systemPrompt: '',
          worldSetting: '',
          characterBinding: false,
          boundCharacters: [],
          npcBinding: false,
        };
        loadXSettingsToUI();
      }

      // åŠ è½½é¢„è®¾åˆ—è¡¨
      loadXPresetsList();

      console.log('âœ… Xè®¾ç½®å·²åŠ è½½ (è´¦æˆ·:', currentAccountId || 'main', ')');
    } catch (error) {
      console.error('åˆå§‹åŒ–Xè®¾ç½®å¤±è´¥:', error);
    }
  }

  // å°†è®¾ç½®æ•°æ®åŠ è½½åˆ°UI
  function loadXSettingsToUI() {
    document.getElementById('x-system-prompt').value = xSettingsData.systemPrompt || '';
    document.getElementById('x-world-setting').value = xSettingsData.worldSetting || '';

    // ç¡®ä¿ boundCharacters æ•°ç»„å­˜åœ¨
    if (!xSettingsData.boundCharacters) {
      xSettingsData.boundCharacters = [];
    }

    updateCharacterToggleUI();

    // å¦‚æœå¼€å¯äº†è§’è‰²ç»‘å®šï¼Œæ˜¾ç¤ºè§’è‰²é€‰æ‹©åŒºåŸŸ
    const bindingArea = document.getElementById('character-binding-area');
    if (xSettingsData.characterBinding) {
      bindingArea.style.display = 'block';
      loadCharactersList();
    } else {
      bindingArea.style.display = 'none';
    }

    // æ›´æ–°NPCç»‘å®šUI
    updateNPCToggleUI();

    // å¦‚æœå¼€å¯äº†NPCç»‘å®šï¼Œæ˜¾ç¤ºNPCç®¡ç†åŒºåŸŸ
    const npcArea = document.getElementById('npc-binding-area');
    if (xSettingsData.npcBinding) {
      npcArea.style.display = 'block';
      loadNPCsList();
    } else {
      npcArea.style.display = 'none';
    }
  }

  // åˆ‡æ¢è§’è‰²ç»‘å®š (å·²è¢«æ–°ç‰ˆæœ¬æ›¿æ¢ï¼Œåœ¨æ–°ä½ç½®)

  // ä¿å­˜Xè®¾ç½®ï¼ˆæŒ‰è´¦å·å­˜å‚¨ï¼‰
  async function saveXSettings() {
    try {
      // è·å–UIä¸­çš„æ•°æ®
      xSettingsData.systemPrompt = document.getElementById('x-system-prompt').value;
      xSettingsData.worldSetting = document.getElementById('x-world-setting').value;

      const db = getXDB();
      const settingsId = `xSettings_${currentAccountId || 'main'}`;

      await db.xSettings.put({
        id: settingsId,
        ...xSettingsData,
        lastUpdated: new Date().toISOString(),
      });

      console.log('âœ… Xè®¾ç½®å·²ä¿å­˜ (è´¦æˆ·:', currentAccountId || 'main', ')');
      showXToast('è®¾ç½®å·²ä¿å­˜', 'success');
    } catch (error) {
      console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
      showXToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
  }

  // ä¿å­˜ä¸ºé¢„è®¾
  async function saveXPreset() {
    const presetName = prompt('è¯·è¾“å…¥é¢„è®¾åç§°:');
    if (!presetName || presetName.trim() === '') {
      showXToast('é¢„è®¾åç§°ä¸èƒ½ä¸ºç©º', 'error');
      return;
    }

    try {
      // åªä¿å­˜æç¤ºè¯å’Œä¸–ç•Œè§‚è®¾å®š
      const presetData = {
        systemPrompt: document.getElementById('x-system-prompt').value,
        worldSetting: document.getElementById('x-world-setting').value,
        characterBinding: xSettingsData.characterBinding || false,
        boundCharacters: xSettingsData.boundCharacters || [],
      };

      const db = getXDB();

      await db.xPresets.add({
        name: presetName.trim(),
        ...presetData,
        createdAt: new Date().toISOString(),
      });

      showXToast(`é¢„è®¾"${presetName}"å·²ä¿å­˜`, 'success');
      loadXPresetsList(); // åˆ·æ–°é¢„è®¾åˆ—è¡¨
    } catch (error) {
      console.error('ä¿å­˜é¢„è®¾å¤±è´¥:', error);
      showXToast('ä¿å­˜é¢„è®¾å¤±è´¥: ' + error.message, 'error');
    }
  }

  // åŠ è½½é¢„è®¾åˆ—è¡¨
  async function loadXPresetsList() {
    try {
      const db = getXDB();

      const presets = await db.xPresets.orderBy('createdAt').reverse().toArray();
      const presetsList = document.getElementById('x-presets-list');

      if (presets.length === 0) {
        presetsList.innerHTML =
          '<p style="color: #71767b; font-size: 14px; text-align: center; margin: 20px 0;">æš‚æ— ä¿å­˜çš„é¢„è®¾</p>';
        return;
      }

      presetsList.innerHTML = presets
        .map(
          preset => `
                <div class="preset-item" style="display: flex; align-items: center; justify-content: space-between; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                  <div style="flex: 1; min-width: 0;">
                    <div style="color: #fff; font-weight: 600; font-size: 15px; margin-bottom: 4px; word-wrap: break-word;">${
                      preset.name
                    }</div>
                    <div style="color: #71767b; font-size: 13px;">${new Date(preset.createdAt).toLocaleString()}</div>
                  </div>
                  <div style="display: flex; gap: 8px; flex-shrink: 0;">
                    <button onclick="loadXPreset(${preset.id})" 
                      style="background-color: #1d9bf0; color: #fff; border: none; border-radius: 15px; padding: 6px 12px; font-size: 12px; cursor: pointer; white-space: nowrap;">
                      åŠ è½½
                    </button>
                    <button onclick="deleteXPreset(${preset.id})" 
                      style="background-color: #f4212e; color: #fff; border: none; border-radius: 15px; padding: 6px 12px; font-size: 12px; cursor: pointer; white-space: nowrap;">
                      åˆ é™¤
                    </button>
                  </div>
                </div>
              `,
        )
        .join('');
    } catch (error) {
      console.error('åŠ è½½é¢„è®¾åˆ—è¡¨å¤±è´¥:', error);
    }
  }

  // åŠ è½½é¢„è®¾
  async function loadXPreset(presetId) {
    try {
      const db = getXDB();
      const preset = await db.xPresets.get(presetId);
      if (preset) {
        // åŠ è½½æ‰€æœ‰è®¾å®š
        document.getElementById('x-system-prompt').value = preset.systemPrompt || '';
        document.getElementById('x-world-setting').value = preset.worldSetting || '';
        xSettingsData.characterBinding = preset.characterBinding || false;
        xSettingsData.boundCharacters = preset.boundCharacters || [];

        // æ›´æ–°UI
        loadXSettingsToUI();

        showXToast(`å·²åŠ è½½é¢„è®¾"${preset.name}"`, 'success');
      }
    } catch (error) {
      console.error('åŠ è½½é¢„è®¾å¤±è´¥:', error);
      showXToast('åŠ è½½é¢„è®¾å¤±è´¥: ' + error.message, 'error');
    }
  }

  // åˆ é™¤é¢„è®¾
  async function deleteXPreset(presetId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è®¾å—ï¼Ÿ')) return;

    try {
      const db = getXDB();

      await db.xPresets.delete(presetId);
      showXToast('é¢„è®¾å·²åˆ é™¤', 'success');
      loadXPresetsList(); // åˆ·æ–°é¢„è®¾åˆ—è¡¨
    } catch (error) {
      console.error('åˆ é™¤é¢„è®¾å¤±è´¥:', error);
      showXToast('åˆ é™¤é¢„è®¾å¤±è´¥: ' + error.message, 'error');
    }
  }

  // å¯¼å‡ºæ‰€æœ‰Xæ•°æ®
  async function exportXData() {
    try {
      const xDb = getXDB();

      // å¯¼å‡ºæ‰€æœ‰Xæ•°æ®åº“å†…å®¹
      const exportData = {
        // Xè®¾ç½®
        xSettings: await xDb.xSettings.toArray(),
        // ç”¨æˆ·èµ„æ–™ï¼ˆæ‰€æœ‰è´¦æˆ·ï¼‰
        xUserProfile: await xDb.xUserProfile.toArray(),
        // æ¨æ–‡æ•°æ®
        xTweetsData: await xDb.xTweetsData.toArray(),
        // ç”¨æˆ·å‘å¸ƒçš„æ¨æ–‡ï¼ˆæ‰€æœ‰è´¦æˆ·ï¼‰
        xUserTweets: await xDb.xUserTweets.toArray(),
        // è§’è‰²Xèµ„æ–™
        xCharacterProfiles: await xDb.xCharacterProfiles.toArray(),
        // é¢„è®¾
        xPresets: await xDb.xPresets.toArray(),
        // ç”¨æˆ·æé—®ç®±æ•°æ®
        xAskbox: await xDb.xAskbox.toArray(),
        // å½“å‰æ´»è·ƒè´¦æˆ·
        xActiveAccount: await xDb.xActiveAccount.toArray(),
        // è´¦æˆ·åˆ—è¡¨
        xAccountList: await xDb.xAccountList.toArray(),
        // NPCè®¾ç½®
        xNPCs: await xDb.xNPCs.toArray(),
        // è´¦æˆ·ä¸»é¡µæ•°æ®
        xAccountProfiles: await xDb.xAccountProfiles.toArray(),
        // è´¦æˆ·æé—®ç®±æ•°æ®
        xAccountAskbox: await xDb.xAccountAskbox.toArray(),
        // å…ƒæ•°æ®
        exportTime: new Date().toISOString(),
        version: '2.0',
        dataType: 'x-social-full-backup',
      };

      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });

      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `x-data-backup-${new Date().toISOString().split('T')[0]}.json`;
      link.click();

      showXToast('æ‰€æœ‰æ•°æ®å·²å¯¼å‡º', 'success');
      console.log('âœ… Xæ•°æ®å¯¼å‡ºæˆåŠŸï¼ŒåŒ…å«:', {
        è®¾ç½®æ•°: exportData.xSettings.length,
        ç”¨æˆ·èµ„æ–™æ•°: exportData.xUserProfile.length,
        æ¨æ–‡æ•°æ®æ•°: exportData.xTweetsData.length,
        ç”¨æˆ·æ¨æ–‡æ•°: exportData.xUserTweets.length,
        è§’è‰²Xèµ„æ–™æ•°: exportData.xCharacterProfiles.length,
        é¢„è®¾æ•°: exportData.xPresets.length,
        ç”¨æˆ·æé—®ç®±æ•°: exportData.xAskbox.length,
        æ´»è·ƒè´¦æˆ·æ•°: exportData.xActiveAccount.length,
        è´¦æˆ·åˆ—è¡¨æ•°: exportData.xAccountList.length,
        NPCè®¾ç½®æ•°: exportData.xNPCs.length,
        è´¦æˆ·ä¸»é¡µæ•°: exportData.xAccountProfiles.length,
        è´¦æˆ·æé—®ç®±æ•°: exportData.xAccountAskbox.length,
      });
    } catch (error) {
      console.error('âŒ å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
      showXToast('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
    }
  }

  // å¯¼å…¥æ‰€æœ‰Xæ•°æ®
  function importXData() {
    if (
      !confirm(
        'âš ï¸ è­¦å‘Šï¼šå¯¼å…¥æ•°æ®å°†å®Œå…¨æ›¿æ¢å½“å‰æ‰€æœ‰Xæ•°æ®ï¼ˆåŒ…æ‹¬ç”¨æˆ·èµ„æ–™ã€æ¨æ–‡ã€å¸–å­ã€è®¾ç½®ç­‰ï¼‰ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
      )
    ) {
      return;
    }

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = async function (event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function (e) {
        try {
          const importData = JSON.parse(e.target.result);

          // éªŒè¯æ•°æ®æ ¼å¼
          if (!importData || importData.dataType !== 'x-social-full-backup') {
            showXToast('å¯¼å…¥å¤±è´¥: ä¸æ˜¯æœ‰æ•ˆçš„Xæ•°æ®å¤‡ä»½æ–‡ä»¶', 'error');
            return;
          }

          showXToast('æ­£åœ¨å¯¼å…¥æ•°æ®ï¼Œè¯·ç¨å€™...', 'info');

          const xDb = getXDB();

          // æ¸…ç©ºç°æœ‰æ•°æ®
          await xDb.xSettings.clear();
          await xDb.xUserProfile.clear();
          await xDb.xTweetsData.clear();
          await xDb.xUserTweets.clear();
          await xDb.xCharacterProfiles.clear();
          await xDb.xPresets.clear();
          await xDb.xAskbox.clear();
          await xDb.xActiveAccount.clear();
          await xDb.xAccountList.clear();
          await xDb.xNPCs.clear();
          await xDb.xAccountProfiles.clear();
          await xDb.xAccountAskbox.clear();

          console.log('âœ… å·²æ¸…ç©ºæ—§æ•°æ®');

          // å¯¼å…¥æ–°æ•°æ®
          if (importData.xSettings && importData.xSettings.length > 0) {
            await xDb.xSettings.bulkAdd(importData.xSettings);
          }
          if (importData.xUserProfile && importData.xUserProfile.length > 0) {
            await xDb.xUserProfile.bulkAdd(importData.xUserProfile);
          }
          if (importData.xTweetsData && importData.xTweetsData.length > 0) {
            await xDb.xTweetsData.bulkAdd(importData.xTweetsData);
          }
          if (importData.xUserTweets && importData.xUserTweets.length > 0) {
            await xDb.xUserTweets.bulkAdd(importData.xUserTweets);
          }
          if (importData.xCharacterProfiles && importData.xCharacterProfiles.length > 0) {
            await xDb.xCharacterProfiles.bulkAdd(importData.xCharacterProfiles);
          }
          if (importData.xPresets && importData.xPresets.length > 0) {
            await xDb.xPresets.bulkAdd(importData.xPresets);
          }
          if (importData.xAskbox && importData.xAskbox.length > 0) {
            await xDb.xAskbox.bulkAdd(importData.xAskbox);
          }
          if (importData.xActiveAccount && importData.xActiveAccount.length > 0) {
            await xDb.xActiveAccount.bulkAdd(importData.xActiveAccount);
          }
          if (importData.xAccountList && importData.xAccountList.length > 0) {
            await xDb.xAccountList.bulkAdd(importData.xAccountList);
          }
          if (importData.xNPCs && importData.xNPCs.length > 0) {
            await xDb.xNPCs.bulkAdd(importData.xNPCs);
          }
          if (importData.xAccountProfiles && importData.xAccountProfiles.length > 0) {
            await xDb.xAccountProfiles.bulkAdd(importData.xAccountProfiles);
          }
          if (importData.xAccountAskbox && importData.xAccountAskbox.length > 0) {
            await xDb.xAccountAskbox.bulkAdd(importData.xAccountAskbox);
          }

          console.log('âœ… Xæ•°æ®å¯¼å…¥æˆåŠŸï¼ŒåŒ…å«:', {
            è®¾ç½®æ•°: importData.xSettings?.length || 0,
            ç”¨æˆ·èµ„æ–™æ•°: importData.xUserProfile?.length || 0,
            æ¨æ–‡æ•°æ®æ•°: importData.xTweetsData?.length || 0,
            ç”¨æˆ·æ¨æ–‡æ•°: importData.xUserTweets?.length || 0,
            è§’è‰²Xèµ„æ–™æ•°: importData.xCharacterProfiles?.length || 0,
            é¢„è®¾æ•°: importData.xPresets?.length || 0,
            ç”¨æˆ·æé—®ç®±æ•°: importData.xAskbox?.length || 0,
            æ´»è·ƒè´¦æˆ·æ•°: importData.xActiveAccount?.length || 0,
            è´¦æˆ·åˆ—è¡¨æ•°: importData.xAccountList?.length || 0,
            NPCè®¾ç½®æ•°: importData.xNPCs?.length || 0,
            è´¦æˆ·ä¸»é¡µæ•°: importData.xAccountProfiles?.length || 0,
            è´¦æˆ·æé—®ç®±æ•°: importData.xAccountAskbox?.length || 0,
          });

          showXToast('æ•°æ®å¯¼å…¥æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°...', 'success');

          // å»¶è¿Ÿåˆ·æ–°ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } catch (error) {
          console.error('âŒ å¯¼å…¥æ•°æ®å¤±è´¥:', error);
          showXToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
        }
      };
      reader.readAsText(file);
    };

    input.click();
  }

  // åˆ‡æ¢è§’è‰²ç»‘å®š
  function toggleCharacterBinding() {
    xSettingsData.characterBinding = !xSettingsData.characterBinding;
    updateCharacterToggleUI();

    const bindingArea = document.getElementById('character-binding-area');
    if (xSettingsData.characterBinding) {
      bindingArea.style.display = 'block';
      loadCharactersList();
    } else {
      bindingArea.style.display = 'none';
      // æ¸…ç©ºç»‘å®šçš„è§’è‰²
      if (!xSettingsData.boundCharacters) xSettingsData.boundCharacters = [];
    }
  }

  // æ›´æ–°è§’è‰²ç»‘å®šåˆ‡æ¢æŒ‰é’®UI
  function updateCharacterToggleUI() {
    const toggle = document.getElementById('x-character-toggle');
    const circle = toggle.querySelector('.toggle-circle');

    if (xSettingsData.characterBinding) {
      toggle.style.backgroundColor = '#1d9bf0';
      circle.style.left = '22px';
    } else {
      toggle.style.backgroundColor = '#333';
      circle.style.left = '2px';
    }
  }

  // åŠ è½½è§’è‰²åˆ—è¡¨
  async function loadCharactersList() {
    try {
      // è·å–æ‰€æœ‰èŠå¤©ä¸­çš„éç¾¤ç»„è§’è‰²
      const db = getDB(); // ä¿®æ­£ï¼šchatsè¡¨åœ¨å…¨å±€æ•°æ®åº“ä¸­
      const allChats = await db.chats.toArray();
      const characters = allChats.filter(chat => !chat.isGroup);

      const charactersList = document.getElementById('characters-list');

      if (characters.length === 0) {
        charactersList.innerHTML = TemplateBuilders.buildEmptyState('æš‚æ— å¯ç»‘å®šçš„è§’è‰²ï¼Œè¯·å…ˆåˆ›å»ºè§’è‰²èŠå¤©');
        return;
      }

      if (!xSettingsData.boundCharacters) xSettingsData.boundCharacters = [];

      charactersList.innerHTML = characters
        .map(character => {
          const isChecked = xSettingsData.boundCharacters.includes(character.id);
          return TemplateBuilders.buildCharacterItem(character, isChecked);
        })
        .join('');
    } catch (error) {
      ValidationUtils.handleError(error, 'åŠ è½½è§’è‰²åˆ—è¡¨');
      document.getElementById('characters-list').innerHTML = TemplateBuilders.buildErrorState('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥');
    }
  }

  // åˆ‡æ¢è§’è‰²é€‰æ‹©çŠ¶æ€
  function toggleCharacterSelection(characterId) {
    if (!xSettingsData.boundCharacters) {
      xSettingsData.boundCharacters = [];
    }

    const index = xSettingsData.boundCharacters.indexOf(characterId);
    if (index > -1) {
      xSettingsData.boundCharacters.splice(index, 1);
    } else {
      xSettingsData.boundCharacters.push(characterId);
    }

    // æ›´æ–°UI
    const checkbox = document.querySelector(`[data-character-id="${characterId}"]`);
    if (checkbox) {
      const isChecked = xSettingsData.boundCharacters.includes(characterId);
      checkbox.outerHTML = TemplateBuilders.buildCheckbox(characterId, isChecked);
    }
  }

  // é•¿æŒ‰ç›¸å…³å˜é‡
  let longPressTimer = null;
  let longPressTarget = null;

  // å¼€å§‹é•¿æŒ‰
  function startLongPress(characterId) {
    longPressTarget = characterId;
    longPressTimer = setTimeout(() => {
      if (longPressTarget === characterId) {
        openCharacterXProfile(characterId);
      }
    }, 500); // 500msé•¿æŒ‰è§¦å‘
  }

  // ç»“æŸé•¿æŒ‰
  function endLongPress() {
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      longPressTimer = null;
    }
    longPressTarget = null;
  }

  // æ‰“å¼€è§’è‰²Xèµ„æ–™è®¾ç½®
  async function openCharacterXProfile(characterId) {
    try {
      const db = getDB(); // ä¿®æ­£ï¼šchatsè¡¨åœ¨å…¨å±€æ•°æ®åº“ä¸­
      const xDb = getXDB(); // Xä¸“ç”¨æ•°æ®åº“ç”¨äºxCharacterProfiles

      const character = await db.chats.get(characterId);
      if (!character) {
        showXToast('æœªæ‰¾åˆ°è§’è‰²ä¿¡æ¯', 'error');
        return;
      }

      // åŠ è½½ç°æœ‰çš„Xèµ„æ–™
      let xProfile = await xDb.xCharacterProfiles.get(characterId);
      if (!xProfile) {
        // åˆ›å»ºé»˜è®¤Xèµ„æ–™
        xProfile = {
          characterId: characterId,
          xName: character.name,
          xHandle: character.name.toLowerCase().replace(/\s+/g, '_'),
          xAvatar: 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
          xVerified: false,
          xBio: '',
          relationships: [],
        };
      }

      // ç¡®ä¿æœ‰relationshipså­—æ®µ
      if (!xProfile.relationships) {
        xProfile.relationships = [];
      }

      // å¡«å……å¼¹çª—å†…å®¹
      const infoDisplay = document.getElementById('character-info-display');
      if (infoDisplay) {
        infoDisplay.innerHTML = TemplateBuilders.buildCharacterInfoDisplay(character);
      }

      // è·å–æ‰€æœ‰è¡¨å•å…ƒç´ 
      const avatarElement = document.getElementById('character-x-avatar');
      const avatarUrlElement = document.getElementById('character-x-avatar-url');
      const coverPreviewElement = document.getElementById('character-x-cover-preview');
      const coverUrlElement = document.getElementById('character-x-cover-url');
      const nameElement = document.getElementById('character-x-name');
      const handleElement = document.getElementById('character-x-handle');
      const verifiedElement = document.getElementById('character-x-verified');
      const tag1IconElement = document.getElementById('character-tag1-icon');
      const tag1TextElement = document.getElementById('character-custom-tag1');
      const tag1ColorElement = document.getElementById('character-tag1-color');
      const tag2IconElement = document.getElementById('character-tag2-icon');
      const tag2TextElement = document.getElementById('character-custom-tag2');
      const tag2ColorElement = document.getElementById('character-tag2-color');
      const followingCountElement = document.getElementById('character-following-count');
      const followersCountElement = document.getElementById('character-followers-count');
      const bioElement = document.getElementById('character-x-bio');
      const publicIdentityElement = document.getElementById('character-public-identity');
      const showRealNameElement = document.getElementById('character-show-real-name');
      const realNameElement = document.getElementById('character-real-name');

      // å®‰å…¨åœ°è®¾ç½®å…ƒç´ å€¼ - ç»Ÿä¸€ä½¿ç”¨é»˜è®¤å¤´åƒ
      const defaultAvatar = 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg';
      if (avatarElement) avatarElement.src = defaultAvatar;
      if (avatarUrlElement) avatarUrlElement.value = defaultAvatar;
      if (coverPreviewElement)
        coverPreviewElement.src = xProfile.xCover || 'https://i.postimg.cc/qRzMB6nQ/default-cover.jpg';
      if (coverUrlElement) coverUrlElement.value = xProfile.xCover || '';
      if (nameElement) nameElement.value = xProfile.xName;
      if (handleElement) handleElement.value = xProfile.xHandle;
      if (verifiedElement) verifiedElement.checked = xProfile.xVerified;
      if (tag1IconElement) tag1IconElement.value = xProfile.customTag1?.icon || '';
      if (tag1TextElement) tag1TextElement.value = xProfile.customTag1?.text || '';
      if (tag1ColorElement) tag1ColorElement.value = xProfile.customTag1?.color || '#71767b';
      if (tag2IconElement) tag2IconElement.value = xProfile.customTag2?.icon || '';
      if (tag2TextElement) tag2TextElement.value = xProfile.customTag2?.text || '';
      if (tag2ColorElement) tag2ColorElement.value = xProfile.customTag2?.color || '#71767b';
      if (followingCountElement) followingCountElement.value = xProfile.followingCount || '';
      if (followersCountElement) followersCountElement.value = xProfile.followersCount || '';
      if (bioElement) bioElement.value = xProfile.xBio || '';
      if (publicIdentityElement) publicIdentityElement.value = xProfile.publicIdentity || '';
      if (showRealNameElement) showRealNameElement.checked = xProfile.showRealName || false;
      if (realNameElement) realNameElement.value = xProfile.realName || '';

      // æ ¹æ®å¤é€‰æ¡†çŠ¶æ€æ˜¾ç¤º/éšè—çœŸåè¾“å…¥æ¡†
      toggleCharacterRealNameInput();

      // æ›´æ–°å­—ç¬¦è®¡æ•°
      updateCharacterXProfileCounts();

      // è®¾ç½®å½“å‰ç¼–è¾‘çš„è§’è‰²ID
      document.getElementById('character-x-profile-form').setAttribute('data-character-id', characterId);

      // æ¸²æŸ“å…³ç³»åˆ—è¡¨
      renderRelationshipsList(xProfile.relationships || []);

      // æ˜¾ç¤ºå¼¹çª—
      document.getElementById('character-x-profile-modal').style.display = 'block';
    } catch (error) {
      ValidationUtils.handleError(error, 'æ‰“å¼€è§’è‰²Xèµ„æ–™');
    }
  }

  // å…³é—­è§’è‰²Xèµ„æ–™è®¾ç½®å¼¹çª—
  function closeCharacterXProfileModal() {
    document.getElementById('character-x-profile-modal').style.display = 'none';
  }

  // æ›´æ–°è§’è‰²Xå¤´åƒ
  function updateCharacterXAvatar(url) {
    const avatarImg = document.getElementById('character-x-avatar');

    if (!url || url.trim() === '') {
      // å¦‚æœURLä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
      avatarImg.src = 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg';
      return;
    }

    // éªŒè¯URLæ ¼å¼
    try {
      new URL(url);
    } catch (e) {
      avatarImg.src = 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg';
      return;
    }

    // éªŒè¯æ˜¯å¦ä¸ºå›¾ç‰‡URL
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
    const isImageUrl = imageExtensions.some(ext => url.toLowerCase().includes(ext));

    if (!isImageUrl) {
      // ä¸æ˜¯æ˜æ˜¾çš„å›¾ç‰‡URLï¼Œä½†ä»ç„¶å°è¯•åŠ è½½
      avatarImg.onerror = function () {
        this.src = 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg';
        showXToast('å¤´åƒé“¾æ¥æ— æ•ˆï¼Œå·²ä½¿ç”¨é»˜è®¤å¤´åƒ', 'warning');
      };
    }

    avatarImg.src = url;
  }

  // æ›´æ–°è§’è‰²XèƒŒæ™¯å›¾
  function updateCharacterXCover(url) {
    const coverImg = document.getElementById('character-x-cover-preview');

    if (!url || url.trim() === '') {
      coverImg.src = 'https://i.postimg.cc/qRzMB6nQ/default-cover.jpg';
      return;
    }

    try {
      new URL(url);
    } catch (e) {
      coverImg.src = 'https://i.postimg.cc/qRzMB6nQ/default-cover.jpg';
      return;
    }

    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
    const isImageUrl = imageExtensions.some(ext => url.toLowerCase().includes(ext));

    if (!isImageUrl) {
      coverImg.onerror = function () {
        this.src = 'https://i.postimg.cc/qRzMB6nQ/default-cover.jpg';
        showXToast('èƒŒæ™¯å›¾é“¾æ¥æ— æ•ˆï¼Œå·²ä½¿ç”¨é»˜è®¤èƒŒæ™¯', 'warning');
      };
    }

    coverImg.src = url;
  }

  // æ›´æ–°ç®€ä»‹å­—ç¬¦è®¡æ•°ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
  function updateCharacterBioCount() {
    updateCharacterXProfileCounts();
  }

  // æ›´æ–°è§’è‰²Xèµ„æ–™æ‰€æœ‰å­—ç¬¦è®¡æ•°
  function updateCharacterXProfileCounts() {
    // æ›´æ–°ç®€ä»‹è®¡æ•°
    const bioTextarea = document.getElementById('character-x-bio');
    const bioCountSpan = document.getElementById('character-bio-count');
    if (bioTextarea && bioCountSpan) {
      bioCountSpan.textContent = bioTextarea.value.length;
    }

    // è§’è‰²å…¬ä¼—èº«ä»½å·²ç§»é™¤å­—ç¬¦é™åˆ¶ï¼Œæ— éœ€è®¡æ•°

    // æ›´æ–°çœŸå®å§“åè®¡æ•°
    const realNameInput = document.getElementById('character-real-name');
    const realNameCountSpan = document.getElementById('character-real-name-count');
    if (realNameInput && realNameCountSpan) {
      realNameCountSpan.textContent = realNameInput.value.length;
    }
  }

  // ä¿å­˜è§’è‰²Xèµ„æ–™
  async function saveCharacterXProfile(event) {
    event.preventDefault();

    const characterId = document.getElementById('character-x-profile-form').getAttribute('data-character-id');
    const xName = document.getElementById('character-x-name').value.trim();
    const xHandle = document.getElementById('character-x-handle').value.trim();
    const xAvatarUrl = document.getElementById('character-x-avatar-url').value.trim();
    const xAvatar = xAvatarUrl || 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg';
    const xVerified = document.getElementById('character-x-verified').checked;
    const xCoverUrl = document.getElementById('character-x-cover-url').value.trim();
    const xCover = xCoverUrl || 'https://i.postimg.cc/qRzMB6nQ/default-cover.jpg';
    const tag1Icon = document.getElementById('character-tag1-icon').value.trim();
    const tag1Text = document.getElementById('character-custom-tag1').value.trim();
    const tag1Color = document.getElementById('character-tag1-color').value;
    const tag2Icon = document.getElementById('character-tag2-icon').value.trim();
    const tag2Text = document.getElementById('character-custom-tag2').value.trim();
    const tag2Color = document.getElementById('character-tag2-color').value;
    const followingCount = document.getElementById('character-following-count').value.trim();
    const followersCount = document.getElementById('character-followers-count').value.trim();
    const xBio = document.getElementById('character-x-bio').value.trim();
    const publicIdentity = document.getElementById('character-public-identity').value.trim();
    const showRealName = document.getElementById('character-show-real-name').checked;
    const realName = document.getElementById('character-real-name').value.trim();

    // éªŒè¯æ•°æ®
    if (!xName) {
      showXToast('Xç”¨æˆ·åä¸èƒ½ä¸ºç©º', 'error');
      return;
    }

    if (!xHandle) {
      showXToast('Xå¥æŸ„ä¸èƒ½ä¸ºç©º', 'error');
      return;
    }

    if (xName.length > 50) {
      showXToast('Xç”¨æˆ·åä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦', 'error');
      return;
    }

    if (xHandle.length > 15) {
      showXToast('Xå¥æŸ„ä¸èƒ½è¶…è¿‡15ä¸ªå­—ç¬¦', 'error');
      return;
    }

    if (xBio.length > 160) {
      showXToast('Xç®€ä»‹ä¸èƒ½è¶…è¿‡160ä¸ªå­—ç¬¦', 'error');
      return;
    }

    // å…¬ä¼—èº«ä»½å·²ç§»é™¤å­—ç¬¦é™åˆ¶

    if (showRealName && realName.length > 50) {
      showXToast('çœŸå®å§“åä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦', 'error');
      return;
    }

    if (showRealName && !realName) {
      showXToast('é€‰æ‹©å…¬å¼€çœŸåæ—¶å¿…é¡»å¡«å†™çœŸå®å§“å', 'error');
      return;
    }

    // éªŒè¯å¤´åƒURL
    if (xAvatarUrl) {
      try {
        new URL(xAvatarUrl);
      } catch (e) {
        showXToast('å¤´åƒURLæ ¼å¼æ— æ•ˆ', 'error');
        return;
      }
    }

    try {
      const db = getXDB();
      // è·å–å½“å‰å…³ç³»æ•°æ®
      const currentProfile = await db.xCharacterProfiles.get(characterId);
      const currentRelationships = currentProfile?.relationships || [];

      // ä¿å­˜Xèµ„æ–™
      await db.xCharacterProfiles.put({
        characterId: characterId,
        xName: xName,
        xHandle: xHandle,
        xAvatar: xAvatar,
        xVerified: xVerified,
        xCover: xCover,
        customTag1: tag1Text ? { icon: tag1Icon, text: tag1Text, color: tag1Color } : null,
        customTag2: tag2Text ? { icon: tag2Icon, text: tag2Text, color: tag2Color } : null,
        followingCount: followingCount,
        followersCount: followersCount,
        xBio: xBio,
        publicIdentity: publicIdentity,
        showRealName: showRealName,
        realName: showRealName ? realName : '', // åªæœ‰é€‰æ‹©å…¬å¼€æ—¶æ‰ä¿å­˜çœŸå
        relationships: currentRelationships,
        lastUpdated: new Date().toISOString(),
      });

      showXToast('Xèµ„æ–™å·²ä¿å­˜', 'success');
      closeCharacterXProfileModal();
    } catch (error) {
      console.error('ä¿å­˜è§’è‰²Xèµ„æ–™å¤±è´¥:', error);
      showXToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
  }

  // NPCå…³ç³»ç»‘å®šåŠŸèƒ½

  // å½“å‰ç¼–è¾‘çš„å…³ç³»IDï¼ˆç”¨äºç¼–è¾‘æ¨¡å¼ï¼‰
  let currentEditingRelationshipId = null;
  // å½“å‰å…³ç³»åˆ—è¡¨
  let currentRelationships = [];

  // æ¸²æŸ“å…³ç³»åˆ—è¡¨
  function renderRelationshipsList(relationships) {
    currentRelationships = relationships || [];
    const container = document.getElementById('character-relationships-list');

    if (currentRelationships.length === 0) {
      container.innerHTML = `
                <div style="text-align: center; color: #71767b; font-size: 13px; padding: 20px;">
                  æš‚æ— ç»‘å®šå…³ç³»ï¼Œç‚¹å‡»ä¸Šæ–¹"æ·»åŠ å…³ç³»"æŒ‰é’®å¼€å§‹ç»‘å®šNPC
                </div>
              `;
      return;
    }

    container.innerHTML = currentRelationships
      .map(
        rel => `
              <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                  <div style="flex: 1;">
                    <div style="color: #fff; font-weight: 600; font-size: 14px; margin-bottom: 4px;">
                      ${rel.npcName} <span style="color: #71767b; font-weight: normal;">${rel.npcHandle}</span>
                    </div>
                    <div style="color: #1d9bf0; font-size: 12px; background-color: rgba(29,155,240,0.1); padding: 2px 8px; border-radius: 12px; display: inline-block; margin-bottom: 6px;">
                      ${rel.relationshipType}
                    </div>
                  </div>
                  <div style="display: flex; gap: 8px;">
                    <button onclick="editRelationship('${rel.id}')" 
                      style="background: none; border: none; color: #1d9bf0; cursor: pointer; padding: 4px 8px; font-size: 12px;">
                      ç¼–è¾‘
                    </button>
                    <button onclick="deleteRelationship('${rel.id}')" 
                      style="background: none; border: none; color: #f4212e; cursor: pointer; padding: 4px 8px; font-size: 12px;">
                      åˆ é™¤
                    </button>
                  </div>
                </div>
                ${
                  rel.description
                    ? `<div style="color: #71767b; font-size: 12px; line-height: 1.4;">${rel.description}</div>`
                    : ''
                }
              </div>
            `,
      )
      .join('');
  }

  // æ‰“å¼€æ·»åŠ å…³ç³»å¼¹çª—
  function openAddRelationshipModal() {
    currentEditingRelationshipId = null;
    document.getElementById('relationship-modal-title').textContent = 'æ·»åŠ NPCå…³ç³»';

    // æ¸…ç©ºè¡¨å•
    document.getElementById('relationship-npc-name').value = '';
    document.getElementById('relationship-npc-handle').value = '';
    document.getElementById('relationship-type').value = 'æœ‹å‹';
    document.getElementById('relationship-description').value = '';
    updateRelationshipDescCount();

    document.getElementById('relationship-modal').style.display = 'block';
  }

  // ç¼–è¾‘å…³ç³»
  function editRelationship(relationshipId) {
    const relationship = currentRelationships.find(rel => rel.id === relationshipId);
    if (!relationship) return;

    currentEditingRelationshipId = relationshipId;
    document.getElementById('relationship-modal-title').textContent = 'ç¼–è¾‘NPCå…³ç³»';

    // å¡«å……è¡¨å•
    document.getElementById('relationship-npc-name').value = relationship.npcName;
    document.getElementById('relationship-npc-handle').value = relationship.npcHandle;
    document.getElementById('relationship-type').value = relationship.relationshipType;
    document.getElementById('relationship-description').value = relationship.description || '';
    updateRelationshipDescCount();

    document.getElementById('relationship-modal').style.display = 'block';
  }

  // åˆ é™¤å…³ç³»
  async function deleteRelationship(relationshipId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…³ç³»ç»‘å®šå—ï¼Ÿ')) return;

    try {
      // ä»å½“å‰åˆ—è¡¨ä¸­ç§»é™¤
      currentRelationships = currentRelationships.filter(rel => rel.id !== relationshipId);

      // ä¿å­˜åˆ°æ•°æ®åº“
      await saveRelationshipsToDatabase();

      // æ›´æ–°ç•Œé¢
      renderRelationshipsList(currentRelationships);

      showXToast('å…³ç³»å·²åˆ é™¤', 'success');
    } catch (error) {
      console.error('åˆ é™¤å…³ç³»å¤±è´¥:', error);
      showXToast('åˆ é™¤å¤±è´¥', 'error');
    }
  }

  // å…³é—­å…³ç³»ç¼–è¾‘å¼¹çª—
  function closeRelationshipModal() {
    document.getElementById('relationship-modal').style.display = 'none';
    currentEditingRelationshipId = null;
  }

  // æ›´æ–°å…³ç³»æè¿°å­—ç¬¦è®¡æ•°
  function updateRelationshipDescCount() {
    const descTextarea = document.getElementById('relationship-description');
    const countSpan = document.getElementById('relationship-desc-count');
    countSpan.textContent = descTextarea.value.length;
  }

  // ä¿å­˜å…³ç³»åˆ°æ•°æ®åº“
  async function saveRelationshipsToDatabase() {
    const characterId = document.getElementById('character-x-profile-form').getAttribute('data-character-id');
    if (!characterId) return;

    try {
      const db = getXDB();

      // è·å–å½“å‰Xèµ„æ–™
      const currentProfile = await db.xCharacterProfiles.get(characterId);
      if (currentProfile) {
        // æ›´æ–°å…³ç³»æ•°æ®
        currentProfile.relationships = currentRelationships;
        await db.xCharacterProfiles.put(currentProfile);
      }
    } catch (error) {
      console.error('ä¿å­˜å…³ç³»åˆ°æ•°æ®åº“å¤±è´¥:', error);
      throw error;
    }
  }

  // ä¿å­˜å…³ç³»è¡¨å•
  async function saveRelationshipForm(event) {
    event.preventDefault();

    const npcName = document.getElementById('relationship-npc-name').value.trim();
    const npcHandle = document.getElementById('relationship-npc-handle').value.trim();
    const relationshipType = document.getElementById('relationship-type').value;
    const description = document.getElementById('relationship-description').value.trim();

    // éªŒè¯æ•°æ®
    if (!npcName) {
      showXToast('NPCåç§°ä¸èƒ½ä¸ºç©º', 'error');
      return;
    }

    if (!npcHandle) {
      showXToast('NPCå¥æŸ„ä¸èƒ½ä¸ºç©º', 'error');
      return;
    }

    // ç¡®ä¿å¥æŸ„æ ¼å¼æ­£ç¡®
    const handleFormatted = npcHandle.startsWith('@') ? npcHandle : `@${npcHandle}`;

    try {
      if (currentEditingRelationshipId) {
        // ç¼–è¾‘æ¨¡å¼
        const relationshipIndex = currentRelationships.findIndex(rel => rel.id === currentEditingRelationshipId);
        if (relationshipIndex !== -1) {
          currentRelationships[relationshipIndex] = {
            ...currentRelationships[relationshipIndex],
            npcName: npcName,
            npcHandle: handleFormatted,
            relationshipType: relationshipType,
            description: description,
            updatedAt: new Date().toISOString(),
          };
        }
      } else {
        // æ·»åŠ æ¨¡å¼
        const newRelationship = {
          id: 'rel_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          npcName: npcName,
          npcHandle: handleFormatted,
          relationshipType: relationshipType,
          description: description,
          createdAt: new Date().toISOString(),
        };
        currentRelationships.push(newRelationship);
      }

      // ä¿å­˜åˆ°æ•°æ®åº“
      await saveRelationshipsToDatabase();

      // æ›´æ–°ç•Œé¢
      renderRelationshipsList(currentRelationships);

      // å…³é—­å¼¹çª—
      closeRelationshipModal();

      showXToast(currentEditingRelationshipId ? 'å…³ç³»å·²æ›´æ–°' : 'å…³ç³»å·²æ·»åŠ ', 'success');
    } catch (error) {
      console.error('ä¿å­˜å…³ç³»å¤±è´¥:', error);
      showXToast('ä¿å­˜å¤±è´¥', 'error');
    }
  }

  // ============================================
  // NPCç»‘å®šåŠŸèƒ½
  // ============================================

  // å½“å‰ç¼–è¾‘çš„NPC ID
  let currentEditingNPCId = null;

  // åˆ‡æ¢NPCç»‘å®šå¼€å…³
  async function toggleNPCBinding() {
    xSettingsData.npcBinding = !xSettingsData.npcBinding;

    // æ›´æ–°UI
    updateNPCToggleUI();

    // æ˜¾ç¤º/éšè—NPCç®¡ç†åŒºåŸŸ
    const npcArea = document.getElementById('npc-binding-area');
    if (xSettingsData.npcBinding) {
      npcArea.style.display = 'block';
      await loadNPCsList();
    } else {
      npcArea.style.display = 'none';
    }

    // è‡ªåŠ¨ä¿å­˜è®¾ç½®
    await saveXSettings();
  }

  // æ›´æ–°NPCç»‘å®šåˆ‡æ¢æŒ‰é’®UI
  function updateNPCToggleUI() {
    const toggle = document.getElementById('x-npc-toggle');
    const circle = toggle.querySelector('.toggle-circle');

    if (xSettingsData.npcBinding) {
      toggle.style.backgroundColor = '#1d9bf0';
      circle.style.left = '22px';
    } else {
      toggle.style.backgroundColor = '#333';
      circle.style.left = '2px';
    }
  }

  // åŠ è½½NPCåˆ—è¡¨
  async function loadNPCsList() {
    try {
      const db = getXDB();
      const npcId = 'xNPCs_global'; // å…¨å±€å­˜å‚¨ï¼Œæ‰€æœ‰è´¦å·å…±äº«
      const npcData = await db.xNPCs.get(npcId);
      const allNPCs = npcData?.npcs || [];

      // è¿‡æ»¤å‡ºç»‘å®šäº†å½“å‰è´¦å·çš„NPC
      const currentAccount = currentAccountId || 'main';
      const npcs = allNPCs.filter(npc => npc.boundUsers && npc.boundUsers.includes(currentAccount));

      const npcsList = document.getElementById('npcs-list');

      if (npcs.length === 0) {
        npcsList.innerHTML =
          '<p style="color: #71767b; font-size: 14px; text-align: center; padding: 20px 0;">æš‚æ— ç»‘å®šåˆ°æ­¤è´¦å·çš„NPCï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»º</p>';
        return;
      }

      npcsList.innerHTML = npcs
        .map(
          npc => `
          <div style="
            background-color: #0a0a0a;
            border: 1px solid #2f3336;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
          ">
            <img src="${npc.avatar || 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg'}" 
              style="width: 48px; height: 48px; border-radius: 50%; flex-shrink: 0;" 
              alt="${npc.name}">
            <div style="flex: 1; min-width: 0;">
              <div style="color: #fff; font-weight: 600; font-size: 15px; margin-bottom: 2px;">${npc.name}</div>
              <div style="color: #71767b; font-size: 14px;">${npc.handle}</div>
              <div style="color: #71767b; font-size: 13px; margin-top: 4px;">
                ç»‘å®šç”¨æˆ·: ${npc.boundUsers?.length || 0}ä¸ª
              </div>
            </div>
            <div style="display: flex; gap: 8px; flex-shrink: 0;">
              <button onclick="editNPC('${npc.id}')" style="
                background-color: #1d9bf0;
                color: #fff;
                border: none;
                border-radius: 15px;
                padding: 6px 12px;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
              " onmouseover="this.style.backgroundColor='#1a8cd8'" onmouseout="this.style.backgroundColor='#1d9bf0'">
                ç¼–è¾‘
              </button>
              <button onclick="deleteNPC('${npc.id}')" style="
                background-color: #f4212e;
                color: #fff;
                border: none;
                border-radius: 15px;
                padding: 6px 12px;
                font-size: 13px;
                cursor: pointer;
                white-space: nowrap;
                transition: all 0.2s;
              " onmouseover="this.style.backgroundColor='#d11a29'" onmouseout="this.style.backgroundColor='#f4212e'">
                åˆ é™¤
              </button>
            </div>
          </div>
        `,
        )
        .join('');
    } catch (error) {
      console.error('åŠ è½½NPCåˆ—è¡¨å¤±è´¥:', error);
      document.getElementById('npcs-list').innerHTML =
        '<p style="color: #f4212e; font-size: 14px; text-align: center; padding: 20px 0;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
    }
  }

  // æ‰“å¼€åˆ›å»ºNPCå¼¹çª—
  function openCreateNPCModal() {
    currentEditingNPCId = null;

    // æ¸…ç©ºè¡¨å•
    document.getElementById('npc-name').value = '';
    document.getElementById('npc-handle').value = '';
    document.getElementById('npc-avatar').value = '';
    document.getElementById('npc-personality').value = '';
    document.getElementById('npc-posting-habits').value = '';
    document.getElementById('npc-homepage').value = '';

    // æ›´æ–°æ ‡é¢˜
    document.getElementById('npc-modal-title').textContent = 'åˆ›å»ºNPC';

    // åŠ è½½ç”¨æˆ·åˆ—è¡¨
    loadNPCBindUsersList();

    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('npc-edit-modal').style.display = 'block';
    document.body.style.overflow = 'hidden';
  }

  // ç¼–è¾‘NPC
  async function editNPC(npcId) {
    try {
      const db = getXDB();
      const npcDataId = 'xNPCs_global'; // å…¨å±€å­˜å‚¨ï¼Œæ‰€æœ‰è´¦å·å…±äº«
      const npcData = await db.xNPCs.get(npcDataId);
      const npcs = npcData?.npcs || [];
      const npc = npcs.find(n => n.id === npcId);

      if (!npc) {
        showXToast('NPCä¸å­˜åœ¨', 'error');
        return;
      }

      currentEditingNPCId = npcId;

      // å¡«å……è¡¨å•
      document.getElementById('npc-name').value = npc.name || '';
      document.getElementById('npc-handle').value = npc.handle || '';
      document.getElementById('npc-avatar').value = npc.avatar || '';
      document.getElementById('npc-personality').value = npc.personality || '';
      document.getElementById('npc-posting-habits').value = npc.postingHabits || '';
      document.getElementById('npc-homepage').value = npc.homepage || '';

      // æ›´æ–°æ ‡é¢˜
      document.getElementById('npc-modal-title').textContent = 'ç¼–è¾‘NPC';

      // åŠ è½½ç”¨æˆ·åˆ—è¡¨å¹¶é€‰ä¸­å·²ç»‘å®šçš„ç”¨æˆ·
      await loadNPCBindUsersList(npc.boundUsers || []);

      // æ˜¾ç¤ºå¼¹çª—
      document.getElementById('npc-edit-modal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    } catch (error) {
      console.error('åŠ è½½NPCæ•°æ®å¤±è´¥:', error);
      showXToast('åŠ è½½å¤±è´¥', 'error');
    }
  }

  // åŠ è½½ç»‘å®šç”¨æˆ·åˆ—è¡¨
  async function loadNPCBindUsersList(selectedUsers = []) {
    try {
      const db = getXDB();
      const accounts = await db.xAccountList.toArray();

      const usersList = document.getElementById('npc-bind-users');

      if (accounts.length === 0) {
        usersList.innerHTML =
          '<p style="color: #71767b; font-size: 14px; text-align: center; padding: 10px 0;">æš‚æ— è´¦å·</p>';
        return;
      }

      usersList.innerHTML = accounts
        .map(account => {
          const isChecked = selectedUsers.includes(account.accountId);
          return `
          <label style="
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s;
          " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.05)'"
            onmouseout="this.style.backgroundColor='transparent'">
            <input 
              type="checkbox" 
              value="${account.accountId}" 
              ${isChecked ? 'checked' : ''}
              style="width: 16px; height: 16px; accent-color: #1d9bf0; cursor: pointer;">
            <img src="${account.avatar}" style="width: 32px; height: 32px; border-radius: 50%;" alt="${account.name}">
            <div style="flex: 1;">
              <div style="color: #fff; font-size: 14px; font-weight: 600;">${account.name}</div>
              <div style="color: #71767b; font-size: 13px;">è´¦å·ID: ${account.accountId}</div>
            </div>
          </label>
        `;
        })
        .join('');
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
    }
  }

  // ä¿å­˜NPC
  async function saveNPC() {
    try {
      const name = document.getElementById('npc-name').value.trim();
      const handle = document.getElementById('npc-handle').value.trim();
      const avatar = document.getElementById('npc-avatar').value.trim();
      const personality = document.getElementById('npc-personality').value.trim();
      const postingHabits = document.getElementById('npc-posting-habits').value.trim();
      const homepage = document.getElementById('npc-homepage').value.trim();

      // è·å–é€‰ä¸­çš„ç”¨æˆ·
      const boundUsers = Array.from(document.querySelectorAll('#npc-bind-users input[type="checkbox"]:checked')).map(
        input => input.value,
      );

      // éªŒè¯æ•°æ®
      if (!name) {
        showXToast('NPCå§“åä¸èƒ½ä¸ºç©º', 'error');
        return;
      }

      if (!handle) {
        showXToast('NPCå¥æŸ„ä¸èƒ½ä¸ºç©º', 'error');
        return;
      }

      // ç¡®ä¿å¥æŸ„æ ¼å¼æ­£ç¡®
      const handleFormatted = handle.startsWith('@') ? handle : `@${handle}`;

      const db = getXDB();
      const npcDataId = 'xNPCs_global'; // å…¨å±€å­˜å‚¨ï¼Œæ‰€æœ‰è´¦å·å…±äº«
      const npcData = await db.xNPCs.get(npcDataId);
      let npcs = npcData?.npcs || [];

      if (currentEditingNPCId) {
        // ç¼–è¾‘æ¨¡å¼
        const index = npcs.findIndex(n => n.id === currentEditingNPCId);
        if (index !== -1) {
          npcs[index] = {
            ...npcs[index],
            name,
            handle: handleFormatted,
            avatar: avatar || 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
            personality,
            postingHabits,
            homepage,
            boundUsers,
            updatedAt: new Date().toISOString(),
          };
        }
      } else {
        // åˆ›å»ºæ¨¡å¼
        const newNPC = {
          id: 'npc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          name,
          handle: handleFormatted,
          avatar: avatar || 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
          personality,
          postingHabits,
          homepage,
          boundUsers,
          createdAt: new Date().toISOString(),
        };
        npcs.push(newNPC);
      }

      // ä¿å­˜åˆ°æ•°æ®åº“
      await db.xNPCs.put({
        id: npcDataId,
        npcs,
        lastUpdated: new Date().toISOString(),
      });

      console.log(`âœ… NPCå·²${currentEditingNPCId ? 'æ›´æ–°' : 'åˆ›å»º'}:`, name, handle);
      console.log('ğŸ“ ç»‘å®šè´¦å·æ•°é‡:', boundUsers.length);
      console.log('ğŸ“ ç»‘å®šè´¦å·åˆ—è¡¨:', boundUsers.length > 0 ? boundUsers : 'æ— ');

      // åˆ·æ–°åˆ—è¡¨
      await loadNPCsList();

      // å…³é—­å¼¹çª—
      closeNPCEditModal();

      showXToast(currentEditingNPCId ? 'NPCå·²æ›´æ–°' : 'NPCå·²åˆ›å»º', 'success');
    } catch (error) {
      console.error('ä¿å­˜NPCå¤±è´¥:', error);
      showXToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
  }

  // åˆ é™¤NPC
  async function deleteNPC(npcId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªNPCå—ï¼Ÿ\næ­¤æ“ä½œå°†å½±å“æ‰€æœ‰ç»‘å®šäº†æ­¤NPCçš„è´¦å·ã€‚')) return;

    try {
      const db = getXDB();
      const npcDataId = 'xNPCs_global'; // å…¨å±€å­˜å‚¨ï¼Œæ‰€æœ‰è´¦å·å…±äº«
      const npcData = await db.xNPCs.get(npcDataId);
      let npcs = npcData?.npcs || [];

      npcs = npcs.filter(n => n.id !== npcId);

      await db.xNPCs.put({
        id: npcDataId,
        npcs,
        lastUpdated: new Date().toISOString(),
      });

      await loadNPCsList();

      showXToast('NPCå·²åˆ é™¤', 'success');
    } catch (error) {
      console.error('åˆ é™¤NPCå¤±è´¥:', error);
      showXToast('åˆ é™¤å¤±è´¥', 'error');
    }
  }

  // å…³é—­NPCç¼–è¾‘å¼¹çª—
  function closeNPCEditModal(event) {
    if (event && event.target !== event.currentTarget) return;

    document.getElementById('npc-edit-modal').style.display = 'none';
    document.body.style.overflow = 'auto';
    currentEditingNPCId = null;
  }

  // ç”¨æˆ·ä¸»é¡µç›¸å…³åŠŸèƒ½

  // åˆ‡æ¢ä¸»é¡µæ ‡ç­¾
  function switchProfileTab(tabName) {
    // é‡ç½®æ‰€æœ‰æ ‡ç­¾æ ·å¼
    document.querySelectorAll('.profile-tab').forEach(tab => {
      tab.classList.remove('active');
      tab.style.color = '#71767b';
      tab.querySelector('.tab-indicator').style.display = 'none';
    });

    // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
    document.querySelectorAll('.profile-tab-content').forEach(content => {
      content.style.display = 'none';
    });

    // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
    const activeTab = document.querySelector(`.profile-tab[onclick="switchProfileTab('${tabName}')"]`);
    if (activeTab) {
      activeTab.classList.add('active');
      activeTab.style.color = '#fff';
      activeTab.querySelector('.tab-indicator').style.display = 'block';
    }

    // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹åŒºåŸŸ
    const contentArea = document.getElementById(`profile-${tabName}-content`);
    if (contentArea) {
      contentArea.style.display = 'block';
    }

    // å¦‚æœåˆ‡æ¢åˆ°å¸–å­æ ‡ç­¾ï¼ŒåŠ è½½ç”¨æˆ·æ¨æ–‡
    if (tabName === 'posts') {
      loadUserProfileTweets();
    }
  }

  // ç¼–è¾‘ä¸ªäººèµ„æ–™
  function editProfile() {
    openEditProfileModal();
  }

  // åŠ è½½ç”¨æˆ·èµ„æ–™åˆ°UI
  function loadUserProfileToUI() {
    // ä½¿ç”¨window.userProfileDataç¡®ä¿è¯»å–æœ€æ–°æ•°æ®
    const profile = window.userProfileData;

    // æ›´æ–°é¡¶æ å¤´åƒ
    const topBarAvatar = document.getElementById('top-bar-avatar');
    if (topBarAvatar) {
      topBarAvatar.src = profile.avatar;
    }

    // æ›´æ–°ä¸»é¡µä¿¡æ¯
    const profileElements = {
      'x-profile-header-name': profile.name,
      'x-profile-user-name': profile.name,
      'x-profile-user-handle': profile.handle,
      'x-profile-bio': profile.bio,
      'x-profile-following-count': profile.following,
      'x-profile-followers-count': profile.followers,
    };

    Object.entries(profileElements).forEach(([id, value]) => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = value;
      }
    });

    // æ›´æ–°è‡ªå®šä¹‰æ ‡ç­¾å†…å®¹ã€å›¾æ ‡å’Œé¢œè‰²
    const tag1Element = document.getElementById('x-profile-tag1');
    const tag1IconElement = document.getElementById('x-profile-tag1-icon');
    const tag2Element = document.getElementById('x-profile-tag2');
    const tag2IconElement = document.getElementById('x-profile-tag2-icon');

    if (tag1Element) {
      tag1Element.textContent = profile.customTag1;
      tag1Element.style.color = profile.customTag1Color || '#71767b';
    }
    if (tag1IconElement) {
      tag1IconElement.textContent = profile.customTag1Icon || 'âœ¨';
    }
    if (tag2Element) {
      tag2Element.textContent = profile.customTag2;
      tag2Element.style.color = profile.customTag2Color || '#71767b';
    }
    if (tag2IconElement) {
      tag2IconElement.textContent = profile.customTag2Icon || 'ğŸ“…';
    }

    // æ›´æ–°å¤´åƒ
    const mainAvatar = document.getElementById('x-profile-main-avatar');
    if (mainAvatar) {
      mainAvatar.src = profile.avatar;
    }

    // æ›´æ–°å°é¢å›¾
    const coverImage = document.getElementById('x-profile-cover-image');
    if (coverImage) {
      coverImage.src = profile.coverImage;
    }

    // æ›´æ–°è®¤è¯å¾½ç« 
    updateVerificationBadge();

    // æ›´æ–°è¯„è®ºè¾“å…¥åŒºåŸŸçš„å¤´åƒ
    const commentInputAvatar = document.querySelector('#comment-input-area img, .comment-input-area img');
    if (commentInputAvatar) {
      commentInputAvatar.src = profile.avatar;
    }

    // æ›´æ–°ä¸»é¡µè¯„è®ºè¾“å…¥æ¡†å¤´åƒ
    const commentUserAvatar = document.getElementById('comment-user-avatar');
    if (commentUserAvatar) {
      commentUserAvatar.src = profile.avatar;
    }

    // æ›´æ–°è¯¦æƒ…é¡µè¯„è®ºè¾“å…¥æ¡†å¤´åƒ
    const detailCommentUserAvatar = document.getElementById('detail-comment-user-avatar');
    if (detailCommentUserAvatar) {
      detailCommentUserAvatar.src = profile.avatar;
    }

    // æ›´æ–°æ‰€æœ‰å›å¤è¾“å…¥æ¡†å¤´åƒ
    const replyUserAvatars = document.querySelectorAll('.reply-user-avatar');
    replyUserAvatars.forEach(avatar => {
      avatar.src = profile.avatar;
    });

    // æ›´æ–°å‘å¸–å¼¹çª—å¤´åƒ
    const composeUserAvatar = document.getElementById('compose-user-avatar');
    if (composeUserAvatar) {
      composeUserAvatar.src = profile.avatar;
    }

    console.log('âœ… UIå·²æ›´æ–°ï¼Œå½“å‰ç”¨æˆ·èµ„æ–™:', profile.name);
  }

  // æ›´æ–°è®¤è¯å¾½ç« æ˜¾ç¤º
  function updateVerificationBadge() {
    const verifiedBadge = document.getElementById('x-profile-verified-badge');
    if (!verifiedBadge) return;

    const verificationType = userProfileData.verificationType || 'none';

    // å¦‚æœæ˜¯æ— è®¤è¯ï¼Œéšè—å¾½ç« 
    if (verificationType === 'none') {
      verifiedBadge.style.display = 'none';
      return;
    }

    // æ˜¾ç¤ºå¾½ç« 
    verifiedBadge.style.display = 'inline-block';

    // æ ¹æ®è®¤è¯ç±»å‹è®¾ç½®ä¸åŒçš„å›¾æ ‡å’Œé¢œè‰²
    let badgeColor = '#1d9bf0'; // é»˜è®¤è“è‰²
    let badgePath = ''; // SVGè·¯å¾„

    switch (verificationType) {
      case 'verified':
        // è“è‰²å‹¾ - å·²è®¤è¯ï¼ˆä¿æŒåŸæ ·ï¼‰
        badgeColor = '#1d9bf0';
        badgePath =
          'M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z';
        break;
      case 'couple':
        // ç®€çº¦ç™½è‰²å¿ƒå½¢ - æƒ…ä¾£è®¤è¯
        badgeColor = '#ffffff';
        badgePath =
          'M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z';
        break;
      case 'married':
        // ç®€çº¦ç™½è‰²åœ†ç¯ - å·²å©šè®¤è¯
        badgeColor = '#ffffff';
        badgePath =
          'M12 4c4.42 0 8 3.58 8 8s-3.58 8-8 8-8-3.58-8-8 3.58-8 8-8zm0 2c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z';
        break;
      case 'vip':
        // ç®€çº¦ç™½è‰²è±å½¢ - VIPè®¤è¯
        badgeColor = '#ffffff';
        badgePath = 'M12 3l6 6-6 6-6-6 6-6zm0 2.83L8.83 9 12 12.17 15.17 9 12 5.83z';
        break;
      default:
        // é»˜è®¤è“è‰²å‹¾
        badgeColor = '#1d9bf0';
        badgePath =
          'M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z';
        break;
    }

    // æ›´æ–°å¾½ç« é¢œè‰²å’Œå›¾æ ‡
    verifiedBadge.style.fill = badgeColor;

    // æ›´æ–°SVGè·¯å¾„
    const pathElement = verifiedBadge.querySelector('path');
    if (pathElement) {
      pathElement.setAttribute('d', badgePath);
    }

    // æ·»åŠ æƒ…ä¾£è®¤è¯çš„ç‰¹æ®Šæç¤º
    if (verificationType === 'couple' && userProfileData.coupleCharacterName) {
      verifiedBadge.setAttribute('title', `æƒ…ä¾£è®¤è¯ - ä¸${userProfileData.coupleCharacterName}æ˜¯æƒ…ä¾£å…³ç³»`);
    } else {
      // è®¾ç½®å…¶ä»–è®¤è¯ç±»å‹çš„æç¤º
      const titles = {
        verified: 'å·²è®¤è¯è´¦æˆ·',
        married: 'å·²å©šè®¤è¯',
        vip: 'VIPè®¤è¯',
        couple: 'æƒ…ä¾£è®¤è¯',
      };
      verifiedBadge.setAttribute('title', titles[verificationType] || 'å·²è®¤è¯è´¦æˆ·');
    }
  }

  // ä¸ºè§’è‰²è®¾ç½®æƒ…ä¾£è®¤è¯
  async function setCoupleVerificationForCharacter(characterId, userNameAsCouple) {
    try {
      const db = getXDB();
      // è·å–è§’è‰²çš„Xèµ„æ–™
      let xProfile = await db.xCharacterProfiles.get(characterId);

      if (xProfile) {
        // ä¸ºè§’è‰²è®¾ç½®æƒ…ä¾£è®¤è¯
        xProfile.xVerified = true;
        xProfile.verificationType = 'couple';
        xProfile.couplePartnerName = userNameAsCouple;

        // ä¿å­˜æ›´æ–°
        await db.xCharacterProfiles.put(xProfile);

        console.log(`å·²ä¸ºè§’è‰² ${xProfile.xName} è®¾ç½®æƒ…ä¾£è®¤è¯ï¼Œæƒ…ä¾£å¯¹è±¡: ${userNameAsCouple}`);
      }
    } catch (error) {
      console.error('ä¸ºè§’è‰²è®¾ç½®æƒ…ä¾£è®¤è¯å¤±è´¥:', error);
    }
  }

  // åŒæ­¥ç”¨æˆ·å¤´åƒåˆ°æ‰€æœ‰ä½ç½®
  function syncUserAvatar(newAvatarUrl) {
    userProfileData.avatar = newAvatarUrl;

    // æ›´æ–°æ‰€æœ‰å¤´åƒä½ç½®
    const avatarSelectors = [
      '#top-bar-avatar',
      '#x-profile-main-avatar',
      '.comment-input-area img',
      '#comment-user-avatar',
      '#detail-comment-user-avatar',
      '#compose-user-avatar',
    ];

    avatarSelectors.forEach(selector => {
      const element = document.querySelector(selector);
      if (element) {
        element.src = newAvatarUrl;
      }
    });

    // æ›´æ–°æ‰€æœ‰å›å¤è¾“å…¥æ¡†å¤´åƒ
    document.querySelectorAll('.reply-user-avatar').forEach(avatar => {
      avatar.src = newAvatarUrl;
    });

    // æ›´æ–°ç”¨æˆ·å‘å¸ƒçš„è¯„è®ºä¸­çš„å¤´åƒ
    document.querySelectorAll('.comment-item img[alt="æˆ‘"], .comment-item img[alt="Your avatar"]').forEach(img => {
      img.src = newAvatarUrl;
    });
  }

  // æ¸²æŸ“ç”¨æˆ·çš„æ¨æ–‡åˆ°ä¸»é¡µ
  function renderUserTweets() {
    const container = document.getElementById('x-profile-tweets-container');
    if (!container) return;

    // è·å–ç”¨æˆ·å‘å¸ƒçš„æ¨æ–‡ï¼ˆè¿™é‡Œç®€åŒ–ä¸ºç©ºï¼Œå®é™…åº”è¯¥ä»æ•°æ®ä¸­ç­›é€‰ï¼‰
    const userTweets = [];

    if (userTweets.length === 0) {
      container.innerHTML = `
                <div style="padding: 60px 32px; text-align: center;">
                  <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;">è¿˜æ²¡æœ‰å‘å¸–</div>
                  <div style="color: #71767b; font-size: 15px;">å½“ä½ å‘å¸ƒæ¨æ–‡æ—¶ï¼Œå®ƒä»¬ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</div>
                </div>
              `;
    } else {
      container.innerHTML = '';
      userTweets.forEach(tweet => {
        const tweetElement = createTweetElement(tweet);
        container.appendChild(tweetElement);
      });
    }

    // æ›´æ–°å¸–å­æ•°é‡
    const headerCount = document.getElementById('x-profile-header-count');
    if (headerCount) {
      headerCount.textContent = `${userTweets.length} å¸–å­`;
    }
  }

  // å¤šè´¦æˆ·ç®¡ç†åŠŸèƒ½

  // å½“å‰æ¿€æ´»çš„è´¦æˆ·ID
  let currentAccountId = 'main';

  // åˆ‡æ¢ä¸ªäººä¸»é¡µèœå•
  function toggleProfileMenu() {
    const menu = document.getElementById('profile-dropdown-menu');
    const isVisible = menu.style.display !== 'none';

    if (isVisible) {
      menu.style.display = 'none';
    } else {
      menu.style.display = 'block';
    }
  }

  // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
  document.addEventListener('click', function (event) {
    const menuBtn = document.getElementById('profile-menu-btn');
    const menu = document.getElementById('profile-dropdown-menu');

    if (!menuBtn || !menu) return;

    if (!menuBtn.contains(event.target) && !menu.contains(event.target)) {
      menu.style.display = 'none';
    }
  });

  // æ‰“å¼€è´¦å·ç®¡ç†å¼¹çª—
  async function openAccountManager() {
    // å…³é—­ä¸‹æ‹‰èœå•
    document.getElementById('profile-dropdown-menu').style.display = 'none';

    // æ˜¾ç¤ºè´¦å·ç®¡ç†å¼¹çª—
    showAccountManagerModal();
  }

  // æ˜¾ç¤ºè´¦å·ç®¡ç†å¼¹çª—
  async function showAccountManagerModal() {
    // è·å–æ‰€æœ‰è´¦æˆ·
    const accounts = await getAllAccounts();

    // åˆ›å»ºå¼¹çª—
    const modal = document.createElement('div');
    modal.id = 'account-manager-modal';
    modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
            `;

    modal.innerHTML = `
            <div style="
                background-color: #1a1a1a;
                border-radius: 16px;
                width: 90%;
                max-width: 480px;
                max-height: 70vh;
                overflow-y: auto;
                border: 1px solid #333;
                position: relative;
              ">
              <!-- å¼¹çª—å¤´éƒ¨ -->
              <div style="
                  padding: 20px;
                  border-bottom: 1px solid #333;
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  position: sticky;
                  top: 0;
                  background-color: #1a1a1a;
                  z-index: 10;
                ">
                <div>
                  <h3 style="margin: 0; color: #fff; font-size: 20px; font-weight: 700;">è´¦å·ç®¡ç†</h3>
                  <p style="margin: 4px 0 0; color: #71767b; font-size: 14px;">ç®¡ç†ä½ çš„å¤šä¸ªXè´¦æˆ·</p>
                </div>
                <button onclick="closeAccountManager()" style="
                    background: transparent;
                    border: none;
                    color: #71767b;
                    cursor: pointer;
                    padding: 8px;
                    border-radius: 50%;
                    transition: background-color 0.2s;
                  " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'"
                  onmouseout="this.style.backgroundColor='transparent'">
                  <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                    <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>
                  </svg>
                </button>
              </div>

              <!-- è´¦æˆ·åˆ—è¡¨ -->
              <div style="padding: 20px;">
                <div id="accounts-list" style="margin-bottom: 20px;">
                  ${await renderAccountsList(accounts)}
                </div>

                <!-- æ–°å»ºè´¦æˆ·æŒ‰é’® -->
                <button onclick="createNewAccount()" style="
                    width: 100%;
                    background-color: #1d9bf0;
                    color: #fff;
                    border: none;
                    border-radius: 12px;
                    padding: 16px;
                    font-size: 16px;
                    font-weight: 700;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                  " onmouseover="this.style.backgroundColor='#1a8cd8'"
                  onmouseout="this.style.backgroundColor='#1d9bf0'">
                  <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                    <g><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></g>
                  </svg>
                  æ–°å»ºè´¦æˆ·
                </button>
              </div>
            </div>
            `;

    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';

    // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
    modal.addEventListener('click', e => {
      if (e.target === modal) {
        closeAccountManager();
      }
    });
  }

  // è·å–æ‰€æœ‰è´¦æˆ·
  async function getAllAccounts() {
    try {
      const db = getXDB();
      const accounts = await db.xAccountList.orderBy('createdAt').toArray();
      const activeAccount = await db.xActiveAccount.get('current');

      // å¦‚æœæ²¡æœ‰è´¦æˆ·è®°å½•ï¼Œåˆ›å»ºé»˜è®¤è´¦æˆ·
      if (accounts.length === 0) {
        const defaultAccount = {
          accountId: 'main',
          name: userProfileData.name || 'æˆ‘',
          avatar: userProfileData.avatar || 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg',
          createdAt: new Date().toISOString(),
          isActive: true,
        };
        await db.xAccountList.put(defaultAccount);
        await db.xActiveAccount.put({ id: 'current', accountId: 'main' });
        return [defaultAccount];
      }

      // æ ‡è®°å½“å‰æ¿€æ´»çš„è´¦æˆ·
      accounts.forEach(account => {
        account.isActive = activeAccount && activeAccount.accountId === account.accountId;
      });

      return accounts;
    } catch (error) {
      console.error('è·å–è´¦æˆ·åˆ—è¡¨å¤±è´¥:', error);
      return [];
    }
  }

  // æ¸²æŸ“è´¦æˆ·åˆ—è¡¨
  async function renderAccountsList(accounts) {
    if (accounts.length === 0) {
      return `
            <div style="text-align: center; color: #71767b; padding: 40px 20px;">
              <div style="font-size: 16px; margin-bottom: 8px;">æš‚æ— è´¦æˆ·</div>
              <div style="font-size: 14px;">åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªè´¦æˆ·</div>
            </div>
            `;
    }

    return accounts
      .map(
        account => `
            <div style="
                border: 2px solid ${account.isActive ? '#1d9bf0' : '#333'};
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                cursor: pointer;
                transition: all 0.2s;
                background-color: ${account.isActive ? 'rgba(29, 155, 240, 0.05)' : 'transparent'};
              " onclick="switchAccount('${account.accountId}')"
              onmouseover="if (!${account.isActive}) this.style.borderColor='#536471'"
              onmouseout="if (!${account.isActive}) this.style.borderColor='#333'">
              <div style="display: flex; align-items: center; gap: 12px;">
                <img src="${account.avatar}" style="width: 48px; height: 48px; border-radius: 50%;" alt="${
          account.name
        }">
                  <div style="flex: 1;">
                    <div style="color: #fff; font-size: 16px; font-weight: 700; margin-bottom: 4px;">
                      ${account.name}
                      ${
                        account.isActive
                          ? '<span style="color: #1d9bf0; font-size: 12px; margin-left: 8px;">â— å½“å‰è´¦æˆ·</span>'
                          : ''
                      }
                    </div>
                    <div style="color: #71767b; font-size: 14px;">
                      åˆ›å»ºäº ${new Date(account.createdAt).toLocaleDateString('zh-CN')}
                    </div>
                  </div>
                  ${
                    !account.isActive && account.accountId !== 'main'
                      ? `
                    <button onclick="event.stopPropagation(); deleteAccount('${account.accountId}')" style="
                      background: transparent;
                      border: 1px solid #ef4444;
                      color: #ef4444;
                      border-radius: 8px;
                      padding: 6px 8px;
                      font-size: 12px;
                      cursor: pointer;
                      transition: all 0.2s;
                    " onmouseover="this.style.backgroundColor='rgba(239, 68, 68, 0.1)'" 
                       onmouseout="this.style.backgroundColor='transparent'">
                      åˆ é™¤
                    </button>
                  `
                      : ''
                  }
              </div>
            </div>
            `,
      )
      .join('');
  }

  // å…³é—­è´¦å·ç®¡ç†å¼¹çª—
  function closeAccountManager() {
    const modal = document.getElementById('account-manager-modal');
    if (modal) {
      modal.remove();
    }
    document.body.style.overflow = 'auto';
  }

  // åˆ‡æ¢è´¦æˆ·
  async function switchAccount(accountId) {
    if (accountId === currentAccountId) {
      closeAccountManager();
      return;
    }

    try {
      const db = getXDB();

      // æ›´æ–°æ¿€æ´»è´¦æˆ·è®°å½•
      await db.xActiveAccount.put({ id: 'current', accountId: accountId });

      // æ›´æ–°å½“å‰è´¦æˆ·ID
      currentAccountId = accountId;

      // åŠ è½½æ–°è´¦æˆ·çš„æ•°æ®
      await loadUserProfileFromDB(accountId);

      // é‡æ–°åŠ è½½ X è®¾ç½®ï¼ˆæŒ‰è´¦å·åŠ è½½ï¼‰
      await initializeXSettings();

      // æ›´æ–°UIæ˜¾ç¤º
      loadUserProfileToUI();

      // åŒæ­¥å¤´åƒåˆ°æ‰€æœ‰ä½ç½®
      syncUserAvatar(userProfileData.avatar);

      // é‡æ–°åŠ è½½ä¸ªäººä¸»é¡µæ¨æ–‡ï¼ˆæŒ‰è´¦æˆ·éš”ç¦»ï¼‰
      if (document.getElementById('x-profile-page').style.display !== 'none') {
        loadUserProfileTweets();
      }

      // æ›´æ–°å‘å¸–å¼¹çª—çš„ç”¨æˆ·ä¿¡æ¯
      const composeAvatar = document.getElementById('compose-user-avatar');
      if (composeAvatar) {
        composeAvatar.src = userProfileData.avatar;
      }

      // å…³é—­å¼¹çª—
      closeAccountManager();

      showXToast(`å·²åˆ‡æ¢åˆ°è´¦æˆ·ï¼š${userProfileData.name}`, 'success');
      console.log('âœ… å·²åˆ‡æ¢è´¦æˆ·ï¼Œç»‘å®šè§’è‰²æ•°:', xSettingsData.boundCharacters?.length || 0);
    } catch (error) {
      console.error('åˆ‡æ¢è´¦æˆ·å¤±è´¥:', error);
      showXToast('åˆ‡æ¢è´¦æˆ·å¤±è´¥', 'error');
    }
  }

  // åˆ›å»ºæ–°è´¦æˆ·
  async function createNewAccount() {
    try {
      const db = getXDB();

      // ç”Ÿæˆæ–°çš„è´¦æˆ·ID
      const newAccountId = 'account_' + Date.now();

      // ä½¿ç”¨ç»Ÿä¸€çš„é»˜è®¤ç”¨æˆ·èµ„æ–™é…ç½®
      const defaultProfile = getDefaultUserProfile(newAccountId);

      // ä¿å­˜æ–°è´¦æˆ·çš„ç”¨æˆ·èµ„æ–™
      await db.xUserProfile.put(defaultProfile);

      // æ·»åŠ åˆ°è´¦æˆ·åˆ—è¡¨
      const newAccount = {
        accountId: newAccountId,
        name: 'æ–°ç”¨æˆ·',
        avatar: 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg',
        createdAt: new Date().toISOString(),
      };
      await db.xAccountList.put(newAccount);

      // è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°è´¦æˆ·
      await switchAccount(newAccountId);
    } catch (error) {
      console.error('åˆ›å»ºæ–°è´¦æˆ·å¤±è´¥:', error);
      showXToast('åˆ›å»ºæ–°è´¦æˆ·å¤±è´¥', 'error');
    }
  }

  // åˆ é™¤è´¦æˆ·
  async function deleteAccount(accountId) {
    if (accountId === 'main') {
      showXToast('æ— æ³•åˆ é™¤é»˜è®¤è´¦æˆ·', 'error');
      return;
    }

    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦æˆ·å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
      return;
    }

    try {
      const db = getXDB();

      // åˆ é™¤è´¦æˆ·çš„ç”¨æˆ·èµ„æ–™
      await db.xUserProfile.delete(accountId);

      // ä»è´¦æˆ·åˆ—è¡¨ä¸­åˆ é™¤
      await db.xAccountList.delete(accountId);

      showXToast('è´¦æˆ·å·²åˆ é™¤', 'success');

      // é‡æ–°æ˜¾ç¤ºè´¦æˆ·ç®¡ç†å¼¹çª—
      closeAccountManager();
      setTimeout(() => {
        showAccountManagerModal();
      }, 300);
    } catch (error) {
      console.error('åˆ é™¤è´¦æˆ·å¤±è´¥:', error);
      showXToast('åˆ é™¤è´¦æˆ·å¤±è´¥', 'error');
    }
  }

  // åˆå§‹åŒ–ç”¨æˆ·ä¸»é¡µ
  async function initializeUserProfile() {
    // é¦–å…ˆåŠ è½½å½“å‰æ¿€æ´»çš„è´¦æˆ·
    await loadActiveAccount();
    await loadUserProfileFromDB();
    loadUserProfileToUI();

    // åŒæ­¥å¤´åƒåˆ°æ‰€æœ‰ä½ç½®
    syncUserAvatar(userProfileData.avatar);

    // åŠ è½½å½“å‰è´¦æˆ·çš„æ¨æ–‡
    loadUserProfileTweets();
  }

  // åŠ è½½å½“å‰æ¿€æ´»çš„è´¦æˆ·
  async function loadActiveAccount() {
    try {
      const db = getXDB();

      // åˆå§‹åŒ–å¤šè´¦æˆ·ç³»ç»Ÿ
      await initializeMultiAccountSystem();

      const activeAccount = await db.xActiveAccount.get('current');
      if (activeAccount) {
        currentAccountId = activeAccount.accountId;
      } else {
        // å¦‚æœæ²¡æœ‰æ¿€æ´»è´¦æˆ·è®°å½•ï¼Œä½¿ç”¨é»˜è®¤è´¦æˆ·
        currentAccountId = 'main';
        await db.xActiveAccount.put({ id: 'current', accountId: 'main' });
      }
    } catch (error) {
      console.error('åŠ è½½æ¿€æ´»è´¦æˆ·å¤±è´¥:', error);
      currentAccountId = 'main';
    }
  }

  // åˆå§‹åŒ–å¤šè´¦æˆ·ç³»ç»Ÿ
  async function initializeMultiAccountSystem() {
    try {
      const db = getXDB();

      // æ£€æŸ¥æ˜¯å¦å­˜åœ¨é»˜è®¤è´¦æˆ·è®°å½•
      const defaultAccount = await db.xAccountList.get('main');
      if (!defaultAccount) {
        // ä»ç°æœ‰çš„ç”¨æˆ·èµ„æ–™åˆ›å»ºé»˜è®¤è´¦æˆ·è®°å½•
        const existingProfile = await db.xUserProfile.get('main');
        const defaultAccountData = {
          accountId: 'main',
          name: existingProfile?.name || 'æˆ‘',
          avatar: existingProfile?.avatar || 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg',
          createdAt: existingProfile?.lastUpdated || new Date().toISOString(),
        };
        await db.xAccountList.put(defaultAccountData);
        console.log('å·²åˆ›å»ºé»˜è®¤è´¦æˆ·è®°å½•');
      }

      // ç¡®ä¿æœ‰æ¿€æ´»è´¦æˆ·è®°å½•
      const activeAccount = await db.xActiveAccount.get('current');
      if (!activeAccount) {
        await db.xActiveAccount.put({ id: 'current', accountId: 'main' });
        console.log('å·²è®¾ç½®é»˜è®¤æ¿€æ´»è´¦æˆ·');
      }
    } catch (error) {
      console.error('åˆå§‹åŒ–å¤šè´¦æˆ·ç³»ç»Ÿå¤±è´¥:', error);
    }
  }

  // ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·èµ„æ–™ï¼ˆå¤šè´¦æˆ·ç³»ç»Ÿä¸“ç”¨ï¼‰
  async function loadUserProfileFromDB(accountId = null) {
    try {
      const db = getXDB();
      const targetAccountId = accountId || currentAccountId || 'main';
      const savedProfile = await db.xUserProfile.get(targetAccountId);

      if (savedProfile) {
        // æ›´æ–°ç°æœ‰å¯¹è±¡çš„å±æ€§ï¼ˆä¿æŒå¼•ç”¨ä¸€è‡´ï¼‰
        Object.assign(window.userProfileData, savedProfile);
      } else {
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·èµ„æ–™ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼ˆæ–°è´¦æˆ·çš„æƒ…å†µï¼‰
        console.log('âš ï¸ æœªæ‰¾åˆ°è´¦æˆ·èµ„æ–™ï¼Œä½¿ç”¨é»˜è®¤å€¼:', targetAccountId);
        const defaultProfile = getDefaultUserProfile(targetAccountId);
        Object.assign(window.userProfileData, defaultProfile);
      }

      // ç¡®ä¿æ‰€æœ‰å¿…è¦å­—æ®µå­˜åœ¨ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„å­—æ®µéªŒè¯ï¼‰
      ensureProfileFields(window.userProfileData);

      console.log('âœ… å·²åŠ è½½ç”¨æˆ·èµ„æ–™æ•°æ®:', targetAccountId);
      if (window.userProfileData.knownIdentityCharacters && window.userProfileData.knownIdentityCharacters.length > 0) {
        console.log('ğŸ“Œ å·²çŸ¥èº«ä»½è§’è‰²æ•°é‡:', window.userProfileData.knownIdentityCharacters.length);
      }
    } catch (error) {
      console.error('âŒ åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', error);
      const defaultProfile = getDefaultUserProfile('main');
      Object.assign(window.userProfileData, defaultProfile);
    }
  }

  // ä¿å­˜ç”¨æˆ·èµ„æ–™åˆ°æ•°æ®åº“
  async function saveUserProfileToDB() {
    try {
      const db = getXDB();
      const targetAccountId = currentAccountId || 'main';

      await db.xUserProfile.put({
        id: targetAccountId,
        ...window.userProfileData, // ä½¿ç”¨window.userProfileDataç¡®ä¿ä½¿ç”¨æœ€æ–°æ•°æ®
        lastUpdated: new Date().toISOString(),
      });

      // åŒæ—¶æ›´æ–°è´¦æˆ·åˆ—è¡¨ä¸­çš„åŸºæœ¬ä¿¡æ¯
      const existingAccount = await db.xAccountList.get(targetAccountId);
      if (existingAccount) {
        existingAccount.name = window.userProfileData.name;
        existingAccount.avatar = window.userProfileData.avatar;
        await db.xAccountList.put(existingAccount);
      }

      console.log('ç”¨æˆ·èµ„æ–™å·²ä¿å­˜åˆ°æ•°æ®åº“ï¼Œè´¦æˆ·ID:', targetAccountId);
      if (window.userProfileData.knownIdentityCharacters && window.userProfileData.knownIdentityCharacters.length > 0) {
        console.log('å·²çŸ¥èº«ä»½è§’è‰²:', window.userProfileData.knownIdentityCharacters.length + 'ä¸ª');
      }
    } catch (error) {
      console.error('ä¿å­˜ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
      throw error;
    }
  }

  // ç¼–è¾‘ä¸ªäººèµ„æ–™å¼¹çª—ç›¸å…³åŠŸèƒ½

  // æ‰“å¼€ç¼–è¾‘ä¸ªäººèµ„æ–™å¼¹çª—
  function openEditProfileModal() {
    const modal = document.getElementById('edit-profile-modal');
    modal.style.display = 'flex';

    // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
    document.body.style.overflow = 'hidden';

    // åŠ è½½å½“å‰æ•°æ®åˆ°ç¼–è¾‘è¡¨å•
    loadDataToEditForm();
  }

  // å…³é—­ç¼–è¾‘ä¸ªäººèµ„æ–™å¼¹çª—
  function closeEditProfileModal(event) {
    // å¦‚æœæœ‰äº‹ä»¶å‚æ•°ï¼Œæ£€æŸ¥æ˜¯å¦ç‚¹å‡»çš„æ˜¯èƒŒæ™¯åŒºåŸŸ
    if (event && event.target !== event.currentTarget) {
      return;
    }

    const modal = document.getElementById('edit-profile-modal');
    modal.style.display = 'none';

    // æ¢å¤èƒŒæ™¯æ»šåŠ¨
    document.body.style.overflow = 'auto';
  }

  // åŠ è½½å½“å‰ç”¨æˆ·æ•°æ®åˆ°ç¼–è¾‘è¡¨å•
  function loadDataToEditForm() {
    // ä½¿ç”¨window.userProfileDataç¡®ä¿è¯»å–æœ€æ–°æ•°æ®
    const profile = window.userProfileData;

    // åŠ è½½åŸºæœ¬ä¿¡æ¯
    document.getElementById('edit-user-name').value = profile.name;
    document.getElementById('edit-user-handle').value = profile.handle.replace('@', '');
    document.getElementById('edit-user-bio').value = profile.bio;
    document.getElementById('edit-custom-tag1').value = profile.customTag1;
    document.getElementById('edit-custom-tag2').value = profile.customTag2;
    document.getElementById('edit-following-count').value = profile.following;
    document.getElementById('edit-followers-count').value = profile.followers;

    // åŠ è½½æ ‡ç­¾å›¾æ ‡å’Œé¢œè‰²
    document.getElementById('edit-tag1-icon').value = profile.customTag1Icon || 'âœ¨';
    document.getElementById('edit-tag2-icon').value = profile.customTag2Icon || 'ğŸ“…';
    document.getElementById('edit-tag1-color').value = profile.customTag1Color || '#71767b';
    document.getElementById('edit-tag2-color').value = profile.customTag2Color || '#71767b';
    document.getElementById('edit-tag1-color-text').value = profile.customTag1Color || '#71767b';
    document.getElementById('edit-tag2-color-text').value = profile.customTag2Color || '#71767b';

    // åŠ è½½å›¾ç‰‡
    document.getElementById('edit-cover-image').src = profile.coverImage;
    document.getElementById('edit-main-avatar').src = profile.avatar;

    // åŠ è½½å…¬ä¼—èº«ä»½å’ŒçœŸåè®¾ç½®
    document.getElementById('edit-public-identity').value = profile.publicIdentity || '';
    document.getElementById('edit-show-real-name').checked = profile.showRealName || false;
    document.getElementById('edit-real-name').value = profile.realName || '';

    // æ ¹æ®å¤é€‰æ¡†çŠ¶æ€æ˜¾ç¤º/éšè—çœŸåè¾“å…¥æ¡†
    toggleRealNameInput();

    // æ›´æ–°å­—ç¬¦è®¡æ•°
    updateCharacterCounts();

    // åŠ è½½è®¤è¯ç±»å‹è®¾ç½®
    loadVerificationTypeData();

    // åŠ è½½è§’è‰²èº«ä»½è¯†åˆ«è®¾ç½®
    loadIdentityCharactersList();

    console.log('âœ… å·²åŠ è½½ç”¨æˆ·æ•°æ®åˆ°ç¼–è¾‘è¡¨å•');
  }

  // åŠ è½½è®¤è¯ç±»å‹æ•°æ®åˆ°ç¼–è¾‘è¡¨å•
  function loadVerificationTypeData() {
    // ä½¿ç”¨window.userProfileDataç¡®ä¿è¯»å–æœ€æ–°æ•°æ®
    const profile = window.userProfileData;

    // è®¾ç½®è®¤è¯ç±»å‹é€‰æ‹©
    const verificationTypeSelect = document.getElementById('edit-verification-type');
    if (verificationTypeSelect) {
      verificationTypeSelect.value = profile.verificationType || 'none';
    }

    // è®¾ç½®æƒ…ä¾£ç»‘å®šè§’è‰²
    const coupleCharacterSelect = document.getElementById('edit-couple-character');
    if (coupleCharacterSelect) {
      coupleCharacterSelect.value = profile.coupleCharacterId || '';
    }

    // åŠ è½½å¯é€‰æ‹©çš„è§’è‰²åˆ°æƒ…ä¾£ç»‘å®šä¸‹æ‹‰æ¡†
    loadCoupleCharacterOptions();

    // æ›´æ–°UIæ˜¾ç¤º
    updateVerificationTypeUI();
  }

  // æ›´æ–°è®¤è¯ç±»å‹UIæ˜¾ç¤º
  function updateVerificationTypeUI() {
    const verificationTypeSelect = document.getElementById('edit-verification-type');
    const coupleBindingSection = document.getElementById('couple-binding-section');

    if (!verificationTypeSelect || !coupleBindingSection) return;

    const selectedType = verificationTypeSelect.value;

    // æ ¹æ®é€‰æ‹©çš„è®¤è¯ç±»å‹æ˜¾ç¤º/éšè—æƒ…ä¾£ç»‘å®šé€‰é¡¹
    if (selectedType === 'couple') {
      coupleBindingSection.style.display = 'block';
    } else {
      coupleBindingSection.style.display = 'none';
    }
  }

  // åŠ è½½å¯é€‰æ‹©çš„è§’è‰²åˆ°æƒ…ä¾£ç»‘å®šä¸‹æ‹‰æ¡†
  async function loadCoupleCharacterOptions() {
    try {
      const db = getDB(); // chatsè¡¨åœ¨ä¸»æ•°æ®åº“ä¸­
      const xDb = getXDB(); // Xèµ„æ–™åœ¨Xä¸“ç”¨æ•°æ®åº“ä¸­

      // è·å–æ‰€æœ‰èŠå¤©è§’è‰²
      const allChats = await db.chats.toArray();
      const characters = allChats.filter(chat => !chat.isGroup);

      const coupleCharacterSelect = document.getElementById('edit-couple-character');
      if (!coupleCharacterSelect) return;

      // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
      coupleCharacterSelect.innerHTML =
        '<option value="" style="background-color: #000; color: #fff;">æœªé€‰æ‹©è§’è‰²</option>';

      // è·å–æ‰€æœ‰è§’è‰²çš„Xèµ„æ–™ï¼ˆä»Xä¸“ç”¨æ•°æ®åº“ï¼‰
      const characterProfiles = await xDb.xCharacterProfiles.toArray();
      const profileMap = new Map();
      characterProfiles.forEach(profile => {
        profileMap.set(profile.characterId, profile);
      });

      // æ·»åŠ è§’è‰²é€‰é¡¹
      characters.forEach(character => {
        const option = document.createElement('option');
        option.value = character.id;

        // ä¼˜å…ˆä½¿ç”¨Xå¹³å°åç§°ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®åˆ™ä½¿ç”¨è§’è‰²å
        const xProfile = profileMap.get(character.id);
        const displayName = xProfile?.xName || character.name;

        option.textContent = displayName;
        option.style.backgroundColor = '#000';
        option.style.color = '#fff';
        coupleCharacterSelect.appendChild(option);
      });

      // è®¾ç½®å½“å‰é€‰ä¸­çš„è§’è‰²
      if (userProfileData.coupleCharacterId) {
        coupleCharacterSelect.value = userProfileData.coupleCharacterId;
      }
    } catch (error) {
      console.error('åŠ è½½æƒ…ä¾£è§’è‰²é€‰é¡¹å¤±è´¥:', error);
    }
  }

  // æ›´æ–°å­—ç¬¦è®¡æ•°æ˜¾ç¤º
  function updateCharacterCounts() {
    const nameInput = document.getElementById('edit-user-name');
    const handleInput = document.getElementById('edit-user-handle');
    const bioInput = document.getElementById('edit-user-bio');
    const tag1Input = document.getElementById('edit-custom-tag1');
    const tag2Input = document.getElementById('edit-custom-tag2');

    // æ›´æ–°åç§°è®¡æ•°
    if (nameInput) {
      const nameCount = nameInput.value.length;
      nameInput.parentNode.querySelector('div').textContent = `${nameCount} / 50`;
    }

    // æ›´æ–°ç”¨æˆ·åè®¡æ•°
    if (handleInput) {
      const handleCount = handleInput.value.length;
      handleInput.parentNode.querySelector('div').textContent = `${handleCount} / 15`;
    }

    // æ›´æ–°ç®€ä»‹è®¡æ•°
    if (bioInput) {
      const bioCount = bioInput.value.length;
      bioInput.parentNode.querySelector('div').textContent = `${bioCount} / 160`;
    }

    // æ›´æ–°æ ‡ç­¾1è®¡æ•°
    if (tag1Input) {
      const tag1Count = tag1Input.value.length;
      const tag1Container = tag1Input.closest('.form-group');
      const countDiv = tag1Container.querySelector('div:last-child');
      countDiv.textContent = `${tag1Count} / 30`;
    }

    // æ›´æ–°æ ‡ç­¾2è®¡æ•°
    if (tag2Input) {
      const tag2Count = tag2Input.value.length;
      const tag2Container = tag2Input.closest('.form-group');
      const countDiv = tag2Container.querySelector('div:last-child');
      countDiv.textContent = `${tag2Count} / 30`;
    }

    // å…¬ä¼—èº«ä»½å·²ç§»é™¤å­—ç¬¦é™åˆ¶ï¼Œæ— éœ€è®¡æ•°

    // æ›´æ–°çœŸå®å§“åè®¡æ•°
    const realNameInput = document.getElementById('edit-real-name');
    if (realNameInput) {
      const realNameCount = realNameInput.value.length;
      realNameInput.parentNode.querySelector('div').textContent = `${realNameCount} / 50`;
    }
  }

  // åˆ‡æ¢çœŸåè¾“å…¥æ¡†æ˜¾ç¤º
  function toggleRealNameInput() {
    const checkbox = document.getElementById('edit-show-real-name');
    const container = document.getElementById('real-name-input-container');

    // æ·»åŠ  null æ£€æŸ¥ï¼Œé˜²æ­¢å…ƒç´ ä¸å­˜åœ¨æ—¶æŠ¥é”™
    if (!checkbox || !container) {
      console.warn('ç”¨æˆ·çœŸåç›¸å…³å…ƒç´ æœªæ‰¾åˆ°');
      return;
    }

    if (checkbox.checked) {
      container.style.display = 'block';
    } else {
      container.style.display = 'none';
      // æ¸…ç©ºçœŸåè¾“å…¥æ¡†
      const realNameInput = document.getElementById('edit-real-name');
      if (realNameInput) {
        realNameInput.value = '';
        updateCharacterCounts();
      }
    }
  }

  // åˆ‡æ¢è§’è‰²çœŸåè¾“å…¥æ¡†æ˜¾ç¤º
  function toggleCharacterRealNameInput() {
    const checkbox = document.getElementById('character-show-real-name');
    const container = document.getElementById('character-real-name-input-container');

    // æ·»åŠ  null æ£€æŸ¥ï¼Œé˜²æ­¢å…ƒç´ ä¸å­˜åœ¨æ—¶æŠ¥é”™
    if (!checkbox || !container) {
      console.warn('è§’è‰²çœŸåç›¸å…³å…ƒç´ æœªæ‰¾åˆ°');
      return;
    }

    if (checkbox.checked) {
      container.style.display = 'block';
    } else {
      container.style.display = 'none';
      // æ¸…ç©ºçœŸåè¾“å…¥æ¡†
      const realNameInput = document.getElementById('character-real-name');
      if (realNameInput) {
        realNameInput.value = '';
        updateCharacterXProfileCounts();
      }
    }
  }

  // æ ‡ç­¾1é¢œè‰²åŒæ­¥åŠŸèƒ½
  function updateTag1ColorFromText() {
    const colorText = document.getElementById('edit-tag1-color-text');
    const colorPicker = document.getElementById('edit-tag1-color');

    if (colorText && colorPicker) {
      const colorValue = colorText.value.trim();
      if (colorValue.match(/^#[0-9A-Fa-f]{6}$/)) {
        colorPicker.value = colorValue;
      }
    }
  }

  function updateTag1ColorFromPicker() {
    const colorText = document.getElementById('edit-tag1-color-text');
    const colorPicker = document.getElementById('edit-tag1-color');

    if (colorText && colorPicker) {
      colorText.value = colorPicker.value;
    }
  }

  // æ ‡ç­¾2é¢œè‰²åŒæ­¥åŠŸèƒ½
  function updateTag2ColorFromText() {
    const colorText = document.getElementById('edit-tag2-color-text');
    const colorPicker = document.getElementById('edit-tag2-color');

    if (colorText && colorPicker) {
      const colorValue = colorText.value.trim();
      if (colorValue.match(/^#[0-9A-Fa-f]{6}$/)) {
        colorPicker.value = colorValue;
      }
    }
  }

  function updateTag2ColorFromPicker() {
    const colorText = document.getElementById('edit-tag2-color-text');
    const colorPicker = document.getElementById('edit-tag2-color');

    if (colorText && colorPicker) {
      colorText.value = colorPicker.value;
    }
  }

  // ç®€åŒ–çš„å…³æ³¨æ•°å¤„ç† - ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²
  function getFollowCountValue(input) {
    if (!input) return '';
    return input.toString().trim();
  }

  // ç¼–è¾‘å°é¢å›¾
  // ç¼–è¾‘å°é¢å›¾ - ä½¿ç”¨é“¾æ¥ä¸Šä¼ 
  function editCoverImage() {
    const currentCover = document.getElementById('edit-cover-image').src;
    const coverUrl = prompt('è¯·è¾“å…¥å°é¢å›¾ç‰‡é“¾æ¥ï¼š', currentCover);

    if (coverUrl === null) return; // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ

    if (!coverUrl.trim()) {
      showXToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡é“¾æ¥', 'error');
      return;
    }

    // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„URL
    try {
      new URL(coverUrl);
    } catch (e) {
      showXToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡é“¾æ¥', 'error');
      return;
    }

    // æµ‹è¯•å›¾ç‰‡æ˜¯å¦å¯ä»¥åŠ è½½
    const testImg = new Image();
    testImg.onload = function () {
      document.getElementById('edit-cover-image').src = coverUrl;
      showXToast('å°é¢å›¾å·²æ›´æ–°', 'success');
    };
    testImg.onerror = function () {
      showXToast('æ— æ³•åŠ è½½è¯¥å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®', 'error');
    };
    testImg.src = coverUrl;
  }

  // ç§»é™¤å°é¢å›¾
  function removeCoverImage() {
    const defaultCover = 'https://i.postimg.cc/qRzMB6nQ/default-cover.jpg';
    document.getElementById('edit-cover-image').src = defaultCover;
    showXToast('å·²ç§»é™¤å°é¢å›¾', 'success');
  }

  // ç¼–è¾‘å¤´åƒ - ä½¿ç”¨é“¾æ¥ä¸Šä¼ 
  function editAvatarImage() {
    const currentAvatar = document.getElementById('edit-main-avatar').src;
    const avatarUrl = prompt('è¯·è¾“å…¥å¤´åƒå›¾ç‰‡é“¾æ¥ï¼š', currentAvatar);

    if (avatarUrl === null) return; // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ

    if (!avatarUrl.trim()) {
      showXToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡é“¾æ¥', 'error');
      return;
    }

    // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„URL
    try {
      new URL(avatarUrl);
    } catch (e) {
      showXToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡é“¾æ¥', 'error');
      return;
    }

    // æµ‹è¯•å›¾ç‰‡æ˜¯å¦å¯ä»¥åŠ è½½
    const testImg = new Image();
    testImg.onload = function () {
      document.getElementById('edit-main-avatar').src = avatarUrl;
      showXToast('å¤´åƒå·²æ›´æ–°', 'success');
    };
    testImg.onerror = function () {
      showXToast('æ— æ³•åŠ è½½è¯¥å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®', 'error');
    };
    testImg.src = avatarUrl;
  }

  // è§’è‰²èº«ä»½è¯†åˆ«ç®¡ç†å‡½æ•°

  // åŠ è½½å·²ç»‘å®šXèµ„æ–™çš„è§’è‰²åˆ—è¡¨
  async function loadIdentityCharactersList() {
    try {
      const db = getDB(); // ä¿®æ­£ï¼šchatsè¡¨åœ¨å…¨å±€æ•°æ®åº“ä¸­
      const xDb = getXDB(); // Xä¸“ç”¨æ•°æ®åº“ç”¨äºå…¶ä»–æ•°æ®

      // è·å–Xè®¾ç½®ä¸­çš„ç»‘å®šè§’è‰²ï¼ˆä½¿ç”¨å½“å‰è´¦å·çš„è®¾ç½®ï¼‰
      const settingsId = `xSettings_${currentAccountId || 'main'}`;
      const xSettings = await xDb.xSettings.get(settingsId);
      const boundCharacters = xSettings?.boundCharacters || [];

      if (boundCharacters.length === 0) {
        renderIdentityCharactersList([]);
        return;
      }

      // è·å–æ‰€æœ‰èŠå¤©è§’è‰²
      const allChats = await db.chats.toArray();
      const characters = allChats.filter(chat => !chat.isGroup && boundCharacters.includes(chat.id));

      // ç­›é€‰å‡ºå·²ç»‘å®šXèµ„æ–™çš„è§’è‰²
      const charactersWithXProfile = [];
      for (const character of characters) {
        const xProfile = await xDb.xCharacterProfiles.get(character.id);
        if (xProfile) {
          charactersWithXProfile.push({
            id: character.id,
            name: character.name,
            originalName: character.originalName,
            xProfile: xProfile,
          });
        }
      }

      renderIdentityCharactersList(charactersWithXProfile);
    } catch (error) {
      console.error('åŠ è½½è§’è‰²èº«ä»½è¯†åˆ«åˆ—è¡¨å¤±è´¥:', error);
      renderIdentityCharactersList([]);
    }
  }

  // æ¸²æŸ“è§’è‰²èº«ä»½è¯†åˆ«åˆ—è¡¨
  function renderIdentityCharactersList(characters) {
    const container = document.getElementById('identity-characters-list');

    if (characters.length === 0) {
      container.innerHTML = `
                <div style="text-align: center; color: #71767b; font-size: 13px; padding: 20px;">
                  æš‚æ— å·²ç»‘å®šXèµ„æ–™çš„è§’è‰²<br>
                  <span style="font-size: 12px; margin-top: 4px; display: block;">
                    è¯·å…ˆåœ¨Xè®¾ç½®ä¸­ç»‘å®šè§’è‰²å¹¶è®¾ç½®Xèµ„æ–™
                  </span>
                </div>
              `;
      return;
    }

    // ç¡®ä¿knownIdentityCharactersæ•°ç»„å­˜åœ¨
    if (!userProfileData.knownIdentityCharacters) {
      userProfileData.knownIdentityCharacters = [];
    }

    container.innerHTML = characters
      .map(character => {
        const isSelected = userProfileData.knownIdentityCharacters.includes(character.id);
        return `
                <div style="display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 6px; margin-bottom: 6px; cursor: pointer; transition: background-color 0.2s;" 
                     onmouseover="this.style.backgroundColor='rgba(255,255,255,0.05)'" 
                     onmouseout="this.style.backgroundColor='transparent'"
                     onclick="toggleIdentityCharacter('${character.id}')">
                  
                  <!-- å¤é€‰æ¡† -->
                  <div style="
                    width: 18px;
                    height: 18px;
                    border: 2px solid ${isSelected ? '#1d9bf0' : '#71767b'};
                    border-radius: 3px;
                    background-color: ${isSelected ? '#1d9bf0' : 'transparent'};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s;
                    flex-shrink: 0;
                  ">
                    ${
                      isSelected
                        ? '<svg viewBox="0 0 24 24" style="width: 12px; height: 12px; fill: #fff;"><path d="M9 16.17L5.53 12.7l-1.06 1.06L9 18.3l9.54-9.54-1.06-1.06L9 16.17z"/></svg>'
                        : ''
                    }
                  </div>

                                    <!-- è§’è‰²å¤´åƒ -->
                  <img src="${character.xProfile.xAvatar}" alt="${character.xProfile.xName}" 
                       style="width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;">

                  <!-- è§’è‰²ä¿¡æ¯ -->
                  <div style="flex: 1; min-width: 0;">
                    <div style="color: #fff; font-weight: 600; font-size: 14px;">
                      ${character.xProfile.xName}
                      ${
                        character.xProfile.xVerified
                          ? '<svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: #1d9bf0; margin-left: 4px; display: inline;"><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-2.5-1.668c-.326-.217-.413-.656-.196-.982.217-.326.656-.414.982-.196l1.875 1.25 3.75-5.625c.22-.33.66-.418.99-.196.33.22.418.66.196.99z"/></svg>'
                          : ''
                      }
                    </div>
                    <div style="color: #71767b; font-size: 12px;">
                      ${character.xProfile.xHandle} â€¢ ${character.name}
                                            ${
                                              character.xProfile &&
                                              character.xProfile.userPersona &&
                                              character.xProfile.userPersona.trim()
                                                ? '<span style="color: #10b981; font-size: 11px; margin-left: 8px;">âœ“ å·²è®¾ç½®äººè®¾</span>'
                                                : '<span style="color: #f59e0b; font-size: 11px; margin-left: 8px;">âš  æœªè®¾ç½®äººè®¾</span>'
                                            }
                    </div>
                  </div>

                  <!-- è®¾ç½®ç”¨æˆ·äººè®¾æŒ‰é’® -->
                  <div class="persona-setting-btn" onclick="event.stopPropagation(); window.openUserPersonaEditor('${
                    character.id
                  }')" 
                       style="
                         width: 32px;
                         height: 32px;
                         border-radius: 50%;
                         background-color: ${
                           character.xProfile && character.xProfile.userPersona && character.xProfile.userPersona.trim()
                             ? '#10b981'
                             : '#1d9bf0'
                         };
                         color: #fff;
                         display: flex;
                         align-items: center;
                         justify-content: center;
                         cursor: pointer;
                         flex-shrink: 0;
                         transition: all 0.2s;
                         margin-left: 8px;
                       "
                       onmouseover="this.style.backgroundColor='${
                         character.xProfile && character.xProfile.userPersona && character.xProfile.userPersona.trim()
                           ? '#059669'
                           : '#1a8cd8'
                       }'; this.style.transform='scale(1.05)'"
                       onmouseout="this.style.backgroundColor='${
                         character.xProfile && character.xProfile.userPersona && character.xProfile.userPersona.trim()
                           ? '#10b981'
                           : '#1d9bf0'
                       }'; this.style.transform='scale(1)'"
                       title="${
                         character.xProfile && character.xProfile.userPersona && character.xProfile.userPersona.trim()
                           ? 'ç¼–è¾‘ç”¨æˆ·äººè®¾'
                           : 'è®¾ç½®ç”¨æˆ·äººè®¾'
                       }">
                    ${
                      character.xProfile && character.xProfile.userPersona && character.xProfile.userPersona.trim()
                        ? '<svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;"><g><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></g></svg>'
                        : '<svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;"><g><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></g></svg>'
                    }
                  </div>
                </div>
              `;
      })
      .join('');
  }

  // åˆ‡æ¢è§’è‰²èº«ä»½è¯†åˆ«çŠ¶æ€
  function toggleIdentityCharacter(characterId) {
    // ç¡®ä¿knownIdentityCharactersæ•°ç»„å­˜åœ¨
    if (!userProfileData.knownIdentityCharacters) {
      userProfileData.knownIdentityCharacters = [];
    }

    const index = userProfileData.knownIdentityCharacters.indexOf(characterId);
    if (index === -1) {
      // æ·»åŠ åˆ°å·²çŸ¥èº«ä»½åˆ—è¡¨
      userProfileData.knownIdentityCharacters.push(characterId);
    } else {
      // ä»å·²çŸ¥èº«ä»½åˆ—è¡¨ä¸­ç§»é™¤
      userProfileData.knownIdentityCharacters.splice(index, 1);
    }

    // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°UI
    loadIdentityCharactersList();
  }

  // ç”¨æˆ·äººè®¾ç¼–è¾‘åŠŸèƒ½ - ä½¿ç”¨+æŒ‰é’®è§¦å‘

  // æ‰“å¼€ç”¨æˆ·äººè®¾ç¼–è¾‘å™¨ - å…¨å±€å‡½æ•°
  window.openUserPersonaEditor = async function (characterId) {
    try {
      const mainDB = getDB(); // ç”¨äºè®¿é—® chats è¡¨
      const xDB = getXDB(); // ç”¨äºè®¿é—® xCharacterProfiles è¡¨

      const chat = await mainDB.chats.get(characterId);
      const xProfile = await xDB.xCharacterProfiles.get(characterId);

      if (!chat || !xProfile) {
        showXToast('æ— æ³•è·å–è§’è‰²ä¿¡æ¯', 'error');
        return;
      }

      // è·å–ç°æœ‰çš„ç”¨æˆ·äººè®¾ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      const existingPersona = xProfile.userPersona || '';

      // æ˜¾ç¤ºç¼–è¾‘å¼¹çª—
      window.showUserPersonaModal(characterId, chat.name, xProfile.xName, existingPersona);
    } catch (error) {
      console.error('æ‰“å¼€ç”¨æˆ·äººè®¾ç¼–è¾‘å™¨å¤±è´¥:', error);
      showXToast('æ‰“å¼€ç¼–è¾‘å™¨å¤±è´¥', 'error');
    }
  };

  // æ˜¾ç¤ºç”¨æˆ·äººè®¾ç¼–è¾‘å¼¹çª— - å…¨å±€å‡½æ•°
  window.showUserPersonaModal = function (characterId, characterName, xName, existingPersona) {
    const modal = document.createElement('div');
    modal.id = 'user-persona-modal';
    modal.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background-color: rgba(0, 0, 0, 0.8);
              display: flex;
              align-items: center;
              justify-content: center;
              z-index: 10000;
              backdrop-filter: blur(4px);
            `;

    modal.innerHTML = `
              <div style="
                background-color: #1a1a1a;
                border-radius: 16px;
                width: 90%;
                max-width: 500px;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
                border: 1px solid #333;
              ">
                <!-- å¼¹çª—å¤´éƒ¨ -->
                <div style="
                  padding: 20px;
                  border-bottom: 1px solid #333;
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                ">
                  <div>
                    <h3 style="margin: 0; color: #fff; font-size: 18px; font-weight: 700;">
                      ç¼–è¾‘ç”¨æˆ·äººè®¾
                    </h3>
                    <p style="margin: 4px 0 0; color: #71767b; font-size: 14px;">
                      ä¸º ${xName} (${characterName}) è®¾ç½®ä½ çš„èº«ä»½ä¿¡æ¯
                    </p>
                  </div>
                  <button onclick="window.closeUserPersonaModal()" style="
                    background: transparent;
                    border: none;
                    color: #71767b;
                    cursor: pointer;
                    padding: 8px;
                    border-radius: 50%;
                    transition: background-color 0.2s;
                  " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'" 
                     onmouseout="this.style.backgroundColor='transparent'">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                      <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>
                    </svg>
                  </button>
                </div>

                <!-- å¼¹çª—å†…å®¹ -->
                <div style="padding: 20px;">
                  <!-- è¯´æ˜æ–‡å­— -->
                  <div style="
                    background-color: #003d82;
                    border: 1px solid #1d9bf0;
                    border-radius: 8px;
                    padding: 12px;
                    margin-bottom: 20px;
                  ">
                    <div style="color: #1d9bf0; font-size: 14px; font-weight: 600; margin-bottom: 4px;">
                      ğŸ’¡ å¦‚ä½•è®¾ç½®ç”¨æˆ·äººè®¾
                    </div>
                    <div style="color: #e1e8ed; font-size: 13px; line-height: 1.4;">
                      â€¢ æè¿°ä½ å¸Œæœ›è¿™ä¸ªè§’è‰²äº†è§£çš„å…³äºä½ çš„ä¿¡æ¯<br>
                      â€¢ ä¾‹å¦‚ï¼šæ€§æ ¼ç‰¹ç‚¹ã€å…´è¶£çˆ±å¥½ã€èŒä¸šèƒŒæ™¯ç­‰<br>
                      â€¢ è¿™äº›ä¿¡æ¯å°†å¸®åŠ©è§’è‰²æ›´è‡ªç„¶åœ°ä¸ä½ äº’åŠ¨
                    </div>
                  </div>

                  <!-- ç”¨æˆ·äººè®¾è¾“å…¥ -->
                  <div style="margin-bottom: 20px;">
                    <label style="
                      display: block;
                      color: #fff;
                      font-size: 15px;
                      font-weight: 600;
                      margin-bottom: 8px;
                    ">ç”¨æˆ·äººè®¾</label>
                    <textarea id="user-persona-input" placeholder="è¯·æè¿°ä½ å¸Œæœ›${xName}äº†è§£çš„å…³äºä½ çš„ä¿¡æ¯..." style="
                      width: 100%;
                      min-height: 120px;
                      max-height: 300px;
                      background-color: #0a0a0a;
                      border: 1px solid #333;
                      border-radius: 8px;
                      color: #fff;
                      font-size: 14px;
                      padding: 12px;
                      resize: vertical;
                      outline: none;
                      box-sizing: border-box;
                      font-family: inherit;
                      line-height: 1.4;
                    " oninput="window.updatePersonaCharCount()">${existingPersona}</textarea>
                    <div style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-top: 8px;
                    ">
                      <div style="color: #71767b; font-size: 12px;">
                        å»ºè®®è¯¦ç»†æè¿°ï¼Œå¸®åŠ©è§’è‰²æ›´å¥½åœ°ç†è§£ä½ 
                      </div>
                      <div id="persona-char-count" style="color: #71767b; font-size: 12px;">
                        ${existingPersona.length} å­—ç¬¦
                      </div>
                    </div>
                  </div>

                  <!-- æ“ä½œæŒ‰é’® -->
                  <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="window.closeUserPersonaModal()" style="
                      background: transparent;
                      color: #71767b;
                      border: 1px solid #333;
                      border-radius: 20px;
                      padding: 8px 20px;
                      font-size: 15px;
                      font-weight: 700;
                      cursor: pointer;
                      transition: all 0.2s;
                    " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.05)'" 
                       onmouseout="this.style.backgroundColor='transparent'">
                      å–æ¶ˆ
                    </button>
                    <button onclick="window.saveUserPersona('${characterId}')" style="
                      background-color: #1d9bf0;
                      color: #fff;
                      border: none;
                      border-radius: 20px;
                      padding: 8px 20px;
                      font-size: 15px;
                      font-weight: 700;
                      cursor: pointer;
                      transition: all 0.2s;
                    " onmouseover="this.style.backgroundColor='#1a8cd8'" 
                       onmouseout="this.style.backgroundColor='#1d9bf0'">
                      ä¿å­˜
                    </button>
                  </div>
                </div>
              </div>
            `;

    document.body.appendChild(modal);

    // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
    modal.addEventListener('click', e => {
      if (e.target === modal) {
        window.closeUserPersonaModal();
      }
    });
  };

  // æ›´æ–°å­—ç¬¦è®¡æ•° - å…¨å±€å‡½æ•°
  window.updatePersonaCharCount = function () {
    const textarea = document.getElementById('user-persona-input');
    const countEl = document.getElementById('persona-char-count');
    if (textarea && countEl) {
      countEl.textContent = `${textarea.value.length} å­—ç¬¦`;
    }
  };

  // å…³é—­ç”¨æˆ·äººè®¾ç¼–è¾‘å¼¹çª— - å…¨å±€å‡½æ•°
  window.closeUserPersonaModal = function () {
    const modal = document.getElementById('user-persona-modal');
    if (modal) {
      modal.remove();
    }
  };

  // ä¿å­˜ç”¨æˆ·äººè®¾ - å…¨å±€å‡½æ•°
  window.saveUserPersona = async function (characterId) {
    const textarea = document.getElementById('user-persona-input');
    const persona = textarea.value.trim();

    try {
      const db = getXDB();

      // è·å–ç°æœ‰çš„è§’è‰²Xèµ„æ–™
      let xProfile = await db.xCharacterProfiles.get(characterId);

      if (xProfile) {
        // æ›´æ–°ç”¨æˆ·äººè®¾
        xProfile.userPersona = persona;
        await db.xCharacterProfiles.put(xProfile);

        console.log(
          `å·²ä¿å­˜è§’è‰² ${characterId} çš„ç”¨æˆ·äººè®¾:`,
          persona.substring(0, 100) + (persona.length > 100 ? '...' : ''),
        );

        showXToast(persona ? 'ç”¨æˆ·äººè®¾å·²ä¿å­˜' : 'ç”¨æˆ·äººè®¾å·²æ¸…ç©º', 'success');
        window.closeUserPersonaModal();
      } else {
        showXToast('æ— æ³•æ‰¾åˆ°è§’è‰²èµ„æ–™', 'error');
      }
    } catch (error) {
      console.error('ä¿å­˜ç”¨æˆ·äººè®¾å¤±è´¥:', error);
      showXToast('ä¿å­˜å¤±è´¥', 'error');
    }
  };

  // ä¿å­˜ä¸ªäººèµ„æ–™æ›´æ”¹
  async function saveProfileChanges() {
    // è·å–è¡¨å•æ•°æ®
    const newName = document.getElementById('edit-user-name').value.trim();
    const newHandle = document.getElementById('edit-user-handle').value.trim();
    const newBio = document.getElementById('edit-user-bio').value.trim();
    const newTag1 = document.getElementById('edit-custom-tag1').value.trim();
    const newTag2 = document.getElementById('edit-custom-tag2').value.trim();
    const newTag1Icon = document.getElementById('edit-tag1-icon').value.trim() || 'âœ¨';
    const newTag2Icon = document.getElementById('edit-tag2-icon').value.trim() || 'ğŸ“…';
    const newTag1Color = document.getElementById('edit-tag1-color').value || '#71767b';
    const newTag2Color = document.getElementById('edit-tag2-color').value || '#71767b';
    const newFollowing = getFollowCountValue(document.getElementById('edit-following-count').value);
    const newFollowers = getFollowCountValue(document.getElementById('edit-followers-count').value);
    const newCover = document.getElementById('edit-cover-image').src;
    const newAvatar = document.getElementById('edit-main-avatar').src;

    // è·å–è®¤è¯ç±»å‹æ•°æ®
    const newVerificationType = document.getElementById('edit-verification-type').value;
    const newCoupleCharacterId = document.getElementById('edit-couple-character').value;

    // è·å–æƒ…ä¾£è§’è‰²çš„Xå¹³å°èº«ä»½ä¿¡æ¯ï¼ˆå¦‚æœæœ‰é€‰æ‹©ï¼‰
    let newCoupleCharacterName = '';
    if (newCoupleCharacterId) {
      try {
        const db = getXDB();

        const coupleCharacterProfile = await db.xCharacterProfiles.get(newCoupleCharacterId);
        if (coupleCharacterProfile) {
          // ä½¿ç”¨Xå¹³å°çš„handleå’Œnameç»„åˆ
          newCoupleCharacterName = `@${coupleCharacterProfile.xHandle}ï¼ˆ${coupleCharacterProfile.xName}ï¼‰`;
        } else {
          // å¦‚æœæ²¡æœ‰Xèµ„æ–™ï¼Œä»é€‰é¡¹ä¸­è·å–ï¼Œå¹¶ç”Ÿæˆé»˜è®¤æ ¼å¼
          const coupleOption = document.querySelector(`#edit-couple-character option[value="${newCoupleCharacterId}"]`);
          const displayName = coupleOption ? coupleOption.textContent : '';
          if (displayName) {
            const defaultHandle = displayName.toLowerCase().replace(/\s+/g, '_');
            newCoupleCharacterName = `@${defaultHandle}ï¼ˆ${displayName}ï¼‰`;
          }
        }
      } catch (error) {
        console.error('è·å–æƒ…ä¾£è§’è‰²Xèµ„æ–™å¤±è´¥:', error);
        // å¤‡ç”¨æ–¹æ¡ˆï¼šä»é€‰é¡¹ä¸­è·å–
        const coupleOption = document.querySelector(`#edit-couple-character option[value="${newCoupleCharacterId}"]`);
        const displayName = coupleOption ? coupleOption.textContent : '';
        if (displayName) {
          const defaultHandle = displayName.toLowerCase().replace(/\s+/g, '_');
          newCoupleCharacterName = `@${defaultHandle}ï¼ˆ${displayName}ï¼‰`;
        }
      }
    }

    // è·å–å…¬ä¼—èº«ä»½å’ŒçœŸåè®¾ç½®
    const newPublicIdentity = document.getElementById('edit-public-identity').value.trim();
    const newShowRealName = document.getElementById('edit-show-real-name').checked;
    const newRealName = document.getElementById('edit-real-name').value.trim();

    // éªŒè¯æ•°æ®
    if (!newName) {
      showXToast('åç§°ä¸èƒ½ä¸ºç©º', 'error');
      return;
    }

    if (!newHandle) {
      showXToast('ç”¨æˆ·åä¸èƒ½ä¸ºç©º', 'error');
      return;
    }

    if (newName.length > 50) {
      showXToast('åç§°ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦', 'error');
      return;
    }

    if (newHandle.length > 15) {
      showXToast('ç”¨æˆ·åä¸èƒ½è¶…è¿‡15ä¸ªå­—ç¬¦', 'error');
      return;
    }

    if (newBio.length > 160) {
      showXToast('è‡ªæˆ‘ä»‹ç»ä¸èƒ½è¶…è¿‡160ä¸ªå­—ç¬¦', 'error');
      return;
    }

    if (newTag1.length > 30) {
      showXToast('è‡ªå®šä¹‰æ ‡ç­¾1ä¸èƒ½è¶…è¿‡30ä¸ªå­—ç¬¦', 'error');
      return;
    }

    if (newTag2.length > 30) {
      showXToast('è‡ªå®šä¹‰æ ‡ç­¾2ä¸èƒ½è¶…è¿‡30ä¸ªå­—ç¬¦', 'error');
      return;
    }

    if (newFollowing.length > 20) {
      showXToast('å…³æ³¨æ•°é‡è¿‡é•¿', 'error');
      return;
    }

    if (newFollowers.length > 20) {
      showXToast('å…³æ³¨è€…æ•°é‡è¿‡é•¿', 'error');
      return;
    }

    // å…¬ä¼—èº«ä»½å·²ç§»é™¤å­—ç¬¦é™åˆ¶

    if (newShowRealName && newRealName.length > 50) {
      showXToast('çœŸå®å§“åä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦', 'error');
      return;
    }

    if (newShowRealName && !newRealName) {
      showXToast('é€‰æ‹©å…¬å¼€çœŸåæ—¶å¿…é¡»å¡«å†™çœŸå®å§“å', 'error');
      return;
    }

    // æ›´æ–°ç”¨æˆ·æ•°æ®ï¼ˆä½¿ç”¨window.userProfileDataç¡®ä¿æ•°æ®æŒä¹…åŒ–ï¼‰
    window.userProfileData.name = newName;
    window.userProfileData.handle = '@' + newHandle;
    window.userProfileData.bio = newBio;
    window.userProfileData.customTag1 = newTag1;
    window.userProfileData.customTag2 = newTag2;
    window.userProfileData.customTag1Icon = newTag1Icon;
    window.userProfileData.customTag2Icon = newTag2Icon;
    window.userProfileData.customTag1Color = newTag1Color;
    window.userProfileData.customTag2Color = newTag2Color;
    window.userProfileData.following = newFollowing;
    window.userProfileData.followers = newFollowers;
    window.userProfileData.coverImage = newCover;
    window.userProfileData.avatar = newAvatar;

    // æ›´æ–°è®¤è¯ç±»å‹æ•°æ®
    window.userProfileData.verificationType = newVerificationType;
    window.userProfileData.coupleCharacterId = newCoupleCharacterId;
    window.userProfileData.coupleCharacterName = newCoupleCharacterName;

    // æ›´æ–°å…¬ä¼—èº«ä»½å’ŒçœŸåè®¾ç½®
    window.userProfileData.publicIdentity = newPublicIdentity;
    window.userProfileData.showRealName = newShowRealName;
    window.userProfileData.realName = newShowRealName ? newRealName : ''; // åªæœ‰é€‰æ‹©å…¬å¼€æ—¶æ‰ä¿å­˜çœŸå

    // æ ¹æ®è®¤è¯ç±»å‹æ›´æ–°verifiedå­—æ®µ
    window.userProfileData.verified = newVerificationType !== 'none';

    // âš ï¸ æ³¨æ„ï¼šknownIdentityCharacterså·²é€šè¿‡toggleIdentityCharacterå‡½æ•°å®æ—¶æ›´æ–°åˆ°window.userProfileData
    // è¿™é‡Œä¸éœ€è¦é‡æ–°æ”¶é›†ï¼Œç›´æ¥ä¿å­˜å³å¯
    // ç¡®ä¿å­—æ®µå­˜åœ¨
    if (!window.userProfileData.knownIdentityCharacters) {
      window.userProfileData.knownIdentityCharacters = [];
    }

    // å¦‚æœæ˜¯æƒ…ä¾£è®¤è¯ä¸”ç»‘å®šäº†è§’è‰²ï¼Œä¸ºè¯¥è§’è‰²ä¹Ÿè®¾ç½®æƒ…ä¾£è®¤è¯
    if (newVerificationType === 'couple' && newCoupleCharacterId) {
      setCoupleVerificationForCharacter(newCoupleCharacterId, window.userProfileData.name);
    }

    try {
      // è°ƒè¯•ï¼šä¿å­˜å‰æ£€æŸ¥
      console.log('ğŸ“ å‡†å¤‡ä¿å­˜ç”¨æˆ·èµ„æ–™...');
      console.log('ğŸ‘¤ å·²çŸ¥èº«ä»½è§’è‰²æ•°:', window.userProfileData.knownIdentityCharacters?.length || 0);
      console.log('ğŸ‘¤ å·²çŸ¥èº«ä»½è§’è‰²åˆ—è¡¨:', window.userProfileData.knownIdentityCharacters || []);

      // ä¿å­˜åˆ°æ•°æ®åº“
      await saveUserProfileToDB();

      // æ›´æ–°UIæ˜¾ç¤º
      loadUserProfileToUI();

      // æ›´æ–°è®¤è¯å¾½ç« æ˜¾ç¤º
      updateVerificationBadge();

      // åŒæ­¥å¤´åƒåˆ°æ‰€æœ‰ä½ç½®
      syncUserAvatar(newAvatar);

      // å…³é—­å¼¹çª—
      closeEditProfileModal();

      let successMessage = 'ä¸ªäººèµ„æ–™å·²æ›´æ–°';
      if (window.userProfileData.knownIdentityCharacters && window.userProfileData.knownIdentityCharacters.length > 0) {
        successMessage += `ï¼Œå·²è®¾ç½® ${window.userProfileData.knownIdentityCharacters.length} ä¸ªè§’è‰²çŸ¥é“æ‚¨çš„èº«ä»½`;
      }
      showXToast(successMessage, 'success');

      // è°ƒè¯•ï¼šè¾“å‡ºèº«ä»½è¯†åˆ«è®¾ç½®
      if (window.userProfileData.knownIdentityCharacters && window.userProfileData.knownIdentityCharacters.length > 0) {
        console.log('âœ… å·²ä¿å­˜çš„ç”¨æˆ·èº«ä»½è¯†åˆ«è®¾ç½®:', window.userProfileData.knownIdentityCharacters);
        console.log('âœ… è¿™äº›è§’è‰²ç°åœ¨çŸ¥é“æ‚¨çš„èº«ä»½ï¼Œå¯ä»¥åœ¨Xå¹³å°ä¸Šä¸æ‚¨è‡ªç„¶äº’åŠ¨');
      }
    } catch (error) {
      console.error('ä¿å­˜ä¸ªäººèµ„æ–™å¤±è´¥:', error);
      showXToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
  }

  // å‘å¸–å¼¹çª—ç›¸å…³åŠŸèƒ½

  // éšç§è®¾ç½®çŠ¶æ€ï¼š'public' = æ‰€æœ‰äººå¯è§ï¼Œ'private' = ä»…è‡ªå·±å¯è§
  let tweetPrivacySetting = 'public';

  // æ‰“å¼€å‘å¸–å¼¹çª—
  function openComposeTweetModal() {
    const modal = document.getElementById('compose-tweet-modal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // é‡ç½®å¼¹çª—å†…å®¹
    resetComposeModal();

    // åŒæ­¥ç”¨æˆ·å¤´åƒ
    const avatar = document.querySelector('#compose-tweet-modal img[alt="ç”¨æˆ·å¤´åƒ"]');
    if (avatar) {
      avatar.src = userProfileData.avatar;
    }
  }

  // å…³é—­å‘å¸–å¼¹çª—
  function closeComposeTweetModal(event) {
    if (event && event.target !== event.currentTarget) {
      return;
    }

    const modal = document.getElementById('compose-tweet-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';

    // æ¸…ç†å¼•ç”¨å†…å®¹
    if (typeof removeQuoteContent === 'function') {
      removeQuoteContent();
    }
  }

  // é‡ç½®å¼¹çª—å†…å®¹
  function resetComposeModal() {
    // æ¸…ç©ºæ–‡æœ¬è¾“å…¥
    document.getElementById('compose-text-input').value = '';
    updateComposeCharCount();
    updateComposeTweetButton();

    // éšè—æ‰€æœ‰åŠŸèƒ½åŒºåŸŸ
    document.getElementById('compose-image-section').style.display = 'none';
    document.getElementById('compose-location-section').style.display = 'none';
    document.getElementById('compose-link-section').style.display = 'none';

    // é‡ç½®åŠŸèƒ½æŒ‰é’®çŠ¶æ€
    resetFunctionButtonStates();

    // æ¸…ç©ºå„åŠŸèƒ½åŒºåŸŸçš„å†…å®¹
    clearImageSection();
    clearLocationSection();
    clearLinkSection();

    // é‡ç½®éšç§è®¾ç½®ä¸ºé»˜è®¤å€¼
    tweetPrivacySetting = 'public';
    const iconPath = document.getElementById('privacy-icon-path');
    const textElement = document.getElementById('privacy-text');
    iconPath.setAttribute(
      'd',
      'M12 1.75C6.34 1.75 1.75 6.34 1.75 12S6.34 22.25 12 22.25 22.25 17.66 22.25 12 17.66 1.75 12 1.75zm-.81 14.68l-4.1-3.27 1.25-1.57 2.47 1.98 3.97-5.47 1.62 1.18-5.21 7.15z',
    );
    textElement.textContent = 'æ‰€æœ‰äººå¯ä»¥å›å¤';

    // æ¸…ç†å¼•ç”¨å†…å®¹
    if (typeof removeQuoteContent === 'function') {
      removeQuoteContent();
    }
  }

  // å¤„ç†æ–‡æœ¬è¾“å…¥
  function handleComposeInput() {
    updateComposeCharCount();
    updateComposeTweetButton();
    processHashtagsAndMentions();
  }

  // æ›´æ–°å­—ç¬¦è®¡æ•°
  function updateComposeCharCount() {
    const textInput = document.getElementById('compose-text-input');
    const charCount = document.getElementById('compose-char-count');
    const length = textInput.value.length;

    charCount.textContent = `${length} / 280`;

    // æ ¹æ®å­—ç¬¦æ•°æ›´æ”¹é¢œè‰²
    if (length > 260) {
      charCount.style.color = '#f4212e';
    } else if (length > 240) {
      charCount.style.color = '#ffad1f';
    } else {
      charCount.style.color = '#71767b';
    }
  }

  // æ›´æ–°å‘å¸–æŒ‰é’®çŠ¶æ€
  function updateComposeTweetButton() {
    const textInput = document.getElementById('compose-text-input');
    const tweetBtn = document.getElementById('compose-tweet-btn');
    const hasContent = textInput.value.trim().length > 0;

    if (hasContent) {
      tweetBtn.disabled = false;
      tweetBtn.style.opacity = '1';
      tweetBtn.style.cursor = 'pointer';
    } else {
      tweetBtn.disabled = true;
      tweetBtn.style.opacity = '0.5';
      tweetBtn.style.cursor = 'not-allowed';
    }
  }

  // å¤„ç†è¯é¢˜æ ‡ç­¾å’ŒæåŠ
  function processHashtagsAndMentions() {
    const textInput = document.getElementById('compose-text-input');
    const text = textInput.value;

    // è¿™é‡Œå¯ä»¥æ·»åŠ å®æ—¶é«˜äº®#å’Œ@çš„é€»è¾‘
    // ç”±äºtextareaçš„é™åˆ¶ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸å®ç°å®æ—¶é«˜äº®
    // åœ¨å®é™…å‘å¸ƒæ—¶ä¼šå¤„ç†è¿™äº›æ ‡ç­¾
  }

  // åˆ‡æ¢å›¾ç‰‡åŒºåŸŸ
  function toggleImageSection() {
    const section = document.getElementById('compose-image-section');
    const btn = document.getElementById('image-btn');

    if (section.style.display === 'none') {
      section.style.display = 'block';
      btn.style.backgroundColor = 'rgba(29,155,240,0.1)';
    } else {
      section.style.display = 'none';
      btn.style.backgroundColor = 'transparent';
      clearImageSection();
    }
  }

  // é€‰æ‹©å›¾ç‰‡æ·»åŠ æ–¹å¼
  function selectImageMethod(method) {
    const descBtn = document.getElementById('img-desc-btn');
    const uploadBtn = document.getElementById('img-upload-btn');
    const descInput = document.getElementById('image-description-input');
    const uploadArea = document.getElementById('image-upload-area');

    // é‡ç½®æŒ‰é’®æ ·å¼
    descBtn.style.backgroundColor = '#333';
    descBtn.style.borderColor = '#536471';
    uploadBtn.style.backgroundColor = '#333';
    uploadBtn.style.borderColor = '#536471';

    // éšè—æ‰€æœ‰åŒºåŸŸ
    descInput.style.display = 'none';
    uploadArea.style.display = 'none';

    if (method === 'description') {
      descBtn.style.backgroundColor = '#1d9bf0';
      descBtn.style.borderColor = '#1d9bf0';
      descInput.style.display = 'block';
    } else if (method === 'upload') {
      uploadBtn.style.backgroundColor = '#1d9bf0';
      uploadBtn.style.borderColor = '#1d9bf0';
      uploadArea.style.display = 'block';
    }
  }

  // è§¦å‘å›¾ç‰‡ä¸Šä¼ 
  function triggerImageUpload() {
    document.getElementById('image-file-input').click();
  }

  // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
  function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // éªŒè¯æ–‡ä»¶ç±»å‹
    if (!file.type.startsWith('image/')) {
      showXToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
      return;
    }

    // éªŒè¯æ–‡ä»¶å¤§å°
    if (file.size > 5 * 1024 * 1024) {
      showXToast('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB', 'error');
      return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      const previewArea = document.getElementById('uploaded-image-preview');
      const previewImg = document.getElementById('preview-image');

      previewImg.src = e.target.result;
      previewArea.style.display = 'block';

      showXToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
    };
    reader.readAsDataURL(file);
  }

  // ç§»é™¤å›¾ç‰‡
  function removeImage() {
    clearImageSection();
    toggleImageSection(); // å…³é—­å›¾ç‰‡åŒºåŸŸ
  }

  // æ¸…ç©ºå›¾ç‰‡åŒºåŸŸ
  function clearImageSection() {
    // é‡ç½®æ–‡ä»¶è¾“å…¥
    document.getElementById('image-file-input').value = '';

    // éšè—é¢„è§ˆ
    document.getElementById('uploaded-image-preview').style.display = 'none';

    // æ¸…ç©ºæè¿°æ–‡æœ¬
    const descTextarea = document.querySelector('#image-description-input textarea');
    if (descTextarea) {
      descTextarea.value = '';
    }

    // é‡ç½®æŒ‰é’®çŠ¶æ€
    const descBtn = document.getElementById('img-desc-btn');
    const uploadBtn = document.getElementById('img-upload-btn');
    descBtn.style.backgroundColor = '#333';
    descBtn.style.borderColor = '#536471';
    uploadBtn.style.backgroundColor = '#333';
    uploadBtn.style.borderColor = '#536471';

    // éšè—è¾“å…¥åŒºåŸŸ
    document.getElementById('image-description-input').style.display = 'none';
    document.getElementById('image-upload-area').style.display = 'none';
  }

  // åˆ‡æ¢ä½ç½®åŒºåŸŸ
  function toggleLocationSection() {
    const section = document.getElementById('compose-location-section');
    const btn = document.getElementById('location-btn');

    if (section.style.display === 'none') {
      section.style.display = 'block';
      btn.style.backgroundColor = 'rgba(29,155,240,0.1)';
    } else {
      section.style.display = 'none';
      btn.style.backgroundColor = 'transparent';
      clearLocationSection();
    }
  }

  // ç§»é™¤ä½ç½®
  function removeLocation() {
    clearLocationSection();
    toggleLocationSection(); // å…³é—­ä½ç½®åŒºåŸŸ
  }

  // æ¸…ç©ºä½ç½®åŒºåŸŸ
  function clearLocationSection() {
    document.getElementById('location-input').value = '';
  }

  // åˆ‡æ¢é“¾æ¥åŒºåŸŸ
  function toggleLinkSection() {
    const section = document.getElementById('compose-link-section');
    const btn = document.getElementById('attach-btn');

    if (section.style.display === 'none') {
      section.style.display = 'block';
      btn.style.backgroundColor = 'rgba(29,155,240,0.1)';
    } else {
      section.style.display = 'none';
      btn.style.backgroundColor = 'transparent';
      clearLinkSection();
    }
  }

  // ç§»é™¤é“¾æ¥
  function removeLink() {
    clearLinkSection();
    toggleLinkSection(); // å…³é—­é“¾æ¥åŒºåŸŸ
  }

  // æ¸…ç©ºé“¾æ¥åŒºåŸŸ
  function clearLinkSection() {
    document.getElementById('link-title-input').value = '';
    document.getElementById('link-url-input').value = '';
    document.getElementById('link-description-input').value = '';
  }

  // é‡ç½®åŠŸèƒ½æŒ‰é’®çŠ¶æ€
  function resetFunctionButtonStates() {
    const buttons = ['image-btn', 'location-btn', 'attach-btn'];
    buttons.forEach(btnId => {
      const btn = document.getElementById(btnId);
      btn.style.backgroundColor = 'transparent';
    });
  }

  // åˆ‡æ¢éšç§è®¾ç½®
  function togglePrivacySettings() {
    // åˆ‡æ¢éšç§çŠ¶æ€
    tweetPrivacySetting = tweetPrivacySetting === 'public' ? 'private' : 'public';

    const iconPath = document.getElementById('privacy-icon-path');
    const textElement = document.getElementById('privacy-text');

    if (tweetPrivacySetting === 'public') {
      // æ‰€æœ‰äººå¯è§
      iconPath.setAttribute(
        'd',
        'M12 1.75C6.34 1.75 1.75 6.34 1.75 12S6.34 22.25 12 22.25 22.25 17.66 22.25 12 17.66 1.75 12 1.75zm-.81 14.68l-4.1-3.27 1.25-1.57 2.47 1.98 3.97-5.47 1.62 1.18-5.21 7.15z',
      );
      textElement.textContent = 'æ‰€æœ‰äººå¯ä»¥å›å¤';
    } else {
      // ä»…è‡ªå·±å¯è§
      iconPath.setAttribute(
        'd',
        'M17.863 13.44c1.477 1.58 2.366 3.8 2.632 6.46l.11 1.1H3.395l.11-1.1c.266-2.66 1.155-4.88 2.632-6.46C7.627 11.85 9.648 11 12 11s4.373.85 5.863 2.44zM12 2C9.791 2 8 3.79 8 6s1.791 4 4 4 4-1.79 4-4-1.791-4-4-4z',
      );
      textElement.textContent = 'ä»…è‡ªå·±å¯è§';
    }

    showXToast(`å·²åˆ‡æ¢ä¸º${tweetPrivacySetting === 'public' ? 'æ‰€æœ‰äººå¯è§' : 'ä»…è‡ªå·±å¯è§'}`, 'success');
  }

  // å‘å¸ƒæ¨æ–‡
  async function publishTweet() {
    const textInput = document.getElementById('compose-text-input');
    const content = textInput.value.trim();

    if (!content) {
      showXToast('è¯·è¾“å…¥æ¨æ–‡å†…å®¹', 'error');
      return;
    }

    // è·å–é™„åŠ å†…å®¹ï¼ˆä½¿ç”¨window.userProfileDataç¡®ä¿è·å–æœ€æ–°è´¦å·æ•°æ®ï¼‰
    const tweetData = {
      id: 'user_' + Date.now(),
      content: content,
      image: getImageData(),
      location: getLocationData(),
      link: getLinkData(),
      timestamp: new Date(),
      user: {
        name: window.userProfileData.name,
        handle: window.userProfileData.handle,
        avatar: window.userProfileData.avatar,
        verified: window.userProfileData.verified,
      },
      stats: {
        comments: 0,
        retweets: 0,
        likes: 0,
        views: 0,
      },
      comments: [],
      privacy: tweetPrivacySetting,
    };

    // å¦‚æœæœ‰å¼•ç”¨å†…å®¹ï¼Œæ·»åŠ åˆ°æ¨æ–‡ä¸­
    if (typeof currentQuoteData !== 'undefined' && currentQuoteData) {
      tweetData.quotedTweet = {
        type: currentQuoteData.type,
        user: {
          name: currentQuoteData.user.name,
          handle: currentQuoteData.user.handle,
          avatar: currentQuoteData.user.avatar,
          verified: currentQuoteData.user.verified,
        },
        content: currentQuoteData.content,
        time: currentQuoteData.time,
        image: currentQuoteData.image || null, // ä¿å­˜å›¾ç‰‡æ•°æ®
        link: currentQuoteData.link || null, // ä¿å­˜é“¾æ¥æ•°æ®
        location: currentQuoteData.location || null, // ä¿å­˜ä½ç½®æ•°æ®
      };
    }

    console.log('æ¨æ–‡æ•°æ®:', tweetData);

    // å…³é—­å¼¹çª—
    closeComposeTweetModal();

    // ä¿å­˜ç”¨æˆ·å‘å¸ƒçš„å¸–å­åˆ°ä¸ªäººé¡µé¢
    await saveUserTweet(tweetData);

    // å¦‚æœå½“å‰åœ¨ä¸ªäººä¸»é¡µï¼Œåˆ·æ–°æ¨æ–‡æ˜¾ç¤º
    if (document.getElementById('x-profile-page').style.display !== 'none') {
      loadUserProfileTweets();
    }

    // æ˜¾ç¤ºæ¨æ–‡è¯¦æƒ…é¡µé¢
    showTweetDetail(tweetData);

    showXToast(currentQuoteData ? 'å¼•ç”¨è½¬å‘å·²å‘å¸ƒï¼' : 'å‘å¸–æˆåŠŸï¼', 'success');

    // å¦‚æœè®¾ç½®ä¸ºæ‰€æœ‰äººå¯è§ï¼Œè§¦å‘AIå›å¤
    if (tweetPrivacySetting === 'public') {
      showXToast('æ­£åœ¨ç­‰å¾…å›å¤...', 'info');
      await generateAIResponseForTweet(tweetData);
    }
  }

  // è·å–å›¾ç‰‡æ•°æ®
  function getImageData() {
    const imageSection = document.getElementById('compose-image-section');
    if (imageSection.style.display === 'none') return null;

    const descTextarea = document.querySelector('#image-description-input textarea');
    const previewImg = document.getElementById('preview-image');

    if (descTextarea && descTextarea.style.display !== 'none' && descTextarea.value.trim()) {
      return {
        type: 'description',
        content: descTextarea.value.trim(),
      };
    } else if (previewImg && previewImg.src && previewImg.src.startsWith('data:')) {
      return {
        type: 'upload',
        content: previewImg.src,
      };
    }

    return null;
  }

  // è·å–ä½ç½®æ•°æ®
  function getLocationData() {
    const locationSection = document.getElementById('compose-location-section');
    if (locationSection.style.display === 'none') return null;

    const locationInput = document.getElementById('location-input');
    const location = locationInput.value.trim();

    return location ? location : null;
  }

  // è·å–é“¾æ¥æ•°æ®
  function getLinkData() {
    const linkSection = document.getElementById('compose-link-section');
    if (linkSection.style.display === 'none') return null;

    const title = document.getElementById('link-title-input').value.trim();
    const url = document.getElementById('link-url-input').value.trim();
    const description = document.getElementById('link-description-input').value.trim();

    if (title || url || description) {
      return {
        title: title,
        url: url,
        description: description,
      };
    }

    return null;
  }

  // ä¿å­˜åŠŸèƒ½ç›¸å…³å‡½æ•°
  function saveImageData() {
    showXToast('å›¾ç‰‡æ•°æ®å·²ä¿å­˜', 'success');
  }

  function saveLocationData() {
    const locationInput = document.getElementById('location-input');
    if (locationInput.value.trim()) {
      showXToast('ä½ç½®ä¿¡æ¯å·²ä¿å­˜', 'success');
    } else {
      showXToast('è¯·å…ˆè¾“å…¥ä½ç½®ä¿¡æ¯', 'error');
    }
  }

  function saveLinkData() {
    const title = document.getElementById('link-title-input').value.trim();
    const url = document.getElementById('link-url-input').value.trim();
    const description = document.getElementById('link-description-input').value.trim();

    if (title || url || description) {
      showXToast('é“¾æ¥ä¿¡æ¯å·²ä¿å­˜', 'success');
    } else {
      showXToast('è¯·å…ˆå¡«å†™é“¾æ¥ä¿¡æ¯', 'error');
    }
  }

  // å¤„ç†é“¾æ¥é¦–å›¾ä¸Šä¼ 
  function triggerLinkImageUpload() {
    document.getElementById('link-image-input').click();
  }

  function handleLinkImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // éªŒè¯æ–‡ä»¶ç±»å‹
    if (!file.type.startsWith('image/')) {
      showXToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
      return;
    }

    // éªŒè¯æ–‡ä»¶å¤§å°
    if (file.size > 5 * 1024 * 1024) {
      showXToast('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB', 'error');
      return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      const previewArea = document.getElementById('link-image-preview');
      const previewImg = document.getElementById('link-preview-image');

      previewImg.src = e.target.result;
      previewArea.style.display = 'block';

      showXToast('é“¾æ¥é¦–å›¾ä¸Šä¼ æˆåŠŸ', 'success');
    };
    reader.readAsDataURL(file);
  }

  // æ›´æ–°è·å–é“¾æ¥æ•°æ®å‡½æ•°
  function getLinkData() {
    const linkSection = document.getElementById('compose-link-section');
    if (linkSection.style.display === 'none') return null;

    const title = document.getElementById('link-title-input').value.trim();
    const url = document.getElementById('link-url-input').value.trim();
    const description = document.getElementById('link-description-input').value.trim();
    const previewImg = document.getElementById('link-preview-image');
    const thumbnail = previewImg && previewImg.src.startsWith('data:') ? previewImg.src : null;

    if (title || url || description || thumbnail) {
      return {
        title: title,
        url: url,
        description: description,
        thumbnail: thumbnail,
      };
    }

    return null;
  }

  // æ¸…ç©ºé“¾æ¥åŒºåŸŸ
  function clearLinkSection() {
    document.getElementById('link-title-input').value = '';
    document.getElementById('link-url-input').value = '';
    document.getElementById('link-description-input').value = '';
    document.getElementById('link-image-input').value = '';
    document.getElementById('link-image-preview').style.display = 'none';
  }

  // æ˜¾ç¤ºæ¨æ–‡è¯¦æƒ…é¡µé¢
  function showTweetDetail(tweetData) {
    // ä¿å­˜æ¨æ–‡æ•°æ®åˆ°sessionStorageï¼Œä¾›é‡å›åŠŸèƒ½ä½¿ç”¨
    sessionStorage.setItem('currentTweetData', JSON.stringify(tweetData));

    // éšè—æ‰€æœ‰é¡µé¢
    document.querySelectorAll('.x-page').forEach(page => {
      page.style.display = 'none';
    });

    // æ˜¾ç¤ºæ¨æ–‡è¯¦æƒ…é¡µé¢
    const detailPage = document.getElementById('x-tweet-detail-page');
    detailPage.style.display = 'flex';

    // æ¸²æŸ“æ¨æ–‡è¯¦æƒ…
    renderTweetDetail(tweetData);

    // ç¡®ä¿ç”¨æˆ·èµ„æ–™å¤´åƒæ­£ç¡®æ˜¾ç¤º
    setTimeout(() => {
      const detailCommentUserAvatar = document.getElementById('detail-comment-user-avatar');
      if (detailCommentUserAvatar) {
        detailCommentUserAvatar.src = userProfileData.avatar;
      }

      // æ›´æ–°æ‰€æœ‰å›å¤è¾“å…¥æ¡†å¤´åƒ
      const replyUserAvatars = document.querySelectorAll('.reply-user-avatar');
      replyUserAvatars.forEach(avatar => {
        avatar.src = userProfileData.avatar;
      });
    }, 100);
  }

  // æ¸²æŸ“æ¨æ–‡è¯¦æƒ…
  function renderTweetDetail(tweet) {
    const container = document.getElementById('tweet-detail-container');
    container.setAttribute('data-tweet-id', tweet.id);

    // åˆ›å»ºè¯¦æƒ…HTML
    const detailHTML = `
              <div class="tweet-detail-item" style="padding: 16px; border-bottom: 1px solid #2f3336;">
                <!-- ç”¨æˆ·ä¿¡æ¯ -->
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                  <img src="${tweet.user.avatar}" alt="${tweet.user.name}" 
                    style="width: 48px; height: 48px; border-radius: 50%;">
                  <div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                      <span style="color: #fff; font-weight: 700; font-size: 17px;">${tweet.user.name}</span>
                      ${
                        tweet.user.verified
                          ? '<svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #1d9bf0;"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>'
                          : ''
                      }
                    </div>
                    <div style="color: #71767b; font-size: 15px;">${tweet.user.handle}</div>
                  </div>
                </div>

                <!-- æ¨æ–‡å†…å®¹ -->
                <div style="color: #fff; font-size: 23px; line-height: 1.3; margin-bottom: 16px; word-wrap: break-word;">
                  ${processContent(tweet.content)}
                </div>

                ${renderTweetMedia(tweet)}
                ${renderTweetLink(tweet)}
                ${renderQuotedTweet(tweet)}

                <!-- æ—¶é—´å’Œä½ç½®ä¿¡æ¯ -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin: 16px 0; padding: 16px 0; border-top: 1px solid #2f3336; border-bottom: 1px solid #2f3336;">
                  <div style="display: flex; align-items: center; gap: 16px;">
                    <span style="color: #71767b; font-size: 15px;">${formatDetailTime(tweet.timestamp)}</span>
                    <span style="color: #71767b; font-size: 15px;">Â·</span>
                    <span id="tweet-detail-views" style="color: #71767b; font-size: 15px;">${formatNumber(
                      tweet.stats.views,
                    )} æŸ¥çœ‹</span>
                  </div>
                  ${
                    tweet.location
                      ? `
                    <div style="display: flex; align-items: center; gap: 4px; color: #1d9bf0; font-size: 15px;">
                      <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;">
                        <g>
                          <path d="M12 7c-1.93 0-3.5 1.57-3.5 3.5S10.07 14 12 14s3.5-1.57 3.5-3.5S13.93 7 12 7zm0 5c-.827 0-1.5-.673-1.5-1.5S11.173 9 12 9s1.5.673 1.5 1.5S12.827 12 12 12zm0-10c-4.687 0-8.5 3.813-8.5 8.5 0 5.967 7.621 11.116 7.945 11.332l.555.37.555-.37C12.879 21.616 20.5 16.467 20.5 10.5 20.5 5.813 16.687 2 12 2zm0 17.77c-1.665-1.241-6.5-5.196-6.5-9.27C5.5 6.916 8.416 4 12 4s6.5 2.916 6.5 6.5c0 4.073-4.835 8.028-6.5 9.27z"></path>
                        </g>
                      </svg>
                      <span>${tweet.location}</span>
                    </div>
                  `
                      : ''
                  }
                </div>

                <!-- äº’åŠ¨æ•°æ® -->
                <div id="tweet-detail-stats" style="display: flex; align-items: center; gap: 32px; padding: 12px 0; border-bottom: 1px solid #2f3336;">
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <span style="color: #fff; font-weight: 700; font-size: 15px;">${formatNumber(
                      tweet.stats.retweets,
                    )}</span>
                    <span style="color: #71767b; font-size: 15px;">è½¬æ¨</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <span style="color: #fff; font-weight: 700; font-size: 15px;">${formatNumber(
                      tweet.stats.likes,
                    )}</span>
                    <span style="color: #71767b; font-size: 15px;">å–œæ¬¢</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <span style="color: #fff; font-weight: 700; font-size: 15px;">${formatNumber(
                      tweet.stats.comments,
                    )}</span>
                    <span style="color: #71767b; font-size: 15px;">ä¹¦ç­¾</span>
                  </div>
                </div>

                <!-- äº’åŠ¨æŒ‰é’® -->
                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                  <div class="tweet-action comment" style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 50%; cursor: pointer; color: #71767b; transition: all 0.2s;" onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'; this.style.color='#1d9bf0';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#71767b';">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                      <g><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g>
                    </svg>
                  </div>
                  <div class="tweet-action retweet" style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 50%; cursor: pointer; color: #71767b; transition: all 0.2s;" onmouseover="this.style.backgroundColor='rgba(0,186,124,0.1)'; this.style.color='#00ba7c';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#71767b';">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                      <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>
                    </svg>
                  </div>
                  <div class="tweet-action like" onclick="toggleDetailLike('${
                    tweet.id
                  }', this)" data-liked="false" data-likes="${
      tweet.stats.likes
    }" style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 50%; cursor: pointer; color: #71767b; transition: all 0.2s;" onmouseover="this.style.backgroundColor='rgba(249,24,128,0.1)'; this.style.color='#f91880';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#71767b';">
                    <svg class="action-icon like-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                      <g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>
                    </svg>
                  </div>
                  <div class="tweet-action bookmark" style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 50%; cursor: pointer; color: #71767b; transition: all 0.2s;" onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'; this.style.color='#1d9bf0';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#71767b';">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                      <g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z"></path></g>
                    </svg>
                  </div>
                  <div class="tweet-action share" style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 50%; cursor: pointer; color: #71767b; transition: all 0.2s;" onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'; this.style.color='#1d9bf0';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#71767b';">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                      <g><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.29 3.3-1.42-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"></path></g>
                    </svg>
                  </div>
                </div>
              </div>
            `;

    container.innerHTML = detailHTML;

    // åŒæ­¥ç”¨æˆ·å¤´åƒ
    const commentInputAvatar = document.querySelector('#x-tweet-detail-page .detail-comment-input-area img');
    if (commentInputAvatar) {
      commentInputAvatar.src = userProfileData.avatar;
    }

    // æ¸²æŸ“è¯„è®ºï¼ˆå¦‚æœæœ‰ï¼‰
    renderDetailComments(tweet.comments);
  }

  // æ¸²æŸ“æ¨æ–‡åª’ä½“å†…å®¹
  function renderTweetMedia(tweet) {
    if (!tweet.image) return '';

    if (tweet.image.type === 'description') {
      return `
                <div style="margin-bottom: 16px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px;">
                  <div style="color: #fff; font-size: 15px; line-height: 1.4;">${tweet.image.content}</div>
                </div>
              `;
    } else if (tweet.image.type === 'upload') {
      return `
                <div style="margin-bottom: 16px; border-radius: 16px; overflow: hidden;">
                  <img src="${tweet.image.content}" style="width: 100%; max-height: 400px; object-fit: cover; display: block;" alt="æ¨æ–‡å›¾ç‰‡">
                </div>
              `;
    }

    return '';
  }

  // æ¸²æŸ“æ¨æ–‡é“¾æ¥
  function renderTweetLink(tweet) {
    if (!tweet.link) return '';

    return `
              <div style="margin-bottom: 16px; border: 1px solid #333; border-radius: 12px; overflow: hidden; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.03)'" onmouseout="this.style.backgroundColor='transparent'">
                ${
                  tweet.link.thumbnail
                    ? `
                  <div style="width: 100%; height: 200px; background-color: #333;">
                    <img src="${tweet.link.thumbnail}" style="width: 100%; height: 100%; object-fit: cover;" alt="é“¾æ¥é¢„è§ˆå›¾">
                  </div>
                `
                    : ''
                }
                <div style="padding: 12px;">
                  <div style="color: #71767b; font-size: 13px; margin-bottom: 4px;">${tweet.link.url || 'é“¾æ¥'}</div>
                  ${
                    tweet.link.title
                      ? `<div style="color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 4px; line-height: 1.3;">${tweet.link.title}</div>`
                      : ''
                  }
                  ${
                    tweet.link.description
                      ? `<div style="color: #71767b; font-size: 14px; line-height: 1.4;">${tweet.link.description}</div>`
                      : ''
                  }
                </div>
              </div>
            `;
  }

  // æ¸²æŸ“å¼•ç”¨æ¨æ–‡å†…å®¹ï¼ˆè¯¦æƒ…é¡µç‰ˆæœ¬ï¼‰
  function renderQuotedTweet(tweet) {
    if (!tweet.quotedTweet) return '';

    const quoted = tweet.quotedTweet;
    const typeText = quoted.type === 'tweet' ? 'æ¨æ–‡' : 'è¯„è®º';

    return `
              <div style="margin-bottom: 16px; border: 1px solid #333; border-radius: 16px; padding: 16px; background-color: rgba(255,255,255,0.03); transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.05)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.03)'">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <img src="${quoted.user.avatar}" style="width: 24px; height: 24px; border-radius: 50%;" alt="${
      quoted.user.name
    }">
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <span style="color: #fff; font-size: 15px; font-weight: 700;">${quoted.user.name}</span>
                    ${
                      quoted.user.verified
                        ? '<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #1d9bf0;"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>'
                        : ''
                    }
                    <span style="color: #71767b; font-size: 15px;">${quoted.user.handle}</span>
                    <span style="color: #71767b; font-size: 15px;">Â·${quoted.time}</span>
                  </div>
                </div>
                <div style="color: #fff; font-size: 17px; line-height: 1.3; word-wrap: break-word;">${
                  quoted.content
                }</div>
                ${renderQuotedTweetMedia(quoted)}
                <div style="color: #71767b; font-size: 13px; margin-top: 12px; font-style: italic;">å¼•ç”¨${typeText}</div>
              </div>
            `;
  }

  // æ¸²æŸ“å¼•ç”¨å†…å®¹çš„åª’ä½“ï¼ˆå›¾ç‰‡ï¼‰
  function renderQuotedTweetMedia(quoted) {
    if (!quoted.image) return '';

    if (quoted.image.type === 'description') {
      return `
                <div style="margin-top: 8px; background-color: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 8px; padding: 8px;">
                  <div style="color: #fff; font-size: 13px; line-height: 1.4;">${quoted.image.content}</div>
                </div>
              `;
    } else if (quoted.image.type === 'upload') {
      return `
                <div style="margin-top: 8px; border-radius: 8px; overflow: hidden;">
                  <img src="${quoted.image.content}" style="width: 100%; max-height: 120px; object-fit: cover; display: block;" alt="å¼•ç”¨å›¾ç‰‡">
                </div>
              `;
    }

    return '';
  }

  // æ ¼å¼åŒ–è¯¦æƒ…é¡µæ—¶é—´
  function formatDetailTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();

    const formatter = new Intl.DateTimeFormat('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });

    return formatter.format(date);
  }

  // è¯¦æƒ…é¡µç‚¹èµåŠŸèƒ½
  function toggleDetailLike(tweetId, element) {
    const isLiked = element.dataset.liked === 'true';
    const currentLikes = parseInt(element.dataset.likes);

    if (isLiked) {
      element.dataset.liked = 'false';
      element.dataset.likes = (currentLikes - 1).toString();
      element.style.color = '#71767b';
    } else {
      element.dataset.liked = 'true';
      element.dataset.likes = (currentLikes + 1).toString();
      element.style.color = '#f91880';
    }
  }

  // è¯¦æƒ…é¡µè¯„è®ºç›¸å…³åŠŸèƒ½
  function handleDetailCommentInput(event) {
    const textarea = event.target;
    const replyBtn = document.getElementById('detail-reply-btn');

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    if (textarea.value.trim().length > 0) {
      replyBtn.style.opacity = '1';
      replyBtn.disabled = false;
    } else {
      replyBtn.style.opacity = '0.5';
      replyBtn.disabled = true;
    }

    // å›è½¦å‘é€è¯„è®º
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      if (textarea.value.trim().length > 0) {
        submitDetailComment();
      }
    }
  }

  function autoResizeDetail(textarea) {
    textarea.style.height = '20px';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';

    const replyBtn = document.getElementById('detail-reply-btn');
    if (textarea.value.trim().length > 0) {
      replyBtn.style.opacity = '1';
      replyBtn.disabled = false;
    } else {
      replyBtn.style.opacity = '0.5';
      replyBtn.disabled = true;
    }
  }

  async function submitDetailComment() {
    const textarea = document.getElementById('detail-comment-input');
    const content = textarea.value.trim();

    if (content.length === 0) return;

    // è·å–å½“å‰æ¨æ–‡æ•°æ®
    const currentTweetData = sessionStorage.getItem('currentTweetData');
    if (!currentTweetData) {
      showXToast('æ— æ³•è·å–æ¨æ–‡ä¿¡æ¯', 'error');
      return;
    }

    let tweetData;
    try {
      tweetData = JSON.parse(currentTweetData);
    } catch (e) {
      showXToast('æ¨æ–‡æ•°æ®è§£æå¤±è´¥', 'error');
      return;
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºä»…è‡ªå·±å¯è§çš„å¸–å­
    if (tweetData.privacy === 'private') {
      showXToast('ç§æœ‰å¸–å­ä¸æ”¯æŒå›å¤åŠŸèƒ½', 'error');
      return;
    }

    const newComment = {
      id: 'detail_' + Date.now(),
      user: {
        name: window.userProfileData.name,
        handle: window.userProfileData.handle,
        avatar: window.userProfileData.avatar,
        verified: window.userProfileData.verified,
      },
      content: content,
      time: 'åˆšåˆš',
      replies: [],
    };

    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡æ•°æ®
    if (detailCommentImageData) {
      newComment.image = {
        type: 'upload',
        content: detailCommentImageData,
      };
    }

    // æ¸²æŸ“æ–°è¯„è®º
    const commentsContainer = document.getElementById('detail-comments-container');
    const commentElement = createCommentElement(newComment);
    commentsContainer.appendChild(commentElement);

    // æ›´æ–°æ–°æ·»åŠ çš„å›å¤è¾“å…¥æ¡†å¤´åƒï¼ˆä½¿ç”¨window.userProfileDataç¡®ä¿è·å–æœ€æ–°è´¦å·æ•°æ®ï¼‰
    const replyUserAvatars = document.querySelectorAll('.reply-user-avatar');
    replyUserAvatars.forEach(avatar => {
      avatar.src = window.userProfileData.avatar;
    });

    // æ¸…ç©ºè¾“å…¥æ¡†
    textarea.value = '';
    textarea.style.height = '20px';

    // æ¸…é™¤å›¾ç‰‡
    if (detailCommentImageData) {
      removeDetailCommentImage();
    }

    const replyBtn = document.getElementById('detail-reply-btn');
    replyBtn.style.opacity = '0.5';
    replyBtn.disabled = true;

    showXToast('ä½ çš„è¯„è®ºç­‰å¾…å›å¤ä¸­', 'info');

    // è§¦å‘AIå›å¤ - åˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·è‡ªå·±çš„å¸–å­
    const isOwnPost =
      tweetData.user && (tweetData.user.handle === userProfileData.handle || tweetData.id.startsWith('user_'));
    await generateUnifiedAIResponse(tweetData, newComment, {
      isOwnPost,
      commentType: 'main_comment',
      pageType: 'detail',
      parentComment: null,
    });
  }

  function renderDetailComments(comments) {
    const container = document.getElementById('detail-comments-container');
    container.innerHTML = '';

    if (!comments || comments.length === 0) return;

    comments.forEach(comment => {
      const commentElement = createCommentElement(comment);
      container.appendChild(commentElement);
    });

    // æ›´æ–°æ‰€æœ‰å›å¤è¾“å…¥æ¡†å¤´åƒ
    const replyUserAvatars = document.querySelectorAll('.reply-user-avatar');
    replyUserAvatars.forEach(avatar => {
      avatar.src = userProfileData.avatar;
    });
  }

  // â–¼â–¼â–¼ ã€ä¸»è¦ï¼ï¼ï¼ã€‘ç¬¬äºŒä¸ªæƒ…æ™¯ï¼šå‘å¸–ç”Ÿæˆå™¨â–¼â–¼â–¼
  async function generateAIResponseForTweet(tweetData, isReroll = false) {
    try {
      // ä»æ•°æ®åº“è¯»å–APIé…ç½®
      const db = getDB(); // ç”¨äºè®¿é—®APIé…ç½®
      const xDb = getXDB(); // ç”¨äºè®¿é—®Xä¸“ç”¨è®¾ç½®

      const apiConfig = await db.apiConfig.get('main');
      if (!apiConfig || !apiConfig.proxyUrl || !apiConfig.apiKey || !apiConfig.model) {
        showXToast('è¯·å…ˆé…ç½®APIè®¾ç½®', 'error');
        return;
      }

      const { proxyUrl, apiKey, model } = apiConfig;

      // ä»Xè®¾ç½®ä¸­è¯»å–é…ç½®ï¼ˆæŒ‰è´¦å·è¯»å–ï¼‰
      const settingsId = `xSettings_${currentAccountId || 'main'}`;
      const xSettings = await xDb.xSettings.get(settingsId);
      const userPrompt = xSettings?.systemPrompt || '';
      const worldSetting = xSettings?.worldSetting || '';
      const boundCharacters = xSettings?.boundCharacters || [];

      // ä½¿ç”¨å·¥å…·å‡½æ•°æ„å»ºç”¨æˆ·Xä¸ªäººèµ„æ–™ä¿¡æ¯ï¼ˆä½¿ç”¨window.userProfileDataç¡®ä¿è·å–æœ€æ–°æ•°æ®ï¼‰
      const userXProfileInfo = StringBuilders.buildUserXProfileInfo(window.userProfileData);

      // è·å–çŸ¥é“ç”¨æˆ·èº«ä»½çš„è§’è‰²ä¿¡æ¯
      let knownIdentityCharactersInfo = '';
      if (userXProfileInfo.knownIdentityCharacters.length > 0 && boundCharacters.length > 0) {
        const allChats = await db.chats.toArray();
        const knownCharacters = allChats.filter(
          chat => !chat.isGroup && userXProfileInfo.knownIdentityCharacters.includes(chat.id),
        );

        if (knownCharacters.length > 0) {
          knownIdentityCharactersInfo = '\n\nã€çŸ¥é“ç”¨æˆ·èº«ä»½çš„è§’è‰²ã€‘ï¼š';
          for (const char of knownCharacters) {
            let xProfile = await xDb.xCharacterProfiles.get(char.id);
            if (xProfile) {
              knownIdentityCharactersInfo += `\n- ${xProfile.xName} (${xProfile.xHandle}): çŸ¥é“ç”¨æˆ·èº«ä»½ï¼Œå¯èƒ½ä¼šå¯¹ç”¨æˆ·çš„å¸–å­è¿›è¡Œäº’åŠ¨`;
              if (char.history && char.history.length > 0) {
                const recentHistory = char.history.slice(-5);
                knownIdentityCharactersInfo += '\n  æœ€è¿‘äº’åŠ¨è®°å¿†ï¼š';
                recentHistory.forEach(msg => {
                  if (msg.role === 'assistant' && msg.content) {
                    knownIdentityCharactersInfo += `\n  - ${msg.content.substring(0, 80)}...`;
                  }
                });
              }
            }
          }
          knownIdentityCharactersInfo += '\n\næ³¨æ„ï¼šè¿™äº›è§’è‰²å¯èƒ½ä¼šå¯¹ç”¨æˆ·çš„å¸–å­è¿›è¡Œè¯„è®ºï¼Œä½†æ¦‚ç‡ä¸è¦å¤ªé«˜ï¼Œè¦è‡ªç„¶ã€‚';
        }
      }

      // 1. æç¤ºè¯ + ä¸–ç•Œä¹¦
      let systemPrompt = StringBuilders.buildBaseSystemPrompt({
        userPrompt,
        worldSetting,
      });

      // 2. è§’è‰²å®šä¹‰ï¼ˆå¸–å­å›å¤ç”Ÿæˆä¸“ç”¨ï¼‰
      systemPrompt += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš« æ ¸å¿ƒä»»åŠ¡è¯´æ˜ ğŸš«
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä½ æ˜¯Xç¤¾äº¤å¹³å°çš„äº’åŠ¨ç”Ÿæˆå™¨ã€‚ç”¨æˆ·åˆšå‘å¸ƒäº†ä¸€æ¡æ–°å¸–å­ï¼Œä½ çš„ä»»åŠ¡æ˜¯ï¼š
âœ… ç”Ÿæˆå…¶ä»–Xå¹³å°ç”¨æˆ·å¯¹è¿™æ¡å¸–å­çš„è¯„è®ºå’Œååº”
âŒ ç»å¯¹ä¸èƒ½ç”Ÿæˆç”¨æˆ·æœ¬äººå‘è¡¨çš„ä»»ä½•å†…å®¹

**æ˜ç¡®ï¼šç”¨æˆ·å·²ç»å‘å¸ƒäº†æ¨æ–‡ï¼Œä½ åªè´Ÿè´£ç”Ÿæˆåˆ«äººçš„å›åº”ï¼**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;

      // 3. è§’è‰²èµ„æ–™ï¼ˆäº’åŠ¨ååº”åœºæ™¯ï¼‰
      const charactersInfo = await StringBuilders.buildCompleteCharacterInfo(
        boundCharacters,
        userXProfileInfo,
        'reaction',
      );
      if (charactersInfo) {
        systemPrompt += charactersInfo;
      }
      if (knownIdentityCharactersInfo) {
        systemPrompt += knownIdentityCharactersInfo;
      }

      // 4. ç”¨æˆ·èµ„æ–™
      systemPrompt += StringBuilders.buildUniversalConstraints(userXProfileInfo);

      systemPrompt += `

ã€ç”Ÿæˆè¦æ±‚ã€‘ï¼š
- ç”Ÿæˆ1-15æ¡è¯„è®ºï¼Œå†…å®¹å¤šæ ·åŒ–ï¼ˆç®€çŸ­/æ·±åº¦/è¡¨æƒ…ç¬¦å·ï¼‰ï¼Œæ”¯æŒæ¥¼ä¸­æ¥¼å›å¤ï¼Œå…¨å¹´é¾„é€‚å®œ
- å¼•ç”¨è½¬å‘å¤„ç†ï¼šå¦‚å¸–å­å«å¼•ç”¨å†…å®¹ï¼Œè¯„è®ºå¯æ¶‰åŠç”¨æˆ·è§‚ç‚¹å’Œè¢«å¼•ç”¨åŸå†…å®¹
- å…¬ä¼—èº«ä»½å½±å“ï¼šçŸ¥ååº¦è¶Šé«˜ï¼Œè®¨è®ºçƒ­åº¦å’Œäº’åŠ¨æ•°æ®è¶Šå¤š

ã€æƒ…ä¾£è§’è‰²å›å¤è§„åˆ™ã€‘ï¼š
${
  userXProfileInfo.verificationType === 'couple' && userXProfileInfo.coupleCharacterName
    ? `- ç”¨æˆ·çš„æƒ…ä¾£æ˜¯ ${userXProfileInfo.coupleCharacterName}ï¼ˆå…¬å¼€å…³ç³»ï¼‰
- å‡ºç°æ¦‚ç‡åº”å¾ˆä½ï¼ˆ10-20%ï¼Œä¸å¸–å­æ— å…³æ—¶æ›´ä½ï¼‰
- è¯„è®ºå›´ç»•å¸–å­ä¸»é¢˜ï¼Œè‡ªç„¶ä½“ç°äº²å¯†å…³ç³»ä½†ä¸è¿‡åˆ†å¼ºè°ƒ
- ç²‰ä¸ç¾¤ä½“é™åˆ¶ï¼šä»…å½“åŒæ–¹ä¸ºæ˜æ˜Ÿ/ç½‘çº¢/å…¬ä¼—äººç‰©æ—¶æ‰å¯èƒ½ç”Ÿæˆ1-2æ¡CPç²‰ä¸è¯„è®ºï¼Œæ™®é€šæƒ…ä¾£ä¸¥ç¦ç”Ÿæˆ"ç£•CP""å—‘ç³–"ç­‰ç²‰ä¸å‘è¯„è®º`
    : ''
}

ã€JSONè¿”å›æ ¼å¼ã€‘ï¼š
\`\`\`json
{
  "stats": {retweets, likes, views, comments},
  "comments": [è¯„è®ºæ•°ç»„]
}
\`\`\`

è¯„è®ºå¯¹è±¡ç»“æ„ï¼š
- user: {name, handle, avatar, verified}
- content: è¯„è®ºæ–‡æœ¬
- time: æ—¶é—´æè¿°
- replies: [å›å¤æ•°ç»„] (å¯é€‰ï¼Œæ¥¼ä¸­æ¥¼å›å¤ï¼Œä¸è¶…è¿‡3å±‚)
- replyTo: "@è¢«å›å¤è€…å¥æŸ„" (æ¥¼ä¸­æ¥¼å›å¤æ—¶å¿…å¡«)

å…³é”®è§„åˆ™ï¼š
1. verifiedå­—æ®µå¿…é¡»æ˜¯å¸ƒå°”å€¼(true/false)
2. statsä¸­æ‰€æœ‰æ•°å­—å¿…é¡»æ˜¯çº¯æ•°å­—
3. æ”¯æŒå¤šå±‚å¯¹è¯é“¾ï¼šAè¯„è®º â†’ Bå›å¤A(replyTo:"@A") â†’ Cå›å¤B(replyTo:"@B")`;

      // æ„å»ºæ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒå›¾ç‰‡è¯†åˆ«
      const messageContent = [];

      // æ·»åŠ åŸºç¡€æ–‡æœ¬å†…å®¹
      let contentText = `è¯·ä¸ºè¿™æ¡æ¨æ–‡ç”Ÿæˆç¤¾äº¤äº’åŠ¨æ•°æ®ï¼š

æ¨æ–‡å†…å®¹ï¼š"${tweetData.content}"
${tweetData.location ? `ä½ç½®ï¼š${tweetData.location}` : ''}
${tweetData.link ? `é“¾æ¥ï¼š${tweetData.link.title || tweetData.link.url}` : ''}`;

      // å¦‚æœæœ‰å¼•ç”¨å†…å®¹ï¼Œæ·»åŠ å¼•ç”¨ä¿¡æ¯
      if (tweetData.quotedTweet) {
        const quoted = tweetData.quotedTweet;
        const quotedType = quoted.type === 'tweet' ? 'æ¨æ–‡' : 'è¯„è®º';
        contentText += `

ã€å¼•ç”¨${quotedType}ã€‘ï¼š
åŸä½œè€…ï¼š${quoted.user.name} (${quoted.user.handle})${quoted.user.verified ? ' âœ“å·²è®¤è¯' : ''}
å‘å¸ƒæ—¶é—´ï¼š${quoted.time}
åŸå†…å®¹ï¼š"${quoted.content}"`;

        // å¦‚æœå¼•ç”¨å†…å®¹åŒ…å«å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡ä¿¡æ¯
        if (quoted.image) {
          if (quoted.image.type === 'description') {
            contentText += `
åŸå›¾ç‰‡æè¿°ï¼š${quoted.image.content}`;
          } else if (quoted.image.type === 'upload') {
            contentText += `
åŸå›¾ç‰‡ï¼šåŒ…å«ä¸Šä¼ çš„å›¾ç‰‡å†…å®¹`;
          }
        }

        // å¦‚æœå¼•ç”¨å†…å®¹åŒ…å«ä½ç½®ä¿¡æ¯
        if (quoted.location) {
          contentText += `
åŸä½ç½®ï¼š${quoted.location}`;
        }

        contentText += `

æ³¨æ„ï¼šè¿™æ˜¯ä¸€æ¡å¼•ç”¨è½¬å‘ï¼Œç”¨æˆ·å¯¹åŸ${quotedType}è¿›è¡Œäº†è¯„è®ºå¹¶è½¬å‘ã€‚AIå›å¤åº”è¯¥è€ƒè™‘åˆ°è¿™ä¸ªå¼•ç”¨å…³ç³»å’Œä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆçš„è¯„è®ºå¯èƒ½ä¼šåŒæ—¶æ¶‰åŠç”¨æˆ·çš„è¯„è®ºå’Œè¢«å¼•ç”¨çš„åŸå†…å®¹ã€‚`;
      }

      messageContent.push({ type: 'text', text: contentText });

      // å¦‚æœæœ‰ä¸Šä¼ çš„å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡å†…å®¹
      if (tweetData.image && tweetData.image.type === 'upload' && tweetData.image.content) {
        messageContent.push({
          type: 'image_url',
          image_url: { url: tweetData.image.content },
        });
      } else if (tweetData.image && tweetData.image.type === 'description') {
        messageContent.push({
          type: 'text',
          text: `å›¾ç‰‡æè¿°ï¼š${tweetData.image.content}`,
        });
      }

      const messages = [{ role: 'user', content: messageContent }];

      // åˆ¤æ–­APIç±»å‹å¹¶å‘é€è¯·æ±‚
      let isGemini = proxyUrl.includes('generativelanguage');
      let response;

      if (isGemini) {
        // ä¸ºXç¤¾äº¤é¡µé¢åˆ›å»ºæ­£ç¡®çš„Geminiè¯·æ±‚é…ç½®
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
        const geminiConfig = {
          url: `${GEMINI_API_URL}/${model}:generateContent?key=${getRandomValue(apiKey)}`,
          data: {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text:
                        systemPrompt +
                        '\n\n' +
                        messages
                          .map(m =>
                            Array.isArray(m.content) ? m.content.map(c => c.text || '[å›¾ç‰‡]').join(' ') : m.content,
                          )
                          .join('\n'),
                    },
                  ],
                },
              ],
              generationConfig: {
                temperature: 0.8,
              },
            }),
          },
        };
        response = await fetch(geminiConfig.url, geminiConfig.data);
      } else {
        const openAiPayload = {
          model: model,
          messages: [{ role: 'system', content: systemPrompt }, ...messages],
          temperature: 0.8,
          stream: false,
        };
        response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify(openAiPayload),
        });
      }

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`APIé”™è¯¯: ${response.status} - ${errorData.error?.message || response.statusText}`);
      }

      const data = await response.json();
      let aiResponseContent;

      if (isGemini) {
        aiResponseContent = getGeminiResponseText(data);
      } else {
        // OpenAIæ ¼å¼
        aiResponseContent = data.choices?.[0]?.message?.content || '';
      }

      console.log('AIåŸå§‹å“åº”:', aiResponseContent);

      // è°ƒè¯•ç”¨æˆ·èº«ä»½è¯†åˆ«ä¿¡æ¯
      console.log('ç”¨æˆ·èº«ä»½è¯†åˆ«è°ƒè¯•ä¿¡æ¯ï¼ˆå‘å¸–AIå›å¤ï¼‰:');
      console.log('- ç”¨æˆ·Xèµ„æ–™:', userXProfileInfo);
      console.log('- çŸ¥é“ç”¨æˆ·èº«ä»½çš„è§’è‰²æ•°é‡:', userXProfileInfo.knownIdentityCharacters.length);
      if (knownIdentityCharactersInfo) {
        console.log('- çŸ¥é“ç”¨æˆ·èº«ä»½çš„è§’è‰²ä¿¡æ¯å·²æ·»åŠ åˆ°AIä¸Šä¸‹æ–‡');
      }

      // è§£æAIè¿”å›çš„JSONæ•°æ®
      const cleanedResponse = aiResponseContent
        .replace(/```json\s*/, '')
        .replace(/```\s*$/, '')
        .trim();

      if (!cleanedResponse) {
        throw new Error('AIè¿”å›äº†ç©ºçš„å“åº”å†…å®¹');
      }

      let interactionData;
      try {
        interactionData = JSON.parse(cleanedResponse);
      } catch (parseError) {
        console.error('JSONè§£æå¤±è´¥:', parseError);
        console.error('å°è¯•è§£æçš„å†…å®¹:', cleanedResponse);
        throw new Error(`AIè¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼: ${parseError.message}`);
      }

      // éªŒè¯æ•°æ®æ ¼å¼
      if (!interactionData.stats || !interactionData.comments) {
        throw new Error('AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
      }

      // ä¸ºè¯„è®ºåˆ†é…ID
      const timestamp = Date.now();
      interactionData.comments.forEach((comment, index) => {
        comment.id = `ai_${timestamp}_${index}`;

        // ä¸ºå›å¤åˆ†é…ID
        if (comment.replies && comment.replies.length > 0) {
          comment.replies.forEach((reply, replyIndex) => {
            reply.id = `ai_${timestamp}_${index}_${replyIndex}`;
          });
        }
      });

      // æ›´æ–°æ¨æ–‡è¯¦æƒ…é¡µé¢çš„æ•°æ®
      await updateTweetDetailWithAI(tweetData.id, interactionData, isReroll);

      // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è¿™æ¡æ¨æ–‡çš„è¯¦æƒ…é¡µï¼Œé‡æ–°åŠ è½½å®Œæ•´æ•°æ®å¹¶æ˜¾ç¤º
      const detailPage = document.getElementById('x-tweet-detail-page');
      if (detailPage && detailPage.style.display === 'flex') {
        const currentTweetData = sessionStorage.getItem('currentTweetData');
        if (currentTweetData) {
          const currentTweet = JSON.parse(currentTweetData);
          if (currentTweet.id === tweetData.id) {
            // ä»æ•°æ®åº“é‡æ–°åŠ è½½æœ€æ–°çš„æ¨æ–‡æ•°æ®ï¼ˆåŒ…å«AIååº”ï¼‰
            const db = getXDB();
            const accountTweetsId = `userTweets_${currentAccountId || 'main'}`;
            const userTweets = await db.xUserTweets.get(accountTweetsId);
            if (userTweets) {
              const updatedTweet = userTweets.tweets.find(t => t.id === tweetData.id);
              if (updatedTweet) {
                await showTweetDetail(updatedTweet);
                console.log('âœ… è¯¦æƒ…é¡µå·²åˆ·æ–°ï¼Œæ˜¾ç¤ºæœ€æ–°AIååº”');
              }
            }
          }
        }
      }

      showXToast('ä½ çš„å¸–å­æœ‰äººå›å¤äº†å“¦', 'success');
    } catch (error) {
      console.error('ç”ŸæˆAIå›å¤å¤±è´¥:', error);
      showXToast(`å›å¤ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
    }
  }

  // é‡æ–°ç”ŸæˆAIå›å¤
  async function rerollAIReplies() {
    try {
      // è·å–å½“å‰æ¨æ–‡ID
      const currentTweetId = getCurrentTweetId();
      if (!currentTweetId) {
        showXToast('æ— æ³•è·å–å½“å‰æ¨æ–‡ä¿¡æ¯', 'error');
        return;
      }

      // è·å–æ¨æ–‡æ•°æ®
      const xTweetsData = await getXTweetsData();
      const currentTweet = xTweetsData.find(tweet => tweet.id === currentTweetId);
      if (!currentTweet) {
        showXToast('æœªæ‰¾åˆ°æ¨æ–‡æ•°æ®', 'error');
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const rerollBtn = document.getElementById('reroll-replies-btn');
      const originalHTML = rerollBtn.innerHTML;
      rerollBtn.innerHTML = `
                 <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff; animation: spin 1s linear infinite;">
                   <g>
                  <path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z" />
                   </g>
                 </svg>
               `;
      rerollBtn.style.pointerEvents = 'none';

      // æ˜¾ç¤ºé‡å›æç¤º
      showXToast('æ­£åœ¨é‡æ–°ç”Ÿæˆå›å¤...', 'info');

      // é‡æ–°ç”ŸæˆAIå›å¤
      await generateAIResponseForTweet(currentTweet, true);

      // æ¢å¤æŒ‰é’®çŠ¶æ€
      rerollBtn.innerHTML = originalHTML;
      rerollBtn.style.pointerEvents = 'auto';
    } catch (error) {
      console.error('é‡æ–°ç”ŸæˆAIå›å¤å¤±è´¥:', error);
      showXToast('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');

      // æ¢å¤æŒ‰é’®çŠ¶æ€
      const rerollBtn = document.getElementById('reroll-replies-btn');
      const originalHTML = `
                             <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">
              <g>
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </g>
            </svg>
               `;
      rerollBtn.innerHTML = originalHTML;
      rerollBtn.style.pointerEvents = 'auto';
    }
  }

  // è·å–å½“å‰æ˜¾ç¤ºçš„æ¨æ–‡ID
  function getCurrentTweetId() {
    const tweetDetailContainer = document.getElementById('tweet-detail-container');
    return tweetDetailContainer ? tweetDetailContainer.getAttribute('data-tweet-id') : null;
  }

  // è·å–æ¨æ–‡æ•°æ® - ç®€åŒ–ç‰ˆæœ¬ï¼Œç›´æ¥è¿”å›å½“å‰æ¨æ–‡æ•°æ®
  async function getXTweetsData() {
    // å› ä¸ºæ¨æ–‡è¯¦æƒ…é¡µé¢åªæ˜¾ç¤ºå•ä¸ªæ¨æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥ä»DOMä¸­é‡æ„æ•°æ®
    const currentTweetId = getCurrentTweetId();
    if (!currentTweetId) return [];

    // ä»sessionStorageè·å–æ¨æ–‡æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
    const tweetData = sessionStorage.getItem('currentTweetData');
    if (tweetData) {
      try {
        return [JSON.parse(tweetData)];
      } catch (e) {
        console.warn('æ— æ³•è§£ææ¨æ–‡æ•°æ®:', e);
      }
    }

    return [];
  }
  // â–²â–²â–² ã€ä¸»è¦ï¼ï¼ï¼ã€‘ç¬¬äºŒä¸ªæƒ…æ™¯ï¼šå‘å¸–ç”Ÿæˆå™¨ â–²â–²â–²

  // ä¿å­˜ç”¨æˆ·å‘å¸ƒçš„å¸–å­
  async function saveUserTweet(tweetData) {
    try {
      const db = getXDB();
      const accountTweetsId = `userTweets_${currentAccountId || 'main'}`;

      // è·å–å½“å‰è´¦æˆ·çš„æ¨æ–‡æ•°æ®
      let userTweets = await db.xUserTweets.get(accountTweetsId);
      if (!userTweets) {
        userTweets = { id: accountTweetsId, tweets: [] };
      }

      // ä¸ºæ¨æ–‡æ·»åŠ è´¦æˆ·IDæ ‡è¯†
      tweetData.accountId = currentAccountId || 'main';

      // æ·»åŠ æ–°æ¨æ–‡åˆ°å¼€å¤´ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
      userTweets.tweets.unshift(tweetData);

      // ä¿å­˜æ›´æ–°åçš„æ•°æ®
      await db.xUserTweets.put(userTweets);

      console.log('ç”¨æˆ·æ¨æ–‡å·²ä¿å­˜åˆ°è´¦æˆ·:', currentAccountId, tweetData);
    } catch (error) {
      console.error('ä¿å­˜ç”¨æˆ·æ¨æ–‡å¤±è´¥:', error);
    }
  }

  // è·å–å½“å‰è´¦æˆ·å‘å¸ƒçš„æ‰€æœ‰å¸–å­
  async function getUserTweets() {
    try {
      const db = getXDB();
      const accountTweetsId = `userTweets_${currentAccountId || 'main'}`;

      const userTweets = await db.xUserTweets.get(accountTweetsId);
      return userTweets ? userTweets.tweets : [];
    } catch (error) {
      console.error('è·å–ç”¨æˆ·æ¨æ–‡å¤±è´¥:', error);
      return [];
    }
  }

  // å¤šé€‰åˆ é™¤ç›¸å…³å˜é‡
  let isMultiSelectMode = false;
  let selectedTweets = new Set();

  // åˆ‡æ¢æ¨æ–‡é€‰æ‹©çŠ¶æ€
  function toggleTweetSelection(tweetId) {
    if (!isMultiSelectMode) {
      enterMultiSelectMode();
    }

    const tweetEl = document.querySelector(`[data-tweet-id="${tweetId}"]`);
    if (!tweetEl) return;

    if (selectedTweets.has(tweetId)) {
      selectedTweets.delete(tweetId);
      tweetEl.classList.remove('selected');
      tweetEl.style.backgroundColor = '';
    } else {
      selectedTweets.add(tweetId);
      tweetEl.classList.add('selected');
      tweetEl.style.backgroundColor = 'rgba(29, 155, 240, 0.1)';
    }

    updateDeleteUI();
  }

  // è¿›å…¥å¤šé€‰æ¨¡å¼
  function enterMultiSelectMode() {
    isMultiSelectMode = true;

    // æ˜¾ç¤ºåˆ é™¤å·¥å…·æ 
    showDeleteToolbar();

    // æ”¹å˜æ‰€æœ‰æ¨æ–‡çš„æ ·å¼
    document.querySelectorAll('.user-tweet-item').forEach(item => {
      item.style.borderLeft = '3px solid #1d9bf0';
    });
  }

  // é€€å‡ºå¤šé€‰æ¨¡å¼
  function exitMultiSelectMode() {
    isMultiSelectMode = false;
    selectedTweets.clear();

    // éšè—åˆ é™¤å·¥å…·æ 
    hideDeleteToolbar();

    // æ¢å¤æ‰€æœ‰æ¨æ–‡çš„æ ·å¼
    document.querySelectorAll('.user-tweet-item').forEach(item => {
      item.classList.remove('selected');
      item.style.backgroundColor = '';
      item.style.borderLeft = '';
    });
  }

  // æ˜¾ç¤ºåˆ é™¤å·¥å…·æ 
  function showDeleteToolbar() {
    let toolbar = document.getElementById('delete-toolbar');
    if (!toolbar) {
      toolbar = document.createElement('div');
      toolbar.id = 'delete-toolbar';
      toolbar.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #000;
                border: 1px solid #333;
                border-radius: 20px;
                padding: 8px 16px;
                display: flex;
                align-items: center;
                gap: 12px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5);
              `;

      toolbar.innerHTML = `
                <button onclick="selectAllTweets()" style="background-color: #1d9bf0; color: #fff; border: none; border-radius: 16px; padding: 6px 12px; font-size: 13px; cursor: pointer;">
                  å…¨é€‰
                </button>
                <span id="selected-count" style="color: #fff; font-size: 14px;">å·²é€‰æ‹© 0 æ¡</span>
                <button onclick="deleteSelectedTweets()" style="background-color: #f91880; color: #fff; border: none; border-radius: 16px; padding: 6px 12px; font-size: 13px; cursor: pointer;">
                  åˆ é™¤
                </button>
                <button onclick="exitMultiSelectMode()" style="background-color: #333; color: #fff; border: none; border-radius: 16px; padding: 6px 12px; font-size: 13px; cursor: pointer;">
                  å–æ¶ˆ
                </button>
              `;

      document.body.appendChild(toolbar);
    }
    toolbar.style.display = 'flex';
  }

  // éšè—åˆ é™¤å·¥å…·æ 
  function hideDeleteToolbar() {
    const toolbar = document.getElementById('delete-toolbar');
    if (toolbar) {
      toolbar.style.display = 'none';
    }
  }

  // æ›´æ–°åˆ é™¤UI
  function updateDeleteUI() {
    const countEl = document.getElementById('selected-count');
    if (countEl) {
      countEl.textContent = `å·²é€‰æ‹© ${selectedTweets.size} æ¡`;
    }
  }

  // å…¨é€‰æ¨æ–‡
  function selectAllTweets() {
    document.querySelectorAll('.user-tweet-item').forEach(item => {
      const tweetId = item.dataset.tweetId;
      if (!selectedTweets.has(tweetId)) {
        selectedTweets.add(tweetId);
        item.classList.add('selected');
        item.style.backgroundColor = 'rgba(29, 155, 240, 0.1)';
      }
    });
    updateDeleteUI();
  }

  // åˆ é™¤é€‰ä¸­çš„æ¨æ–‡
  async function deleteSelectedTweets() {
    if (selectedTweets.size === 0) return;

    const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedTweets.size} æ¡æ¨æ–‡å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚`);
    if (!confirmDelete) return;

    try {
      const db = getXDB();

      // è·å–å½“å‰è´¦æˆ·çš„æ¨æ–‡æ•°æ®
      const accountTweetsId = `userTweets_${currentAccountId || 'main'}`;
      const userTweets = await db.xUserTweets.get(accountTweetsId);
      if (userTweets && userTweets.tweets) {
        // è¿‡æ»¤æ‰é€‰ä¸­çš„æ¨æ–‡
        userTweets.tweets = userTweets.tweets.filter(tweet => !selectedTweets.has(tweet.id));

        // ä¿å­˜æ›´æ–°åçš„æ•°æ®
        await db.xUserTweets.put(userTweets);

        // åŒæ—¶ä»ä¸»æ¨æ–‡æ•°æ®ä¸­åˆ é™¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const tweetsData = await db.xTweetsData.get('tweets');
        if (tweetsData) {
          let updated = false;

          if (tweetsData.forYouTweets) {
            const originalLength = tweetsData.forYouTweets.length;
            tweetsData.forYouTweets = tweetsData.forYouTweets.filter(tweet => !selectedTweets.has(tweet.id));
            if (tweetsData.forYouTweets.length !== originalLength) updated = true;
          }

          if (tweetsData.followingTweets) {
            const originalLength = tweetsData.followingTweets.length;
            tweetsData.followingTweets = tweetsData.followingTweets.filter(tweet => !selectedTweets.has(tweet.id));
            if (tweetsData.followingTweets.length !== originalLength) updated = true;
          }

          if (updated) {
            await db.xTweetsData.put(tweetsData);
          }
        }

        showXToast(`å·²åˆ é™¤ ${selectedTweets.size} æ¡æ¨æ–‡`, 'success');

        // é€€å‡ºå¤šé€‰æ¨¡å¼å¹¶åˆ·æ–°æ˜¾ç¤º
        exitMultiSelectMode();
        loadUserProfileTweets();
      }
    } catch (error) {
      console.error('åˆ é™¤æ¨æ–‡å¤±è´¥:', error);
      showXToast('åˆ é™¤å¤±è´¥', 'error');
    }
  }

  // åŠ è½½ç”¨æˆ·ä¸ªäººé¡µé¢çš„æ¨æ–‡
  async function loadUserProfileTweets() {
    try {
      const userTweets = await getUserTweets();
      const container = document.getElementById('x-profile-tweets-container');

      if (userTweets.length === 0) {
        container.innerHTML = `
                  <div style="padding: 60px 32px; text-align: center;">
                    <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;">è¿˜æ²¡æœ‰æ¨æ–‡</div>
                    <div style="color: #71767b; font-size: 15px;">å½“ä½ å‘é€ç¬¬ä¸€æ¡æ¨æ–‡æ—¶ï¼Œå®ƒä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</div>
                  </div>
                `;
      } else {
        container.innerHTML = '';
        userTweets.forEach(tweet => {
          const tweetElement = createUserTweetElement(tweet);
          container.appendChild(tweetElement);
        });
      }

      // æ›´æ–°å¸–å­æ•°é‡æ˜¾ç¤º
      const headerCount = document.getElementById('x-profile-header-count');
      if (headerCount) {
        headerCount.textContent = `${userTweets.length} å¸–å­`;
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ¨æ–‡å¤±è´¥:', error);
    }
  }

  // åˆ›å»ºç”¨æˆ·æ¨æ–‡å…ƒç´ ï¼ˆä¸ªäººé¡µé¢ç‰ˆæœ¬ï¼‰
  function createUserTweetElement(tweet) {
    const tweetEl = document.createElement('div');
    tweetEl.className = 'tweet-item user-tweet-item';
    tweetEl.dataset.tweetId = tweet.id;
    tweetEl.style.cursor = 'pointer';
    tweetEl.style.position = 'relative';

    // è§¦æ‘¸äº‹ä»¶å¤„ç†å˜é‡
    let longPressTimer;
    let isLongPressed = false;
    let touchStartX = 0;
    let touchStartY = 0;
    let hasMoved = false;
    const TOUCH_THRESHOLD = 15; // æ»‘åŠ¨é˜ˆå€¼ï¼ˆåƒç´ ï¼‰

    tweetEl.addEventListener('touchstart', e => {
      // è®°å½•åˆå§‹è§¦æ‘¸ä½ç½®
      const touch = e.touches[0];
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
      hasMoved = false;

      longPressTimer = setTimeout(() => {
        if (!hasMoved) {
          // åªæœ‰æ²¡æœ‰ç§»åŠ¨æ—¶æ‰è§¦å‘é•¿æŒ‰
          isLongPressed = true;
          toggleTweetSelection(tweet.id);
          e.preventDefault();
        }
      }, 800);
    });

    tweetEl.addEventListener('touchmove', e => {
      const touch = e.touches[0];
      const deltaX = Math.abs(touch.clientX - touchStartX);
      const deltaY = Math.abs(touch.clientY - touchStartY);

      // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡é˜ˆå€¼ï¼Œæ ‡è®°ä¸ºæ»‘åŠ¨
      if (deltaX > TOUCH_THRESHOLD || deltaY > TOUCH_THRESHOLD) {
        hasMoved = true;
        clearTimeout(longPressTimer); // å–æ¶ˆé•¿æŒ‰
      }
    });

    tweetEl.addEventListener('touchend', e => {
      clearTimeout(longPressTimer);

      // åªæœ‰åœ¨æ²¡æœ‰æ»‘åŠ¨ä¸”æ²¡æœ‰é•¿æŒ‰çš„æƒ…å†µä¸‹æ‰è§¦å‘ç‚¹å‡»
      if (!isLongPressed && !hasMoved) {
        if (isMultiSelectMode) {
          toggleTweetSelection(tweet.id);
        } else {
          showTweetDetail(tweet);
        }
      }

      isLongPressed = false;
      hasMoved = false;
    });

    // æ¡Œé¢ç«¯é¼ æ ‡äº‹ä»¶ä¿æŒåŸæœ‰é€»è¾‘
    tweetEl.addEventListener('mousedown', e => {
      longPressTimer = setTimeout(() => {
        isLongPressed = true;
        toggleTweetSelection(tweet.id);
        e.preventDefault();
      }, 800);
    });

    tweetEl.addEventListener('mouseup', e => {
      clearTimeout(longPressTimer);
      if (!isLongPressed) {
        if (isMultiSelectMode) {
          toggleTweetSelection(tweet.id);
        } else {
          showTweetDetail(tweet);
        }
      }
      isLongPressed = false;
    });

    tweetEl.onclick = null; // ç§»é™¤åŸæ¥çš„ç‚¹å‡»äº‹ä»¶

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTimeForProfile(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));

      if (diffInHours < 1) {
        const diffInMinutes = Math.floor((now - date) / (1000 * 60));
        return diffInMinutes < 1 ? 'åˆšåˆš' : `${diffInMinutes}åˆ†é’Ÿ`;
      } else if (diffInHours < 24) {
        return `${diffInHours}å°æ—¶`;
      } else {
        const diffInDays = Math.floor(diffInHours / 24);
        return diffInDays === 1 ? '1å¤©' : `${diffInDays}å¤©`;
      }
    }

    // æ¸²æŸ“åª’ä½“å†…å®¹
    function renderProfileTweetMedia(tweet) {
      if (!tweet.image) return '';

      if (tweet.image.type === 'description') {
        return `
                  <div style="margin-top: 12px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 12px;">
                    <div style="color: #fff; font-size: 14px; line-height: 1.4;">${tweet.image.content}</div>
                  </div>
                `;
      } else if (tweet.image.type === 'upload') {
        return `
                  <div style="margin-top: 12px; border-radius: 12px; overflow: hidden;">
                    <img src="${tweet.image.content}" style="width: 100%; max-height: 200px; object-fit: cover; display: block;" alt="æ¨æ–‡å›¾ç‰‡">
                  </div>
                `;
      }
      return '';
    }

    // æ¸²æŸ“é“¾æ¥å†…å®¹
    function renderProfileTweetLink(tweet) {
      if (!tweet.link) return '';

      return `
                <div style="margin-top: 12px; border: 1px solid #333; border-radius: 12px; overflow: hidden;">
                  ${
                    tweet.link.thumbnail
                      ? `
                    <div style="width: 100%; height: 150px; background-color: #333;">
                      <img src="${tweet.link.thumbnail}" style="width: 100%; height: 100%; object-fit: cover;" alt="é“¾æ¥é¢„è§ˆå›¾">
                    </div>
                  `
                      : ''
                  }
                  <div style="padding: 12px;">
                    <div style="color: #71767b; font-size: 13px; margin-bottom: 4px;">${tweet.link.url || 'é“¾æ¥'}</div>
                    ${
                      tweet.link.title
                        ? `<div style="color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 4px;">${tweet.link.title}</div>`
                        : ''
                    }
                    ${
                      tweet.link.description
                        ? `<div style="color: #71767b; font-size: 13px;">${tweet.link.description}</div>`
                        : ''
                    }
                  </div>
                </div>
              `;
    }

    // æ¸²æŸ“ä¸ªäººä¸»é¡µå¼•ç”¨å†…å®¹çš„åª’ä½“ï¼ˆå›¾ç‰‡ï¼‰
    function renderProfileQuotedTweetMedia(quoted) {
      if (!quoted.image) return '';

      if (quoted.image.type === 'description') {
        return `
                  <div style="margin-top: 6px; background-color: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 6px; padding: 6px;">
                    <div style="color: #fff; font-size: 12px; line-height: 1.4;">${quoted.image.content}</div>
                  </div>
                `;
      } else if (quoted.image.type === 'upload') {
        return `
                  <div style="margin-top: 6px; border-radius: 6px; overflow: hidden;">
                    <img src="${quoted.image.content}" style="width: 100%; max-height: 80px; object-fit: cover; display: block;" alt="å¼•ç”¨å›¾ç‰‡">
                  </div>
                `;
      }

      return '';
    }

    // æ¸²æŸ“å¼•ç”¨æ¨æ–‡å†…å®¹
    function renderProfileQuotedTweet(tweet) {
      if (!tweet.quotedTweet) return '';

      const quoted = tweet.quotedTweet;
      const typeText = quoted.type === 'tweet' ? 'æ¨æ–‡' : 'è¯„è®º';

      return `
                <div style="margin-top: 12px; border: 1px solid #333; border-radius: 12px; padding: 12px; background-color: rgba(255,255,255,0.03);">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <img src="${quoted.user.avatar}" style="width: 20px; height: 20px; border-radius: 50%;" alt="${
        quoted.user.name
      }">
                    <span style="color: #fff; font-size: 13px; font-weight: 600;">${quoted.user.name}</span>
                    ${
                      quoted.user.verified
                        ? '<svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #1d9bf0;"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>'
                        : ''
                    }
                    <span style="color: #71767b; font-size: 13px;">${quoted.user.handle}</span>
                    <span style="color: #71767b; font-size: 13px;">Â·${quoted.time}</span>
                  </div>
                  <div style="color: #fff; font-size: 14px; line-height: 1.4;">${quoted.content}</div>
                  ${renderProfileQuotedTweetMedia(quoted)}
                  <div style="color: #71767b; font-size: 12px; margin-top: 8px;">å¼•ç”¨${typeText}</div>
                </div>
              `;
    }

    tweetEl.innerHTML = `
              <img class="tweet-avatar" src="${tweet.user.avatar}" alt="${tweet.user.name}">
              <div class="tweet-main">
                <div class="tweet-user-info">
                  <span class="tweet-user-name">${tweet.user.name}</span>
                  ${
                    tweet.user.verified
                      ? '<svg class="tweet-verified" viewBox="0 0 24 24"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>'
                      : ''
                  }
                  <span class="tweet-user-handle">${tweet.user.handle}</span>
                  <span class="tweet-time">Â·${formatTimeForProfile(tweet.timestamp)}</span>
                  ${
                    tweet.location
                      ? `
                    <div style="display: flex; align-items: center; gap: 4px; margin-left: 8px;">
                      <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: #1d9bf0;">
                        <g><path d="M12 7c-1.93 0-3.5 1.57-3.5 3.5S10.07 14 12 14s3.5-1.57 3.5-3.5S13.93 7 12 7zm0 5c-.827 0-1.5-.673-1.5-1.5S11.173 9 12 9s1.5.673 1.5 1.5S12.827 12 12 12zm0-10c-4.687 0-8.5 3.813-8.5 8.5 0 5.967 7.621 11.116 7.945 11.332l.555.37.555-.37C12.879 21.616 20.5 16.467 20.5 10.5 20.5 5.813 16.687 2 12 2zm0 17.77c-1.665-1.241-6.5-5.196-6.5-9.27C5.5 6.916 8.416 4 12 4s6.5 2.916 6.5 6.5c0 4.073-4.835 8.028-6.5 9.27z"></path></g>
                      </svg>
                      <span style="color: #1d9bf0; font-size: 13px;">${tweet.location}</span>
                    </div>
                  `
                      : ''
                  }
                </div>
                <div class="tweet-content">${processContent(tweet.content)}</div>
                ${renderProfileTweetMedia(tweet)}
                ${renderProfileTweetLink(tweet)}
                ${renderProfileQuotedTweet(tweet)}
                <div class="tweet-actions">
                  <div class="tweet-action comment">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g>
                    </svg>
                    <span>${DataUtils.formatNumber(tweet.stats.comments)}</span>
                  </div>
                  <div class="tweet-action retweet" onclick="handleQuoteRetweetFromData('tweet', '${tweet.id}')">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>
                    </svg>
                    <span>${DataUtils.formatNumber(tweet.stats.retweets)}</span>
                  </div>
                  <div class="tweet-action like" data-liked="false" data-likes="${tweet.stats.likes}">
                    <svg class="action-icon like-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>
                    </svg>
                    <span class="like-count">${DataUtils.formatNumber(tweet.stats.likes)}</span>
                  </div>
                  <div class="tweet-action view">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10H6v10H4zm9.248 0v-7h2v7h-2z"></path></g>
                    </svg>
                    <span>${DataUtils.formatNumber(tweet.stats.views)}</span>
                  </div>
                  <div class="tweet-action bookmark">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z"></path></g>
                    </svg>
                  </div>
                  <div class="tweet-action share">
                    <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                      <g><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.29 3.3-1.42-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"></path></g>
                    </svg>
                  </div>
                </div>
              </div>
            `;

    return tweetEl;
  }

  // åˆ·æ–°ä¸ªäººé¡µé¢çš„æ¨æ–‡æ˜¾ç¤ºï¼ˆç”¨äºAIå›å¤ååŒæ­¥æ•°æ®ï¼‰
  function refreshUserProfileTweets() {
    const container = document.getElementById('x-profile-tweets-container');
    if (container && container.parentElement.style.display !== 'none') {
      loadUserProfileTweets();
    }
  }

  // æ›´æ–°æ¨æ–‡è¯¦æƒ…é¡µé¢çš„AIæ•°æ®
  async function updateTweetDetailWithAI(tweetId, interactionData, isReroll = false) {
    // ä½¿ç”¨IDç²¾ç¡®æ›´æ–°å…ƒç´ 

    // æ›´æ–°äº’åŠ¨æ•°æ®æ˜¾ç¤ºåŒºåŸŸ
    const statsDiv = document.getElementById('tweet-detail-stats');
    if (statsDiv) {
      statsDiv.innerHTML = `
                 <div style="display: flex; align-items: center; gap: 4px;">
                   <span style="color: #fff; font-weight: 700; font-size: 15px;">${formatNumber(
                     interactionData.stats.retweets,
                   )}</span>
                   <span style="color: #71767b; font-size: 15px;">è½¬æ¨</span>
                 </div>
                 <div style="display: flex; align-items: center; gap: 4px;">
                   <span style="color: #fff; font-weight: 700; font-size: 15px;">${formatNumber(
                     interactionData.stats.likes,
                   )}</span>
                   <span style="color: #71767b; font-size: 15px;">å–œæ¬¢</span>
                 </div>
                 <div style="display: flex; align-items: center; gap: 4px;">
                   <span style="color: #fff; font-weight: 700; font-size: 15px;">${formatNumber(
                     interactionData.stats.comments,
                   )}</span>
                   <span style="color: #71767b; font-size: 15px;">ä¹¦ç­¾</span>
                 </div>
               `;
    }

    // æ›´æ–°æŸ¥çœ‹æ•°æ®
    const viewElement = document.getElementById('tweet-detail-views');
    if (viewElement) {
      viewElement.textContent = `${formatNumber(interactionData.stats.views)} æŸ¥çœ‹`;
    }

    // æ·»åŠ AIç”Ÿæˆçš„è¯„è®º
    const commentsContainer = document.getElementById('detail-comments-container');

    // å¦‚æœæ˜¯é‡å›ï¼Œæ¸…é™¤ç°æœ‰è¯„è®º
    if (isReroll && commentsContainer) {
      commentsContainer.innerHTML = '';
    }
    if (commentsContainer && interactionData.comments.length > 0) {
      interactionData.comments.forEach(comment => {
        // åˆ›å»ºè¯„è®ºç»„å®¹å™¨
        const commentGroup = document.createElement('div');
        commentGroup.style.cssText = 'position: relative;';

        // æ·»åŠ ä¸»è¯„è®º
        const commentElement = createCommentElement(comment);

        // å¦‚æœæœ‰å›å¤ï¼Œç»™ä¸»è¯„è®ºæ·»åŠ ç‰¹æ®Šç±»
        if (comment.replies && comment.replies.length > 0) {
          commentElement.classList.add('has-replies');
        }

        commentGroup.appendChild(commentElement);

        // æ¸²æŸ“å›å¤
        if (comment.replies && comment.replies.length > 0) {
          comment.replies.forEach(reply => {
            const replyElement = createCommentElement(reply, true);
            commentGroup.appendChild(replyElement);
          });
        }

        commentsContainer.appendChild(commentGroup);
      });
    }

    // æ›´æ–°å­˜å‚¨çš„æ¨æ–‡æ•°æ®
    await updateStoredTweetData(tweetId, interactionData);
  }

  // æ›´æ–°å­˜å‚¨çš„æ¨æ–‡æ•°æ®ï¼ˆåŒ…å«AIç”Ÿæˆçš„äº’åŠ¨æ•°æ®å’Œè¯„è®ºï¼‰
  async function updateStoredTweetData(tweetId, interactionData) {
    try {
      const db = getXDB();

      // ä½¿ç”¨æ­£ç¡®çš„è´¦æˆ·IDè·å–ç”¨æˆ·æ¨æ–‡æ•°æ®
      const accountTweetsId = `userTweets_${currentAccountId || 'main'}`;
      let userTweets = await db.xUserTweets.get(accountTweetsId);

      if (!userTweets) {
        console.warn('æœªæ‰¾åˆ°ç”¨æˆ·æ¨æ–‡æ•°æ®ï¼Œè´¦æˆ·ID:', accountTweetsId);
        return;
      }

      // æŸ¥æ‰¾å¹¶æ›´æ–°å¯¹åº”çš„æ¨æ–‡
      const tweetIndex = userTweets.tweets.findIndex(tweet => tweet.id === tweetId);
      if (tweetIndex !== -1) {
        // æ›´æ–°äº’åŠ¨æ•°æ®
        userTweets.tweets[tweetIndex].stats = {
          ...userTweets.tweets[tweetIndex].stats,
          ...interactionData.stats,
        };

        // æ›´æ–°è¯„è®ºæ•°æ®
        userTweets.tweets[tweetIndex].comments = interactionData.comments || [];

        // ä¿å­˜æ›´æ–°åçš„æ•°æ®
        await db.xUserTweets.put(userTweets);

        // åŒæ—¶æ›´æ–° sessionStorage ä¸­çš„å½“å‰æ¨æ–‡æ•°æ®
        const currentTweetData = sessionStorage.getItem('currentTweetData');
        if (currentTweetData) {
          try {
            const currentTweet = JSON.parse(currentTweetData);
            if (currentTweet.id === tweetId) {
              currentTweet.stats = userTweets.tweets[tweetIndex].stats;
              currentTweet.comments = userTweets.tweets[tweetIndex].comments;
              sessionStorage.setItem('currentTweetData', JSON.stringify(currentTweet));
            }
          } catch (e) {
            console.warn('æ›´æ–° sessionStorage å¤±è´¥:', e);
          }
        }

        console.log('âœ… æ¨æ–‡AIååº”å·²ä¿å­˜åˆ°æ•°æ®åº“:', tweetId, 'è´¦æˆ·:', accountTweetsId);

        // åˆ·æ–°ä¸ªäººé¡µé¢æ˜¾ç¤º
        refreshUserProfileTweets();
      } else {
        console.warn('âš ï¸ æœªæ‰¾åˆ°è¦æ›´æ–°çš„æ¨æ–‡:', tweetId);
      }
    } catch (error) {
      console.error('âŒ æ›´æ–°å­˜å‚¨æ¨æ–‡æ•°æ®å¤±è´¥:', error);
    }
  }

  // â–¼â–¼â–¼ ã€ä¸»è¦ï¼ï¼ï¼ã€‘ç¬¬ä¸‰ä¸ªæƒ…æ™¯ï¼šç»Ÿä¸€AIå›å¤ç”Ÿæˆå™¨â–¼â–¼â–¼
  async function generateUnifiedAIResponse(tweetData, userComment, options = {}) {
    try {
      const {
        isOwnPost = false,
        commentType = 'main_comment', // 'main_comment' | 'reply_comment'
        pageType = 'detail', // 'detail' | 'main'
        parentComment = null,
        mainCommentId = null, // ç”¨äºæ¥¼ä¸­æ¥¼å›å¤çš„ä¸»è¯„è®ºID
      } = options;

      // ä»æ•°æ®åº“è¯»å–APIé…ç½®
      const db = getDB(); // ç”¨äºè®¿é—®APIé…ç½®
      const xDb = getXDB(); // ç”¨äºè®¿é—®Xä¸“ç”¨è®¾ç½®

      const apiConfig = await db.apiConfig.get('main');
      if (!apiConfig || !apiConfig.proxyUrl || !apiConfig.apiKey || !apiConfig.model) {
        showXToast('è¯·å…ˆé…ç½®APIè®¾ç½®', 'error');
        return;
      }

      const { proxyUrl, apiKey, model } = apiConfig;

      // ä»Xè®¾ç½®ä¸­è¯»å–é…ç½®ï¼ˆæŒ‰è´¦å·è¯»å–ï¼‰
      const settingsId = `xSettings_${currentAccountId || 'main'}`;
      const xSettings = await xDb.xSettings.get(settingsId);
      const userPrompt = xSettings?.systemPrompt || '';
      const worldSetting = xSettings?.worldSetting || '';
      const boundCharacters = xSettings?.boundCharacters || [];

      // ä½¿ç”¨å·¥å…·å‡½æ•°æ„å»ºç”¨æˆ·Xä¸ªäººèµ„æ–™ä¿¡æ¯ï¼ˆä½¿ç”¨window.userProfileDataç¡®ä¿è·å–æœ€æ–°æ•°æ®ï¼‰
      const userXProfileInfo = StringBuilders.buildUserXProfileInfo(window.userProfileData);

      // 1. æç¤ºè¯ + ä¸–ç•Œä¹¦
      let systemPrompt = StringBuilders.buildBaseSystemPrompt({
        userPrompt,
        worldSetting,
      });

      // 2. è§’è‰²å®šä¹‰ï¼ˆè¯„è®ºå›å¤ç”Ÿæˆä¸“ç”¨ï¼‰
      systemPrompt += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš« æ ¸å¿ƒä»»åŠ¡è¯´æ˜ ğŸš«
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä½ æ˜¯Xç¤¾äº¤å¹³å°çš„äº’åŠ¨ç”Ÿæˆå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼š
âœ… ä¸ºç”¨æˆ·çš„è¯„è®ºç”Ÿæˆå…¶ä»–äººçš„å›åº”/ååº”
âŒ ç»å¯¹ä¸èƒ½å†ç”Ÿæˆç”¨æˆ·æœ¬äººçš„è¯„è®ºæˆ–å›å¤

**æ˜ç¡®ï¼šç”¨æˆ·å·²ç»å‘è¡¨äº†è¯„è®ºï¼Œä½ åªè´Ÿè´£ç”Ÿæˆåˆ«äººå¯¹è¿™æ¡è¯„è®ºçš„ååº”ï¼**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;

      // æ·»åŠ åœºæ™¯åˆ†æ”¯æç¤ºè¯ï¼ˆè¯„è®ºåœºæ™¯ç‰¹æœ‰çš„è¯¦ç»†é€»è¾‘ï¼‰
      systemPrompt += StringBuilders.buildScenarioPrompt({
        isOwnPost,
        commentType,
        pageType,
        parentComment,
      });

      // 3. è§’è‰²èµ„æ–™ï¼ˆå›å¤åœºæ™¯ï¼‰
      const charactersInfo = await StringBuilders.buildCompleteCharacterInfo(
        boundCharacters,
        userXProfileInfo,
        'reply',
      );
      if (charactersInfo) {
        systemPrompt += charactersInfo;
      }

      // 4. ç”¨æˆ·èµ„æ–™
      systemPrompt += StringBuilders.buildUniversalConstraints(userXProfileInfo);

      systemPrompt += `

ã€è¯„è®ºå›å¤è¦æ±‚ã€‘ï¼š
- ç”Ÿæˆ1-5æ¡å›å¤ï¼Œå†…å®¹å¤šæ ·åŒ–ï¼ˆç®€çŸ­/æ·±åº¦/è¡¨æƒ…ç¬¦å·ï¼‰
- ç¯å¢ƒè´´åˆï¼šå‚è€ƒè¯„è®ºåŒºç°æœ‰è®¨è®ºï¼ŒåŸºäºä¸»é¢˜å’Œæ°›å›´ç”Ÿæˆè´´åˆå›å¤
- å›å¤å†…å®¹å¿…é¡»å›´ç»•æ¨æ–‡ä¸»é¢˜å’Œç”¨æˆ·è¯„è®ºå†…å®¹ï¼Œä¸è¦åç¦»ä¸»é¢˜

${
  boundCharacters.length > 0
    ? `**è§’è‰²å›å¤è¦ç‚¹**ï¼šæ ¹æ®è®¾å®šåˆ¤æ–­æ˜¯å¦é€‚åˆå‘è¨€ï¼Œç¬¦åˆäººè®¾ç‰¹ç‚¹ï¼Œå¯ç”Ÿæˆ0-2ä¸ªè§’è‰²å›å¤ï¼Œä¸¥æ ¼ä½¿ç”¨è§’è‰²Xèµ„æ–™ä¿¡æ¯ã€‚`
    : '**å½“å‰çŠ¶æ€**ï¼šæ— ç»‘å®šè§’è‰²ï¼Œç”Ÿæˆæ™®é€šç”¨æˆ·å›å¤ã€‚'
}

ã€æƒ…ä¾£è§’è‰²å›å¤è§„åˆ™ã€‘ï¼š
${
  userXProfileInfo.verificationType === 'couple' && userXProfileInfo.coupleCharacterName
    ? `- ç”¨æˆ·çš„æƒ…ä¾£æ˜¯ ${userXProfileInfo.coupleCharacterName}
- **å…³é”®é™åˆ¶**ï¼šåœ¨ä»–äººå¸–å­ä¸‹å›å¤ç”¨æˆ·è¯„è®ºæ—¶ï¼Œå‡ºç°æ¦‚ç‡æä½ï¼ˆ5-15%ï¼‰
  * è¯„è®ºä¸æƒ…ä¾£è§’è‰²æ— å…³ â†’ ä¸å‡ºç°
  * è¯é¢˜æ™®é€š/æ—¥å¸¸ â†’ å¾ˆå°‘å‡ºç°
  * åªæœ‰è¯„è®ºå†…å®¹ä¸æƒ…ä¾£è§’è‰²ç›¸å…³ã€æˆ–ç¡®æœ‰ç†ç”±å‚ä¸è®¨è®ºæ—¶æ‰å¯èƒ½å‡ºç°
- å›å¤å›´ç»•å¸–å­ä¸»é¢˜å’Œè®¨è®ºï¼Œä¸åªæ˜¯"ç§€æ©çˆ±"
- ç²‰ä¸ç¾¤ä½“ä¸¥æ ¼é™åˆ¶ï¼šä»…å½“åŒæ–¹ä¸ºæ˜æ˜Ÿ/ç½‘çº¢/å…¬ä¼—äººç‰©æ—¶æ‰å¯èƒ½æœ‰1æ¡CPç²‰ä¸è¯„è®ºï¼ˆæ¦‚ç‡æä½ï¼‰ï¼Œæ™®é€šæƒ…ä¾£ç»æ— "ç£•å­¦å®¶""CPç²‰"ç­‰ç²‰ä¸ç¾¤ä½“`
    : ''
}

ã€JSONè¿”å›æ ¼å¼ã€‘ï¼š
\`\`\`json
{
  "${commentType === 'reply_comment' && pageType === 'main' ? 'replies' : 'comments'}": [å›å¤æ•°ç»„]
}
\`\`\`

å›å¤å¯¹è±¡ç»“æ„ï¼š
- user: {name, handle, avatar, verified}
- content: å›å¤æ–‡æœ¬
- time: æ—¶é—´æè¿°
- replyTo: "${commentType === 'reply_comment' && parentComment ? parentComment.user.handle : userComment.user.handle}"
- replies: []

å…³é”®è§„åˆ™ï¼š
1. verifiedå­—æ®µå¿…é¡»æ˜¯å¸ƒå°”å€¼(true/false)
2. ${
        boundCharacters.length > 0
          ? 'ç”Ÿæˆè§’è‰²å›å¤æ—¶å¿…é¡»ä¸¥æ ¼ä½¿ç”¨æä¾›çš„è§’è‰²Xèµ„æ–™(xNameã€xHandleã€xAvatarã€xVerified)ï¼Œä¸å¾—ä½¿ç”¨é»˜è®¤å€¼æˆ–è‡ªç¼–ä¿¡æ¯'
          : 'æ™®é€šç”¨æˆ·å›å¤ï¼Œè‡ªåˆ›ç”¨æˆ·åå’Œå¥æŸ„'
      }`;

      // æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯
      let contextInfo = `ã€æ¨æ–‡ä¿¡æ¯${pageType === 'detail' ? 'ï¼ˆè¯¦æƒ…é¡µï¼‰' : 'ï¼ˆä¸»é¡µï¼‰'}ã€‘
æ ‡é¢˜ï¼š${isOwnPost ? 'ã€ç”¨æˆ·çš„å¸–å­ã€‘' : ''}${tweetData.content}
æ¨æ–‡ä½œè€…ï¼š${tweetData.user.name} (${tweetData.user.handle})
${tweetData.location ? `ä½ç½®ï¼š${tweetData.location}` : ''}
${tweetData.link ? `é“¾æ¥ï¼š${tweetData.link.title || tweetData.link.url}` : ''}
${tweetData.media && tweetData.media.length > 0 ? `åª’ä½“ï¼š${tweetData.media[0].description}` : ''}`;

      // å¦‚æœæ¨æ–‡åŒ…å«å¼•ç”¨å†…å®¹ï¼Œæ·»åŠ å¼•ç”¨ä¿¡æ¯
      if (tweetData.quotedTweet) {
        const quoted = tweetData.quotedTweet;
        const quotedType = quoted.type === 'tweet' ? 'æ¨æ–‡' : 'è¯„è®º';
        contextInfo += `

ã€è¯¥æ¨æ–‡å¼•ç”¨äº†ä»¥ä¸‹${quotedType}ã€‘
åŸä½œè€…ï¼š${quoted.user.name} (${quoted.user.handle})${quoted.user.verified ? ' âœ“å·²è®¤è¯' : ''}
å‘å¸ƒæ—¶é—´ï¼š${quoted.time}
åŸå†…å®¹ï¼š"${quoted.content}"`;

        // å¦‚æœå¼•ç”¨å†…å®¹åŒ…å«å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡ä¿¡æ¯
        if (quoted.image) {
          if (quoted.image.type === 'description') {
            contextInfo += `
åŸå›¾ç‰‡æè¿°ï¼š${quoted.image.content}`;
          } else if (quoted.image.type === 'upload') {
            contextInfo += `
åŸå›¾ç‰‡ï¼šåŒ…å«ä¸Šä¼ çš„å›¾ç‰‡å†…å®¹`;
          }
        }

        // å¦‚æœå¼•ç”¨å†…å®¹åŒ…å«ä½ç½®ä¿¡æ¯
        if (quoted.location) {
          contextInfo += `
åŸä½ç½®ï¼š${quoted.location}`;
        }

        contextInfo += `

æ³¨æ„ï¼šè¿™æ˜¯å¼•ç”¨è½¬å‘ï¼Œç”¨æˆ·çš„è¯„è®ºæ˜¯å¯¹ä¸Šè¿°${quotedType}çš„å›åº”/è¯„è®ºã€‚å›å¤æ—¶å¯ä»¥åŒæ—¶è€ƒè™‘ç”¨æˆ·çš„è¯„è®ºå’Œè¢«å¼•ç”¨çš„åŸå†…å®¹ï¼Œå¯ä»¥è®¨è®ºå¼•ç”¨å…³ç³»ã€åŸä½œè€…è§‚ç‚¹ï¼Œæˆ–ç”¨æˆ·çš„è½¬å‘è¯„è®ºç­‰ã€‚`;
      }

      contextInfo += `

ã€ç”¨æˆ·å‘è¡¨çš„${commentType === 'main_comment' ? 'è¯„è®º' : 'å›å¤'}ã€‘
ç”¨æˆ·åï¼š${userComment.user.name}
ç”¨æˆ·å¥æŸ„ï¼š${userComment.user.handle}
${commentType === 'main_comment' ? 'è¯„è®º' : 'å›å¤'}å†…å®¹ï¼š${userComment.content}`;

      if (commentType === 'reply_comment' && parentComment) {
        contextInfo += `

ã€è¢«å›å¤çš„è¯„è®ºã€‘
ç”¨æˆ·åï¼š${parentComment.user.name}
ç”¨æˆ·å¥æŸ„ï¼š${parentComment.user.handle}
è¯„è®ºå†…å®¹ï¼š${parentComment.content}`;
      }

      // æ·»åŠ å·²æœ‰è¯„è®ºåŒºå†…å®¹åˆ°ä¸Šä¸‹æ–‡
      if (tweetData.comments && tweetData.comments.length > 0) {
        contextInfo += `

ã€å½“å‰è¯„è®ºåŒºå†…å®¹ã€‘ï¼ˆå…±${tweetData.comments.length}æ¡è¯„è®ºï¼Œå¸®åŠ©ç†è§£è®¨è®ºä¸»é¢˜å’Œæ°›å›´ï¼‰`;

        // æ˜¾ç¤ºæœ€å¤šå‰10æ¡è¯„è®ºï¼Œé¿å…ä¸Šä¸‹æ–‡è¿‡é•¿
        const displayComments = tweetData.comments.slice(0, 10);
        displayComments.forEach((comment, index) => {
          contextInfo += `
${index + 1}. ${comment.user.name} (${comment.user.handle}): ${comment.content}`;

          // å¦‚æœæœ‰å›å¤ï¼Œä¹Ÿæ˜¾ç¤ºå‰3æ¡
          if (comment.replies && comment.replies.length > 0) {
            const displayReplies = comment.replies.slice(0, 3);
            displayReplies.forEach((reply, replyIndex) => {
              contextInfo += `
   â””â”€ ${reply.user.name} (${reply.user.handle}): ${reply.content}`;
            });

            if (comment.replies.length > 3) {
              contextInfo += `
   â””â”€ ...è¿˜æœ‰${comment.replies.length - 3}æ¡å›å¤`;
            }
          }
        });

        if (tweetData.comments.length > 10) {
          contextInfo += `
...è¿˜æœ‰${tweetData.comments.length - 10}æ¡è¯„è®ºæœªæ˜¾ç¤º`;
        }
      }

      // æŸ¥æ‰¾æ¨æ–‡ä½œè€…æ˜¯å¦ä¸ºç»‘å®šè§’è‰²ï¼ˆå¦‚æœæœ‰ç»‘å®šè§’è‰²çš„è¯ï¼‰
      if (boundCharacters.length > 0) {
        // è·å–ç»‘å®šè§’è‰²ä¿¡æ¯ç”¨äºæŸ¥æ‰¾æ¨æ–‡ä½œè€…
        const mainDB = getDB(); // ç”¨äºè®¿é—® chats è¡¨
        const xDB = getXDB(); // ç”¨äºè®¿é—® xCharacterProfiles è¡¨
        const allChats = await mainDB.chats.toArray();
        const boundCharsData = allChats.filter(chat => !chat.isGroup && boundCharacters.includes(chat.id));

        if (boundCharsData.length > 0) {
          // è·å–Xèµ„æ–™ç”¨äºåŒ¹é…æ¨æ–‡ä½œè€…
          const allXProfiles = await xDB.xCharacterProfiles.toArray();
          const tweetAuthorCharacter = allXProfiles.find(
            xProfile => xProfile.xName === tweetData.user.name || xProfile.xHandle === tweetData.user.handle,
          );

          if (
            tweetAuthorCharacter &&
            tweetAuthorCharacter.relationships &&
            tweetAuthorCharacter.relationships.length > 0
          ) {
            contextInfo += `

ã€æ¨æ–‡ä½œè€…çš„å·²çŸ¥å…³ç³»ã€‘
æ¨æ–‡ä½œè€…ï¼š${tweetAuthorCharacter.xName}
å…³ç³»ç½‘ç»œï¼š
${tweetAuthorCharacter.relationships
  .map(
    rel =>
      `- ${rel.npcName} (${rel.npcHandle}): ${rel.relationshipType}${rel.description ? ' | ' + rel.description : ''}`,
  )
  .join('\n')}

æ³¨æ„ï¼šå¦‚æœç”Ÿæˆè¿™äº›NPCçš„å›å¤ï¼Œè¯·æ ¹æ®ä¸æ¨æ–‡ä½œè€…çš„å…³ç³»ç‰¹ç‚¹æ¥è°ƒæ•´äº’åŠ¨é£æ ¼ã€‚`;
          }
        }
      }

      // æ„å»ºæ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒå›¾ç‰‡è¯†åˆ«
      const messageContent = [];
      messageContent.push({ type: 'text', text: contextInfo });

      // å¦‚æœç”¨æˆ·è¯„è®ºåŒ…å«ä¸Šä¼ çš„å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡å†…å®¹
      if (userComment.image && userComment.image.type === 'upload' && userComment.image.content) {
        messageContent.push({
          type: 'image_url',
          image_url: { url: userComment.image.content },
        });
      } else if (userComment.image && userComment.image.type === 'description') {
        messageContent.push({
          type: 'text',
          text: `ç”¨æˆ·è¯„è®ºé™„å¸¦çš„å›¾ç‰‡æè¿°ï¼š${userComment.image.content}`,
        });
      }

      const messages = [{ role: 'user', content: messageContent }];

      // APIè°ƒç”¨
      let isGemini = proxyUrl.includes('generativelanguage');
      let response;

      if (isGemini) {
        // ä¸ºXç¤¾äº¤é¡µé¢åˆ›å»ºæ­£ç¡®çš„Geminiè¯·æ±‚é…ç½®
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
        const geminiConfig = {
          url: `${GEMINI_API_URL}/${model}:generateContent?key=${getRandomValue(apiKey)}`,
          data: {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text:
                        systemPrompt +
                        '\n\n' +
                        messages
                          .map(m =>
                            Array.isArray(m.content) ? m.content.map(c => c.text || '[å›¾ç‰‡]').join(' ') : m.content,
                          )
                          .join('\n'),
                    },
                  ],
                },
              ],
              generationConfig: {
                temperature: 0.8,
              },
            }),
          },
        };
        response = await fetch(geminiConfig.url, geminiConfig.data);
      } else {
        const openAiPayload = {
          model: model,
          messages: [{ role: 'system', content: systemPrompt }, ...messages],
          temperature: 0.8,
          stream: false,
        };
        response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify(openAiPayload),
        });
      }

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`APIé”™è¯¯: ${response.status} - ${errorData.error?.message || response.statusText}`);
      }

      const data = await response.json();
      let aiResponseContent = isGemini ? getGeminiResponseText(data) : data.choices?.[0]?.message?.content || '';

      console.log('ç»Ÿä¸€AIåŸå§‹å“åº”:', aiResponseContent);
      console.log('ç»‘å®šè§’è‰²æ•°é‡:', boundCharacters.length);
      console.log('è¯„è®ºåŒºä¸Šä¸‹æ–‡:', tweetData.comments ? `${tweetData.comments.length}æ¡è¯„è®º` : 'æ— è¯„è®º');
      if (tweetData.comments && tweetData.comments.length > 0) {
        console.log(
          'è¯„è®ºç¤ºä¾‹:',
          tweetData.comments.slice(0, 3).map(c => `${c.user.name}: ${c.content.substring(0, 50)}...`),
        );
      }

      // è§£æAIè¿”å›çš„JSONæ•°æ®
      const cleanedResponse = aiResponseContent
        .replace(/```json\s*/, '')
        .replace(/```\s*$/, '')
        .trim();
      if (!cleanedResponse) throw new Error('AIè¿”å›äº†ç©ºçš„å“åº”å†…å®¹');

      let replyData;
      try {
        replyData = JSON.parse(cleanedResponse);
      } catch (parseError) {
        console.error('JSONè§£æå¤±è´¥:', parseError);
        console.error('å°è¯•è§£æçš„å†…å®¹:', cleanedResponse);
        throw new Error(`AIè¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼: ${parseError.message}`);
      }

      // ç»Ÿä¸€æ•°æ®å¤„ç†
      const timestamp = Date.now();
      const repliesKey = commentType === 'reply_comment' && pageType === 'main' ? 'replies' : 'comments';
      const replies = replyData[repliesKey] || [];

      if (!Array.isArray(replies)) {
        throw new Error('AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
      }

      // æ ¹æ®é¡µé¢ç±»å‹å’Œè¯„è®ºç±»å‹å¤„ç†æ¸²æŸ“
      if (pageType === 'detail') {
        // è¯¦æƒ…é¡µé¢ï¼šç›´æ¥æ¸²æŸ“åˆ°é¡µé¢ - ä¿®å¤æ¥¼ä¸­æ¥¼å¹³çº§å›å¤æ’å…¥é€»è¾‘
        replies.forEach((comment, index) => {
          comment.id = `ai_unified_${timestamp}_${index}`;
          const commentElement = createCommentElement(comment, commentType === 'reply_comment');
          const commentsContainer = document.getElementById('detail-comments-container');

          if (commentType === 'reply_comment' && parentComment) {
            // å¯¹äºæ¥¼ä¸­æ¥¼å›å¤ï¼Œæ‰¾åˆ°è¢«å›å¤è¯„è®ºçš„ä½ç½®ï¼Œæ’å…¥ä¸ºå¹³çº§
            const allComments = commentsContainer.querySelectorAll('.comment-item');
            let insertPosition = null;
            let insertAfter = null;

            // æ‰¾åˆ°è¢«å›å¤è¯„è®ºçš„ä½ç½®
            allComments.forEach(commentEl => {
              if (commentEl.dataset.commentId === parentComment.id) {
                insertPosition = commentEl;

                // å¦‚æœè¢«å›å¤çš„æ˜¯æ¥¼ä¸­æ¥¼è¯„è®ºï¼Œæ‰¾åˆ°è¿™ä¸ªè¯„è®ºç»„çš„æœ€åä¸€ä¸ªè¯„è®º
                if (commentEl.classList.contains('reply-item')) {
                  let nextSibling = commentEl.nextElementSibling;
                  insertAfter = commentEl;

                  // æ‰¾åˆ°å½“å‰è¯„è®ºç»„çš„æœ€åä¸€æ¡è¯„è®º
                  while (nextSibling && nextSibling.classList.contains('reply-item')) {
                    insertAfter = nextSibling;
                    nextSibling = nextSibling.nextElementSibling;
                  }
                } else {
                  // å¦‚æœè¢«å›å¤çš„æ˜¯ä¸»è¯„è®ºï¼Œæ‰¾åˆ°è¿™ä¸ªè¯„è®ºç»„çš„æœ€åä¸€æ¡è¯„è®ºï¼ˆåŒ…æ‹¬æ‰€æœ‰æ¥¼ä¸­æ¥¼ï¼‰
                  let nextSibling = commentEl.nextElementSibling;
                  insertAfter = commentEl;

                  while (nextSibling && nextSibling.classList.contains('reply-item')) {
                    insertAfter = nextSibling;
                    nextSibling = nextSibling.nextElementSibling;
                  }
                }
              }
            });

            if (insertAfter) {
              // æ’å…¥åˆ°è¯„è®ºç»„çš„æœ€åä½ç½®
              if (insertAfter.nextSibling) {
                insertAfter.parentNode.insertBefore(commentElement, insertAfter.nextSibling);
              } else {
                insertAfter.parentNode.appendChild(commentElement);
              }
            } else {
              // å¦‚æœæ²¡æ‰¾åˆ°ä½ç½®ï¼Œå°±æ·»åŠ åˆ°æœ«å°¾
              commentsContainer.appendChild(commentElement);
            }
          } else {
            // ä¸»è¯„è®ºå›å¤æˆ–æ‰¾ä¸åˆ°ç‰¹å®šä½ç½®æ—¶ï¼Œæ·»åŠ åˆ°æœ«å°¾
            commentsContainer.appendChild(commentElement);
          }
        });

        // æ›´æ–°å›å¤è¾“å…¥æ¡†å¤´åƒ
        const replyUserAvatars = document.querySelectorAll('.reply-user-avatar');
        replyUserAvatars.forEach(avatar => {
          avatar.src = userProfileData.avatar;
        });
      } else {
        // ä¸»é¡µï¼šæ›´æ–°æ•°æ®å¹¶é‡æ–°æ¸²æŸ“
        if (commentType === 'main_comment') {
          // ä¸»è¯„è®ºï¼šæ·»åŠ åˆ°æ¨æ–‡è¯„è®ºåˆ—è¡¨
          replies.forEach((comment, index) => {
            comment.id = `ai_main_unified_${timestamp}_${index}`;
            tweetData.comments.push(comment);
          });
          tweetData.stats.comments += replies.length;
        } else {
          // æ¥¼ä¸­æ¥¼å›å¤ï¼šæ·»åŠ åˆ°ä¸»è¯„è®ºçš„repliesï¼ˆå¹³çº§æ˜¾ç¤ºï¼‰
          const targetCommentId = mainCommentId || parentComment.id;
          const mainCommentObj = tweetData.comments.find(c => c.id === targetCommentId);
          if (mainCommentObj) {
            replies.forEach((reply, index) => {
              reply.id = `ai_main_sub_unified_${timestamp}_${index}`;
              if (!mainCommentObj.replies) mainCommentObj.replies = [];
              mainCommentObj.replies.push(reply);
            });
          } else {
            console.warn('æ— æ³•æ‰¾åˆ°ä¸»è¯„è®ºï¼ŒmainCommentId:', targetCommentId);
          }
        }

        // ä¿å­˜æ•°æ®å¹¶é‡æ–°æ¸²æŸ“ - å…ˆä»æ•°æ®åº“é‡æ–°åŠ è½½æ•°æ®ä»¥é¿å…è¦†ç›–ç”¨æˆ·è¯„è®º
        try {
          const existingData = await xDb.xTweetsData.get('tweets');
          if (existingData) {
            // æ›´æ–°ç°æœ‰æ•°æ®è€Œä¸æ˜¯å®Œå…¨è¦†ç›–
            existingData.forYouTweets = forYouTweets;
            existingData.followingTweets = followingTweets;
            existingData.lastUpdated = new Date().toISOString();
            await xDb.xTweetsData.put(existingData);
          } else {
            await xDb.xTweetsData.put({
              id: 'tweets',
              forYouTweets: forYouTweets,
              followingTweets: followingTweets,
              lastUpdated: new Date().toISOString(),
            });
          }
        } catch (saveError) {
          console.error('ä¿å­˜ç»Ÿä¸€AIå›å¤æ•°æ®å¤±è´¥:', saveError);
        }

        renderComments(currentTweetId);

        // æ»šåŠ¨åˆ°åº•éƒ¨
        const commentsContainer = document.querySelector('.comments-container');
        setTimeout(() => {
          commentsContainer.scrollTop = commentsContainer.scrollHeight;
        }, 100);
      }

      showXToast('ä½ çš„è¯„è®ºå·²ç»æ”¶åˆ°å›å¤!', 'success');
    } catch (error) {
      console.error('ç”Ÿæˆç»Ÿä¸€AIå›å¤å¤±è´¥:', error);
      showXToast(`å›å¤ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
    }
  }
  // æ³¨æ„ï¼šå·²åˆ é™¤é‡å¤çš„APIè¾…åŠ©å‡½æ•°å®šä¹‰ï¼Œä½¿ç”¨æ–‡ä»¶å¼€å¤´çš„å¥å£®ç‰ˆæœ¬

  // â–²â–²â–² ã€ä¸»è¦ï¼ï¼ï¼ã€‘ç¬¬ä¸‰ä¸ªæƒ…æ™¯ï¼šç»Ÿä¸€AIå›å¤ç”Ÿæˆå™¨ â–²â–²â–²

  // â–²â–²â–²ï¼ï¼ï¼ä¸‰ä¸ªæƒ…æ™¯ç»¼åˆå¦‚ä¸Šï¼ï¼ï¼â–²â–²â–²

  //â–¼â–¼â–¼ å¼•ç”¨è½¬å‘åŠŸèƒ½JavaScriptâ–¼â–¼â–¼

  // å…¨å±€å˜é‡å­˜å‚¨å½“å‰å¼•ç”¨å†…å®¹
  let currentQuoteData = null;

  // ä»æ•°æ®æºè·å–å¼•ç”¨ä¿¡æ¯å¹¶å¤„ç†è½¬å‘
  async function handleQuoteRetweetFromData(type, id) {
    let sourceData = null;

    if (type === 'tweet') {
      // ä»ä¸»é¡µæ¨æ–‡æ•°æ®ä¸­æŸ¥æ‰¾
      const allTweets = [...forYouTweets, ...followingTweets];
      sourceData = allTweets.find(tweet => tweet.id === id);

      // å¦‚æœåœ¨ä¸»é¡µæ²¡æ‰¾åˆ°ï¼ŒæŸ¥æ‰¾ç”¨æˆ·æ¨æ–‡
      if (!sourceData) {
        try {
          const db = getXDB();

          const userTweets = await db.xUserTweets.get('userTweets');
          if (userTweets && userTweets.tweets) {
            sourceData = userTweets.tweets.find(tweet => tweet.id === id);
          }
        } catch (error) {
          console.error('æŸ¥æ‰¾ç”¨æˆ·æ¨æ–‡å¤±è´¥:', error);
        }
      }

      // å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œå°è¯•ä»è¯¦æƒ…é¡µå½“å‰æ¨æ–‡ä¸­æŸ¥æ‰¾
      if (!sourceData) {
        const currentTweetData = sessionStorage.getItem('currentTweetData');
        if (currentTweetData) {
          try {
            const tweetData = JSON.parse(currentTweetData);
            if (tweetData.id === id) {
              sourceData = tweetData;
            }
          } catch (error) {
            console.error('è§£æè¯¦æƒ…é¡µæ¨æ–‡æ•°æ®å¤±è´¥:', error);
          }
        }
      }
    } else if (type === 'comment') {
      // ä»è¯„è®ºæ•°æ®ä¸­æŸ¥æ‰¾
      sourceData = await findCommentById(id);
    }

    if (!sourceData) {
      showXToast('æ— æ³•æ‰¾åˆ°è¦å¼•ç”¨çš„å†…å®¹', 'error');
      return;
    }

    // å¤„ç†å›¾ç‰‡æ•°æ®ï¼ˆä»mediaå­—æ®µè½¬æ¢ä¸ºimageæ ¼å¼ï¼‰
    let imageData = null;
    if (sourceData.media && sourceData.media.length > 0 && sourceData.media[0].type === 'image') {
      imageData = {
        type: 'description',
        content: sourceData.media[0].description,
      };
    } else if (sourceData.image) {
      // å…¼å®¹å·²æœ‰çš„imageå­—æ®µæ ¼å¼
      imageData = sourceData.image;
    }

    // è°ƒç”¨å¼•ç”¨å¤„ç†å‡½æ•°
    handleQuoteRetweet(
      type,
      id,
      sourceData.user.name,
      sourceData.user.handle,
      sourceData.user.avatar,
      sourceData.user.verified,
      sourceData.content || '',
      sourceData.time,
      imageData, // ä¼ é€’å›¾ç‰‡æ•°æ®
      sourceData.link || null, // ä¼ é€’é“¾æ¥æ•°æ®
      sourceData.location || null, // ä¼ é€’ä½ç½®æ•°æ®
    );
  }

  // æ ¹æ®IDæŸ¥æ‰¾è¯„è®º - ä¿®å¤æ¥¼ä¸­æ¥¼æŸ¥æ‰¾é€»è¾‘
  async function findCommentById(commentId) {
    // é¦–å…ˆå°è¯•ç›´æ¥ä»DOMä¸­æ‰¾åˆ°å¯¹åº”çš„è¯„è®ºå…ƒç´ å¹¶æå–æ•°æ®
    // è¿™æ ·å¯ä»¥ç¡®ä¿å¼•ç”¨çš„æ˜¯ç”¨æˆ·å®é™…ç‚¹å‡»çš„è¯„è®ºï¼Œé¿å…æ•°æ®ç»“æ„å’ŒDOMç»“æ„ä¸åŒ¹é…
    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
    if (commentElement) {
      try {
        const userName = commentElement.querySelector('.tweet-user-name').textContent;
        const userHandle = commentElement.querySelector('.tweet-user-handle').textContent;
        const userAvatar = commentElement.querySelector('.tweet-avatar').src;
        const verified = commentElement.querySelector('.tweet-verified') !== null;
        const contentElement = commentElement.querySelector('.comment-content');

        // è·å–è¯„è®ºå†…å®¹ï¼Œè¿‡æ»¤æ‰å›å¤æ ‡è®°
        let content = '';
        if (contentElement) {
          // å…‹éš†èŠ‚ç‚¹ä»¥é¿å…ä¿®æ”¹åŸDOM
          const contentClone = contentElement.cloneNode(true);
          // ç§»é™¤å›å¤æ ‡è®°
          const replyTo = contentClone.querySelector('.reply-to');
          if (replyTo) {
            replyTo.remove();
          }
          content = contentClone.textContent.trim();
        }

        const timeElement = commentElement.querySelector('.tweet-time');
        const time = timeElement ? timeElement.textContent.replace('Â·', '').trim() : 'åˆšåˆš';

        return {
          id: commentId,
          user: {
            name: userName,
            handle: userHandle,
            avatar: userAvatar,
            verified: verified,
          },
          content: content,
          time: time,
        };
      } catch (error) {
        console.error('ä»DOMæå–è¯„è®ºä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // å¦‚æœä»DOMæå–å¤±è´¥ï¼Œå›é€€åˆ°æ•°æ®æŸ¥æ‰¾
    // åœ¨ä¸»é¡µæ¨æ–‡ä¸­æŸ¥æ‰¾
    const allTweets = [...forYouTweets, ...followingTweets];

    for (const tweet of allTweets) {
      if (tweet.comments) {
        for (const comment of tweet.comments) {
          if (comment.id === commentId) {
            return comment;
          }
          // æ£€æŸ¥å›å¤
          if (comment.replies) {
            for (const reply of comment.replies) {
              if (reply.id === commentId) {
                return reply;
              }
            }
          }
        }
      }
    }

    // åœ¨è¯¦æƒ…é¡µé¢å½“å‰æ¨æ–‡ä¸­æŸ¥æ‰¾
    const currentTweetData = sessionStorage.getItem('currentTweetData');
    if (currentTweetData) {
      const tweetData = ValidationUtils.safeParseJSON(currentTweetData);
      if (tweetData && tweetData.comments) {
        for (const comment of tweetData.comments) {
          if (comment.id === commentId) {
            return comment;
          }
          // æ£€æŸ¥å›å¤
          if (comment.replies) {
            for (const reply of comment.replies) {
              if (reply.id === commentId) {
                return reply;
              }
            }
          }
        }
      }
    }

    // åœ¨ç”¨æˆ·æ¨æ–‡ä¸­æŸ¥æ‰¾
    try {
      const db = getXDB();

      const userTweets = await db.xUserTweets.get('userTweets');
      if (userTweets && userTweets.tweets) {
        for (const tweet of userTweets.tweets) {
          if (tweet.comments) {
            for (const comment of tweet.comments) {
              if (comment.id === commentId) {
                return comment;
              }
              // æ£€æŸ¥å›å¤
              if (comment.replies) {
                for (const reply of comment.replies) {
                  if (reply.id === commentId) {
                    return reply;
                  }
                }
              }
            }
          }
        }
      }
    } catch (error) {
      ValidationUtils.handleError(error, 'æŸ¥æ‰¾ç”¨æˆ·æ¨æ–‡è¯„è®º');
    }

    return null;
  }

  // å¤„ç†å¼•ç”¨è½¬å‘
  function handleQuoteRetweet(
    type,
    id,
    userName,
    userHandle,
    userAvatar,
    verified,
    content,
    time,
    imageData = null,
    linkData = null,
    location = null,
  ) {
    // æ‰“å¼€å‘å¸–å¼¹çª—
    openComposeTweetModal();

    // å­˜å‚¨å¼•ç”¨æ•°æ®
    currentQuoteData = {
      type: type, // 'tweet' æˆ– 'comment'
      id: id,
      user: {
        name: userName,
        handle: userHandle,
        avatar: userAvatar,
        verified: verified,
      },
      content: content,
      time: time,
      image: imageData, // å›¾ç‰‡æ•°æ®
      link: linkData, // é“¾æ¥æ•°æ®
      location: location, // ä½ç½®æ•°æ®
    };

    // æ˜¾ç¤ºå¼•ç”¨å†…å®¹é¢„è§ˆ
    showQuotePreview();

    // æ›´æ–°æ–‡æœ¬è¾“å…¥æ¡†å ä½ç¬¦
    const textInput = document.getElementById('compose-text-input');
    if (textInput) {
      textInput.placeholder = type === 'tweet' ? 'æ·»åŠ ä½ çš„è¯„è®ºæ¥å¼•ç”¨è¿™æ¡æ¨æ–‡' : 'æ·»åŠ ä½ çš„è¯„è®ºæ¥å¼•ç”¨è¿™æ¡è¯„è®º';
      textInput.focus();
    }
  }

  // æ˜¾ç¤ºå¼•ç”¨å†…å®¹é¢„è§ˆ
  function showQuotePreview() {
    if (!currentQuoteData) return;

    const preview = document.getElementById('quote-content-preview');
    const typeText = document.getElementById('quote-type-text');
    const userAvatar = document.getElementById('quote-user-avatar');
    const userName = document.getElementById('quote-user-name');
    const userVerified = document.getElementById('quote-user-verified');
    const userHandle = document.getElementById('quote-user-handle');
    const userTime = document.getElementById('quote-user-time');
    const contentText = document.getElementById('quote-content-text');

    if (!preview) return;

    // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
    preview.style.display = 'block';

    // è®¾ç½®å¼•ç”¨ç±»å‹
    if (typeText) {
      typeText.textContent = currentQuoteData.type === 'tweet' ? 'å¼•ç”¨æ¨æ–‡' : 'å¼•ç”¨è¯„è®º';
    }

    // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
    if (userAvatar) userAvatar.src = currentQuoteData.user.avatar;
    if (userName) userName.textContent = currentQuoteData.user.name;
    if (userHandle) userHandle.textContent = currentQuoteData.user.handle;
    if (userTime) userTime.textContent = 'Â·' + currentQuoteData.time;

    // æ˜¾ç¤º/éšè—è®¤è¯å›¾æ ‡
    if (userVerified) {
      userVerified.style.display = currentQuoteData.user.verified ? 'inline' : 'none';
    }

    // è®¾ç½®å†…å®¹
    if (contentText) {
      // å¤„ç†å†…å®¹ä¸­çš„HTMLè½¬ä¹‰
      const processedContent = currentQuoteData.content
        .replace(/&quot;/g, '"')
        .replace(/&#x27;/g, "'")
        .replace(/&amp;/g, '&');
      contentText.textContent = processedContent;
    }

    // å¤„ç†å›¾ç‰‡å†…å®¹
    const imageContainer = document.getElementById('quote-image-container');
    if (imageContainer) {
      if (currentQuoteData.image) {
        imageContainer.style.display = 'block';

        if (currentQuoteData.image.type === 'description') {
          imageContainer.innerHTML = `
              <div style="margin-top: 8px; background-color: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 8px; padding: 8px;">
                <div style="color: #fff; font-size: 13px; line-height: 1.4;">${currentQuoteData.image.content}</div>
              </div>
            `;
        } else if (currentQuoteData.image.type === 'upload') {
          imageContainer.innerHTML = `
              <div style="margin-top: 8px; border-radius: 8px; overflow: hidden;">
                <img src="${currentQuoteData.image.content}" style="width: 100%; max-height: 120px; object-fit: cover; display: block;" alt="å¼•ç”¨å›¾ç‰‡">
              </div>
            `;
        }
      } else {
        imageContainer.style.display = 'none';
        imageContainer.innerHTML = '';
      }
    }
  }

  // ç§»é™¤å¼•ç”¨å†…å®¹
  function removeQuoteContent() {
    currentQuoteData = null;
    const preview = document.getElementById('quote-content-preview');
    if (preview) {
      preview.style.display = 'none';
    }

    // æ¸…ç†å›¾ç‰‡å®¹å™¨
    const imageContainer = document.getElementById('quote-image-container');
    if (imageContainer) {
      imageContainer.style.display = 'none';
      imageContainer.innerHTML = '';
    }

    // æ¢å¤åŸå§‹å ä½ç¬¦
    const textInput = document.getElementById('compose-text-input');
    if (textInput) {
      textInput.placeholder = 'æœ‰ä»€ä¹ˆæ–°é²œäº‹ï¼Ÿ';
    }
  }
  //  â–²â–²â–² å¼•ç”¨è½¬å‘åŠŸèƒ½JavaScript â–²â–²â–²
  // â–²â–²â–² ã€æ•´åˆã€‘Xç¤¾äº¤appçš„JavaScriptä»£ç ç»“æŸ â–²â–²â–²

  // ============================================
  // ç¬¬å››éƒ¨åˆ†: åˆå§‹åŒ–å’Œå¯¹å¤–æ¥å£
  // ============================================

  // åˆå§‹åŒ–Xç¤¾äº¤åº”ç”¨
  async function initXSocialApp() {
    try {
      console.log('ğŸš€ åˆå§‹åŒ– X Social App...');

      // 1. æ³¨å…¥æ ·å¼
      injectStyles();

      // 2. åˆ›å»ºHTMLç»“æ„
      createXSocialHTML();

      // 3. åŠ è½½æ´»è·ƒè´¦å·ï¼ˆå¿…é¡»åœ¨åŠ è½½ç”¨æˆ·èµ„æ–™ä¹‹å‰ï¼‰
      await loadActiveAccount();
      console.log('ğŸ“Œ å½“å‰æ´»è·ƒè´¦æˆ·:', currentAccountId);

      // 4. åˆå§‹åŒ–æ¨æ–‡æ•°æ®
      await initializeTweets();

      // 5. åŠ è½½ç”¨æˆ·èµ„æ–™ï¼ˆä½¿ç”¨æ­£ç¡®çš„currentAccountIdï¼‰
      await loadUserProfile();

      // 6. åˆå§‹åŒ–Xè®¾ç½®ï¼ˆæŒ‰è´¦å·åŠ è½½ï¼‰
      await initializeXSettings();

      // 7. ç»‘å®šæ‰€æœ‰äº‹ä»¶å¤„ç†å™¨
      bindEventHandlers();

      // 8. æ›´æ–°UIæ˜¾ç¤ºï¼ˆç¡®ä¿ç”¨æˆ·èµ„æ–™æ­£ç¡®æ˜¾ç¤ºï¼‰
      loadUserProfileToUI();

      console.log('âœ… X Social App åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      console.error('âŒ X Social App åˆå§‹åŒ–å¤±è´¥:', error);
      showXToast('åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
    }
  }

  // æ¸²æŸ“Xç¤¾äº¤é¡µé¢ - å…¼å®¹ç°æœ‰HTMLçš„è°ƒç”¨æ–¹å¼
  function renderXSocialScreen() {
    console.log('ğŸ¬ æ¸²æŸ“Xç¤¾äº¤é¡µé¢');

    // å¦‚æœè¿˜æœªåˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–
    const xScreen = document.getElementById('x-social-screen');
    if (!xScreen) {
      console.log('âš ï¸ Xç¤¾äº¤é¡µé¢æœªåˆ›å»ºï¼Œå¼€å§‹åˆå§‹åŒ–...');
      initXSocialApp().then(() => {
        console.log('âœ… åˆå§‹åŒ–å®Œæˆï¼Œæ˜¾ç¤ºä¸»é¡µ');
        const screen = document.getElementById('x-social-screen');
        if (screen) {
          screen.style.display = 'flex';
          switchXPage('home');
        }
      });
    } else {
      console.log('âœ… Xç¤¾äº¤é¡µé¢å·²å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º');
      // ç¡®ä¿é¡µé¢å¯è§
      xScreen.style.display = 'flex';
      switchXPage('home');
    }
  }

  // è·å–é»˜è®¤ç”¨æˆ·èµ„æ–™é…ç½®ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
  function getDefaultUserProfile(accountId = 'main') {
    return {
      id: accountId,
      name: accountId === 'main' ? 'æˆ‘' : 'æ–°ç”¨æˆ·',
      handle: accountId === 'main' ? '@me' : '@newuser_' + Date.now().toString().slice(-6),
      avatar: 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg',
      coverImage: 'https://i.postimg.cc/qRzMB6nQ/default-cover.jpg',
      verified: false,
      verificationType: 'none',
      bio: 'æ¬¢è¿æ¥åˆ°æˆ‘çš„Xä¸»é¡µï¼',
      publicIdentity: '',
      showRealName: false,
      realName: '',
      customTag1: 'ç§‘æŠ€çˆ±å¥½è€…',
      customTag1Icon: 'âœ¨',
      customTag1Color: '#71767b',
      customTag2: '2024å¹´åŠ å…¥',
      customTag2Icon: 'ğŸ“…',
      customTag2Color: '#71767b',
      followingCount: accountId === 'main' ? '156' : '0',
      followersCount: accountId === 'main' ? '89' : '0',
      knownIdentityCharacters: [],
      coupleCharacterId: '',
      coupleCharacterName: '',
      lastUpdated: new Date().toISOString(),
    };
  }

  // åŠ è½½ç”¨æˆ·èµ„æ–™ï¼ˆåˆå§‹åŒ–ä¸“ç”¨ - ç®€åŒ–ç‰ˆï¼‰
  async function loadUserProfile() {
    try {
      const db = getXDB();
      const accountId = currentAccountId || 'main';
      const profile = await db.xUserProfile.get(accountId);

      if (profile) {
        // æ›´æ–°ç°æœ‰å¯¹è±¡çš„å±æ€§ï¼Œè€Œä¸æ˜¯æ›¿æ¢æ•´ä¸ªå¯¹è±¡ï¼ˆä¿æŒå¼•ç”¨ä¸€è‡´ï¼‰
        Object.assign(window.userProfileData, profile);
      } else {
        // ä½¿ç”¨é»˜è®¤ç”¨æˆ·èµ„æ–™å¹¶ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆä»…åœ¨é¦–æ¬¡åˆå§‹åŒ–æ—¶ï¼‰
        const defaultProfile = getDefaultUserProfile(accountId);
        Object.assign(window.userProfileData, defaultProfile);
        await db.xUserProfile.put(window.userProfileData);
        console.log('ğŸ“ å·²åˆ›å»ºé»˜è®¤ç”¨æˆ·èµ„æ–™:', accountId);
      }

      // ç¡®ä¿å¿…è¦å­—æ®µå­˜åœ¨ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
      ensureProfileFields(window.userProfileData);

      console.log('âœ… ç”¨æˆ·èµ„æ–™å·²åŠ è½½:', window.userProfileData.name, '(è´¦æˆ·:', accountId + ')');
      console.log('ğŸ” ç”¨æˆ·èµ„æ–™è¯¦æƒ…:', {
        è®¤è¯ç±»å‹: window.userProfileData.verificationType,
        æƒ…ä¾£è§’è‰²: window.userProfileData.coupleCharacterName,
        å·²çŸ¥èº«ä»½è§’è‰²æ•°: window.userProfileData.knownIdentityCharacters?.length || 0,
      });
    } catch (error) {
      console.error('âŒ åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
      // å³ä½¿å¤±è´¥ä¹Ÿä½¿ç”¨é»˜è®¤å€¼
      const defaultProfile = getDefaultUserProfile('main');
      Object.assign(window.userProfileData, defaultProfile);
    }
  }

  // ç¡®ä¿ç”¨æˆ·èµ„æ–™åŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µï¼ˆç”¨äºæ•°æ®å…¼å®¹ï¼‰
  function ensureProfileFields(profile) {
    if (!profile.knownIdentityCharacters) profile.knownIdentityCharacters = [];
    if (!profile.verificationType) profile.verificationType = 'none';
    if (!profile.coupleCharacterId) profile.coupleCharacterId = '';
    if (!profile.coupleCharacterName) profile.coupleCharacterName = '';
    if (profile.publicIdentity === undefined) profile.publicIdentity = '';
    if (profile.showRealName === undefined) profile.showRealName = false;
    if (profile.realName === undefined) profile.realName = '';
    if (!profile.customTag1Color) profile.customTag1Color = '#71767b';
    if (!profile.customTag2Color) profile.customTag2Color = '#71767b';
  }

  // ç»‘å®šäº‹ä»¶å¤„ç†å™¨
  function bindEventHandlers() {
    // å› ä¸ºHTMLæ˜¯åŠ¨æ€åˆ›å»ºçš„ï¼Œéœ€è¦åœ¨åˆ›å»ºåç»‘å®šæ‰€æœ‰äº‹ä»¶

    // ç»‘å®šè§’è‰²Xèµ„æ–™è¡¨å•äº‹ä»¶
    const characterXProfileForm = document.getElementById('character-x-profile-form');
    if (characterXProfileForm) {
      characterXProfileForm.addEventListener('submit', saveCharacterXProfile);
      console.log('âœ… å·²ç»‘å®šè§’è‰²Xèµ„æ–™è¡¨å•æäº¤äº‹ä»¶');
    }

    // ç»‘å®šç®€ä»‹å­—ç¬¦è®¡æ•°äº‹ä»¶
    const characterXBio = document.getElementById('character-x-bio');
    if (characterXBio) {
      characterXBio.addEventListener('input', updateCharacterBioCount);
    }

    // ç»‘å®šå…³ç³»è¡¨å•äº‹ä»¶
    const relationshipForm = document.getElementById('relationship-form');
    if (relationshipForm) {
      relationshipForm.addEventListener('submit', saveRelationshipForm);
      console.log('âœ… å·²ç»‘å®šå…³ç³»è¡¨å•æäº¤äº‹ä»¶');
    }

    // ç»‘å®šå…³ç³»æè¿°å­—ç¬¦è®¡æ•°äº‹ä»¶
    const relationshipDesc = document.getElementById('relationship-description');
    if (relationshipDesc) {
      relationshipDesc.addEventListener('input', updateRelationshipDescCount);
    }

    // ç»‘å®šè§’è‰²çœŸå®å§“åå­—ç¬¦è®¡æ•°äº‹ä»¶
    const characterRealName = document.getElementById('character-real-name');
    if (characterRealName) {
      characterRealName.addEventListener('input', updateCharacterXProfileCounts);
    }

    console.log('âœ… æ‰€æœ‰äº‹ä»¶å¤„ç†å™¨å·²ç»‘å®š');
  }

  // ============================================
  // æé—®ç®±åŠŸèƒ½
  // ============================================

  // æé—®ç®±æ•°æ®ï¼ˆä¸´æ—¶å­˜å‚¨ï¼Œåç»­å¯æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼‰
  let askboxData = {
    avatar: 'https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg',
    nickname: '= =',
    prompt: 'è¯·å‘æˆ‘åŒ¿åæé—®!waiting...',
    background: 'https://i.postimg.cc/7LqVqxt4/mmexport1759588659314.jpg',
    answeredQuestions: [],
  };

  // æé—®ç®±å¤šé€‰åˆ é™¤ç›¸å…³å˜é‡
  let isAskboxMultiSelectMode = false;
  let selectedQuestions = new Set();
  let questionLongPressTimer = null;

  // ä»æ•°æ®åº“åŠ è½½æé—®ç®±æ•°æ®
  async function loadAskboxDataFromDB() {
    try {
      const xDb = getXDB();
      const accountId = currentAccountId || 'main';
      const askboxId = `askbox_${accountId}`;

      const savedData = await xDb.xAskbox.get(askboxId);

      if (savedData) {
        // ä»æ•°æ®åº“åŠ è½½
        Object.assign(askboxData, savedData);
        console.log('âœ… æé—®ç®±æ•°æ®å·²ä»æ•°æ®åº“åŠ è½½:', accountId);
      } else {
        // ä½¿ç”¨é»˜è®¤æ•°æ®å¹¶ä¿å­˜åˆ°æ•°æ®åº“
        askboxData.id = askboxId;
        await xDb.xAskbox.put(askboxData);
        console.log('âœ… å·²åˆ›å»ºé»˜è®¤æé—®ç®±æ•°æ®:', accountId);
      }
    } catch (error) {
      console.error('âŒ åŠ è½½æé—®ç®±æ•°æ®å¤±è´¥:', error);
    }
  }

  // ä¿å­˜æé—®ç®±æ•°æ®åˆ°æ•°æ®åº“
  async function saveAskboxDataToDB() {
    try {
      const xDb = getXDB();
      const accountId = currentAccountId || 'main';
      const askboxId = `askbox_${accountId}`;

      askboxData.id = askboxId;
      await xDb.xAskbox.put(askboxData);
      console.log('âœ… æé—®ç®±æ•°æ®å·²ä¿å­˜åˆ°æ•°æ®åº“:', accountId);
    } catch (error) {
      console.error('âŒ ä¿å­˜æé—®ç®±æ•°æ®å¤±è´¥:', error);
    }
  }

  // åŠ è½½æé—®ç®±æ•°æ®åˆ°UI
  async function loadAskboxData() {
    // ä»æ•°æ®åº“åŠ è½½
    await loadAskboxDataFromDB();

    // æ›´æ–°UI
    const avatarEl = document.getElementById('askbox-avatar');
    const nicknameEl = document.getElementById('askbox-nickname');
    const promptEl = document.getElementById('askbox-prompt');
    const backgroundEl = document.getElementById('askbox-background');

    if (avatarEl) avatarEl.src = askboxData.avatar;
    if (nicknameEl) nicknameEl.textContent = askboxData.nickname;
    if (promptEl) promptEl.textContent = askboxData.prompt;
    if (backgroundEl) backgroundEl.style.backgroundImage = `url('${askboxData.background}')`;

    // æ¸²æŸ“å·²å›ç­”çš„æé—®åˆ—è¡¨
    renderAnsweredQuestions();
  }

  // ä¿®æ”¹æé—®ç®±å¤´åƒ
  async function changeAskboxAvatar() {
    const newAvatar = prompt('è¯·è¾“å…¥æ–°çš„å¤´åƒURL:', askboxData.avatar);
    if (newAvatar && newAvatar.trim()) {
      askboxData.avatar = newAvatar.trim();
      const avatarEl = document.getElementById('askbox-avatar');
      if (avatarEl) avatarEl.src = askboxData.avatar;

      // ä¿å­˜åˆ°æ•°æ®åº“
      await saveAskboxDataToDB();
      showXToast('å¤´åƒå·²æ›´æ–°å¹¶ä¿å­˜', 'success');
    }
  }

  // ä¿å­˜æé—®ç®±æ˜µç§°ï¼ˆåŸå¤„ç¼–è¾‘ï¼‰
  async function saveAskboxNickname() {
    const nicknameEl = document.getElementById('askbox-nickname');
    if (!nicknameEl) return;

    const newNickname = nicknameEl.textContent.trim();
    if (newNickname && newNickname !== askboxData.nickname) {
      askboxData.nickname = newNickname;
      await saveAskboxDataToDB();
      console.log('âœ… æ˜µç§°å·²è‡ªåŠ¨ä¿å­˜:', newNickname);
    }
  }

  // ä¿å­˜æé—®å¡ç‰‡æ–‡å­—ï¼ˆåŸå¤„ç¼–è¾‘ï¼‰
  async function saveAskboxPrompt() {
    const promptEl = document.getElementById('askbox-prompt');
    if (!promptEl) return;

    const newPrompt = promptEl.textContent.trim();
    if (newPrompt && newPrompt !== askboxData.prompt) {
      askboxData.prompt = newPrompt;
      await saveAskboxDataToDB();
      console.log('âœ… æç¤ºæ–‡å­—å·²è‡ªåŠ¨ä¿å­˜:', newPrompt);
    }
  }

  // æ‰“å¼€æé—®ç®±è®¾ç½®
  function openAskboxSettings() {
    const newBackground = prompt('è¯·è¾“å…¥æ–°çš„èƒŒæ™¯å›¾URL:', askboxData.background);
    if (newBackground && newBackground.trim()) {
      askboxData.background = newBackground.trim();
      const backgroundEl = document.getElementById('askbox-background');
      if (backgroundEl) backgroundEl.style.backgroundImage = `url('${askboxData.background}')`;

      // ä¿å­˜åˆ°æ•°æ®åº“
      saveAskboxDataToDB();
      showXToast('èƒŒæ™¯å›¾å·²æ›´æ–°å¹¶ä¿å­˜', 'success');
    }
  }

  // è·å–æ–°çš„æé—®ï¼ˆç¬¬å››ä¸ªæƒ…æ™¯ï¼šæé—®ç®±AIç”Ÿæˆï¼‰
  async function getNewQuestion() {
    try {
      showXToast('æ­£åœ¨ç”Ÿæˆæ–°çš„æé—®...', 'info');

      // ä»æ•°æ®åº“è¯»å–APIé…ç½®å’ŒXè®¾ç½®
      const db = getDB();
      const xDb = getXDB();

      const apiConfig = await db.apiConfig.get('main');
      if (!apiConfig || !apiConfig.proxyUrl || !apiConfig.apiKey || !apiConfig.model) {
        showXToast('è¯·å…ˆé…ç½®APIè®¾ç½®', 'error');
        return;
      }

      const { proxyUrl, apiKey, model } = apiConfig;

      // ä»Xè®¾ç½®ä¸­è¯»å–é…ç½®ï¼ˆæŒ‰è´¦å·è¯»å–ï¼‰
      const settingsId = `xSettings_${currentAccountId || 'main'}`;
      const xSettings = await xDb.xSettings.get(settingsId);
      const userPrompt = xSettings?.systemPrompt || '';
      const worldSetting = xSettings?.worldSetting || '';
      const boundCharacters = xSettings?.boundCharacters || [];

      // ä½¿ç”¨å·¥å…·å‡½æ•°æ„å»ºç”¨æˆ·Xä¸ªäººèµ„æ–™ä¿¡æ¯
      const userXProfileInfo = StringBuilders.buildUserXProfileInfo(window.userProfileData);

      // è¯»å–ç”¨æˆ·å·²å‘å¸ƒçš„æ¨æ–‡
      const userTweetsId = `userTweets_${currentAccountId || 'main'}`;
      const userTweetsData = await xDb.xUserTweets.get(userTweetsId);
      const userTweets = userTweetsData?.tweets || [];
      const recentUserTweets = userTweets.slice(0, 10); // æœ€è¿‘10æ¡æ¨æ–‡

      // è·å–æƒ…ä¾£è§’è‰²çš„Xèµ„æ–™
      let coupleCharacterInfo = '';
      if (userXProfileInfo.verificationType === 'couple' && userXProfileInfo.coupleCharacterId) {
        const coupleCharacterProfile = await xDb.xCharacterProfiles
          .where('characterId')
          .equals(userXProfileInfo.coupleCharacterId)
          .first();

        if (coupleCharacterProfile) {
          coupleCharacterInfo = `
ã€æƒ…ä¾£è§’è‰²ä¿¡æ¯ã€‘ï¼š
- Xå§“åï¼š${coupleCharacterProfile.xName}
- Xå¥æŸ„ï¼š${coupleCharacterProfile.xHandle}
- Xç®€ä»‹ï¼š${coupleCharacterProfile.xBio || 'æ— '}
- å…¬ä¼—èº«ä»½ï¼š${coupleCharacterProfile.publicIdentity || 'æ— '}
- çœŸå®å§“åï¼š${
            coupleCharacterProfile.showRealName && coupleCharacterProfile.realName
              ? coupleCharacterProfile.realName
              : 'æœªå…¬å¼€'
          }
`;
        }
      }

      // è·å–ç»‘å®šè§’è‰²ä¿¡æ¯ï¼ˆç”¨äºåŒ¿åæé—®ï¼‰
      let boundCharactersInfo = '';
      if (boundCharacters.length > 0) {
        const mainDB = getDB();
        const allChats = await mainDB.chats.toArray();
        const boundCharsData = allChats.filter(chat => !chat.isGroup && boundCharacters.includes(chat.id));

        const allXProfiles = await xDb.xCharacterProfiles.toArray();
        const xProfileMap = new Map();
        allXProfiles.forEach(profile => {
          xProfileMap.set(profile.characterId, profile);
        });

        if (boundCharsData.length > 0) {
          boundCharactersInfo = '\nã€ç»‘å®šè§’è‰²ä¿¡æ¯ï¼ˆå¯åŒ¿åæé—®ï¼‰ã€‘ï¼š\nä»¥ä¸‹è§’è‰²å¯ä»¥ä½œä¸ºåŒ¿åæé—®è€…ï¼š\n';
          for (const char of boundCharsData) {
            const xProfile = xProfileMap.get(char.id);
            if (xProfile) {
              boundCharactersInfo += `\n- ${xProfile.xName}ï¼ˆ${xProfile.xHandle}ï¼‰: ${
                char.settings.aiPersona?.substring(0, 100) || ''
              }`;
            }
          }
        }
      }

      // æ”¶é›†å·²å›å¤çš„æé—®ï¼ˆä½œä¸ºå¯¹è¯å†å²ï¼‰
      const answeredQuestionsContext = askboxData.answeredQuestions
        .filter(q => q.answer && q.answer.trim())
        .slice(0, 5) // æœ€è¿‘5ä¸ªå·²å›å¤çš„æé—®
        .map(q => `Q: ${q.question}\nA: ${q.answer}`)
        .join('\n\n');

      // æ„å»ºæé—®ç®±ä¸“ç”¨ç³»ç»Ÿæç¤ºè¯
      let systemPrompt = StringBuilders.buildBaseSystemPrompt({
        userPrompt,
        worldSetting,
      });

      systemPrompt += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ æ ¸å¿ƒä»»åŠ¡è¯´æ˜ - åŒ¿åæé—®ç®± ğŸ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä½ æ˜¯ä¸€ä¸ªåŒ¿åæé—®ç®±ç³»ç»Ÿã€‚è¯·ä¸ºç”¨æˆ·ç”Ÿæˆä¸€ä¸ªæœ‰è¶£çš„ã€é€‚åˆä»–ä»¬èº«ä»½çš„åŒ¿åæé—®ã€‚

ã€ç”¨æˆ·èº«ä»½ä¿¡æ¯ã€‘ï¼š
- ç”¨æˆ·åï¼š${userXProfileInfo.name}
- Xå¥æŸ„ï¼š${userXProfileInfo.handle}
- ç®€ä»‹ï¼š${userXProfileInfo.bio || 'æ— '}
- å…¬ä¼—èº«ä»½ï¼š${userXProfileInfo.publicIdentity || 'æ— '}
- è®¤è¯ç±»å‹ï¼š${StringBuilders.getUserVerificationTypeDescription(userXProfileInfo)}
${
  userXProfileInfo.verificationType === 'couple' && userXProfileInfo.coupleCharacterName
    ? `- æƒ…ä¾£å…³ç³»ï¼šä¸${userXProfileInfo.coupleCharacterName}æ˜¯å…¬å¼€æƒ…ä¾£`
    : ''
}
${coupleCharacterInfo}

ã€ç”¨æˆ·æœ€è¿‘å‘å¸ƒçš„æ¨æ–‡ã€‘ï¼š
${
  recentUserTweets.length > 0
    ? recentUserTweets.map((tweet, i) => `${i + 1}. ${tweet.content}${tweet.time ? ` (${tweet.time})` : ''}`).join('\n')
    : 'æš‚æ— æ¨æ–‡'
}

${boundCharactersInfo}

${
  answeredQuestionsContext
    ? `ã€ä¹‹å‰çš„æé—®ä¸å›å¤å†å²ã€‘ï¼š\n${answeredQuestionsContext}\n\nã€ç»§ç»­æ€§è¦æ±‚ã€‘ï¼šæ–°æé—®å¯ä»¥å»¶ç»­ä¹‹å‰çš„è¯é¢˜ï¼Œä¹Ÿå¯ä»¥å¼€å¯æ–°è¯é¢˜ï¼Œä¿æŒè‡ªç„¶ã€‚`
    : ''
}

ã€æé—®ç”Ÿæˆè¦æ±‚ã€‘ï¼š
1. æé—®è¦è‡ªç„¶ã€çœŸå®ï¼Œåƒæ˜¯çœŸå®çš„åŒ¿åç”¨æˆ·æå‡ºçš„
2. æé—®å†…å®¹è¦ä¸ç”¨æˆ·çš„èº«ä»½ã€ç®€ä»‹ã€å…¬ä¼—èº«ä»½ã€æœ€è¿‘å‘å¸ƒçš„æ¨æ–‡ç›¸å…³
3. å¦‚æœæœ‰ç»‘å®šè§’è‰²ï¼Œå¯ä»¥è®©è§’è‰²ä»¥åŒ¿åèº«ä»½æé—®ï¼Œæé—®å†…å®¹è¦ç¬¦åˆè§’è‰²çš„äººè®¾å’Œæ€§æ ¼
4. å¦‚æœæœ‰ä¹‹å‰çš„æé—®å†å²ï¼Œå¯ä»¥å»¶ç»­è¯é¢˜ï¼Œä¹Ÿå¯ä»¥æå‡ºæ–°è¯é¢˜
5. æé—®å¯ä»¥æ˜¯ï¼š
   - å…³äºæœ€è¿‘æ¨æ–‡å†…å®¹çš„è¿½é—®æˆ–è¯„è®º
   - å…³äºç”Ÿæ´»ç»éªŒã€æƒ…æ„Ÿæ€åº¦çš„è¯¢é—®
   - å…³äºå…´è¶£çˆ±å¥½ã€ä¸“ä¸šæŠ€èƒ½çš„è¯·æ•™
   - å…³äºæ—¥å¸¸è¶£äº‹ã€ç‰¹æ®Šç»å†çš„å¥½å¥‡
   - è½»æ¾å¹½é»˜æˆ–æ·±åº¦æ€è€ƒçš„è¯é¢˜
6. æé—®é•¿åº¦é€‚ä¸­ï¼ˆ10-50å­—ï¼‰ï¼Œä¸è¦å¤ªé•¿æˆ–å¤ªçŸ­
7. è¯­æ°”å¯ä»¥æ˜¯ï¼šå¥½å¥‡çš„ã€è°ƒä¾ƒçš„ã€çœŸè¯šçš„ã€å¹½é»˜çš„
8. é¿å…è¿‡äºç§å¯†ã€å†’çŠ¯æˆ–ä¸é€‚å½“çš„é—®é¢˜

ã€è¿”å›æ ¼å¼ã€‘ï¼š
æ¯è¡Œä¸€ä¸ªæé—®ï¼Œç”¨æ¢è¡Œç¬¦åˆ†éš”ï¼Œä¸éœ€è¦åºå·ã€å¼•å·æˆ–å…¶ä»–æ ¼å¼
æ¯ä¸ªæé—®ç‹¬ç«‹æˆè¡Œï¼Œç›´æ¥è¾“å‡ºæé—®å†…å®¹

ç¤ºä¾‹æ ¼å¼ï¼š
çœ‹åˆ°ä½ æœ€è¿‘å‘çš„æ¨æ–‡ï¼Œæ„Ÿè§‰å¿ƒæƒ…ä¸é”™å‘€ï¼Ÿ
æœ€è¿‘æœ‰é‡åˆ°ä»€ä¹ˆè®©ä½ ç‰¹åˆ«å¼€å¿ƒçš„äº‹å—ï¼Ÿ
å¦‚æœå¯ä»¥æ‹¥æœ‰ä¸€ä¸ªè¶…èƒ½åŠ›ï¼Œä½ ä¼šé€‰ä»€ä¹ˆï¼Ÿ
ä½ è§‰å¾—æœ€é‡è¦çš„äººç”Ÿå“è´¨æ˜¯ä»€ä¹ˆï¼Ÿ

ç°åœ¨ï¼Œè¯·ä¸ºç”¨æˆ·ç”Ÿæˆ3-10ä¸ªåŒ¿åæé—®ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š`;

      const messages = [{ role: 'user', content: 'è¯·ç”Ÿæˆ3-10ä¸ªåŒ¿åæé—®ï¼Œæ¯è¡Œä¸€ä¸ª' }];

      // åˆ¤æ–­APIç±»å‹å¹¶å‘é€è¯·æ±‚
      let isGemini = proxyUrl.includes('generativelanguage');
      let response;

      if (isGemini) {
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
        const geminiConfig = {
          url: `${GEMINI_API_URL}/${model}:generateContent?key=${getRandomValue(apiKey)}`,
          data: {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: systemPrompt + '\n\n' + messages.map(m => m.content).join('\n'),
                    },
                  ],
                },
              ],
              generationConfig: {
                temperature: 0.9,
              },
            }),
          },
        };
        response = await fetch(geminiConfig.url, geminiConfig.data);
      } else {
        const openAiPayload = {
          model: model,
          messages: [{ role: 'system', content: systemPrompt }, ...messages],
          temperature: 0.9,
          stream: false,
        };
        response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify(openAiPayload),
        });
      }

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`APIé”™è¯¯: ${response.status} - ${errorData.error?.message || response.statusText}`);
      }

      const data = await response.json();
      let aiResponseContent;

      if (isGemini) {
        // Geminiæ ¼å¼
        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
          aiResponseContent = data.candidates[0].content.parts[0].text || '';
        }
      } else {
        // OpenAIæ ¼å¼
        aiResponseContent = data.choices?.[0]?.message?.content || '';
      }

      console.log('AIç”Ÿæˆçš„æé—®:', aiResponseContent);

      // æŒ‰è¡Œåˆ†å‰²æé—®å†…å®¹
      const questions = aiResponseContent
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .map(line => {
          // æ¸…ç†æ¯è¡Œï¼šå»é™¤åºå·ï¼ˆå¦‚ "1. "ã€"- "ç­‰ï¼‰ã€å¼•å·
          return line
            .replace(/^\d+[\.\)ã€]\s*/, '') // å»é™¤æ•°å­—åºå·
            .replace(/^[-â€¢]\s*/, '') // å»é™¤çŸ­æ¨ªçº¿æˆ–é¡¹ç›®ç¬¦å·
            .replace(/^["ã€Œã€]|["ã€ã€]$/g, '') // å»é™¤å¼•å·
            .trim();
        })
        .filter(q => q.length > 0); // å†æ¬¡è¿‡æ»¤ç©ºè¡Œ

      if (questions.length === 0) {
        throw new Error('AIè¿”å›äº†ç©ºçš„æé—®å†…å®¹');
      }

      console.log(`âœ… è§£æåˆ° ${questions.length} ä¸ªæé—®:`, questions);

      // ä¸ºæ¯ä¸ªæé—®åˆ›å»ºå¯¹è±¡å¹¶æ·»åŠ åˆ°æ•°ç»„
      const newQuestions = questions.map((question, index) => ({
        id: `q_${Date.now()}_${index}_${Math.random().toString(36).substr(2, 9)}`,
        question: question,
        answer: '', // åˆå§‹ä¸ºç©ºï¼Œç”¨æˆ·å¯ä»¥ç¼–è¾‘å›å¤
        date: new Date().toISOString(),
      }));

      // æ‰¹é‡æ·»åŠ åˆ°æœ€å‰é¢
      askboxData.answeredQuestions.unshift(...newQuestions);

      // ä¿å­˜åˆ°æ•°æ®åº“
      await saveAskboxDataToDB();

      // é‡æ–°æ¸²æŸ“æé—®åˆ—è¡¨
      renderAnsweredQuestions();

      showXToast(`ä½ æœ‰ ${newQuestions.length} ä¸ªæ–°çš„æé—®è¯·æŸ¥æ”¶`, 'success');
    } catch (error) {
      console.error('ç”Ÿæˆæé—®å¤±è´¥:', error);
      showXToast(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
    }
  }

  // æ¸²æŸ“å·²å›ç­”çš„æé—®åˆ—è¡¨
  function renderAnsweredQuestions() {
    const container = document.getElementById('answered-questions-list');
    const titleEl = document.getElementById('answered-questions-title');
    if (!container) return;

    if (askboxData.answeredQuestions.length === 0) {
      // éšè—æ ‡é¢˜
      if (titleEl) titleEl.style.display = 'none';

      container.innerHTML = `
        <div style="
          text-align: center;
          color: rgba(255,255,255,0.6);
          font-size: 14px;
          padding: 40px 20px;
        ">
          æš‚æ— æé—®
        </div>
      `;
      return;
    }

    // æ˜¾ç¤ºæ ‡é¢˜
    if (titleEl) titleEl.style.display = 'block';

    container.innerHTML = askboxData.answeredQuestions
      .map((q, index) => {
        const date = new Date(q.date);
        const dateStr = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
        const isSelected = selectedQuestions.has(q.id);

        return `
      <div 
        class="askbox-question-item"
        data-question-id="${q.id}"
        style="
        background-color: rgba(255,255,255,0.9);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: all 0.2s;
        ${isSelected ? 'border: 3px solid #1d9bf0; background-color: rgba(29, 155, 240, 0.1);' : ''}
        ${isAskboxMultiSelectMode ? 'border-left: 3px solid #1d9bf0;' : ''}
      " 
      onmouseover="if(!${isAskboxMultiSelectMode}){this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)';}"
      onmouseout="if(!${isAskboxMultiSelectMode}){this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';}"
      onmousedown="startQuestionLongPress('${q.id}')"
      onmouseup="endQuestionLongPress()"
      onmouseleave="endQuestionLongPress()"
      ontouchstart="startQuestionLongPress('${q.id}')"
      ontouchend="endQuestionLongPress()"
      onclick="if(${isAskboxMultiSelectMode}){toggleQuestionSelection('${q.id}');event.stopPropagation();}"
      >
        <!-- æé—®åŒºåŸŸï¼ˆæµ…é»‘ç°è‰²ï¼‰ -->
        <div style="
          background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
          padding: 20px;
          color: #fff;
        ">
          <div style="font-size: 15px; line-height: 1.6; word-break: break-word;">
            ${q.question}
          </div>
        </div>
        
        <!-- å›å¤åŒºåŸŸï¼ˆç™½è‰²ï¼Œå¯ç¼–è¾‘ï¼‰ -->
        <div style="
          background-color: #fff;
          padding: 20px;
          min-height: 60px;
          color: #333;
        ">
          <div id="answer-${q.id}" 
            contenteditable="true"
            data-question-id="${q.id}"
            style="
              font-size: 14px; 
              line-height: 1.6; 
              word-break: break-word;
              outline: none;
              cursor: text;
              min-height: 20px;
              ${q.answer ? '' : 'color: #999; text-align: center;'}
            "
            onblur="saveQuestionAnswer('${q.id}')"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();this.blur();}"
            onfocus="if(this.textContent==='ç‚¹å‡»æ­¤å¤„å›å¤...'){this.textContent='';this.style.color='#333';this.style.textAlign='left';}">${
              q.answer || 'ç‚¹å‡»æ­¤å¤„å›å¤...'
            }</div>
        </div>
        
        <!-- æ—¥æœŸæ ‡ç­¾ -->
        <div style="
          background-color: #f5f5f5;
          padding: 8px 20px;
          color: #999;
          font-size: 12px;
          text-align: right;
        ">
          ${dateStr}
        </div>
      </div>
    `;
      })
      .join('');
  }

  // ä¿å­˜æé—®å›å¤ï¼ˆåŸå¤„ç¼–è¾‘ï¼‰
  async function saveQuestionAnswer(questionId) {
    const answerEl = document.getElementById(`answer-${questionId}`);
    if (!answerEl) return;

    const question = askboxData.answeredQuestions.find(q => q.id === questionId);
    if (!question) return;

    let newAnswer = answerEl.textContent.trim();

    // å¦‚æœæ˜¯å ä½ç¬¦æ–‡æœ¬ï¼Œåˆ™æ¸…ç©º
    if (newAnswer === 'ç‚¹å‡»æ­¤å¤„å›å¤...') {
      newAnswer = '';
    }

    if (newAnswer !== question.answer) {
      question.answer = newAnswer;
      await saveAskboxDataToDB();
      console.log('âœ… å›å¤å·²è‡ªåŠ¨ä¿å­˜:', questionId);
    }
  }

  // ============================================
  // æé—®ç®±å¤šé€‰åˆ é™¤åŠŸèƒ½
  // ============================================

  // å¼€å§‹é•¿æŒ‰æé—®å¡ç‰‡
  function startQuestionLongPress(questionId) {
    if (isAskboxMultiSelectMode) return; // å·²ç»åœ¨å¤šé€‰æ¨¡å¼ï¼Œä¸éœ€è¦é•¿æŒ‰

    questionLongPressTimer = setTimeout(() => {
      enterAskboxMultiSelectMode();
      toggleQuestionSelection(questionId);
    }, 500); // é•¿æŒ‰500msè§¦å‘
  }

  // ç»“æŸé•¿æŒ‰
  function endQuestionLongPress() {
    if (questionLongPressTimer) {
      clearTimeout(questionLongPressTimer);
      questionLongPressTimer = null;
    }
  }

  // åˆ‡æ¢æé—®é€‰æ‹©çŠ¶æ€
  function toggleQuestionSelection(questionId) {
    if (!isAskboxMultiSelectMode) {
      enterAskboxMultiSelectMode();
    }

    const questionEl = document.querySelector(`.askbox-question-item[data-question-id="${questionId}"]`);
    if (!questionEl) return;

    if (selectedQuestions.has(questionId)) {
      selectedQuestions.delete(questionId);
      questionEl.style.border = '';
      questionEl.style.backgroundColor = 'rgba(255,255,255,0.9)';
    } else {
      selectedQuestions.add(questionId);
      questionEl.style.border = '3px solid #1d9bf0';
      questionEl.style.backgroundColor = 'rgba(29, 155, 240, 0.1)';
    }

    updateAskboxDeleteUI();
  }

  // è¿›å…¥æé—®ç®±å¤šé€‰æ¨¡å¼
  function enterAskboxMultiSelectMode() {
    isAskboxMultiSelectMode = true;

    // æ˜¾ç¤ºåˆ é™¤å·¥å…·æ 
    showAskboxDeleteToolbar();

    // æ”¹å˜æ‰€æœ‰æé—®å¡ç‰‡çš„æ ·å¼
    document.querySelectorAll('.askbox-question-item').forEach(item => {
      item.style.borderLeft = '3px solid #1d9bf0';
    });

    console.log('âœ… å·²è¿›å…¥æé—®ç®±å¤šé€‰æ¨¡å¼');
  }

  // é€€å‡ºæé—®ç®±å¤šé€‰æ¨¡å¼
  function exitAskboxMultiSelectMode() {
    isAskboxMultiSelectMode = false;
    selectedQuestions.clear();

    // éšè—åˆ é™¤å·¥å…·æ 
    hideAskboxDeleteToolbar();

    // æ¢å¤æ‰€æœ‰æé—®å¡ç‰‡çš„æ ·å¼
    document.querySelectorAll('.askbox-question-item').forEach(item => {
      item.style.border = '';
      item.style.borderLeft = '';
      item.style.backgroundColor = 'rgba(255,255,255,0.9)';
    });

    console.log('âœ… å·²é€€å‡ºæé—®ç®±å¤šé€‰æ¨¡å¼');
  }

  // æ˜¾ç¤ºæé—®ç®±åˆ é™¤å·¥å…·æ 
  function showAskboxDeleteToolbar() {
    let toolbar = document.getElementById('askbox-delete-toolbar');
    if (!toolbar) {
      toolbar = document.createElement('div');
      toolbar.id = 'askbox-delete-toolbar';
      toolbar.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0,0,0,0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 24px;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        z-index: 2000ï¼›
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      `;

      toolbar.innerHTML = `
        <button onclick="selectAllQuestions()" style="
          background-color: #1d9bf0; 
          color: #fff; 
          border: none; 
          border-radius: 20px; 
          padding: 8px 16px; 
          font-size: 14px; 
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        " onmouseover="this.style.backgroundColor='#1a8cd8'" onmouseout="this.style.backgroundColor='#1d9bf0'">
          å…¨é€‰
        </button>
        <span id="askbox-selected-count" style="color: #fff; font-size: 14px; font-weight: 500;">å·²é€‰æ‹© 0 ä¸ª</span>
        <button onclick="deleteSelectedQuestions()" style="
          background-color: #f91880; 
          color: #fff; 
          border: none; 
          border-radius: 20px; 
          padding: 8px 16px; 
          font-size: 14px; 
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        " onmouseover="this.style.backgroundColor='#d0155f'" onmouseout="this.style.backgroundColor='#f91880'">
          åˆ é™¤
        </button>
        <button onclick="exitAskboxMultiSelectMode()" style="
          background-color: rgba(255,255,255,0.15); 
          color: #fff; 
          border: none; 
          border-radius: 20px; 
          padding: 8px 16px; 
          font-size: 14px; 
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.25)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.15)'">
          å–æ¶ˆ
        </button>
      `;

      document.body.appendChild(toolbar);
    }
    toolbar.style.display = 'flex';
  }

  // éšè—æé—®ç®±åˆ é™¤å·¥å…·æ 
  function hideAskboxDeleteToolbar() {
    const toolbar = document.getElementById('askbox-delete-toolbar');
    if (toolbar) {
      toolbar.style.display = 'none';
    }
  }

  // æ›´æ–°æé—®ç®±åˆ é™¤UI
  function updateAskboxDeleteUI() {
    const countEl = document.getElementById('askbox-selected-count');
    if (countEl) {
      countEl.textContent = `å·²é€‰æ‹© ${selectedQuestions.size} ä¸ª`;
    }
  }

  // å…¨é€‰æé—®
  function selectAllQuestions() {
    document.querySelectorAll('.askbox-question-item').forEach(item => {
      const questionId = item.dataset.questionId;
      if (!selectedQuestions.has(questionId)) {
        selectedQuestions.add(questionId);
        item.style.border = '3px solid #1d9bf0';
        item.style.backgroundColor = 'rgba(29, 155, 240, 0.1)';
      }
    });
    updateAskboxDeleteUI();
  }

  // åˆ é™¤é€‰ä¸­çš„æé—®
  async function deleteSelectedQuestions() {
    if (selectedQuestions.size === 0) {
      showXToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æé—®', 'warning');
      return;
    }

    const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedQuestions.size} ä¸ªæé—®å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚`);
    if (!confirmDelete) return;

    try {
      // è¿‡æ»¤æ‰é€‰ä¸­çš„æé—®
      askboxData.answeredQuestions = askboxData.answeredQuestions.filter(q => !selectedQuestions.has(q.id));

      // ä¿å­˜åˆ°æ•°æ®åº“
      await saveAskboxDataToDB();

      showXToast(`å·²åˆ é™¤ ${selectedQuestions.size} ä¸ªæé—®`, 'success');

      // é€€å‡ºå¤šé€‰æ¨¡å¼å¹¶åˆ·æ–°æ˜¾ç¤º
      exitAskboxMultiSelectMode();
      renderAnsweredQuestions();
    } catch (error) {
      console.error('åˆ é™¤æé—®å¤±è´¥:', error);
      showXToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
    }
  }

  // ============================================
  // ç¬¬äº”éƒ¨åˆ†: æš´éœ²å…¨å±€æ¥å£
  // ============================================

  // å°†å¿…è¦çš„å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
  window.renderXSocialScreenProxy = renderXSocialScreen;
  window.switchXPage = switchXPage;
  window.switchHomeTab = switchHomeTab;
  window.refreshXTweets = refreshXTweets;
  window.showTweetComments = showTweetComments;
  window.submitComment = submitComment;
  window.handleCommentInput = handleCommentInput;
  window.autoResize = autoResize;
  window.showReplyInput = showReplyInput;
  window.cancelReply = cancelReply;
  window.submitReply = submitReply;
  window.handleReplyInput = handleReplyInput;
  window.autoResizeReply = autoResizeReply;
  window.toggleLike = toggleLike;
  window.toggleCommentLike = toggleCommentLike;
  window.deleteUserComment = deleteUserComment;
  window.showSensitiveContent = showSensitiveContent;
  window.handleQuotedTweetClick = handleQuotedTweetClick;
  window.handleQuoteRetweetFromData = handleQuoteRetweetFromData;
  window.openComposeTweetModal = openComposeTweetModal;
  window.closeComposeTweetModal = closeComposeTweetModal;
  window.publishTweet = publishTweet;
  window.handleComposeInput = handleComposeInput;
  window.processHashtagsAndMentions = processHashtagsAndMentions;
  window.toggleImageSection = toggleImageSection;
  window.selectImageMethod = selectImageMethod;
  window.triggerImageUpload = triggerImageUpload;
  window.handleImageUpload = handleImageUpload;
  window.saveImageData = saveImageData;
  window.removeImage = removeImage;
  window.toggleLocationSection = toggleLocationSection;
  window.saveLocationData = saveLocationData;
  window.removeLocation = removeLocation;
  window.toggleLinkSection = toggleLinkSection;
  window.saveLinkData = saveLinkData;
  window.removeLink = removeLink;
  window.triggerLinkImageUpload = triggerLinkImageUpload;
  window.handleLinkImageUpload = handleLinkImageUpload;
  window.removeQuoteContent = removeQuoteContent;
  window.togglePrivacySettings = togglePrivacySettings;
  window.editProfile = editProfile;
  window.openEditProfileModal = openEditProfileModal;
  window.closeEditProfileModal = closeEditProfileModal;
  window.saveProfileChanges = saveProfileChanges;
  window.switchProfileTab = switchProfileTab;
  window.toggleProfileMenu = toggleProfileMenu;
  window.openAccountManager = openAccountManager;
  window.updateCharacterCounts = updateCharacterCounts;
  window.toggleRealNameInput = toggleRealNameInput;
  window.updateTag1ColorFromText = updateTag1ColorFromText;
  window.updateTag1ColorFromPicker = updateTag1ColorFromPicker;
  window.updateTag2ColorFromText = updateTag2ColorFromText;
  window.updateTag2ColorFromPicker = updateTag2ColorFromPicker;
  window.editCoverImage = editCoverImage;
  window.removeCoverImage = removeCoverImage;
  window.editAvatarImage = editAvatarImage;
  window.updateVerificationTypeUI = updateVerificationTypeUI;
  window.toggleCharacterBinding = toggleCharacterBinding;
  window.toggleCharacterSelection = toggleCharacterSelection;
  window.openCharacterXProfile = openCharacterXProfile;
  window.closeCharacterXProfileModal = closeCharacterXProfileModal;
  window.saveCharacterXProfile = saveCharacterXProfile;
  window.updateCharacterXAvatar = updateCharacterXAvatar;
  window.updateCharacterBioCount = updateCharacterBioCount;
  window.toggleCharacterRealNameInput = toggleCharacterRealNameInput;
  window.openAddRelationshipModal = openAddRelationshipModal;
  window.editRelationship = editRelationship;
  window.deleteRelationship = deleteRelationship;
  window.closeRelationshipModal = closeRelationshipModal;
  window.updateRelationshipDescCount = updateRelationshipDescCount;
  window.saveRelationshipForm = saveRelationshipForm;
  window.saveXSettings = saveXSettings;
  window.saveXPreset = saveXPreset;
  window.loadXPreset = loadXPreset;
  window.deleteXPreset = deleteXPreset;
  window.exportXData = exportXData;
  window.importXData = importXData;
  window.showTweetDetail = showTweetDetail;
  window.handleDetailCommentInput = handleDetailCommentInput;
  window.autoResizeDetail = autoResizeDetail;
  window.submitDetailComment = submitDetailComment;
  window.toggleDetailLike = toggleDetailLike;
  window.rerollAIReplies = rerollAIReplies;
  window.toggleTweetSelection = toggleTweetSelection;
  window.enterMultiSelectMode = enterMultiSelectMode;
  window.exitMultiSelectMode = exitMultiSelectMode;
  window.selectAllTweets = selectAllTweets;
  window.deleteSelectedTweets = deleteSelectedTweets;
  window.showXToast = showXToast;
  window.toggleIdentityCharacter = toggleIdentityCharacter;
  window.closeAccountManager = closeAccountManager;
  window.switchAccount = switchAccount;
  window.createNewAccount = createNewAccount;
  window.deleteAccount = deleteAccount;
  window.triggerCommentImageUpload = triggerCommentImageUpload;
  window.handleCommentImageUpload = handleCommentImageUpload;
  window.removeCommentImage = removeCommentImage;
  window.triggerDetailCommentImageUpload = triggerDetailCommentImageUpload;
  window.handleDetailCommentImageUpload = handleDetailCommentImageUpload;
  window.removeDetailCommentImage = removeDetailCommentImage;

  // NPCç»‘å®šç›¸å…³å‡½æ•°
  window.toggleNPCBinding = toggleNPCBinding;
  window.openCreateNPCModal = openCreateNPCModal;
  window.editNPC = editNPC;
  window.saveNPC = saveNPC;
  window.deleteNPC = deleteNPC;
  window.closeNPCEditModal = closeNPCEditModal;

  // æé—®ç®±ç›¸å…³å‡½æ•°
  window.loadAskboxData = loadAskboxData;
  window.changeAskboxAvatar = changeAskboxAvatar;
  window.saveAskboxNickname = saveAskboxNickname;
  window.saveAskboxPrompt = saveAskboxPrompt;
  window.openAskboxSettings = openAskboxSettings;
  window.getNewQuestion = getNewQuestion;
  window.saveQuestionAnswer = saveQuestionAnswer;

  // æé—®ç®±å¤šé€‰åˆ é™¤ç›¸å…³å‡½æ•°
  window.startQuestionLongPress = startQuestionLongPress;
  window.endQuestionLongPress = endQuestionLongPress;
  window.toggleQuestionSelection = toggleQuestionSelection;
  window.enterAskboxMultiSelectMode = enterAskboxMultiSelectMode;
  window.exitAskboxMultiSelectMode = exitAskboxMultiSelectMode;
  window.selectAllQuestions = selectAllQuestions;
  window.deleteSelectedQuestions = deleteSelectedQuestions;

  // æœç´¢é¡µé¢ç›¸å…³å‡½æ•°
  window.switchSearchTab = switchSearchTab;
  window.handleTrendingClick = handleTrendingClick;
  window.handleTrendingMore = handleTrendingMore;
  window.openAddCategoryModal = openAddCategoryModal;
  window.closeCategoryModal = closeCategoryModal;
  window.addNewCategory = addNewCategory;
  window.deleteCategory = deleteCategory;
  window.toggleCategory = toggleCategory;
  window.updateCategoryName = updateCategoryName;
  window.updateCategoryDescription = updateCategoryDescription;
  window.saveCustomCategories = saveCustomCategories;
  window.refreshTrends = refreshTrends;
  window.toggleSearchButton = toggleSearchButton;
  window.performSearch = performSearch;
  window.switchSearchResultTab = switchSearchResultTab;
  window.backToTrending = backToTrending;

  console.log('âœ… å…¨å±€æ¥å£å·²æš´éœ²');

  // åˆ›å»º XSocialApp å¯¹è±¡ä»¥å…¼å®¹HTMLæ£€æŸ¥
  window.XSocialApp = {
    init: initXSocialApp,
    render: renderXSocialScreen,
    version: '1.0',
    isLoaded: true,
  };

  // è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆå¦‚æœDOMå·²åŠ è½½ï¼‰
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initXSocialApp);
  } else {
    // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿å…¶ä»–è„šæœ¬å…ˆåŠ è½½
    setTimeout(initXSocialApp, 100);
  }

  console.log('ğŸ“¦ X Social App æ¨¡å—å·²åŠ è½½ï¼Œç‰ˆæœ¬: 1.0');
})(window);
        
    </script>
    <div id="qzone-sticker-panel">
        <div id="qzone-sticker-grid"></div>
    </div>
    <!-- â–¼â–¼â–¼ ã€å…¨æ–° V2.0 | æ”¯æŒä¸Šä¼ ã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ avatar-frame-modal â–¼â–¼â–¼ -->
    <div id="avatar-frame-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>é€‰æ‹©å¤´åƒæ¡†</span>
                <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘æ·»åŠ æ“ä½œæŒ‰é’® -->
                <div class="header-actions">
                    <button id="upload-custom-frame-btn" class="action-button">ä¸Šä¼ </button>
                    <button id="batch-import-frames-btn" class="action-button">æ‰¹é‡</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="frame-tabs">
                    <div id="ai-frame-tab" class="frame-tab active">å¯¹æ–¹çš„</div>
                    <div id="my-frame-tab" class="frame-tab">æˆ‘çš„</div>
                </div>
                <div id="ai-frame-content" class="frame-content">
                    <div id="ai-frame-grid" class="frame-grid">
                    </div>
                </div>
                <div id="my-frame-content" class="frame-content" style="display: none;">
                    <div id="my-frame-grid" class="frame-grid">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-frame-settings-btn">å–æ¶ˆ</button>
                <button class="save" id="save-frame-settings-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>
    <!-- ã€æ ¸å¿ƒæ–°å¢ã€‘ç”¨äºæœ¬åœ°ä¸Šä¼ çš„éšè—æ–‡ä»¶è¾“å…¥æ¡† -->
    <input type="file" id="custom-frame-upload-input" accept="image/*" hidden>
    <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<div id="character-profile-modal" class="modal">
    <div class="character-profile-content">
        <!-- å³ä¸Šè§’çš„å†å²è®°å½•å›¾æ ‡æŒ‰é’® -->
        <button id="profile-history-icon-btn" title="æŸ¥çœ‹å†å²å¿ƒå£°">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg>
        </button>
        
        <!-- ä¸»èµ„æ–™é¡µ -->
        <div id="profile-main-content">
            <!-- ï¼ˆè¿™é‡Œçš„å†…å®¹ç»“æ„ä¸ä¸Šæ¬¡ç±»ä¼¼ï¼Œä½†è¢«åŒ…è£¹åœ¨äº†å¡ç‰‡å†…éƒ¨ï¼‰ -->
            <div id="profile-timestamp" class="thought-header"></div>
            <div class="thought-content">
                <div class="voice">
                    <div class="label">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        å¿ƒå£°
                    </div>
                    <p id="profile-heartfelt-voice" class="text"></p>
                </div>
                <div class="jottings">
                    <div class="label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path></svg>
                        æ•£è®°
                    </div>
                    <p id="profile-random-jottings" class="text"></p>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•é¡µ (ä¿æŒä¸å˜ï¼Œä½†ç°åœ¨ä¹Ÿåœ¨å¡ç‰‡å†…åˆ‡æ¢) -->
        <div id="profile-thoughts-history-view">
            <div class="profile-header">
                <span>å¿ƒå£°è®°å½•</span>
                <button id="history-back-btn" title="è¿”å›">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
            </div>
            <div id="thoughts-history-list"></div>
        </div>
    </div>
</div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘â€œæˆ‘çš„â€å¤´åƒåº“ä¸“ç”¨æ–‡ä»¶ä¸Šä¼ è¾“å…¥æ¡† â–¼â–¼â–¼ -->
    <input type="file" id="my-avatar-upload-input" accept="image/*" hidden>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯é€‰æ‹©ç¤¼ç‰©æ¥æ”¶äººçš„å¼¹çª—ï¼Œè¯·ç²˜è´´åˆ° body åº•éƒ¨ â–¼â–¼â–¼ -->
    <div id="gift-recipient-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span>é€‰æ‹©æ”¶ç¤¼äºº</span>
                <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="select-all-recipients"> å…¨é€‰ </label>
            </div>
            <div class="modal-body" id="gift-recipient-list" style="padding: 0;">
                <!-- ç¾¤æˆå‘˜åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-gift-recipient-btn">å–æ¶ˆ</button>
                <button class="save" id="confirm-gift-recipient-btn">ç¡®è®¤é€å‡º</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ rendering-rules-screen â–¼â–¼â–¼ -->
    <div id="rendering-rules-screen" class="screen">
        <div class="header">
            <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
            <span>æ¸²æŸ“è§„åˆ™</span>
            <span class="action-btn" id="add-new-rule-btn">+</span>
        </div>
        <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å…¨æ–°çš„é¡µç­¾å’Œå†…å®¹åŒºç»“æ„ -->
        <div id="rules-tabs">
            <!-- JS ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆé¡µç­¾ -->
        </div>
        <div id="rules-content-container">
            <!-- JS ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆå†…å®¹é¢æ¿ -->
        </div>
    </div>
    <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
    <!-- 2. è§„åˆ™ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div id="rule-editor-modal" class="modal">
        <div class="modal-content" style="height: 85%;">
            <div class="modal-header">
                <span id="rule-editor-title">åˆ›å»ºæ–°è§„åˆ™</span>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
                <div class="form-group" style="flex-shrink: 0;">
                    <label for="rule-name-input">è§„åˆ™åç§°</label>
                    <input type="text" id="rule-name-input" placeholder="ä¾‹å¦‚ï¼šç¾å›¢å¤–å–å¡ç‰‡">
                </div>
                <div class="form-group" style="flex-shrink: 0;">
                    <label for="rule-chat-id-select">ç»‘å®šèŒƒå›´</label>
                    <select id="rule-chat-id-select">
                        <option value="global">å…¬ç”¨ (æ‰€æœ‰è§’è‰²)</option>
                        <!-- è§’è‰²åˆ—è¡¨å°†ç”±JSåŠ¨æ€å¡«å…… -->
                    </select>
                </div>
                <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;">
                    <label for="rule-regex-input">æ­£åˆ™è¡¨è¾¾å¼ (ä½¿ç”¨gä½œä¸ºæ ‡å¿—)</label>
                    <textarea id="rule-regex-input" rows="3" style="font-family: monospace; resize: vertical;" placeholder="ä¾‹å¦‚ï¼šMTR\[(.*?)\]\[(.*?)\|(.*?)\]"></textarea>
                </div>
                <div class="form-group" style="flex-grow: 2; display: flex; flex-direction: column;">
                    <label for="rule-template-input">HTML æ¨¡æ¿ (ç”¨ $1, $2 å¼•ç”¨)</label>
                    <textarea id="rule-template-input" rows="6" style="font-family: monospace; resize: vertical;" placeholder="ä¾‹å¦‚ï¼š<div class=`waimai-card`>...<span>$2</span>...</div>"></textarea>
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                    <label for="rule-enabled-switch" style="margin-bottom: 0;">å¯ç”¨è§„åˆ™</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="rule-enabled-switch" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-rule-editor-btn">å–æ¶ˆ</button>
                <button class="save" id="save-rule-btn">ä¿å­˜è§„åˆ™</button>
            </div>
        </div>
    </div>
    <!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªã€å…¨æ–°çš„ <audio> æ ‡ç­¾ã€‘ç²˜è´´åˆ° <body> æ ‡ç­¾çš„æœ€æœ«å°¾ï¼Œç´§é‚» </body> ä¹‹å‰ â–¼â–¼â–¼ -->
<audio id="notification-sound-player" preload="auto"></audio>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°V2ç‰ˆã€‘BGMæœç´¢ç»“æœå¼¹çª— (æ”¯æŒå¤šé€‰) â–¼â–¼â–¼ -->
<div id="music-search-results-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>æœç´¢ç»“æœ</span>
            <!-- æ ¸å¿ƒä¿®æ”¹1ï¼šæ·»åŠ â€œå…¨é€‰â€å¤é€‰æ¡† -->
            <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="select-all-music-search"> å…¨é€‰
            </label>
        </div>
        <div class="modal-body" id="search-results-list" style="padding: 0;">
            <!-- æœç´¢ç»“æœå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <!-- æ ¸å¿ƒä¿®æ”¹2ï¼šæ›´æ–°é¡µè„šæŒ‰é’® -->
            <button class="cancel" id="cancel-music-search-btn">å–æ¶ˆ</button>
            <button class="save" id="add-selected-music-btn">æ·»åŠ é€‰ä¸­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<audio id="char-audio-player" preload="auto"></audio>
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è±†ç“£è§’è‰²é€‰æ‹©å¼¹çª— â–¼â–¼â–¼ -->
<div id="douban-cast-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>é€‰æ‹©å‚ä¸è±†ç“£çš„è§’è‰²</span>
        </div>
        <div class="modal-body" id="douban-cast-list" style="padding: 0;">
            <!-- è§’è‰²åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-douban-cast-btn">å–æ¶ˆ</button>
            <button class="save" id="save-douban-cast-btn">ä¿å­˜å¹¶åˆ·æ–°</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯ä¸ºâ€œé¢„è®¾â€åŠŸèƒ½æ–°å¢çš„æ–‡ä»¶å¯¼å…¥è¾“å…¥æ¡† â–¼â–¼â–¼ -->
<input type="file" id="import-preset-input" accept=".json" hidden>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¿™æ˜¯æ›´æ–°é€šçŸ¥å¼¹çª—çš„HTMLç»“æ„ â–¼â–¼â–¼ -->
<div id="update-notice-modal">
    <div class="update-notice-content">
        <div class="update-notice-body" id="update-notice-body">
            <!-- æ›´æ–°å†…å®¹å°†ç”±JSåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
        </div>
        <div class="update-notice-footer">
            <button id="update-notice-confirm-btn">æˆ‘çŸ¥é“äº†</button>
            <button id="update-notice-dismiss-btn">ä¸å†æç¤º</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢HTMLç»“æŸ â–²â–²â–² -->
</body>
</html>



















